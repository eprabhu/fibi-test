name: Sync CORE to COI

on:
  push:
    branches: [main, master]
    paths:
      - 'Fibi-Vanilla/FIBI_CORE/**'

permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout fibi-test
        uses: actions/checkout@v4
        with:
          fetch-depth: 2
      
      - name: Check if CORE files changed
        id: check-core
        run: |
          if git diff --name-only HEAD~1 HEAD | grep -q "Fibi-Vanilla/FIBI_CORE"; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "CORE files changed"
          else
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "No CORE files changed"
          fi
      
      - name: Checkout COI
        if: steps.check-core.outputs.changed == 'true'
        uses: actions/checkout@v4
        with:
          repository: eprabhu/coi
          path: coi-repo
          token: ${{ secrets.GH_COI_PUSH_TOKEN }}
      
      - name: Sync CORE files
        if: steps.check-core.outputs.changed == 'true'
        run: |
          echo "Syncing CORE files..."
          
          # Create destination directory if it doesn't exist
          mkdir -p coi-repo/DB/CORE
          
          # Copy CORE files (preserve directory structure)
          cp -r Fibi-Vanilla/FIBI_CORE/* coi-repo/DB/CORE/ || true
          
          # Commit and push
          cd coi-repo
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add DB/CORE/ || true
          
          if [ -n "$(git status --porcelain DB/CORE)" ]; then
            echo "Committing changes..."
            git commit -m "Auto-sync CORE from fibi-test

          Source commit: ${{ github.sha }}
          Source: ${{ github.repository }}"
            
            echo "Pushing to COI repository..."
            git push origin main || git push origin master
            echo "âœ… Sync completed successfully!"
          else
            echo "No changes to commit. Already in sync."
          fi

