name: Sync CORE to COI

on:
  push:
    branches: [main, master]
    paths:
      - 'Fibi-Vanilla/FIBI_CORE/**'

permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout fibi-test
        uses: actions/checkout@v4
        with:
          fetch-depth: 2
      
      - name: Check if CORE files changed
        id: check-core
        run: |
          if git diff --name-only HEAD~1 HEAD | grep -q "Fibi-Vanilla/FIBI_CORE"; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "CORE files changed"
          else
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "No CORE files changed"
          fi
      
      - name: Verify Secret
        if: steps.check-core.outputs.changed == 'true'
        run: |
          if [ -z "$GH_COI_PUSH_TOKEN" ]; then
            echo "❌ ERROR: GH_COI_PUSH_TOKEN secret is empty or not set!"
            echo "Please check: https://github.com/eprabhu/fibi-test/settings/secrets/actions"
            exit 1
          else
            TOKEN_LENGTH=${#GH_COI_PUSH_TOKEN}
            echo "✅ Token secret exists (length: $TOKEN_LENGTH characters)"
            if [ $TOKEN_LENGTH -lt 10 ]; then
              echo "⚠️  WARNING: Token seems too short. Please verify it's correct."
            fi
          fi
        env:
          GH_COI_PUSH_TOKEN: ${{ secrets.GH_COI_PUSH_TOKEN }}
      
      - name: Checkout COI
        if: steps.check-core.outputs.changed == 'true'
        run: |
          echo "Cloning COI repository..."
          git clone https://x-access-token:$GH_COI_PUSH_TOKEN@github.com/eprabhu/coi.git coi-repo
          cd coi-repo
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
        env:
          GH_COI_PUSH_TOKEN: ${{ secrets.GH_COI_PUSH_TOKEN }}
      
      - name: Sync CORE files
        if: steps.check-core.outputs.changed == 'true'
        env:
          GH_TOKEN: ${{ secrets.GH_COI_PUSH_TOKEN }}
        run: |
          echo "Syncing CORE files..."
          
          # Create destination directory if it doesn't exist
          mkdir -p coi-repo/DB/CORE
          
          # Copy CORE files (preserve directory structure)
          cp -r Fibi-Vanilla/FIBI_CORE/* coi-repo/DB/CORE/ || true
          
          # Commit and push
          cd coi-repo
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Get the current branch name
          BRANCH=$(git branch --show-current || echo "main")
          echo "Current branch: $BRANCH"
          
          # Configure remote URL with token (use x-oauth-basic for PAT)
          git remote set-url origin https://x-access-token:${{ secrets.GH_COI_PUSH_TOKEN }}@github.com/eprabhu/coi.git
          
          git add DB/CORE/ || true
          
          if [ -n "$(git status --porcelain DB/CORE)" ]; then
            echo "Committing changes..."
            git commit -m "Auto-sync CORE from fibi-test

          Source commit: ${{ github.sha }}
          Source: ${{ github.repository }}"
            
            echo "Pushing to COI repository (branch: $BRANCH)..."
            git push origin $BRANCH
            echo "✅ Sync completed successfully!"
          else
            echo "No changes to commit. Already in sync."
          fi

