name: Sync CORE to COI

on:
  push:
    branches: [main, master]
    paths:
      - 'Fibi-Vanilla/FIBI_CORE/**'
      - 'Fibi-*-Release/**/CORE/**'

permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout fibi-test
        uses: actions/checkout@v4
        with:
          fetch-depth: 2
      
      - name: Check if CORE files changed
        id: check-core
        run: |
          # Get all changed files (modified, added, deleted)
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)
          # Get deleted files specifically
          DELETED_FILES=$(git diff --name-only --diff-filter=D HEAD~1 HEAD || true)
          # Get added files specifically
          ADDED_FILES=$(git diff --name-only --diff-filter=A HEAD~1 HEAD || true)
          # Get modified files
          MODIFIED_FILES=$(git diff --name-only --diff-filter=M HEAD~1 HEAD || true)
          
          # Combine all changes (additions, modifications, deletions)
          ALL_CORE_CHANGES=$(echo -e "$CHANGED_FILES" | grep -E 'Fibi-Vanilla/FIBI_CORE|Fibi-.*-Release.*/CORE' || true)
          
          # Check for Fibi-Vanilla CORE changes (modified, added, or deleted)
          if echo "$ALL_CORE_CHANGES" | grep -q "Fibi-Vanilla/FIBI_CORE"; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "vanilla_changed=true" >> $GITHUB_OUTPUT
            echo "Fibi-Vanilla CORE files changed (modified, added, or deleted)"
          fi
          
          # Check if entire Vanilla CORE folder was deleted
          if echo "$DELETED_FILES" | grep -q "^Fibi-Vanilla/FIBI_CORE"; then
            echo "vanilla_deleted=true" >> $GITHUB_OUTPUT
            echo "⚠️  Entire Fibi-Vanilla CORE folder was deleted"
          fi
          
          # Check for Release CORE changes and extract release names
          RELEASE_CHANGES=$(echo "$ALL_CORE_CHANGES" | grep -oP "Fibi-[^/]+-Release" | sort -u || true)
          if [ -n "$RELEASE_CHANGES" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "release_changed=true" >> $GITHUB_OUTPUT
            echo "releases=$RELEASE_CHANGES" >> $GITHUB_OUTPUT
            echo "Release CORE files changed in: $RELEASE_CHANGES"
          fi
          
          # Check for deleted release CORE folders
          DELETED_RELEASES=$(echo "$DELETED_FILES" | grep -oP "Fibi-[^/]+-Release" | sort -u || true)
          if [ -n "$DELETED_RELEASES" ]; then
            echo "release_deleted=true" >> $GITHUB_OUTPUT
            echo "deleted_releases=$DELETED_RELEASES" >> $GITHUB_OUTPUT
            echo "⚠️  Release CORE folders deleted: $DELETED_RELEASES"
          fi
          
          # Check for routines YAML file changes (PROCEDURES.yaml, VIEWS.yaml, FUNCTIONS.yaml, etc.)
          ROUTINES_YAML_CHANGES=$(echo "$ALL_CORE_CHANGES" | grep -E '\.(yaml|yml)$' | grep -E '(PROCEDURES|VIEWS|FUNCTIONS|TRIGGERS)\.(yaml|yml)$' || true)
          if [ -n "$ROUTINES_YAML_CHANGES" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "routines_yaml_changed=true" >> $GITHUB_OUTPUT
            echo "Routines YAML files changed: $ROUTINES_YAML_CHANGES"
          fi
          
          # Set default if no changes
          if [ -z "$ALL_CORE_CHANGES" ] && [ -z "$DELETED_RELEASES" ] && [ -z "$ROUTINES_YAML_CHANGES" ]; then
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "No CORE files changed"
          fi
      
      - name: Verify Secret
        if: steps.check-core.outputs.changed == 'true'
        run: |
          if [ -z "$GH_COI_PUSH_TOKEN" ]; then
            echo "❌ ERROR: GH_COI_PUSH_TOKEN secret is empty or not set!"
            echo "Please check: https://github.com/eprabhu/fibi-test/settings/secrets/actions"
            exit 1
          else
            TOKEN_LENGTH=${#GH_COI_PUSH_TOKEN}
            echo "✅ Token secret exists (length: $TOKEN_LENGTH characters)"
            if [ $TOKEN_LENGTH -lt 10 ]; then
              echo "⚠️  WARNING: Token seems too short. Please verify it's correct."
            fi
          fi
        env:
          GH_COI_PUSH_TOKEN: ${{ secrets.GH_COI_PUSH_TOKEN }}
      
      - name: Checkout COI
        if: steps.check-core.outputs.changed == 'true'
        run: |
          echo "Cloning COI repository..."
          git clone https://x-access-token:$GH_COI_PUSH_TOKEN@github.com/eprabhu/coi.git coi-repo
          cd coi-repo
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
        env:
          GH_COI_PUSH_TOKEN: ${{ secrets.GH_COI_PUSH_TOKEN }}
      
      - name: Sync CORE files
        if: steps.check-core.outputs.changed == 'true'
        env:
          GH_TOKEN: ${{ secrets.GH_COI_PUSH_TOKEN }}
        run: |
          echo "Syncing CORE files..."
          
          # Create base destination directory
          mkdir -p coi-repo/DB/CORE
          
          # Handle Vanilla CORE deletion
          if [ "${{ steps.check-core.outputs.vanilla_deleted }}" == "true" ]; then
            echo "⚠️  Vanilla CORE folder was deleted, removing from COI..."
            if [ -d "coi-repo/DB/CORE" ]; then
              # Remove only vanilla CORE files, keep release folders
              find coi-repo/DB/CORE -maxdepth 1 -type f -delete || true
              find coi-repo/DB/CORE -maxdepth 1 -type d ! -name "CORE" ! -name "Fibi-*-Release" -exec rm -rf {} + || true
              echo "✅ Removed Vanilla CORE from COI"
            fi
          fi
          
          # Sync Fibi-Vanilla CORE (if changed but not deleted)
          if [ "${{ steps.check-core.outputs.vanilla_changed }}" == "true" ] && [ "${{ steps.check-core.outputs.vanilla_deleted }}" != "true" ]; then
            echo "Syncing Fibi-Vanilla CORE..."
            # Remove existing CORE folder contents if exists (for clean sync)
            # But preserve release folders
            if [ -d "coi-repo/DB/CORE" ]; then
              # Remove files and non-release directories at root level
              find coi-repo/DB/CORE -maxdepth 1 -type f -delete || true
              find coi-repo/DB/CORE -maxdepth 1 -type d ! -name "CORE" ! -name "Fibi-*-Release" -exec rm -rf {} + || true
            fi
            # Copy CORE files (preserve directory structure)
            if [ -d "Fibi-Vanilla/FIBI_CORE" ]; then
              cp -r Fibi-Vanilla/FIBI_CORE/* coi-repo/DB/CORE/ || true
              echo "✅ Synced Fibi-Vanilla CORE"
            fi
          fi
          
          # Handle deleted Release CORE folders
          if [ "${{ steps.check-core.outputs.release_deleted }}" == "true" ]; then
            echo "⚠️  Handling deleted Release CORE folders..."
            DELETED_RELEASES="${{ steps.check-core.outputs.deleted_releases }}"
            
            for RELEASE in $DELETED_RELEASES; do
              DEST_DIR="coi-repo/DB/CORE/$RELEASE"
              if [ -d "$DEST_DIR" ]; then
                echo "Removing deleted release folder: $DEST_DIR"
                rm -rf "$DEST_DIR"
                echo "✅ Removed $RELEASE from COI"
              fi
            done
          fi
          
          # Sync Release CORE folders (if changed but not deleted)
          if [ "${{ steps.check-core.outputs.release_changed }}" == "true" ]; then
            echo "Syncing Release CORE folders..."
            
            # Get changed files to find which releases need syncing
            CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)
            
            # Find all unique release folders with CORE changes
            RELEASES=$(echo "$CHANGED_FILES" | grep -oP "Fibi-[^/]+-Release" | sort -u)
            
            for RELEASE in $RELEASES; do
              echo "Processing release: $RELEASE"
              
              # Check if this release folder still exists in source
              if [ ! -d "$RELEASE" ]; then
                echo "⚠️  Release folder $RELEASE no longer exists, skipping sync"
                continue
              fi
              
              # Find CORE folder in this release (could be BASE/CORE, or any subfolder/CORE)
              CORE_PATH=$(find "$RELEASE" -type d -name "CORE" | head -1)
              
              if [ -n "$CORE_PATH" ] && [ -d "$CORE_PATH" ]; then
                echo "Found CORE folder at: $CORE_PATH"
                
                # Create destination directory for this release
                DEST_DIR="coi-repo/DB/CORE/$RELEASE"
                
                # Remove existing release folder if it exists (for clean sync)
                if [ -d "$DEST_DIR" ]; then
                  echo "Removing existing $RELEASE folder for clean sync..."
                  rm -rf "$DEST_DIR"
                fi
                
                # Create fresh directory
                mkdir -p "$DEST_DIR"
                
                # Copy CORE folder contents (not the CORE folder itself)
                echo "Copying from $CORE_PATH to $DEST_DIR"
                cp -r "$CORE_PATH"/* "$DEST_DIR/" || true
                
                echo "✅ Synced $RELEASE CORE to $DEST_DIR"
              else
                echo "⚠️  No CORE folder found in $RELEASE"
                # If CORE folder doesn't exist in source, remove from destination
                DEST_DIR="coi-repo/DB/CORE/$RELEASE"
                if [ -d "$DEST_DIR" ]; then
                  echo "Removing $RELEASE folder from COI (CORE folder deleted in source)"
                  rm -rf "$DEST_DIR"
                fi
              fi
            done
          fi
          
          # Sync ROUTINES files if routines YAML files changed
          if [ "${{ steps.check-core.outputs.routines_yaml_changed }}" == "true" ]; then
            echo "Syncing ROUTINES files from changed YAML files..."
            
            # Get changed routines YAML files
            CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)
            ROUTINES_YAML_FILES=$(echo "$CHANGED_FILES" | grep -E 'CORE/.*\.(yaml|yml)$' | grep -E '(PROCEDURES|VIEWS|FUNCTIONS|TRIGGERS)\.(yaml|yml)$' || true)
            
            # Process each changed YAML file
            for YAML_FILE in $ROUTINES_YAML_FILES; do
              if [ ! -f "$YAML_FILE" ]; then
                echo "⚠️  YAML file $YAML_FILE not found (may have been deleted), skipping"
                continue
              fi
              
              echo "Processing YAML file: $YAML_FILE"
              
              # Extract all sqlFile paths from YAML
              # Pattern: sqlFile: followed by path: on next line
              SQL_PATHS=$(awk '/sqlFile:/{getline; if(/path:/){gsub(/.*path:[[:space:]]*/, ""); gsub(/[[:space:]]*$/, ""); if($0 != "") print}}' "$YAML_FILE" || true)
              
              if [ -z "$SQL_PATHS" ]; then
                echo "No sqlFile paths found in $YAML_FILE"
                continue
              fi
              
              # Copy each SQL file
              for SQL_PATH in $SQL_PATHS; do
                echo "Found SQL path: $SQL_PATH"
                
                # Normalize path (remove leading/trailing spaces)
                SQL_PATH=$(echo "$SQL_PATH" | xargs)
                
                # Handle different path formats
                SOURCE_FILE=""
                
                # Try path as-is first
                if [ -f "$SQL_PATH" ]; then
                  SOURCE_FILE="$SQL_PATH"
                # Try relative to repository root
                elif [ -f "./$SQL_PATH" ]; then
                  SOURCE_FILE="./$SQL_PATH"
                # Try to find the file anywhere in repository
                else
                  SOURCE_FILE=$(find . -type f -path "*/$SQL_PATH" ! -path "*/.git/*" | head -1)
                fi
                
                if [ -n "$SOURCE_FILE" ] && [ -f "$SOURCE_FILE" ]; then
                  # Get absolute path for source
                  SOURCE_FILE=$(realpath "$SOURCE_FILE" 2>/dev/null || echo "$SOURCE_FILE")
                  
                  # Determine destination path (same structure in COI)
                  # Remove leading ./ if present
                  SQL_PATH_CLEAN=$(echo "$SQL_PATH" | sed 's|^\./||')
                  DEST_FILE="coi-repo/$SQL_PATH_CLEAN"
                  DEST_DIR=$(dirname "$DEST_FILE")
                  
                  # Create destination directory
                  mkdir -p "$DEST_DIR"
                  
                  # Copy the file
                  echo "Copying $SOURCE_FILE to $DEST_FILE"
                  cp "$SOURCE_FILE" "$DEST_FILE" || true
                  echo "✅ Synced routine file: $SQL_PATH_CLEAN"
                else
                  echo "⚠️  SQL file not found: $SQL_PATH (searched in repository)"
                fi
              done
            done
            
            echo "✅ Finished syncing ROUTINES files"
          fi
          
          # Commit and push
          cd coi-repo
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Get the current branch name
          BRANCH=$(git branch --show-current || echo "main")
          echo "Current branch: $BRANCH"
          
          # Configure remote URL with token
          git remote set-url origin https://x-access-token:${{ secrets.GH_COI_PUSH_TOKEN }}@github.com/eprabhu/coi.git
          
          git add DB/CORE/ ROUTINES/ || true
          
          if [ -n "$(git status --porcelain DB/CORE ROUTINES/ 2>/dev/null)" ]; then
            echo "Committing changes..."
            git commit -m "Auto-sync CORE and ROUTINES from fibi-test

          Source commit: ${{ github.sha }}
          Source: ${{ github.repository }}"
            
            echo "Pushing to COI repository (branch: $BRANCH)..."
            git push origin $BRANCH
            echo "✅ Sync completed successfully!"
          else
            echo "No changes to commit. Already in sync."
          fi

