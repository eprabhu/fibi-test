name: Sync CORE to COI

on:
  push:
    paths:
      - 'Fibi-*-Release/**/CORE/**'
      - 'Fibi-*-Release/**/ROUTINES/**'
      - 'Sprint-*/**/CORE/**'
      - 'Sprint-*/**/ROUTINES/**'
      - 'ROUTINES/BASE/CORE/**'

permissions:
  contents: write
  pull-requests: write

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout fibi-test
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch full history to handle merge commits properly
      
      - name: Get commit author info
        id: author
        run: |
          AUTHOR_EMAIL=$(git log -1 --pretty=format:"%ae" || echo "${{ github.actor }}@users.noreply.github.com")
          AUTHOR_NAME=$(git log -1 --pretty=format:"%an" || echo "${{ github.actor }}")
          echo "author_email=$AUTHOR_EMAIL" >> $GITHUB_OUTPUT
          echo "author_name=$AUTHOR_NAME" >> $GITHUB_OUTPUT
          echo "Commit author: $AUTHOR_NAME <$AUTHOR_EMAIL>"
      
      - name: Get current branch name
        id: branch
        run: |
          # Extract branch name from ref (e.g., refs/heads/feature-branch -> feature-branch)
          BRANCH_NAME="${{ github.ref_name }}"
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          echo "Current branch: $BRANCH_NAME"
      
      - name: Check if CORE files changed
        id: check-core
        run: |
          # Determine the base commit for comparison
          # For merge commits, compare against the first parent (main branch)
          # For regular commits, compare against previous commit
          if git cat-file -e HEAD^2 2>/dev/null; then
            # This is a merge commit, compare against first parent (the branch we merged into)
            BASE_COMMIT="HEAD^1"
            echo "Merge commit detected, comparing against first parent"
          else
            # Regular commit, compare against previous commit
            BASE_COMMIT="HEAD~1"
            echo "Regular commit, comparing against previous commit"
          fi
          
          # Get all changed files (modified, added, deleted)
          CHANGED_FILES=$(git diff --name-only $BASE_COMMIT HEAD || git diff --name-only HEAD~1 HEAD || echo "")
          # Get deleted files specifically
          DELETED_FILES=$(git diff --name-only --diff-filter=D $BASE_COMMIT HEAD || git diff --name-only --diff-filter=D HEAD~1 HEAD || echo "")
          # Get added files specifically
          ADDED_FILES=$(git diff --name-only --diff-filter=A $BASE_COMMIT HEAD || git diff --name-only --diff-filter=A HEAD~1 HEAD || echo "")
          # Get modified files
          MODIFIED_FILES=$(git diff --name-only --diff-filter=M $BASE_COMMIT HEAD || git diff --name-only --diff-filter=M HEAD~1 HEAD || echo "")
          
          echo "Changed files detected:"
          echo "$CHANGED_FILES" | head -20
          
          # Combine all changes (additions, modifications, deletions)
          ALL_CORE_CHANGES=$(echo -e "$CHANGED_FILES" | grep -E '(Fibi-.*-Release|Sprint-.*)/.*/CORE' || true)
          
          # Check for Release and Sprint CORE changes and extract folder names
          RELEASE_CHANGES=$(echo "$ALL_CORE_CHANGES" | grep -oP "Fibi-[^/]+-Release" | sort -u || true)
          SPRINT_CHANGES=$(echo "$ALL_CORE_CHANGES" | grep -oP "Sprint-[^/]+" | sort -u || true)
          
          if [ -n "$RELEASE_CHANGES" ] || [ -n "$SPRINT_CHANGES" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
            if [ -n "$RELEASE_CHANGES" ]; then
              echo "release_changed=true" >> $GITHUB_OUTPUT
              echo "releases=$RELEASE_CHANGES" >> $GITHUB_OUTPUT
              echo "Release CORE files changed in: $RELEASE_CHANGES"
            fi
            if [ -n "$SPRINT_CHANGES" ]; then
              echo "sprint_changed=true" >> $GITHUB_OUTPUT
              echo "sprints=$SPRINT_CHANGES" >> $GITHUB_OUTPUT
              echo "Sprint CORE files changed in: $SPRINT_CHANGES"
            fi
          fi
          
          # Check for deleted release and sprint CORE folders
          DELETED_RELEASES=$(echo "$DELETED_FILES" | grep -oP "Fibi-[^/]+-Release" | sort -u || true)
          DELETED_SPRINTS=$(echo "$DELETED_FILES" | grep -oP "Sprint-[^/]+" | sort -u || true)
          
          if [ -n "$DELETED_RELEASES" ] || [ -n "$DELETED_SPRINTS" ]; then
            if [ -n "$DELETED_RELEASES" ]; then
              echo "release_deleted=true" >> $GITHUB_OUTPUT
              echo "deleted_releases=$DELETED_RELEASES" >> $GITHUB_OUTPUT
              echo "⚠️  Release CORE folders deleted: $DELETED_RELEASES"
            fi
            if [ -n "$DELETED_SPRINTS" ]; then
              echo "sprint_deleted=true" >> $GITHUB_OUTPUT
              echo "deleted_sprints=$DELETED_SPRINTS" >> $GITHUB_OUTPUT
              echo "⚠️  Sprint CORE folders deleted: $DELETED_SPRINTS"
            fi
          fi
          
          # Check for routines YAML file changes - ONLY from BASE/CORE
          # (PROCEDURES.yaml, VIEWS.yaml, FUNCTIONS.yaml, etc.)
          ROUTINES_YAML_CHANGES=$(echo "$ALL_CORE_CHANGES" | grep -E 'BASE/CORE/.*\.(yaml|yml)$' | grep -E '(PROCEDURES|VIEWS|FUNCTIONS|TRIGGERS)\.(yaml|yml)$' || true)
          if [ -n "$ROUTINES_YAML_CHANGES" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "routines_yaml_changed=true" >> $GITHUB_OUTPUT
            echo "Routines YAML files changed: $ROUTINES_YAML_CHANGES"
          fi
          
          # Check for direct changes in ROUTINES/BASE/CORE/** folders (SQL files)
          # Check both absolute paths and relative paths
          ROUTINES_BASE_CORE_CHANGES=$(echo "$CHANGED_FILES" | grep -E '(^|/)ROUTINES/BASE/CORE/(PROCEDURES|FUNCTIONS|VIEWS|TRIGGERS)/.*\.sql$' || true)
          if [ -n "$ROUTINES_BASE_CORE_CHANGES" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "routines_base_core_changed=true" >> $GITHUB_OUTPUT
            echo "Direct ROUTINES/BASE/CORE files changed: $ROUTINES_BASE_CORE_CHANGES"
          else
            # Also check if ROUTINES/BASE/CORE is in the changed files at all (might have different path format)
            if echo "$CHANGED_FILES" | grep -qE 'ROUTINES.*BASE.*CORE.*\.(sql|yaml|yml)'; then
              echo "ROUTINES/BASE/CORE files detected with different path format"
              ROUTINES_BASE_CORE_CHANGES=$(echo "$CHANGED_FILES" | grep -E 'ROUTINES.*BASE.*CORE' || true)
              if [ -n "$ROUTINES_BASE_CORE_CHANGES" ]; then
                echo "changed=true" >> $GITHUB_OUTPUT
                echo "routines_base_core_changed=true" >> $GITHUB_OUTPUT
                echo "Direct ROUTINES/BASE/CORE files changed (detected): $ROUTINES_BASE_CORE_CHANGES"
              fi
            fi
          fi
          
          # Set default if no changes
          if [ -z "$ALL_CORE_CHANGES" ] && [ -z "$DELETED_RELEASES" ] && [ -z "$ROUTINES_YAML_CHANGES" ] && [ -z "$ROUTINES_BASE_CORE_CHANGES" ]; then
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "No CORE files changed"
          fi
      
      - name: Verify Secret
        if: steps.check-core.outputs.changed == 'true'
        run: |
          if [ -z "$GH_COI_PUSH_TOKEN" ]; then
            echo "❌ ERROR: GH_COI_PUSH_TOKEN secret is empty or not set!"
            echo "Please check: https://github.com/eprabhu/fibi-test/settings/secrets/actions"
            exit 1
          else
            TOKEN_LENGTH=${#GH_COI_PUSH_TOKEN}
            echo "✅ Token secret exists (length: $TOKEN_LENGTH characters)"
            if [ $TOKEN_LENGTH -lt 10 ]; then
              echo "⚠️  WARNING: Token seems too short. Please verify it's correct."
            fi
          fi
        env:
          GH_COI_PUSH_TOKEN: ${{ secrets.GH_COI_PUSH_TOKEN }}
      
      - name: Checkout COI
        if: steps.check-core.outputs.changed == 'true'
        run: |
          echo "Cloning COI repository..."
          git clone https://x-access-token:$GH_COI_PUSH_TOKEN@github.com/eprabhu/coi.git coi-repo
          cd coi-repo
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Get the branch name from the source repository
          SOURCE_BRANCH="${{ steps.branch.outputs.branch_name }}"
          echo "Checking out branch: $SOURCE_BRANCH"
          
          # Check if branch exists in COI repository
          if git ls-remote --heads origin "$SOURCE_BRANCH" | grep -q "$SOURCE_BRANCH"; then
            echo "Branch $SOURCE_BRANCH exists in COI, checking it out..."
            git checkout "$SOURCE_BRANCH"
          else
            echo "Branch $SOURCE_BRANCH does not exist in COI, creating it..."
            git checkout -b "$SOURCE_BRANCH"
          fi
        env:
          GH_COI_PUSH_TOKEN: ${{ secrets.GH_COI_PUSH_TOKEN }}
      
      - name: Load Configuration
        if: steps.check-core.outputs.changed == 'true'
        run: |
          chmod +x .github/workflows/scripts/load-config.sh
          source .github/workflows/scripts/load-config.sh || true
      
      - name: Sync CORE files
        if: steps.check-core.outputs.changed == 'true'
        env:
          GH_COI_PUSH_TOKEN: ${{ secrets.GH_COI_PUSH_TOKEN }}
          RELEASE_DELETED: ${{ steps.check-core.outputs.release_deleted }}
          DELETED_RELEASES: ${{ steps.check-core.outputs.deleted_releases }}
          RELEASE_CHANGED: ${{ steps.check-core.outputs.release_changed }}
          SPRINT_DELETED: ${{ steps.check-core.outputs.sprint_deleted }}
          DELETED_SPRINTS: ${{ steps.check-core.outputs.deleted_sprints }}
          SPRINT_CHANGED: ${{ steps.check-core.outputs.sprint_changed }}
          ROUTINES_YAML_CHANGED: ${{ steps.check-core.outputs.routines_yaml_changed }}
          ROUTINES_BASE_CORE_CHANGED: ${{ steps.check-core.outputs.routines_base_core_changed }}
          SOURCE_BRANCH_NAME: ${{ steps.branch.outputs.branch_name }}
          GITHUB_SHA: ${{ github.sha }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_RUN_ID: ${{ github.run_id }}
          GITHUB_ACTOR: ${{ github.actor }}
        run: |
          chmod +x .github/workflows/scripts/sync-core-files.sh
          bash .github/workflows/scripts/sync-core-files.sh
      
      - name: Create Pull Request
        if: steps.check-core.outputs.changed == 'true'
        env:
          GH_COI_PUSH_TOKEN: ${{ secrets.GH_COI_PUSH_TOKEN }}
          SOURCE_BRANCH_NAME: ${{ steps.branch.outputs.branch_name }}
          GITHUB_SHA: ${{ github.sha }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_RUN_ID: ${{ github.run_id }}
          GITHUB_ACTOR: ${{ github.actor }}
        run: |
          chmod +x .github/workflows/scripts/create-pr.sh
          bash .github/workflows/scripts/create-pr.sh
      
      - name: Send failure notification email
        if: failure()
        continue-on-error: true
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "❌ CORE Sync Failed - fibi-test to COI Repository"
          to: ${{ steps.author.outputs.author_email }},prabhu.e@polussolutions.com
          from: GitHub Actions <${{ secrets.EMAIL_USERNAME }}>
          body: |
            <h2>❌ CORE Sync Workflow Failed</h2>
            
            <p><strong>Repository:</strong> ${{ github.repository }}</p>
            <p><strong>Commit:</strong> <code>${{ github.sha }}</code></p>
            <p><strong>Commit Message:</strong> ${{ github.event.head_commit.message }}</p>
            <p><strong>Author:</strong> ${{ steps.author.outputs.author_name }} (${{ steps.author.outputs.author_email }})</p>
            <p><strong>Branch:</strong> ${{ github.ref_name }}</p>
            <p><strong>Workflow:</strong> Sync CORE to COI</p>
            <p><strong>Run ID:</strong> ${{ github.run_id }}</p>
            
            <hr>
            
            <h3>View Error Details:</h3>
            <p><a href="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}">Click here to view the workflow run and error logs</a></p>
            
            <p><strong>Direct Link:</strong><br>
            <code>${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}</code></p>
            
            <hr>
            
            <p><small>This is an automated notification from GitHub Actions. Please check the workflow logs for detailed error information.</small></p>
          content_type: text/html

