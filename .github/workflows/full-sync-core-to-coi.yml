name: Full Sync CORE to COI

on:
  workflow_dispatch:
    inputs:
      target_branch:
        description: 'Target branch in COI repository (leave empty to use current branch)'
        required: false
        type: string
        default: ''

permissions:
  contents: write
  pull-requests: write

jobs:
  full-sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout fibi-test
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      
      - name: Get commit author info
        id: author
        run: |
          AUTHOR_EMAIL=$(git log -1 --pretty=format:"%ae" || echo "${{ github.actor }}@users.noreply.github.com")
          AUTHOR_NAME=$(git log -1 --pretty=format:"%an" || echo "${{ github.actor }}")
          echo "author_email=$AUTHOR_EMAIL" >> $GITHUB_OUTPUT
          echo "author_name=$AUTHOR_NAME" >> $GITHUB_OUTPUT
          echo "Commit author: $AUTHOR_NAME <$AUTHOR_EMAIL>"
      
      - name: Determine target branch
        id: branch
        run: |
          # Use provided branch or default to current branch
          if [ -n "${{ github.event.inputs.target_branch }}" ]; then
            BRANCH_NAME="${{ github.event.inputs.target_branch }}"
            echo "Using provided target branch: $BRANCH_NAME"
          else
            BRANCH_NAME="${{ github.ref_name }}"
            echo "Using current branch: $BRANCH_NAME"
          fi
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          echo "Target branch: $BRANCH_NAME"
      
      - name: Verify Secret
        run: |
          if [ -z "$GH_COI_PUSH_TOKEN" ]; then
            echo "❌ ERROR: GH_COI_PUSH_TOKEN secret is empty or not set!"
            echo "Please check: https://github.com/eprabhu/fibi-test/settings/secrets/actions"
            exit 1
          else
            TOKEN_LENGTH=${#GH_COI_PUSH_TOKEN}
            echo "✅ Token secret exists (length: $TOKEN_LENGTH characters)"
            if [ $TOKEN_LENGTH -lt 10 ]; then
              echo "⚠️  WARNING: Token seems too short. Please verify it's correct."
            fi
          fi
        env:
          GH_COI_PUSH_TOKEN: ${{ secrets.GH_COI_PUSH_TOKEN }}
      
      - name: Checkout COI
        run: |
          echo "Cloning COI repository..."
          git clone https://x-access-token:$GH_COI_PUSH_TOKEN@github.com/eprabhu/coi.git coi-repo
          cd coi-repo
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Get the target branch name
          TARGET_BRANCH="${{ steps.branch.outputs.branch_name }}"
          echo "Checking out branch: $TARGET_BRANCH"
          
          # Check if branch exists in COI repository
          if git ls-remote --heads origin "$TARGET_BRANCH" | grep -q "$TARGET_BRANCH"; then
            echo "Branch $TARGET_BRANCH exists in COI, checking it out..."
            git checkout "$TARGET_BRANCH"
          else
            echo "Branch $TARGET_BRANCH does not exist in COI, creating it..."
            git checkout -b "$TARGET_BRANCH"
          fi
        env:
          GH_COI_PUSH_TOKEN: ${{ secrets.GH_COI_PUSH_TOKEN }}
      
      - name: Full Sync CORE and ROUTINES
        env:
          GH_COI_PUSH_TOKEN: ${{ secrets.GH_COI_PUSH_TOKEN }}
          SOURCE_BRANCH_NAME: ${{ steps.branch.outputs.branch_name }}
          GITHUB_SHA: ${{ github.sha }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_RUN_ID: ${{ github.run_id }}
          GITHUB_ACTOR: ${{ github.actor }}
        run: |
          chmod +x .github/workflows/scripts/full-sync-core-files.sh
          bash .github/workflows/scripts/full-sync-core-files.sh
      
      - name: Create Pull Request
        env:
          GH_COI_PUSH_TOKEN: ${{ secrets.GH_COI_PUSH_TOKEN }}
          SOURCE_BRANCH_NAME: ${{ steps.branch.outputs.branch_name }}
          GITHUB_SHA: ${{ github.sha }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_RUN_ID: ${{ github.run_id }}
          GITHUB_ACTOR: ${{ github.actor }}
        run: |
          chmod +x .github/workflows/scripts/create-full-sync-pr.sh
          bash .github/workflows/scripts/create-full-sync-pr.sh
      
      - name: Send failure notification email
        if: failure()
        continue-on-error: true
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "❌ Full CORE Sync Failed - fibi-test to COI Repository"
          to: ${{ steps.author.outputs.author_email }},prabhu.e@polussolutions.com
          from: GitHub Actions <${{ secrets.EMAIL_USERNAME }}>
          body: |
            <h2>❌ Full CORE Sync Workflow Failed</h2>
            
            <p><strong>Repository:</strong> ${{ github.repository }}</p>
            <p><strong>Commit:</strong> <code>${{ github.sha }}</code></p>
            <p><strong>Triggered by:</strong> ${{ github.actor }}</p>
            <p><strong>Author:</strong> ${{ steps.author.outputs.author_name }} (${{ steps.author.outputs.author_email }})</p>
            <p><strong>Target Branch:</strong> ${{ steps.branch.outputs.branch_name }}</p>
            <p><strong>Workflow:</strong> Full Sync CORE to COI</p>
            <p><strong>Run ID:</strong> ${{ github.run_id }}</p>
            
            <hr>
            
            <h3>View Error Details:</h3>
            <p><a href="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}">Click here to view the workflow run and error logs</a></p>
            
            <p><strong>Direct Link:</strong><br>
            <code>${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}</code></p>
            
            <hr>
            
            <p><small>This is an automated notification from GitHub Actions. Please check the workflow logs for detailed error information.</small></p>
          content_type: text/html

