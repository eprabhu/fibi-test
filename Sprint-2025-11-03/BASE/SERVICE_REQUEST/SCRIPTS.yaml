databaseChangeLog:

  - changeSet:
      id: FIBI-8877-1
      author: Sasikumar Chandran
      labels: 'DML'
      comment:
      changes:
        - sql:
            sql: |
              INSERT INTO COEUS_SUB_MODULE (COEUS_SUB_MODULE_ID, MODULE_CODE, SUB_MODULE_CODE, DESCRIPTION, UPDATE_TIMESTAMP, UPDATE_USER, REQUIRE_UNIQUE_QUESTIONNAIRE, IS_ACTIVE)
                SELECT 
                    (SELECT COALESCE(MAX(COEUS_SUB_MODULE_ID), 0) + 1 FROM COEUS_SUB_MODULE),
                    20,
                    2,
                    'Service Request Task',
                    UTC_DATE(),
                    'admin',
                    'N',
                    'Y'
                WHERE NOT EXISTS (
                    SELECT 1 FROM COEUS_SUB_MODULE WHERE MODULE_CODE = 20 AND SUB_MODULE_CODE = 2
                );
      rollback:
        - sql:
            sql: |
              DELETE FROM COEUS_SUB_MODULE WHERE MODULE_CODE = 20 AND SUB_MODULE_CODE = 2;

  - changeSet:
      id: FIBI-8877-2
      author: Sasikumar Chandran
      labels: 'DML'
      comment:
      changes:
        - sql:
            sql: |
              DELETE FROM INBOX where MODULE_CODE = 20 AND MODULE_ITEM_KEY NOT IN (SELECT SR_HEADER_ID FROM SR_HEADER);
      rollback: empty
      
  - changeSet:
      id: FIBI-8907-1
      author: Reshma Antony
      labels: 'DML'
      comment:
      changes:
        - sql:
            sql: |
             UPDATE NOTIFICATION_TYPE
             SET MESSAGE = REPLACE(MESSAGE, '{SERVICE_TYPE}', '{SERVICE_REQUEST_TYPE}'), UPDATE_USER ='admin',UPDATE_TIMESTAMP = UTC_TIMESTAMP()
             WHERE MESSAGE LIKE '%{SERVICE_TYPE}%';

             UPDATE NOTIFICATION_TYPE
             SET SUBJECT = REPLACE(SUBJECT, '{SERVICE_TYPE}', '{SERVICE_REQUEST_TYPE}'),UPDATE_USER ='admin',UPDATE_TIMESTAMP = UTC_TIMESTAMP()
             WHERE SUBJECT LIKE '%{SERVICE_TYPE}%';
      rollback:
        - sql:
            sql: |
              UPDATE NOTIFICATION_TYPE
              SET MESSAGE = REPLACE(MESSAGE, '{SERVICE_REQUEST_TYPE}', '{SERVICE_TYPE}'), 
              UPDATE_USER = 'admin',
              UPDATE_TIMESTAMP = UTC_TIMESTAMP()
              WHERE MESSAGE LIKE '%{SERVICE_REQUEST_TYPE}%';

              UPDATE NOTIFICATION_TYPE
              SET SUBJECT = REPLACE(SUBJECT, '{SERVICE_REQUEST_TYPE}', '{SERVICE_TYPE}'),
              UPDATE_USER = 'admin',
              UPDATE_TIMESTAMP = UTC_TIMESTAMP()
              WHERE SUBJECT LIKE '%{SERVICE_REQUEST_TYPE}%';

  - changeSet:
      id: FIBI-8333-1
      author: Nabeel Ahamed M
      labels: 'DDL'
      comment: 'Script for adding new columns in SR_HEADER_HISTORY table'
      changes:
        - sql:
            sql: |
              SET @col := (
                  SELECT COUNT(*)
                  FROM INFORMATION_SCHEMA.COLUMNS
                  WHERE TABLE_NAME = 'SR_HEADER_HISTORY'
                    AND TABLE_SCHEMA = DATABASE()
                    AND COLUMN_NAME = 'PREV_CUSTOM_DATA'
              );

              SET @sql := IF(@col = 0,
                            'ALTER TABLE SR_HEADER_HISTORY ADD COLUMN PREV_CUSTOM_DATA JSON NULL;',
                            'SELECT "Column PREV_CUSTOM_DATA already exists";');

              PREPARE stmt FROM @sql;
              EXECUTE stmt;
              DEALLOCATE PREPARE stmt;

              SET @col := (
                  SELECT COUNT(*)
                  FROM INFORMATION_SCHEMA.COLUMNS
                  WHERE TABLE_NAME = 'SR_HEADER_HISTORY'
                    AND TABLE_SCHEMA = DATABASE()
                    AND COLUMN_NAME = 'CUSTOM_DATA'
              );

              SET @sql := IF(@col = 0,
                            'ALTER TABLE SR_HEADER_HISTORY ADD COLUMN CUSTOM_DATA JSON NULL;',
                            'SELECT "Column CUSTOM_DATA already exists";');

              PREPARE stmt FROM @sql;
              EXECUTE stmt;
              DEALLOCATE PREPARE stmt;
      rollback:
        - sql:
            sql: |
              ALTER TABLE SR_HEADER_HISTORY
              DROP COLUMN PREV_CUSTOM_DATA,
              DROP COLUMN CUSTOM_DATA;    

              
