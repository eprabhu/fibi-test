DELIMITER //
CREATE PROCEDURE `MIG_SR_CMT_ATTCH_DATA`(AV_AWARD_ID INT
)
BEGIN

    DECLARE NOT_FOUND                 INT DEFAULT 0;
	DECLARE LI_MODULE_ITEM_ID         INT;
	DECLARE LI_SR_HEADER_ID           INT;
	DECLARE LI_STATUS_CODE            INT;
	DECLARE LS_REPORTER_PERSON_ID     VARCHAR(40);
	DECLARE LS_FULL_NAME		      VARCHAR(90);
	DECLARE LS_COMMENTS 		      LONGTEXT;
	DECLARE LD_UPDATE_TIMESTAMP	      DATETIME;
	DECLARE LS_UPDATE_USER		      VARCHAR(60);
	DECLARE LI_ACTION_LOG_ID	      INT;
	
	DECLARE LS_MIME_TYPE		      VARCHAR(100);
	DECLARE LS_FILE_NAME		      VARCHAR(300);
	DECLARE LDD_UPDATE_TIMESTAMP		  DATETIME(6);
	DECLARE LI_DOCUMENT_STATUS_CODE   INT;
	DECLARE LS_FILE_DATA_ID		      VARCHAR(255);
	DECLARE LI_VERSION_NUMBER		  INT;
	DECLARE LI_TYPE_CODE  			  INT;
	DECLARE LS_DESCRIPTION		      VARCHAR(200);
	DECLARE LI_COUNT				  INT DEFAULT 0;
    DECLARE LI_DOCUMENT_ID			  INT DEFAULT 0;
	
	DECLARE SEL_DATA CURSOR FOR
	SELECT
	ASR.MODULE_ITEM_ID,
	SR.SR_HEADER_ID,
	SR.STATUS_CODE,
	SR.REPORTER_PERSON_ID,
	P.FULL_NAME
	FROM SR_HEADER SR 
	INNER JOIN ASSOC_SR ASR ON ASR.SR_HEADER_ID = SR.SR_HEADER_ID
	LEFT JOIN PERSON P ON P.PERSON_ID = SR.REPORTER_PERSON_ID
	WHERE SR.STATUS_CODE IN (10,11);
	
	DECLARE SEL_AWARD_COMMENT_DATA CURSOR FOR 
	SELECT CONCAT('<p>',COMMENTS,'</p>'),UPDATE_TIMESTAMP,UPDATE_USER FROM AWARD_COMMENT WHERE  AWARD_ID = LI_MODULE_ITEM_ID AND COMMENTS IS NOT NULL;
	
	DECLARE SEL_AWARD_ATTACH_DATA CURSOR FOR 
	SELECT MIME_TYPE,FILE_NAME,UPDATE_TIMESTAMP,UPDATE_USER,DOCUMENT_STATUS_CODE,
	FILE_DATA_ID,VERSION_NUMBER,TYPE_CODE,DESCRIPTION FROM AWARD_ATTACHMENT WHERE AWARD_ID = LI_MODULE_ITEM_ID AND FILE_DATA_ID IS NOT NULL;

	DECLARE EXIT HANDLER FOR SQLEXCEPTION
				BEGIN
				
					GET DIAGNOSTICS CONDITION 1 @sqlstate = RETURNED_SQLSTATE, 
					 @errno = MYSQL_ERRNO, @msg = MESSAGE_TEXT;					 
					SET @full_error = CONCAT(@errno,'/',@msg);	
					SELECT @full_error;
                     				
                END;
				
     DECLARE CONTINUE HANDLER FOR NOT FOUND SET NOT_FOUND = 1;	

        OPEN SEL_DATA;
            SEL_DATA:LOOP
            SET NOT_FOUND=0;
            FETCH SEL_DATA INTO LI_MODULE_ITEM_ID,LI_SR_HEADER_ID,LI_STATUS_CODE,LS_REPORTER_PERSON_ID,LS_FULL_NAME; 
			
            IF NOT_FOUND=1 THEN
            LEAVE SEL_DATA;
            END IF;

 
			
				OPEN SEL_AWARD_COMMENT_DATA;
					SEL_AWARD_COMMENT_DATA:LOOP
					SET NOT_FOUND=0;
					FETCH SEL_AWARD_COMMENT_DATA INTO LS_COMMENTS,LD_UPDATE_TIMESTAMP,LS_UPDATE_USER; 
					
					IF NOT_FOUND=1 THEN
					LEAVE SEL_AWARD_COMMENT_DATA;
					END IF;		
			
            SET LI_COUNT = 0;
            SELECT COUNT(1) INTO LI_COUNT FROM SR_COMMENTS 
            WHERE COMMENTS IS NOT NULL AND COMMENTS = LS_COMMENTS AND SR_HEADER_ID = LI_SR_HEADER_ID;
			
            IF LI_COUNT = 0 THEN
            
							INSERT INTO SR_ACTION_LOG (
								ACTION_TYPE_CODE,
								ASSIGNEE_PERSON_ID,
								ASSIGNEE_PERSON_NAME,
								STATUS_CODE,
								UPDATE_TIMESTAMP,
								UPDATE_USER,
								SR_HEADER_ID,
								SR_TASK_ID
							) VALUES  (
								10,                       
								LS_REPORTER_PERSON_ID,
								LS_FULL_NAME,
								LI_STATUS_CODE,                    
								LD_UPDATE_TIMESTAMP,
								LS_UPDATE_USER,
								LI_SR_HEADER_ID,
								NULL
							);
		
						SET LI_ACTION_LOG_ID = LAST_INSERT_ID();
						
							INSERT INTO SR_COMMENTS (
								ACTION_LOG_ID,
								COMMENT_NUMBER,
								COMMENTS,
								UPDATE_TIMESTAMP,
								UPDATE_USER,
								SR_HEADER_ID,
								PRIVATE_FLAG,
								SECTION_CODE,
								PARENT_COMMENT_ID,
								CREATE_USER,
								CREATE_TIMESTAMP
							) VALUES (
								LI_ACTION_LOG_ID, 
								NULL, 
								LS_COMMENTS, 
								LD_UPDATE_TIMESTAMP, 
								LS_UPDATE_USER, 
								LI_SR_HEADER_ID, 
								'N', 
								'2025', 
								NULL, 
								LS_REPORTER_PERSON_ID, 
								LD_UPDATE_TIMESTAMP
							);
					END IF;		
					END LOOP SEL_AWARD_COMMENT_DATA;
				CLOSE SEL_AWARD_COMMENT_DATA;	
				
		SET LS_UPDATE_USER = NULL;
		
				OPEN SEL_AWARD_ATTACH_DATA;
					SEL_AWARD_ATTACH_DATA:LOOP
					SET NOT_FOUND=0;
					FETCH SEL_AWARD_ATTACH_DATA INTO LS_MIME_TYPE,LS_FILE_NAME,LDD_UPDATE_TIMESTAMP,LS_UPDATE_USER,LI_DOCUMENT_STATUS_CODE,
													 LS_FILE_DATA_ID,LI_VERSION_NUMBER,LI_TYPE_CODE,LS_DESCRIPTION; 
					
					IF NOT_FOUND=1 THEN
					LEAVE SEL_AWARD_ATTACH_DATA;
					END IF;
					
            SET LI_COUNT = 0;
            SELECT COUNT(1) INTO LI_COUNT FROM SR_ATTACHMENT 
            WHERE CONTENT_TYPE =LS_MIME_TYPE AND FILE_NAME =LS_FILE_NAME AND SR_HEADER_ID = LI_SR_HEADER_ID 
                        AND FILE_DATA_ID = LS_FILE_DATA_ID ;
 					
			IF LI_COUNT = 0 THEN
							INSERT INTO SR_ACTION_LOG (
								ACTION_TYPE_CODE,
								ASSIGNEE_PERSON_ID,
								ASSIGNEE_PERSON_NAME,
								STATUS_CODE,
								UPDATE_TIMESTAMP,
								UPDATE_USER,
								SR_HEADER_ID,
								SR_TASK_ID
							) VALUES  (
								10,                       
								LS_REPORTER_PERSON_ID,
								LS_FULL_NAME,
								LI_STATUS_CODE,                    
								LDD_UPDATE_TIMESTAMP,
								LS_UPDATE_USER,
								LI_SR_HEADER_ID,
								NULL
							);
		
						SET LI_ACTION_LOG_ID = LAST_INSERT_ID();
						
                        SELECT COUNT(DOCUMENT_ID) INTO LI_COUNT
						FROM SR_ATTACHMENT WHERE SR_HEADER_ID = LI_SR_HEADER_ID 
						AND FILE_NAME =LS_FILE_NAME AND CONTENT_TYPE = LS_MIME_TYPE
                        AND FILE_DATA_ID = LS_FILE_DATA_ID ;
						
						IF LI_COUNT = 0 THEN 
						
						SELECT MAX(IFNULL(DOCUMENT_ID,0))+1 INTO LI_DOCUMENT_ID
						FROM SR_ATTACHMENT WHERE SR_HEADER_ID = LI_SR_HEADER_ID;
						
						SET LI_VERSION_NUMBER = 1;
						
						ELSE 
						
						SELECT DOCUMENT_ID INTO LI_DOCUMENT_ID
						FROM SR_ATTACHMENT WHERE SR_HEADER_ID = LI_SR_HEADER_ID 
						AND FILE_NAME =LS_FILE_NAME AND CONTENT_TYPE = LS_MIME_TYPE
                        AND FILE_DATA_ID = LS_FILE_DATA_ID ;
						
						SELECT MAX(IFNULL(VERSION_NUMBER,0))+1 INTO LI_VERSION_NUMBER
						FROM SR_ATTACHMENT WHERE SR_HEADER_ID = LI_SR_HEADER_ID AND DOCUMENT_ID = LI_DOCUMENT_ID;
						
						END IF;
					
							INSERT INTO SR_ATTACHMENT (
								ACTION_LOG_ID,
								ATTACHMENT,
								CONTENT_TYPE,
								FILE_NAME,
								UPDATE_TIMESTAMP,
								UPDATE_USER,
								SR_HEADER_ID,
								DOCUMENT_ID,
								DOCUMENT_STATUS_CODE,
								FILE_DATA_ID,
								VERSION_NUMBER,
								ATTACHMENT_TYPE_CODE,
								DESCRIPTION,
								CREATED_BY
							) VALUES (
								LI_ACTION_LOG_ID,
								NULL,
								LS_MIME_TYPE,
								LS_FILE_NAME,
								LDD_UPDATE_TIMESTAMP,
								LS_UPDATE_USER,
								LI_SR_HEADER_ID,
								LI_DOCUMENT_ID,
								LI_DOCUMENT_STATUS_CODE,
								LS_FILE_DATA_ID,
								LI_VERSION_NUMBER,
								1,
								LS_DESCRIPTION,
								LS_REPORTER_PERSON_ID
							);
					END IF;		
					END LOOP SEL_AWARD_ATTACH_DATA;
				CLOSE SEL_AWARD_ATTACH_DATA;

			END LOOP SEL_DATA;
		CLOSE SEL_DATA;



END;
//

