databaseChangeLog:

  - changeSet:
      id: FIBI-9132-1
      author: Adarsh
      labels: 'DML'
      comment: Added a new column in SR_CATEGORY table
      changes:
        - sql:
            sql: |
              ANALYZE TABLE SR_CATEGORY;
              SET @sql := IF(
                  (SELECT COUNT(*)
                    FROM information_schema.COLUMNS
                    WHERE TABLE_SCHEMA = DATABASE()
                      AND TABLE_NAME = 'SR_CATEGORY'
                      AND COLUMN_NAME = 'IS_DEFAULT') = 0,
                  'ALTER TABLE SR_CATEGORY ADD COLUMN `IS_DEFAULT` VARCHAR(1) DEFAULT ''N'';',           
                  'DO 1'
              );
              PREPARE stmt FROM @sql;
              EXECUTE stmt;
              DEALLOCATE PREPARE stmt; 
      rollback:
        - sql:
            sql: |
              ALTER TABLE SR_CATEGORY DROP COLUMN IS_DEFAULT;

  - changeSet:
      id: FIBI-9132-2
      author: Adarsh
      labels: 'DML'
      comment: Updated the code table configuration for SR_CATEGORY with new column
      changes:
        - sql:
            sql: |
              UPDATE CODE_TABLE_CONFIGURATION  
              SET CONTENT = '{\n  \"group\": \"Service Request\",\n  \"codeTableName\": \"Service Request Category\",\n  \"description\": \"List of all service request Category\",\n  \"databaseTableName\": \"SR_CATEGORY\",\n  \"fields\": [\n    {\n      \"columnName\": \"CATEGORY_CODE\",\n      \"displayName\": \"Category Code\",\n      \"dataType\": \"String\",\n      \"isEditable\": true,\n      \"length\": 3,\n      \"canEmpty\": false,\n      \"visible\": true,\n      \"valueChanged\": null,\n      \"index\": null,\n      \"filterType\": null,\n      \"valueField\": null,\n      \"isTransient\": null,\n      \"values\": null,\n      \"refColumnName\": null,\n      \"defaultValue\": null\n    },\n    {\n      \"columnName\": \"DESCRIPTION\",\n      \"displayName\": \"Description\",\n      \"dataType\": \"String\",\n      \"isEditable\": true,\n      \"length\": 500,\n      \"canEmpty\": false,\n      \"visible\": true,\n      \"valueChanged\": null,\n      \"index\": null,\n      \"filterType\": null,\n      \"valueField\": null,\n      \"isTransient\": null,\n      \"values\": null,\n      \"refColumnName\": null,\n      \"defaultValue\": null\n    },\n    {\n      \"columnName\": \"UPDATE_TIMESTAMP\",\n      \"displayName\": \"update timestamp\",\n      \"dataType\": \"Date\",\n      \"isEditable\": false,\n      \"length\": null,\n      \"canEmpty\": true,\n      \"visible\": true,\n      \"valueChanged\": null,\n      \"index\": null,\n      \"filterType\": null,\n      \"valueField\": null,\n      \"isTransient\": null,\n      \"values\": null,\n      \"refColumnName\": null,\n      \"defaultValue\": null\n    },\n    {\n      \"columnName\": \"UPDATE_USER\",\n      \"displayName\": \"Update User\",\n      \"dataType\": \"String\",\n      \"isEditable\": false,\n      \"length\": 60,\n      \"canEmpty\": true,\n      \"visible\": true,\n      \"valueChanged\": null,\n      \"index\": null,\n      \"filterType\": null,\n      \"valueField\": null,\n      \"isTransient\": null,\n      \"values\": null,\n      \"refColumnName\": \"PERSON#USER_NAME\",\n      \"defaultValue\": null\n    },\n    {\n      \"columnName\": \"IS_ACTIVE\",\n      \"displayName\": \"Is Active\",\n      \"dataType\": \"String\",\n      \"isEditable\": true,\n      \"length\": 1,\n      \"canEmpty\": false,\n      \"visible\": true,\n      \"valueChanged\": null,\n      \"index\": null,\n      \"filterType\": \"switch\",\n      \"valueField\": null,\n      \"isTransient\": null,\n      \"values\": null,\n      \"refColumnName\": null,\n      \"defaultValue\": null\n    },\n	{\n      \"columnName\": \"IS_DEFAULT\",\n      \"displayName\": \"Is Default\",\n      \"dataType\": \"String\",\n      \"isEditable\": true,\n      \"length\": 1,\n      \"canEmpty\": false,\n      \"visible\": true,\n      \"valueChanged\": null,\n      \"index\": null,\n      \"filterType\": \"switch\",\n      \"valueField\": null,\n      \"isTransient\": null,\n      \"values\": null,\n      \"refColumnName\": null,\n      \"defaultValue\": null\n    }	\n  ],\n  \"primaryKey\": [\n    \"CATEGORY_CODE\"\n  ],\n  \"dependency\": [\n    {\n      \"displayName\": \"Service Request Header\",\n      \"table_name\": \"sr_header\",\n      \"columnName\": \"CATEGORY_CODE\"\n    },\n    {\n      \"displayName\": \"Service Request Type\",\n      \"table_name\": \"sr_type\",\n      \"columnName\": \"CATEGORY_CODE\"\n    }\n  ],\n  \"actions\": null\n}' WHERE (TABLE_NAME = 'SR_CATEGORY'); 
      rollback:
        - sql:
            sql: |
              UPDATE CODE_TABLE_CONFIGURATION
              SET CONTENT = '{\n  \"group\": \"Service Request\",\n  \"codeTableName\": \"Service Request Category\",\n  \"description\": \"List of all service request Category\",\n  \"databaseTableName\": \"SR_CATEGORY\",\n  \"fields\": [\n    {\n      \"columnName\": \"CATEGORY_CODE\",\n      \"displayName\": \"Category Code\",\n      \"dataType\": \"String\",\n      \"isEditable\": true,\n      \"length\": 3,\n      \"canEmpty\": false,\n      \"visible\": true,\n      \"valueChanged\": null,\n      \"index\": null,\n      \"filterType\": null,\n      \"valueField\": null,\n      \"isTransient\": null,\n      \"values\": null,\n      \"refColumnName\": null,\n      \"defaultValue\": null\n    },\n    {\n      \"columnName\": \"DESCRIPTION\",\n      \"displayName\": \"Description\",\n      \"dataType\": \"String\",\n      \"isEditable\": true,\n      \"length\": 500,\n      \"canEmpty\": false,\n      \"visible\": true,\n      \"valueChanged\": null,\n      \"index\": null,\n      \"filterType\": null,\n      \"valueField\": null,\n      \"isTransient\": null,\n      \"values\": null,\n      \"refColumnName\": null,\n      \"defaultValue\": null\n    },\n    {\n      \"columnName\": \"UPDATE_TIMESTAMP\",\n      \"displayName\": \"update timestamp\",\n      \"dataType\": \"Date\",\n      \"isEditable\": false,\n      \"length\": null,\n      \"canEmpty\": true,\n      \"visible\": true,\n      \"valueChanged\": null,\n      \"index\": null,\n      \"filterType\": null,\n      \"valueField\": null,\n      \"isTransient\": null,\n      \"values\": null,\n      \"refColumnName\": null,\n      \"defaultValue\": null\n    },\n    {\n      \"columnName\": \"UPDATE_USER\",\n      \"displayName\": \"Update User\",\n      \"dataType\": \"String\",\n      \"isEditable\": false,\n      \"length\": 60,\n      \"canEmpty\": true,\n      \"visible\": true,\n      \"valueChanged\": null,\n      \"index\": null,\n      \"filterType\": null,\n      \"valueField\": null,\n      \"isTransient\": null,\n      \"values\": null,\n      \"refColumnName\": \"PERSON#USER_NAME\",\n      \"defaultValue\": null\n    },\n    {\n      \"columnName\": \"IS_ACTIVE\",\n      \"displayName\": \"Is Active\",\n      \"dataType\": \"String\",\n      \"isEditable\": true,\n      \"length\": 1,\n      \"canEmpty\": false,\n      \"visible\": true,\n      \"valueChanged\": null,\n      \"index\": null,\n      \"filterType\": \"switch\",\n      \"valueField\": null,\n      \"isTransient\": null,\n      \"values\": null,\n      \"refColumnName\": null,\n      \"defaultValue\": null\n    }	\n  ],\n  \"primaryKey\": [\n    \"CATEGORY_CODE\"\n  ],\n  \"dependency\": [\n    {\n      \"displayName\": \"Service Request Header\",\n      \"table_name\": \"sr_header\",\n      \"columnName\": \"CATEGORY_CODE\"\n    },\n    {\n      \"displayName\": \"Service Request Type\",\n      \"table_name\": \"sr_type\",\n      \"columnName\": \"CATEGORY_CODE\"\n    }\n  ],\n  \"actions\": null\n}' WHERE (TABLE_NAME = 'SR_CATEGORY');

  - changeSet:
      id: FIBI-9134-1
      author: Reshma Antony
      labels: 'DML'
      comment: Insert into DYN_ELEMENT_CONFIG for Service Request Project association.
      changes:
        - sql:
            sql: |
              INSERT INTO DYN_ELEMENT_CONFIG (UI_REFERENCE_ID, DESCRIPTION, SUB_SECTION_CODE, SECTION_CODE, HELP, UPDATE_USER, UPDATE_TIMESTAMP) 
              SELECT 'sr-prj-assoc-module', 'Service Request Project assoc Module', '2018', 'SR2001', 'Select the module that most accurately matches the purpose of this record.', 'admin', UTC_TIMESTAMP() 
                WHERE NOT EXISTS (
                    SELECT 1 FROM DYN_ELEMENT_CONFIG WHERE UI_REFERENCE_ID = 'sr-prj-assoc-module');                      
              INSERT INTO DYN_ELEMENT_CONFIG (UI_REFERENCE_ID, DESCRIPTION, SUB_SECTION_CODE, SECTION_CODE, HELP, UPDATE_USER, UPDATE_TIMESTAMP) 
              SELECT 'sr-prj-assoc-relation-type', 'Service Request Project asscoc Relation type', '2018', 'SR2001', 'Indicates the relationship between the current record and the selected linked record.', 'admin', UTC_TIMESTAMP()
              WHERE NOT EXISTS (
                  SELECT 1 FROM DYN_ELEMENT_CONFIG WHERE UI_REFERENCE_ID = 'sr-prj-assoc-relation-type'
              );
              INSERT INTO DYN_ELEMENT_CONFIG (UI_REFERENCE_ID, DESCRIPTION, SUB_SECTION_CODE, SECTION_CODE, HELP, UPDATE_USER, UPDATE_TIMESTAMP)
              SELECT 'sr-prj-assoc-link-to', 'Service Request Project asscoc Link to','2018', 
                  'SR2001', 'Search for and select the appropriate record to establish the association.', 'admin', UTC_TIMESTAMP()
              WHERE NOT EXISTS (
                  SELECT 1 FROM DYN_ELEMENT_CONFIG WHERE UI_REFERENCE_ID = 'sr-prj-assoc-link-to'
              );
      rollback: 
        - sql:
            sql: |    
              DELETE FROM `DYN_ELEMENT_CONFIG` WHERE UI_REFERENCE_ID = 'sr-prj-assoc-link-to';         
              DELETE FROM `DYN_ELEMENT_CONFIG` WHERE UI_REFERENCE_ID = 'sr-prj-assoc-relation-type';
              DELETE FROM `DYN_ELEMENT_CONFIG` WHERE UI_REFERENCE_ID = 'sr-prj-assoc-module';

