#!/bin/bash

# Post-commit hook to automatically sync CORE module changes to COI repository
# This hook is triggered after every commit in fibi-test

# Get the directory where this hook is located
HOOK_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_ROOT="$(cd "$HOOK_DIR/../.." && pwd)"
SYNC_SCRIPT="$REPO_ROOT/scripts/sync-core-to-coi.sh"

# Check if sync script exists
if [ ! -f "$SYNC_SCRIPT" ]; then
    echo "Warning: Sync script not found at $SYNC_SCRIPT"
    exit 0  # Don't fail the commit if sync script is missing
fi

# Get the list of files changed in the last commit
CHANGED_FILES=$(git diff-tree --no-commit-id --name-only -r HEAD)

# Check if any CORE module files were changed
CORE_CHANGED=false
for file in $CHANGED_FILES; do
    # Check if file is in FIBI_CORE directory (case-insensitive)
    if echo "$file" | grep -qi "FIBI_CORE\|Fibi-Vanilla/FIBI_CORE"; then
        CORE_CHANGED=true
        break
    fi
done

# If CORE module was changed, trigger sync
if [ "$CORE_CHANGED" = true ]; then
    echo ""
    echo "========================================="
    echo "CORE module changes detected!"
    echo "Triggering automatic sync to COI repository..."
    echo "========================================="
    echo ""
    
    # Get commit message for reference
    COMMIT_MSG=$(git log -1 --pretty=format:"%s")
    
    # Run the sync script
    bash "$SYNC_SCRIPT" "$COMMIT_MSG"
    
    SYNC_EXIT_CODE=$?
    if [ $SYNC_EXIT_CODE -eq 0 ]; then
        echo ""
        echo "========================================="
        echo "CORE sync completed successfully!"
        echo "========================================="
        echo ""
    else
        echo ""
        echo "========================================="
        echo "Warning: CORE sync encountered an error"
        echo "You may need to sync manually using:"
        echo "  bash $SYNC_SCRIPT"
        echo "========================================="
        echo ""
    fi
fi

exit 0  # Always exit successfully to not block the commit

