CREATE PROCEDURE `SR_CONTRACT_ADMIN_UPDATION`(AV_MODULE_KEY INT, AV_CHANGED_UNIT VARCHAR(20), AV_UPDATED_PERSON VARCHAR(200), AV_UPDATE_TIME TIMESTAMP)
PROC:BEGIN

    DECLARE LI_CUSTOM_ELEMENT_ID INT;
    DECLARE LI_CUSTOM_DATA_ID INT;
    DECLARE LS_CUSTOM_ELEMENT_LABEL VARCHAR(100);
    DECLARE LI_CD_COUNT INT;
    DECLARE LI_SR_STATUS_CODE INT;

    DECLARE LS_SR_REPORTER_ID VARCHAR(20);
    DECLARE LS_SR_REPORTER_NAME VARCHAR(100);

    DECLARE LS_PERSON_NAME VARCHAR(100);
	DECLARE LS_PERSON_ID VARCHAR(20);
    DECLARE LS_PREV_PERSON_NAME VARCHAR(100);
    DECLARE LS_PREV_PERSON_ID VARCHAR(20);

    DECLARE PRV_CUSTOM_DATA JSON DEFAULT JSON_OBJECT();
    DECLARE UPD_CUSTOM_DATA JSON DEFAULT JSON_OBJECT();

    DECLARE LOG_ID INT;

    SELECT cde.CUSTOM_DATA_ELEMENTS_ID, cde.COLUMN_LABEL
    INTO LI_CUSTOM_ELEMENT_ID, LS_CUSTOM_ELEMENT_LABEL
    FROM CUSTOM_DATA_ELEMENT_USAGE cdeu JOIN CUSTOM_DATA_ELEMENTS cde 
	ON cdeu.CUSTOM_DATA_ELEMENTS_ID = cde.CUSTOM_DATA_ELEMENTS_ID
    WHERE cdeu.MODULE_CODE = 20 AND cde.IS_ACTIVE = 'Y'
	AND cde.CUSTOM_ELEMENT_NAME = 'Contract Admin';

    IF LI_CUSTOM_ELEMENT_ID IS NULL THEN
        LEAVE PROC;
    END IF;

    SELECT STATUS_CODE, REPORTER_PERSON_ID 
    INTO LI_SR_STATUS_CODE, LS_SR_REPORTER_ID
    FROM SR_HEADER 
    WHERE SR_HEADER_ID = AV_MODULE_KEY;

    SELECT FULL_NAME INTO LS_SR_REPORTER_NAME 
    FROM PERSON WHERE PERSON_ID = LS_SR_REPORTER_ID;

    SELECT p.FULL_NAME, p.PERSON_ID INTO LS_PERSON_NAME, LS_PERSON_ID
    FROM UNIT_ADMINISTRATOR ua
    JOIN PERSON p ON ua.PERSON_ID = p.PERSON_ID
    WHERE ua.UNIT_ADMINISTRATOR_TYPE_CODE = 12
	AND ua.UNIT_NUMBER = AV_CHANGED_UNIT AND p.STATUS = 'A'
    ORDER BY ua.UPDATE_TIMESTAMP DESC LIMIT 1;

    SELECT COUNT(*) INTO LI_CD_COUNT
    FROM CUSTOM_DATA
    WHERE MODULE_ITEM_CODE = 20
	AND CUSTOM_DATA_ELEMENTS_ID = LI_CUSTOM_ELEMENT_ID
	AND MODULE_ITEM_KEY = AV_MODULE_KEY;

    IF LI_SR_STATUS_CODE != 1 THEN

        IF LI_CD_COUNT > 0 THEN

            SELECT CUSTOM_DATA_ID, DESCRIPTION, VALUE 
            INTO LI_CUSTOM_DATA_ID, LS_PREV_PERSON_NAME, LS_PREV_PERSON_ID
            FROM CUSTOM_DATA WHERE MODULE_ITEM_CODE = 20
			AND CUSTOM_DATA_ELEMENTS_ID = LI_CUSTOM_ELEMENT_ID
			AND MODULE_ITEM_KEY = AV_MODULE_KEY;

            SET PRV_CUSTOM_DATA = JSON_OBJECT(
                'label', LS_CUSTOM_ELEMENT_LABEL,
                'answers', JSON_ARRAY(
                    JSON_OBJECT(
                        'customDataId', LI_CUSTOM_DATA_ID,
                        'value', LS_PREV_PERSON_ID,
                        'description', LS_PREV_PERSON_NAME,
                        'moduleItemKey', AV_MODULE_KEY,
                        'moduleItemCode', 20,
                        'moduleSubItemKey', 0,
                        'moduleSubItemCode', 0,
                        'customDataElementsId', LI_CUSTOM_ELEMENT_ID)),
                'isMultiselect', FALSE,
                'isDescriptionBased', TRUE);
                
        ELSE
        
            SET PRV_CUSTOM_DATA = JSON_OBJECT(
                'label', LS_CUSTOM_ELEMENT_LABEL,
                'answers', NULL,
                'isMultiselect', FALSE,
                'isDescriptionBased', TRUE);
                
        END IF;

        SET UPD_CUSTOM_DATA = JSON_OBJECT(
            'label', LS_CUSTOM_ELEMENT_LABEL,
            'answers', JSON_ARRAY(
                JSON_OBJECT(
                    'customDataId', LI_CUSTOM_DATA_ID,
                    'value', LS_PERSON_ID,
                    'description', LS_PERSON_NAME,
                    'moduleItemKey', AV_MODULE_KEY,
                    'moduleItemCode', 20,
                    'moduleSubItemKey', 0,
                    'moduleSubItemCode', 0,
                    'customDataElementsId', LI_CUSTOM_ELEMENT_ID)),
            'isMultiselect', FALSE,
            'isDescriptionBased', TRUE);
            
		IF NOT (LS_PERSON_NAME <=> LS_PREV_PERSON_NAME) THEN
			INSERT INTO SR_ACTION_LOG
			(ACTION_TYPE_CODE, ASSIGNEE_PERSON_ID, ASSIGNEE_PERSON_NAME, STATUS_CODE, UPDATE_TIMESTAMP, UPDATE_USER, SR_HEADER_ID)
			VALUES (8, LS_SR_REPORTER_ID, LS_SR_REPORTER_NAME, LI_SR_STATUS_CODE, AV_UPDATE_TIME, AV_UPDATED_PERSON, AV_MODULE_KEY);

			SET LOG_ID = LAST_INSERT_ID();

			INSERT INTO SR_HEADER_HISTORY
			(ACTION_LOG_ID, UPDATE_TIMESTAMP, UPDATE_USER, SR_HEADER_ID, PREV_CUSTOM_DATA, CUSTOM_DATA)
			VALUES (LOG_ID, AV_UPDATE_TIME, AV_UPDATED_PERSON, AV_MODULE_KEY, PRV_CUSTOM_DATA, UPD_CUSTOM_DATA);
        END IF;
        
    END IF;
    
	SET @colname = CONCAT('CUST_ELEMENTS_ID_', LI_CUSTOM_ELEMENT_ID);

    IF LI_CD_COUNT > 0 THEN
    
        UPDATE CUSTOM_DATA SET VALUE = LS_PERSON_ID,
        DESCRIPTION = LS_PERSON_NAME,
        UPDATE_TIMESTAMP = AV_UPDATE_TIME,
		UPDATE_USER = AV_UPDATED_PERSON WHERE MODULE_ITEM_CODE = 20
		AND CUSTOM_DATA_ELEMENTS_ID = LI_CUSTOM_ELEMENT_ID
		AND MODULE_ITEM_KEY = AV_MODULE_KEY;
        
        CALL SR_CUSTOM_DATA_RT_SYNC_BY_SR_HEADER_ID(AV_MODULE_KEY, NULL);

    ELSE
    
        INSERT INTO CUSTOM_DATA
        (CUSTOM_DATA_ELEMENTS_ID, MODULE_ITEM_CODE, MODULE_ITEM_KEY, MODULE_SUB_ITEM_CODE, MODULE_SUB_ITEM_KEY, UPDATE_TIMESTAMP, UPDATE_USER, DESCRIPTION, VALUE)
        VALUES
        (LI_CUSTOM_ELEMENT_ID, 20, AV_MODULE_KEY, 0, 0, AV_UPDATE_TIME, AV_UPDATED_PERSON, LS_PERSON_NAME, LS_PERSON_ID);
       
         CALL SR_CUSTOM_DATA_RT_SYNC_BY_SR_HEADER_ID(AV_MODULE_KEY, NULL);

    END IF;

END PROC
