CREATE OR REPLACE PROCEDURE GET_UNIT_DATA_FOR_SYNC (
    AV_START_TIMESTAMP IN TIMESTAMP,
    AV_END_TIMESTAMP   IN TIMESTAMP,
    AV_OFFSET          IN NUMBER,
    AV_LIMIT           IN NUMBER,
    AV_RESULT_SET      OUT SYS_REFCURSOR
) IS
BEGIN
    OPEN AV_RESULT_SET FOR
    WITH unit_hierarchy AS (
        SELECT 
            UNIT_NUMBER,
            UNIT_NAME,
            ORGANIZATION_ID,
            UPDATE_TIMESTAMP,
            UPDATE_USER,
            PARENT_UNIT_NUMBER,
            ACTIVE_FLAG,
            ACRONYM,
            PARENT_UNIT_NAME
        FROM unit
        START WITH PARENT_UNIT_NUMBER IS NULL
        CONNECT BY PRIOR UNIT_NUMBER = PARENT_UNIT_NUMBER
        ORDER SIBLINGS BY UNIT_NUMBER
    )
    SELECT 
        UNIT_NUMBER,
        UNIT_NAME,
        ORGANIZATION_ID,
        UPDATE_TIMESTAMP,
        UPDATE_USER,
        PARENT_UNIT_NUMBER,
        ACTIVE_FLAG,
        ACRONYM,
        PARENT_UNIT_NAME
    FROM unit_hierarchy
    WHERE UPDATE_TIMESTAMP BETWEEN AV_START_TIMESTAMP AND AV_END_TIMESTAMP
    OFFSET AV_OFFSET ROWS
    FETCH NEXT AV_LIMIT ROWS ONLY;
END;
