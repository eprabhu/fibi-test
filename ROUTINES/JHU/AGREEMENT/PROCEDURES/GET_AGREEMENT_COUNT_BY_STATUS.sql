CREATE PROCEDURE GET_AGREEMENT_COUNT_BY_STATUS(
AV_PERSON_ID VARCHAR(40),
AV_UNIT_NUMBER VARCHAR(50),
AV_DESCENT_FLAG VARCHAR(1)
)
BEGIN
DECLARE LS_DYN_SQL LONGTEXT DEFAULT '';
DECLARE LS_UNIT_NUMBER_CONDITION LONGTEXT;
DECLARE LS_UNIT_CONDITION LONGTEXT  DEFAULT '';
DECLARE LS_CHILD_UNIT_CONDITION LONGTEXT  DEFAULT '';


    IF AV_UNIT_NUMBER IS NULL OR AV_UNIT_NUMBER = '' THEN 
        SET LS_UNIT_NUMBER_CONDITION = 'NULL';
    ELSE
        SET LS_UNIT_NUMBER_CONDITION = CONCAT("'", AV_UNIT_NUMBER, "'");
        IF AV_UNIT_NUMBER IS NOT NULL AND AV_DESCENT_FLAG = 'Y' THEN 
	        SET LS_CHILD_UNIT_CONDITION = CONCAT(' OR T1.UNIT_NUMBER IN (SELECT CHILD_UNIT_NUMBER FROM UNIT_WITH_CHILDREN WHERE UNIT_NUMBER = ',LS_UNIT_NUMBER_CONDITION,')');	
		END IF;
    END IF;

SET LS_DYN_SQL = CONCAT('
    WITH ACCESS_TMP_ADMIN 
							AS
							(
							SELECT UNIT_NUMBER
							FROM PERSON_ROLES T1
							INNER JOIN ROLE_RIGHTS T2 ON T1.ROLE_ID = T2.ROLE_ID
							INNER JOIN RIGHTS T3 ON T2.RIGHT_ID = T3.RIGHT_ID 
							WHERE T1.DESCEND_FLAG = ''N'' AND T1.PERSON_ID = ''',AV_PERSON_ID,'''
							AND RIGHT_NAME IN (''AGREEMENT_ADMINISTRATOR'',''VIEW_ADMIN_GROUP_AGREEMENT'',''VIEW_ALL_AGREEMENT'',''MODIFY_ALL_AGREEMENT'') 							
							UNION
							SELECT CHILD_UNIT_NUMBER FROM UNIT_WITH_CHILDREN 
							WHERE UNIT_NUMBER IN (
							SELECT UNIT_NUMBER
							FROM PERSON_ROLES T1
							INNER JOIN ROLE_RIGHTS T2 ON T1.ROLE_ID = T2.ROLE_ID
							INNER JOIN RIGHTS T3 ON T2.RIGHT_ID = T3.RIGHT_ID 
							WHERE T1.DESCEND_FLAG = ''Y'' AND T1.PERSON_ID = ''',AV_PERSON_ID,'''
							AND RIGHT_NAME IN (''AGREEMENT_ADMINISTRATOR'',''VIEW_ADMIN_GROUP_AGREEMENT'',''VIEW_ALL_AGREEMENT'',''MODIFY_ALL_AGREEMENT'') 
                            ))
        SELECT
			T6.DESCRIPTION,
			T6.AGREEMENT_STATUS_CODE,
			COALESCE(COUNT(T.AGREEMENT_REQUEST_ID), 0) AS RECORD_COUNT
        FROM (
            SELECT DISTINCT
                T1.AGREEMENT_REQUEST_ID,
                T1.AGREEMENT_STATUS_CODE
            FROM AGREEMENT_HEADER T1
            LEFT JOIN ADMIN_GROUP T50 ON T1.ADMIN_GROUP_ID = T50.ADMIN_GROUP_ID
            INNER JOIN NEGOTIATION_ASSOCIATION S0 ON T1.AGREEMENT_REQUEST_ID = S0.ASSOCIATED_PROJECT_ID AND S0.ASSOCIATION_TYPE_CODE = 4
            WHERE T1.AGREEMENT_SEQUENCE_STATUS <> ''TEMPLATE'' AND (T1.IS_HOLD = ''N'' OR T1.IS_HOLD IS NULL)
              AND (', LS_UNIT_NUMBER_CONDITION, ' IS NULL OR T1.UNIT_NUMBER = ', LS_UNIT_NUMBER_CONDITION, LS_CHILD_UNIT_CONDITION, ')
              AND (
                  T1.AGREEMENT_REQUEST_ID IN (
                      SELECT R1.AGREEMENT_REQUEST_ID 
                      FROM AGREEMENT_PEOPLE_ROLES R1
                      INNER JOIN ROLE_RIGHTS R2 ON R1.ROLE_ID = R2.ROLE_ID
                      INNER JOIN RIGHTS R3 ON R2.RIGHT_ID = R3.RIGHT_ID 
                      WHERE R1.PERSON_ID = ''', AV_PERSON_ID, '''
                  )
                  OR T1.UNIT_NUMBER IN (SELECT DISTINCT UNIT_NUMBER FROM ACCESS_TMP_ADMIN)
                  OR T1.REQUESTOR_PERSON_ID = ''', AV_PERSON_ID, '''
                  OR EXISTS (
                      SELECT S1.NEGOTIATION_LOCATION_ID 
                      FROM NEGOTIATION_LOCATION S1 
                      WHERE S1.NEGOTIATION_ID = S0.NEGOTIATION_ID 
                        AND S1.ASSIGNEE_PERSON_ID = ''', AV_PERSON_ID, '''
                  )
                  OR T1.AGREEMENT_REQUEST_ID IN (
                      SELECT T9.MODULE_ITEM_ID 
                      FROM WORKFLOW T9
                      INNER JOIN WORKFLOW_DETAIL T10 ON T9.WORKFLOW_ID = T10.WORKFLOW_ID
                      WHERE T9.MODULE_CODE = 13 
                        AND T10.APPROVER_PERSON_ID = ''', AV_PERSON_ID, '''
                        AND T9.MODULE_ITEM_ID = T1.AGREEMENT_REQUEST_ID
                        AND T9.IS_WORKFLOW_ACTIVE = ''Y''
                        AND T10.APPROVAL_STATUS = ''W''
                  )
                  OR T1.ADMIN_PERSON_ID = ''', AV_PERSON_ID, '''
                  OR T1.AGREEMENT_REQUEST_ID IN (select AGREEMENT_REQUEST_ID FROM AGREEMENT_PEOPLE WHERE  PEOPLE_TYPE_ID = 3 AND PERSON_ID = ''', AV_PERSON_ID, ''')
                  OR (T50.ROLE_ID IN (SELECT T51.ROLE_ID FROM ROLE_RIGHTS T51 
																	LEFT JOIN RIGHTS T52 ON T51.RIGHT_ID = T52.RIGHT_ID
																	LEFT JOIN PERSON_ROLES T53 ON T51.ROLE_ID = T53.ROLE_ID
																	WHERE T53.PERSON_ID = ''', AV_PERSON_ID ,''' AND T52.RIGHT_NAME = ''VIEW_ADMIN_GROUP_AGREEMENT''))
		)
	) T
	RIGHT JOIN AGREEMENT_STATUS T6 ON T.AGREEMENT_STATUS_CODE = T6.AGREEMENT_STATUS_CODE
	INNER JOIN AGREEMENT_STATUS T7 ON T6.AGREEMENT_STATUS_CODE = T7.AGREEMENT_STATUS_CODE AND T7.IS_ACTIVE = ''Y''
	GROUP BY T6.AGREEMENT_STATUS_CODE, T6.DESCRIPTION
    ORDER BY T6.SORT_ORDER ASC;
');

SET @QUERY_STATEMENT = LS_DYN_SQL;
PREPARE EXECUTABLE_STAEMENT FROM @QUERY_STATEMENT;
EXECUTE EXECUTABLE_STAEMENT;

END
