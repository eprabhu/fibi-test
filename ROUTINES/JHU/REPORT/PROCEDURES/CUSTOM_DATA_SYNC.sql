CREATE PROCEDURE `CUSTOM_DATA_SYNC`()
BEGIN 
DECLARE LD_SYNC_INTERVAL_START_TIME DATETIME;
DECLARE LD_SYNC_INTERVAL_END_TIME DATETIME;
DECLARE LD_CURRENT_TIMESTAMP DATETIME;
DECLARE LS_DYN_SQL LONGTEXT;
DECLARE AWARD_IDS LONGTEXT;
DECLARE AWARD_NUMBERS LONGTEXT;


DECLARE EXIT HANDLER FOR SQLEXCEPTION
BEGIN
GET DIAGNOSTICS CONDITION 1 @sqlstate = RETURNED_SQLSTATE, @errno = MYSQL_ERRNO, @msg = MESSAGE_TEXT;
             
IF @msg != 'ERR:AWARD_MASTER_DATASET_SYNC' THEN
	SELECT CONCAT('Count of failed : ', (SELECT COUNT(1) FROM TEMP_AWARD_MASTER_DATASET)) AS ''
		  UNION
	SELECT 'The awards which got failed while syncing custom data is as listed below:';
	SELECT AWARD_ID,AWARD_NUMBER FROM TEMP_AWARD_MASTER_DATASET;
	ROLLBACK;
	TRUNCATE TEMP_AWARD_MASTER_DATASET;
END IF;

END;

SELECT  UTC_TIMESTAMP() INTO LD_CURRENT_TIMESTAMP;
SELECT  DATE_SUB(LAST_SYNC_TIMESTAMP,INTERVAL 4 MINUTE) INTO LD_SYNC_INTERVAL_START_TIME FROM REPORT_LAST_SYNC_TIME;
SELECT  DATE_SUB(LD_CURRENT_TIMESTAMP, INTERVAL 3 MINUTE) INTO LD_SYNC_INTERVAL_END_TIME;

SET SQL_SAFE_UPDATES = 0;
SET TRANSACTION ISOLATION LEVEL READ COMMITTED;
TRUNCATE TEMP_AWARD_MASTER_DATASET;
 
INSERT INTO TEMP_AWARD_MASTER_DATASET (AWARD_ID, AWARD_NUMBER)
(SELECT
A3.AWARD_ID, A3.AWARD_NUMBER
FROM AWARD A3
WHERE A3.DOCUMENT_UPDATE_TIMESTAMP BETWEEN LD_SYNC_INTERVAL_START_TIME AND LD_SYNC_INTERVAL_END_TIME
AND ((A3.AWARD_SEQUENCE_STATUS = 'PENDING' AND A3.SEQUENCE_NUMBER = 1)
OR
(A3.AWARD_SEQUENCE_STATUS = 'ACTIVE')));

COMMIT;

SET SESSION group_concat_max_len = 10000000;

SELECT GROUP_CONCAT(A3.AWARD_ID) INTO AWARD_IDS FROM AWARD A3
WHERE A3.DOCUMENT_UPDATE_TIMESTAMP BETWEEN LD_SYNC_INTERVAL_START_TIME AND LD_SYNC_INTERVAL_END_TIME
AND (
(A3.AWARD_SEQUENCE_STATUS IN('PENDING','ARCHIVE','CANCELLED') AND A3.SEQUENCE_NUMBER = 1)
OR
A3.AWARD_SEQUENCE_STATUS IN('ACTIVE'));




SELECT GROUP_CONCAT('''', A3.AWARD_NUMBER ,'''') INTO AWARD_NUMBERS FROM AWARD A3
WHERE A3.DOCUMENT_UPDATE_TIMESTAMP BETWEEN LD_SYNC_INTERVAL_START_TIME AND LD_SYNC_INTERVAL_END_TIME
AND ((A3.AWARD_SEQUENCE_STATUS IN('PENDING','ARCHIVE','CANCELLED')
AND A3.SEQUENCE_NUMBER = 1) OR
A3.AWARD_SEQUENCE_STATUS IN('ACTIVE'));


IF AWARD_NUMBERS IS NOT NULL THEN
SET LS_DYN_SQL  = CONCAT('DELETE FROM AWARD_ORG_APPROVED_BUDGET_RT T1
WHERE T1.AWARD_NUMBER IN(', AWARD_NUMBERS, ')');
SET @QUERY_STATEMENT = LS_DYN_SQL;
PREPARE EXECUTABLE_STAEMENT FROM @QUERY_STATEMENT;
EXECUTE EXECUTABLE_STAEMENT;
END IF;

IF AWARD_NUMBERS IS NOT NULL THEN
SET LS_DYN_SQL  = CONCAT('DELETE FROM AWARD_LATEST_APROVED_BUDGET_RT T1
WHERE T1.AWARD_NUMBER IN(', AWARD_NUMBERS, ')');
SET @QUERY_STATEMENT = LS_DYN_SQL;
PREPARE EXECUTABLE_STAEMENT FROM @QUERY_STATEMENT;
EXECUTE EXECUTABLE_STAEMENT;
END IF;
 
 
INSERT INTO AWARD_ORG_APPROVED_BUDGET_RT(
AWARD_ID,
AWARD_NUMBER,
BUDGET_CATEGORY_CODE,
ORIGINAL_APPROVED_BUDGET)
  (SELECT
T1.AWARD_ID,
T1.AWARD_NUMBER,
T2.BUDGET_CATEGORY_CODE,
SUM(T2.LINE_ITEM_COST) ORG_APRVED_BUD_BYBUDGET_CATEGORY
FROM AWARD_BUDGET_HEADER T1
INNER JOIN AWARD_BUDGET_DETAIL T2 ON T1.BUDGET_HEADER_ID = T2.BUDGET_HEADER_ID
WHERE  T1.AWARD_ID IN(SELECT
A3.AWARD_ID
FROM TEMP_AWARD_MASTER_DATASET A3)
AND T1.VERSION_NUMBER IN (SELECT MIN(AB1.VERSION_NUMBER) FROM AWARD_BUDGET_HEADER AB1
WHERE AB1.AWARD_ID = T1.AWARD_ID)
GROUP BY T1.AWARD_NUMBER,T2.BUDGET_CATEGORY_CODE
);
 
 
INSERT INTO AWARD_LATEST_APROVED_BUDGET_RT(
AWARD_ID,
AWARD_NUMBER,
BUDGET_CATEGORY_CODE,
LATEST_APPROVED_BUDGET)
  (SELECT
T1.AWARD_ID,
T1.AWARD_NUMBER,
T2.BUDGET_CATEGORY_CODE,
SUM(T2.LINE_ITEM_COST) LATEST_APRVED_BUD_BYBUDGET_CATEGORY
FROM AWARD_BUDGET_HEADER T1
INNER JOIN AWARD_BUDGET_DETAIL T2 ON T1.BUDGET_HEADER_ID = T2.BUDGET_HEADER_ID
WHERE  T1.AWARD_ID IN(SELECT
A3.AWARD_ID
FROM TEMP_AWARD_MASTER_DATASET A3)
AND T1.VERSION_NUMBER IN (SELECT MAX(AB1.VERSION_NUMBER) FROM AWARD_BUDGET_HEADER AB1
WHERE AB1.AWARD_ID = T1.AWARD_ID)
GROUP BY T1.AWARD_NUMBER,T2.BUDGET_CATEGORY_CODE
);


IF AWARD_NUMBERS IS NOT NULL THEN
						
	SET LS_DYN_SQL  = CONCAT('DELETE FROM AWARD_ORIGINAL_L2_AMT_RT T1
	WHERE T1.AWARD_NUMBER IN(', AWARD_NUMBERS, ')');
	
	SET @QUERY_STATEMENT = LS_DYN_SQL;
	PREPARE EXECUTABLE_STAEMENT FROM @QUERY_STATEMENT;
	EXECUTE EXECUTABLE_STAEMENT;

END IF;
        INSERT INTO AWARD_ORIGINAL_L2_AMT_RT(
        AWARD_NUMBER,
        INTERNAL_ORDER_CODE,
        AMOUNT)
        ( SELECT T0.AWARD_NUMBER, T2.INTERNAL_ORDER_CODE, T2.LINE_ITEM_COST
				FROM AWARD T0
				INNER JOIN AWARD_BUDGET_HEADER T1 ON T0.AWARD_ID = T1.AWARD_ID
				INNER JOIN AWARD_BUDGET_DETAIL T2 ON T1.BUDGET_HEADER_ID = T2.BUDGET_HEADER_ID
				WHERE T0.DOCUMENT_UPDATE_TIMESTAMP BETWEEN LD_SYNC_INTERVAL_START_TIME AND LD_SYNC_INTERVAL_END_TIME
										AND ((T0.AWARD_SEQUENCE_STATUS = 'PENDING' AND T0.SEQUENCE_NUMBER = 1) 
                                        OR 
                                        (T0.AWARD_SEQUENCE_STATUS = 'ACTIVE'))
				AND T1.VERSION_NUMBER IN (SELECT MIN(S1.VERSION_NUMBER) FROM AWARD_BUDGET_HEADER S1 WHERE S1.AWARD_ID = T1.AWARD_ID)
        );
 
call AWARD_MASTER_DATASET_SYNC();



SET SQL_SAFE_UPDATES = 0;
 
DELETE FROM AWARD_ORG_APPROVED_BUDGET_RT WHERE AWARD_ID NOT IN (SELECT AWARD_ID FROM AWARD);
DELETE FROM AWARD_LATEST_APROVED_BUDGET_RT WHERE AWARD_ID NOT IN (SELECT AWARD_ID FROM AWARD);
DELETE FROM AWARD_ORIGINAL_L2_AMT_RT WHERE AWARD_NUMBER NOT IN (SELECT AWARD_NUMBER FROM AWARD);


SELECT 'CUSTOM_DATA_SYNC executed successfully' AS SUCCESS FROM DUAL;
CALL AWARD_MASTER_DATASET_SYNC();

SET SQL_SAFE_UPDATES = 0;
UPDATE REPORT_LAST_SYNC_TIME SET LAST_SYNC_TIMESTAMP = LD_CURRENT_TIMESTAMP;
SET SQL_SAFE_UPDATES = 1;
SELECT 1 AS SUCCESS FROM DUAL;
SET TRANSACTION ISOLATION LEVEL REPEATABLE READ;

END
