CREATE PROCEDURE `GET_SERVICE_REQUEST_WIDGET_COUNT`(
      AV_WIDGET VARCHAR(200),
      AV_PERSON_ID VARCHAR(40),
      AV_UNIT_NUMBER VARCHAR(50),
      AV_TYPE_CODES VARCHAR(200),
      AV_STATUS_CODES VARCHAR(200),
      AV_ASSIGNEE_PERSON_ID VARCHAR(40),
      AV_REPORTER_PERSON_ID VARCHAR(40),
      AV_START_DATE VARCHAR(30),
      AV_END_DATE VARCHAR(30),
	  AV_PRIORITIES VARCHAR(10),
	  AV_DESCENT_FLAG VARCHAR(1)
)
BEGIN
    DECLARE LS_DYN_SQL LONGTEXT DEFAULT '';
    DECLARE LS_FILTER_CONDITIONS LONGTEXT DEFAULT '';
    DECLARE LS_UNIT_CONDITION LONGTEXT;
    DECLARE JOIN_CONDITION LONGTEXT;
	SET LS_UNIT_CONDITION = '';
    SET JOIN_CONDITION = '';
    
    SET LS_DYN_SQL = CONCAT('WITH ACCESS_TMP AS 
                            (
                                SELECT UNIT_NUMBER
                                FROM PERSON_ROLES T1
                                INNER JOIN ROLE_RIGHTS T2 ON T1.ROLE_ID = T2.ROLE_ID
                                INNER JOIN RIGHTS T3 ON T2.RIGHT_ID = T3.RIGHT_ID 
                                WHERE T1.DESCEND_FLAG = ''N'' AND T1.PERSON_ID = ''', AV_PERSON_ID ,'''
                                AND T3.RIGHT_NAME IN (''SERVICE_REQUEST_ADMINISTRATOR'', ''MODIFY_SERVICE_REQUEST'', ''VIEW_SERVICE_REQUEST'')
                                UNION
                                SELECT CHILD_UNIT_NUMBER FROM UNIT_WITH_CHILDREN 
                                WHERE UNIT_NUMBER IN 
                                (
                                    SELECT UNIT_NUMBER
                                    FROM PERSON_ROLES T1
                                    INNER JOIN ROLE_RIGHTS T2 ON T1.ROLE_ID = T2.ROLE_ID
                                    INNER JOIN RIGHTS T3 ON T2.RIGHT_ID = T3.RIGHT_ID 
                                    WHERE T1.DESCEND_FLAG = ''Y'' AND T1.PERSON_ID = ''', AV_PERSON_ID ,'''
                                    AND T3.RIGHT_NAME IN (''SERVICE_REQUEST_ADMINISTRATOR'', ''MODIFY_SERVICE_REQUEST'', ''VIEW_SERVICE_REQUEST'')
                                )
                            ),
                            SR_TEMP AS 
                            (
                                SELECT s.SR_HEADER_ID 
                                FROM SR_HEADER s 
                                INNER JOIN WORKFLOW T9 ON T9.MODULE_ITEM_ID = s.SR_HEADER_ID
                                INNER JOIN WORKFLOW_DETAIL T10 ON T9.WORKFLOW_ID = T10.WORKFLOW_ID
                                WHERE T10.APPROVER_PERSON_ID = ''', AV_PERSON_ID ,'''
                                AND T9.MODULE_CODE = 20 
                                AND T9.IS_WORKFLOW_ACTIVE = ''Y'' 
                                AND T10.APPROVAL_STATUS = ''W''
                            ),
                            SR_HEADER_IDS AS 
                            (
                                SELECT DISTINCT SR_HEADER_ID 
                                FROM SR_PERSON_ROLES T5
                                INNER JOIN ROLE_RIGHTS rr ON rr.ROLE_ID = T5.ROLE_ID
                                INNER JOIN RIGHTS r ON r.RIGHT_ID = rr.RIGHT_ID 
                                WHERE r.RIGHT_NAME IN (''SERVICE_REQUEST_WATCHER'', ''MODIFY_SERVICE_REQUEST'', ''VIEW_SERVICE_REQUEST'')
                                AND T5.PERSON_ID = ''', AV_PERSON_ID ,'''
                            ),
                            SR_VIEW_ASSIGNEE AS
                            (
                                SELECT AG.ADMIN_GROUP_ID
                                FROM ADMIN_GROUP AG
                                INNER JOIN ROLE_RIGHTS RR ON AG.ROLE_ID = RR.ROLE_ID
                                INNER JOIN RIGHTS R ON RR.RIGHT_ID = R.RIGHT_ID
                                INNER JOIN PERSON_ROLES PR ON RR.ROLE_ID = PR.ROLE_ID
                                WHERE PR.PERSON_ID = ''', AV_PERSON_ID ,'''
                                AND R.RIGHT_NAME = ''VIEW_SR_ADMIN_GROUP''
                            ) ');
	
	IF AV_UNIT_NUMBER IS NOT NULL AND AV_UNIT_NUMBER != '' THEN

        IF AV_DESCENT_FLAG = 'Y' THEN
	       SET LS_FILTER_CONDITIONS = CONCAT(' AND (( EXISTS (SELECT 1 FROM UNIT_WITH_CHILDREN WHERE UNIT_NUMBER = ''',AV_UNIT_NUMBER,''' AND CHILD_UNIT_NUMBER = T1.UNIT_NUMBER)) OR  (T1.UNIT_NUMBER =''',AV_UNIT_NUMBER,''' ) )');	

        ELSE
           SET LS_FILTER_CONDITIONS = CONCAT(' AND (T1.UNIT_NUMBER =''',AV_UNIT_NUMBER,''' )')	;

        END IF;

    END IF;

    IF AV_TYPE_CODES IS NOT NULL AND AV_TYPE_CODES != '' THEN
        SET LS_FILTER_CONDITIONS = CONCAT(LS_FILTER_CONDITIONS, ' AND T1.TYPE_CODE IN (', AV_TYPE_CODES ,')');
    END IF;

    IF AV_STATUS_CODES IS NOT NULL AND AV_STATUS_CODES != '' THEN
        SET LS_FILTER_CONDITIONS = CONCAT(LS_FILTER_CONDITIONS, ' AND T1.STATUS_CODE IN (', AV_STATUS_CODES ,')');
    END IF;

    IF AV_ASSIGNEE_PERSON_ID IS NOT NULL AND AV_ASSIGNEE_PERSON_ID != '' THEN
        SET LS_FILTER_CONDITIONS = CONCAT(LS_FILTER_CONDITIONS, ' AND T1.ASSIGNEE_PERSON_ID = ''', AV_ASSIGNEE_PERSON_ID ,'''');
    END IF;

    IF AV_REPORTER_PERSON_ID IS NOT NULL AND AV_REPORTER_PERSON_ID != '' THEN
        SET LS_FILTER_CONDITIONS = CONCAT(LS_FILTER_CONDITIONS, ' AND T1.REPORTER_PERSON_ID = ''', AV_REPORTER_PERSON_ID ,'''');
    END IF;

    IF AV_START_DATE IS NOT NULL AND AV_START_DATE != '' THEN
        SET LS_FILTER_CONDITIONS = CONCAT(LS_FILTER_CONDITIONS, ' AND T1.CREATE_TIMESTAMP >= ''', AV_START_DATE ,'''');
    END IF;

    IF AV_END_DATE IS NOT NULL AND AV_END_DATE != '' THEN
        SET LS_FILTER_CONDITIONS = CONCAT(LS_FILTER_CONDITIONS, ' AND T1.CREATE_TIMESTAMP <= ''', AV_END_DATE ,'''');
    END IF;
    
    IF AV_WIDGET = 'SERVICE_REQUEST_PRIORITY_COUNT' THEN
        SET LS_DYN_SQL = CONCAT(LS_DYN_SQL, 
            'SELECT SRP.PRIORITY_ID, SRP.DESCRIPTION, COALESCE(COUNT(SR.SR_HEADER_ID), 0) AS TOTAL_COUNT 
            FROM (
                SELECT SR_HEADER_ID, PRIORITY_ID
                FROM SR_HEADER T1
                WHERE(
                    (T1.REPORTER_PERSON_ID =  ''', AV_PERSON_ID ,''')
                    OR (T1.ASSIGNEE_PERSON_ID = ''', AV_PERSON_ID ,''')
                    OR T1.UNIT_NUMBER IN (SELECT DISTINCT UNIT_NUMBER FROM ACCESS_TMP)
                    OR T1.SR_HEADER_ID IN (SELECT DISTINCT SR_HEADER_ID FROM SR_HEADER_IDS)
                    OR T1.SR_HEADER_ID IN (SELECT DISTINCT SR_HEADER_ID FROM SR_TEMP)
                    OR T1.ADMIN_GROUP_ID IN (SELECT DISTINCT ADMIN_GROUP_ID FROM SR_VIEW_ASSIGNEE)    
                )
                AND T1.IS_SYSTEM_GENERATED = ''N'' 
                AND T1.TYPE_CODE IS NOT NULL 
                AND T1.STATUS_CODE IS NOT NULL
            ');
		SET LS_DYN_SQL = CONCAT(LS_DYN_SQL, LS_FILTER_CONDITIONS);
		SET LS_DYN_SQL = CONCAT(LS_DYN_SQL, '
            ) SR
            RIGHT JOIN SR_PRIORITY SRP ON SR.PRIORITY_ID = SRP.PRIORITY_ID
            GROUP BY SRP.PRIORITY_ID 
            ORDER BY SRP.PRIORITY_ID');
            
			
    ELSEIF AV_WIDGET = 'SERVICE_REQUEST_CATEGORY_COUNT' THEN
        
        SET LS_DYN_SQL = CONCAT(LS_DYN_SQL, 
            'SELECT C1.CATEGORY_CODE, C1.DESCRIPTION, COALESCE(COUNT(SR.SR_HEADER_ID), 0) AS TOTAL_COUNT 
            FROM (
                SELECT SR_HEADER_ID, CATEGORY_CODE 
                FROM SR_HEADER T1
                WHERE(
                    (T1.REPORTER_PERSON_ID = ''', AV_PERSON_ID ,''')
                    OR (T1.ASSIGNEE_PERSON_ID = ''', AV_PERSON_ID ,''')
                    OR T1.UNIT_NUMBER IN (SELECT DISTINCT UNIT_NUMBER FROM ACCESS_TMP)
                    OR T1.SR_HEADER_ID IN (SELECT DISTINCT SR_HEADER_ID FROM SR_HEADER_IDS)
                    OR T1.SR_HEADER_ID IN (SELECT DISTINCT SR_HEADER_ID FROM SR_TEMP)
                    OR T1.ADMIN_GROUP_ID IN (SELECT DISTINCT ADMIN_GROUP_ID FROM SR_VIEW_ASSIGNEE)
                )
                AND T1.IS_SYSTEM_GENERATED = ''N'' 
                AND T1.TYPE_CODE IS NOT NULL 
                AND T1.STATUS_CODE IS NOT NULL
            ');
			
			IF AV_PRIORITIES IS NOT NULL AND AV_PRIORITIES != '' THEN
			SET LS_FILTER_CONDITIONS = CONCAT(LS_FILTER_CONDITIONS, 'AND T1.PRIORITY_ID IN (',AV_PRIORITIES,')');
			END IF;
			
		SET LS_DYN_SQL = CONCAT(LS_DYN_SQL, LS_FILTER_CONDITIONS);
		
		SET LS_DYN_SQL = CONCAT(LS_DYN_SQL, '
            ) SR
            RIGHT JOIN SR_CATEGORY C1 ON SR.CATEGORY_CODE = C1.CATEGORY_CODE
            GROUP BY C1.CATEGORY_CODE
            ORDER BY C1.CATEGORY_CODE');

 ELSEIF AV_WIDGET = 'SERVICE_REQUEST_RESEARCH_SUMMARY_COUNT' THEN 

			SET LS_DYN_SQL = CONCAT(LS_DYN_SQL,',
    SR_COUNTS AS (
        SELECT
            SUM(CASE WHEN T.STATUS_CODE IN (1,2,3,4,5,6,7,8,9,10,11,12,14) THEN 1 ELSE 0 END) AS TOTAL,
            SUM(CASE WHEN T.STATUS_CODE IN (1, 3, 9, 12) THEN 1 ELSE 0 END) AS OPENED,
            SUM(CASE WHEN T.STATUS_CODE = 8 THEN 1 ELSE 0 END) AS CLOSED,
            SUM(CASE WHEN T.STATUS_CODE = 5 THEN 1 ELSE 0 END) AS RESOLVED,
            SUM(CASE WHEN T.STATUS_CODE = 2 THEN 1 ELSE 0 END) AS PENDING,
            SUM(CASE WHEN T.STATUS_CODE = 6 AND T.ASSIGNEE_PERSON_ID IS NULL AND T.ADMIN_GROUP_ID IS NULL THEN 1 ELSE 0 END) AS REOPENED
        FROM (
            SELECT DISTINCT
                T1.SR_HEADER_ID,
                T1.STATUS_CODE,
                T1.ASSIGNEE_PERSON_ID,
                T1.ADMIN_GROUP_ID,
                T1.UNIT_NUMBER,
                T1.IS_SYSTEM_GENERATED
            FROM SR_HEADER T1
			 INNER JOIN SR_TYPE T2 ON T1.TYPE_CODE = T2.TYPE_CODE
            INNER JOIN SR_PRIORITY T3 ON T1.PRIORITY_ID = T3.PRIORITY_ID
            LEFT JOIN SR_STATUS T4 ON T1.STATUS_CODE = T4.STATUS_CODE
            LEFT JOIN UNIT T5 ON T1.UNIT_NUMBER = T5.UNIT_NUMBER
            LEFT JOIN PERSON T6 ON T1.ASSIGNEE_PERSON_ID = T6.PERSON_ID
            LEFT JOIN PERSON T7 ON T1.REPORTER_PERSON_ID = T7.PERSON_ID
          WHERE(
                    (T1.REPORTER_PERSON_ID = ''', AV_PERSON_ID ,''')
                    OR (T1.ASSIGNEE_PERSON_ID = ''', AV_PERSON_ID ,''')
                    OR T1.UNIT_NUMBER IN (SELECT DISTINCT UNIT_NUMBER FROM ACCESS_TMP)
                    OR T1.SR_HEADER_ID IN (SELECT DISTINCT SR_HEADER_ID FROM SR_HEADER_IDS)
                    OR T1.SR_HEADER_ID IN (SELECT DISTINCT SR_HEADER_ID FROM SR_TEMP)
                    OR T1.ADMIN_GROUP_ID IN (SELECT DISTINCT ADMIN_GROUP_ID FROM SR_VIEW_ASSIGNEE)
                )
                AND T1.IS_SYSTEM_GENERATED = ''N'' 
                AND T1.TYPE_CODE IS NOT NULL 
                AND T1.STATUS_CODE IS NOT NULL
            ', JOIN_CONDITION,LS_FILTER_CONDITIONS,
									')T)
	SELECT ''Opened'' AS SERVICE_REQUEST_RESEARCH_SUMMARY ,''In Progress''AS LABEL, COALESCE(OPENED, 0) AS COUNT FROM SR_COUNTS
    UNION ALL
    SELECT ''Pending'',''Approval in Progress'', COALESCE(PENDING, 0) FROM SR_COUNTS
    UNION ALL
    SELECT ''Resolved'',''Resolved'', COALESCE(RESOLVED, 0) FROM SR_COUNTS
    UNION ALL
    SELECT ''Total'' ,''Total'', COALESCE(TOTAL, 0)  FROM SR_COUNTS');

END IF;			

    SET @QUERY_STATEMENT = LS_DYN_SQL;
    PREPARE EXECUTABLE_STATEMENT FROM @QUERY_STATEMENT;
    EXECUTE EXECUTABLE_STATEMENT;
END
