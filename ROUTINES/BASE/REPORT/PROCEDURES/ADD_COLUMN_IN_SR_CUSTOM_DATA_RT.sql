CREATE PROCEDURE `ADD_COLUMN_IN_SR_CUSTOM_DATA_RT`(AV_CUSTOM_DATA_ELEMENTS_ID INT, AV_ACTYPE VARCHAR(5))
PROC:BEGIN
    DECLARE LS_MUTLI_ANS_INDEX	LONGTEXT;
    DECLARE LS_DATATYPE VARCHAR(30);
    DECLARE LS_NEW_COLUMN_NAME VARCHAR(300);
    DECLARE LI_COUNT INT DEFAULT 0;
    DECLARE LS_COLUMN_NAME VARCHAR(300);
    DECLARE LI_DATA_LENGTH INT;
    DECLARE LI_CUT_CNT INT;
    DECLARE LS_IS_MULTI_SELECT_LOOKUP VARCHAR(1);
    DECLARE LS_DATA_TYPE_CODE VARCHAR(3);
    
    select count(1) into LI_CUT_CNT from custom_data_elements 
    where CUSTOM_DATA_ELEMENTS_ID = AV_CUSTOM_DATA_ELEMENTS_ID;
    
    IF LI_CUT_CNT < 1 THEN
    LEAVE PROC;
    END IF;
    
     IF AV_ACTYPE IN ('I', 'U') THEN
         SELECT DATA_TYPE, DATA_LENGTH, IS_MULTI_SELECT_LOOKUP INTO LS_DATATYPE, LI_DATA_LENGTH , LS_IS_MULTI_SELECT_LOOKUP 
        FROM CUSTOM_DATA_ELEMENTS T1 
        WHERE T1.CUSTOM_DATA_ELEMENTS_ID = AV_CUSTOM_DATA_ELEMENTS_ID;
		
        SET LS_DATA_TYPE_CODE = LS_DATATYPE;
         IF LS_DATATYPE = 3 THEN
            SET LS_DATATYPE = 'DATE';
        ELSEIF LS_DATATYPE = 2 THEN
            IF LI_DATA_LENGTH < 120 THEN 
                SET LS_DATATYPE = CONCAT('INT(', LI_DATA_LENGTH, ')');
            ELSE
                SET LS_DATATYPE = 'INT';
            END IF;
        ELSEIF LS_DATATYPE IN (10, 8, 9, 4, 5) THEN 
            SET LS_DATATYPE = 'LONGTEXT';
        ELSEIF LS_DATATYPE = 1 THEN
            SET LS_DATATYPE = CONCAT('VARCHAR(', LI_DATA_LENGTH, ')');
        ELSE 
            SET LS_DATATYPE = 'VARCHAR(500)';
        END IF;

         SET LS_NEW_COLUMN_NAME = CONCAT('CUST_ELEMENTS_ID_', AV_CUSTOM_DATA_ELEMENTS_ID);
        
     IF NOT EXISTS (
            SELECT 1
            FROM INFORMATION_SCHEMA.COLUMNS
            WHERE TABLE_NAME = 'SR_CUSTOM_DATA_RT' 
            AND COLUMN_NAME = LS_NEW_COLUMN_NAME
                AND TABLE_SCHEMA = DATABASE()
        ) THEN 
        
			SET LS_MUTLI_ANS_INDEX = '';
            IF LS_IS_MULTI_SELECT_LOOKUP = "Y" AND LS_DATA_TYPE_CODE IN (4, 8, 9) THEN
				SET LS_MUTLI_ANS_INDEX = CONCAT(' , ADD FULLTEXT (',LS_NEW_COLUMN_NAME,')');
            END IF;
        
              SET @SQL = CONCAT('ALTER TABLE SR_CUSTOM_DATA_RT ADD COLUMN ', LS_NEW_COLUMN_NAME, ' ', LS_DATATYPE, ' AFTER SR_HEADER_ID', LS_MUTLI_ANS_INDEX);
            PREPARE STMT FROM @SQL;
            EXECUTE STMT;
            DEALLOCATE PREPARE STMT;
            
       END IF;

       CALL UPDATE_DASHBOARD_LOOKUPS_FOR_CUSTOM_DATA(AV_CUSTOM_DATA_ELEMENTS_ID, 20, AV_ACTYPE, LS_DATA_TYPE_CODE);

    ELSEIF AV_ACTYPE = 'D' THEN

    CALL UPDATE_DASHBOARD_LOOKUPS_FOR_CUSTOM_DATA(AV_CUSTOM_DATA_ELEMENTS_ID, 20, AV_ACTYPE, NULL);

        SET LS_COLUMN_NAME = CONCAT('CUST_ELEMENTS_ID_', AV_CUSTOM_DATA_ELEMENTS_ID);
         
         SELECT COUNT(*) INTO LI_COUNT 
        FROM INFORMATION_SCHEMA.COLUMNS 
        WHERE TABLE_NAME = 'SR_CUSTOM_DATA_RT' AND COLUMN_NAME = LS_COLUMN_NAME;

        IF LI_COUNT > 0 THEN 
            SET @SQL = CONCAT('ALTER TABLE SR_CUSTOM_DATA_RT DROP COLUMN ', LS_COLUMN_NAME);
            
            PREPARE STMT FROM @SQL;
            EXECUTE STMT;
            DEALLOCATE PREPARE STMT;
        END IF;
    END IF;
END PROC
