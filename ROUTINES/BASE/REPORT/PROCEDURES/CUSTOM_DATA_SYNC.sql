CREATE PROCEDURE `CUSTOM_DATA_SYNC`()
BEGIN 
DECLARE LD_SYNC_INTERVAL_START_TIME  DATETIME;
DECLARE LD_SYNC_INTERVAL_END_TIME    DATETIME;
DECLARE LD_CURRENT_TIMESTAMP         DATETIME;
DECLARE LS_DYN_SQL                   LONGTEXT;
DECLARE AWARD_IDS                    LONGTEXT;
DECLARE AWARD_NUMBERS                LONGTEXT;

DECLARE EXIT HANDLER FOR SQLEXCEPTION
BEGIN
GET DIAGNOSTICS CONDITION 1 @sqlstate = RETURNED_SQLSTATE, @errno = MYSQL_ERRNO, @msg = MESSAGE_TEXT;
             
IF @msg != 'ERR:AWARD_MASTER_DATASET_SYNC' THEN
    SELECT 'Skipped execution of AWARD_MASTER_DATASET_SYNC and PR_MASTER_DATASET_SYNC procedures.' AS ''
          UNION
	SELECT CONCAT('Count of failed : ', (SELECT COUNT(1) FROM TEMP_AWARD_MASTER_DATASET)) AS ''
		  UNION
	SELECT 'The awards which got failed while syncing custom data is as listed below:';
	SELECT AWARD_ID,AWARD_NUMBER FROM TEMP_AWARD_MASTER_DATASET;
	ROLLBACK;
	TRUNCATE TEMP_AWARD_MASTER_DATASET;
END IF;

END;

SELECT  UTC_TIMESTAMP() INTO LD_CURRENT_TIMESTAMP;
SELECT  DATE_SUB(LAST_SYNC_TIMESTAMP,INTERVAL 4 MINUTE) INTO LD_SYNC_INTERVAL_START_TIME FROM REPORT_LAST_SYNC_TIME;
SELECT  DATE_SUB(LD_CURRENT_TIMESTAMP, INTERVAL 3 MINUTE) INTO LD_SYNC_INTERVAL_END_TIME;

SET SQL_SAFE_UPDATES = 0;
SET TRANSACTION ISOLATION LEVEL READ COMMITTED;
TRUNCATE TEMP_AWARD_MASTER_DATASET;
 
INSERT INTO TEMP_AWARD_MASTER_DATASET (AWARD_ID, AWARD_NUMBER)
(SELECT
A3.AWARD_ID, A3.AWARD_NUMBER
FROM AWARD A3
WHERE A3.DOCUMENT_UPDATE_TIMESTAMP BETWEEN LD_SYNC_INTERVAL_START_TIME AND LD_SYNC_INTERVAL_END_TIME
AND ((A3.AWARD_SEQUENCE_STATUS = 'PENDING' AND A3.SEQUENCE_NUMBER = 1)
OR
(A3.AWARD_SEQUENCE_STATUS = 'ACTIVE')));

COMMIT;

SET SESSION group_concat_max_len = 1000000;

SELECT GROUP_CONCAT(A3.AWARD_ID) INTO AWARD_IDS FROM AWARD A3
WHERE A3.DOCUMENT_UPDATE_TIMESTAMP BETWEEN LD_SYNC_INTERVAL_START_TIME AND LD_SYNC_INTERVAL_END_TIME
AND (
(A3.AWARD_SEQUENCE_STATUS IN('PENDING','ARCHIVE','CANCELLED') AND A3.SEQUENCE_NUMBER = 1)
OR
A3.AWARD_SEQUENCE_STATUS IN('ACTIVE'));



IF AWARD_IDS IS NOT NULL THEN
SET LS_DYN_SQL  = CONCAT('DELETE FROM CUSTOM_DATA_REPORT_RT T2
WHERE T2.MODULE_ITEM_KEY IN(', AWARD_IDS, ')');
SET @QUERY_STATEMENT = LS_DYN_SQL;
PREPARE EXECUTABLE_STATEMENT FROM @QUERY_STATEMENT;
EXECUTE EXECUTABLE_STATEMENT;
END IF;

INSERT INTO CUSTOM_DATA_REPORT_RT(
MODULE_ITEM_KEY,
GRANT_CODE,
INPUT_GST_CATEGORY,
OUTPUT_GST_CATEGORY,
STEM_NONSTEM,
RIE_DOMAIN,
SUB_LEAD_UNIT,
PROFIT_CENTER,
FUND_CENTER,
COST_CENTER,
DISPLAY_AT_ACAD_PROFILE,
MULTIPLIER,
LEVEL_2_SUP_ORG,
CLAIM_PREPARER,
LAST_SYNC_TIME)
 (SELECT
MODULE_ITEM_KEY,
MAX(case when CUSTOM_DATA_ELEMENTS_ID =  (SELECT MAX(CUSTOM_DATA_ELEMENTS_ID) FROM CUSTOM_DATA_ELEMENTS WHERE CUSTOM_ELEMENT_NAME = 'GRANT CODE' and IS_LATEST_VERSION = 'Y') then ifnull(description,value)  end) as GRANT_CODE,
MAX(case when CUSTOM_DATA_ELEMENTS_ID =  (SELECT MAX(CUSTOM_DATA_ELEMENTS_ID) FROM CUSTOM_DATA_ELEMENTS WHERE CUSTOM_ELEMENT_NAME = 'Input GST Category' and IS_LATEST_VERSION = 'Y') then ifnull(description,value) end) as INPUT_GST_CATEGORY,
MAX(case when CUSTOM_DATA_ELEMENTS_ID =  (SELECT MAX(CUSTOM_DATA_ELEMENTS_ID) FROM CUSTOM_DATA_ELEMENTS WHERE CUSTOM_ELEMENT_NAME = 'Output GST Category' and IS_LATEST_VERSION = 'Y') then ifnull(description,value) end) as OUTPUT_GST_CATEGORY,
MAX(case when CUSTOM_DATA_ELEMENTS_ID =  (SELECT MAX(CUSTOM_DATA_ELEMENTS_ID) FROM CUSTOM_DATA_ELEMENTS WHERE CUSTOM_ELEMENT_NAME = 'STEM/Non-STEM' and IS_LATEST_VERSION = 'Y') then ifnull(description,value) end) as STEM_NONSTEM,
MAX(case when CUSTOM_DATA_ELEMENTS_ID =  (SELECT MAX(CUSTOM_DATA_ELEMENTS_ID) FROM CUSTOM_DATA_ELEMENTS WHERE CUSTOM_ELEMENT_NAME = 'RIE Domain' and IS_LATEST_VERSION = 'Y') then ifnull(description,value) end) as RIE_DOMAIN,
MAX(case when CUSTOM_DATA_ELEMENTS_ID =  (SELECT MAX(CUSTOM_DATA_ELEMENTS_ID) FROM CUSTOM_DATA_ELEMENTS WHERE CUSTOM_ELEMENT_NAME = 'Sub_lead_Unit' and IS_LATEST_VERSION = 'Y') then description end) as SUB_LEAD_UNIT,
MAX(case when CUSTOM_DATA_ELEMENTS_ID =  (SELECT MAX(CUSTOM_DATA_ELEMENTS_ID) FROM CUSTOM_DATA_ELEMENTS WHERE CUSTOM_ELEMENT_NAME = 'PROFIT CENTER' and IS_LATEST_VERSION = 'Y') then ifnull(description,value) end) as PROFIT_CENTER,
MAX(case when CUSTOM_DATA_ELEMENTS_ID =  (SELECT MAX(CUSTOM_DATA_ELEMENTS_ID) FROM CUSTOM_DATA_ELEMENTS WHERE CUSTOM_ELEMENT_NAME = 'FUND CENTER' and IS_LATEST_VERSION = 'Y') then ifnull(description,value) end) as FUND_CENTER,
MAX(case when CUSTOM_DATA_ELEMENTS_ID =  (SELECT MAX(CUSTOM_DATA_ELEMENTS_ID) FROM CUSTOM_DATA_ELEMENTS WHERE CUSTOM_ELEMENT_NAME = 'COST CENTER' and IS_LATEST_VERSION = 'Y' ) then ifnull(description,value) end) as COST_CENTER,
MAX(case when CUSTOM_DATA_ELEMENTS_ID =  (SELECT MAX(CUSTOM_DATA_ELEMENTS_ID) FROM CUSTOM_DATA_ELEMENTS WHERE CUSTOM_ELEMENT_NAME = 'Display at Acad Profile?' and IS_LATEST_VERSION = 'Y' ) then ifnull(description,value) end) as DISPLAY_AT_ACAD_PROFILE,
MAX(case when CUSTOM_DATA_ELEMENTS_ID =  (SELECT MAX(CUSTOM_DATA_ELEMENTS_ID) FROM CUSTOM_DATA_ELEMENTS WHERE CUSTOM_ELEMENT_NAME = 'Multiplier %' and IS_LATEST_VERSION = 'Y' ) then ifnull(description,value) end) as MULTIPLIER_PERCENT,
MAX(case when CUSTOM_DATA_ELEMENTS_ID =  (SELECT MAX(CUSTOM_DATA_ELEMENTS_ID) FROM CUSTOM_DATA_ELEMENTS WHERE CUSTOM_ELEMENT_NAME = 'Level_2_Sup_Org' and IS_LATEST_VERSION = 'Y') then description end) as LEVEL_2_SUP_ORG,
MAX(case when CUSTOM_DATA_ELEMENTS_ID =  (SELECT MAX(CUSTOM_DATA_ELEMENTS_ID) FROM CUSTOM_DATA_ELEMENTS WHERE CUSTOM_ELEMENT_NAME = 'CLAIM_PREPARER' and IS_LATEST_VERSION = 'Y') then ifnull(description,value) end) as CLAIM_PREPARER,
UTC_TIMESTAMP()
FROM CUSTOM_DATA  T1 WHERE MODULE_ITEM_CODE = 1
AND MODULE_ITEM_KEY IN (SELECT
A3.AWARD_ID
FROM TEMP_AWARD_MASTER_DATASET A3)
GROUP BY MODULE_ITEM_KEY
);
 

SELECT GROUP_CONCAT('''', A3.AWARD_NUMBER ,'''') INTO AWARD_NUMBERS FROM AWARD A3
WHERE A3.DOCUMENT_UPDATE_TIMESTAMP BETWEEN LD_SYNC_INTERVAL_START_TIME AND LD_SYNC_INTERVAL_END_TIME
AND ((A3.AWARD_SEQUENCE_STATUS IN('PENDING','ARCHIVE','CANCELLED')
AND A3.SEQUENCE_NUMBER = 1) OR
A3.AWARD_SEQUENCE_STATUS IN('ACTIVE'));


IF AWARD_NUMBERS IS NOT NULL THEN
SET LS_DYN_SQL  = CONCAT('DELETE FROM AWARD_ORG_APPROVED_BUDGET_RT T1
WHERE T1.AWARD_NUMBER IN(', AWARD_NUMBERS, ')');
SET @QUERY_STATEMENT = LS_DYN_SQL;
PREPARE EXECUTABLE_STAEMENT FROM @QUERY_STATEMENT;
EXECUTE EXECUTABLE_STAEMENT;
END IF;

IF AWARD_NUMBERS IS NOT NULL THEN
SET LS_DYN_SQL  = CONCAT('DELETE FROM AWARD_LATEST_APROVED_BUDGET_RT T1
WHERE T1.AWARD_NUMBER IN(', AWARD_NUMBERS, ')');
SET @QUERY_STATEMENT = LS_DYN_SQL;
PREPARE EXECUTABLE_STAEMENT FROM @QUERY_STATEMENT;
EXECUTE EXECUTABLE_STAEMENT;
END IF;
 
 
INSERT INTO AWARD_ORG_APPROVED_BUDGET_RT(
AWARD_ID,
AWARD_NUMBER,
BUDGET_CATEGORY_CODE,
ORIGINAL_APPROVED_BUDGET)
  (SELECT
T1.AWARD_ID,
T1.AWARD_NUMBER,
T2.BUDGET_CATEGORY_CODE,
SUM(T2.LINE_ITEM_COST) ORG_APRVED_BUD_BYBUDGET_CATEGORY
FROM AWARD_BUDGET_HEADER T1
INNER JOIN AWARD_BUDGET_DETAIL T2 ON T1.BUDGET_HEADER_ID = T2.BUDGET_HEADER_ID
WHERE  T1.AWARD_ID IN(SELECT
A3.AWARD_ID
FROM TEMP_AWARD_MASTER_DATASET A3)
AND T1.VERSION_NUMBER IN (SELECT MIN(AB1.VERSION_NUMBER) FROM AWARD_BUDGET_HEADER AB1
WHERE AB1.AWARD_ID = T1.AWARD_ID)
GROUP BY T1.AWARD_NUMBER,T2.BUDGET_CATEGORY_CODE
);
 
 
INSERT INTO AWARD_LATEST_APROVED_BUDGET_RT(
AWARD_ID,
AWARD_NUMBER,
BUDGET_CATEGORY_CODE,
LATEST_APPROVED_BUDGET)
  (SELECT
T1.AWARD_ID,
T1.AWARD_NUMBER,
T2.BUDGET_CATEGORY_CODE,
SUM(T2.LINE_ITEM_COST) LATEST_APRVED_BUD_BYBUDGET_CATEGORY
FROM AWARD_BUDGET_HEADER T1
INNER JOIN AWARD_BUDGET_DETAIL T2 ON T1.BUDGET_HEADER_ID = T2.BUDGET_HEADER_ID
WHERE  T1.AWARD_ID IN(SELECT
A3.AWARD_ID
FROM TEMP_AWARD_MASTER_DATASET A3)
AND T1.VERSION_NUMBER IN (SELECT MAX(AB1.VERSION_NUMBER) FROM AWARD_BUDGET_HEADER AB1
WHERE AB1.AWARD_ID = T1.AWARD_ID)
GROUP BY T1.AWARD_NUMBER,T2.BUDGET_CATEGORY_CODE
);


IF AWARD_NUMBERS IS NOT NULL THEN
						
	SET LS_DYN_SQL  = CONCAT('DELETE FROM AWARD_ORIGINAL_L2_AMT_RT T1
	WHERE T1.AWARD_NUMBER IN(', AWARD_NUMBERS, ')');
	
	SET @QUERY_STATEMENT = LS_DYN_SQL;
	PREPARE EXECUTABLE_STAEMENT FROM @QUERY_STATEMENT;
	EXECUTE EXECUTABLE_STAEMENT;

END IF;
        INSERT INTO AWARD_ORIGINAL_L2_AMT_RT(
        AWARD_NUMBER,
        INTERNAL_ORDER_CODE,
        AMOUNT)
        ( SELECT T0.AWARD_NUMBER, T2.INTERNAL_ORDER_CODE, T2.LINE_ITEM_COST
				FROM AWARD T0
				INNER JOIN AWARD_BUDGET_HEADER T1 ON T0.AWARD_ID = T1.AWARD_ID
				INNER JOIN AWARD_BUDGET_DETAIL T2 ON T1.BUDGET_HEADER_ID = T2.BUDGET_HEADER_ID
				WHERE T0.DOCUMENT_UPDATE_TIMESTAMP BETWEEN LD_SYNC_INTERVAL_START_TIME AND LD_SYNC_INTERVAL_END_TIME
										AND ((T0.AWARD_SEQUENCE_STATUS = 'PENDING' AND T0.SEQUENCE_NUMBER = 1) 
                                        OR 
                                        (T0.AWARD_SEQUENCE_STATUS = 'ACTIVE'))
				AND T1.VERSION_NUMBER IN (SELECT MIN(S1.VERSION_NUMBER) FROM AWARD_BUDGET_HEADER S1 WHERE S1.AWARD_ID = T1.AWARD_ID)
        );
 


-- DELETE AWARD DATA WHICH ARE NOT AVAILABLE IN AWARD TABLE 

SET SQL_SAFE_UPDATES = 0;
 
DELETE FROM CUSTOM_DATA_REPORT_RT WHERE MODULE_ITEM_KEY NOT IN (SELECT AWARD_ID FROM AWARD);
DELETE FROM AWARD_ORG_APPROVED_BUDGET_RT WHERE AWARD_ID NOT IN (SELECT AWARD_ID FROM AWARD);
DELETE FROM AWARD_LATEST_APROVED_BUDGET_RT WHERE AWARD_ID NOT IN (SELECT AWARD_ID FROM AWARD);
DELETE FROM AWARD_ORIGINAL_L2_AMT_RT WHERE AWARD_NUMBER NOT IN (SELECT AWARD_NUMBER FROM AWARD);

SELECT 'CUSTOM_DATA_SYNC executed successfully' AS SUCCESS FROM DUAL;
CALL AWARD_MASTER_DATASET_SYNC();

SET SQL_SAFE_UPDATES = 0;
UPDATE REPORT_LAST_SYNC_TIME SET LAST_SYNC_TIMESTAMP = LD_CURRENT_TIMESTAMP;
SET SQL_SAFE_UPDATES = 1;

CALL PR_MASTER_DATASET_SYNC();

SET TRANSACTION ISOLATION LEVEL REPEATABLE READ;

END
