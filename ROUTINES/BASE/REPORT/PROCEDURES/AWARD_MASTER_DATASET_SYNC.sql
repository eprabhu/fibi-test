CREATE PROCEDURE `AWARD_MASTER_DATASET_SYNC`()
BEGIN
DECLARE LD_SYNC_INTERVAL_START_TIME   DATETIME;
DECLARE LD_SYNC_INTERVAL_END_TIME     DATETIME;
DECLARE AWARD_NUMBERS                 LONGTEXT;
DECLARE LS_DYN_SQL                    LONGTEXT;

DECLARE EXIT HANDLER FOR SQLEXCEPTION
BEGIN
SELECT 'Skipped execution of PR_MASTER_DATASET_SYNC procedure.' AS ''
UNION
SELECT CONCAT('Count of failed : ', (SELECT COUNT(1) FROM TEMP_AWARD_MASTER_DATASET)) AS ''
	UNION
SELECT 'The awards which got failed while syncing award master data is as listed below:';
SELECT AWARD_ID,AWARD_NUMBER FROM TEMP_AWARD_MASTER_DATASET;
ROLLBACK;
TRUNCATE TEMP_AWARD_MASTER_DATASET;
RESIGNAL SET MESSAGE_TEXT = 'ERR:AWARD_MASTER_DATASET_SYNC';
END;

SELECT  DATE_SUB(LAST_SYNC_TIMESTAMP,INTERVAL 4 MINUTE) INTO LD_SYNC_INTERVAL_START_TIME FROM REPORT_LAST_SYNC_TIME;
SELECT  DATE_SUB(UTC_TIMESTAMP(), INTERVAL 3 MINUTE) INTO LD_SYNC_INTERVAL_END_TIME;
 
SET SQL_SAFE_UPDATES = 0;
TRUNCATE TEMP_AWARD_MASTER_DATASET;
 
SET TRANSACTION ISOLATION LEVEL READ COMMITTED;  


 
INSERT INTO TEMP_AWARD_MASTER_DATASET (
AWARD_ID,
AWARD_NUMBER,
ACCOUNT_NUMBER,
LEAD_UNIT_NUMBER,
AWARD_TYPE_CODE,
ACTIVITY_TYPE_CODE,
ACCOUNT_TYPE_CODE,
STATUS_CODE,
SPONSOR_CODE,
PRIME_SPONSOR_CODE,
WORKFLOW_AWARD_STATUS_CODE,
BASIS_OF_PAYMENT_CODE,
METHOD_OF_PAYMENT_CODE,
PAYMENT_INVOICE_FREQ_CODE,
GRANT_HEADER_ID,
SEQUENCE_NUMBER,
TITLE,
AWARD_EFFECTIVE_DATE,
FINAL_EXPIRATION_DATE,
AWARD_SEQUENCE_STATUS,
BEGIN_DATE,
SPONSOR_AWARD_NUMBER,
CREATE_TIMESTAMP,
CREATE_USER,
DURATION,
FUNDER_APPROVAL_DATE,
AWARD_EXECUTION_DATE )(
SELECT 
A3.AWARD_ID,
A3.AWARD_NUMBER,
A3.ACCOUNT_NUMBER,
A3.LEAD_UNIT_NUMBER,
A3.AWARD_TYPE_CODE,
A3.ACTIVITY_TYPE_CODE,
A3.ACCOUNT_TYPE_CODE,
A3.STATUS_CODE,
A3.SPONSOR_CODE,
A3.PRIME_SPONSOR_CODE,
A3.WORKFLOW_AWARD_STATUS_CODE,
A3.BASIS_OF_PAYMENT_CODE,
A3.METHOD_OF_PAYMENT_CODE,
A3.PAYMENT_INVOICE_FREQ_CODE,
A3.GRANT_HEADER_ID,
A3.SEQUENCE_NUMBER,
A3.TITLE,
A3.AWARD_EFFECTIVE_DATE
,A3.FINAL_EXPIRATION_DATE,
A3.AWARD_SEQUENCE_STATUS,
A3.BEGIN_DATE,
A3.SPONSOR_AWARD_NUMBER,
A3.CREATE_TIMESTAMP,
A3.CREATE_USER,
A3.DURATION,
A3.FUNDER_APPROVAL_DATE,
A3.AWARD_EXECUTION_DATE 
FROM AWARD A3
WHERE A3.AWARD_SEQUENCE_STATUS IN('ACTIVE') 
AND A3.AWARD_NUMBER IN (SELECT AWARD_NUMBER FROM AWARD_EXPENSE_HEADER WHERE UPDATE_TIMESTAMP BETWEEN LD_SYNC_INTERVAL_START_TIME AND LD_SYNC_INTERVAL_END_TIME)
UNION 
(SELECT A3.AWARD_ID,
A3.AWARD_NUMBER,
A3.ACCOUNT_NUMBER,
A3.LEAD_UNIT_NUMBER,
A3.AWARD_TYPE_CODE,
A3.ACTIVITY_TYPE_CODE,
A3.ACCOUNT_TYPE_CODE,
A3.STATUS_CODE,
A3.SPONSOR_CODE,
A3.PRIME_SPONSOR_CODE,
A3.WORKFLOW_AWARD_STATUS_CODE,
A3.BASIS_OF_PAYMENT_CODE,
A3.METHOD_OF_PAYMENT_CODE,
A3.PAYMENT_INVOICE_FREQ_CODE,
A3.GRANT_HEADER_ID,
A3.SEQUENCE_NUMBER,
A3.TITLE,
A3.AWARD_EFFECTIVE_DATE
,A3.FINAL_EXPIRATION_DATE,
A3.AWARD_SEQUENCE_STATUS,
A3.BEGIN_DATE,
A3.SPONSOR_AWARD_NUMBER,
A3.CREATE_TIMESTAMP,
A3.CREATE_USER,
A3.DURATION,
A3.FUNDER_APPROVAL_DATE,
A3.AWARD_EXECUTION_DATE FROM AWARD A3
WHERE A3.DOCUMENT_UPDATE_TIMESTAMP BETWEEN LD_SYNC_INTERVAL_START_TIME AND LD_SYNC_INTERVAL_END_TIME
AND ((A3.AWARD_SEQUENCE_STATUS IN('PENDING','ARCHIVE','CANCELLED') AND A3.SEQUENCE_NUMBER = 1)
OR A3.AWARD_SEQUENCE_STATUS IN('ACTIVE'))));

COMMIT;
 SET SESSION group_concat_max_len = 1000000;
SELECT GROUP_CONCAT('''', AWARD_NUMBER ,'''') INTO AWARD_NUMBERS FROM TEMP_AWARD_MASTER_DATASET; 
 IF AWARD_NUMBERS IS NOT NULL THEN
        SET LS_DYN_SQL  = CONCAT('DELETE FROM AWARD_MASTER_DATASET_RT T2
        WHERE T2.AWARD_NUMBER IN(', AWARD_NUMBERS, ')');
        SET @QUERY_STATEMENT = LS_DYN_SQL;
        PREPARE EXECUTABLE_STATEMENT FROM @QUERY_STATEMENT;
        EXECUTE EXECUTABLE_STATEMENT;
END IF;
 
BEGIN
INSERT INTO AWARD_MASTER_DATASET_RT(
AWARD_ID,
ACCOUNT_NUMBER,
AWARD_NUMBER,
SEQUENCE_NUMBER,
TITLE,
AWARD_STATUS,
ACCOUNT_TYPE,
AWARD_TYPE,
ACTIVITY_TYPE,
LEAD_UNIT_NUMBER,
UNIT_NAME,
GRANT_CALL_TITLE,
SPONSOR_CODE,
SPONSOR_NAME,
PRIME_SPONSOR_CODE,
PRIME_SPONSOR_NAME,
AWARD_EXECUTION_DATE,
AWARD_EFFECTIVE_DATE,
FINAL_EXPIRATION_DATE,
AWARD_SEQUENCE_STATUS,
KEY_PERSON_NAME,
KEY_PERSON_ID,
PERSON_ROLE_ID,
PERSON_ROLE,
ANTICIPATED_TOTAL_AMOUNT,
AMOUNT_OBLIGATED_TO_DATE,
CURRENT_FUND_EFFECTIVE_DATE,
OBLIGATION_EXPIRATION_DATE,
BEGIN_DATE,
EMPLOYEE_FLAG,
PI_PERSON_ID,
PI_NAME,
PI_HOME_UNIT_NUMBER,
PI_HOME_UNIT,
AWARD_WORKFLOW_STATUS_CODE,
AWARD_WORKFLOW_STATUS,
SPONSOR_AWARD_NUMBER,
KEY_PERSON_ORGANIZATION,
KEY_PERSON_DEPARTMENT_NUMBER,
KEY_PERSON_DEPARTMENT,
KEY_PERSON_COUNTRY,
KEY_PERSON_EMAIL,
TOTAL_COST_SHARE,
TOTAL_PROJECT_COST,
TOTAL_COST_IN_CURRENCY,
TOTAL_COST,
TOTAL_DIRECT_COST,
TOTAL_INDIRECT_COST,
BASIS_OF_PAYMENT_DESC,
METHOD_OF_PAYMENT_DESC,
PAYMENT_INVOICE_FREQ_DESC,
RATE_CLASS_CODE,
AWARD_CREATE_TIMESTAMP,
AWARD_CREATE_USER,
STEM_NONSTEM,
RIE_DOMAIN,
INPUT_GST_CATEGORY,
OUTPUT_GST_CATEGORY,
GRANT_CODE,
SUB_LEAD_UNIT,
PROFIT_CENTER,
FUND_CENTER,
COST_CENTER,
MULTIPLIER,
CUMULATIVE_REVENUE,
CUMULATIVE_ACTUAL_EXPENSE,
CUMULATIVE_COMMITTED_EXPENSE,
BALANCE_FUND,
BALANCE_LESS_COMMITTED_AMOUNT,
ORIGINAL_APPROVED_BUDGET,
LATEST_APPROVED_BUDGET,
UTILIZATION_RATE,
DURATION,
PERCENTAGE_OF_EFFORT,
CUMULATIVE_VIREMENT,
DISPLAY_AT_ACAD_PROFILE,
GRANT_PER_MONTH,
F_AND_A_RATE_TYPE,
PROJECT_AGE,
FUNDING_SCHEME,
SPONSOR_TYPE_CODE,
SPONSOR_TYPE,
LAST_SYNC_TIME,
ABBREVIATION,
GRANT_FUNDING_AGENCY,
GRANT_FUNDING_AGENCY_TYPE,
SPONSOR_COUNTRY,
PRIME_SPONSOR_COUNTRY,
FUND_CODE,
AWARD_STATUS_CODE,
ACTUAL_EXPENSE_WO_IRC,
COMMITTED_EXPENSE_WO_IRC,
UTILIZATION_RATE_WO_IRC,
LEVEL_2_SUP_ORG,
KEY_PERSON_GENDER,
FEED_STATUS,
NTU_PRIORITY,
FUNDER_APPROVAL_DATE,
CLAIM_PREPARER,
AREA_OF_RESEARCH,
SPECIAL_REVIEW

)(SELECT DISTINCT 
		T1.AWARD_ID,
        T1.ACCOUNT_NUMBER,
        T1.AWARD_NUMBER,
        T1.SEQUENCE_NUMBER,
        T1.TITLE,
         T2.DESCRIPTION  ,
          T3.DESCRIPTION  ,
         T4.DESCRIPTION  ,
         T5.DESCRIPTION  ,
        T1.LEAD_UNIT_NUMBER AS LEAD_UNIT_NUMBER,
        T11.UNIT_NAME AS LEAD_UNIT_NAME,
        T6.NAME AS GRANT_CALL_TITLE,
        T1.SPONSOR_CODE AS SPONSOR_CODE,
        T7.SPONSOR_NAME AS SPONSOR_NAME,
        T1.PRIME_SPONSOR_CODE AS PRIME_SPONSOR_CODE,
        T8.SPONSOR_NAME AS PRIME_SPONSOR_NAME,
        DATE(T1.AWARD_EXECUTION_DATE) AS AWARD_EXECUTION_DATE,
        DATE(T1.AWARD_EFFECTIVE_DATE) AS AWARD_EFFECTIVE_DATE,
        DATE(T1.FINAL_EXPIRATION_DATE) AS FINAL_EXPIRATION_DATE,
        T1.AWARD_SEQUENCE_STATUS AS AWARD_SEQUENCE_STATUS,
        IFNULL(T22.FULL_NAME,T20.FULL_NAME) AS KEY_PERSON_NAME,
        IFNULL(T9.PERSON_ID, T9.ROLODEX_ID) AS KEY_PERSON_ID,
        T9.PERSON_ROLE_ID,
        T12.DESCRIPTION AS PERSON_ROLE,
        IFNULL(T10.ANTICIPATED_TOTAL_AMOUNT,0.00) AS ANTICIPATED_TOTAL_AMOUNT,
        IFNULL(T10.AMOUNT_OBLIGATED_TO_DATE,0.00) AS AMOUNT_OBLIGATED_TO_DATE,
        DATE(T10.CURRENT_FUND_EFFECTIVE_DATE) AS CURRENT_FUND_EFFECTIVE_DATE,
        DATE(T10.OBLIGATION_EXPIRATION_DATE) AS OBLIGATION_EXPIRATION_DATE,
        DATE(T1.BEGIN_DATE) AS BEGIN_DATE,
        (CASE WHEN (T9.PERSON_ID IS NOT NULL) THEN 'Y'
        ELSE 'N'
        END) AS EMPLOYEE_FLAG,
        (SELECT IFNULL(PERSON_ID,ROLODEX_ID) FROM
        AWARD_PERSONS P1 WHERE P1.AWARD_ID = T1.AWARD_ID AND P1.PI_FLAG = 'Y') AS PI_PERSON_ID,
        (SELECT IFNULL(P2.FULL_NAME,R1.FULL_NAME) FROM
        AWARD_PERSONS P1
        LEFT JOIN PERSON P2 ON P1.PERSON_ID = P2.PERSON_ID
        LEFT JOIN ROLODEX R1 ON P1.ROLODEX_ID = R1.ROLODEX_ID
        WHERE P1.AWARD_ID = T1.AWARD_ID AND P1.PI_FLAG = 'Y'
        ) AS PI_NAME,
        (SELECT P2.HOME_UNIT
        FROM AWARD_PERSONS P1
        INNER JOIN PERSON P2 ON P1.PERSON_ID = P2.PERSON_ID
        WHERE P1.AWARD_ID = T1.AWARD_ID AND P1.PI_FLAG = 'Y' AND P1.PERSON_ID IS NOT NULL
        ) AS PI_HOME_UNIT_NUMBER,
        (SELECT U1.UNIT_NAME
        FROM AWARD_PERSONS P1
        INNER JOIN PERSON P2 ON P1.PERSON_ID = P2.PERSON_ID
        INNER JOIN UNIT U1 ON P2.HOME_UNIT = U1.UNIT_NUMBER
        WHERE P1.AWARD_ID = T1.AWARD_ID AND P1.PI_FLAG = 'Y' AND P1.PERSON_ID IS NOT NULL
        ) AS PI_HOME_UNIT,
        T1.WORKFLOW_AWARD_STATUS_CODE,
        T13.DESCRIPTION AS AWARD_WORKFLOW_STATUS_DESC,
        T1.SPONSOR_AWARD_NUMBER,
        IFNULL(T21.ORGANIZATION_NAME,T20.ORGANIZATION_NAME)AS KEY_PERSON_ORGANIZATION,
        T23.UNIT_NUMBER AS KEY_PERSON_DEPARTMENT_NUMBER,
        T23.UNIT_NAME AS KEY_PERSON_DEPARTMENT,
        IFNULL(T40.COUNTRY_NAME,T30.COUNTRY_NAME) AS KEY_PERSON_COUNTRY,
        IFNULL(T22.EMAIL_ADDRESS,T20.EMAIL_ADDRESS) AS KEY_PERSON_EMAIL,
        IFNULL(T25.COST_SHARE_AMT,0.00) AS TOTAL_COST_SHARE,
        IFNULL(T10.ANTICIPATED_TOTAL_AMOUNT,0)+IFNULL(T25.COST_SHARE_AMT,0) AS TOTAL_PROJECT_COST,
        IFNULL(T10.TOTAL_COST_IN_CURRENCY,0.00) AS TOTAL_COST_IN_CURRENCY,
        IFNULL(T14.TOTAL_COST,0.00) AS TOTAL_COST,
        IFNULL(T14.TOTAL_DIRECT_COST,0.00) AS TOTAL_DIRECT_COST,
        IFNULL(T14.TOTAL_INDIRECT_COST,0.00) AS TOTAL_INDIRECT_COST,
        T16.DESCRIPTION AS BASIS_OF_PAYMENT_DESC,
        T17.DESCRIPTION AS METHOD_OF_PAYMENT_DESC,
        T18.DESCRIPTION AS PAYMENT_INVOICE_FREQ_DESC,
        T19.DESCRIPTION AS RATE_CLASS_CODE,
        T1.CREATE_TIMESTAMP AS AWARD_CREATE_TIMESTAMP,
        T1.CREATE_USER,
        T15.STEM_NONSTEM,
        T15.RIE_DOMAIN,
        T15.INPUT_GST_CATEGORY,
        T15.OUTPUT_GST_CATEGORY,
        T15.GRANT_CODE,
        T15.SUB_LEAD_UNIT,
        T15.PROFIT_CENTER,
        T15.FUND_CENTER,
        T15.COST_CENTER,
        T15.MULTIPLIER,
        IFNULL(T33.CUMULATIVE_REVENUE,0.00) AS CUMULATIVE_REVENUE,
        IFNULL(T31.CUMULATIVE_ACTUAL_EXPENSE,0.00) AS CUMULATIVE_ACTUAL_EXPENSE,
        IFNULL(T32.CUMULATIVE_COMMITTED_EXPENSE,0.00) AS CUMULATIVE_COMMITTED_EXPENSE,
        IFNULL(T34.LATEST_APPROVED_BUDGET,0)-IFNULL(T31.CUMULATIVE_ACTUAL_EXPENSE,0) AS BALANCE_FUND,
        IFNULL(T34.LATEST_APPROVED_BUDGET,0)-(ifnull(T31.CUMULATIVE_ACTUAL_EXPENSE,0) + ifnull(T32.CUMULATIVE_COMMITTED_EXPENSE,0)) AS BALANCE_LESS_COMMITTED_AMOUNT,
        IFNULL(T35.ORIGINAL_APPROVED_BUDGET,0.00) AS ORIGINAL_APPROVED_BUDGET,
        IFNULL(T34.LATEST_APPROVED_BUDGET,0.00) AS LATEST_APPROVED_BUDGET,
        (CASE WHEN (LATEST_APPROVED_BUDGET IS NOT NULL AND LATEST_APPROVED_BUDGET > 0) THEN IFNULL(ROUND((T31.CUMULATIVE_ACTUAL_EXPENSE/T34.LATEST_APPROVED_BUDGET)*100,2),0) ELSE 0 END)
		 AS UTILIZATION_RATE,
        T1.DURATION,
        T9.PERCENTAGE_OF_EFFORT,
        IFNULL(T14.CUMULATIVE_VIREMENT,0.00)   AS CUMULATIVE_VIREMENT,
        T15.DISPLAY_AT_ACAD_PROFILE,
        (CASE WHEN ((TIMESTAMPDIFF(MONTH,T1.BEGIN_DATE, DATE_ADD(T1.FINAL_EXPIRATION_DATE, INTERVAL 1 DAY ))) IS NOT NULL AND 
        (TIMESTAMPDIFF(MONTH,T1.BEGIN_DATE, DATE_ADD(T1.FINAL_EXPIRATION_DATE, INTERVAL 1 DAY ))) > 0) THEN
		IFNULL(T10.ANTICIPATED_TOTAL_AMOUNT,0.00)/(TIMESTAMPDIFF(MONTH,T1.BEGIN_DATE, DATE_ADD(T1.FINAL_EXPIRATION_DATE, INTERVAL 1 DAY )))
		ELSE 0 END)  AS GRANT_PER_MONTH,
        T26.DESCRIPTION AS F_AND_A_RATE_TYPE,
        datediff(NOW(),T1.BEGIN_DATE)+1 AS PROJECT_AGE,
        T28.DESCRIPTION AS FUNDING_SCHEME,
        T7.SPONSOR_TYPE_CODE,
        T29.DESCRIPTION AS SPONSOR_TYPE,
        utc_timestamp(),
        T6.ABBREVIATION,
        T37.SPONSOR_NAME AS GRANT_FUNDING_AGENCY,
        T38.DESCRIPTION AS GRANT_FUNDING_AGENCY_TYPE,
        T41.COUNTRY_NAME AS SPONSOR_COUNTRY,
        T42.COUNTRY_NAME AS PRIME_SPONSOR_COUNTRY,
        FN_GET_AWARD_FUND_CODE(T1.AWARD_NUMBER,T1.ACCOUNT_TYPE_CODE) AS FUND_CODE,
        T1.STATUS_CODE,
        IFNULL(T43.ACTUAL_EXPENSE_WO_IRC, 0.00),
        IFNULL(T44.COMMITTED_EXPENSE_WO_IRC, 0.00),
        (CASE WHEN (TOTAL_DIRECT_COST IS NOT NULL AND TOTAL_DIRECT_COST > 0) THEN
		IFNULL(ROUND((IFNULL(T43.ACTUAL_EXPENSE_WO_IRC, 0.00)/IFNULL(T14.TOTAL_DIRECT_COST,0.00))*100,2),0) ELSE 0 END)  AS UTILIZATION_RATE_WO_IRC,
        T15.LEVEL_2_SUP_ORG,
        IFNULL(T22.GENDER,NULL) AS KEY_PERSON_GENDER,
        T45.FEED_STATUS,
        T46.NTU_PRIORITY,
        T1.FUNDER_APPROVAL_DATE,
        T15.CLAIM_PREPARER,
	T47.AREA_OF_RESEARCH,
        T48.DESCRIPTION AS SPECIAL_REVIEW
        
FROM TEMP_AWARD_MASTER_DATASET T1
LEFT OUTER JOIN AWARD_STATUS T2 ON T1.STATUS_CODE = T2.STATUS_CODE
LEFT OUTER JOIN ACCOUNT_TYPE T3 ON T1.ACCOUNT_TYPE_CODE = T3.ACCOUNT_TYPE_CODE
LEFT OUTER JOIN AWARD_TYPE T4 ON T4.AWARD_TYPE_CODE = T1.AWARD_TYPE_CODE
LEFT OUTER JOIN ACTIVITY_TYPE T5 ON T1.ACTIVITY_TYPE_CODE = T5.ACTIVITY_TYPE_CODE
LEFT OUTER JOIN GRANT_CALL_HEADER T6 ON T1.GRANT_HEADER_ID = T6.GRANT_HEADER_ID
LEFT OUTER JOIN SPONSOR T7 ON T1.SPONSOR_CODE = T7.SPONSOR_CODE
LEFT OUTER JOIN SPONSOR T8 ON T1.PRIME_SPONSOR_CODE = T8.SPONSOR_CODE
LEFT OUTER JOIN AWARD_PERSONS T9 ON T1.AWARD_ID = T9.AWARD_ID
LEFT OUTER JOIN (SELECT S1.AWARD_ID AS AWARD_ID,
        S1.AWARD_NUMBER AS AWARD_NUMBER,
        S1.ANTICIPATED_TOTAL_AMOUNT AS ANTICIPATED_TOTAL_AMOUNT,
        S1.AMOUNT_OBLIGATED_TO_DATE AS AMOUNT_OBLIGATED_TO_DATE,
        S1.FINAL_EXPIRATION_DATE AS FINAL_EXPIRATION_DATE,
        S1.CURRENT_FUND_EFFECTIVE_DATE AS CURRENT_FUND_EFFECTIVE_DATE,
        S1.OBLIGATION_EXPIRATION_DATE AS OBLIGATION_EXPIRATION_DATE,
        S1.TOTAL_COST_IN_CURRENCY
        FROM AWARD_AMOUNT_INFO S1,
        (SELECT MAX(
S3.AWARD_AMOUNT_INFO_ID
) AS AWARD_AMOUNT_INFO_ID
,S3.AWARD_NUMBER FROM AWARD_AMOUNT_INFO S3
LEFT JOIN AWARD_AMOUNT_TRANSACTION S2 ON S3.TRANSACTION_ID = S2.TRANSACTION_ID
INNER JOIN AWARD S5 ON S5.AWARD_NUMBER = S3.AWARD_NUMBER
WHERE (S2.TRANSACTION_STATUS_CODE in ('P','A') AND S5.AWARD_DOCUMENT_TYPE_CODE = 1 
AND S5.AWARD_SEQUENCE_STATUS = 'PENDING') OR (S2.TRANSACTION_STATUS_CODE = 'A' AND S5.AWARD_SEQUENCE_STATUS = 'ACTIVE') 
GROUP BY S3.AWARD_NUMBER) S2
WHERE S1.AWARD_AMOUNT_INFO_ID = S2.AWARD_AMOUNT_INFO_ID
AND S1.AWARD_NUMBER = S2.AWARD_NUMBER
        ) T10 ON T1.AWARD_NUMBER = T10.AWARD_NUMBER
LEFT OUTER JOIN UNIT T11 ON T1.LEAD_UNIT_NUMBER = T11.UNIT_NUMBER
LEFT OUTER JOIN EPS_PROP_PERSON_ROLE T12 ON T9.PERSON_ROLE_ID = T12.PROP_PERSON_ROLE_ID
LEFT OUTER JOIN AWARD_WORKFLOW_STATUS T13 ON T1.WORKFLOW_AWARD_STATUS_CODE = T13.WORKFLOW_AWARD_STATUS_CODE
LEFT OUTER JOIN (SELECT S3.AWARD_ID,
        S3.TOTAL_COST,
        S3.TOTAL_DIRECT_COST,
        S3.TOTAL_INDIRECT_COST,
        S3.RATE_CLASS_CODE,
        S3.CUMULATIVE_VIREMENT,
        S3.RATE_TYPE_CODE
        FROM AWARD_BUDGET_HEADER S3
        WHERE S3.VERSION_NUMBER IN (SELECT MAX(S4.VERSION_NUMBER) FROM AWARD_BUDGET_HEADER S4
        WHERE S3.AWARD_ID = S4.AWARD_ID)) T14 ON T1.AWARD_ID = T14.AWARD_ID
LEFT OUTER JOIN CUSTOM_DATA_REPORT_RT T15 ON T1.AWARD_ID = T15.MODULE_ITEM_KEY
LEFT OUTER JOIN AWARD_BASIS_OF_PAYMENT T16 ON T1.BASIS_OF_PAYMENT_CODE = T16.BASIS_OF_PAYMENT_CODE
LEFT OUTER JOIN AWARD_METHOD_OF_PAYMENT T17 ON T1.METHOD_OF_PAYMENT_CODE = T17.METHOD_OF_PAYMENT_CODE
LEFT OUTER JOIN INVOICE_FREQUENCY T18 ON T1.PAYMENT_INVOICE_FREQ_CODE = T18.INVOICE_FREQUENCY_CODE
LEFT OUTER JOIN RATE_CLASS T19 ON T14.RATE_CLASS_CODE = T19.RATE_CLASS_CODE
LEFT OUTER JOIN ROLODEX T20 ON T9.ROLODEX_ID = T20.ROLODEX_ID
LEFT OUTER JOIN ORGANIZATION T21 ON T20.ORGANIZATION = T21.ORGANIZATION_ID
LEFT OUTER JOIN PERSON T22 ON T9.PERSON_ID = T22.PERSON_ID
LEFT OUTER JOIN UNIT T23 ON T22.HOME_UNIT = T23.UNIT_NUMBER
LEFT OUTER JOIN (SELECT S5.AWARD_ID,SUM(COMMITMENT_AMOUNT) AS COST_SHARE_AMT FROM AWARD_COST_SHARE S5
        GROUP BY S5.AWARD_ID )T25 ON T1.AWARD_ID = T25.AWARD_ID
LEFT OUTER JOIN RATE_TYPE T26 ON T14.RATE_TYPE_CODE = T26.RATE_TYPE_CODE
        AND T14.RATE_CLASS_CODE = T26.RATE_CLASS_CODE
LEFT OUTER JOIN SPONSOR_FUNDING_SCHEME T27 ON T6.FUNDING_SCHEME_ID = T27.FUNDING_SCHEME_ID
LEFT OUTER JOIN FUNDING_SCHEME T28 ON T27.FUNDING_SCHEME_CODE = T28.FUNDING_SCHEME_CODE
LEFT OUTER JOIN SPONSOR_TYPE T29 ON T7.SPONSOR_TYPE_CODE = T29.SPONSOR_TYPE_CODE
LEFT OUTER JOIN COUNTRY T30 ON T20.COUNTRY_CODE = T30.COUNTRY_CODE
LEFT OUTER JOIN COUNTRY T40 ON T22.COUNTRY_CODE = T40.COUNTRY_CODE
LEFT OUTER JOIN (SELECT A2.AWARD_ID,S1.ACCOUNT_NUMBER,
        SUM(S1.TOTAL_EXPENSE_AMOUNT) AS CUMULATIVE_ACTUAL_EXPENSE
        FROM AWARD_BUDGET_HEADER A2
        INNER JOIN AWARD_BUDGET_DETAIL A3 ON A2.BUDGET_HEADER_ID = A3.BUDGET_HEADER_ID
        INNER JOIN AWARD_EXPENSE_DETAILS S1 ON A3.INTERNAL_ORDER_CODE = S1.INTERNAL_ORDER_CODE
        WHERE A2.VERSION_NUMBER IN (SELECT max(AB1.VERSION_NUMBER) FROM AWARD_BUDGET_HEADER AB1
        WHERE AB1.AWARD_ID = A2.AWARD_ID)
        AND A2.AWARD_ID in (SELECT AWARD_ID FROM TEMP_AWARD_MASTER_DATASET)
        GROUP BY S1.ACCOUNT_NUMBER,A2.AWARD_ID
        ) T31 ON T1.ACCOUNT_NUMBER = T31.ACCOUNT_NUMBER  AND T31.AWARD_ID = T1.AWARD_ID
LEFT OUTER JOIN (SELECT A2.AWARD_ID,
        S2.ACCOUNT_NUMBER,
        SUM(S2.COMMITTED_AMOUNT) AS CUMULATIVE_COMMITTED_EXPENSE
        FROM AWARD_BUDGET_HEADER A2
        INNER JOIN AWARD_BUDGET_DETAIL A3 ON A2.BUDGET_HEADER_ID = A3.BUDGET_HEADER_ID
        INNER JOIN AWARD_EXPENSE_DETAILS_EXT S2 ON S2.INTERNAL_ORDER_CODE = A3.INTERNAL_ORDER_CODE
        WHERE S2.IS_FROM_SAP = 'Y'
        AND A2.VERSION_NUMBER IN (SELECT max(AB1.VERSION_NUMBER) FROM AWARD_BUDGET_HEADER AB1
        WHERE AB1.AWARD_ID = A2.AWARD_ID)
        AND A2.AWARD_ID IN (SELECT AWARD_ID FROM TEMP_AWARD_MASTER_DATASET)
        GROUP BY S2.ACCOUNT_NUMBER,A2.AWARD_ID
        ) T32 ON T1.ACCOUNT_NUMBER = T32.ACCOUNT_NUMBER  AND  T1.AWARD_ID =  T32.AWARD_ID
LEFT OUTER JOIN (SELECT A2.AWARD_ID,S1.ACCOUNT_NUMBER,
        SUM(S1.TOTAL_EXPENSE_AMOUNT) AS ACTUAL_EXPENSE_WO_IRC
        FROM AWARD_BUDGET_HEADER A2
        INNER JOIN AWARD_BUDGET_DETAIL A3 ON A2.BUDGET_HEADER_ID = A3.BUDGET_HEADER_ID
        INNER JOIN AWARD_EXPENSE_DETAILS S1 ON A3.INTERNAL_ORDER_CODE = S1.INTERNAL_ORDER_CODE
        WHERE A2.VERSION_NUMBER IN (SELECT max(AB1.VERSION_NUMBER) FROM AWARD_BUDGET_HEADER AB1
        WHERE AB1.AWARD_ID = A2.AWARD_ID)
        AND substr(A3.INTERNAL_ORDER_CODE,16,3) <> 'IRC'
        AND A2.AWARD_ID IN (SELECT AWARD_ID FROM TEMP_AWARD_MASTER_DATASET)
        GROUP BY S1.ACCOUNT_NUMBER,A2.AWARD_ID
        ) T43 ON T1.ACCOUNT_NUMBER = T43.ACCOUNT_NUMBER  AND T43.AWARD_ID = T1.AWARD_ID
LEFT OUTER JOIN (SELECT A2.AWARD_ID,
        S2.ACCOUNT_NUMBER,
        SUM(S2.COMMITTED_AMOUNT) AS COMMITTED_EXPENSE_WO_IRC
        FROM AWARD_BUDGET_HEADER A2
        INNER JOIN AWARD_BUDGET_DETAIL A3 ON A2.BUDGET_HEADER_ID = A3.BUDGET_HEADER_ID
        INNER JOIN AWARD_EXPENSE_DETAILS_EXT S2 ON S2.INTERNAL_ORDER_CODE = A3.INTERNAL_ORDER_CODE
        WHERE S2.IS_FROM_SAP = 'Y'
        AND A2.VERSION_NUMBER IN (SELECT max(AB1.VERSION_NUMBER) FROM AWARD_BUDGET_HEADER AB1
        WHERE AB1.AWARD_ID = A2.AWARD_ID)
        AND substr(A3.INTERNAL_ORDER_CODE,16,3) <> 'IRC'
        AND A2.AWARD_ID IN (SELECT AWARD_ID FROM TEMP_AWARD_MASTER_DATASET)
        GROUP BY S2.ACCOUNT_NUMBER,A2.AWARD_ID
        ) T44 ON T1.ACCOUNT_NUMBER = T44.ACCOUNT_NUMBER  AND  T1.AWARD_ID =  T44.AWARD_ID
LEFT OUTER JOIN (SELECT S3.ACCOUNT_NUMBER,
        SUM(S3.TOTAL_REVENUE_AMOUNT) AS CUMULATIVE_REVENUE
        FROM AWARD_REVENUE_DETAILS S3
        GROUP BY S3.ACCOUNT_NUMBER
        )T33 ON T1.ACCOUNT_NUMBER = T33.ACCOUNT_NUMBER
LEFT OUTER JOIN (SELECT S4.AWARD_ID,
        S4.TOTAL_COST AS LATEST_APPROVED_BUDGET
        FROM AWARD_BUDGET_HEADER S4
        WHERE S4.VERSION_NUMBER IN (SELECT MAX(S5.VERSION_NUMBER) FROM AWARD_BUDGET_HEADER S5
        WHERE S4.AWARD_ID = S5.AWARD_ID
        ))T34 ON T1.AWARD_ID = T34.AWARD_ID
LEFT OUTER JOIN (SELECT S6.AWARD_ID,
        S6.TOTAL_COST AS ORIGINAL_APPROVED_BUDGET
        FROM AWARD_BUDGET_HEADER S6
        WHERE S6.VERSION_NUMBER IN (SELECT MIN(S7.VERSION_NUMBER) FROM AWARD_BUDGET_HEADER S7
        WHERE S6.AWARD_ID = S7.AWARD_ID
        ))T35 ON T1.AWARD_ID = T35.AWARD_ID
LEFT OUTER JOIN SPONSOR T37 ON T6.SPONSOR_CODE = T37.SPONSOR_CODE
LEFT OUTER JOIN SPONSOR_TYPE T38 ON T6.SPONSOR_TYPE_CODE = T38.SPONSOR_TYPE_CODE
LEFT OUTER JOIN COUNTRY T41 ON T7.COUNTRY_CODE = T41.COUNTRY_CODE
LEFT OUTER JOIN COUNTRY T42 ON T8.COUNTRY_CODE = T42.COUNTRY_CODE
LEFT OUTER JOIN (SELECT T43.AWARD_ID, T44.DESCRIPTION AS FEED_STATUS
        FROM SAP_AWARD_FEED T43
        INNER JOIN SAP_FEED_STATUS T44 ON T44.FEED_STATUS_CODE = T43.FEED_STATUS
        ) T45 ON T1.AWARD_ID = T45.AWARD_ID
LEFT OUTER JOIN (SELECT GROUP_CONCAT(DISTINCT R2.DESCRIPTION SEPARATOR ', ') AS NTU_PRIORITY, R1.AWARD_ID  FROM AWARD_RESEARCH_AREAS R1
        INNER JOIN RESEARCH_TYPE_AREA R2 ON R2.RESRCH_TYPE_AREA_CODE = R1.RESRCH_TYPE_AREA_CODE AND R1.RESRCH_TYPE_CODE = 2 GROUP BY R1.AWARD_ID)
        T46 ON T1.AWARD_ID = T46.AWARD_ID
LEFT OUTER JOIN (SELECT GROUP_CONCAT(DISTINCT R2.DESCRIPTION SEPARATOR ', ') AS AREA_OF_RESEARCH, R1.AWARD_ID  FROM AWARD_RESEARCH_AREAS R1
        INNER JOIN RESEARCH_TYPE_AREA R2 ON R2.RESRCH_TYPE_AREA_CODE = R1.RESRCH_TYPE_AREA_CODE AND R1.RESRCH_TYPE_CODE = 1 GROUP BY R1.AWARD_ID)
        T47 ON T1.AWARD_ID = T47.AWARD_ID
LEFT JOIN AWARD_SPECIAL_REVIEW ASR ON ASR.AWARD_ID = T1.AWARD_ID
LEFT JOIN SPECIAL_REVIEW T48 ON T48.SPECIAL_REVIEW_CODE = ASR.SPECIAL_REVIEW_CODE
where ((T1.AWARD_SEQUENCE_STATUS = 'PENDING' AND T1.SEQUENCE_NUMBER = 1)
        OR (T1.AWARD_SEQUENCE_STATUS = 'ACTIVE'))
        
);
COMMIT;
END;
 SET TRANSACTION ISOLATION LEVEL REPEATABLE READ;
 
 
-- DELETE DATA WHICH ARE NOT AVAILABLE IN AWARD TABLE

SET SQL_SAFE_UPDATES = 0;

 DELETE FROM AWARD_MASTER_DATASET_RT WHERE AWARD_ID NOT IN (SELECT AWARD_ID FROM AWARD);

SET SQL_SAFE_UPDATES = 1;

SELECT 'AWARD_MASTER_DATASET_SYNC executed successfully' AS SUCCESS FROM DUAL;
 END;
