CREATE PROCEDURE SR_CUSTOM_DATA_RT_SYNC_BY_SR_HEADER_ID(AV_MODULE_ITEM_KEY INT, AV_COPY_MODULE_ITEM_KEY INT)
PROC:BEGIN
    DECLARE LS_INSERT LONGTEXT DEFAULT '';
    DECLARE LS_QUERY LONGTEXT DEFAULT '';
    DECLARE LS_COLUMN_NAME VARCHAR(4000);
    DECLARE LS_COST_ELEMENT_ID VARCHAR(2000);
    DECLARE NOT_FOUND INT DEFAULT 0;
	DECLARE LI_CNT INT DEFAULT 1;
	DECLARE LS_SELECT_FIELD LONGTEXT DEFAULT ' ';
	DECLARE LS_TAB_FORM LONGTEXT DEFAULT ' ';
	DECLARE LI_COLUMN_ID INT;
    DECLARE LI_DEL INT DEFAULT 0;
    DECLARE LS_STATUS VARCHAR(255) ;
    DECLARE LI_SEQUENCE_NUMBER INT DEFAULT 0;
    DECLARE l_count INT;
    DECLARE LS_IS_MULTI_SELECT_LOOKUP VARCHAR(1);
    DECLARE LS_DATATYPE VARCHAR(30);

    DECLARE LS_CUST_DATA LONGTEXT;

    DECLARE SEL_COLUMN_NAME CURSOR FOR
        WITH SR_CUSTOM_DATA AS (
        SELECT DISTINCT CONCAT('CUST_ELEMENTS_ID_',CD.CUSTOM_DATA_ELEMENTS_ID) AS 'CUST_ELEMENT' FROM
        CUSTOM_DATA CD
		INNER JOIN CUSTOM_DATA_ELEMENT_USAGE CDU ON (CDU.MODULE_CODE = CD.MODULE_ITEM_CODE AND CDU.MODULE_CODE = 20)
        WHERE CD.MODULE_ITEM_CODE = 20 AND CD.MODULE_ITEM_KEY = AV_MODULE_ITEM_KEY
        )
        SELECT COLUMN_NAME FROM INFORMATION_SCHEMA.COLUMNS
        INNER JOIN SR_CUSTOM_DATA ACD ON ACD.CUST_ELEMENT = COLUMN_NAME
        WHERE TABLE_SCHEMA  = (SELECT DATABASE())
        AND TABLE_NAME = 'SR_CUSTOM_DATA_RT'
        AND COLUMN_NAME <> 'SR_HEADER_ID'
        AND COLUMN_NAME <> 'UPDATE_TIMESTAMP'
        AND COLUMN_NAME <> 'SR_CUSTOM_DATA_RT_ID'
        ORDER BY ORDINAL_POSITION;

    DECLARE CONTINUE HANDLER FOR NOT FOUND SET NOT_FOUND = 1;

    SELECT count(1) into l_count FROM CUSTOM_DATA WHERE MODULE_ITEM_KEY = AV_MODULE_ITEM_KEY and MODULE_ITEM_CODE = 20;
    IF l_count = 0 THEN
        SET SQL_SAFE_UPDATES = 0;
        DELETE FROM SR_CUSTOM_DATA_RT WHERE SR_HEADER_ID = AV_MODULE_ITEM_KEY;
        SET SQL_SAFE_UPDATES = 1;
        LEAVE PROC;
    END IF;

        OPEN SEL_COLUMN_NAME;

            COLUMN_NAME_LOOP: LOOP
                SET NOT_FOUND = 0;
                FETCH SEL_COLUMN_NAME INTO LS_COLUMN_NAME ;

                IF NOT_FOUND = 1 THEN
                    LEAVE COLUMN_NAME_LOOP;
                END IF;


                SELECT  t1.CUSTOM_DATA_ELEMENTS_ID, IS_MULTI_SELECT_LOOKUP, DATA_TYPE INTO LS_COST_ELEMENT_ID, LS_IS_MULTI_SELECT_LOOKUP, LS_DATATYPE FROM CUSTOM_DATA_ELEMENTS T1
                WHERE CONCAT('CUST_ELEMENTS_ID_',T1.CUSTOM_DATA_ELEMENTS_ID) = LS_COLUMN_NAME;

                IF (LS_COST_ELEMENT_ID IS NOT NULL) THEN

                    SET LS_INSERT = CONCAT(LS_INSERT,LS_COLUMN_NAME,',');

                    SET LS_SELECT_FIELD = CONCAT(LS_SELECT_FIELD,',T',LI_CNT,'.C1');

                SET LS_CUST_DATA = IF(LS_IS_MULTI_SELECT_LOOKUP = "Y" AND LS_DATATYPE IN (4, 8, 9), 'GROUP_CONCAT(COALESCE(DESCRIPTION, VALUE) SEPARATOR " ,")', 'COALESCE(DESCRIPTION, VALUE)');

                IF LI_CNT = 1 THEN

                    SET LS_TAB_FORM = CONCAT(LS_TAB_FORM,' (SELECT MODULE_ITEM_KEY,', LS_CUST_DATA,' AS c1
                    FROM CUSTOM_DATA WHERE MODULE_ITEM_CODE = 20 AND CUSTOM_DATA_ELEMENTS_ID = ',LS_COST_ELEMENT_ID,' AND MODULE_ITEM_KEY =',AV_MODULE_ITEM_KEY,') AS T',LI_CNT, ' RIGHT JOIN ');

                    ELSE

                    SET LS_TAB_FORM = CONCAT(LS_TAB_FORM,' (SELECT MODULE_ITEM_KEY, ', LS_CUST_DATA,' AS c1
                        FROM CUSTOM_DATA WHERE MODULE_ITEM_CODE = 20 AND CUSTOM_DATA_ELEMENTS_ID = ',LS_COST_ELEMENT_ID,' AND MODULE_ITEM_KEY =',AV_MODULE_ITEM_KEY,')
                        AS T',LI_CNT,' ON  T',LI_CNT,'.MODULE_ITEM_KEY = T',(LI_CNT-1),'.MODULE_ITEM_KEY RIGHT JOIN');           
                    END IF;

                    SET LI_CNT = LI_CNT+1;
                END IF;
            END LOOP COLUMN_NAME_LOOP;
        CLOSE SEL_COLUMN_NAME;

        IF (LS_TAB_FORM IS NULL OR LS_TAB_FORM = ' ' OR  LS_SELECT_FIELD IS NULL OR LS_SELECT_FIELD = ' ') THEN
            LEAVE PROC;
        END IF;
 
        SET LS_TAB_FORM = LEFT(LS_TAB_FORM,LENGTH(LS_TAB_FORM)-11);

        SELECT COUNT(1) INTO LI_DEL FROM SR_CUSTOM_DATA_RT WHERE SR_HEADER_ID = AV_MODULE_ITEM_KEY;
            IF LI_DEL >= 1  THEN 
                SET SQL_SAFE_UPDATES = 0;
                    DELETE FROM SR_CUSTOM_DATA_RT WHERE SR_HEADER_ID = AV_MODULE_ITEM_KEY ;
                SET SQL_SAFE_UPDATES = 1;
            END IF;
        SET LS_QUERY = CONCAT('SELECT T1.MODULE_ITEM_KEY ',LS_SELECT_FIELD,' ,NOW()  FROM ',LS_TAB_FORM,' WHERE T1.MODULE_ITEM_KEY = ',AV_MODULE_ITEM_KEY);

    SET @sql = CONCAT('    
            INSERT INTO SR_CUSTOM_DATA_RT (SR_HEADER_ID,',LS_INSERT,'UPDATE_TIMESTAMP) ' , LS_QUERY
    );
  
   PREPARE STMT FROM @SQL;
   EXECUTE STMT;
   DEALLOCATE PREPARE STMT;
    
END PROC
