CREATE PROCEDURE `PR_MASTER_DATASET_SYNC`()
BEGIN
DECLARE LS_ERR_FLG                  VARCHAR(1);
DECLARE LD_SYNC_INTERVAL_START_TIME DATETIME;
DECLARE LD_SYNC_INTERVAL_END_TIME   DATETIME;
DECLARE LD_CURRENT_TIMESTAMP        DATETIME;
DECLARE DONE                        BOOLEAN;

DECLARE CONTINUE HANDLER FOR NOT FOUND SET DONE = TRUE;
DECLARE EXIT HANDLER FOR SQLEXCEPTION
BEGIN
SELECT CONCAT('Count of failed : ', (SELECT COUNT(1) FROM TEMP_PR_MASTER_DATASET_RT)) AS ''
UNION
SELECT 'The awards which got failed while syncing progress report data is as listed below:';
SELECT T1.AWARD_ID, A.AWARD_NUMBER, T1.PROGRESS_REPORT_NUMBER
FROM TEMP_PR_MASTER_DATASET_RT T1
JOIN AWARD A ON T1.AWARD_ID = A.AWARD_ID;
SET AUTOCOMMIT = 1;
ROLLBACK;
TRUNCATE TEMP_PR_MASTER_DATASET_RT;
END;

BEGIN
	SET SQL_SAFE_UPDATES = 0;
	SET AUTOCOMMIT = 0;
	SET LS_ERR_FLG = 'N';
	

SELECT  UTC_TIMESTAMP() INTO LD_CURRENT_TIMESTAMP;
SELECT  DATE_SUB(PR_LAST_SYNC_TIMESTAMP,INTERVAL 4 MINUTE) INTO LD_SYNC_INTERVAL_START_TIME FROM REPORT_LAST_SYNC_TIME;
SELECT  DATE_SUB(UTC_TIMESTAMP(), INTERVAL 3 MINUTE) INTO LD_SYNC_INTERVAL_END_TIME;

TRUNCATE TEMP_PR_MASTER_DATASET_RT;

INSERT INTO TEMP_PR_MASTER_DATASET_RT(PROGRESS_REPORT_ID,PROGRESS_REPORT_NUMBER,AWARD_ID,PROGRESS_REPORT_STATUS_CODE,REPORT_CLASS_CODE,DUE_DATE,FUNDER_APPROVAL_DATE,REPORT_START_DATE,REPORT_END_DATE,CREATE_TIMESTAMP,CREATE_USER)
(SELECT PROGRESS_REPORT_ID,PROGRESS_REPORT_NUMBER,AWARD_ID,PROGRESS_REPORT_STATUS_CODE,REPORT_CLASS_CODE,DUE_DATE,FUNDER_APPROVAL_DATE,REPORT_START_DATE,REPORT_END_DATE,CREATE_TIMESTAMP,CREATE_USER FROM AWARD_PROGRESS_REPORT WHERE PROGRESS_REPORT_NUMBER IN (SELECT A1.PROGRESS_REPORT_NUMBER FROM AWARD_PROGRESS_REPORT A1 WHERE A1.DOCUMENT_UPDATE_TIMESTAMP BETWEEN LD_SYNC_INTERVAL_START_TIME AND LD_SYNC_INTERVAL_END_TIME));

DELETE FROM PROG_RPT_HDR_RT WHERE PROGRESS_REPORT_NUMBER IN (SELECT DISTINCT PROGRESS_REPORT_NUMBER FROM TEMP_PR_MASTER_DATASET_RT); 

DELETE FROM PROG_RPT_KPI_RT WHERE PROGRESS_REPORT_ID IN (SELECT DISTINCT PROGRESS_REPORT_ID FROM TEMP_PR_MASTER_DATASET_RT); 

DELETE FROM PROG_RPT_MILESTONES_RT WHERE PROGRESS_REPORT_ID IN (SELECT DISTINCT PROGRESS_REPORT_ID FROM TEMP_PR_MASTER_DATASET_RT); 



INSERT INTO PROG_RPT_HDR_RT(
	  REPORT_TYPE,
	  PROGRESS_REPORT_ID,
	  PROGRESS_REPORT_NUMBER,
	  REPORT_STATUS,
	  REPORTING_START_DATE,
	  REPORTING_END_DATE,
	  DUE_DATE,
	 -- KPI_SUMMARY_ID,
	  REPORT_CREATED_BY,
	  REPORT_CREATED_TIMESTAMP,
	  REPORT_LAST_UPDATED_BY,
	  FUNDER_APPROVAL_DATE,
	  PROJECT_ACHIEVEMENT,
	  KEY_INFORMATION,
	  CAPABILITIES_DEVELOPED,
	  MEDIA_EXPOSURE,
	  FUTURE_ACHIEVEMENT,
	  FUTURE_PLANS_IN_SINGAPORE,
	  FUTURE_CAPABILITIES_DEVELOPED,
	  FUTURE_FURTHER_DEVELOPMENT,
	  ACHIEVEMENT_PROJECT_OBJECTIVE,
	 -- KPI_CATEGORY,
	  -- KPI_CRITERIA,
	  -- TARGET,  
	  AWARD_NUMBER,
	  AWARD_ID,
	  ACCOUNT_NUMBER,
	  SPONSOR_AWARD_NUMBER,
	  AWARD_STATUS,
	  AWARD_TYPE,
	  ACCOUNT_TYPE,
	  ACTIVITY_TYPE,
	  TITLE_GRANT_CALL,
	  GRANT_SCHEME,
	  TITLE_AWARD,
	  AWARD_NOTICEDATE,
	  AWARD_EFFECTIVEDATE,
	  FINAL_EXPIRATIONDATE,
	  AWARD_CREATEDATE,
	  DURATION_PROJECT,
	  SPONSOR,
	  PRIME_SPONSOR,
	  LEAD_UNIT,
	  SUB_LEAD_UNIT,
	  LEAD_PRINCIPAL_INVESTIGATOR,
	  KEY_PERSON_EMAIL,
	  ANTICIPATED_TOTAL,
	  OBLIGATED_TOTAL,
	  TOTAL_PROJECT_COST,
	  ORIGINAL_AMOUNT,
	  REVISED_AMOUNT,
	  WORKFLOW_START_DATE,
	  WORKFLOW_END_DATE,
	  AWARD_WORKFLOW_STATUS,
	  REPORT_LAST_UPDATED_TIMESTAMP,
	  STEM_NONSTEM,
	  RIE_DOMAIN,
	  DISPLAY_AT_ACAD_PROFILE,
	  FUNDING_SCHEME,
	  APPROVAL_COMMENT,
	  OVERALL_COMMENT,
	  LEAD_UNIT_NUMBER,
	  APPROVER_ROLE_TYPE,
	 -- ACHIEVED_SUM,
	  LAST_SYNC_TIME
	)(SELECT DISTINCT
			t22.DESCRIPTION AS REPORT_TYPE,
			t0.PROGRESS_REPORT_ID AS PROGRESS_REPORT_ID,
			t0.PROGRESS_REPORT_NUMBER AS PROGRESS_REPORT_NUMBER,
			t.DESCRIPTION AS REPORT_STATUS,
			t0.REPORT_START_DATE AS REPORTING_START_DATE,
			t0.REPORT_END_DATE AS REPORTING_END_DATE,
			t0.DUE_DATE AS DUE_DATE,
		  --   t4.KPI_SUMMARY_ID AS kpi_summary_id,
			(SELECT FULL_NAME FROM PERSON p WHERE p.USER_NAME = t0.CREATE_USER ORDER By p.STATUS LIMIT 1) AS REPORT_CREATED_BY,
			 DATE_FORMAT(CONVERT_TZ(t0.CREATE_TIMESTAMP,
                        '+00:00',
                        '+8:00'),
                '%d/%m/%Y %H:%i:%s') AS REPORT_CREATED_TIMESTAMP,
			t34.UPDATE_USER AS REPORT_LAST_UPDATED_BY,
			t0.FUNDER_APPROVAL_DATE AS FUNDER_APPROVAL_DATE,		
			(SELECT 
					award_progress_report_achievement.DESCRIPTION AS PROJECT_ACHIEVEMENT
				FROM
					award_progress_report_achievement
				WHERE
					((award_progress_report_achievement.PROGRESS_REPORT_ID = t0.PROGRESS_REPORT_ID)
						AND (award_progress_report_achievement.ACHIEVEMENT_TYPE_CODE = 1))) AS PROJECT_ACHIEVEMENT,
			(SELECT 
					award_progress_report_achievement.DESCRIPTION AS PROJECT_ACHIEVEMENT
				FROM
					award_progress_report_achievement
				WHERE
					((award_progress_report_achievement.PROGRESS_REPORT_ID = t0.PROGRESS_REPORT_ID)
						AND (award_progress_report_achievement.ACHIEVEMENT_TYPE_CODE = 2))) AS KEY_INFORMATION,
			(SELECT 
					award_progress_report_achievement.DESCRIPTION AS Project_Achievement
				FROM
					award_progress_report_achievement
				WHERE
					((award_progress_report_achievement.PROGRESS_REPORT_ID = t0.PROGRESS_REPORT_ID)
						AND (award_progress_report_achievement.ACHIEVEMENT_TYPE_CODE = 3))) AS CAPABILITIES_DEVELOPED,
			(SELECT 
					award_progress_report_achievement.DESCRIPTION AS PROJECT_ACHIEVEMENT
				FROM
					award_progress_report_achievement
				WHERE
					((award_progress_report_achievement.PROGRESS_REPORT_ID = t0.PROGRESS_REPORT_ID)
						AND (award_progress_report_achievement.ACHIEVEMENT_TYPE_CODE = 4))) AS MEDIA_EXPOSURE,
			(SELECT 
					award_progress_report_achievement.DESCRIPTION AS PROJECT_ACHIEVEMENT
				FROM
					award_progress_report_achievement
				WHERE
					((award_progress_report_achievement.PROGRESS_REPORT_ID = t0.PROGRESS_REPORT_ID)
						AND (award_progress_report_achievement.ACHIEVEMENT_TYPE_CODE = 5))) AS FUTURE_ACHIEVEMENT,
			(SELECT 
					award_progress_report_achievement.DESCRIPTION AS PROJECT_ACHIEVEMENT
				FROM
					award_progress_report_achievement
				WHERE
					((award_progress_report_achievement.PROGRESS_REPORT_ID = t0.PROGRESS_REPORT_ID)
						AND (award_progress_report_achievement.ACHIEVEMENT_TYPE_CODE = 6))) AS FUTURE_PLANS_IN_SINGAPORE,
			(SELECT 
					award_progress_report_achievement.DESCRIPTION AS PROJECT_ACHIEVEMENT
				FROM
					award_progress_report_achievement
				WHERE
					((award_progress_report_achievement.PROGRESS_REPORT_ID = t0.PROGRESS_REPORT_ID)
						AND (award_progress_report_achievement.ACHIEVEMENT_TYPE_CODE = 7))) AS FUTURE_CAPABILITIES_DEVELOPED,
			(SELECT 
					award_progress_report_achievement.DESCRIPTION AS PROJECT_ACHIEVEMENT
				FROM
					award_progress_report_achievement
				WHERE
					((award_progress_report_achievement.PROGRESS_REPORT_ID = t0.PROGRESS_REPORT_ID)
						AND (award_progress_report_achievement.ACHIEVEMENT_TYPE_CODE = 8))) AS FUTURE_FURTHER_DEVELOPMENT,
			(SELECT 
					award_progress_report_achievement.DESCRIPTION AS PROJECT_ACHIEVEMENT
				FROM
					award_progress_report_achievement
				WHERE
					((award_progress_report_achievement.PROGRESS_REPORT_ID = t0.PROGRESS_REPORT_ID)
						AND (award_progress_report_achievement.ACHIEVEMENT_TYPE_CODE = 9))) AS ACHIEVEMENT_PROJECT_OBJECTIVE,
		  --  t20.DESCRIPTION AS KPI_CATEGORY,
		  --  t21.DESCRIPTION AS KPI_CRITERIA,
		 --   t4.TARGET AS TARGET,    
			t1.AWARD_NUMBER AS AWARD_NUMBER,
			t1.AWARD_ID AS AWARD_ID,
			t1.ACCOUNT_NUMBER AS ACCOUNT_NUMBER,
			t1.SPONSOR_AWARD_NUMBER AS SPONSOR_AWARD_NUMBER,
			t1.AWARD_STATUS AS AWARD_STATUS,
			t1.AWARD_TYPE AS AWARD_TYPE,
			t1.ACCOUNT_TYPE AS ACCOUNT_TYPE,
			t1.ACTIVITY_TYPE AS ACTIVITY_TYPE,
			t1.GRANT_CALL_TITLE AS TITLE_GRANT_CALL,
			t1.FUNDING_SCHEME AS GRANT_SCHEME,
			t1.TITLE AS TITLE_AWARD,
			t1.AWARD_EFFECTIVE_DATE AS AWARD_NOTICEDATE,
			t1.BEGIN_DATE AS AWARD_EFFECTIVEDATE,
			t1.FINAL_EXPIRATION_DATE AS FINAL_EXPIRATIONDATE,
			t1.AWARD_CREATE_TIMESTAMP AS AWARD_CREATEDATE,
			t1.DURATION AS DURATION_PROJECT,
			t1.SPONSOR_NAME AS SPONSOR,
			t1.PRIME_SPONSOR_NAME AS PRIME_SPONSOR,
			t1.unit_name AS LEAD_UNIT,
			t1.SUB_LEAD_UNIT AS SUB_LEAD_UNIT,
			t1.PI_NAME AS LEAD_PRINCIPAL_INVESTIGATOR,
			t1.KEY_PERSON_EMAIL AS KEY_PERSON_EMAIL,
			t1.ANTICIPATED_TOTAL_AMOUNT AS ANTICIPATED_TOTAL,
			t1.AMOUNT_OBLIGATED_TO_DATE AS OBLIGATED_TOTAL,
			t1.TOTAL_PROJECT_COST AS TOTAL_PROJECT_COST,
			t1.ORIGINAL_APPROVED_BUDGET AS ORIGINAL_AMOUNT,
			t1.LATEST_APPROVED_BUDGET AS REVISED_AMOUNT,
			-- t34.WORKFLOW_START_DATE AS WORKFLOW_START_DATE,
            DATE_FORMAT(CONVERT_TZ(t34.WORKFLOW_START_DATE,
							'+00:00',
							'+8:00'),
					'%d/%m/%Y %H:%i:%s') AS WORKFLOW_START_DATE,
		-- 	t34.WORKFLOW_END_DATE AS WORKFLOW_END_DATE, 
            DATE_FORMAT(CONVERT_TZ(t34.WORKFLOW_END_DATE,
							'+00:00',
							'+8:00'),
					'%d/%m/%Y %H:%i:%s') AS WORKFLOW_END_DATE,
			t1.AWARD_WORKFLOW_STATUS AS AWARD_WORKFLOW_STATUS,
		-- 	t34.UPDATE_TIMESTAMP AS REPORT_LAST_UPDATED_TIMESTAMP,
			DATE_FORMAT(CONVERT_TZ(t34.UPDATE_TIMESTAMP,
							'+00:00',
							'+8:00'),
					'%d/%m/%Y %H:%i:%s') AS REPORT_LAST_UPDATED_TIMESTAMP,
			t1.STEM_NONSTEM AS STEM_NONSTEM,
			t1.RIE_DOMAIN AS RIE_DOMAIN,
			t1.DISPLAY_AT_ACAD_PROFILE AS DISPLAY_AT_ACAD_PROFILE,
			t1.FUNDING_SCHEME AS FUNDING_SCHEME,
			t34.APPROVAL_COMMENT AS APPROVAL_COMMENT,
			t34.DESCRIPTION AS OVERALL_COMMENT,
			t1.LEAD_UNIT_NUMBER AS LEAD_UNIT_NUMBER,
			t34.ROLE_TYPE AS APPROVER_ROLE_TYPE,
		   -- IFNULL(t4.ACHIEVED, '0.00') AS ACHIEVED_SUM,
			UTC_TIMESTAMP()
		FROM
			TEMP_PR_MASTER_DATASET_RT t0
			LEFT JOIN (SELECT DISTINCT
				w.MODULE_ITEM_ID AS MODULE_ITEM_ID,
					w.WORKFLOW_START_DATE AS WORKFLOW_START_DATE,
					w.WORKFLOW_END_DATE AS WORKFLOW_END_DATE,
					wd.APPROVAL_COMMENT AS APPROVAL_COMMENT,
					wd.UPDATE_TIMESTAMP AS UPDATE_TIMESTAMP,
					(CASE
						WHEN (wd.APPROVAL_STATUS = 'B') THEN NULL
						ELSE ( SELECT p.FULL_NAME FROM person p WHERE  p.USER_NAME = wd.UPDATE_USER ORDER BY STATUS LIMIT 1)
					END) AS UPDATE_USER,
					wft.DESCRIPTION AS DESCRIPTION,
					IFNULL( (SELECT pr.DESCRIPTION FROM person_role_type pr WHERE wd.ROLE_TYPE_CODE = pr.ROLE_TYPE_CODE limit 1), wd.STOP_NAME)	AS ROLE_TYPE
			FROM
				workflow w
			LEFT JOIN workflow_detail wd ON w.WORKFLOW_ID = wd.WORKFLOW_ID
			LEFT JOIN workflow_detail_ext wde ON wd.WORKFLOW_DETAIL_ID = wde.WORKFLOW_DETAIL_ID
			 -- LEFT JOIN person p ON ((p.USER_NAME = wd.UPDATE_USER)))
			LEFT JOIN workflow_feedback_type wft ON wft.FEEDBACK_TYPE_CODE = wde.FEEDBACK_TYPE_CODE
		   --  LEFT JOIN person_role_type pr ON ((wd.ROLE_TYPE_CODE = pr.ROLE_TYPE_CODE)))
			WHERE
				w.MODULE_CODE = 16
				AND wd.APPROVAL_STATUS IN ('A' , 'B','R')
				AND w.IS_WORKFLOW_ACTIVE = 'Y' ) t34 ON (t34.MODULE_ITEM_ID = t0.PROGRESS_REPORT_ID)
			LEFT JOIN report_class t22 ON ((t0.REPORT_CLASS_CODE = t22.REPORT_CLASS_CODE))
			LEFT JOIN progress_report_status t ON ((t.PROGRESS_REPORT_STATUS_CODE = t0.PROGRESS_REPORT_STATUS_CODE))
			LEFT JOIN award_master_dataset_rt t1 ON (((t1.AWARD_ID = t0.AWARD_ID)
				AND (t1.PERSON_ROLE_ID = 3))) 
			);
		   

		-- KPI with no values
		INSERT INTO PROG_RPT_KPI_RT
			(	PROGRESS_REPORT_ID,
				KPI_SUMMARY_ID ,
				KPI_CATEGORY ,
				KPI_CRITERIA ,
				TARGET
			)
		(SELECT ks.PROGRESS_REPORT_ID, 
			ks.KPI_SUMMARY_ID,
			(SELECT kt.DESCRIPTION FROM KPI_TYPE kt WHERE kt.KPI_TYPE_CODE = ks.KPI_CATEGORY_TYPE_CODE LIMIT 1) AS KPI_CATEGORY,
			(SELECT kct.DESCRIPTION FROM KPI_CRITERIA_TYPE kct WHERE kct.KPI_CRITERIA_TYPE_CODE = ks.KPI_CRITERIA_TYPE_CODE LIMIT 1) AS KPI_CRITERIA,
			ks.TARGET
		FROM award_progress_report_kpi_summary ks
		WHERE ks.progress_report_id IN ( SELECT PROGRESS_REPORT_ID FROM TEMP_PR_MASTER_DATASET_RT)
		  AND  ks.PROGRESS_REPORT_ID = ks.ORGINATING_PROGRESS_REPORT_ID
		  AND NOT EXISTS ( SELECT 1 FROM progress_report_kpi_cash_funding WHERE KPI_SUMMARY_ID = ks.KPI_SUMMARY_ID) 
		  AND NOT EXISTS ( SELECT 1 FROM progress_report_kpi_collaboration_projects WHERE KPI_SUMMARY_ID = ks.KPI_SUMMARY_ID)
		  AND NOT EXISTS ( SELECT 1 FROM progress_report_kpi_competitive_grants WHERE KPI_SUMMARY_ID = ks.KPI_SUMMARY_ID) 
		  AND NOT EXISTS ( SELECT 1 FROM progress_report_kpi_conference_presentation WHERE KPI_SUMMARY_ID = ks.KPI_SUMMARY_ID)
		  AND NOT EXISTS ( SELECT 1 FROM progress_report_kpi_grant_specific WHERE KPI_SUMMARY_ID = ks.KPI_SUMMARY_ID)
		  AND NOT EXISTS ( SELECT 1 FROM progress_report_kpi_impact_publications WHERE KPI_SUMMARY_ID = ks.KPI_SUMMARY_ID)
		  AND NOT EXISTS ( SELECT 1 FROM progress_report_kpi_inkind_contributions WHERE KPI_SUMMARY_ID = ks.KPI_SUMMARY_ID)
		  AND NOT EXISTS ( SELECT 1 FROM progress_report_kpi_licenses WHERE KPI_SUMMARY_ID = ks.KPI_SUMMARY_ID)
		  AND NOT EXISTS ( SELECT 1 FROM progress_report_kpi_manpower_development WHERE KPI_SUMMARY_ID = ks.KPI_SUMMARY_ID)
		  AND NOT EXISTS ( SELECT 1 FROM progress_report_kpi_patents WHERE KPI_SUMMARY_ID = ks.KPI_SUMMARY_ID)
		  AND NOT EXISTS ( SELECT 1 FROM progress_report_kpi_successful_startups WHERE KPI_SUMMARY_ID = ks.KPI_SUMMARY_ID)
		  AND NOT EXISTS ( SELECT 1 FROM progress_report_kpi_technologies_deployed WHERE KPI_SUMMARY_ID = ks.KPI_SUMMARY_ID) 
		  AND NOT EXISTS ( SELECT 1 FROM progress_report_kpi_technology_disclosure WHERE KPI_SUMMARY_ID = ks.KPI_SUMMARY_ID) 
		  AND NOT EXISTS ( SELECT 1 FROM progress_report_kpi_undergraduate_student WHERE KPI_SUMMARY_ID = ks.KPI_SUMMARY_ID)
		  AND NOT EXISTS ( SELECT 1 FROM progress_report_kpi_health_specific_outcomes WHERE KPI_SUMMARY_ID = ks.KPI_SUMMARY_ID)
		  AND NOT EXISTS ( SELECT 1 FROM progress_report_kpi_post_docs_employed WHERE KPI_SUMMARY_ID = ks.KPI_SUMMARY_ID)
		);

	-- Publications

	INSERT INTO PROG_RPT_KPI_RT
		(PROGRESS_REPORT_ID,
		KPI_SUMMARY_ID ,
		KPI_CATEGORY ,
		KPI_CRITERIA ,
		TARGET , 
		ACHIEVED_SUM ,
		PUBLICATIONS_STATUS ,
		PUBLICATIONS_AUTHOR_NAMES ,
		PUBLICATIONS_TITLE_OF_ARTICLE,
		PUBLICATIONS_JOURNAL_NAME ,
		PUBLICATIONS_PUBLISHER ,
		PUBLICATIONS_YEAR_ISSUENO ,
		PUBLICATIONS_PAGE_NO ,
		PUBLICATIONS_IMPACT_FACTOR ,
		PUBLICATIONS_ACKNOWLEDGEMENT_FUNDING,
		PUBLICATIONS_COMMENTS ,
		PUBLICATIONS_PUBLICATION_DATE 
	)
	(SELECT ks.PROGRESS_REPORT_ID, 
			ks.KPI_SUMMARY_ID,
			(SELECT kt.DESCRIPTION FROM KPI_TYPE kt WHERE kt.KPI_TYPE_CODE = ks.KPI_CATEGORY_TYPE_CODE LIMIT 1) AS KPI_CATEGORY,
			(SELECT kct.DESCRIPTION FROM KPI_CRITERIA_TYPE kct WHERE kct.KPI_CRITERIA_TYPE_CODE = ks.KPI_CRITERIA_TYPE_CODE LIMIT 1) AS KPI_CRITERIA,
			ks.TARGET,
			-- ks.ACHIEVED,
			(SELECT SUM(T1.ACHIEVED) FROM AWARD_PROGRESS_REPORT_KPI_SUMMARY T1 
			INNER JOIN AWARD_PROGRESS_REPORT T2 ON T2.PROGRESS_REPORT_ID = T1.ORGINATING_PROGRESS_REPORT_ID WHERE T1.PROGRESS_REPORT_ID = ks.PROGRESS_REPORT_ID 
			AND T1.KPI_CRITERIA_TYPE_CODE = ks.KPI_CRITERIA_TYPE_CODE GROUP BY T1.KPI_CRITERIA_TYPE_CODE) AS ACHIEVED_SUM,
			(SELECT DESCRIPTION FROM kpi_publication_status ps WHERE ps.PUBLICATION_STATUS_CODE = ip.PUBLICATION_STATUS_CODE) AS PUBLICATIONS_STATUS,
			ip.AUTHOR_NAME AS PUBLICATIONS_AUTHOR_NAMES,
			ip.TITLE_OF_ARTICLE AS PUBLICATIONS_TITLE_OF_ARTICLE,
			ip.JOURNAL_NAME AS PUBLICATIONS_JOURNAL_NAME,
			ip.PUBLISHER AS PUBLICATIONS_PUBLISHER,
			ip.YEAR AS PUBLICATIONS_YEAR_ISSUENO,
			ip.PAGE_NO AS PUBLICATIONS_PAGE_NO,
			ip.IMPACT_FACTOR AS PUBLICATIONS_IMPACT_FACTOR,
			ip.FUNDING_ACKNOWLEDGEMENT AS PUBLICATIONS_ACKNOWLEDGEMENT_FUNDING,
			ip.COMMENTS AS PUBLICATIONS_COMMENTS,
			ip.PUBLICATION_DATE AS PUBLICATIONS_PUBLICATION_DATE
	FROM    progress_report_kpi_impact_publications ip,
			award_progress_report_kpi_summary ks
	WHERE  ip.progress_report_id IN ( SELECT PROGRESS_REPORT_ID FROM TEMP_PR_MASTER_DATASET_RT)
	  AND  ks.KPI_SUMMARY_ID = ip.KPI_SUMMARY_ID
	  AND  ks.PROGRESS_REPORT_ID = ks.ORGINATING_PROGRESS_REPORT_ID
	);

	-- Collaboration projects
					  
	INSERT INTO PROG_RPT_KPI_RT
		(PROGRESS_REPORT_ID,
		KPI_SUMMARY_ID ,
		KPI_CATEGORY ,
		KPI_CRITERIA ,
		TARGET , 
		ACHIEVED_SUM ,
		COLLABORATION_PROJECT_TITLE,
		COLLABORATION_PROJECT_DESCRIPTION,
		COLLABORATION_PROJECT_START_DATE,
		COLLABORATION_PROJECT_END_DATE,
		COLLABORATION_NAME_OF_COLLABORATING_ORGANIZATION,
		COLLABORATION_COUNTRY,
		COLLABORATION_COMPANY_UEN,
		COLLABORATION_COMMENTS
	)
	(SELECT ks.PROGRESS_REPORT_ID, 
			ks.KPI_SUMMARY_ID,
			(SELECT kt.DESCRIPTION FROM KPI_TYPE kt WHERE kt.KPI_TYPE_CODE = ks.KPI_CATEGORY_TYPE_CODE LIMIT 1) AS KPI_CATEGORY,
			(SELECT kct.DESCRIPTION FROM KPI_CRITERIA_TYPE kct WHERE kct.KPI_CRITERIA_TYPE_CODE = ks.KPI_CRITERIA_TYPE_CODE LIMIT 1) AS KPI_CRITERIA,
			ks.TARGET,
			-- ks.ACHIEVED,
			(SELECT SUM(T1.ACHIEVED) FROM AWARD_PROGRESS_REPORT_KPI_SUMMARY T1 
			INNER JOIN AWARD_PROGRESS_REPORT T2 ON T2.PROGRESS_REPORT_ID = T1.ORGINATING_PROGRESS_REPORT_ID WHERE T1.PROGRESS_REPORT_ID = ks.PROGRESS_REPORT_ID 
			AND T1.KPI_CRITERIA_TYPE_CODE = ks.KPI_CRITERIA_TYPE_CODE GROUP BY T1.KPI_CRITERIA_TYPE_CODE) AS ACHIEVED_SUM,
			cp.PROJECT_TITLE AS COLLABORATION_PROJECT_TITLE,
			cp.PROJECT_DESCRIPTION AS COLLABORATION_PROJECT_DESCRIPTION,
			cp.PROJECT_START_DATE AS COLLABORATION_PROJECT_START_DATE,
			cp.PROJECT_END_DATE AS COLLABORATION_PROJECT_END_DATE,
			cp.COLLABORATING_ORGANIZATION AS COLLABORATION_NAME_OF_COLLABORATING_ORGANIZATION,
			(SELECT c.COUNTRY_NAME FROM COUNTRY c WHERE c.COUNTRY_CODE = cp.COUNTRY_CODE) AS COLLABORATION_COUNTRY,
			cp.COMPANY_UEN AS COLLABORATION_COMPANY_UEN,
			cp.COMMENTS AS COLLABORATION_COMMENTS
	FROM    progress_report_kpi_collaboration_projects cp,
			award_progress_report_kpi_summary ks
	WHERE   cp.progress_report_id IN ( SELECT PROGRESS_REPORT_ID FROM TEMP_PR_MASTER_DATASET_RT)
	  AND   ks.KPI_SUMMARY_ID = cp.KPI_SUMMARY_ID
	  AND   ks.PROGRESS_REPORT_ID = ks.ORGINATING_PROGRESS_REPORT_ID	 
	);				  

	-- Tech Disclosure
	INSERT INTO PROG_RPT_KPI_RT
		(PROGRESS_REPORT_ID,
		KPI_SUMMARY_ID ,
		KPI_CATEGORY ,
		KPI_CRITERIA ,
		TARGET , 
		ACHIEVED_SUM ,
		TECHNOLOGY_DISCLOSURES_STATUS,
		TECHNOLOGY_DISCLOSURES_AUTHOR_NAMES,
		TECHNOLOGY_DISCLOSURES_TITLE_PATENT,
		TECHNOLOGY_DISCLOSURES_COVERING_COUNTRIES,
		TECHNOLOGY_DISCLOSURES_FILING_OFFICE,
		TECHNOLOGY_DISCLOSURES_DATE_FILING,
		TECHNOLOGY_DISCLOSURES_DATE_AWARD,
		TECHNOLOGY_DISCLOSURES_COMMENTS
	)
	(SELECT ks.PROGRESS_REPORT_ID, 
			ks.KPI_SUMMARY_ID,
			(SELECT kt.DESCRIPTION FROM KPI_TYPE kt WHERE kt.KPI_TYPE_CODE = ks.KPI_CATEGORY_TYPE_CODE LIMIT 1) AS KPI_CATEGORY,
			(SELECT kct.DESCRIPTION FROM KPI_CRITERIA_TYPE kct WHERE kct.KPI_CRITERIA_TYPE_CODE = ks.KPI_CRITERIA_TYPE_CODE LIMIT 1) AS KPI_CRITERIA,
			ks.TARGET,
			-- ks.ACHIEVED,
			(SELECT SUM(T1.ACHIEVED) FROM AWARD_PROGRESS_REPORT_KPI_SUMMARY T1 
			INNER JOIN AWARD_PROGRESS_REPORT T2 ON T2.PROGRESS_REPORT_ID = T1.ORGINATING_PROGRESS_REPORT_ID WHERE T1.PROGRESS_REPORT_ID = ks.PROGRESS_REPORT_ID 
			AND T1.KPI_CRITERIA_TYPE_CODE = ks.KPI_CRITERIA_TYPE_CODE GROUP BY T1.KPI_CRITERIA_TYPE_CODE) AS ACHIEVED_SUM,
			(SELECT DESCRIPTION  FROM kpi_technology_disclosure_status ds WHERE ds.TECHNOLOGY_DISCLOSURE_STATUS_CODE = td.TECHNOLOGY_DISCLOSURE_STATUS_CODE) AS TECHNOLOGY_DISCLOSURES_STATUS,
			td.AUTHOR_NAME AS TECHNOLOGY_DISCLOSURES_AUTHOR_NAMES,
			td.TITLE_OF_PATENT AS TECHNOLOGY_DISCLOSURES_TITLE_PATENT,
			td.COVERING_COUNTRIES AS TECHNOLOGY_DISCLOSURES_COVERING_COUNTRIES,
			td.FILING_OFFICE AS TECHNOLOGY_DISCLOSURES_FILING_OFFICE,
			td.DATE_OF_FILING AS TECHNOLOGY_DISCLOSURES_DATE_FILING,
			td.DATE_OF_AWARD AS TECHNOLOGY_DISCLOSURES_DATE_AWARD,
			td.COMMENTS AS TECHNOLOGY_DISCLOSURES_COMMENTS
	FROM    progress_report_kpi_technology_disclosure td,
			award_progress_report_kpi_summary ks
	WHERE   td.progress_report_id IN ( SELECT PROGRESS_REPORT_ID FROM TEMP_PR_MASTER_DATASET_RT)
	  AND   ks.KPI_SUMMARY_ID = td.KPI_SUMMARY_ID
	  AND   ks.PROGRESS_REPORT_ID = ks.ORGINATING_PROGRESS_REPORT_ID
	);	

	-- Manpower dev
	INSERT INTO PROG_RPT_KPI_RT
			(PROGRESS_REPORT_ID,
			KPI_SUMMARY_ID ,
			KPI_CATEGORY ,
			KPI_CRITERIA,
			TARGET , 
			ACHIEVED_SUM ,
			MANPOWER_NAME_STUDENT,
			MANPOWER_CITIZENSHIP,
			MANPOWER_CURRENT_STATUS,
			MANPOWER_DATE_ENROLLED,
			MANPOWER_DATE_GRADUATED_RESIGNED,
			MANPOWER_DATE_JOINING_PROJECT,
			MANPOWER_DATE_LEAVING_PROJECT,
			MANPOWER_COMMENTS
	)
	(SELECT ks.PROGRESS_REPORT_ID, 
			ks.KPI_SUMMARY_ID,
			(SELECT kt.DESCRIPTION FROM KPI_TYPE kt WHERE kt.KPI_TYPE_CODE = ks.KPI_CATEGORY_TYPE_CODE LIMIT 1) AS KPI_CATEGORY,
			(SELECT kct.DESCRIPTION FROM KPI_CRITERIA_TYPE kct WHERE kct.KPI_CRITERIA_TYPE_CODE = ks.KPI_CRITERIA_TYPE_CODE LIMIT 1) AS KPI_CRITERIA,
			ks.TARGET,
			-- ks.ACHIEVED,
			(SELECT SUM(T1.ACHIEVED) FROM AWARD_PROGRESS_REPORT_KPI_SUMMARY T1 
			INNER JOIN AWARD_PROGRESS_REPORT T2 ON T2.PROGRESS_REPORT_ID = T1.ORGINATING_PROGRESS_REPORT_ID WHERE T1.PROGRESS_REPORT_ID = ks.PROGRESS_REPORT_ID 
			AND T1.KPI_CRITERIA_TYPE_CODE = ks.KPI_CRITERIA_TYPE_CODE GROUP BY T1.KPI_CRITERIA_TYPE_CODE) AS ACHIEVED_SUM,
			md.NAME_OF_STUDENT AS MANPOWER_NAME_STUDENT,
			md.CITIZENSHIP AS MANPOWER_CITIZENSHIP,
			(SELECT DESCRIPTION FROM kpi_manpower_development_current_status cs WHERE cs.CURRENT_STATUS_CODE = md.CURRENT_STATUS_CODE ) AS MANPOWER_CURRENT_STATUS,
			md.DATE_ENROLLED AS MANPOWER_DATE_ENROLLED,
			md.DATE_GRADUATED AS MANPOWER_DATE_GRADUATED_RESIGNED,
			md.DATE_OF_JOINING AS MANPOWER_DATE_JOINING_PROJECT,
			md.DATE_OF_LEAVING AS MANPOWER_DATE_LEAVING_PROJECT,
			md.COMMENTS AS MANPOWER_COMMENTS
	FROM    progress_report_kpi_manpower_development md,
			award_progress_report_kpi_summary ks
	WHERE md.progress_report_id IN ( SELECT PROGRESS_REPORT_ID FROM TEMP_PR_MASTER_DATASET_RT)
	  AND ks.KPI_SUMMARY_ID = md.KPI_SUMMARY_ID
	  AND ks.PROGRESS_REPORT_ID = ks.ORGINATING_PROGRESS_REPORT_ID
	);

	-- UG student
	INSERT INTO PROG_RPT_KPI_RT
			(PROGRESS_REPORT_ID,
			KPI_SUMMARY_ID ,
			KPI_CATEGORY ,
			KPI_CRITERIA,
			TARGET , 
			ACHIEVED_SUM ,
			UG_STUDENTS_NAME_STUDENT,
			UG_STUDENTS_CITIZENSHIP,
			UG_STUDENTS_CURRENT_STATUS,
			UG_STUDENTS_DATE_JOINING_PROJECT,
			UG_STUDENTS_DATE_LEAVING_PROJECT,
			UG_STUDENTS_COMMENTS
	)
	(SELECT ks.PROGRESS_REPORT_ID, 
			ks.KPI_SUMMARY_ID,
			(SELECT kt.DESCRIPTION FROM KPI_TYPE kt WHERE kt.KPI_TYPE_CODE = ks.KPI_CATEGORY_TYPE_CODE LIMIT 1) AS KPI_CATEGORY,
			(SELECT kct.DESCRIPTION FROM KPI_CRITERIA_TYPE kct WHERE kct.KPI_CRITERIA_TYPE_CODE = ks.KPI_CRITERIA_TYPE_CODE LIMIT 1) AS KPI_CRITERIA,
			ks.TARGET,
			-- ks.ACHIEVED,
			(SELECT SUM(T1.ACHIEVED) FROM AWARD_PROGRESS_REPORT_KPI_SUMMARY T1 
			INNER JOIN AWARD_PROGRESS_REPORT T2 ON T2.PROGRESS_REPORT_ID = T1.ORGINATING_PROGRESS_REPORT_ID WHERE T1.PROGRESS_REPORT_ID = ks.PROGRESS_REPORT_ID 
			AND T1.KPI_CRITERIA_TYPE_CODE = ks.KPI_CRITERIA_TYPE_CODE GROUP BY T1.KPI_CRITERIA_TYPE_CODE) AS ACHIEVED_SUM,
			ugs.NAME_OF_STUDENT AS UG_STUDENTS_NAME_STUDENT,
			ugs.CITIZENSHIP AS UG_STUDENTS_CITIZENSHIP,
			(SELECT DESCRIPTION FROM kpi_manpower_development_current_status cs WHERE cs.CURRENT_STATUS_CODE = ugs.CURRENT_STATUS_CODE )  AS UG_STUDENTS_CURRENT_STATUS,
			ugs.DATE_OF_JOINING AS UG_STUDENTS_DATE_JOINING_PROJECT,
			ugs.DATE_OF_LEAVING AS UG_STUDENTS_DATE_LEAVING_PROJECT,
			ugs.COMMENTS AS UG_STUDENTS_COMMENTS
	FROM    progress_report_kpi_undergraduate_student ugs,
			award_progress_report_kpi_summary ks
	WHERE ugs.progress_report_id IN ( SELECT PROGRESS_REPORT_ID FROM TEMP_PR_MASTER_DATASET_RT)
	  AND ks.KPI_SUMMARY_ID = ugs.KPI_SUMMARY_ID
	  AND ks.PROGRESS_REPORT_ID = ks.ORGINATING_PROGRESS_REPORT_ID
	   
	);

	-- Conference Presentation
	INSERT INTO PROG_RPT_KPI_RT
			(PROGRESS_REPORT_ID,
			KPI_SUMMARY_ID ,
			KPI_CATEGORY ,
			KPI_CRITERIA,
			TARGET , 
			ACHIEVED_SUM ,
			CONFERENCE_NAME_PRESENTER_RESEARCHER,
			CONFERENCE_TITLE,
			CONFERENCE_CONFERENCE_TITLE_AWARD_TITLE,
			CONFERENCE_ORGANISER,
			CONFERENCE_CONFERENCE_LOCATION_COUNTRY_STATE,
			CONFERENCE_DATE,
			CONFERENCE_COMMENTS
	)
	(SELECT ks.PROGRESS_REPORT_ID, 
			ks.KPI_SUMMARY_ID,
			(SELECT kt.DESCRIPTION FROM KPI_TYPE kt WHERE kt.KPI_TYPE_CODE = ks.KPI_CATEGORY_TYPE_CODE LIMIT 1) AS KPI_CATEGORY,
			(SELECT kct.DESCRIPTION FROM KPI_CRITERIA_TYPE kct WHERE kct.KPI_CRITERIA_TYPE_CODE = ks.KPI_CRITERIA_TYPE_CODE LIMIT 1) AS KPI_CRITERIA,
			ks.TARGET,
			-- ks.ACHIEVED,
			(SELECT SUM(T1.ACHIEVED) FROM AWARD_PROGRESS_REPORT_KPI_SUMMARY T1 
			INNER JOIN AWARD_PROGRESS_REPORT T2 ON T2.PROGRESS_REPORT_ID = T1.ORGINATING_PROGRESS_REPORT_ID WHERE T1.PROGRESS_REPORT_ID = ks.PROGRESS_REPORT_ID 
			AND T1.KPI_CRITERIA_TYPE_CODE = ks.KPI_CRITERIA_TYPE_CODE GROUP BY T1.KPI_CRITERIA_TYPE_CODE) AS ACHIEVED_SUM,
			cpt.NAME_OF_PRESENTER AS CONFERENCE_NAME_PRESENTER_RESEARCHER,
			cpt.TITLE AS CONFERENCE_TITLE,
			cpt.CONFERENCE_TITLE AS CONFERENCE_CONFERENCE_TITLE_AWARD_TITLE,
			cpt.ORGANISER AS CONFERENCE_ORGANISER,
			cpt.CONFERENCE_LOCATION AS CONFERENCE_CONFERENCE_LOCATION_COUNTRY_STATE,
			cpt.DATE AS CONFERENCE_DATE,
			cpt.COMMENTS AS CONFERENCE_COMMENTS
	FROM    progress_report_kpi_conference_presentation cpt,
			award_progress_report_kpi_summary ks
	WHERE   cpt.progress_report_id IN ( SELECT PROGRESS_REPORT_ID FROM TEMP_PR_MASTER_DATASET_RT)
	  AND   ks.KPI_SUMMARY_ID = cpt.KPI_SUMMARY_ID
	  AND	ks.PROGRESS_REPORT_ID = ks.ORGINATING_PROGRESS_REPORT_ID	    
	);

	-- Competitive Grants
	INSERT INTO PROG_RPT_KPI_RT
			(PROGRESS_REPORT_ID,
			KPI_SUMMARY_ID ,
			KPI_CATEGORY ,
			KPI_CRITERIA,
			TARGET , 
			ACHIEVED_SUM ,
			COMPETITIVE_GRANTS_NAME_GRANT_RECEIVED,
			COMPETITIVE_GRANTS_PROJECT_REFERENCE_NO,
			COMPETITIVE_GRANTS_FUNDING_AGENCY,
			COMPETITIVE_GRANTS_RECIPIENT_GRANT,
			COMPETITIVE_GRANTS_HOST_INSTITUTION,
			COMPETITIVE_GRANTS_DIRECT_COST,
			COMPETITIVE_GRANTS_INDIRECT_COST,
			COMPETITIVE_GRANTS_PROJECT_START_DATE,
			COMPETITIVE_GRANTS_PROJECT_END_DATE,
			COMPETITIVE_GRANTS_PROJECT_TITLE,
			COMPETITIVE_GRANTS_COMMENTS
	)
	(SELECT ks.PROGRESS_REPORT_ID, 
			ks.KPI_SUMMARY_ID,
			(SELECT kt.DESCRIPTION FROM KPI_TYPE kt WHERE kt.KPI_TYPE_CODE = ks.KPI_CATEGORY_TYPE_CODE LIMIT 1) AS KPI_CATEGORY,
			(SELECT kct.DESCRIPTION FROM KPI_CRITERIA_TYPE kct WHERE kct.KPI_CRITERIA_TYPE_CODE = ks.KPI_CRITERIA_TYPE_CODE LIMIT 1) AS KPI_CRITERIA,
			ks.TARGET,
			-- ks.ACHIEVED,
			(SELECT SUM(T1.ACHIEVED) FROM AWARD_PROGRESS_REPORT_KPI_SUMMARY T1 
			INNER JOIN AWARD_PROGRESS_REPORT T2 ON T2.PROGRESS_REPORT_ID = T1.ORGINATING_PROGRESS_REPORT_ID WHERE T1.PROGRESS_REPORT_ID = ks.PROGRESS_REPORT_ID 
			AND T1.KPI_CRITERIA_TYPE_CODE = ks.KPI_CRITERIA_TYPE_CODE GROUP BY T1.KPI_CRITERIA_TYPE_CODE) AS ACHIEVED_SUM,
			cg.NAME_OF_GRANT_RECEIVED AS COMPETITIVE_GRANTS_NAME_GRANT_RECEIVED,
			cg.PROJECT_REFERENCE_NO AS COMPETITIVE_GRANTS_PROJECT_REFERENCE_NO,
			(SELECT SPONSOR_NAME FROM sponsor s WHERE s.SPONSOR_CODE = cg.SPONSOR_CODE )  AS COMPETITIVE_GRANTS_FUNDING_AGENCY,
			cg.RECIPIENT_OF_GRANT AS COMPETITIVE_GRANTS_RECIPIENT_GRANT,
			cg.HOST_INSTITUTION AS COMPETITIVE_GRANTS_HOST_INSTITUTION,
			cg.DIRECT_COST AS COMPETITIVE_GRANTS_DIRECT_COST,
			cg.INDIRECT_COST AS COMPETITIVE_GRANTS_INDIRECT_COST,
			cg.PROJECT_START_DATE AS COMPETITIVE_GRANTS_PROJECT_START_DATE,
			cg.PROJECT_END_DATE AS COMPETITIVE_GRANTS_PROJECT_END_DATE,
			cg.PROJECT_TITLE AS COMPETITIVE_GRANTS_PROJECT_TITLE,
			cg.COMMENTS AS COMPETITIVE_GRANTS_COMMENTS
	FROM    progress_report_kpi_competitive_grants cg,
			award_progress_report_kpi_summary ks
	WHERE cg.progress_report_id IN ( SELECT PROGRESS_REPORT_ID FROM TEMP_PR_MASTER_DATASET_RT)
	  AND ks.KPI_SUMMARY_ID = cg.KPI_SUMMARY_ID
	  AND ks.PROGRESS_REPORT_ID = ks.ORGINATING_PROGRESS_REPORT_ID	   
	);

	-- Cash Funding
	INSERT INTO PROG_RPT_KPI_RT
			(PROGRESS_REPORT_ID,
			KPI_SUMMARY_ID ,
			KPI_CATEGORY ,
			KPI_CRITERIA,
			TARGET , 
			ACHIEVED_SUM ,
			CASH_FUNDING_NAME_COMPANY_CONTRIBUTING,
			CASH_FUNDING_COUNTRY_COMPANY,
			CASH_FUNDING_COMPANY_UEN,
			CASH_FUNDING_DATE_CONTRIBUTION,
			CASH_FUNDING_AMOUNT_CASH_FUNDING,
			CASH_FUNDING_COMMENTS
	)
	(SELECT ks.PROGRESS_REPORT_ID, 
			ks.KPI_SUMMARY_ID,
			(SELECT kt.DESCRIPTION FROM KPI_TYPE kt WHERE kt.KPI_TYPE_CODE = ks.KPI_CATEGORY_TYPE_CODE LIMIT 1) AS KPI_CATEGORY,
			(SELECT kct.DESCRIPTION FROM KPI_CRITERIA_TYPE kct WHERE kct.KPI_CRITERIA_TYPE_CODE = ks.KPI_CRITERIA_TYPE_CODE LIMIT 1) AS KPI_CRITERIA,
			ks.TARGET,
			-- ks.ACHIEVED,
			(SELECT SUM(T1.ACHIEVED) FROM AWARD_PROGRESS_REPORT_KPI_SUMMARY T1 
			INNER JOIN AWARD_PROGRESS_REPORT T2 ON T2.PROGRESS_REPORT_ID = T1.ORGINATING_PROGRESS_REPORT_ID WHERE T1.PROGRESS_REPORT_ID = ks.PROGRESS_REPORT_ID 
			AND T1.KPI_CRITERIA_TYPE_CODE = ks.KPI_CRITERIA_TYPE_CODE GROUP BY T1.KPI_CRITERIA_TYPE_CODE) AS ACHIEVED_SUM,
			cf.NAME_OF_COMPANY AS CASH_FUNDING_NAME_COMPANY_CONTRIBUTING,
			(SELECT c.COUNTRY_NAME FROM COUNTRY c WHERE c.COUNTRY_CODE = cf.COUNTRY_CODE)  AS CASH_FUNDING_COUNTRY_COMPANY,
			cf.COMPANY_UEN AS CASH_FUNDING_COMPANY_UEN,
			cf.DATE_OF_CONTRIBUTION AS CASH_FUNDING_DATE_CONTRIBUTION,
			cf.AMOUNT AS CASH_FUNDING_AMOUNT_CASH_FUNDING,
			cf.COMMENTS AS CASH_FUNDING_COMMENTS
	FROM    progress_report_kpi_cash_funding cf,
			award_progress_report_kpi_summary ks
	WHERE cf.progress_report_id IN ( SELECT PROGRESS_REPORT_ID FROM TEMP_PR_MASTER_DATASET_RT)
	  AND ks.KPI_SUMMARY_ID = cf.KPI_SUMMARY_ID
	  AND ks.PROGRESS_REPORT_ID = ks.ORGINATING_PROGRESS_REPORT_ID	   
	);

	-- In Kind Contributions
	INSERT INTO PROG_RPT_KPI_RT
			(PROGRESS_REPORT_ID,
			KPI_SUMMARY_ID ,
			KPI_CATEGORY ,
			KPI_CRITERIA,
			TARGET , 
			ACHIEVED_SUM ,
			IN_KIND_DATE_CONTRIBUTION,
			IN_KIND_NAME_COMPANY_CONTRIBUTING,
			IN_KIND_COUNTRY_COMPANY,
			IN_KIND_COMPANY_UEN,
			IN_KIND_AMOUNT_KIND_CONTRIBUTIONS,
			IN_KIND_COMMENTS
	)
	(SELECT ks.PROGRESS_REPORT_ID, 
			ks.KPI_SUMMARY_ID,
			(SELECT kt.DESCRIPTION FROM KPI_TYPE kt WHERE kt.KPI_TYPE_CODE = ks.KPI_CATEGORY_TYPE_CODE LIMIT 1) AS KPI_CATEGORY,
			(SELECT kct.DESCRIPTION FROM KPI_CRITERIA_TYPE kct WHERE kct.KPI_CRITERIA_TYPE_CODE = ks.KPI_CRITERIA_TYPE_CODE LIMIT 1) AS KPI_CRITERIA,
			ks.TARGET,
			-- ks.ACHIEVED,
			(SELECT SUM(T1.ACHIEVED) FROM AWARD_PROGRESS_REPORT_KPI_SUMMARY T1 
			INNER JOIN AWARD_PROGRESS_REPORT T2 ON T2.PROGRESS_REPORT_ID = T1.ORGINATING_PROGRESS_REPORT_ID WHERE T1.PROGRESS_REPORT_ID = ks.PROGRESS_REPORT_ID 
			AND T1.KPI_CRITERIA_TYPE_CODE = ks.KPI_CRITERIA_TYPE_CODE GROUP BY T1.KPI_CRITERIA_TYPE_CODE) AS ACHIEVED_SUM,
			ikc.DATE_OF_CONTRIBUTION AS IN_KIND_DATE_CONTRIBUTION,
			ikc.NAME_OF_COMPANY AS IN_KIND_NAME_COMPANY_CONTRIBUTING,
			(SELECT c.COUNTRY_NAME FROM COUNTRY c WHERE c.COUNTRY_CODE = ikc.COUNTRY_CODE)  AS IN_KIND_COUNTRY_COMPANY,
			ikc.COMPANY_UEN AS IN_KIND_COMPANY_UEN,
			ikc.AMOUNT AS IN_KIND_AMOUNT_KIND_CONTRIBUTIONS,
			ikc.COMMENTS AS IN_KIND_COMMENTS
	FROM    progress_report_kpi_inkind_contributions ikc,
			award_progress_report_kpi_summary ks
	WHERE ikc.progress_report_id IN ( SELECT PROGRESS_REPORT_ID FROM TEMP_PR_MASTER_DATASET_RT)
	  AND ks.KPI_SUMMARY_ID = ikc.KPI_SUMMARY_ID
	  AND ks.PROGRESS_REPORT_ID = ks.ORGINATING_PROGRESS_REPORT_ID	   
	);

	-- Tech deployed
	INSERT INTO PROG_RPT_KPI_RT
			(PROGRESS_REPORT_ID,
			KPI_SUMMARY_ID ,
			KPI_CATEGORY ,
			KPI_CRITERIA,
			TARGET , 
			ACHIEVED_SUM ,
			TECHNOLOGIES_DEPLOYED_DATE_DEPLOYING,
			TECHNOLOGIES_DEPLOYED_NAME_COMPANY_DEPLOYING,
			TECHNOLOGIES_DEPLOYED_COUNTRY_COMPANY,
			TECHNOLOGIES_DEPLOYED_COMPANY_UEN,
			TECHNOLOGIES_DEPLOYED_DETAILS,
			TECHNOLOGIES_DEPLOYED_COMMENTS
	)
	(SELECT ks.PROGRESS_REPORT_ID, 
			ks.KPI_SUMMARY_ID,
			(SELECT kt.DESCRIPTION FROM KPI_TYPE kt WHERE kt.KPI_TYPE_CODE = ks.KPI_CATEGORY_TYPE_CODE LIMIT 1) AS KPI_CATEGORY,
			(SELECT kct.DESCRIPTION FROM KPI_CRITERIA_TYPE kct WHERE kct.KPI_CRITERIA_TYPE_CODE = ks.KPI_CRITERIA_TYPE_CODE LIMIT 1) AS KPI_CRITERIA,
			ks.TARGET,
			-- ks.ACHIEVED,
			(SELECT SUM(T1.ACHIEVED) FROM AWARD_PROGRESS_REPORT_KPI_SUMMARY T1 
			INNER JOIN AWARD_PROGRESS_REPORT T2 ON T2.PROGRESS_REPORT_ID = T1.ORGINATING_PROGRESS_REPORT_ID WHERE T1.PROGRESS_REPORT_ID = ks.PROGRESS_REPORT_ID 
			AND T1.KPI_CRITERIA_TYPE_CODE = ks.KPI_CRITERIA_TYPE_CODE GROUP BY T1.KPI_CRITERIA_TYPE_CODE) AS ACHIEVED_SUM,
			td.DATE_OF_DEPLOYING AS TECHNOLOGIES_DEPLOYED_DATE_DEPLOYING,
			td.NAME_OF_COMPANY AS TECHNOLOGIES_DEPLOYED_NAME_COMPANY_DEPLOYING,
			(SELECT c.COUNTRY_NAME FROM COUNTRY c WHERE c.COUNTRY_CODE = td.COUNTRY_CODE) AS TECHNOLOGIES_DEPLOYED_COUNTRY_COMPANY,
			td.COMPANY_UEN AS TECHNOLOGIES_DEPLOYED_COMPANY_UEN,
			td.DETAILS_OF_TECHNOLOGIES AS TECHNOLOGIES_DEPLOYED_DETAILS,
			td.COMMENTS AS TECHNOLOGIES_DEPLOYED_COMMENTS
	FROM    progress_report_kpi_technologies_deployed td,
			award_progress_report_kpi_summary ks
	WHERE td.progress_report_id IN ( SELECT PROGRESS_REPORT_ID FROM TEMP_PR_MASTER_DATASET_RT)
	  AND ks.KPI_SUMMARY_ID = td.KPI_SUMMARY_ID
	  AND ks.PROGRESS_REPORT_ID = ks.ORGINATING_PROGRESS_REPORT_ID	   
	);

	-- Patents
	INSERT INTO PROG_RPT_KPI_RT
			(PROGRESS_REPORT_ID,
			KPI_SUMMARY_ID ,
			KPI_CATEGORY ,
			KPI_CRITERIA,
			TARGET , 
			ACHIEVED_SUM ,
			PATENTS_DATE_FILED,
			PATENTS_DATE_GRANTED,
			PATENTS_TITLE,
			PATENTS_DESCRIPTION,
			PATENTS_OWNERSHIP,
			PATENTS_PATENT_NUMBER,
			PATENTS_COMMENTS
	)
	(SELECT ks.PROGRESS_REPORT_ID, 
			ks.KPI_SUMMARY_ID,
			(SELECT kt.DESCRIPTION FROM KPI_TYPE kt WHERE kt.KPI_TYPE_CODE = ks.KPI_CATEGORY_TYPE_CODE LIMIT 1) AS KPI_CATEGORY,
			(SELECT kct.DESCRIPTION FROM KPI_CRITERIA_TYPE kct WHERE kct.KPI_CRITERIA_TYPE_CODE = ks.KPI_CRITERIA_TYPE_CODE LIMIT 1) AS KPI_CRITERIA,
			ks.TARGET,
			-- ks.ACHIEVED,
			(SELECT SUM(T1.ACHIEVED) FROM AWARD_PROGRESS_REPORT_KPI_SUMMARY T1 
			INNER JOIN AWARD_PROGRESS_REPORT T2 ON T2.PROGRESS_REPORT_ID = T1.ORGINATING_PROGRESS_REPORT_ID WHERE T1.PROGRESS_REPORT_ID = ks.PROGRESS_REPORT_ID 
			AND T1.KPI_CRITERIA_TYPE_CODE = ks.KPI_CRITERIA_TYPE_CODE GROUP BY T1.KPI_CRITERIA_TYPE_CODE) AS ACHIEVED_SUM,
			p.DATE_FILED AS PATENTS_DATE_FILED,
			p.DATE_GRANTED AS PATENTS_DATE_GRANTED,
			p.TITLE AS PATENTS_TITLE,
			p.DESCRIPTION AS PATENTS_DESCRIPTION,
			p.OWNERSHIP AS PATENTS_OWNERSHIP,
			p.PATENT_NUMBER AS PATENTS_PATENT_NUMBER,
			p.COMMENTS AS PATENTS_COMMENTS
	FROM    progress_report_kpi_patents p,
			award_progress_report_kpi_summary ks
	WHERE p.progress_report_id IN ( SELECT PROGRESS_REPORT_ID FROM TEMP_PR_MASTER_DATASET_RT)
	  AND ks.KPI_SUMMARY_ID = p.KPI_SUMMARY_ID
	  AND ks.PROGRESS_REPORT_ID = ks.ORGINATING_PROGRESS_REPORT_ID   
	);

	-- Licenses
	INSERT INTO PROG_RPT_KPI_RT
			(PROGRESS_REPORT_ID,
			KPI_SUMMARY_ID ,
			KPI_CATEGORY ,
			KPI_CRITERIA,
			TARGET , 
			ACHIEVED_SUM ,
			LICENSES_START_DATE_LICENSING,
			LICENSES_NAME_LICENSEE_ASSIGNEE,
			LICENSES_COMPANY_UEN,
			LICENSES_LICENSING_PERIOD,
			LICENSES_DETAILS_IP_LICENSED,
			LICENSES_COMMENTS
	)
	(SELECT ks.PROGRESS_REPORT_ID, 
			ks.KPI_SUMMARY_ID,
			(SELECT kt.DESCRIPTION FROM KPI_TYPE kt WHERE kt.KPI_TYPE_CODE = ks.KPI_CATEGORY_TYPE_CODE LIMIT 1) AS KPI_CATEGORY,
			(SELECT kct.DESCRIPTION FROM KPI_CRITERIA_TYPE kct WHERE kct.KPI_CRITERIA_TYPE_CODE = ks.KPI_CRITERIA_TYPE_CODE LIMIT 1) AS KPI_CRITERIA,
			ks.TARGET,
			-- ks.ACHIEVED,
			(SELECT SUM(T1.ACHIEVED) FROM AWARD_PROGRESS_REPORT_KPI_SUMMARY T1 
			INNER JOIN AWARD_PROGRESS_REPORT T2 ON T2.PROGRESS_REPORT_ID = T1.ORGINATING_PROGRESS_REPORT_ID WHERE T1.PROGRESS_REPORT_ID = ks.PROGRESS_REPORT_ID 
			AND T1.KPI_CRITERIA_TYPE_CODE = ks.KPI_CRITERIA_TYPE_CODE GROUP BY T1.KPI_CRITERIA_TYPE_CODE) AS ACHIEVED_SUM,
			l.START_DATE AS LICENSES_START_DATE_LICENSING,
			l.NAME_OF_LICENSE AS LICENSES_NAME_LICENSEE_ASSIGNEE,
			l.COMPANY_UEN AS LICENSES_COMPANY_UEN,
			l.LICENSING_PERIOD AS LICENSES_LICENSING_PERIOD,
			l.DETAILS_OF_LICENSE AS LICENSES_DETAILS_IP_LICENSED,
			l.COMMENTS AS LICENSES_COMMENTS
	FROM    progress_report_kpi_licenses l,
			award_progress_report_kpi_summary ks
	WHERE  l.progress_report_id IN ( SELECT PROGRESS_REPORT_ID FROM TEMP_PR_MASTER_DATASET_RT)
	  AND  ks.KPI_SUMMARY_ID = l.KPI_SUMMARY_ID
	  AND  ks.PROGRESS_REPORT_ID = ks.ORGINATING_PROGRESS_REPORT_ID	  
	);

	-- Startups
	INSERT INTO PROG_RPT_KPI_RT
			(PROGRESS_REPORT_ID,
			KPI_SUMMARY_ID ,
			KPI_CATEGORY ,
			KPI_CRITERIA,
			TARGET , 
			ACHIEVED_SUM ,
			START_UPS_DATE_ESTABLISHMENT,
			START_UPS_DATE_ESTABLISHED,
			START_UPS_NAME_COMPANY,
			START_UPS_COMPANY_UEN,
			START_UPS_EXTERNAL_FUNDING_CRITERIA,
			START_UPS_VALUATION_CRITERIA,
			START_UPS_ANNUAL_REVENUE_CRITERIA,
			START_UPS_COMMENTS
	)
	(SELECT ks.PROGRESS_REPORT_ID, 
			ks.KPI_SUMMARY_ID,
			(SELECT kt.DESCRIPTION FROM KPI_TYPE kt WHERE kt.KPI_TYPE_CODE = ks.KPI_CATEGORY_TYPE_CODE LIMIT 1) AS KPI_CATEGORY,
			(SELECT kct.DESCRIPTION FROM KPI_CRITERIA_TYPE kct WHERE kct.KPI_CRITERIA_TYPE_CODE = ks.KPI_CRITERIA_TYPE_CODE LIMIT 1) AS KPI_CRITERIA,
			ks.TARGET,
			-- ks.ACHIEVED,
			(SELECT SUM(T1.ACHIEVED) FROM AWARD_PROGRESS_REPORT_KPI_SUMMARY T1 
			INNER JOIN AWARD_PROGRESS_REPORT T2 ON T2.PROGRESS_REPORT_ID = T1.ORGINATING_PROGRESS_REPORT_ID WHERE T1.PROGRESS_REPORT_ID = ks.PROGRESS_REPORT_ID 
			AND T1.KPI_CRITERIA_TYPE_CODE = ks.KPI_CRITERIA_TYPE_CODE GROUP BY T1.KPI_CRITERIA_TYPE_CODE) AS ACHIEVED_SUM,
			ss.DATE_OF_ESTABLISHMENT AS START_UPS_DATE_ESTABLISHMENT,
			ss.DATE_ESTABLISHED AS START_UPS_DATE_ESTABLISHED,
			ss.NAME_OF_COMPANY AS START_UPS_NAME_COMPANY,
			ss.COMPANY_UEN AS START_UPS_COMPANY_UEN,
			ss.EXTERNAL_FUNDING_CRITERIA AS START_UPS_EXTERNAL_FUNDING_CRITERIA,
			ss.VALUATION_CRITERIA AS START_UPS_VALUATION_CRITERIA,
			ss.ANNUAL_REVENUE_CRITERIA AS START_UPS_ANNUAL_REVENUE_CRITERIA,
			ss.COMMENTS AS START_UPS_COMMENTS
	FROM    progress_report_kpi_successful_startups ss,
			award_progress_report_kpi_summary ks
	WHERE ss.progress_report_id IN ( SELECT PROGRESS_REPORT_ID FROM TEMP_PR_MASTER_DATASET_RT)
	  AND ks.KPI_SUMMARY_ID = ss.KPI_SUMMARY_ID
	  AND ks.PROGRESS_REPORT_ID = ks.ORGINATING_PROGRESS_REPORT_ID	   
	);

	-- Health specific outcome
	INSERT INTO PROG_RPT_KPI_RT
			(PROGRESS_REPORT_ID,
			KPI_SUMMARY_ID ,
			KPI_CATEGORY ,
			KPI_CRITERIA,
			TARGET , 
			ACHIEVED_SUM ,
			HEALTH_SPECIFIC_DATE,
			HEALTH_SPECIFIC_NUMBER_YEARS_SAVED,
			HEALTH_SPECIFIC_DESCRIPTION_TITLE,
			HEALTH_SPECIFIC_REMARKS
	)
	(SELECT ks.PROGRESS_REPORT_ID, 
			ks.KPI_SUMMARY_ID,
			(SELECT kt.DESCRIPTION FROM KPI_TYPE kt WHERE kt.KPI_TYPE_CODE = ks.KPI_CATEGORY_TYPE_CODE LIMIT 1) AS KPI_CATEGORY,
			(SELECT kct.DESCRIPTION FROM KPI_CRITERIA_TYPE kct WHERE kct.KPI_CRITERIA_TYPE_CODE = ks.KPI_CRITERIA_TYPE_CODE LIMIT 1) AS KPI_CRITERIA,
			ks.TARGET,
			-- ks.ACHIEVED,
			(SELECT SUM(T1.ACHIEVED) FROM AWARD_PROGRESS_REPORT_KPI_SUMMARY T1 
			INNER JOIN AWARD_PROGRESS_REPORT T2 ON T2.PROGRESS_REPORT_ID = T1.ORGINATING_PROGRESS_REPORT_ID WHERE T1.PROGRESS_REPORT_ID = ks.PROGRESS_REPORT_ID 
			AND T1.KPI_CRITERIA_TYPE_CODE = ks.KPI_CRITERIA_TYPE_CODE GROUP BY T1.KPI_CRITERIA_TYPE_CODE) AS ACHIEVED_SUM,
			hso.DATE_ESTABLISHED AS HEALTH_SPECIFIC_DATE,
			hso.NUMBER_OF_LIFE_YEARS AS HEALTH_SPECIFIC_NUMBER_YEARS_SAVED,
			hso.TITLE AS HEALTH_SPECIFIC_DESCRIPTION_TITLE,
			hso.COMMENTS AS HEALTH_SPECIFIC_REMARKS
	FROM    progress_report_kpi_health_specific_outcomes hso,
			award_progress_report_kpi_summary ks
	WHERE hso.progress_report_id IN ( SELECT PROGRESS_REPORT_ID FROM TEMP_PR_MASTER_DATASET_RT)
	  AND ks.KPI_SUMMARY_ID = hso.KPI_SUMMARY_ID
	  AND ks.PROGRESS_REPORT_ID = ks.ORGINATING_PROGRESS_REPORT_ID	   
	);

	-- Post docs
	INSERT INTO PROG_RPT_KPI_RT
			(PROGRESS_REPORT_ID,
			KPI_SUMMARY_ID ,
			KPI_CATEGORY ,
			KPI_CRITERIA,
			TARGET , 
			ACHIEVED_SUM ,
			POST_DOCS_EMPLOYMENT_START_DATE,
			POST_DOCS_NAME,
			POST_DOCS_NATIONALITY,
			POST_DOCS_PERMANENT_RESIDENCE,
			POST_DOCS_NRIC_FIN,
			POST_DOCS_COMMENTS
	)
	(SELECT ks.PROGRESS_REPORT_ID, 
			ks.KPI_SUMMARY_ID,
			(SELECT kt.DESCRIPTION FROM KPI_TYPE kt WHERE kt.KPI_TYPE_CODE = ks.KPI_CATEGORY_TYPE_CODE LIMIT 1) AS KPI_CATEGORY,
			(SELECT kct.DESCRIPTION FROM KPI_CRITERIA_TYPE kct WHERE kct.KPI_CRITERIA_TYPE_CODE = ks.KPI_CRITERIA_TYPE_CODE LIMIT 1) AS KPI_CRITERIA,
			ks.TARGET,
			-- ks.ACHIEVED,
			(SELECT SUM(T1.ACHIEVED) FROM AWARD_PROGRESS_REPORT_KPI_SUMMARY T1 
			INNER JOIN AWARD_PROGRESS_REPORT T2 ON T2.PROGRESS_REPORT_ID = T1.ORGINATING_PROGRESS_REPORT_ID WHERE T1.PROGRESS_REPORT_ID = ks.PROGRESS_REPORT_ID 
			AND T1.KPI_CRITERIA_TYPE_CODE = ks.KPI_CRITERIA_TYPE_CODE GROUP BY T1.KPI_CRITERIA_TYPE_CODE) AS ACHIEVED_SUM,
			pde.EMPLOYMENT_START_DATE AS POST_DOCS_EMPLOYMENT_START_DATE,
			pde.EMPLOYEE_NAME AS POST_DOCS_NAME,
			pde.NATIONALITY AS POST_DOCS_NATIONALITY,
			pde.PERMANENT_RESIDENCE AS POST_DOCS_PERMANENT_RESIDENCE,
			pde.IDENTIFICATION_NUMBER AS POST_DOCS_NRIC_FIN,
			pde.COMMENTS AS POST_DOCS_COMMENTS
	FROM    progress_report_kpi_post_docs_employed pde,
			award_progress_report_kpi_summary ks
	WHERE  pde.progress_report_id IN ( SELECT PROGRESS_REPORT_ID FROM TEMP_PR_MASTER_DATASET_RT)
	  AND  ks.KPI_SUMMARY_ID = pde.KPI_SUMMARY_ID
	  AND  ks.PROGRESS_REPORT_ID = ks.ORGINATING_PROGRESS_REPORT_ID	   
	);

	-- Milestone
	INSERT INTO PROG_RPT_MILESTONES_RT
	(
		PROGRESS_REPORT_ID, 
		MILESTONE,
		MILESTONE_STATUS,	
		ACTUAL_START_MONTH,
		ACTUAL_END_MONTH, 
		START_DATE,
		END_DATE,
		REMARK	
	)
	(
		SELECT 	pgm.PROGRESS_REPORT_ID AS progress_report_id,
				pgm.MILESTONE AS MILESTONE,
				(SELECT ms.DESCRIPTION FROM MILESTONE_STATUS ms WHERE ms.MILESTONE_STATUS_CODE = pgm.MILESTONE_STATUS_CODE )AS DESCRIPTION,
				pgm.ACTUAL_START_MONTH AS ACTUAL_START_MONTH,
				pgm.ACTUAL_END_MONTH AS ACTUAL_END_MONTH,
				pgm.START_DATE AS START_DATE,
				pgm.END_DATE AS END_DATE,
				pgm.REMARK AS REMARK	
		 FROM   AWARD_PROGRESS_REPORT_MILESTONE pgm
		WHERE pgm.PROGRESS_REPORT_ID IN ( SELECT PROGRESS_REPORT_ID FROM TEMP_PR_MASTER_DATASET_RT)
	);

	DELETE FROM PROG_RPT_HDR_RT
	WHERE PROGRESS_REPORT_ID NOT IN (SELECT PROGRESS_REPORT_ID FROM AWARD_PROGRESS_REPORT);
	
	DELETE FROM PROG_RPT_KPI_RT
	WHERE PROGRESS_REPORT_ID NOT IN (SELECT PROGRESS_REPORT_ID FROM AWARD_PROGRESS_REPORT);
	
	DELETE FROM PROG_RPT_MILESTONES_RT
	WHERE PROGRESS_REPORT_ID NOT IN (SELECT PROGRESS_REPORT_ID FROM AWARD_PROGRESS_REPORT);
    
	-- DELETE DATA WHERE AWARD_ID NOT IN AWARD TABLE 
	
	DELETE FROM PROG_RPT_HDR_RT WHERE PROGRESS_REPORT_ID IN 
	(SELECT PROGRESS_REPORT_ID FROM AWARD_PROGRESS_REPORT WHERE AWARD_ID NOT IN (SELECT AWARD_ID FROM AWARD));
	
	DELETE FROM PROG_RPT_KPI_RT WHERE PROGRESS_REPORT_ID IN 
	(SELECT PROGRESS_REPORT_ID FROM AWARD_PROGRESS_REPORT WHERE AWARD_ID NOT IN (SELECT AWARD_ID FROM AWARD));
	
	DELETE FROM PROG_RPT_MILESTONES_RT WHERE PROGRESS_REPORT_ID IN 
	(SELECT PROGRESS_REPORT_ID FROM AWARD_PROGRESS_REPORT WHERE AWARD_ID NOT IN (SELECT AWARD_ID FROM AWARD));
	
	

	UPDATE REPORT_LAST_SYNC_TIME SET PR_LAST_SYNC_TIMESTAMP = LD_CURRENT_TIMESTAMP;
    
	IF LS_ERR_FLG = 'N' THEN
	   COMMIT;
	END IF;
	SET AUTOCOMMIT = 1;
	SET SQL_SAFE_UPDATES = 1;
	SELECT 'PR_MASTER_DATASET_SYNC executed successfully' AS SUCCESS FROM DUAL;
END;
END
