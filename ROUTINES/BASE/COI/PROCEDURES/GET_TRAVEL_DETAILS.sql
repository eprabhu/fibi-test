


CREATE PROCEDURE `GET_TRAVEL_DETAILS`(
AV_COLUMN_NAMES           	VARCHAR(4000),
AV_MODULE_ITEM_KEY         	INT,
AV_SUB_MODULE_ITEM_KEY      INT
)
BEGIN

DECLARE LS_DYN_SQL 					LONGTEXT;
DECLARE LS_DYN_JOINS				LONGTEXT;
DECLARE LS_DYN_CONDITIONS			LONGTEXT;
DECLARE LS_DYN_SELECT_COLUMNS		LONGTEXT;

SET LS_DYN_SQL = CONCAT('SELECT ', AV_COLUMN_NAMES, ' FROM
	(
	    SELECT
               T1.ADMIN_GROUP_ID,
               T1.ADMIN_PERSON_ID,
               T1.CERTIFICATION_TEXT,
               DATE_FORMAT(T1.CERTIFIED_AT, ''%m-%d-%Y %H:%i:%s'') AS CERTIFICATION_DATE,
               T1.CERTIFIED_BY,
               T1.CREATE_TIMESTAMP,
               T1.CREATED_BY,
               T1.DOCUMENT_STATUS_CODE,
               T1.ENTITY_ID,
               T1.ENTITY_NUMBER,
               T1.EXPIRATION_DATE,
               T1.FUNDING_TYPE_CODE,
               T1.HOME_UNIT AS DEPARTMENT_NUMBER,
               T1.PERSON_ENTITY_ID,
               T1.PERSON_ENTITY_NUMBER,
               T1.PERSON_ID,
               T1.PURPOSE_OF_THE_TRIP,
               T1.REVIEW_STATUS_CODE,
               T1.SUBMISSION_DATE,
               T1.TRAVEL_DISCLOSURE_ID,
               T1.TRAVEL_NUMBER,
               T1.TRAVEL_TITLE,
               T1.UPDATE_TIMESTAMP,
               T1.UPDATED_BY,
               T1.VERSION_NUMBER,
               T1.VERSION_STATUS,
               T7.FULL_NAME AS REPORTER_NAME,
               T2.PRIMARY_NAME AS ENTITY_NAME,
               T9.UNIT_NAME AS DEPARTMENT_NAME,
               DATE_FORMAT(MIN(T10.STAY_START_DATE), ''%m-%d-%Y'') AS TRAVEL_START_DATE,
               DATE_FORMAT(MAX(T10.STAY_END_DATE), ''%m-%d-%Y'') AS TRAVEL_END_DATE
               FROM COI_TRAVEL_DISCLOSURE T1
               LEFT JOIN PERSON_ENTITY T8 ON T8.PERSON_ENTITY_ID = T1.PERSON_ENTITY_ID
               LEFT JOIN ENTITY T2 ON T2.ENTITY_ID=T8.ENTITY_ID
               LEFT JOIN COI_TRAVEL_REVIEW_STATUS T3 ON T3.REVIEW_STATUS_CODE=T1.REVIEW_STATUS_CODE
               LEFT JOIN UNIT T5 ON T5.UNIT_NUMBER = T1.HOME_UNIT
               LEFT JOIN COI_TRAVEL_DOCUMENT_STATUS_TYPE T32 ON T32.DOCUMENT_STATUS_CODE = T1.DOCUMENT_STATUS_CODE
               INNER JOIN PERSON T7 ON T7.PERSON_ID=T1.PERSON_ID
               INNER JOIN UNIT T9 ON T9.UNIT_NUMBER = T1.HOME_UNIT
               LEFT JOIN COI_TRAVEL_DESTINATIONS T10 ON T10.TRAVEL_DISCLOSURE_ID = T1.TRAVEL_DISCLOSURE_ID
               WHERE T1.TRAVEL_DISCLOSURE_ID = ', AV_MODULE_ITEM_KEY, '

	)T');

	SET @QUERY_STATEMENT = LS_DYN_SQL;
    PREPARE EXECUTABLE_STAEMENT FROM @QUERY_STATEMENT;
    EXECUTE EXECUTABLE_STAEMENT;

END