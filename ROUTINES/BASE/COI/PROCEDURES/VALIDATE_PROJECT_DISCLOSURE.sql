

CREATE PROCEDURE `VALIDATE_PROJECT_DISCLOSURE`(
    AV_PERSON_ID varchar(40),
    AV_MODULE_CODE int(3),
    AV_MODULE_ITEM_KEY varchar(40)
)
BEGIN

DECLARE LS_COUNT INT(3);
DECLARE LS_DISCL_VALIDATION_FLAG VARCHAR(200);

        IF AV_MODULE_CODE IS NOT NULL AND AV_MODULE_ITEM_KEY IS NOT NULL THEN

			IF AV_MODULE_CODE = 1 THEN
				
				SELECT DISCLOSURE_VALIDATION_FLAG INTO LS_DISCL_VALIDATION_FLAG FROM COI_INT_STAGE_AWARD T1 WHERE T1.PROJECT_NUMBER = AV_MODULE_ITEM_KEY;
								
				IF LS_DISCL_VALIDATION_FLAG = 'SELF' THEN 
				
					SELECT COUNT(COI_DISCL_PROJECTS_ID) INTO LS_COUNT
					FROM COI_DISCL_PROJECTS T5 
					INNER JOIN COI_DISCLOSURE T6 ON T6.DISCLOSURE_ID = T5.DISCLOSURE_ID
					WHERE T6.VERSION_STATUS IN ('ACTIVE', 'PENDING')
					AND T6.PERSON_ID = AV_PERSON_ID
					AND T5.MODULE_ITEM_KEY = AV_MODULE_ITEM_KEY
					AND t6.FCOI_TYPE_CODE = 2
					AND t6.DISPOSITION_STATUS_CODE != 2;
					
					IF LS_COUNT > 0 THEN
				
						SELECT 
						(CASE WHEN t6.EXPIRATION_DATE > CURDATE() THEN false ELSE true END) AS isExpired,
						t6.DISCLOSURE_ID AS projectDisclosure,
						NULL AS fcoiDisclosure
						FROM COI_DISCL_PROJECTS T5 
						INNER JOIN COI_DISCLOSURE T6 ON T6.DISCLOSURE_ID = T5.DISCLOSURE_ID
						WHERE T6.VERSION_STATUS IN ('ACTIVE', 'PENDING')
						AND T6.PERSON_ID = AV_PERSON_ID
						AND T5.MODULE_ITEM_KEY = AV_MODULE_ITEM_KEY
						AND t6.FCOI_TYPE_CODE = 2
						AND t6.DISPOSITION_STATUS_CODE != 2;
					ELSE
					-- not exists then check for any intial or revision exists
						SELECT
						(CASE WHEN t1.EXPIRATION_DATE > CURDATE() THEN false ELSE true END) AS isExpired,
						NULL AS projectDisclosure,
						t1.DISCLOSURE_ID AS fcoiDisclosure
						FROM COI_DISCLOSURE t1
						WHERE t1.PERSON_ID = AV_PERSON_ID
						AND (t1.VERSION_STATUS = 'PENDING' OR t1.VERSION_STATUS = 'ACTIVE')
						AND t1.FCOI_TYPE_CODE IN (1, 3)

						AND T1.REVIEW_STATUS_CODE  IN (1,5,6);
					END IF;
					
				ELSEIF LS_DISCL_VALIDATION_FLAG IS NULL OR LS_DISCL_VALIDATION_FLAG = 'HIERARCHY' THEN
	
					-- Checks any award disclosure exists in hierarchy
					SELECT COUNT(COI_DISCL_PROJECTS_ID) INTO LS_COUNT
						FROM COI_DISCL_PROJECTS T5 
						INNER JOIN COI_DISCLOSURE T6 ON T6.DISCLOSURE_ID = T5.DISCLOSURE_ID
						INNER JOIN COI_INT_STAGE_AWARD AW1 ON AW1.PROJECT_NUMBER = T5.MODULE_ITEM_KEY
						INNER JOIN COI_INT_STAGE_AWARD AW2 ON AW2.ROOT_PROJECT_NUMBER = AW1.ROOT_PROJECT_NUMBER
						AND AW2.PROJECT_NUMBER = AV_MODULE_ITEM_KEY
						WHERE T6.VERSION_STATUS IN ('ACTIVE', 'PENDING')
						AND T6.PERSON_ID = AV_PERSON_ID
						AND t6.DISPOSITION_STATUS_CODE != 2
						AND t6.FCOI_TYPE_CODE = 2 ORDER BY AW1.PROJECT_NUMBER;
						
					IF LS_COUNT > 0 THEN
					
						SELECT 
						(CASE WHEN t6.EXPIRATION_DATE > CURDATE() THEN false ELSE true END) AS isExpired,
						t6.DISCLOSURE_ID AS projectDisclosure,
						NULL AS fcoiDisclosure
						FROM COI_DISCL_PROJECTS T5 
						INNER JOIN COI_DISCLOSURE T6 ON T6.DISCLOSURE_ID = T5.DISCLOSURE_ID
						INNER JOIN COI_INT_STAGE_AWARD AW1 ON AW1.PROJECT_NUMBER = T5.MODULE_ITEM_KEY
						INNER JOIN COI_INT_STAGE_AWARD AW2 ON AW2.ROOT_PROJECT_NUMBER = AW1.ROOT_PROJECT_NUMBER
						AND AW2.PROJECT_NUMBER = AV_MODULE_ITEM_KEY
						WHERE T6.VERSION_STATUS IN ('ACTIVE', 'PENDING')
						AND T6.PERSON_ID = AV_PERSON_ID
						AND T6.DISPOSITION_STATUS_CODE != 2
						AND t6.FCOI_TYPE_CODE = 2 ORDER BY AW1.PROJECT_NUMBER LIMIT 1;  -- return the topmost award in hierarchy
					ELSE
					-- not exists then check for any intial or revision exists
						SELECT
						(CASE WHEN t1.EXPIRATION_DATE > CURDATE() THEN false ELSE true END) AS isExpired,
						NULL AS projectDisclosure,
						t1.DISCLOSURE_ID AS fcoiDisclosure
						FROM COI_DISCLOSURE t1
						WHERE t1.PERSON_ID = AV_PERSON_ID
						AND (t1.VERSION_STATUS = 'PENDING' OR t1.VERSION_STATUS = 'ACTIVE')
						AND t1.FCOI_TYPE_CODE IN (1, 3)
						AND T1.REVIEW_STATUS_CODE  IN (1,5,6);
					END IF;
									
				END IF;
				
				
			ELSE
			
				SELECT
                (CASE WHEN t1.EXPIRATION_DATE > CURDATE() THEN false ELSE true END) AS isExpired,
                t1.DISCLOSURE_ID AS projectDisclosure,
                NULL AS fcoiDisclosure
            FROM COI_DISCLOSURE t1
            INNER JOIN COI_DISCL_PROJECTS t2
                ON t2.DISCLOSURE_ID = t1.DISCLOSURE_ID
            WHERE
                t2.MODULE_CODE = AV_MODULE_CODE
                AND t2.MODULE_ITEM_KEY = AV_MODULE_ITEM_KEY
                AND t1.PERSON_ID = AV_PERSON_ID
                AND t1.VERSION_STATUS = 'PENDING'
				AND t1.DISPOSITION_STATUS_CODE != 2
                AND t1.FCOI_TYPE_CODE = 2;
			
			END IF;
            

        ELSE
            SELECT
                (CASE WHEN t1.EXPIRATION_DATE > CURDATE() THEN false ELSE true END) AS isExpired,
                NULL AS projectDisclosure,
                t1.DISCLOSURE_ID AS fcoiDisclosure
            FROM COI_DISCLOSURE t1
            WHERE
                t1.PERSON_ID = AV_PERSON_ID
                AND (t1.VERSION_STATUS = 'PENDING' OR t1.VERSION_STATUS = 'ACTIVE')
                AND t1.FCOI_TYPE_CODE IN (1, 3); 

        END IF;

END
