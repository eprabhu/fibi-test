


CREATE PROCEDURE `EVALUATE_OPA_QUESTIONNAIRE`(
    AV_PERSON_ENTITY_ID INT,
    AV_PERSON_ID VARCHAR(60)
)
    DETERMINISTIC
BEGIN

    DECLARE REL_PRESENT_FLAG INT DEFAULT 0;
     DECLARE LS_QUEST_COMPLETED_FLAG VARCHAR(1);
     
SELECT 1 into REL_PRESENT_FLAG 
    FROM PERSON_ENTITY_RELATIONSHIP
    WHERE PERSON_ENTITY_ID = AV_PERSON_ENTITY_ID
    AND VALID_PERS_ENTITY_REL_TYP_CODE = 5;

         IF REL_PRESENT_FLAG = 0 THEN

			SELECT QUESTIONNAIRE_COMPLETED_FLAG INTO LS_QUEST_COMPLETED_FLAG FROM QUEST_ANSWER_HEADER WHERE MODULE_ITEM_CODE = 8 AND MODULE_SUB_ITEM_CODE = 801 
			 AND MODULE_ITEM_KEY = AV_PERSON_ENTITY_ID
			AND MODULE_SUB_ITEM_KEY = 5;
				
                IF LS_QUEST_COMPLETED_FLAG = 'Y' THEN
                
                INSERT INTO PERSON_ENTITY_RELATIONSHIP (PERSON_ENTITY_ID, VALID_PERS_ENTITY_REL_TYP_CODE, UPDATE_TIMESTAMP, UPDATE_USER)
				VALUES (AV_PERSON_ENTITY_ID, '5', utc_timestamp(), 'system');
                
                SELECT 'New relation added' AS MESSAGE;

			END IF;

	ELSE
		SELECT 'No new relation added' AS MESSAGE;
        
    END IF;

END