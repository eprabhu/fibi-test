


CREATE PROCEDURE `GET_COI_PERSON_ENTITY_DETAILS`(
IN AV_COI_DISCLOSURE_ID INT,
IN AV_PERSON_ID	VARCHAR(40),
IN AV_FETCH_NON_ARCHIVE BOOLEAN
)
BEGIN

DECLARE LS_DYN_SQL 	 				LONGTEXT;
DECLARE LS_FILTER_CONDITION_1 		LONGTEXT;
DECLARE LS_FILTER_CONDITION_2		LONGTEXT;
DECLARE JOIN_CONDITION 				LONGTEXT;
DECLARE SELECTED_FIELD_LIST 		LONGTEXT;

SET LS_FILTER_CONDITION_1 ='';
SET LS_FILTER_CONDITION_2 ='';
SET SELECTED_FIELD_LIST ='';
SET JOIN_CONDITION ='';

IF AV_COI_DISCLOSURE_ID IS NOT NULL THEN
		SET LS_FILTER_CONDITION_1 = CONCAT(LS_FILTER_CONDITION_1,' t11.DISCLOSURE_ID = ',AV_COI_DISCLOSURE_ID,' ');
        SET SELECTED_FIELD_LIST = CONCAT(SELECTED_FIELD_LIST,' t.COI_DISCL_PROJECT_ENTITY_REL_ID,' );
        SET JOIN_CONDITION = CONCAT(JOIN_CONDITION,' COI_DISCL_PROJECT_ENTITY_REL t
													INNER JOIN COI_DISCL_PROJECTS t11 ON t11.COI_DISCL_PROJECTS_ID = t.COI_DISCL_PROJECTS_ID
													INNER JOIN person_entity t0  ON t.PERSON_ENTITY_ID = t0.PERSON_ENTITY_ID' );
ELSEIF AV_PERSON_ID IS NOT NULL THEN
		SET LS_FILTER_CONDITION_1 = CONCAT(LS_FILTER_CONDITION_1,' t0.PERSON_ID = ''',AV_PERSON_ID,'''');
        SET JOIN_CONDITION = CONCAT(JOIN_CONDITION,' person_entity t0 ' );
END IF;

IF AV_FETCH_NON_ARCHIVE IS NOT NULL THEN
		SET LS_FILTER_CONDITION_2 = CONCAT(LS_FILTER_CONDITION_2,' AND t0.VERSION_STATUS  != ''ARCHIVE'' ');
END IF;

 SET LS_DYN_SQL = CONCAT(' SELECT',SELECTED_FIELD_LIST,'
        t0.PERSON_ENTITY_ID,
        t0.PERSON_ID,
        t0.ENTITY_ID,
        t0.ENTITY_NUMBER,
        t5.PRIMARY_NAME as ENTITY_NAME,
        t6.DESCRIPTION AS ENTITY_TYPE,
        t7.COUNTRY_NAME,
        s1.REL,
        t0.INVOLVEMENT_START_DATE,
        t0.INVOLVEMENT_END_DATE,
        t8.DESCRIPTION AS ENTITY_STATUS,
        t0.IS_FORM_COMPLETED,
        t0.VERSION_STATUS,
        t9.DESCRIPTION AS ENTITY_BUSINESS_TYPE,
		t14.ENTITY_RISK_ID,
        t14.RISK_CATEGORY_CODE,
        t14.RISK_CATEGORY,
        t14.RISK_LEVEL_CODE,
        t14.RISK_LEVEL,
        t5.IS_FOREIGN
    FROM ',JOIN_CONDITION,'
    INNER JOIN entity t5 ON t5.ENTITY_ID = t0.ENTITY_ID
    LEFT JOIN ENTITY_OWNERSHIP_TYPE t6 ON t6.OWNERSHIP_TYPE_CODE = t5.ENTITY_OWNERSHIP_TYPE_CODE
    INNER JOIN country t7 ON t7.COUNTRY_CODE = t5.COUNTRY_CODE
	INNER JOIN entity_status_type t8 on t8.ENTITY_STATUS_TYPE_CODE = t5.ENTITY_STATUS_TYPE_CODE
    LEFT JOIN (
        SELECT t0.PERSON_ENTITY_ID, GROUP_CONCAT(DISTINCT CONCAT(t3.DESCRIPTION, '': '', t4.DESCRIPTION) ORDER BY t3.DESCRIPTION SEPARATOR '':;:'') AS REL
        FROM ',JOIN_CONDITION,'
        INNER JOIN person_entity_relationship t1 ON t1.PERSON_ENTITY_ID = t0.PERSON_ENTITY_ID
        INNER JOIN VALID_PERSON_ENTITY_REL_TYPE t2 ON t1.VALID_PERS_ENTITY_REL_TYP_CODE = t2.VALID_PERS_ENTITY_REL_TYP_CODE
        INNER JOIN coi_disclosure_type t3 ON t2.DISCLOSURE_TYPE_CODE = t3.DISCLOSURE_TYPE_CODE
        INNER JOIN person_entity_rel_type t4 ON t4.RELATIONSHIP_TYPE_CODE = t2.RELATIONSHIP_TYPE_CODE
        WHERE', LS_FILTER_CONDITION_1, LS_FILTER_CONDITION_2, '
        GROUP BY t0.PERSON_ENTITY_ID
    ) s1 ON t0.PERSON_ENTITY_ID = s1.PERSON_ENTITY_ID
    LEFT JOIN ENTITY_BUSINESS_TYPE t9 ON t9.BUSINESS_TYPE_CODE = t5.BUSINESS_TYPE_CODE
	LEFT JOIN ( SELECT t10.ENTITY_RSIK_ID AS ENTITY_RISK_ID, t13.RISK_CATEGORY_CODE, t13.DESCRIPTION AS RISK_CATEGORY,
	    t12.RISK_LEVEL_CODE AS RISK_LEVEL_CODE, t12.DESCRIPTION AS RISK_LEVEL, t10.ENTITY_ID FROM ENTITY_RISK t10
        INNER JOIN ENTITY_RISK_TYPE t13 ON t13.RISK_TYPE_CODE = t10.RISK_TYPE_CODE AND t13.RISK_CATEGORY_CODE = ''CO''
        INNER JOIN ENTITY_RISK_LEVEL t12 ON t12.RISK_LEVEL_CODE = t10.RISK_LEVEL_CODE
    ) t14 ON t14.ENTITY_ID = t5.ENTITY_ID
    WHERE ',LS_FILTER_CONDITION_1, LS_FILTER_CONDITION_2, '
    GROUP BY t0.PERSON_ENTITY_ID, t0.PERSON_ID, t0.ENTITY_NUMBER, t5.PRIMARY_NAME');
    
    SET @QUERY_STATEMENT = LS_DYN_SQL;
	PREPARE EXECUTABLE_STATEMENT FROM @QUERY_STATEMENT;
	EXECUTE EXECUTABLE_STATEMENT;

END