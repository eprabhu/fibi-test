


CREATE PROCEDURE `GET_TRAVEL_DETAILS_OF_ENGAGEMENT`(AV_PERSON_ENTITY_NUMBER INT)
BEGIN

    SELECT
            t1.TRAVEL_DISCLOSURE_ID,
            t1.TRAVEL_NUMBER,
            t1.VERSION_NUMBER,
            t1.VERSION_STATUS,
            t1.HOME_UNIT,
            ANY_VALUE(t4.VALUE) AS PURPOSE_OF_THE_TRIP,
            ANY_VALUE(t6.VALUE) AS TRIP_TITLE,
            ANY_VALUE(t8.VALUE) AS REIMBURSED_AMOUNT,
            t2.destination AS travelDestinations,
        GROUP_CONCAT(DISTINCT t11.VALUE ORDER BY t11.VALUE ASC SEPARATOR ', ') AS TRAVELLER
        FROM COI_TRAVEL_DISCLOSURE t1
        LEFT JOIN (SELECT TRAVEL_DISCLOSURE_ID, JSON_ARRAYAGG(
                JSON_OBJECT(
                    'travelDestinationId', t01.TRAVEL_DESTINATION_ID,
                    'placeOfStay', t01.PLACE_OF_STAY,
                    'city', t01.CITY,
                    'state', t01.STATE,
                    'postCode', t01.POST_CODE,
                    'countryCode', t01.COUNTRY_CODE,
                    'travelMediumDetail', t01.TRAVEL_MEDIUM_DETAIL,
                    'stayStartDate', t01.STAY_START_DATE,
                    'stayEndDate', t01.STAY_END_DATE,
    				'countryName', t9.COUNTRY_NAME
                    )) as destination
    		FROM COI_TRAVEL_DESTINATIONS t01
    		LEFT JOIN COUNTRY t9 ON t9.COUNTRY_CODE = t01.COUNTRY_CODE
            group by TRAVEL_DISCLOSURE_ID
        )t2 ON t2.TRAVEL_DISCLOSURE_ID = t1.TRAVEL_DISCLOSURE_ID
        LEFT JOIN FB_COMP_CUSTOM_ELEMENT t3 ON t3.CUSTOM_ELEMENT_NAME = "Purpose"
        LEFT JOIN FB_COMP_CUSTOM_ELEMENT_ANSWER t4 ON t4.CUSTOM_DATA_ELEMENTS_ID = t3.CUSTOM_DATA_ELEMENTS_ID AND t4.MODULE_ITEM_CODE = 24 AND t4.MODULE_ITEM_KEY = t1.TRAVEL_DISCLOSURE_ID
        LEFT JOIN FB_COMP_CUSTOM_ELEMENT t5 ON t5.CUSTOM_ELEMENT_NAME = "Trip Title"
        LEFT JOIN FB_COMP_CUSTOM_ELEMENT_ANSWER t6 ON t6.CUSTOM_DATA_ELEMENTS_ID = t5.CUSTOM_DATA_ELEMENTS_ID AND t6.MODULE_ITEM_CODE = 24 AND t6.MODULE_ITEM_KEY = t1.TRAVEL_DISCLOSURE_ID
        LEFT JOIN FB_COMP_CUSTOM_ELEMENT t7 ON t7.CUSTOM_ELEMENT_NAME = "Reimbursed Cost"
        LEFT JOIN FB_COMP_CUSTOM_ELEMENT_ANSWER t8 ON t8.CUSTOM_DATA_ELEMENTS_ID = t7.CUSTOM_DATA_ELEMENTS_ID AND t8.MODULE_ITEM_CODE = 24 AND t8.MODULE_ITEM_KEY = t1.TRAVEL_DISCLOSURE_ID
        LEFT JOIN FB_COMP_CUSTOM_ELEMENT t10 ON t10.CUSTOM_ELEMENT_NAME = "Traveller"
        LEFT JOIN FB_COMP_CUSTOM_ELEMENT_ANSWER t11 ON t11.CUSTOM_DATA_ELEMENTS_ID = t10.CUSTOM_DATA_ELEMENTS_ID AND t11.MODULE_ITEM_CODE = 24 AND t11.MODULE_ITEM_KEY = t1.TRAVEL_DISCLOSURE_ID
        WHERE t1.PERSON_ENTITY_NUMBER = AV_PERSON_ENTITY_NUMBER
        GROUP BY t1.TRAVEL_DISCLOSURE_ID;
END