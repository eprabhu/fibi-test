

CREATE PROCEDURE `COI_DISCL_VOID_DEACTIVATED_PROJECT`(
AV_MODULE_CODE		VARCHAR(40),
AV_MODULE_ITEM_KEY	VARCHAR(100),
AV_PERSON_ID 		VARCHAR(40),
AV_REMARK	 		VARCHAR(225)
)
BEGIN

	IF AV_PERSON_ID IS NOT NULL THEN
        UPDATE COI_DISCLOSURE t1
        INNER JOIN COI_DISCL_PROJECTS t2 ON t2.DISCLOSURE_ID = t1.DISCLOSURE_ID
        SET t1.DISPOSITION_STATUS_CODE = 2, t1.REMARK = AV_REMARK,
        t1.UPDATE_TIMESTAMP = UTC_TIMESTAMP()
        WHERE t1.FCOI_TYPE_CODE = 2 AND t2.MODULE_ITEM_KEY = AV_MODULE_ITEM_KEY AND t2.MODULE_CODE = AV_MODULE_CODE AND t1.PERSON_ID = AV_PERSON_ID ;
	
		UPDATE INBOX T0
        INNER JOIN COI_DISCLOSURE T1 ON T1.DISCLOSURE_ID = T0.MODULE_ITEM_KEY
        INNER JOIN COI_DISCL_PROJECTS t2 ON t2.DISCLOSURE_ID = t1.DISCLOSURE_ID
        SET T0.OPENED_FLAG = 'E', T0.UPDATE_TIMESTAMP = UTC_TIMESTAMP() WHERE 
        T1.FCOI_TYPE_CODE = 2 AND T2.MODULE_ITEM_KEY = AV_MODULE_ITEM_KEY AND T0.MESSAGE_TYPE_CODE=8002
        AND t2.MODULE_CODE = AV_MODULE_CODE AND t1.PERSON_ID = AV_PERSON_ID AND T0.OPENED_FLAG='N' ;

        ELSE
		UPDATE COI_DISCLOSURE t1
		INNER JOIN COI_DISCL_PROJECTS t2 ON t2.DISCLOSURE_ID = t1.DISCLOSURE_ID
        SET t1.DISPOSITION_STATUS_CODE = 2, t1.REMARK = AV_REMARK,
        t1.UPDATE_TIMESTAMP = UTC_TIMESTAMP()
        WHERE t1.FCOI_TYPE_CODE = 2 AND t2.MODULE_ITEM_KEY = AV_MODULE_ITEM_KEY AND t2.MODULE_CODE = AV_MODULE_CODE;
	
        UPDATE INBOX T0
        INNER JOIN COI_DISCLOSURE T1 ON T1.DISCLOSURE_ID = T0.MODULE_ITEM_KEY
        INNER JOIN COI_DISCL_PROJECTS t2 ON t2.DISCLOSURE_ID = t1.DISCLOSURE_ID
        SET T0.OPENED_FLAG = 'E', T0.UPDATE_TIMESTAMP = UTC_TIMESTAMP() WHERE 
        T1.FCOI_TYPE_CODE = 2 AND T2.MODULE_ITEM_KEY = AV_MODULE_ITEM_KEY 
        AND T0.MESSAGE_TYPE_CODE=8002 AND T2.MODULE_CODE = AV_MODULE_CODE AND T0.OPENED_FLAG='N' ;

        END IF;

END