


CREATE PROCEDURE `COI_INT_PROJECT_PRSN_DISCL_STATUS`(
    IN AV_PROJECT_NUMBER    VARCHAR(12),
    IN AV_PERSON_ID        TEXT
)
PROC:BEGIN

	DECLARE LS_DISCLOSURE_VALIDATION_FLAG VARCHAR(200);
	DECLARE LS_PROJECT_NUMBER 			  VARCHAR(12);
    DECLARE LS_DISCLOSURE_REQUIRED_FLAG   VARCHAR(20);
    DECLARE LS_EXPIRATION_DATE            VARCHAR(30);
    DECLARE LS_REVIEW_STATUS_CODE         VARCHAR(3);
    DECLARE LS_DISPOSITION_STATUS_CODE    VARCHAR(3);
	DECLARE LI_DISCLOSURE_ID 			  INT;
    DECLARE LI_COUNT 					  INT DEFAULT 0;
    DECLARE DONE						  INT DEFAULT 0;
    DECLARE LS_PERSON_ID 				VARCHAR(20);

    DECLARE SEL_DATA CURSOR FOR 
        SELECT DISTINCT KEY_PERSON_ID
        FROM COI_INT_STAGE_AWARD_PERSON CISAP
        WHERE FIND_IN_SET(CISAP.KEY_PERSON_ID, AV_PERSON_ID) > 0
        AND CISAP.STATUS = 'A';
		
	DECLARE CONTINUE HANDLER FOR NOT FOUND SET DONE = 1;
	
            
	   SELECT UPPER(CISA.DISCLOSURE_VALIDATION_FLAG)
       INTO LS_DISCLOSURE_VALIDATION_FLAG 
       FROM COI_INT_STAGE_AWARD CISA
       WHERE CISA.PROJECT_NUMBER = AV_PROJECT_NUMBER;   
 
    OPEN SEL_DATA;
      SEL_DATA: LOOP
		
        SET DONE = 0;
        FETCH SEL_DATA INTO LS_PERSON_ID;
		IF DONE = 1 THEN 
            LEAVE SEL_DATA;
        END IF;	 
		
	SET LI_COUNT = 0;
	
	   SELECT COUNT(1) INTO LI_COUNT FROM COI_INT_STAGE_AWARD_PERSON 
       WHERE PROJECT_NUMBER = AV_PROJECT_NUMBER AND KEY_PERSON_ID = LS_PERSON_ID AND STATUS = 'A';
	   	   IF LI_COUNT = 0 THEN 
	   
			SET LI_COUNT = 0;
			
	   		SELECT  COUNT(1) INTO LI_COUNT
			FROM COI_DISCL_PROJECTS T5 
			INNER JOIN COI_DISCLOSURE T6 ON T6.DISCLOSURE_ID = T5.DISCLOSURE_ID
			INNER JOIN COI_INT_STAGE_AWARD AW1 ON AW1.PROJECT_NUMBER = T5.MODULE_ITEM_KEY
			INNER JOIN COI_INT_STAGE_AWARD AW2 ON AW2.ROOT_PROJECT_NUMBER = AW1.ROOT_PROJECT_NUMBER
			WHERE T6.VERSION_STATUS IN ('ACTIVE', 'PENDING')
			AND T6.PERSON_ID = LS_PERSON_ID
			AND SUBSTRING_INDEX(AW1.PROJECT_NUMBER, '-', 1) = SUBSTRING_INDEX(AV_PROJECT_NUMBER, '-', 1);
	
			IF LI_COUNT = 0 THEN 
           
			SELECT NULL AS DISCLOSURE_ID, 'No Disclosure.' as DISCLOSURE_STATUS;
			LEAVE PROC;				
			END IF;
	   
	   
	   END IF;
		
		
		IF LS_DISCLOSURE_VALIDATION_FLAG = 'SELF' THEN 
		
			SELECT  DISTINCT MODULE_ITEM_KEY  INTO LS_PROJECT_NUMBER
			FROM COI_DISCL_PROJECTS T5 
			INNER JOIN COI_DISCLOSURE T6 ON T6.DISCLOSURE_ID = T5.DISCLOSURE_ID
			INNER JOIN COI_INT_STAGE_AWARD AW1 ON AW1.PROJECT_NUMBER = T5.MODULE_ITEM_KEY
			WHERE T6.VERSION_STATUS IN ('ACTIVE', 'PENDING')
			AND T6.PERSON_ID = LS_PERSON_ID
			AND AW1.PROJECT_NUMBER = AV_PROJECT_NUMBER;	
		
		ELSE	

			SELECT  DISTINCT MODULE_ITEM_KEY INTO LS_PROJECT_NUMBER
			FROM COI_DISCL_PROJECTS T5 
			INNER JOIN COI_DISCLOSURE T6 ON T6.DISCLOSURE_ID = T5.DISCLOSURE_ID
			INNER JOIN COI_INT_STAGE_AWARD AW1 ON AW1.PROJECT_NUMBER = T5.MODULE_ITEM_KEY
			INNER JOIN COI_INT_STAGE_AWARD AW2 ON AW2.ROOT_PROJECT_NUMBER = AW1.ROOT_PROJECT_NUMBER
			WHERE T6.VERSION_STATUS IN ('ACTIVE', 'PENDING')
			AND T6.PERSON_ID = LS_PERSON_ID
			AND SUBSTRING_INDEX(AW1.PROJECT_NUMBER, '-', 1) = SUBSTRING_INDEX(AV_PROJECT_NUMBER, '-', 1)
			AND T5.DISCLOSURE_ID = (SELECT MAX(T.DISCLOSURE_ID) FROM COI_DISCL_PROJECTS T 
			inner join COI_DISCLOSURE cd on cd.disclosure_id = t.disclosure_id
            WHERE T.MODULE_ITEM_KEY =AW1.PROJECT_NUMBER
            and cd.person_id = T6.PERSON_ID);
		
		END IF;
	
	  IF LS_PROJECT_NUMBER IS NULL THEN	

      			SELECT NULL AS DISCLOSURE_ID, 'No Disclosure.' as DISCLOSURE_STATUS;
			LEAVE PROC;	  
	  END IF;
	  
	  
	 
	  
	SELECT CISAP.DISCLOSURE_REQUIRED_FLAG
       INTO LS_DISCLOSURE_REQUIRED_FLAG
       FROM COI_INT_STAGE_AWARD_PERSON CISAP
       WHERE CISAP.PROJECT_NUMBER = LS_PROJECT_NUMBER
       AND CISAP.KEY_PERSON_ID = LS_PERSON_ID
       AND CISAP.STATUS = 'A'; 
	    
    IF LS_DISCLOSURE_REQUIRED_FLAG IS NULL OR LS_DISCLOSURE_REQUIRED_FLAG = 'NOT_REQUIRED' THEN 
			ITERATE SEL_DATA;
    END IF;


    SELECT CD.REVIEW_STATUS_CODE, CD.EXPIRATION_DATE, CD.DISPOSITION_STATUS_CODE,CD.DISCLOSURE_ID
    INTO LS_REVIEW_STATUS_CODE, LS_EXPIRATION_DATE, LS_DISPOSITION_STATUS_CODE,LI_DISCLOSURE_ID
    FROM COI_DISCL_PROJECTS CDP
    INNER JOIN COI_DISCLOSURE CD ON CD.DISCLOSURE_ID = CDP.DISCLOSURE_ID
    INNER JOIN COI_REVIEW_STATUS_TYPE CRST ON CRST.REVIEW_STATUS_CODE = CD.REVIEW_STATUS_CODE
    WHERE CDP.MODULE_CODE = 1
      AND CD.FCOI_TYPE_CODE = 2
      AND CDP.MODULE_ITEM_KEY = LS_PROJECT_NUMBER
      AND CD.PERSON_ID = LS_PERSON_ID
      AND CD.DISPOSITION_STATUS_CODE <> 2
      AND CD.DISCLOSURE_ID = (SELECT MAX(CD2.DISCLOSURE_ID)
                              FROM COI_DISCLOSURE CD2
                              INNER JOIN COI_DISCL_PROJECTS CDP2 ON CDP2.DISCLOSURE_ID = CD2.DISCLOSURE_ID
                              WHERE CDP2.MODULE_CODE = 1
                                AND CD2.FCOI_TYPE_CODE = 2
                                AND CDP2.MODULE_ITEM_KEY = LS_PROJECT_NUMBER
                                AND CD2.PERSON_ID = LS_PERSON_ID
                                AND CD2.DISPOSITION_STATUS_CODE <> 2);

    IF LS_EXPIRATION_DATE IS NULL OR LS_REVIEW_STATUS_CODE IS NULL THEN
  SELECT CD.REVIEW_STATUS_CODE, CD.EXPIRATION_DATE, CD.DISPOSITION_STATUS_CODE,CD.DISCLOSURE_ID
        INTO LS_REVIEW_STATUS_CODE, LS_EXPIRATION_DATE, LS_DISPOSITION_STATUS_CODE,LI_DISCLOSURE_ID
        FROM COI_DISCL_PROJECTS CDP
        INNER JOIN COI_DISCLOSURE CD ON CD.DISCLOSURE_ID = CDP.DISCLOSURE_ID
        INNER JOIN COI_REVIEW_STATUS_TYPE CRST ON CRST.REVIEW_STATUS_CODE = CD.REVIEW_STATUS_CODE
        WHERE CDP.MODULE_CODE = 1
          AND (CD.FCOI_TYPE_CODE = 1 OR CD.FCOI_TYPE_CODE = 3)
          AND CDP.MODULE_ITEM_KEY = LS_PROJECT_NUMBER
          AND CD.PERSON_ID = LS_PERSON_ID
          AND CD.DISPOSITION_STATUS_CODE <> 2
          AND CD.DISCLOSURE_ID = (SELECT MAX(CD2.DISCLOSURE_ID)
                                  FROM COI_DISCLOSURE CD2
                                  INNER JOIN COI_DISCL_PROJECTS CDP2 ON CDP2.DISCLOSURE_ID = CD2.DISCLOSURE_ID
                                  WHERE CDP2.MODULE_CODE = 1
                                    AND (CD2.FCOI_TYPE_CODE = 1 OR CD2.FCOI_TYPE_CODE = 3)
                                    AND CDP2.MODULE_ITEM_KEY = LS_PROJECT_NUMBER
                                    AND CD2.PERSON_ID = LS_PERSON_ID
									AND CD2.REVIEW_STATUS_CODE = 4	
                                    AND CD2.DISPOSITION_STATUS_CODE <> 2);
    END IF;
	
	IF LS_EXPIRATION_DATE IS NULL OR LS_REVIEW_STATUS_CODE IS NULL THEN
		
		SELECT CD.REVIEW_STATUS_CODE, CD.EXPIRATION_DATE, CD.DISPOSITION_STATUS_CODE,CD.DISCLOSURE_ID
        INTO LS_REVIEW_STATUS_CODE, LS_EXPIRATION_DATE, LS_DISPOSITION_STATUS_CODE,LI_DISCLOSURE_ID
        FROM COI_DISCL_PROJECTS CDP
        INNER JOIN COI_DISCLOSURE CD ON CD.DISCLOSURE_ID = CDP.DISCLOSURE_ID
        INNER JOIN COI_REVIEW_STATUS_TYPE CRST ON CRST.REVIEW_STATUS_CODE = CD.REVIEW_STATUS_CODE
        WHERE CDP.MODULE_CODE = 1
          AND (CD.FCOI_TYPE_CODE = 1 OR CD.FCOI_TYPE_CODE = 3)
          AND CDP.MODULE_ITEM_KEY = LS_PROJECT_NUMBER
          AND CD.PERSON_ID = LS_PERSON_ID
          AND CD.DISPOSITION_STATUS_CODE <> 2
          AND CD.DISCLOSURE_ID = (SELECT MAX(CD2.DISCLOSURE_ID)
                                  FROM COI_DISCLOSURE CD2
                                  INNER JOIN COI_DISCL_PROJECTS CDP2 ON CDP2.DISCLOSURE_ID = CD2.DISCLOSURE_ID
                                  WHERE CDP2.MODULE_CODE = 1
                                    AND (CD2.FCOI_TYPE_CODE = 1 OR CD2.FCOI_TYPE_CODE = 3)
                                    AND CDP2.MODULE_ITEM_KEY = LS_PROJECT_NUMBER
                                    AND CD2.PERSON_ID = LS_PERSON_ID									
                                    AND CD2.DISPOSITION_STATUS_CODE <> 2);					
    END IF;

    IF LS_REVIEW_STATUS_CODE IS NULL THEN     
		SELECT NULL AS DISCLOSURE_ID, 'Disclosure Yet to Disclose.' AS DISCLOSURE_STATUS;		
        LEAVE PROC; 
    END IF;

    IF LS_EXPIRATION_DATE IS NULL THEN
        SELECT LI_DISCLOSURE_ID AS DISCLOSURE_ID, 'Review Inprogress.' AS DISCLOSURE_STATUS;
        LEAVE PROC; 
    END IF;

    IF LS_REVIEW_STATUS_CODE > '1' THEN
        IF LS_REVIEW_STATUS_CODE = '4' AND LS_DISPOSITION_STATUS_CODE = '3' THEN 
            IF DATE_FORMAT(LS_EXPIRATION_DATE, '%Y-%m-%d') < DATE_FORMAT(CURDATE(), '%Y-%m-%d') THEN
				SELECT LI_DISCLOSURE_ID AS DISCLOSURE_ID, 'Disclosure expired.' AS DISCLOSURE_STATUS;
                LEAVE PROC; 
            END IF;
        ELSEIF LS_REVIEW_STATUS_CODE = '5' OR LS_REVIEW_STATUS_CODE = '6' THEN
          		SELECT NULL AS DISCLOSURE_ID, 'No Disclosure.' as DISCLOSURE_STATUS;
			    LEAVE PROC;	
        ELSE 
            
			SELECT LI_DISCLOSURE_ID AS DISCLOSURE_ID, 'Review Inprogress.' AS DISCLOSURE_STATUS;
            LEAVE PROC; 
        END IF;
    ELSE
        
		SELECT LI_DISCLOSURE_ID AS DISCLOSURE_ID,'Review Inprogress.' AS DISCLOSURE_STATUS;
        LEAVE PROC; 
    END IF;
	
		
	END LOOP;	
	CLOSE SEL_DATA;
	IF LI_DISCLOSURE_ID IS NOT NULL THEN
	SELECT LI_DISCLOSURE_ID AS DISCLOSURE_ID,'Review Completed.' AS DISCLOSURE_STATUS;  
    ELSE 

   	SELECT NULL AS DISCLOSURE_ID,'No Disclosure.' AS DISCLOSURE_STATUS;  
    END IF;
END