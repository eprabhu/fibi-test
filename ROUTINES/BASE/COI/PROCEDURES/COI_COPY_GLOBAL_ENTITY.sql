

CREATE PROCEDURE `COI_COPY_GLOBAL_ENTITY`(
	AV_ENTITY_ID INT,
	AV_ENTITY_NUMBER INT
)
BEGIN

DECLARE LI_COPIED_ENTITY_ID 		INT;

	-- Copying the main table
	INSERT INTO ENTITY
		(PRIMARY_NAME, FOREIGN_NAME, PRIOR_NAME, SHORT_NAME, DUNS_NUMBER, UEI_NUMBER, CAGE_NUMBER, ENTITY_OWNERSHIP_TYPE_CODE, ENTITY_STATUS_TYPE_CODE,
		OPERATING_STATUS_TYPE_CODE, DOCUMENT_STATUS_TYPE_CODE, BUSINESS_TYPE_CODE, WEBSITE_ADDRESS, START_DATE, INCORPORATION_DATE, INCORPORATED_IN, CONGRESSIONAL_DISTRICT,
		NUMBER_OF_EMPLOYEES, FEDERAL_EMPLOYER_ID, CERTIFIED_EMAIL, ACTIVITY_TEXT, CURRENCY_CODE, ENTITY_SOURCE_TYPE_CODE, PHONE_NUMBER, PRIMARY_ADDRESS_LINE_1,
		PRIMARY_ADDRESS_LINE_2, CITY, STATE, POST_CODE, COUNTRY_CODE, HUMAN_SUB_ASSURANCE, ANIMAL_WELFARE_ASSURANCE, ANIMAL_ACCREDITATION, APPROVED_BY, APPROVED_TIMESTAMP,
		CREATED_BY, CREATE_TIMESTAMP, UPDATED_BY, UPDATE_TIMESTAMP, ENTITY_NUMBER, IS_ACTIVE, VERSION_NUMBER, VERSION_STATUS, IS_DUNS_MATCHED, ORIGINAL_ENTITY_ID)
	SELECT
		PRIMARY_NAME, FOREIGN_NAME, PRIOR_NAME, SHORT_NAME, DUNS_NUMBER, UEI_NUMBER, CAGE_NUMBER, ENTITY_OWNERSHIP_TYPE_CODE, 3 AS ENTITY_STATUS_TYPE_CODE,
		OPERATING_STATUS_TYPE_CODE, DOCUMENT_STATUS_TYPE_CODE, BUSINESS_TYPE_CODE, WEBSITE_ADDRESS, START_DATE, INCORPORATION_DATE, INCORPORATED_IN, CONGRESSIONAL_DISTRICT,
		NUMBER_OF_EMPLOYEES, FEDERAL_EMPLOYER_ID, CERTIFIED_EMAIL, ACTIVITY_TEXT, CURRENCY_CODE, ENTITY_SOURCE_TYPE_CODE, PHONE_NUMBER, PRIMARY_ADDRESS_LINE_1,
		PRIMARY_ADDRESS_LINE_2, CITY, STATE, POST_CODE, COUNTRY_CODE, HUMAN_SUB_ASSURANCE, ANIMAL_WELFARE_ASSURANCE, ANIMAL_ACCREDITATION, APPROVED_BY, APPROVED_TIMESTAMP,
		CREATED_BY, CREATE_TIMESTAMP, UPDATED_BY, UPDATE_TIMESTAMP, ENTITY_NUMBER, IS_ACTIVE, (SELECT MAX(VERSION_NUMBER)+1 FROM ENTITY WHERE ENTITY_NUMBER = AV_ENTITY_NUMBER)  AS VERSION_NUMBER,
		'PENDING' AS VERSION_STATUS, IS_DUNS_MATCHED, ORIGINAL_ENTITY_ID
		FROM ENTITY WHERE ENTITY_ID = AV_ENTITY_ID;

	-- Getting the copied entity's primary key
	-- LAST_INSERT_ID() is session-specific, meaning it only returns the auto-increment value for the last INSERT executed within the current session.
	SET LI_COPIED_ENTITY_ID = LAST_INSERT_ID();

	-- Copying Family Tree Role
        INSERT INTO ENTITY_FAMILY_TREE
            (ENTITY_ID, PARENT_ENTITY_ID, GLOBAL_ULTIMATE_ENTITY_ID, UPDATED_BY, UPDATE_TIMESTAMP)
            SELECT LI_COPIED_ENTITY_ID AS ENTITY_ID, PARENT_ENTITY_ID, GLOBAL_ULTIMATE_ENTITY_ID, UPDATED_BY, UPDATE_TIMESTAMP FROM ENTITY_FAMILY_TREE WHERE ENTITY_ID = AV_ENTITY_ID;

    	INSERT INTO ENTITY_FAMILY_TREE
            (ENTITY_ID, PARENT_ENTITY_ID, GLOBAL_ULTIMATE_ENTITY_ID, UPDATED_BY, UPDATE_TIMESTAMP)
            SELECT ENTITY_ID, LI_COPIED_ENTITY_ID AS ENTITY_ID, GLOBAL_ULTIMATE_ENTITY_ID, UPDATED_BY, UPDATE_TIMESTAMP FROM ENTITY_FAMILY_TREE WHERE PARENT_ENTITY_ID = AV_ENTITY_ID;


	-- Copying Entity References
	INSERT INTO ENTITY_EXTERNAL_ID_MAPPING
		(ENTITY_ID, EXTERNAL_ID_TYPE_CODE, EXTERNAL_ID, DESCRIPTION, SPONSOR_CODE, ORGANIZATION_ID, UPDATED_BY, UPDATE_TIMESTAMP)
		SELECT LI_COPIED_ENTITY_ID AS ENTITY_ID, EXTERNAL_ID_TYPE_CODE, EXTERNAL_ID, DESCRIPTION, SPONSOR_CODE, ORGANIZATION_ID, UPDATED_BY, UPDATE_TIMESTAMP
		FROM ENTITY_EXTERNAL_ID_MAPPING WHERE ENTITY_ID = AV_ENTITY_ID;

	-- Copying Family Tree Role
	INSERT INTO ENTITY_FAMILY_TREE_ROLE
		(ENTITY_ID, FAMILY_ROLE_TYPE_CODE, UPDATED_BY, UPDATE_TIMESTAMP)
		SELECT LI_COPIED_ENTITY_ID AS ENTITY_ID, FAMILY_ROLE_TYPE_CODE, UPDATED_BY, UPDATE_TIMESTAMP FROM ENTITY_FAMILY_TREE_ROLE WHERE ENTITY_ID = AV_ENTITY_ID;

	-- Copying Entity Foreign Name
	INSERT INTO ENTITY_FOREIGN_NAME
		(ENTITY_ID, FOREIGN_NAME, UPDATED_BY, UPDATE_TIMESTAMP)
		SELECT LI_COPIED_ENTITY_ID AS ENTITY_ID, FOREIGN_NAME, UPDATED_BY, UPDATE_TIMESTAMP FROM ENTITY_FOREIGN_NAME WHERE ENTITY_ID = AV_ENTITY_ID;

	-- Copying Entity Indusry Classification
	INSERT INTO ENTITY_INDUSTRY_CLASSIFICATION
		(ENTITY_ID, INDUSTRY_CATEGORY_ID, IS_PRIMARY, UPDATED_BY, UPDATE_TIMESTAMP)
		SELECT LI_COPIED_ENTITY_ID AS ENTITY_ID, INDUSTRY_CATEGORY_ID, IS_PRIMARY, UPDATED_BY, UPDATE_TIMESTAMP FROM ENTITY_INDUSTRY_CLASSIFICATION WHERE ENTITY_ID = AV_ENTITY_ID;

	-- Copying Entity Mailing Address
	INSERT INTO ENTITY_MAILING_ADDRESS
		(ENTITY_ID, ADDRESS_TYPE_CODE, ADDRESS_LINE_1, ADDRESS_LINE_2, CITY, STATE, POST_CODE, COUNTRY_CODE, LOCALITY,
		REGION, COUNTY, UPDATE_TIMESTAMP, UPDATED_BY, IS_COPY)
		SELECT LI_COPIED_ENTITY_ID AS ENTITY_ID, ADDRESS_TYPE_CODE, ADDRESS_LINE_1, ADDRESS_LINE_2, CITY, STATE, POST_CODE, COUNTRY_CODE, LOCALITY,
		REGION, COUNTY, UPDATE_TIMESTAMP, UPDATED_BY, IS_COPY FROM ENTITY_MAILING_ADDRESS WHERE ENTITY_ID = AV_ENTITY_ID;

	-- Copying Entity Prior Name
	INSERT INTO ENTITY_PRIOR_NAME
		(ENTITY_ID, PRIOR_NAME, EFFECTIVE_YEAR, UPDATED_BY, UPDATE_TIMESTAMP)
		SELECT LI_COPIED_ENTITY_ID AS ENTITY_ID, PRIOR_NAME, EFFECTIVE_YEAR, UPDATED_BY, UPDATE_TIMESTAMP FROM ENTITY_PRIOR_NAME WHERE ENTITY_ID = AV_ENTITY_ID;

	-- Copying Entity Registration
	INSERT INTO ENTITY_REGISTRATION
		(ENTITY_ID, REG_TYPE_CODE, REG_NUMBER, IS_ACTIVE, UPDATE_TIMESTAMP, UPDATED_BY)
		SELECT LI_COPIED_ENTITY_ID AS ENTITY_ID, REG_TYPE_CODE, REG_NUMBER, IS_ACTIVE, UPDATE_TIMESTAMP, UPDATED_BY FROM ENTITY_REGISTRATION WHERE ENTITY_ID = AV_ENTITY_ID;

	-- Copying Entity Risk
	INSERT INTO ENTITY_RISK
		(ENTITY_ID, RISK_TYPE_CODE, RISK_LEVEL_CODE, DESCRIPTION, UPDATE_TIMESTAMP, UPDATED_BY)
		SELECT LI_COPIED_ENTITY_ID AS ENTITY_ID, RISK_TYPE_CODE, RISK_LEVEL_CODE, DESCRIPTION, UPDATE_TIMESTAMP, UPDATED_BY FROM ENTITY_RISK WHERE ENTITY_ID = AV_ENTITY_ID;

	-- Copying Entity Sponsor Info
	INSERT INTO ENTITY_SPONSOR_INFO
		(ENTITY_ID, SPONSOR_CODE, FEED_STATUS_CODE, SPONSOR_TYPE_CODE, ACRONYM, DODAC_NUMBER, AUDIT_REPORT_SENT_FOR_FY,
		DUNNING_CAMPAIGN_ID, CUSTOMER_NUMBER, UPDATE_TIMESTAMP, UPDATED_BY)
		SELECT LI_COPIED_ENTITY_ID AS ENTITY_ID, SPONSOR_CODE, FEED_STATUS_CODE, SPONSOR_TYPE_CODE, ACRONYM, DODAC_NUMBER, AUDIT_REPORT_SENT_FOR_FY,
		DUNNING_CAMPAIGN_ID, CUSTOMER_NUMBER, UPDATE_TIMESTAMP, UPDATED_BY FROM ENTITY_SPONSOR_INFO WHERE ENTITY_ID = AV_ENTITY_ID;

	-- Copying Entity Sub Organization Info
	INSERT INTO ENTITY_SUB_ORG_INFO
		(ENTITY_ID, ORGANIZATION_ID, ORGANIZATION_TYPE_CODE, FEED_STATUS_CODE, IRS_TAX_EXEMPTION, MASS_TAX_EXEMPT_NUM, AGENCY_SYMBOL, VENDOR_CODE, COM_GOV_ENTITY_CODE,
		MASS_EMPLOYEE_CLAIM, SCIENCE_MISCONDUCT_COMPL_DATE, PHS_ACOUNT, NSF_INSTITUTIONAL_CODE, INDIRECT_COST_RATE_AGREEMENT, COGNIZANT_AUDITOR, ONR_RESIDENT_REP,
		LOBBYING_REGISTRANT, LOBBYING_INDIVIDUAL, SAM_EXPIRATION_DATE, SUB_AWD_RISK_ASSMT_DATE, UPDATE_TIMESTAMP, UPDATED_BY)
		SELECT LI_COPIED_ENTITY_ID AS ENTITY_ID, ORGANIZATION_ID, ORGANIZATION_TYPE_CODE, FEED_STATUS_CODE, IRS_TAX_EXEMPTION, MASS_TAX_EXEMPT_NUM, AGENCY_SYMBOL, VENDOR_CODE, COM_GOV_ENTITY_CODE,
		MASS_EMPLOYEE_CLAIM, SCIENCE_MISCONDUCT_COMPL_DATE, PHS_ACOUNT, NSF_INSTITUTIONAL_CODE, INDIRECT_COST_RATE_AGREEMENT, COGNIZANT_AUDITOR, ONR_RESIDENT_REP,
		LOBBYING_REGISTRANT, LOBBYING_INDIVIDUAL, SAM_EXPIRATION_DATE, SUB_AWD_RISK_ASSMT_DATE, UPDATE_TIMESTAMP, UPDATED_BY FROM ENTITY_SUB_ORG_INFO WHERE ENTITY_ID = AV_ENTITY_ID;

	-- Copying Entity Compliance Information
	INSERT INTO ENTITY_COMPLIANCE_INFO
		(ENTITY_ID, ENTITY_TYPE_CODE, UPDATE_TIMESTAMP, UPDATED_BY)
		SELECT LI_COPIED_ENTITY_ID AS ENTITY_ID, ENTITY_TYPE_CODE, UPDATE_TIMESTAMP, UPDATED_BY FROM ENTITY_COMPLIANCE_INFO WHERE ENTITY_ID = AV_ENTITY_ID;

	-- Copying Entity Telephone
	INSERT INTO ENTITY_TELEPHONE
		(ENTITY_ID, INT_DIALING_CODE, TELEPHONE_NUMBER, UPDATE_TIMESTAMP, UPDATED_BY)
		SELECT LI_COPIED_ENTITY_ID AS ENTITY_ID, INT_DIALING_CODE, TELEPHONE_NUMBER, UPDATE_TIMESTAMP, UPDATED_BY FROM ENTITY_TELEPHONE WHERE ENTITY_ID = AV_ENTITY_ID;

	-- Copying Entity Trade Style Name
	INSERT INTO ENTITY_TRADE_STYLE_NAME
		(ENTITY_ID, TRADE_STYLE_NAME, PRIORITY, UPDATED_BY, UPDATE_TIMESTAMP)
		SELECT LI_COPIED_ENTITY_ID AS ENTITY_ID, TRADE_STYLE_NAME, PRIORITY, UPDATED_BY, UPDATE_TIMESTAMP FROM ENTITY_TRADE_STYLE_NAME WHERE ENTITY_ID = AV_ENTITY_ID;

	-- Copying the Attachments
	INSERT INTO ENTITY_ATTACHMENT
		(ATTACHMENT_NUMBER, VERSION_NUMBER, VERSION_STATUS, ENTITY_ID, COMMENT, ATTACHMENT_TYPE_CODE, ATTACHMENT_STATUS_CODE, FILE_NAME, MIME_TYPE, FILE_DATA_ID, UPDATE_TIMESTAMP, UPDATED_BY)
		SELECT ATTACHMENT_NUMBER, VERSION_NUMBER, VERSION_STATUS, LI_COPIED_ENTITY_ID AS ENTITY_ID, COMMENT, ATTACHMENT_TYPE_CODE, ATTACHMENT_STATUS_CODE, FILE_NAME, MIME_TYPE, FILE_DATA_ID, UPDATE_TIMESTAMP, UPDATED_BY
		FROM ENTITY_ATTACHMENT t2 WHERE t2.ENTITY_ID = AV_ENTITY_ID;

	INSERT INTO ENTITY_SECTION_ATTACH_REF
		(ENTITY_ID, ENTITY_SECTION_CODE, ENTITY_ATTACHMENT_ID, UPDATE_TIMESTAMP, UPDATED_BY)
		SELECT
			LI_COPIED_ENTITY_ID AS ENTITY_ID,
			t1.ENTITY_SECTION_CODE,
			t1.ENTITY_ATTACHMENT_ID,
			t1.UPDATE_TIMESTAMP,
			t1.UPDATED_BY
		FROM ENTITY_SECTION_ATTACH_REF t1
		JOIN ENTITY_ATTACHMENT t3
			ON t1.ENTITY_ATTACHMENT_ID = t3.ENTITY_ATTACHMENT_ID
		JOIN ENTITY_ATTACHMENT t2
			ON t2.ATTACHMENT_NUMBER = t3.ATTACHMENT_NUMBER
		   AND t2.VERSION_NUMBER = t3.VERSION_NUMBER
		   AND t2.ENTITY_ID = LI_COPIED_ENTITY_ID
		WHERE t1.ENTITY_ID = AV_ENTITY_ID
			AND NOT EXISTS (
				SELECT 1 FROM ENTITY_SECTION_ATTACH_REF esar3
				WHERE esar3.ENTITY_ID = LI_COPIED_ENTITY_ID
				AND esar3.ENTITY_SECTION_CODE = t1.ENTITY_SECTION_CODE
				AND esar3.ENTITY_ATTACHMENT_ID = t2.ENTITY_ATTACHMENT_ID
			);

	-- Copying Entity Notes
	INSERT INTO ENTITY_NOTES
		(ENTITY_ID, TITLE, CONTENT, UPDATED_BY, UPDATE_TIMESTAMP)
		SELECT  LI_COPIED_ENTITY_ID AS ENTITY_ID, TITLE, CONTENT, UPDATED_BY, UPDATE_TIMESTAMP
		FROM ENTITY_NOTES WHERE ENTITY_ID = AV_ENTITY_ID;

	INSERT INTO ENTITY_SECTION_NOTE_REF
		(ENTITY_ID, ENTITY_SECTION_CODE, ENTITY_NOTE_ID, UPDATE_TIMESTAMP, UPDATED_BY)
		SELECT LI_COPIED_ENTITY_ID AS ENTITY_ID, esnr.ENTITY_SECTION_CODE, en3.NOTE_ID, esnr.UPDATE_TIMESTAMP, esnr.UPDATED_BY
			FROM ENTITY_SECTION_NOTE_REF esnr
			JOIN ENTITY_NOTES en2 ON esnr.ENTITY_NOTE_ID = en2.NOTE_ID
			JOIN ENTITY_NOTES en3 ON en3.TITLE = en2.TITLE AND en3.CONTENT = en2.CONTENT AND en3.ENTITY_ID = LI_COPIED_ENTITY_ID
			WHERE esnr.ENTITY_ID = AV_ENTITY_ID;

	INSERT INTO ENTITY_COMMENT
		(ENTITY_ID, COMMENT_TYPE_CODE, IS_PRIVATE, COMMENT, PARENT_COMMENT_ID)
		SELECT LI_COPIED_ENTITY_ID AS ENTITY_ID, COMMENT_TYPE_CODE, IS_PRIVATE, COMMENT, PARENT_COMMENT_ID
		FROM ENTITY_COMMENT WHERE ENTITY_ID = AV_ENTITY_ID;


	UPDATE ENTITY_COMMENT ec
		JOIN ENTITY_COMMENT ec2 ON ec.COMMENT = ec2.COMMENT AND ec.COMMENT_TYPE_CODE = ec2.COMMENT_TYPE_CODE
		SET
			ec.PARENT_COMMENT_ID = ec2.PARENT_COMMENT_ID
		WHERE ec2.ENTITY_ID = AV_ENTITY_ID AND ec.ENTITY_ID = LI_COPIED_ENTITY_ID;

	select LI_COPIED_ENTITY_ID;

END