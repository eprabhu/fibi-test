

CREATE FUNCTION `FN_SET_PROJECT_DISCLOSURE_REVIEW_STATUS`(
    AWARD_NUMBER VARCHAR(12),
    KEY_PERSON_ID VARCHAR(60)
) RETURNS varchar(255) CHARSET utf8mb4
    DETERMINISTIC
BEGIN
    DECLARE RESULT VARCHAR(255) DEFAULT NULL;
    DECLARE FIRST_PART_AWARD VARCHAR(12) DEFAULT NULL;
    DECLARE RELATED_AWARD_NUMBER VARCHAR(12) DEFAULT NULL;
    DECLARE LI_DISCLOSURE_ID INT DEFAULT NULL;
    DECLARE CERTIFIED_AT DATETIME DEFAULT NULL;
    DECLARE REVIEW_STATUS_DESCRIPTION VARCHAR(255) DEFAULT NULL;

    -- Extract the first part of the AWARD_NUMBER before the hyphen (-)
    SET FIRST_PART_AWARD = SUBSTRING_INDEX(AWARD_NUMBER, '-', 1);
    -- Check for related records in coi_discl_projects and coi_disclosure
    SELECT 
        T1.MODULE_ITEM_KEY,
        T2.DISCLOSURE_ID,
        T2.CERTIFIED_AT
    INTO 
        RELATED_AWARD_NUMBER,
        LI_DISCLOSURE_ID,
        CERTIFIED_AT
    FROM 
        COI_DISCL_PROJECTS T1
    INNER JOIN 
        COI_DISCLOSURE T2 
        ON T1.DISCLOSURE_ID = T2.DISCLOSURE_ID
    WHERE 
        T1.MODULE_CODE = 1
        AND T2.DISPOSITION_STATUS_CODE <> 2
        AND T2.VERSION_STATUS <> 'ARCHIVE'
        AND T2.PERSON_ID = KEY_PERSON_ID
        AND t1.MODULE_ITEM_KEY <> AWARD_NUMBER
        AND T1.MODULE_ITEM_KEY LIKE CONCAT(FIRST_PART_AWARD, '-%')
        AND T1.DISCLOSURE_ID = (select max(DISCLOSURE_ID) from COI_DISCLOSURE where DISCLOSURE_NUMBER = T1.DISCLOSURE_NUMBER )
    ORDER BY 
        T2.CERTIFIED_AT DESC
        LIMIT 1;

    -- Ensure LI_DISCLOSURE_ID is valid before proceeding
    IF LI_DISCLOSURE_ID IS NOT NULL THEN
        SELECT T2.DESCRIPTION INTO REVIEW_STATUS_DESCRIPTION 
        FROM COI_DISCLOSURE T1 
        INNER JOIN COI_REVIEW_STATUS_TYPE T2 
        ON T1.REVIEW_STATUS_CODE = T2.REVIEW_STATUS_CODE
        WHERE T1.DISCLOSURE_ID = LI_DISCLOSURE_ID;

        IF REVIEW_STATUS_DESCRIPTION IS NOT NULL THEN
            SET RESULT = REVIEW_STATUS_DESCRIPTION;
        END IF;
    END IF;

    RETURN RESULT;
END
