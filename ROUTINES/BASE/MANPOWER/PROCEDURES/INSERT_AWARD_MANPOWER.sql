CREATE PROCEDURE INSERT_AWARD_MANPOWER()
BEGIN
    DECLARE done INT DEFAULT FALSE;
    DECLARE LI_AWARD_ID INT;
    DECLARE LS_AWARD_NUMBER VARCHAR(50);
    DECLARE LI_SEQUENCE_NUMBER INT;
    DECLARE LD_CURRENT_TIME DATETIME;
    DECLARE award_cursor CURSOR FOR
        SELECT DISTINCT 
            AW.AWARD_ID,
            AW.AWARD_NUMBER,
            AW.SEQUENCE_NUMBER
        FROM AWARD AW
        INNER JOIN AWARD_BUDGET_HEADER ABH ON AW.AWARD_ID = ABH.AWARD_ID
        INNER JOIN AWARD_BUDGET_DETAIL ABD ON ABH.BUDGET_HEADER_ID = ABD.BUDGET_HEADER_ID
        WHERE 
            IFNULL(INTERNAL_ORDER_CODE, BUDGET_DETAILS_ID) NOT IN (
                SELECT BUDGET_REFERENCE_NUMBER 
                FROM AWARD_MANPOWER 
                WHERE MANPOWER_TYPE_CODE <> 3
                AND BUDGET_REFERENCE_NUMBER is not null
            )
            AND ABD.BUDGET_CATEGORY_CODE IN ('EOM', 'RSS') 
            AND AW.AWARD_SEQUENCE_STATUS IN ("ACTIVE", "PENDING");
    DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;
SET LD_CURRENT_TIME = utc_timestamp();
    OPEN award_cursor;
    read_loop: LOOP
        FETCH award_cursor INTO LI_AWARD_ID, LS_AWARD_NUMBER, LI_SEQUENCE_NUMBER;
        IF done THEN
            LEAVE read_loop;
        END IF;
        INSERT INTO AWARD_MANPOWER (
            AWARD_ID,
            AWARD_NUMBER,
            SEQUENCE_NUMBER,
            MANPOWER_TYPE_CODE,
            BUDGET_REFERENCE_NUMBER,
            BUDGET_REFERENCE_TYPE_CODE,
            BUDGET_VERSION_NUMBER,
            ACTUAL_HEADCOUNT,
            CREATE_USER,
            CREATE_TIMESTAMP,
            UPDATE_USER,
            UPDATE_TIMESTAMP,
            MODULE_CODE,
            SUB_MODULE_CODE
        )
       SELECT LI_AWARD_ID,LS_AWARD_NUMBER,LI_SEQUENCE_NUMBER,
        IF (BUDGET_CATEGORY_CODE = 'EOM', 1, 2),
        ifnull(INTERNAL_ORDER_CODE,BUDGET_DETAILS_ID),  IF (INTERNAL_ORDER_CODE IS NULL, 2, 1), VERSION_NUMBER, QUANTITY,
        UPDATE_USER, LD_CURRENT_TIME, 'quickstart', LD_CURRENT_TIME, 1, 4
        FROM AWARD_BUDGET_DETAIL WHERE BUDGET_HEADER_ID IN 
        (SELECT BUDGET_HEADER_ID FROM AWARD_BUDGET_HEADER WHERE AWARD_ID = LI_AWARD_ID  AND VERSION_NUMBER IN (SELECT MAX(VERSION_NUMBER) from AWARD_BUDGET_HEADER where AWARD_ID = LI_AWARD_ID))
        AND BUDGET_CATEGORY_CODE IN ('EOM', 'RSS') 
        AND ifnull(INTERNAL_ORDER_CODE,BUDGET_DETAILS_ID) NOT IN (SELECT BUDGET_REFERENCE_NUMBER FROM AWARD_MANPOWER WHERE AWARD_ID = LI_AWARD_ID AND BUDGET_REFERENCE_NUMBER IS NOT NULL);
    END LOOP;
    CLOSE award_cursor;
	INSERT INTO
    AWARD_MANPOWER (
        AWARD_ID,
        AWARD_NUMBER,
        SEQUENCE_NUMBER,
        MANPOWER_TYPE_CODE,
        CREATE_USER,
        CREATE_TIMESTAMP,
        UPDATE_USER,
        UPDATE_TIMESTAMP,
        MODULE_CODE,
        SUB_MODULE_CODE
    ) (
        WITH
            MANPOWER_AWARDS AS (
                SELECT AWARD_ID
                FROM AWARD_MANPOWER
                WHERE
                    MANPOWER_TYPE_CODE = 3
            )
        SELECT AW.AWARD_ID, AW.AWARD_NUMBER, AW.SEQUENCE_NUMBER, 3, AW.CREATE_USER, AW.CREATE_TIMESTAMP, AW.CREATE_USER, AW.CREATE_TIMESTAMP, 1, 4
        FROM AWARD AW
        WHERE
            AW.AWARD_SEQUENCE_STATUS IN('PENDING','ACTIVE')
            AND NOT EXISTS (
                SELECT 1
                FROM MANPOWER_AWARDS MA
                WHERE
                    MA.AWARD_ID = AW.AWARD_ID
            )
    );
    INSERT INTO AWARD_MPOWER_MIG_LOG (AWARD_ID, AWARD_MANPOWER_ID)
    (SELECT AWARD_ID, AWARD_MANPOWER_ID FROM AWARD_MANPOWER
    WHERE UPDATE_TIMESTAMP = LD_CURRENT_TIME
    AND UPDATE_USER = 'quickstart');
END

