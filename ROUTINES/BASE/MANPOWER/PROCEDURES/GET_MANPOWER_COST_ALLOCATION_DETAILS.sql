CREATE PROCEDURE GET_MANPOWER_COST_ALLOCATION_DETAILS(
AV_REFERENCE_ID                  VARCHAR(200),
AV_POSITION_ID                   VARCHAR(200),
AV_WBS_NUMBER                    VARCHAR(200),
AV_CHARGE_START_DATE             VARCHAR(200),
AV_CHARGE_END_DATE    			 VARCHAR(200),
AV_SORT_TYPE                     VARCHAR(500),
AV_PAGED                         INT(10),
AV_LIMIT                         INT(10),
AV_TYPE                          VARCHAR(1),
AV_UNLIMITED                     BOOLEAN
)
BEGIN
DECLARE LS_DYN_SQL LONGTEXT;
DECLARE LS_FILTER_CONDITION LONGTEXT;
DECLARE LS_OFFSET_CONDITION VARCHAR(600);
DECLARE LI_OFFSET INT(11);

SET LI_OFFSET = (AV_LIMIT * AV_PAGED);

SET LS_FILTER_CONDITION ='';
SET LS_DYN_SQL ='';

IF AV_TYPE = 'A' THEN
			IF AV_REFERENCE_ID IS NOT NULL AND AV_REFERENCE_ID <> '' THEN
				IF LOWER(AV_REFERENCE_ID) = 'null' THEN
					SET LS_FILTER_CONDITION = CONCAT(LS_FILTER_CONDITION,' T.WORKDAY_REFERENCE_ID IS NULL ');
				ELSE
					SET LS_FILTER_CONDITION = CONCAT(LS_FILTER_CONDITION,' T.WORKDAY_REFERENCE_ID LIKE ''%',AV_REFERENCE_ID,'%'' AND ');
				END IF;
			END IF;
            IF AV_POSITION_ID IS NOT NULL AND AV_POSITION_ID <> '' THEN
			 SET LS_FILTER_CONDITION = CONCAT(LS_FILTER_CONDITION,' T.POSITION_ID LIKE ''%',AV_POSITION_ID,'%'' AND ');
			END IF;
            IF AV_WBS_NUMBER IS NOT NULL AND AV_WBS_NUMBER <> '' THEN
			 SET LS_FILTER_CONDITION = CONCAT(LS_FILTER_CONDITION,' T.WBS_NUMBER LIKE ''%',AV_WBS_NUMBER,'%'' AND ');
			END IF;
		    IF AV_CHARGE_START_DATE IS NOT NULL AND AV_CHARGE_START_DATE <> '' THEN
				SET LS_FILTER_CONDITION = CONCAT( LS_FILTER_CONDITION,' DATE(T.CHARGE_START_DATE ) =   DATE_FORMAT(''',AV_CHARGE_START_DATE,''',''%Y-%m-%d'') AND ');
			END IF;
			IF AV_CHARGE_END_DATE IS NOT NULL AND AV_CHARGE_END_DATE <> '' THEN
				SET LS_FILTER_CONDITION = CONCAT( LS_FILTER_CONDITION,' DATE(T.CHARGE_END_DATE ) =   DATE_FORMAT(''',AV_CHARGE_END_DATE,''',''%Y-%m-%d'') AND ');
			END IF;
END IF;
IF AV_SORT_TYPE IS NULL THEN
	SET AV_SORT_TYPE =  CONCAT(' ORDER BY T.UPDATE_TIMESTAMP DESC ');
ELSE
    SET AV_SORT_TYPE = CONCAT(' ORDER BY ',AV_SORT_TYPE);
END IF;

IF AV_UNLIMITED = TRUE THEN
	SET LS_OFFSET_CONDITION = '';
ELSE
	SET LS_OFFSET_CONDITION = CONCAT(' LIMIT ',AV_LIMIT,' OFFSET ',LI_OFFSET);
END IF;

IF LS_FILTER_CONDITION <>'' THEN

SET LS_FILTER_CONDITION = CONCAT(' WHERE ',LS_FILTER_CONDITION);
SELECT TRIM(TRAILING 'AND ' FROM LS_FILTER_CONDITION) into LS_FILTER_CONDITION from dual;

END IF;
SET LS_DYN_SQL = CONCAT('SELECT DISTINCT *  FROM(SELECT  T1.MANPOWER_WORKDAY_RESOURCE_ID, T1.COST_ALLOCATION, T1.WORKDAY_REFERENCE_ID, T1.POSITION_ID, T1.WBS_NUMBER, T1.CHARGE_START_DATE,
T1.CHARGE_END_DATE,T1.UPDATE_TIMESTAMP,
T1.PERSON_ID,
T1.ALLOCATION_LAST_UPDATED_DATE,
T1.COMMITTED_AMOUNT_USED,
T1.POSITION_STATUS_CODE,
T1.JOB_PROFILE_TYPE_CODE,
T5.DESCRIPTION AS JOB_PROFILE_TYPE,
T6.DESCRIPTION AS POSITION_STATUS FROM MANPOWER_WORKDAY_RESOURCE T1
INNER JOIN AWARD_MANPOWER T2 ON T2.BUDGET_REFERENCE_NUMBER = T1.WBS_NUMBER
LEFT JOIN MANPOWER_JOB_PROFILE_TYPE T5 ON T5.JOB_PROFILE_TYPE_CODE = T1.JOB_PROFILE_TYPE_CODE
LEFT JOIN MANPOWER_POSITION_STATUS T6 ON T6.POSITION_STATUS_CODE = T1.POSITION_STATUS_CODE)T' ,LS_FILTER_CONDITION, ' ',AV_SORT_TYPE,' ',LS_OFFSET_CONDITION );

SET @QUERY_STATEMENT = LS_DYN_SQL;
PREPARE EXECUTABLE_STAEMENT FROM @QUERY_STATEMENT;
EXECUTE EXECUTABLE_STAEMENT;


END
