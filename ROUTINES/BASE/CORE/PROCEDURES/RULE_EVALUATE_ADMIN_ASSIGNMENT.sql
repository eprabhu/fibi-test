CREATE PROCEDURE RULE_EVALUATE_ADMIN_ASSIGNMENT(
    IN AV_MODULE_CODE           INT,
    IN AV_SUBMODULE_CODE        INT,
    IN AV_MODULE_ITEM_KEY       VARCHAR(20),
    IN AV_LOGGIN_PERSON_ID      VARCHAR(60),
    IN AV_UPDATE_USER           VARCHAR(200),
    IN AV_SUB_MODULE_ITEM_KEY   VARCHAR(20)
)
    DETERMINISTIC
PROC:BEGIN
    DECLARE LS_RESULT VARCHAR(10);
    DECLARE LS_PARENT_UNIT_NUMBER VARCHAR(50);
    DECLARE LS_LEAD_UNIT_NUMBER VARCHAR(50);
    DECLARE LOOP_CNT INT DEFAULT 0;
    DECLARE DONE1 BOOLEAN DEFAULT FALSE;
    DECLARE LI_NEXT_NODE INT;
    DECLARE LI_NODE_IF_TRUE INT;
    DECLARE LI_NODE_IF_FALSE INT;
    DECLARE LI_NODE INT;
    DECLARE LS_RULE_ID VARCHAR(50);
    DECLARE LS_RULE_EXPRESSION TEXT;
    DECLARE LS_RULE_STR TEXT DEFAULT '-1';
    DECLARE LS_RULE_STR_TMP TEXT DEFAULT '-1';
    DECLARE LI_MAP_ID INT;
    DECLARE LI_COUNT INT;
    DECLARE LI_ADMIN_GROUP_ID       INT DEFAULT 0;
    DECLARE LS_ADMIN_PERSON_ID      VARCHAR(60) DEFAULT NULL;
    DECLARE LS_ADMIN_NAME            VARCHAR(200) DEFAULT NULL;
    DECLARE LS_GROUP_NAME            VARCHAR(200) DEFAULT NULL;
    DECLARE WORKFLOW_CURSOR CURSOR FOR 
        SELECT 
            T2.NODE_NUMBER,
            CASE WHEN IFNULL(T2.NEXT_NODE, '') = '' THEN -1 ELSE T2.NEXT_NODE END,
            CASE WHEN IFNULL(T2.NODE_IF_TRUE, '') = '' THEN -1 ELSE T2.NODE_IF_TRUE END,
            CASE WHEN IFNULL(T2.NODE_IF_FALSE, '') = '' THEN -1 ELSE T2.NODE_IF_FALSE END,
            T3.RULE_ID,
            T3.RULE_EXPRESSION,
            T3.MAP_ID
        FROM META_RULES T1
        JOIN META_RULE_DETAIL T2 ON T2.META_RULE_ID = T1.META_RULE_ID
        JOIN BUSINESS_RULES T3 ON T3.RULE_ID = T2.RULE_ID
        WHERE T1.MODULE_CODE = AV_MODULE_CODE 
            AND T1.SUB_MODULE_CODE = AV_SUBMODULE_CODE
            AND T1.META_RULE_TYPE = 'A'
            AND T1.UNIT_NUMBER = LS_PARENT_UNIT_NUMBER
            AND (
                (T2.PARENT_NODE = 0 AND LOOP_CNT = 0)
                OR (FIND_IN_SET(T2.NODE_NUMBER, LS_RULE_STR) > 0)
            );

    DECLARE CONTINUE HANDLER FOR NOT FOUND SET DONE1 = TRUE;

    -- Get the Lead Unit
    IF AV_MODULE_CODE = 1 THEN
        SELECT LEAD_UNIT_NUMBER INTO LS_LEAD_UNIT_NUMBER 
        FROM AWARD WHERE AWARD_ID = AV_MODULE_ITEM_KEY;

    ELSEIF AV_MODULE_CODE = 3 THEN
        SELECT HOME_UNIT_NUMBER INTO LS_LEAD_UNIT_NUMBER 
        FROM EPS_PROPOSAL WHERE PROPOSAL_ID = AV_MODULE_ITEM_KEY;

    ELSEIF AV_MODULE_CODE = 13 THEN
        SELECT UNIT_NUMBER INTO LS_LEAD_UNIT_NUMBER 
        FROM AGREEMENT_HEADER WHERE AGREEMENT_REQUEST_ID = AV_MODULE_ITEM_KEY;

    ELSEIF AV_MODULE_CODE = 14 THEN
        SELECT LEAD_UNIT_NUMBER INTO LS_LEAD_UNIT_NUMBER 
        FROM AWARD 
        WHERE AWARD_ID IN (
            SELECT AWARD_ID FROM CLAIM WHERE CLAIM_ID = AV_MODULE_ITEM_KEY
        );

    ELSEIF AV_MODULE_CODE = 16 THEN
        SELECT LEAD_UNIT_NUMBER INTO LS_LEAD_UNIT_NUMBER 
        FROM AWARD 
        WHERE AWARD_ID IN (
            SELECT AWARD_ID FROM AWARD_PROGRESS_REPORT WHERE PROGRESS_REPORT_ID = AV_MODULE_ITEM_KEY
        );

    ELSEIF AV_MODULE_CODE = 20 THEN
        SELECT UNIT_NUMBER INTO LS_LEAD_UNIT_NUMBER 
        FROM SR_HEADER WHERE SR_HEADER_ID = AV_MODULE_ITEM_KEY;

    END IF;

    SET LS_PARENT_UNIT_NUMBER = LS_LEAD_UNIT_NUMBER;

    WHILE LS_PARENT_UNIT_NUMBER IS NOT NULL DO
        SET LOOP_CNT = 0;
        SET LS_RULE_STR = '-1';
        CURSOR_LOOP: LOOP
            SET DONE1 = FALSE;
            SET LI_NEXT_NODE = -1;
            SET LI_NODE_IF_TRUE = -1;
            SET LI_NODE_IF_FALSE = -1;

            OPEN WORKFLOW_CURSOR;

            WORKFLOW_CURSOR_LOOP: LOOP
                FETCH WORKFLOW_CURSOR 
                INTO LI_NODE, LI_NEXT_NODE, LI_NODE_IF_TRUE, LI_NODE_IF_FALSE, 
                     LS_RULE_ID, LS_RULE_EXPRESSION, LI_MAP_ID;

                IF DONE1 THEN 
                    LEAVE WORKFLOW_CURSOR_LOOP;
                END IF;

                SET LS_RULE_STR_TMP = '-1';

                IF LI_NEXT_NODE <> -1 THEN
                    SET LS_RULE_STR_TMP = CONCAT(LS_RULE_STR_TMP, ',', LI_NEXT_NODE);
                END IF;
 
                CALL RULE_EVALUATE_EXPRESSION(
                    AV_MODULE_CODE,
                    AV_SUBMODULE_CODE,
                    AV_MODULE_ITEM_KEY,
                    LS_RULE_ID,
                    LS_RULE_EXPRESSION,
                    AV_UPDATE_USER,
                    AV_LOGGIN_PERSON_ID,
                    AV_SUB_MODULE_ITEM_KEY,
                    @EXPR_RESULT
                );
                SET LS_RESULT = @EXPR_RESULT;
                IF LS_RESULT = 'TRUE' THEN

					CALL SP_ASSIGN_ADMIN_OR_ADMIN_GROUP(
						AV_MODULE_ITEM_KEY,
						AV_MODULE_CODE,
						AV_SUBMODULE_CODE,
						AV_LOGGIN_PERSON_ID,
						AV_UPDATE_USER,
						LI_MAP_ID,
						AV_SUB_MODULE_ITEM_KEY,
						LS_RULE_ID,
						@LI_ADMIN_GROUP_ID,
						@LS_ADMIN_PERSON_ID,
						@LS_ADMIN_NAME,
						@LS_GROUP_NAME
					);
 
					-- Get the result value
					SET LI_ADMIN_GROUP_ID = @LI_ADMIN_GROUP_ID;
					SET LS_ADMIN_PERSON_ID = @LS_ADMIN_PERSON_ID;
					SET LS_ADMIN_NAME = @LS_ADMIN_NAME;
					SET LS_GROUP_NAME = @LS_GROUP_NAME;
            
			IF LI_ADMIN_GROUP_ID IS NOT NULL OR LS_ADMIN_PERSON_ID IS NOT NULL  THEN
				SELECT LI_ADMIN_GROUP_ID,LS_ADMIN_PERSON_ID,LS_ADMIN_NAME,LS_GROUP_NAME;
				LEAVE PROC;
				END IF;
                END IF;

                IF LI_NODE_IF_TRUE <> -1 AND LS_RESULT = 'TRUE' THEN
                    SET LS_RULE_STR_TMP = CONCAT(LS_RULE_STR_TMP, ',', LI_NODE_IF_TRUE);
                END IF;

                IF LI_NODE_IF_FALSE <> -1 AND LS_RESULT = 'FALSE' THEN
                    SET LS_RULE_STR_TMP = CONCAT(LS_RULE_STR_TMP, ',', LI_NODE_IF_FALSE);
                END IF;

                SET LS_RULE_STR = CONCAT(LS_RULE_STR_TMP, ',', LS_RULE_STR);
            END LOOP;

            CLOSE WORKFLOW_CURSOR;


            SET LOOP_CNT = LOOP_CNT + 1;

            IF LI_NEXT_NODE = -1 AND LI_NODE_IF_TRUE = -1 AND LI_NODE_IF_FALSE = -1 THEN
                LEAVE CURSOR_LOOP;
            END IF;
        END LOOP;

        -- Go to parent unit if exists
        SELECT COUNT(*) INTO LI_COUNT FROM UNIT WHERE UNIT_NUMBER = LS_PARENT_UNIT_NUMBER;

        IF LI_COUNT = 0 THEN
            SET LS_PARENT_UNIT_NUMBER = NULL;
        ELSE
            SELECT PARENT_UNIT_NUMBER INTO LS_PARENT_UNIT_NUMBER 
            FROM UNIT WHERE UNIT_NUMBER = LS_PARENT_UNIT_NUMBER;
        END IF;
    END WHILE;

SELECT LI_ADMIN_GROUP_ID,LS_ADMIN_PERSON_ID,LS_ADMIN_NAME,LS_GROUP_NAME;
END
