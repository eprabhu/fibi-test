-- `MIG_DP_PERSONS_TO_SR`; 

CREATE PROCEDURE `MIG_DP_PERSONS_TO_SR`(
	AV_MODULE_ITEM_ID   			    INT,
	AV_SR_HEADER_ID  					INT,
    AV_SOURCE_MODULE_CODE 				INT,
    AV_DESTINATION_MODULE_CODE  		INT,
    AV_UPDATE_USER              		VARCHAR(60)
)
BEGIN
	DECLARE NOT_FOUND                   				    INT;
	DECLARE LS_ERROR_FLAG	            				    VARCHAR(1) 		DEFAULT 'N';
    DECLARE LS_PROC_LOC                 				    VARCHAR(200);
    DECLARE LS_ERROR_MSG                				    VARCHAR(4000);
    DECLARE LS_DEPARTMENT               				    VARCHAR(200);
    DECLARE LS_FULL_NAME                				    VARCHAR(90);
    DECLARE LS_PERSON_ID                				    VARCHAR(40);
    DECLARE LI_PERSON_ROLE_ID           				    INT;
    DECLARE LI_ROLODEX_ID               					INT;
    DECLARE LI_PERCENTAGE_OF_EFFORT 						DECIMAL(5,2);
    DECLARE LS_PI_FLAG                                      VARCHAR(1);
    DECLARE LS_DESIGNATION                                  VARCHAR(255);
    DECLARE LS_IS_PERSON_CERTIFIED                          VARCHAR(1);
    DECLARE LS_PROJECT_ROLE                         		VARCHAR(200);
    DECLARE LS_IS_TRAINING_COMPLETED                        VARCHAR(16);
    DECLARE LS_ASSIGNEE_PERSON_ID                           VARCHAR(40);
    DECLARE LI_STATUS_CODE                          		INT;
    DECLARE LI_DP_PERSON_ID                          		INT;
    DECLARE LI_INSERT_ID                          		 	INT;
    DECLARE LI_COUNT                          		 		INT;
    DECLARE LS_DP_UNIT_NUMBER                          		VARCHAR(50);
    DECLARE LS_LEAD_UNIT_FLAG                          		VARCHAR(1);
    DECLARE LS_USER_MESSAGE                         		VARCHAR(4000)   DEFAULT '';
    DECLARE LS_SUBJECT                         				VARCHAR(1000);
    DECLARE SEL_OLD_SR_PERSONS CURSOR FOR  
    SELECT FULL_NAME, PERSON_ID, PERSON_ROLE_ID FROM SR_PERSONS WHERE SR_HEADER_ID = AV_SR_HEADER_ID;
    
    DECLARE SEL_DP_PERSONS CURSOR FOR
     SELECT PROPOSAL_PERSON_ID, DEPARTMENT, FULL_NAME, PERSON_ID, PROP_PERSON_ROLE_ID, ROLODEX_ID, PERCENTAGE_OF_EFFORT, PI_FLAG, DESIGNATION, PROJECT_ROLE
     FROM eps_proposal_persons where PROPOSAL_ID = AV_MODULE_ITEM_ID;
     
        	DECLARE EXIT HANDLER FOR SQLEXCEPTION
				BEGIN
					GET DIAGNOSTICS CONDITION 1 @sqlstate = RETURNED_SQLSTATE, 
					 @errno = MYSQL_ERRNO, @msg = MESSAGE_TEXT;					 
					SET @full_error = CONCAT(@msg,'/',LS_PROC_LOC);	
					SET LS_ERROR_MSG = @full_error;
                    	RESIGNAL SET MESSAGE_TEXT = LS_ERROR_MSG;
                END;
				
     DECLARE CONTINUE HANDLER FOR NOT FOUND  SET NOT_FOUND = 1;	
 SET LS_ERROR_FLAG = 'N';
	SELECT ASSIGNEE_PERSON_ID, STATUS_CODE, SUBJECT 
	INTO LS_ASSIGNEE_PERSON_ID, LI_STATUS_CODE, LS_SUBJECT 
	FROM SR_HEADER WHERE SR_HEADER_ID = AV_SR_HEADER_ID;
      	SET LS_PROC_LOC = 'SEL_OLD_SR_PERSONS';
			OPEN SEL_OLD_SR_PERSONS;
            SEL_OLD_SR_PERSONS:LOOP
			SET NOT_FOUND  = 0;
            FETCH SEL_OLD_SR_PERSONS INTO LS_FULL_NAME, LS_PERSON_ID,LI_PERSON_ROLE_ID;
            IF NOT_FOUND = 1 THEN
            LEAVE SEL_OLD_SR_PERSONS;
            END IF;
  		SET SQL_SAFE_UPDATES = 0;
		 IF  (select COUNT(*) from sr_persons where SR_HEADER_ID = AV_SR_HEADER_ID  > 0) THEN 	
				DELETE FROM INBOX WHERE MODULE_ITEM_KEY = AV_SR_HEADER_ID AND MESSAGE_TYPE_CODE = 146;
				DELETE FROM SR_PERSON_UNITS WHERE SR_HEADER_ID = AV_SR_HEADER_ID;
		 		DELETE FROM SR_PERSONS WHERE SR_HEADER_ID = AV_SR_HEADER_ID;
                DELETE FROM QUEST_ANSWER_ATTACHMENT WHERE QUESTIONNAIRE_ANSWER_ID IN 
                (SELECT QUESTIONNAIRE_ANSWER_ID FROM QUEST_ANSWER WHERE QUESTIONNAIRE_ANS_HEADER_ID IN
				(SELECT QUESTIONNAIRE_ANS_HEADER_ID FROM QUEST_ANSWER_HEADER  WHERE MODULE_ITEM_KEY = AV_SR_HEADER_ID AND MODULE_ITEM_CODE = 20 AND MODULE_SUB_ITEM_CODE = 1));
                DELETE FROM QUEST_ANSWER  WHERE QUESTIONNAIRE_ANS_HEADER_ID IN 
                (SELECT QUESTIONNAIRE_ANS_HEADER_ID FROM QUEST_ANSWER_HEADER  WHERE MODULE_ITEM_KEY = AV_SR_HEADER_ID  AND MODULE_ITEM_CODE = 20 AND MODULE_SUB_ITEM_CODE = 1);
				DELETE FROM QUEST_ANSWER_HEADER  WHERE MODULE_ITEM_KEY = AV_SR_HEADER_ID AND MODULE_ITEM_CODE = 20  AND MODULE_SUB_ITEM_CODE = 1; 
				 END IF;
		 SET SQL_SAFE_UPDATES = 1;
		 
         IF (LS_PERSON_ID is not null) THEN
            Select count(1) into LI_COUNT from sr_person_roles WHERE SR_HEADER_ID = AV_SR_HEADER_ID AND PERSON_ID = LS_PERSON_ID AND IS_SYSTEM_DERIVED_ROLE = 'Y';
			IF (LI_COUNT > 0)
				THEN
					INSERT INTO sr_action_log (ACTION_TYPE_CODE,ASSIGNEE_PERSON_ID,ASSIGNEE_PERSON_NAME, STATUS_CODE, UPDATE_TIMESTAMP, UPDATE_USER, SR_HEADER_ID) 
					VALUES (31, LS_ASSIGNEE_PERSON_ID, (select FULL_NAME from person where PERSON_ID = LS_ASSIGNEE_PERSON_ID), LI_STATUS_CODE, utc_timestamp(6), AV_UPDATE_USER,AV_SR_HEADER_ID);
					SET LI_INSERT_ID = last_insert_id();
					INSERT INTO sr_header_history (ACTION_LOG_ID, UPDATE_TIMESTAMP, UPDATE_USER, SR_HEADER_ID, DELETED_PERMISSION, PERMISSION_ASSIGNED_USER)
					VALUES (LI_INSERT_ID, utc_timestamp(6), AV_UPDATE_USER, AV_SR_HEADER_ID,
					(SELECT  GROUP_CONCAT(distinct mdv.DERIVED_ROLE_NAME SEPARATOR ', ')  from sr_person_roles spr 
					join 
					module_derived_roles mdv 
					where 
					mdv.ROLE_ID = spr.ROLE_ID and 
					PERSON_ID = LS_PERSON_ID and 
					SR_HEADER_ID = AV_SR_HEADER_ID and
					IS_SYSTEM_DERIVED_ROLE = 'Y'),
					LS_FULL_NAME);
					SET LI_COUNT = 0;
			END IF;
            DELETE FROM sr_person_roles WHERE SR_HEADER_ID = AV_SR_HEADER_ID AND PERSON_ID = LS_PERSON_ID and IS_SYSTEM_DERIVED_ROLE = 'Y';
		END IF;
		END LOOP SEL_OLD_SR_PERSONS;
		CLOSE SEL_OLD_SR_PERSONS;
        
  	SET LS_PROC_LOC = 'SEL_DP_PERSONS';
			OPEN SEL_DP_PERSONS;
            SEL_DP_PERSONS:LOOP
			SET NOT_FOUND  = 0;
            FETCH SEL_DP_PERSONS 
            INTO LI_DP_PERSON_ID, LS_DEPARTMENT, LS_FULL_NAME, LS_PERSON_ID, LI_PERSON_ROLE_ID, LI_ROLODEX_ID, LI_PERCENTAGE_OF_EFFORT, LS_PI_FLAG, LS_DESIGNATION, LS_PROJECT_ROLE;
            IF NOT_FOUND = 1 THEN
            LEAVE SEL_DP_PERSONS;
            END IF; 
            
           Select count(1) into LI_COUNT from sr_person_roles WHERE SR_HEADER_ID = AV_SR_HEADER_ID AND PERSON_ID = LS_PERSON_ID AND IS_SYSTEM_DERIVED_ROLE = 'Y';
			IF (LI_COUNT > 0)
				THEN
					INSERT INTO sr_action_log (ACTION_TYPE_CODE,ASSIGNEE_PERSON_ID,ASSIGNEE_PERSON_NAME, STATUS_CODE, UPDATE_TIMESTAMP, UPDATE_USER, SR_HEADER_ID) 
					VALUES (31, LS_ASSIGNEE_PERSON_ID, (select FULL_NAME from person where PERSON_ID = LS_ASSIGNEE_PERSON_ID), LI_STATUS_CODE, utc_timestamp(6), AV_UPDATE_USER,AV_SR_HEADER_ID);
					
					SET LI_INSERT_ID = last_insert_id();
					
					INSERT INTO sr_header_history (ACTION_LOG_ID, UPDATE_TIMESTAMP, UPDATE_USER, SR_HEADER_ID, DELETED_PERMISSION, PERMISSION_ASSIGNED_USER) 
					VALUES (LI_INSERT_ID, utc_timestamp(6), AV_UPDATE_USER, AV_SR_HEADER_ID,
					(SELECT  GROUP_CONCAT(distinct mdv.DERIVED_ROLE_NAME SEPARATOR ', ')  from sr_person_roles spr 
					join 
					module_derived_roles mdv 
					where 
					mdv.ROLE_ID = spr.ROLE_ID and 
					PERSON_ID = LS_PERSON_ID and 
					SR_HEADER_ID = AV_SR_HEADER_ID and
					IS_SYSTEM_DERIVED_ROLE = 'Y'),
					LS_FULL_NAME);
					SET LI_COUNT = 0;
					DELETE FROM sr_person_roles WHERE SR_HEADER_ID = AV_SR_HEADER_ID AND PERSON_ID = LS_PERSON_ID and IS_SYSTEM_DERIVED_ROLE = 'Y';
			END IF;
            
		INSERT INTO sr_persons (DEPARTMENT, FULL_NAME, PERSON_ID, PERSON_ROLE_ID, ROLODEX_ID, SR_HEADER_ID, PERCENTAGE_OF_EFFORT, PI_FLAG, DESIGNATION, IS_PERSON_CERTIFIED, PROJECT_ROLE, IS_TRAINING_COMPLETED, ACTION_FLAG, UPDATE_TIMESTAMP, UPDATE_USER)
		VALUES (LS_DEPARTMENT, LS_FULL_NAME, LS_PERSON_ID, LI_PERSON_ROLE_ID, LI_ROLODEX_ID, AV_SR_HEADER_ID, LI_PERCENTAGE_OF_EFFORT, LS_PI_FLAG, LS_DESIGNATION, null , LS_PROJECT_ROLE, 'Not Applicable','IMPORTED', utc_timestamp(6), AV_UPDATE_USER);
        
         SET LI_INSERT_ID = last_insert_id();
        IF (select count(*)  from eps_prop_person_units where PROPOSAL_PERSON_ID = LI_DP_PERSON_ID > 0 ) then
			INSERT INTO sr_person_units (SR_HEADER_ID, SR_PERSON_ID, UNIT_NUMBER, LEAD_UNIT_FLAG, UPDATE_TIMESTAMP, UPDATE_USER)
		SELECT 
			AV_SR_HEADER_ID, 
			LI_INSERT_ID, 
			UNIT_NUMBER, 
			LEAD_UNIT_FLAG, 
			utc_timestamp(6), 
			AV_UPDATE_USER 
		FROM 
				eps_prop_person_units 
		WHERE 
				PROPOSAL_PERSON_ID = LI_DP_PERSON_ID;
       END IF;
      
	IF (LS_PERSON_ID is not null ) then
	 IF ((LI_PERSON_ROLE_ID = 3 OR LI_PERSON_ROLE_ID = 4) AND (SELECT COUNT(1) FROM module_derived_roles WHERE AUTO_GRANT_TO_PI = 'Y' AND MODULE_CODE = 20) > 0) 
            THEN
				INSERT INTO sr_action_log (ACTION_TYPE_CODE,ASSIGNEE_PERSON_ID,ASSIGNEE_PERSON_NAME, STATUS_CODE, UPDATE_TIMESTAMP, UPDATE_USER, SR_HEADER_ID) 
				VALUES (30, LS_ASSIGNEE_PERSON_ID, (select FULL_NAME from person where PERSON_ID = LS_ASSIGNEE_PERSON_ID), LI_STATUS_CODE, utc_timestamp(6), AV_UPDATE_USER,AV_SR_HEADER_ID);
				SET LI_INSERT_ID = last_insert_id();
				INSERT INTO sr_person_roles (SR_HEADER_ID, PERSON_ID, ROLE_ID, UPDATE_TIMESTAMP, UPDATE_USER, IS_SYSTEM_DERIVED_ROLE)
				SELECT AV_SR_HEADER_ID, LS_PERSON_ID, ROLE_ID, utc_timestamp(6), AV_UPDATE_USER, 'Y'
				FROM module_derived_roles
				WHERE AUTO_GRANT_TO_PI = 'Y' AND MODULE_CODE = 20;
				
				INSERT INTO sr_header_history (ACTION_LOG_ID, UPDATE_TIMESTAMP, UPDATE_USER, SR_HEADER_ID, ADDED_PERMISSION, PERMISSION_ASSIGNED_USER)
				VALUES (LI_INSERT_ID, utc_timestamp(6), AV_UPDATE_USER, AV_SR_HEADER_ID,
				(SELECT GROUP_CONCAT(DERIVED_ROLE_NAME SEPARATOR ', ')  FROM module_derived_roles WHERE AUTO_GRANT_TO_PI = 'Y' AND MODULE_CODE = 20),LS_FULL_NAME);
				
			ELSEIF ((LI_PERSON_ROLE_ID = 1 ) AND (SELECT COUNT(1) FROM module_derived_roles WHERE AUTO_GRANT_TO_COI = 'Y' AND MODULE_CODE = 20) > 0)
            THEN
				INSERT INTO sr_action_log (ACTION_TYPE_CODE,ASSIGNEE_PERSON_ID,ASSIGNEE_PERSON_NAME, STATUS_CODE, UPDATE_TIMESTAMP, UPDATE_USER, SR_HEADER_ID) 
				VALUES (30, LS_ASSIGNEE_PERSON_ID, (select FULL_NAME from person where PERSON_ID = LS_ASSIGNEE_PERSON_ID), LI_STATUS_CODE, utc_timestamp(6), AV_UPDATE_USER,AV_SR_HEADER_ID);
				
				SET LI_INSERT_ID = last_insert_id();
				
				INSERT INTO sr_person_roles (SR_HEADER_ID, PERSON_ID, ROLE_ID, UPDATE_TIMESTAMP, UPDATE_USER, IS_SYSTEM_DERIVED_ROLE)
				SELECT AV_SR_HEADER_ID, LS_PERSON_ID, ROLE_ID, utc_timestamp(6), AV_UPDATE_USER, 'Y'
				FROM module_derived_roles
				WHERE AUTO_GRANT_TO_COI = 'Y' AND MODULE_CODE = 20;
				
				INSERT INTO sr_header_history (ACTION_LOG_ID, UPDATE_TIMESTAMP, UPDATE_USER, SR_HEADER_ID, ADDED_PERMISSION, PERMISSION_ASSIGNED_USER) 
				VALUES (LI_INSERT_ID, utc_timestamp(6), AV_UPDATE_USER, AV_SR_HEADER_ID,
				(SELECT GROUP_CONCAT(DERIVED_ROLE_NAME SEPARATOR ', ')  FROM module_derived_roles WHERE AUTO_GRANT_TO_COI = 'Y' AND MODULE_CODE = 20),LS_FULL_NAME);
				
			ELSEIF (LI_PERSON_ROLE_ID not in (1,3,4) and (SELECT COUNT(1) FROM module_derived_roles WHERE AUTO_GRANT_TO_OTHERS = 'Y' AND MODULE_CODE = 20) > 0)
			THEN
				INSERT INTO sr_action_log (ACTION_TYPE_CODE,ASSIGNEE_PERSON_ID,ASSIGNEE_PERSON_NAME, STATUS_CODE, UPDATE_TIMESTAMP, UPDATE_USER, SR_HEADER_ID) 
				VALUES (30, LS_ASSIGNEE_PERSON_ID, (select FULL_NAME from person where PERSON_ID = LS_ASSIGNEE_PERSON_ID), LI_STATUS_CODE, utc_timestamp(6), AV_UPDATE_USER,AV_SR_HEADER_ID);
				
				SET LI_INSERT_ID = last_insert_id();
				
				INSERT INTO sr_person_roles (SR_HEADER_ID, PERSON_ID, ROLE_ID, UPDATE_TIMESTAMP, UPDATE_USER, IS_SYSTEM_DERIVED_ROLE)
				SELECT AV_SR_HEADER_ID, LS_PERSON_ID, ROLE_ID, utc_timestamp(6), AV_UPDATE_USER, 'Y'
				FROM module_derived_roles
				WHERE AUTO_GRANT_TO_OTHERS = 'Y' AND MODULE_CODE = 20;
				
				INSERT INTO sr_header_history (ACTION_LOG_ID, UPDATE_TIMESTAMP, UPDATE_USER, SR_HEADER_ID, ADDED_PERMISSION, PERMISSION_ASSIGNED_USER) 
				VALUES (LI_INSERT_ID, utc_timestamp(6), AV_UPDATE_USER, AV_SR_HEADER_ID,
				(SELECT GROUP_CONCAT(DERIVED_ROLE_NAME SEPARATOR ', ')  FROM module_derived_roles WHERE AUTO_GRANT_TO_OTHERS = 'Y' AND MODULE_CODE = 20),LS_FULL_NAME);
			END IF;
        
		   IF ((SELECT count(*) from eps_prop_person_role where PROP_PERSON_ROLE_ID = LI_PERSON_ROLE_ID and CERTIFICATION_REQUIRED = 'Y') > 0) then
				set LS_USER_MESSAGE = CONCAT('#',AV_SR_HEADER_ID,' - ', ifnull (LS_SUBJECT,''));
				INSERT INTO INBOX (ARRIVAL_DATE, MESSAGE_TYPE_CODE, MODULE_CODE, MODULE_ITEM_KEY, OPENED_FLAG, SUBJECT_TYPE, TO_PERSON_ID, UPDATE_TIMESTAMP, UPDATE_USER, USER_MESSAGE, SUB_MODULE_CODE, SUB_MODULE_ITEM_KEY) 
				values (utc_timestamp(6), 146, 20, AV_SR_HEADER_ID, 'N', 'P', LS_PERSON_ID,utc_timestamp(6),AV_UPDATE_USER, LS_USER_MESSAGE, 0,0);
		   END IF;
      END IF;  
        END LOOP SEL_DP_PERSONS;
		CLOSE SEL_DP_PERSONS;  
END
