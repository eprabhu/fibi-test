-- `MIGRATE_PROPOSAL_SPONSOR_TO_AGREEMENT`; 

CREATE PROCEDURE `MIGRATE_PROPOSAL_SPONSOR_TO_AGREEMENT`(
	IN AV_SOURCE_MODULE_ID INT,
    IN AV_DESTINATION_MODULE_ID INT,
    IN AV_DESTINATION_MODULE_CODE INT,
    IN AV_SOURCE_MODULE_CODE INT,
    IN AV_UPDATED_USER VARCHAR(60)
)
BEGIN
    DECLARE V_COUNT INT;
    DECLARE V_START_DATE DATE;
    DECLARE V_END_DATE DATE;
    DECLARE V_UNIT_NUMBER VARCHAR(50);
    DECLARE V_UNIT_NAME VARCHAR(255);
    
    SELECT COUNT(*) INTO V_COUNT FROM AGREEMENT_SPONSOR WHERE AGREEMENT_REQUEST_ID = AV_DESTINATION_MODULE_ID;
    IF V_COUNT = 0 THEN
         INSERT INTO AGREEMENT_SPONSOR (
            AGREEMENT_REQUEST_ID,
           SPONSOR_NAME,
           SPONSOR_CODE,
            UPDATE_TIMESTAMP,
            SPONSOR_ROLE_TYPE_CODE,
            AGREEMENT_SPONSOR_TYPE_CODE,
            UPDATE_USER
        )
        SELECT
            AV_DESTINATION_MODULE_ID,
            t1.SPONSOR_NAME,
            t2.SPONSOR_CODE,
            UTC_TIMESTAMP(),
            1,
            1,
            AV_UPDATED_USER
            FROM sponsor T1
            INNER JOIN EPS_proposal T2 ON T1.SPONSOR_CODE = T2.SPONSOR_CODE WHERE
            T2.PROPOSAL_ID = AV_SOURCE_MODULE_ID
        ;
	END IF;
    INSERT INTO AGREEMENT_SPONSOR (
            AGREEMENT_REQUEST_ID,
            SPONSOR_NAME,
            SPONSOR_CODE,
            UPDATE_TIMESTAMP,
            SPONSOR_ROLE_TYPE_CODE,
            AGREEMENT_SPONSOR_TYPE_CODE,
            UPDATE_USER
        )
        SELECT
            AV_DESTINATION_MODULE_ID,
            t1.SPONSOR_NAME,
            t2.SPONSOR_CODE,
            UTC_TIMESTAMP(),
            5,
            2,
            AV_UPDATED_USER
            FROM sponsor T1
            INNER JOIN EPS_proposal T2 ON T1.SPONSOR_CODE = T2.PRIME_SPONSOR_CODE WHERE
            T2.PROPOSAL_ID = AV_SOURCE_MODULE_ID
        ;
END
