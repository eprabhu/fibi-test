CREATE PROCEDURE `INSERT_WORKFLOW_FOR_ROLE_TYPE`(
	AV_MODULE_CODE DECIMAL(38, 0),
	AV_MODULE_ITEM_ID VARCHAR(20),
	AV_ROLE_TYPE DECIMAL(38, 0),
	AV_WORKFLOW_ID INT(6),
	AV_MAPID INT(6),
	AV_MAP_NUMBER INT(3),
	AV_APPROVAL_STOP_NUMBER INT(3),
	AV_APPROVER_NUMBER INT(3),
	AV_PRIMARY_APPROVER_FLAG VARCHAR(1),
	AV_APPROVAL_STATUS VARCHAR(1),
	AV_UPDATE_USER VARCHAR(100),
	AV_SUBMODULE_CODE DECIMAL(3, 0),
	AV_SUB_MODULE_ITEM_KEY VARCHAR(20),
	AV_RULE_ID INT(6),
	AV_STOP_NAME VARCHAR(200),
	AV_MAP_NAME VARCHAR(200),
	AV_MAP_DESCRIPTION VARCHAR(200)
)
    DETERMINISTIC
BEGIN
DECLARE LS_LEAD_UNIT VARCHAR(50);
DECLARE LL_FULL_NAME VARCHAR(90);
DECLARE LL_EMAIL_ADDRESS VARCHAR(60);
DECLARE LI_TEMP_PERSON_ID LONGTEXT;
DECLARE TMP_PERSON_LIST LONGTEXT;
DECLARE LI_PERSON VARCHAR(40);
DECLARE LS_CODE CHAR(5) DEFAULT '00000';
DECLARE LS_MSG TEXT;
DECLARE LI_FLAG INT;
DECLARE LS_AWARD_ID VARCHAR(22);
DECLARE LS_ACTIVE_AWARD_ID VARCHAR(22);
DECLARE LI_PERSON_COUNT INT;
DECLARE LS_ADMIN_PERSON_ID VARCHAR(22);
DECLARE LI_COUNT INT;
DECLARE LI_MODULE_CODE INT(3);
DECLARE LS_MODULE_ITEM_KEY VARCHAR(20);
DECLARE LS_IS_SYSTEM_GENERATED varchar(1);
DECLARE CONTINUE HANDLER FOR SQLEXCEPTION 
BEGIN
	GET DIAGNOSTICS CONDITION 1 LS_CODE = RETURNED_SQLSTATE,LS_MSG = MESSAGE_TEXT;
END;

IF AV_MODULE_CODE = 1 THEN
        SELECT T2.AWARD_ID INTO LS_ACTIVE_AWARD_ID
        FROM AWARD T1,AWARD T2
        WHERE T1.AWARD_ID = AV_MODULE_ITEM_ID
        AND T1.AWARD_NUMBER = T2.AWARD_NUMBER
        AND T2.AWARD_SEQUENCE_STATUS = 'ACTIVE';
			IF LS_ACTIVE_AWARD_ID IS NOT NULL THEN
					SET AV_MODULE_ITEM_ID = LS_ACTIVE_AWARD_ID;
			END IF;
			SELECT LEAD_UNIT_NUMBER INTO LS_LEAD_UNIT
			FROM AWARD
			WHERE AWARD_ID = AV_MODULE_ITEM_ID;
ELSEIF AV_MODULE_CODE = 2 THEN
        SELECT HOME_UNIT_NUMBER INTO LS_LEAD_UNIT
        FROM PROPOSAL
        WHERE PROPOSAL_ID = AV_MODULE_ITEM_ID;				  
ELSEIF AV_MODULE_CODE = 3 THEN
        SELECT HOME_UNIT_NUMBER INTO LS_LEAD_UNIT
        FROM EPS_PROPOSAL
        WHERE PROPOSAL_ID = AV_MODULE_ITEM_ID;
ELSEIF AV_MODULE_CODE = 12 THEN
        SELECT UNIT_NUMBER INTO LS_LEAD_UNIT
        FROM AGREEMENT_HEADER
        WHERE AGREEMENT_REQUEST_ID = AV_MODULE_ITEM_ID;
        IF LS_LEAD_UNIT IS NULL THEN
                SELECT UNIT_NUMBER INTO LS_LEAD_UNIT
                FROM UNIT
                WHERE PARENT_UNIT_NUMBER IS NULL;
        END IF;
ELSEIF AV_MODULE_CODE = 13 THEN
	SELECT UNIT_NUMBER INTO LS_LEAD_UNIT
	FROM AGREEMENT_HEADER
	WHERE AGREEMENT_REQUEST_ID = AV_MODULE_ITEM_ID;
ELSEIF AV_MODULE_CODE = 14 THEN
        SELECT LEAD_UNIT_NUMBER,AWARD_ID INTO LS_LEAD_UNIT,LS_AWARD_ID
        FROM AWARD
        WHERE AWARD_ID IN(
                SELECT AWARD_ID
                FROM CLAIM
                WHERE CLAIM_ID = AV_MODULE_ITEM_ID);
ELSEIF AV_MODULE_CODE = 15 THEN
        SELECT HOME_UNIT_NUMBER INTO LS_LEAD_UNIT
        FROM GRANT_CALL_HEADER
        WHERE GRANT_HEADER_ID = AV_MODULE_ITEM_ID;
ELSEIF AV_MODULE_CODE = 16 THEN
        SELECT LEAD_UNIT_NUMBER,AWARD_ID INTO LS_LEAD_UNIT,LS_AWARD_ID
        FROM AWARD
        WHERE AWARD_ID IN(
                SELECT AWARD_ID
                FROM AWARD_PROGRESS_REPORT
                WHERE PROGRESS_REPORT_ID = AV_MODULE_ITEM_ID);
ELSEIF AV_MODULE_CODE = 20 THEN
        SELECT ORIGINATING_MODULE_CODE,ORIGINATING_MODULE_ITEM_KEY INTO LI_MODULE_CODE,LS_MODULE_ITEM_KEY
        FROM SR_HEADER T1
        WHERE T1.SR_HEADER_ID = AV_MODULE_ITEM_ID;
        IF LI_MODULE_CODE = 1 THEN
                SELECT AWARD_ID,LEAD_UNIT_NUMBER INTO LS_AWARD_ID,LS_LEAD_UNIT
                FROM AWARD
                WHERE AWARD_ID = LS_MODULE_ITEM_KEY;
        ELSEIF LI_MODULE_CODE = 3 THEN
                SELECT HOME_UNIT_NUMBER INTO LS_LEAD_UNIT
                FROM EPS_PROPOSAL
                WHERE PROPOSAL_ID = LS_MODULE_ITEM_KEY;
        END IF;
ELSEIF AV_MODULE_CODE = 21 THEN
        SELECT FUNDING_OFFICE INTO LS_LEAD_UNIT
        FROM EXTERNAL_USER
        WHERE PERSON_ID = AV_MODULE_ITEM_ID;
END IF;
-- role_type start
IF AV_ROLE_TYPE = 5 THEN 
        IF AV_MODULE_CODE = 1 THEN
                SELECT GROUP_CONCAT(T2.PERSON_ID) into  LI_TEMP_PERSON_ID
                FROM AWARD T1
                INNER JOIN AWARD_PERSONS T2 ON T1.AWARD_ID = T2.AWARD_ID
                INNER JOIN PERSON T3 ON T2.PERSON_ID = T3.PERSON_ID
                WHERE T1.AWARD_ID = AV_MODULE_ITEM_ID
                AND T2.PERSON_ROLE_ID = 3
                AND T3.STATUS = 'A';
        ELSEIF AV_MODULE_CODE = 3 THEN
                SELECT GROUP_CONCAT(T2.PERSON_ID) into  LI_TEMP_PERSON_ID
                FROM EPS_PROPOSAL T1
                INNER JOIN EPS_PROPOSAL_PERSONS T2 ON T1.PROPOSAL_ID = T2.PROPOSAL_ID
                AND T2.PROP_PERSON_ROLE_ID = 3
                INNER JOIN PERSON T3 ON T2.PERSON_ID = T3.PERSON_ID
                WHERE T1.PROPOSAL_ID = AV_MODULE_ITEM_ID
                AND T3.STATUS = 'A';
        ELSEIF AV_MODULE_CODE = 13 THEN
                SELECT GROUP_CONCAT(DISTINCT T1.PERSON_ID) INTO LI_TEMP_PERSON_ID
                FROM AGREEMENT_PEOPLE T1
                INNER JOIN PERSON T2 ON T1.PERSON_ID = T2.PERSON_ID
                WHERE T1.AGREEMENT_REQUEST_ID = AV_MODULE_ITEM_ID
                AND T1.PEOPLE_TYPE_ID = 3
                AND T2.STATUS = 'A';
        ELSEIF AV_MODULE_CODE = 14 THEN
                SELECT GROUP_CONCAT(T2.PERSON_ID) into  LI_TEMP_PERSON_ID
                FROM CLAIM T
                INNER JOIN AWARD T1 ON T.AWARD_ID = T1.AWARD_ID
                INNER JOIN AWARD_PERSONS T2 ON T1.AWARD_ID = T2.AWARD_ID
                INNER JOIN PERSON T3 ON T3.PERSON_ID = T2.PERSON_ID
                WHERE T.CLAIM_ID = AV_MODULE_ITEM_ID
                AND T2.PERSON_ROLE_ID = 3
                AND T3.STATUS = 'A';
		ELSEIF AV_MODULE_CODE = 16 THEN
                SELECT GROUP_CONCAT(T2.PERSON_ID) into  LI_TEMP_PERSON_ID
                FROM AWARD T1
                INNER JOIN AWARD_PERSONS T2 ON T1.AWARD_ID = T2.AWARD_ID
                INNER JOIN PERSON T3 ON T2.PERSON_ID = T3.PERSON_ID
                WHERE T1.AWARD_ID = LS_AWARD_ID
                AND T2.PERSON_ROLE_ID = 3
                AND T3.STATUS = 'A';
        ELSEIF AV_MODULE_CODE = 20 THEN
                SELECT ORIGINATING_MODULE_CODE,ORIGINATING_MODULE_ITEM_KEY, IS_SYSTEM_GENERATED 
				INTO LI_MODULE_CODE, LS_MODULE_ITEM_KEY, LS_IS_SYSTEM_GENERATED
                FROM SR_HEADER T1
                WHERE T1.SR_HEADER_ID = AV_MODULE_ITEM_ID;
                IF LI_MODULE_CODE = 1 THEN
                        SELECT GROUP_CONCAT(T2.PERSON_ID) into  LI_TEMP_PERSON_ID
                        FROM AWARD T1
                        INNER JOIN AWARD_PERSONS T2 ON T1.AWARD_ID = T2.AWARD_ID
                        INNER JOIN PERSON T3 ON T2.PERSON_ID = T3.PERSON_ID
                        WHERE T1.AWARD_ID = LS_AWARD_ID
                        AND T2.PERSON_ROLE_ID = 3
                        AND T3.STATUS = 'A';
                ELSEIF LI_MODULE_CODE IS NULL and LS_IS_SYSTEM_GENERATED = 'N' THEN
				        Select GROUP_CONCAT(T1.PERSON_ID)  into  LI_TEMP_PERSON_ID
                        from sr_persons T1 
						INNER JOIN PERSON T2 ON T2.PERSON_ID = T1.PERSON_ID
						Where T1.PERSON_ROLE_ID = 3 
						AND T1.SR_HEADER_ID = AV_MODULE_ITEM_ID 
						And T2.STATUS = 'A';
                END IF;
        END IF;
ELSEIF AV_ROLE_TYPE = 6 THEN 
	IF AV_MODULE_CODE = 1 THEN
		SELECT GROUP_CONCAT(T2.PERSON_ID) INTO LI_TEMP_PERSON_ID
		FROM AWARD T1
		INNER JOIN AWARD_PERSONS T2 ON T1.AWARD_ID = T2.AWARD_ID
		INNER JOIN PERSON T3 ON T2.PERSON_ID = T3.PERSON_ID
		WHERE T1.AWARD_ID = AV_MODULE_ITEM_ID
		AND T3.STATUS = 'A';
	ELSEIF AV_MODULE_CODE = 3 THEN
		SELECT GROUP_CONCAT(T1.PERSON_ID) INTO LI_TEMP_PERSON_ID
		FROM EPS_PROPOSAL_PERSONS T1
		INNER JOIN PERSON T2 ON T2.PERSON_ID = T1.PERSON_ID
		WHERE T1.PROPOSAL_ID = AV_MODULE_ITEM_ID
		AND T2.STATUS = 'A';
	ELSEIF AV_MODULE_CODE = 20 THEN
               SELECT ORIGINATING_MODULE_CODE,ORIGINATING_MODULE_ITEM_KEY, IS_SYSTEM_GENERATED 
				INTO LI_MODULE_CODE, LS_MODULE_ITEM_KEY, LS_IS_SYSTEM_GENERATED
                FROM SR_HEADER T1
                WHERE T1.SR_HEADER_ID = AV_MODULE_ITEM_ID;
                IF LI_MODULE_CODE = 1 THEN
                        SELECT GROUP_CONCAT(T2.PERSON_ID) into  LI_TEMP_PERSON_ID
                        FROM AWARD T1
                        INNER JOIN AWARD_PERSONS T2 ON T1.AWARD_ID = T2.AWARD_ID
                        INNER JOIN PERSON T3 ON T2.PERSON_ID = T3.PERSON_ID
                        WHERE T1.AWARD_ID = LS_AWARD_ID
                        AND T3.STATUS = 'A';
                ELSEIF LI_MODULE_CODE IS NULL and LS_IS_SYSTEM_GENERATED = 'N' THEN
				       Select GROUP_CONCAT(T1.PERSON_ID) into  LI_TEMP_PERSON_ID
                       FROM sr_persons T1 
					   INNER JOIN PERSON T2 ON T2.PERSON_ID = T1.PERSON_ID
					   WHERE T1.SR_HEADER_ID = AV_MODULE_ITEM_ID 
                       AND T2.STATUS = 'A';
                END IF;
	END IF;
	
ELSEIF AV_ROLE_TYPE = 13 THEN 
IF AV_MODULE_CODE = 3 THEN
		WITH 
		grant_unit_temp as (
						select HOME_UNIT_NUMBER from grant_call_header 
						where GRANT_HEADER_ID in (select GRANT_HEADER_ID from eps_proposal where PROPOSAL_ID = AV_MODULE_ITEM_ID))
		,unit_TMP 	AS(
						SELECT UNIT_NUMBER
						FROM PERSON_ROLES T1
						WHERE T1.UNIT_NUMBER = (select HOME_UNIT_NUMBER from grant_unit_temp)
						AND T1.ROLE_ID = 100							
						UNION
						SELECT UNIT_NUMBER
						FROM PERSON_ROLES T1
						where T1.UNIT_NUMBER in (
						SELECT UNIT_NUMBER  FROM UNIT_WITH_CHILDREN 
						WHERE CHILD_UNIT_NUMBER = (select HOME_UNIT_NUMBER from grant_unit_temp)
						AND T1.ROLE_ID = 100
					)) 
		SELECT  count(distinct T1.PERSON_ID) into LI_PERSON_COUNT
		FROM PERSON_ROLES T1
		INNER JOIN PERSON T2 ON T1.PERSON_ID = T2.PERSON_ID
		WHERE T1.ROLE_ID = 100
		AND T1.UNIT_NUMBER in (select unit_number from unit_TMP)
		AND T2.STATUS = 'A';

	IF LI_PERSON_COUNT = 0 THEN
		SELECT COUNT(1) INTO LI_FLAG
		FROM EPS_PROPOSAL T1
		INNER JOIN GRANT_CALL_HEADER T2 ON T1.GRANT_HEADER_ID = T2.GRANT_HEADER_ID
		WHERE T1.PROPOSAL_ID = AV_MODULE_ITEM_ID
		AND T1.GRANT_HEADER_ID IS NOT NULL
		AND T2.HOME_UNIT_NUMBER <> (SELECT VALUE FROM PARAMETER WHERE PARAMETER_NAME = 'ROOT_UNIT');
		
									IF LI_FLAG > 0 THEN
										SELECT T2.HOME_UNIT_NUMBER INTO LS_LEAD_UNIT
										FROM EPS_PROPOSAL T1
										INNER JOIN GRANT_CALL_HEADER T2 ON T1.GRANT_HEADER_ID = T2.GRANT_HEADER_ID
										WHERE T1.PROPOSAL_ID = AV_MODULE_ITEM_ID;
									ELSE
												WITH ACCESS_TMP 
													AS
													(SELECT UNIT_NUMBER
													FROM PERSON_ROLES T1
													WHERE T1.UNIT_NUMBER = (select HOME_UNIT_NUMBER from eps_proposal where PROPOSAL_ID = AV_MODULE_ITEM_ID)
													AND T1.ROLE_ID = 100							
													UNION
													SELECT UNIT_NUMBER
													FROM PERSON_ROLES T1
													where T1.UNIT_NUMBER in (
													SELECT UNIT_NUMBER  FROM UNIT_WITH_CHILDREN 
													WHERE CHILD_UNIT_NUMBER = (select HOME_UNIT_NUMBER from eps_proposal where PROPOSAL_ID = AV_MODULE_ITEM_ID))
													AND T1.ROLE_ID = 100
												) SELECT  SUBSTRING_INDEX(GROUP_CONCAT(T1.UNIT_NUMBER), ',', -1) into LS_LEAD_UNIT
												FROM PERSON_ROLES T1
												INNER JOIN PERSON T2 ON T1.PERSON_ID = T2.PERSON_ID
												WHERE T1.ROLE_ID = 100
												AND T1.UNIT_NUMBER in (select unit_number from ACCESS_TMP)
												AND T2.STATUS = 'A';
						
									END IF;
						SELECT GROUP_CONCAT(distinct T1.PERSON_ID) INTO LI_TEMP_PERSON_ID
						FROM PERSON_ROLES T1
						INNER JOIN PERSON T2 ON T1.PERSON_ID = T2.PERSON_ID
						WHERE T1.ROLE_ID = 100
						AND T1.UNIT_NUMBER = LS_LEAD_UNIT
						AND T2.STATUS = 'A';
	ELSE
		WITH 
		grant_unit_temp as (
		select HOME_UNIT_NUMBER from grant_call_header 
		where GRANT_HEADER_ID in (select GRANT_HEADER_ID from eps_proposal where PROPOSAL_ID = AV_MODULE_ITEM_ID))
		,unit_TMP 	AS
			(SELECT UNIT_NUMBER
			FROM PERSON_ROLES T1
			WHERE T1.UNIT_NUMBER = (select HOME_UNIT_NUMBER from grant_unit_temp)
			AND T1.ROLE_ID = 100							
			UNION
			SELECT UNIT_NUMBER
			FROM PERSON_ROLES T1
			where T1.UNIT_NUMBER in (
			SELECT UNIT_NUMBER  FROM UNIT_WITH_CHILDREN 
			WHERE CHILD_UNIT_NUMBER = (select HOME_UNIT_NUMBER from grant_unit_temp)
			AND T1.ROLE_ID = 100
		)) 
		SELECT  SUBSTRING_INDEX(GROUP_CONCAT(T1.PERSON_ID), ',', -1) into LI_TEMP_PERSON_ID
		FROM PERSON_ROLES T1
		INNER JOIN PERSON T2 ON T1.PERSON_ID = T2.PERSON_ID
		WHERE T1.ROLE_ID = 100
		AND T1.UNIT_NUMBER in (select unit_number from unit_TMP)
		AND T2.STATUS = 'A';
	END IF;
ELSEIF AV_MODULE_CODE = 1 THEN
	WITH 
		grant_unit_temp as (
						select HOME_UNIT_NUMBER from grant_call_header 
						where GRANT_HEADER_ID in (select GRANT_HEADER_ID from award where award_id = AV_MODULE_ITEM_ID))
		,unit_TMP 	AS(
						SELECT UNIT_NUMBER
						FROM PERSON_ROLES T1
						WHERE T1.UNIT_NUMBER = (select HOME_UNIT_NUMBER from grant_unit_temp)
						AND T1.ROLE_ID = 100							
						UNION
						SELECT UNIT_NUMBER
						FROM PERSON_ROLES T1
						where T1.UNIT_NUMBER in (
						SELECT UNIT_NUMBER  FROM UNIT_WITH_CHILDREN 
						WHERE CHILD_UNIT_NUMBER = (select HOME_UNIT_NUMBER from grant_unit_temp)
						AND T1.ROLE_ID = 100
					)) 
		SELECT  count(distinct T1.PERSON_ID) into LI_PERSON_COUNT
		FROM PERSON_ROLES T1
		INNER JOIN PERSON T2 ON T1.PERSON_ID = T2.PERSON_ID
		WHERE T1.ROLE_ID = 100
		AND T1.UNIT_NUMBER in (select unit_number from unit_TMP)
		AND T2.STATUS = 'A';

	IF LI_PERSON_COUNT = 0 THEN
		SELECT COUNT(1) INTO LI_FLAG
		FROM award T1
		INNER JOIN GRANT_CALL_HEADER T2 ON T1.GRANT_HEADER_ID = T2.GRANT_HEADER_ID
		WHERE T1.award_id = AV_MODULE_ITEM_ID
		AND T1.GRANT_HEADER_ID IS NOT NULL
		AND T2.HOME_UNIT_NUMBER <> (SELECT VALUE FROM PARAMETER WHERE PARAMETER_NAME = 'ROOT_UNIT');
		
									IF LI_FLAG > 0 THEN
										SELECT T2.HOME_UNIT_NUMBER INTO LS_LEAD_UNIT
										FROM award T1
										INNER JOIN GRANT_CALL_HEADER T2 ON T1.GRANT_HEADER_ID = T2.GRANT_HEADER_ID
										WHERE T1.award_id = AV_MODULE_ITEM_ID;
									ELSE
												WITH ACCESS_TMP 
													AS
													(SELECT UNIT_NUMBER
													FROM PERSON_ROLES T1
													WHERE T1.UNIT_NUMBER = (select LEAD_UNIT_NUMBER from award where award_id = AV_MODULE_ITEM_ID)
													AND T1.ROLE_ID = 100							
													UNION
													SELECT UNIT_NUMBER
													FROM PERSON_ROLES T1
													where T1.UNIT_NUMBER in (
													SELECT UNIT_NUMBER  FROM UNIT_WITH_CHILDREN 
													WHERE CHILD_UNIT_NUMBER = (select LEAD_UNIT_NUMBER from award where award_id = AV_MODULE_ITEM_ID))
													AND T1.ROLE_ID = 100
												) SELECT  SUBSTRING_INDEX(GROUP_CONCAT(T1.UNIT_NUMBER), ',', -1) into LS_LEAD_UNIT
												FROM PERSON_ROLES T1
												INNER JOIN PERSON T2 ON T1.PERSON_ID = T2.PERSON_ID
												WHERE T1.ROLE_ID = 100
												AND T1.UNIT_NUMBER in (select unit_number from ACCESS_TMP)
												AND T2.STATUS = 'A';
						
									END IF;
						SELECT GROUP_CONCAT(distinct T1.PERSON_ID) INTO LI_TEMP_PERSON_ID
						FROM PERSON_ROLES T1
						INNER JOIN PERSON T2 ON T1.PERSON_ID = T2.PERSON_ID
						WHERE T1.ROLE_ID = 100
						AND T1.UNIT_NUMBER = LS_LEAD_UNIT
						AND T2.STATUS = 'A';
	ELSE
		WITH 
		grant_unit_temp as (
		select HOME_UNIT_NUMBER from grant_call_header 
		where GRANT_HEADER_ID in (select GRANT_HEADER_ID from award where award_id = AV_MODULE_ITEM_ID))
		,unit_TMP 	AS
			(SELECT UNIT_NUMBER
			FROM PERSON_ROLES T1
			WHERE T1.UNIT_NUMBER = (select HOME_UNIT_NUMBER from grant_unit_temp)
			AND T1.ROLE_ID = 100							
			UNION
			SELECT UNIT_NUMBER
			FROM PERSON_ROLES T1
			where T1.UNIT_NUMBER in (
			SELECT UNIT_NUMBER  FROM UNIT_WITH_CHILDREN 
			WHERE CHILD_UNIT_NUMBER = (select HOME_UNIT_NUMBER from grant_unit_temp)
			AND T1.ROLE_ID = 100
		)) 
		SELECT  SUBSTRING_INDEX(GROUP_CONCAT(T1.PERSON_ID), ',', -1) into LI_TEMP_PERSON_ID
		FROM PERSON_ROLES T1
		INNER JOIN PERSON T2 ON T1.PERSON_ID = T2.PERSON_ID
		WHERE T1.ROLE_ID = 100
		AND T1.UNIT_NUMBER in (select unit_number from unit_TMP)
		AND T2.STATUS = 'A';
	END IF;
ELSEIF AV_MODULE_CODE in (14, 16) THEN
	WITH 
		grant_unit_temp as (
						select HOME_UNIT_NUMBER from grant_call_header 
						where GRANT_HEADER_ID in (select GRANT_HEADER_ID from award where award_id = LS_AWARD_ID))
		,unit_TMP 	AS(
						SELECT UNIT_NUMBER
						FROM PERSON_ROLES T1
						WHERE T1.UNIT_NUMBER = (select HOME_UNIT_NUMBER from grant_unit_temp)
						AND T1.ROLE_ID = 100							
						UNION
						SELECT UNIT_NUMBER
						FROM PERSON_ROLES T1
						where T1.UNIT_NUMBER in (
						SELECT UNIT_NUMBER  FROM UNIT_WITH_CHILDREN 
						WHERE CHILD_UNIT_NUMBER = (select HOME_UNIT_NUMBER from grant_unit_temp)
						AND T1.ROLE_ID = 100
					)) 
		SELECT  count(distinct T1.PERSON_ID) into LI_PERSON_COUNT
		FROM PERSON_ROLES T1
		INNER JOIN PERSON T2 ON T1.PERSON_ID = T2.PERSON_ID
		WHERE T1.ROLE_ID = 100
		AND T1.UNIT_NUMBER in (select unit_number from unit_TMP)
		AND T2.STATUS = 'A';

	IF LI_PERSON_COUNT = 0 THEN
		SELECT COUNT(1) INTO LI_FLAG
		FROM award T1
		INNER JOIN GRANT_CALL_HEADER T2 ON T1.GRANT_HEADER_ID = T2.GRANT_HEADER_ID
		WHERE T1.award_id = LS_AWARD_ID
		AND T1.GRANT_HEADER_ID IS NOT NULL
		AND T2.HOME_UNIT_NUMBER <> (SELECT VALUE FROM PARAMETER WHERE PARAMETER_NAME = 'ROOT_UNIT');
		
									IF LI_FLAG > 0 THEN
										SELECT T2.HOME_UNIT_NUMBER INTO LS_LEAD_UNIT
										FROM award T1
										INNER JOIN GRANT_CALL_HEADER T2 ON T1.GRANT_HEADER_ID = T2.GRANT_HEADER_ID
										WHERE T1.award_id = LS_AWARD_ID;
									ELSE
												WITH ACCESS_TMP 
													AS
													(SELECT UNIT_NUMBER
													FROM PERSON_ROLES T1
													WHERE T1.UNIT_NUMBER = (select LEAD_UNIT_NUMBER from award where award_id = LS_AWARD_ID)
													AND T1.ROLE_ID = 100							
													UNION
													SELECT UNIT_NUMBER
													FROM PERSON_ROLES T1
													where T1.UNIT_NUMBER in (
													SELECT UNIT_NUMBER  FROM UNIT_WITH_CHILDREN 
													WHERE CHILD_UNIT_NUMBER = (select LEAD_UNIT_NUMBER from award where award_id = LS_AWARD_ID))
													AND T1.ROLE_ID = 100
												) SELECT  SUBSTRING_INDEX(GROUP_CONCAT(T1.UNIT_NUMBER), ',', -1) into LS_LEAD_UNIT
												FROM PERSON_ROLES T1
												INNER JOIN PERSON T2 ON T1.PERSON_ID = T2.PERSON_ID
												WHERE T1.ROLE_ID = 100
												AND T1.UNIT_NUMBER in (select unit_number from ACCESS_TMP)
												AND T2.STATUS = 'A';
						
									END IF;
						SELECT GROUP_CONCAT(distinct T1.PERSON_ID) INTO LI_TEMP_PERSON_ID
						FROM PERSON_ROLES T1
						INNER JOIN PERSON T2 ON T1.PERSON_ID = T2.PERSON_ID
						WHERE T1.ROLE_ID = 100
						AND T1.UNIT_NUMBER = LS_LEAD_UNIT
						AND T2.STATUS = 'A';
	ELSE
		WITH 
		grant_unit_temp as (
		select HOME_UNIT_NUMBER from grant_call_header 
		where GRANT_HEADER_ID in (select GRANT_HEADER_ID from award where award_id = LS_AWARD_ID))
		,unit_TMP 	AS
			(SELECT UNIT_NUMBER
			FROM PERSON_ROLES T1
			WHERE T1.UNIT_NUMBER = (select HOME_UNIT_NUMBER from grant_unit_temp)
			AND T1.ROLE_ID = 100							
			UNION
			SELECT UNIT_NUMBER
			FROM PERSON_ROLES T1
			where T1.UNIT_NUMBER in (
			SELECT UNIT_NUMBER  FROM UNIT_WITH_CHILDREN 
			WHERE CHILD_UNIT_NUMBER = (select HOME_UNIT_NUMBER from grant_unit_temp)
			AND T1.ROLE_ID = 100
		)) 
		SELECT  SUBSTRING_INDEX(GROUP_CONCAT(T1.PERSON_ID), ',', -1) into LI_TEMP_PERSON_ID
		FROM PERSON_ROLES T1
		INNER JOIN PERSON T2 ON T1.PERSON_ID = T2.PERSON_ID
		WHERE T1.ROLE_ID = 100
		AND T1.UNIT_NUMBER in (select unit_number from unit_TMP)
		AND T2.STATUS = 'A';
	END IF;
 END IF;
ELSEIF AV_ROLE_TYPE = 23 THEN 
        SELECT  GROUP_CONCAT(DISTINCT T3.PERSON_ID) INTO LI_TEMP_PERSON_ID
        FROM WORKFLOW T1
        INNER JOIN WORKFLOW_DETAIL T2 ON T1.WORKFLOW_ID = T2.WORKFLOW_ID
        INNER JOIN PERSON T3 ON T3.USER_NAME = T2.UPDATE_USER
        WHERE T1.MODULE_CODE = AV_MODULE_CODE
        AND T1.MODULE_ITEM_ID = AV_MODULE_ITEM_ID
        AND T1.SUB_MODULE_CODE = AV_SUBMODULE_CODE
        AND T1.SUB_MODULE_ITEM_ID = AV_SUB_MODULE_ITEM_KEY
        AND T1.MAP_TYPE = 'R'
        AND T1.IS_WORKFLOW_ACTIVE = 'Y'
        AND T2.APPROVAL_STATUS IN ('A', 'B')
        AND T3.STATUS = 'A';
ELSEIF AV_ROLE_TYPE = 24 THEN 
	SELECT DISTINCT T2.APPROVER_PERSON_ID INTO LI_TEMP_PERSON_ID
	FROM WORKFLOW T1
	INNER JOIN WORKFLOW_DETAIL T2 ON T1.WORKFLOW_ID = T2.WORKFLOW_ID
	INNER JOIN PERSON T3 ON T3.PERSON_ID = T2.APPROVER_PERSON_ID
	WHERE T1.MODULE_CODE = AV_MODULE_CODE
	AND T1.MODULE_ITEM_ID = AV_MODULE_ITEM_ID
	AND T1.SUB_MODULE_CODE = AV_SUBMODULE_CODE
	AND T1.SUB_MODULE_ITEM_ID = AV_SUB_MODULE_ITEM_KEY
	AND T1.MAP_TYPE = 'R'
	AND T1.IS_WORKFLOW_ACTIVE = 'Y'
	AND T2.APPROVAL_STATUS IN ('W')
	AND T3.STATUS = 'A';
ELSEIF AV_ROLE_TYPE = 25 THEN 
        SELECT DISTINCT T2.APPROVER_PERSON_ID INTO LI_TEMP_PERSON_ID
		FROM WORKFLOW T1
		INNER JOIN WORKFLOW_DETAIL T2 ON T1.WORKFLOW_ID = T2.WORKFLOW_ID
		INNER JOIN PERSON T3 ON T3.PERSON_ID = T2.APPROVER_PERSON_ID
		WHERE T1.MODULE_CODE = AV_MODULE_CODE
		AND T1.MODULE_ITEM_ID = AV_MODULE_ITEM_ID
		AND T1.SUB_MODULE_CODE = AV_SUBMODULE_CODE
		AND T1.SUB_MODULE_ITEM_ID = AV_SUB_MODULE_ITEM_KEY
		AND T1.MAP_TYPE = 'R'
		AND T1.IS_WORKFLOW_ACTIVE = 'Y'
		AND T3.STATUS = 'A';
ELSEIF AV_ROLE_TYPE = 35 THEN 
	IF AV_MODULE_CODE = 13 THEN
      SELECT T1.ADMIN_PERSON_ID INTO LS_ADMIN_PERSON_ID
			FROM AGREEMENT_HEADER T1
			INNER JOIN PERSON T2 ON T1.ADMIN_PERSON_ID = T2.PERSON_ID
			WHERE AGREEMENT_REQUEST_ID = AV_MODULE_ITEM_ID
			AND T2.STATUS = 'A';
		    IF LS_ADMIN_PERSON_ID IS NULL THEN
			       WITH ACCESS_TMP 
													AS
													(SELECT UNIT_NUMBER
													FROM PERSON_ROLES T1
													WHERE T1.UNIT_NUMBER = (select UNIT_NUMBER from agreement_header where AGREEMENT_REQUEST_ID = AV_MODULE_ITEM_ID)
													AND T1.ROLE_ID = 1300							
													UNION
													SELECT UNIT_NUMBER
													FROM PERSON_ROLES T1
													where T1.UNIT_NUMBER in (
													SELECT UNIT_NUMBER  FROM UNIT_WITH_CHILDREN 
													WHERE CHILD_UNIT_NUMBER = (select UNIT_NUMBER from agreement_header where AGREEMENT_REQUEST_ID = AV_MODULE_ITEM_ID))
													AND T1.ROLE_ID = 1300
												) 
			SELECT GROUP_CONCAT(distinct PR.PERSON_ID) INTO LI_TEMP_PERSON_ID
			FROM PERSON_ROLES PR JOIN 
			(SELECT ROLE_ID,RT.RIGHT_NAME 
			   FROM ROLE_RIGHTS RR,
					RIGHTS RT
				WHERE RR.RIGHT_ID = RT.RIGHT_ID
			) RLE ON RLE.ROLE_ID = PR.ROLE_ID AND RLE.ROLE_ID =1300 
			JOIN PERSON P ON PR.PERSON_ID=P.PERSON_ID AND P.STATUS='A'
			WHERE  PR.UNIT_NUMBER in (select UNIT_NUMBER from ACCESS_TMP);	
    ELSE 
       SELECT T1.ADMIN_PERSON_ID INTO LI_TEMP_PERSON_ID
			FROM AGREEMENT_HEADER T1
			INNER JOIN PERSON T2 ON T1.ADMIN_PERSON_ID = T2.PERSON_ID
			WHERE AGREEMENT_REQUEST_ID = AV_MODULE_ITEM_ID
			AND T2.STATUS = 'A';
		END IF;
	END IF;
ELSEIF AV_ROLE_TYPE = 46 THEN
	IF AV_MODULE_CODE = 1 THEN
			SELECT T1.PERSON_ID INTO LI_TEMP_PERSON_ID
			FROM PERSON T1 WHERE T1.USER_NAME = (SELECT CREATE_USER 
												FROM AWARD
												WHERE AWARD_ID = AV_MODULE_ITEM_ID)
			   AND T1.STATUS = 'A';
		ELSEIF AV_MODULE_CODE = 3 THEN
                        SELECT T2.PERSON_ID INTO LI_TEMP_PERSON_ID
						FROM PERSON T2 WHERE T2.USER_NAME = (SELECT CREATE_USER 
						FROM eps_proposal
						WHERE PROPOSAL_ID = AV_MODULE_ITEM_ID) AND T2.STATUS = 'A';
        ELSEIF AV_MODULE_CODE = 20 THEN
                        SELECT T2.PERSON_ID INTO LI_TEMP_PERSON_ID
						FROM PERSON T2 WHERE T2.USER_NAME = (SELECT CREATE_USER 
						FROM SR_HEADER
						WHERE SR_HEADER_ID = AV_MODULE_ITEM_ID) AND T2.STATUS = 'A';
		ELSEIF AV_MODULE_CODE = 13 THEN
                        SELECT T2.PERSON_ID INTO LI_TEMP_PERSON_ID
						FROM PERSON T2 WHERE T2.USER_NAME = (SELECT CREATE_USER 
						FROM agreement_header
						WHERE AGREEMENT_REQUEST_ID = AV_MODULE_ITEM_ID) AND T2.STATUS = 'A';
		ELSEIF AV_MODULE_CODE = 16 THEN
                        SELECT T2.PERSON_ID INTO LI_TEMP_PERSON_ID
						FROM PERSON T2 WHERE T2.USER_NAME = (SELECT CREATE_USER 
						FROM award_progress_report
						WHERE AWARD_ID = AV_MODULE_ITEM_ID) AND T2.STATUS = 'A';
		ELSEIF AV_MODULE_CODE = 14 THEN
                        SELECT T2.PERSON_ID INTO LI_TEMP_PERSON_ID
						FROM PERSON T2 WHERE T2.USER_NAME = (SELECT CREATE_USER 
						FROM claim
						WHERE AWARD_ID = AV_MODULE_ITEM_ID) AND T2.STATUS = 'A';
    END IF;
ELSEIF AV_ROLE_TYPE = 47 THEN
  IF AV_MODULE_CODE in(1,3,13,20) THEN
				SELECT count(T1.WORKFLOW_START_PERSON) into LI_COUNT
				FROM WORKFLOW T1, PERSON P
				WHERE T1.MODULE_CODE = AV_MODULE_CODE
				AND T1.MODULE_ITEM_ID = AV_MODULE_ITEM_ID
				AND T1.IS_WORKFLOW_ACTIVE = 'Y'
				AND T1.WORKFLOW_SEQUENCE = (SELECT MAX(T2.WORKFLOW_SEQUENCE)
											FROM  WORKFLOW T2
											WHERE T2.MODULE_CODE = AV_MODULE_CODE 
											AND T2.MODULE_ITEM_ID =T1.MODULE_ITEM_ID
											AND T2.IS_WORKFLOW_ACTIVE = 'Y'
											)
				AND P.PERSON_ID = T1.WORKFLOW_START_PERSON
                and T1.WORKFLOW_ID in (select WORKFLOW_id from workflow_detail)
				AND P.STATUS = 'A';
		IF LI_COUNT > 0 then
			SELECT T1.WORKFLOW_START_PERSON INTO LI_TEMP_PERSON_ID
			FROM WORKFLOW T1,
			PERSON P
			WHERE T1.MODULE_CODE = AV_MODULE_CODE
			AND T1.MODULE_ITEM_ID = AV_MODULE_ITEM_ID
			AND T1.IS_WORKFLOW_ACTIVE = 'Y'
			AND T1.WORKFLOW_SEQUENCE = (SELECT MAX(T2.WORKFLOW_SEQUENCE)
										FROM  WORKFLOW T2
										WHERE T2.MODULE_CODE = AV_MODULE_CODE
										AND T2.MODULE_ITEM_ID = T1.MODULE_ITEM_ID
										AND T2.IS_WORKFLOW_ACTIVE = 'Y'
										)
			AND P.PERSON_ID = T1.WORKFLOW_START_PERSON
            and T1.WORKFLOW_ID in (select WORKFLOW_id from workflow_detail)
			AND P.STATUS = 'A';  
		ELSE
		IF AV_MODULE_CODE = 1 THEN
				select  p.person_id INTO LI_TEMP_PERSON_ID
                from award a, person p
                where a.award_id = AV_MODULE_ITEM_ID
                 and p.user_name = a.submit_user 
                and p.status = 'A';
			ELSEIF AV_MODULE_CODE = 3 THEN
				select  p.person_id INTO LI_TEMP_PERSON_ID
                from eps_proposal e,person p 
                where proposal_id = AV_MODULE_ITEM_ID
                 and p.user_name = e.submit_user 
                and p.status = 'A';
			ELSEIF AV_MODULE_CODE = 13 THEN
				select p.person_id INTO LI_TEMP_PERSON_ID
                from agreement_header a, person p  
                where a.AGREEMENT_REQUEST_ID = AV_MODULE_ITEM_ID
                and p.user_name = a.submit_user 
                and p.status = 'A'
                and a.AGREEMENT_REQUEST_ID in (select max(AGREEMENT_REQUEST_ID) from agreement_header where AGREEMENT_REQUEST_ID = AV_MODULE_ITEM_ID);
			ELSEIF AV_MODULE_CODE = 20 THEN
				SELECT p.person_id INTO LI_TEMP_PERSON_ID 
                FROM sr_action_log sr, person p 
                where sr.ACTION_TYPE_CODE = 2 
                and p.user_name = sr.UPDATE_USER 
                and sr.SR_HEADER_ID = AV_MODULE_ITEM_ID
                and p.status = 'A'
                and ACTION_LOG_ID in (select max(ACTION_LOG_ID) from sr_action_log where SR_HEADER_ID = AV_MODULE_ITEM_ID);
			END IF;
		END IF;	
  ELSEIF AV_MODULE_CODE in(14,16) THEN  
		SELECT count(T1.WORKFLOW_START_PERSON) into LI_COUNT
		FROM WORKFLOW T1,
		PERSON P
		WHERE T1.MODULE_CODE = AV_MODULE_CODE
		AND T1.MODULE_ITEM_ID = LS_AWARD_ID
		AND T1.IS_WORKFLOW_ACTIVE = 'Y'
		AND T1.WORKFLOW_SEQUENCE = (SELECT MAX(T2.WORKFLOW_SEQUENCE)
									FROM  WORKFLOW T2
									WHERE T2.MODULE_CODE = AV_MODULE_CODE
									AND T2.MODULE_ITEM_ID = T1.MODULE_ITEM_ID
									AND T2.IS_WORKFLOW_ACTIVE = 'Y'
									)
		AND P.PERSON_ID = T1.WORKFLOW_START_PERSON
		AND P.STATUS = 'A';

		IF LI_COUNT > 0 then
			SELECT T1.WORKFLOW_START_PERSON INTO LI_TEMP_PERSON_ID
			FROM WORKFLOW T1,
			PERSON P
			WHERE T1.MODULE_CODE = AV_MODULE_CODE 
			AND T1.MODULE_ITEM_ID = AV_MODULE_ITEM_ID
			AND T1.IS_WORKFLOW_ACTIVE = 'Y'
			AND T1.WORKFLOW_SEQUENCE = (SELECT MAX(T2.WORKFLOW_SEQUENCE)
										FROM  WORKFLOW T2
										WHERE T2.MODULE_CODE = AV_MODULE_CODE
										AND T2.MODULE_ITEM_ID = T1.MODULE_ITEM_ID
										AND T2.IS_WORKFLOW_ACTIVE = 'Y'
										)
			AND P.PERSON_ID = T1.WORKFLOW_START_PERSON
			AND P.STATUS = 'A';   
		ELSE
			IF AV_MODULE_CODE = 14 THEN
				select p.person_id  INTO LI_TEMP_PERSON_ID 
                from claim c, person p
                where CLAIM_ID = AV_MODULE_CODE
                and c.CLAIM_SUBMIT_USER = p.user_name
                and p.status = 'A';
			ELSEIF AV_MODULE_CODE = 16 THEN
				select p.person_id INTO LI_TEMP_PERSON_ID 
                from award_progress_report  a,  person p
                where a.PROGRESS_REPORT_ID = AV_MODULE_CODE
                and a.SUBMIT_USER = p.user_name
                and p.status = 'A';
			END IF;
		END IF;
     END IF;
ELSEIF AV_ROLE_TYPE = 51 THEN
	IF AV_MODULE_CODE = 13 THEN
		SELECT T3.PERSON_ID INTO LI_TEMP_PERSON_ID
		FROM ASSOC_AGREEMENT T1 
		INNER JOIN AWARD T2 ON T1.MODULE_ITEM_ID = T2.AWARD_ID
		INNER JOIN PERSON T3 ON T3.USER_NAME = T2.CREATE_USER
		WHERE T1.AGREEMENT_ID = AV_MODULE_ITEM_ID
		AND T3.STATUS = 'A';
	ELSEIF AV_MODULE_CODE = 20 THEN
		SELECT T3.PERSON_ID INTO LI_TEMP_PERSON_ID
		FROM ASSOC_SR T1 
		INNER JOIN AWARD T2 ON T1.MODULE_ITEM_ID = T2.AWARD_ID
		INNER JOIN PERSON T3 ON T3.USER_NAME = T2.CREATE_USER
		WHERE T1.SR_HEADER_ID = AV_MODULE_ITEM_ID
		AND T3.STATUS = 'A';
	END IF;
ELSEIF AV_ROLE_TYPE = 52 THEN  
	IF AV_MODULE_CODE = 20 THEN
			SELECT IFNULL(T1.ASSIGNEE_PERSON_ID, T1.ADMIN_GROUP_ID ) INTO LI_TEMP_PERSON_ID
			FROM sr_header T1
			LEFT JOIN PERSON T2 ON T1.ASSIGNEE_PERSON_ID = T2.PERSON_ID
			where T1.SR_HEADER_ID = AV_MODULE_ITEM_ID
			and STATUS_CODE = 4 AND T2.STATUS = 'A'; 
	 END IF;
ELSEIF AV_ROLE_TYPE = 100 THEN	
	SELECT GROUP_CONCAT(distinct T1.PERSON_ID) INTO LI_TEMP_PERSON_ID
	FROM PERSON_ROLES T1
	INNER JOIN PERSON T2 ON T1.PERSON_ID = T2.PERSON_ID
	WHERE T1.ROLE_ID = 1391
	AND T1.UNIT_NUMBER = (SELECT  SUBSTRING_INDEX(GROUP_CONCAT(distinct T1.UNIT_NUMBER), ',', -1) 
							FROM PERSON_ROLES T1
							where T1.UNIT_NUMBER in (
										SELECT UNIT_NUMBER  FROM UNIT_WITH_CHILDREN 
										WHERE CHILD_UNIT_NUMBER = LS_LEAD_UNIT)
										AND T1.ROLE_ID = 1391)
	AND T2.STATUS = 'A';
ELSEIF AV_ROLE_TYPE = 101 THEN	
	IF AV_MODULE_CODE = 3 THEN
			WITH 
				unit_TMP 	AS(
								SELECT UNIT_NUMBER
								FROM PERSON_ROLES T1
								WHERE T1.UNIT_NUMBER = (select HOME_UNIT_NUMBER from eps_proposal where PROPOSAL_ID = AV_MODULE_ITEM_ID)
								AND T1.ROLE_ID = 1392							
								UNION
								SELECT UNIT_NUMBER
								FROM PERSON_ROLES T1
								where T1.UNIT_NUMBER in (
								SELECT UNIT_NUMBER  FROM UNIT_WITH_CHILDREN 
								WHERE CHILD_UNIT_NUMBER = (select HOME_UNIT_NUMBER from eps_proposal where PROPOSAL_ID = AV_MODULE_ITEM_ID)
								AND T1.ROLE_ID = 1392
							)) 
				SELECT  SUBSTRING_INDEX(GROUP_CONCAT(T1.PERSON_ID), ',', -1)  INTO LI_TEMP_PERSON_ID
				FROM PERSON_ROLES T1
				INNER JOIN PERSON T2 ON T1.PERSON_ID = T2.PERSON_ID
				WHERE T1.ROLE_ID = 1392
				AND T1.UNIT_NUMBER in (select unit_number from unit_TMP)
				AND T2.STATUS = 'A';

	ELSEIF AV_MODULE_CODE = 1 THEN
			WITH 
			unit_TMP 	AS
				(SELECT UNIT_NUMBER
				FROM PERSON_ROLES T1
				WHERE T1.UNIT_NUMBER = (select LEAD_UNIT_NUMBER from award where award_id = AV_MODULE_ITEM_ID)
				AND T1.ROLE_ID = 1392							
				UNION
				SELECT UNIT_NUMBER
				FROM PERSON_ROLES T1
				where T1.UNIT_NUMBER in (
				SELECT UNIT_NUMBER  FROM UNIT_WITH_CHILDREN 
				WHERE CHILD_UNIT_NUMBER = (select LEAD_UNIT_NUMBER from award where award_id = AV_MODULE_ITEM_ID)
				AND T1.ROLE_ID = 1392
			)) 
			SELECT  SUBSTRING_INDEX(GROUP_CONCAT(T1.PERSON_ID), ',', -1) into LI_TEMP_PERSON_ID
			FROM PERSON_ROLES T1
			INNER JOIN PERSON T2 ON T1.PERSON_ID = T2.PERSON_ID
			WHERE T1.ROLE_ID = 1392
			AND T1.UNIT_NUMBER in (select unit_number from unit_TMP)
			AND T2.STATUS = 'A';

	ELSEIF AV_MODULE_CODE in (14, 16) THEN
			WITH
			unit_TMP 	AS
				(SELECT UNIT_NUMBER
				FROM PERSON_ROLES T1
				WHERE T1.UNIT_NUMBER = (select LEAD_UNIT_NUMBER from award where award_id = LS_AWARD_ID)
				AND T1.ROLE_ID = 1392							
				UNION
				SELECT UNIT_NUMBER
				FROM PERSON_ROLES T1
				where T1.UNIT_NUMBER in (
				SELECT UNIT_NUMBER  FROM UNIT_WITH_CHILDREN 
				WHERE CHILD_UNIT_NUMBER = (select LEAD_UNIT_NUMBER from award where award_id = LS_AWARD_ID)
				AND T1.ROLE_ID = 1392
			)) 
			SELECT  SUBSTRING_INDEX(GROUP_CONCAT(T1.PERSON_ID), ',', -1) into LI_TEMP_PERSON_ID
			FROM PERSON_ROLES T1
			INNER JOIN PERSON T2 ON T1.PERSON_ID = T2.PERSON_ID
			WHERE T1.ROLE_ID = 1392
			AND T1.UNIT_NUMBER in (select unit_number from unit_TMP)
			AND T2.STATUS = 'A';
	END IF;
ELSEIF AV_ROLE_TYPE = 102 THEN	
	select GROUP_CONCAT(distinct a.PERSON_ID) INTO LI_TEMP_PERSON_ID
	from award_person_roles a, person  P
	where a.PERSON_ID = p.PERSON_ID
	and a.ROLE_ID = 1396
	and AWARD_ID = AV_MODULE_ITEM_ID
	and p.STATUS = 'A';
ELSEIF AV_ROLE_TYPE = 103 THEN	
	select GROUP_CONCAT(distinct a.PERSON_ID) INTO LI_TEMP_PERSON_ID
	from agreement_people_roles a, person  P
	where a.PERSON_ID = p.PERSON_ID
	and a.ROLE_ID = 1397
	and AGREEMENT_REQUEST_ID = AV_MODULE_ITEM_ID
	and p.STATUS = 'A';
ELSEIF AV_ROLE_TYPE = 104 THEN	
	IF AV_MODULE_CODE = 1 then
			WITH ACCESS_TMP 
				AS
				(SELECT UNIT_NUMBER
				FROM PERSON_ROLES T1
				WHERE T1.UNIT_NUMBER = (select LEAD_UNIT_NUMBER from AWARD where AWARD_ID = AV_MODULE_ITEM_ID)
				AND T1.ROLE_ID = 46							
				UNION
				SELECT UNIT_NUMBER
				FROM PERSON_ROLES T1
				where T1.UNIT_NUMBER in (
				SELECT UNIT_NUMBER  FROM UNIT_WITH_CHILDREN 
				WHERE CHILD_UNIT_NUMBER = (select LEAD_UNIT_NUMBER from AWARD where AWARD_ID = AV_MODULE_ITEM_ID))
				AND T1.ROLE_ID = 46
			) SELECT  SUBSTRING_INDEX(GROUP_CONCAT(T1.PERSON_ID), ',', -1) INTO LI_TEMP_PERSON_ID
			FROM PERSON_ROLES T1
			INNER JOIN PERSON T2 ON T1.PERSON_ID = T2.PERSON_ID
			WHERE T1.ROLE_ID = 46
			AND T1.UNIT_NUMBER in (select unit_number from ACCESS_TMP)
			AND T2.STATUS = 'A';

	ELSEIF AV_MODULE_CODE = 14 then
			WITH ACCESS_TMP 
				AS
				(SELECT UNIT_NUMBER
				FROM PERSON_ROLES T1
				WHERE T1.UNIT_NUMBER = (select HOST_UNIT_NUMBER from CLAIM where CLAIM_ID = AV_MODULE_ITEM_ID)
				AND T1.ROLE_ID = 46							
				UNION
				SELECT UNIT_NUMBER
				FROM PERSON_ROLES T1
				where T1.UNIT_NUMBER in (
				SELECT UNIT_NUMBER  FROM UNIT_WITH_CHILDREN 
				WHERE CHILD_UNIT_NUMBER = (select HOST_UNIT_NUMBER from CLAIM where CLAIM_ID = AV_MODULE_ITEM_ID))
				AND T1.ROLE_ID = 46
			) SELECT  SUBSTRING_INDEX(GROUP_CONCAT(T1.PERSON_ID), ',', -1) INTO LI_TEMP_PERSON_ID
			FROM PERSON_ROLES T1
			INNER JOIN PERSON T2 ON T1.PERSON_ID = T2.PERSON_ID
			WHERE T1.ROLE_ID = 46
			AND T1.UNIT_NUMBER in (select unit_number from ACCESS_TMP)
			AND T2.STATUS = 'A';
	END IF;
ELSEIF AV_ROLE_TYPE = 106 THEN	
	select group_concat(distinct s.PERSON_ID) INTO LI_TEMP_PERSON_ID
	from sr_person_roles s, person p
	where s.SR_HEADER_ID = AV_MODULE_ITEM_ID
	and s.person_id = p.person_id
	and p.status = 'A';
ELSEIF AV_ROLE_TYPE = 111 THEN	
	select group_concat(distinct T1.APPROVER_PERSON_ID) INTO LI_TEMP_PERSON_ID
	from WORKFLOW_detail T1
	INNER JOIN PERSON T2 ON T1.APPROVER_PERSON_ID = T2.PERSON_ID
	where T1.workflow_id in (select workflow_id from WORKFLOW where module_code = av_module_code and MODULE_ITEM_ID = AV_MODULE_ITEM_ID)
	AND T2.STATUS = 'A';	
ELSEIF AV_ROLE_TYPE = 112 THEN	
	select GROUP_CONCAT(distinct a.PERSON_ID) INTO LI_TEMP_PERSON_ID
	from eps_proposal_person_roles a, person  P
	where a.PERSON_ID = p.PERSON_ID
	and a.ROLE_ID = 5
	and PROPOSAL_ID = AV_MODULE_ITEM_ID
	and p.STATUS = 'A';
-- role_type end
 END IF;
SELECT LI_TEMP_PERSON_ID INTO TMP_PERSON_LIST
FROM DUAL;
WHILE TMP_PERSON_LIST != '' DO
SET LI_PERSON = SUBSTRING_INDEX(TMP_PERSON_LIST, ',', 1);
SELECT FULL_NAME,EMAIL_ADDRESS INTO LL_FULL_NAME,LL_EMAIL_ADDRESS
FROM PERSON
WHERE PERSON_ID = LI_PERSON;
INSERT INTO WORKFLOW_DETAIL(
		WORKFLOW_ID,
		MAP_ID,
		MAP_NUMBER,
		APPROVAL_STOP_NUMBER,
		APPROVER_NUMBER,
		PRIMARY_APPROVER_FLAG,
		APPROVER_PERSON_ID,
		APPROVAL_STATUS,
		UPDATE_USER,
		UPDATE_TIMESTAMP,
		ROLE_TYPE_CODE,
		EMAIL_ADDRESS,
		APPROVER_PERSON_NAME,
		STOP_NAME,
		MAP_NAME,
		MAP_DESCRIPTION
	) VALUES(
		AV_WORKFLOW_ID,
		AV_MAPID,
		AV_MAP_NUMBER,
		AV_APPROVAL_STOP_NUMBER,
		AV_APPROVER_NUMBER,
		AV_PRIMARY_APPROVER_FLAG,
		LI_PERSON,
		AV_APPROVAL_STATUS,
		AV_UPDATE_USER,
		utc_timestamp(),
		AV_ROLE_TYPE,
		LL_EMAIL_ADDRESS,
		LL_FULL_NAME,
		AV_STOP_NAME,
		AV_MAP_NAME,
		AV_MAP_DESCRIPTION
	);
SET AV_PRIMARY_APPROVER_FLAG = 'N';
IF LOCATE(',', TMP_PERSON_LIST) > 0 THEN
SET TMP_PERSON_LIST = SUBSTRING(
		TMP_PERSON_LIST,
		LOCATE(',', TMP_PERSON_LIST) + 1
	);
ELSE
SET TMP_PERSON_LIST = '';
END IF;
END WHILE;
END

