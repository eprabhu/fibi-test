-- `MIGRATE_ADHOC_REPORTS_TO_AWARD_REPORTING_REQUIREMENTS`; 

CREATE PROCEDURE `MIGRATE_ADHOC_REPORTS_TO_AWARD_REPORTING_REQUIREMENTS`()
BEGIN
	DECLARE DONE TINYINT DEFAULT 0;
    DECLARE LS_AWARD_NUMBER VARCHAR(255);
    DECLARE LS_DUE_DATE VARCHAR(255);
    DECLARE LI_AWARD_ID INT(10);
    DECLARE LS_REPORT_CLASS_CODE VARCHAR(255);
    DECLARE LI_SEQUENCE_NUMBER int;
    DECLARE LD_DOCUMENT_UPDATE_TIMESTAMP datetime;
    DECLARE LS_DOCUMENT_UPDATE_USER varchar(255);
    DECLARE LI_NEW_TERM_ID int;
    DECLARE LD_CREATE_TIME datetime;
    DECLARE LS_CREATE_USER varchar(255);
    DECLARE LI_PROGRESS_REPORT_ID int;
    
    
    DECLARE CURSOR_FOR_AWARD_ADHOC_REPORT CURSOR FOR 
    select t1.award_number,t2.AWARD_ID,t1.REPORT_CLASS_CODE,t1.DUE_DATE, t2.SEQUENCE_NUMBER, t1.UPDATE_TIMESTAMP, 
    t1.UPDATE_USER,t1.CREATE_USER, t1.CREATE_TIMESTAMP, t1.PROGRESS_REPORT_ID from award_progress_report t1 
    left outer join award t2 on t1.AWARD_NUMBER = t2.AWARD_NUMBER
    where (t2.AWARD_SEQUENCE_STATUS = "PENDING" or t2.AWARD_SEQUENCE_STATUS = "ACTIVE")   AND t1.AWARD_REPORT_TRACKING_ID is null;    
    
    OPEN CURSOR_FOR_AWARD_ADHOC_REPORT;
    
    read_loop: LOOP begin          
		        DECLARE CONTINUE HANDLER FOR SQLSTATE '02000' SET DONE = 1;
        FETCH CURSOR_FOR_AWARD_ADHOC_REPORT INTO LS_AWARD_NUMBER, LI_AWARD_ID, LS_REPORT_CLASS_CODE, LS_DUE_DATE, LI_SEQUENCE_NUMBER,
         LD_DOCUMENT_UPDATE_TIMESTAMP, LS_DOCUMENT_UPDATE_USER,LS_CREATE_USER, LD_CREATE_TIME, LI_PROGRESS_REPORT_ID;
 IF DONE THEN
            LEAVE read_loop;
        END IF;
        INSERT INTO award_report_terms (`AWARD_ID`, `AWARD_NUMBER`, `SEQUENCE_NUMBER`, `REPORT_CLASS_CODE`, `FREQUENCY_CODE`, `FREQUENCY_BASE_CODE`, `DUE_DATE`, `UPDATE_TIMESTAMP`, `UPDATE_USER`) 
        VALUES (LI_AWARD_ID, LS_AWARD_NUMBER, LI_SEQUENCE_NUMBER, LS_REPORT_CLASS_CODE, '7', '6', LS_DUE_DATE, LD_DOCUMENT_UPDATE_TIMESTAMP, LS_DOCUMENT_UPDATE_USER);
        SET LI_NEW_TERM_ID = (select max(AWARD_REPORT_TERMS_ID) from award_report_terms);
        
        INSERT INTO award_report_tracking (`AWARD_REPORT_TERMS_ID`, `AWARD_ID`, `AWARD_NUMBER`, `SEQUENCE_NUMBER`,  `CREATE_USER`, `CREATE_DATE`, `UPDATE_TIMESTAMP`, `UPDATE_USER`, `DUE_DATE`, `IS_ADHOC`,`PROGRESS_REPORT_ID`)
         VALUES (LI_NEW_TERM_ID, LI_AWARD_ID, LS_AWARD_NUMBER, LI_SEQUENCE_NUMBER, LS_CREATE_USER, LD_CREATE_TIME, LD_DOCUMENT_UPDATE_TIMESTAMP,
          LS_DOCUMENT_UPDATE_USER, LS_DUE_DATE,'Y', LI_PROGRESS_REPORT_ID);
   end;
   END LOOP;
 
    CLOSE CURSOR_FOR_AWARD_ADHOC_REPORT;
END
