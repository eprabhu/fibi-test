-- `MIGRATE_MILESTONE_NUMBER`; 

CREATE PROCEDURE `MIGRATE_MILESTONE_NUMBER`()
BEGIN
DECLARE LS_AWARD_NUMBER VARCHAR(22);
DECLARE LS_MILESTONE varchar(1000);
DECLARE LS_MILESTONE_NUMBER varchar(30);
BEGIN
DECLARE DONE1 INT DEFAULT FALSE;
DECLARE CUR_CRITERIA CURSOR FOR
WITH DuplicateGroups AS (
    SELECT AWARD_NUMBER, MILESTONE_NUMBER
    FROM award_milestone
    WHERE SEQUENCE_NUMBER = '0'
    GROUP BY AWARD_NUMBER, MILESTONE_NUMBER
    HAVING COUNT(1) > 1
)
SELECT A.AWARD_NUMBER,A.MILESTONE_NUMBER,A.MILESTONE 
FROM award_milestone A 
JOIN DuplicateGroups DG
    ON A.AWARD_NUMBER = DG.AWARD_NUMBER
    AND A.MILESTONE_NUMBER = DG.MILESTONE_NUMBER
    WHERE A.SEQUENCE_NUMBER = '0';
DECLARE CONTINUE HANDLER FOR NOT FOUND SET DONE1 = TRUE;
OPEN CUR_CRITERIA;
INSERT_CUR_MAPPING_LOOP: LOOP
FETCH CUR_CRITERIA INTO
LS_AWARD_NUMBER,
LS_MILESTONE_NUMBER,
LS_MILESTONE;
IF DONE1 THEN
LEAVE INSERT_CUR_MAPPING_LOOP;
END IF;
INSERT INTO `award_milestone_temp` (`AWARD_NUMBER`, `MILESTONE`, `OLD_MILESTONE_NUMBER`, `NEW_MILESTONE_NUMBER`) VALUES (LS_AWARD_NUMBER, LS_MILESTONE, LS_MILESTONE_NUMBER, (SELECT current_timestamp(3)));
END LOOP;
CLOSE CUR_CRITERIA;
END;
END
