CREATE PROCEDURE `ROUTING_ADD_TO_INBOX`(
AV_MODULE_CODE           DECIMAL(38,0),
AV_SUBMODULE_CODE        DECIMAL(38,0),
AV_MODULE_ITEM_KEY       VARCHAR(200),
AV_LOGGIN_PERSON_ID      VARCHAR(200),
AV_UPDATE_USER           VARCHAR(200),
AV_SUB_MODULE_ITEM_KEY    VARCHAR(20),
AV_WORKFLOW_ID 				DECIMAL(38,0)
)
    DETERMINISTIC
BEGIN

	DECLARE LS_PERSON_ID VARCHAR(20);
	DECLARE LS_USER_MESSAGE VARCHAR(4000);
	DECLARE LS_TITLE VARCHAR(1000);
	DECLARE LS_MSG_TYPE VARCHAR(20);
	DECLARE LS_AWARD_NUMBER VARCHAR(20);
	DECLARE LS_MODULE_ITEM_KEY VARCHAR(20);
	DECLARE LS_REPORT_CLASS_NAME VARCHAR(200);
	DECLARE LS_AGREEMENT_TYPE VARCHAR(200);



	DECLARE DONE1 INT DEFAULT FALSE;

	DECLARE LS_MSG TEXT;
	DECLARE LS_DOCUMENT_TYPE_CODE VARCHAR(3);
	DECLARE LS_SERVICE_REQUEST_TYPE VARCHAR(200);
	DECLARE LI_AWD_MODIFI_FLAG INT;
	DECLARE LI_VARIATION_FLAG INT;
	DECLARE LS_AWARD_TITLE VARCHAR(300);
	DECLARE LS_CLAIM_NUMBER VARCHAR(20);
	DECLARE LS_PROGRESS_REPORT_NUMBER VARCHAR(20);							

		
	DECLARE LOOP_CNT INT;

	DECLARE LS_REPORT_TITLE VARCHAR(300);


	DECLARE ADD_TO_INBOX_CUR CURSOR FOR 

	SELECT DISTINCT APPROVER_PERSON_ID 
	FROM WORKFLOW_DETAIL 
	WHERE WORKFLOW_ID = AV_WORKFLOW_ID AND APPROVAL_STATUS = 'W';
	
	DECLARE CONTINUE HANDLER FOR NOT FOUND SET DONE1 = TRUE;
		
	IF AV_MODULE_CODE = 1 THEN 
			SELECT TITLE,AWARD_NUMBER,AWARD_DOCUMENT_TYPE_CODE INTO LS_TITLE,LS_AWARD_NUMBER,LS_DOCUMENT_TYPE_CODE
			FROM AWARD WHERE AWARD_ID = AV_MODULE_ITEM_KEY;

				
			SELECT COUNT(1) INTO LI_VARIATION_FLAG FROM AWARD
			WHERE AWARD_ID = AV_MODULE_ITEM_KEY
			AND AWARD_DOCUMENT_TYPE_CODE = 3;
			
			SELECT COUNT(1) INTO LI_AWD_MODIFI_FLAG FROM AWARD
			WHERE AWARD_ID = AV_MODULE_ITEM_KEY
			AND AWARD_DOCUMENT_TYPE_CODE = 2;
			
			SELECT T2.DESCRIPTION INTO LS_SERVICE_REQUEST_TYPE FROM AWARD T1
			INNER JOIN SR_TYPE T2 ON T1.AWARD_VARIATION_TYPE_CODE = T2.TYPE_CODE
			WHERE AWARD_ID = AV_MODULE_ITEM_KEY;
	
			
			IF AV_SUBMODULE_CODE = 2 THEN 
			
				SELECT T2.DESCRIPTION INTO LS_TITLE
				FROM TASK T1 LEFT JOIN TASK_TYPE T2 ON T1.TASK_TYPE_CODE = T2.TASK_TYPE_CODE 
				WHERE T1.TASK_ID = AV_SUB_MODULE_ITEM_KEY ;
			
				SET LS_MSG_TYPE := '114';
				
				SELECT TITLE INTO LS_AWARD_TITLE
				FROM AWARD WHERE AWARD_ID = AV_MODULE_ITEM_KEY;
			
			ELSE
				IF LS_DOCUMENT_TYPE_CODE = '3' THEN
				SET LS_MSG_TYPE := '122';
				ELSE 
				SET LS_MSG_TYPE := '101';
				END IF;
			END IF;
	ELSEIF AV_MODULE_CODE = 3 THEN 
			SELECT TITLE INTO LS_TITLE FROM EPS_PROPOSAL WHERE PROPOSAL_ID = AV_MODULE_ITEM_KEY;
			SET LS_MSG_TYPE := '102';
	ELSEIF AV_MODULE_CODE = 5 THEN 
			SELECT COALESCE(T2.TITLE,T3.TITLE,'Negotiation') INTO LS_TITLE FROM  NEGOTIATION_ASSOCIATION T1 
			LEFT JOIN AWARD T2 ON T1.ASSOCIATED_PROJECT_ID = T2.AWARD_NUMBER AND T1.ASSOCIATION_TYPE_CODE = 1 AND T2.IS_LATEST = 'Y'
			LEFT JOIN PROPOSAL T3 ON T3.PROPOSAL_NUMBER = T1.ASSOCIATED_PROJECT_ID AND T1.ASSOCIATION_TYPE_CODE = 2
			WHERE T1.NEGOTIATION_ID = AV_MODULE_ITEM_KEY ;
			SET LS_TITLE = COALESCE(LS_TITLE,'Negotiation');
			SET LS_MSG_TYPE := '104';

	ELSEIF AV_MODULE_CODE = 13 THEN
	SELECT TITLE INTO LS_TITLE FROM AGREEMENT_HEADER WHERE AGREEMENT_REQUEST_ID = AV_MODULE_ITEM_KEY;
	SET LS_MSG_TYPE := '1308';

	ELSEIF AV_MODULE_CODE = 14 THEN	
			SELECT TITLE INTO LS_TITLE FROM CLAIM WHERE CLAIM_ID = AV_MODULE_ITEM_KEY;	
			SET LS_MSG_TYPE := '123';
	ELSEIF AV_MODULE_CODE = 16 THEN	
			SELECT TITLE INTO LS_TITLE FROM AWARD WHERE AWARD_ID IN(SELECT AWARD_ID 
									FROM AWARD_PROGRESS_REPORT 
									WHERE PROGRESS_REPORT_ID = AV_MODULE_ITEM_KEY); 				
			SET LS_MSG_TYPE := '126';
	ELSEIF AV_MODULE_CODE = 20 THEN	
			SELECT SUBJECT INTO LS_TITLE FROM SR_HEADER WHERE SR_HEADER_ID = AV_MODULE_ITEM_KEY;	
			SET LS_MSG_TYPE := '135';
		  
	END IF;
	
	IF AV_MODULE_CODE = 1 THEN 

		SET  LS_MODULE_ITEM_KEY = LS_AWARD_NUMBER;
		
		IF AV_SUBMODULE_CODE = 2 THEN 
		
			SET  LS_MODULE_ITEM_KEY = AV_SUB_MODULE_ITEM_KEY;
		
		END IF;
	ELSE
	
		SET  LS_MODULE_ITEM_KEY = AV_MODULE_ITEM_KEY;

	END IF;
	
	IF AV_MODULE_CODE = 14 THEN 
	
		SELECT CLAIM_NUMBER INTO LS_CLAIM_NUMBER FROM CLAIM WHERE CLAIM_ID = AV_MODULE_ITEM_KEY;
		SET  LS_MODULE_ITEM_KEY = LS_CLAIM_NUMBER;  
	END IF;
	
	IF AV_MODULE_CODE = 16 THEN 
	
		SELECT PROGRESS_REPORT_NUMBER INTO LS_PROGRESS_REPORT_NUMBER FROM AWARD_PROGRESS_REPORT WHERE PROGRESS_REPORT_ID = AV_MODULE_ITEM_KEY;
		SET  LS_MODULE_ITEM_KEY = LS_PROGRESS_REPORT_NUMBER;          
	END IF;								   
		
		
	IF AV_MODULE_CODE = 1 AND AV_SUBMODULE_CODE = 0 AND LI_VARIATION_FLAG > 0 THEN 
	
		
		SET LS_USER_MESSAGE = CONCAT(LS_SERVICE_REQUEST_TYPE,' for #',LS_AWARD_NUMBER,' : ',LS_TITLE);
			
	ELSEIF AV_MODULE_CODE = 1 AND AV_SUBMODULE_CODE = 0 AND LI_AWD_MODIFI_FLAG > 0 THEN 
	
		
	  SET LS_USER_MESSAGE = CONCAT('Admin Correction for ',LS_AWARD_NUMBER,' : ',LS_TITLE);

	ELSEIF AV_MODULE_CODE = 1 AND AV_SUBMODULE_CODE = 2 THEN 
	
		IF LI_VARIATION_FLAG > 0 THEN
		
			  SET LS_USER_MESSAGE = CONCAT(LS_SERVICE_REQUEST_TYPE,' ',LS_TITLE,' for #',LS_AWARD_NUMBER,' : ',LS_AWARD_TITLE);


		ELSEIF LI_AWD_MODIFI_FLAG > 0 THEN
		
				SET LS_USER_MESSAGE = CONCAT('Admin Correction ',LS_TITLE,' for #',LS_AWARD_NUMBER,' : ',LS_AWARD_TITLE);

		
		ELSE
			
			SET LS_USER_MESSAGE = CONCAT(LS_TITLE,' for #',LS_AWARD_NUMBER,' : ',LS_AWARD_TITLE);

		END IF;
		
		ELSEIF AV_MODULE_CODE = 13 THEN

			SELECT T2.DESCRIPTION INTO LS_AGREEMENT_TYPE FROM  AGREEMENT_HEADER T1
			INNER JOIN AGREEMENT_TYPE T2  ON T2.AGREEMENT_TYPE_CODE = T1.AGREEMENT_TYPE_CODE
			WHERE AGREEMENT_REQUEST_ID = AV_MODULE_ITEM_KEY;
			
			SET LS_USER_MESSAGE = CONCAT('#',LS_MODULE_ITEM_KEY,' : ',LS_TITLE,' - ', LS_AGREEMENT_TYPE);

	ELSEIF AV_MODULE_CODE = 16 THEN 
    		select T1.TITLE,T2.DESCRIPTION into LS_REPORT_TITLE,LS_REPORT_CLASS_NAME from award_progress_report T1 LEFT JOIN REPORT_CLASS T2 
			ON T1.REPORT_CLASS_CODE = T2.REPORT_CLASS_CODE where T1.PROGRESS_REPORT_ID =  AV_MODULE_ITEM_KEY;
			SET LS_USER_MESSAGE = CONCAT(LS_REPORT_CLASS_NAME,' #',LS_PROGRESS_REPORT_NUMBER," : ",LS_REPORT_TITLE);
	ELSE 
		SET LS_USER_MESSAGE = CONCAT('#',LS_MODULE_ITEM_KEY,' : ',LS_TITLE);
	END IF;
	
	
		
    SET DONE1 = FALSE; 
    OPEN ADD_TO_INBOX_CUR;

	ADD_TO_INBOX_LOOP : LOOP
    
        FETCH ADD_TO_INBOX_CUR INTO LS_PERSON_ID;
		IF DONE1 THEN
			LEAVE ADD_TO_INBOX_LOOP;
		END IF;
        
        
		CALL ADD_TO_INBOX(AV_MODULE_CODE,AV_MODULE_ITEM_KEY,LS_PERSON_ID,'R',LS_USER_MESSAGE,AV_UPDATE_USER,LS_MSG_TYPE,AV_SUBMODULE_CODE,AV_SUB_MODULE_ITEM_KEY);

	END LOOP;
    CLOSE ADD_TO_INBOX_CUR;


END
