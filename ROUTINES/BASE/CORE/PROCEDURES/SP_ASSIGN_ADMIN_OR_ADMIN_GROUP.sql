CREATE PROCEDURE SP_ASSIGN_ADMIN_OR_ADMIN_GROUP(
    IN AV_MODULE_ITEM_KEY        VARCHAR(20),
    IN AV_MODULE_CODE            INT,
    IN AV_SUBMODULE_CODE         INT,
    IN AV_PERSON_ID             VARCHAR(60),
    IN AV_UPDATE_USER           VARCHAR(100),
    IN AV_MAPID                 INT,
    IN AV_SUB_MODULE_ITEM_KEY   VARCHAR(20),
    IN AV_RULE_ID               INT,
	OUT AV_ADMIN_GROUP_ID        INT,
    OUT AV_ADMIN_PERSON_ID       VARCHAR(60),
    OUT AV_ADMIN_NAME             VARCHAR(200),
    OUT AV_GROUP_NAME             VARCHAR(200)
)
BEGIN
    -- Variable Declarations
    DECLARE LS_APPROVER_PERSON_ID        VARCHAR(60);
    DECLARE LS_IS_ROLE                   VARCHAR(1);
    DECLARE LI_ROLE_TYPE_CODE            INT(3);
    DECLARE DONE1                        INT DEFAULT 0;
    DECLARE LI_ADMIN_GROUP_ID            INT;
    DECLARE LS_FINAL_PERSON_ID            VARCHAR(60);
    DECLARE LS_LEAD_UNIT                 VARCHAR(50);
    DECLARE LS_ADMIN_PERSON_ID           VARCHAR(40);
    DECLARE LI_FINAL_GROUP_ID            INT;
    DECLARE LI_GROUP_COUNT               INT;
    DECLARE LS_TEMP_PERSON_ID            VARCHAR(60);



    -- Cursor Declaration
    DECLARE MAP_CURSOR CURSOR FOR 
    SELECT * FROM (
        (SELECT APPROVER_PERSON_ID, IS_ROLE, ROLE_TYPE_CODE,  ADMIN_GROUP_ID 
         FROM WORKFLOW_MAP_DETAIL T3 
         INNER JOIN WORKFLOW_MAP T4 ON T3.MAP_ID = T4.MAP_ID
         WHERE T3.MAP_ID = AV_MAPID AND ROLE_TYPE_CODE IS NOT NULL)
        UNION ALL
        (SELECT APPROVER_PERSON_ID, IS_ROLE, ROLE_TYPE_CODE,  ADMIN_GROUP_ID 
         FROM WORKFLOW_MAP_DETAIL T1
         INNER JOIN WORKFLOW_MAP T6 ON T1.MAP_ID = T6.MAP_ID 
         INNER JOIN PERSON T2 ON T2.PERSON_ID = T1.APPROVER_PERSON_ID 
         WHERE T1.MAP_ID = AV_MAPID AND T2.STATUS = 'A')
		 UNION ALL
		(SELECT APPROVER_PERSON_ID, IS_ROLE, ROLE_TYPE_CODE,  ADMIN_GROUP_ID 
         FROM WORKFLOW_MAP_DETAIL T3 
         INNER JOIN WORKFLOW_MAP T4 ON T3.MAP_ID = T4.MAP_ID
         WHERE T3.MAP_ID = AV_MAPID AND ADMIN_GROUP_ID IS NOT NULL)
		 ) T;

    DECLARE CONTINUE HANDLER FOR NOT FOUND SET DONE1 = 1;
    SET LI_FINAL_GROUP_ID = NULL;
    SET LS_ADMIN_PERSON_ID = NULL;
    SET LS_LEAD_UNIT = NULL;


    -- Start transaction
    START TRANSACTION;
    -- Main Processing
    OPEN MAP_CURSOR;
    MAP_CURSOR_LOOP: LOOP
        FETCH MAP_CURSOR INTO LS_APPROVER_PERSON_ID,LS_IS_ROLE, LI_ROLE_TYPE_CODE,LI_ADMIN_GROUP_ID;
        IF DONE1 = 1 THEN
            LEAVE MAP_CURSOR_LOOP;
        END IF;
        -- Reset temporary variables
        SET LS_FINAL_PERSON_ID = NULL;

        -- Role-based Processing
        IF LS_IS_ROLE = 'Y' AND LI_ROLE_TYPE_CODE IS NOT NULL THEN
            -- Get lead unit for agreements
            IF AV_MODULE_CODE = 13 THEN
                SELECT UNIT_NUMBER INTO LS_LEAD_UNIT
                FROM AGREEMENT_HEADER
                WHERE AGREEMENT_REQUEST_ID = AV_MODULE_ITEM_KEY;
            END IF;

				-- Role Type Handling
			IF LI_ROLE_TYPE_CODE IN (1, 3) THEN
				SELECT T1.PERSON_ID INTO LS_TEMP_PERSON_ID
				FROM UNIT_ADMINISTRATOR T1
				INNER JOIN PERSON T2 ON T2.PERSON_ID = T1.PERSON_ID
				WHERE T1.UNIT_NUMBER = LS_LEAD_UNIT
				AND T1.UNIT_ADMINISTRATOR_TYPE_CODE = (
					SELECT (
							CASE
								LI_ROLE_TYPE_CODE
								WHEN 1 THEN 1
								WHEN 3 THEN 4
							END
						) AS UNIT_ADMINISTRATOR_TYPE_CODE
					FROM DUAL
				)
				AND T2.STATUS = 'A' LIMIT 1;

			ELSEIF LI_ROLE_TYPE_CODE = 2 THEN
				SELECT T1.PERSON_ID INTO LS_TEMP_PERSON_ID
				FROM UNIT_ADMINISTRATOR T1
				INNER JOIN PERSON T2 ON T2.PERSON_ID = T1.PERSON_ID
				WHERE T1.UNIT_ADMINISTRATOR_TYPE_CODE = 5
				AND T1.UNIT_NUMBER = LS_LEAD_UNIT
				AND T2.STATUS = 'A' LIMIT 1;

			ELSEIF LI_ROLE_TYPE_CODE = 20 THEN
				SELECT T1.PERSON_ID INTO LS_TEMP_PERSON_ID
				FROM UNIT_ADMINISTRATOR T1
				INNER JOIN PERSON T2 ON T2.PERSON_ID = T1.PERSON_ID
				WHERE T1.UNIT_ADMINISTRATOR_TYPE_CODE = 3
				AND T1.UNIT_NUMBER = LS_LEAD_UNIT
				AND T2.STATUS = 'A' LIMIT 1;

			ELSEIF LI_ROLE_TYPE_CODE = 21 THEN
				SELECT T1.PERSON_ID INTO LS_TEMP_PERSON_ID
				FROM UNIT_ADMINISTRATOR T1
				INNER JOIN PERSON T2 ON T2.PERSON_ID = T1.PERSON_ID
				WHERE T1.UNIT_ADMINISTRATOR_TYPE_CODE = 5
				AND T1.UNIT_NUMBER = '208'
				AND T2.STATUS = 'A' LIMIT 1;

			ELSEIF LI_ROLE_TYPE_CODE = 4 THEN 
				IF AV_MODULE_CODE = 13 THEN
					SELECT T1.PERSON_ID INTO LS_TEMP_PERSON_ID
					FROM AGREEMENT_PEOPLE T1
					INNER JOIN PERSON T2 ON T1.PERSON_ID = T2.PERSON_ID
					WHERE T1.AGREEMENT_REQUEST_ID = AV_MODULE_ITEM_KEY
					AND T1.PEOPLE_TYPE_ID = 2
					AND T2.STATUS = 'A' LIMIT 1;
				END IF;

			ELSEIF LI_ROLE_TYPE_CODE = 5 THEN 

				IF AV_MODULE_CODE = 13 THEN
					SELECT T2.PERSON_ID INTO LS_TEMP_PERSON_ID
					FROM AGREEMENT_PEOPLE T1
					INNER JOIN PERSON T2 ON T1.PERSON_ID = T2.PERSON_ID
					WHERE T1.AGREEMENT_REQUEST_ID = AV_MODULE_ITEM_KEY
					AND T1.PEOPLE_TYPE_ID = 3
					AND T2.STATUS = 'A' LIMIT 1;
				END IF;

			ELSEIF LI_ROLE_TYPE_CODE = 9 THEN
				SELECT T2.PERSON_ID INTO LS_TEMP_PERSON_ID
				FROM PERSON T2
				WHERE T2.DIRECTORY_TITLE = 'Faculty'
				OR T2.IS_FACULTY = 'Y'
				AND T2.STATUS = 'A' LIMIT 1;

			ELSEIF LI_ROLE_TYPE_CODE = 10 THEN
				SELECT T2.PERSON_ID INTO LS_TEMP_PERSON_ID
				FROM PERSON T2
				WHERE T2.DIRECTORY_TITLE = 'Research Staff'
				OR T2.IS_RESEARCH_STAFF = 'Y'
				AND T2.STATUS = 'A' LIMIT 1;

			ELSEIF LI_ROLE_TYPE_CODE = 11 THEN 

				IF AV_MODULE_CODE = 13 THEN
					SELECT T1.PERSON_ID INTO LS_TEMP_PERSON_ID
					FROM PERSON_ROLES T1
					INNER JOIN PERSON T2 ON T1.PERSON_ID = T2.PERSON_ID
					WHERE T1.ROLE_ID = 660
					AND T2.STATUS = 'A' LIMIT 1;
				END IF;

			ELSEIF LI_ROLE_TYPE_CODE = 14 THEN
				SELECT T1.PERSON_ID INTO LS_TEMP_PERSON_ID
				FROM PERSON_ROLES T1
				LEFT JOIN PERSON T2 ON T1.PERSON_ID = T2.PERSON_ID
				WHERE T1.ROLE_ID = 120
				AND T1.UNIT_NUMBER = LS_LEAD_UNIT
				AND T2.STATUS = 'A' LIMIT 1;

			ELSEIF LI_ROLE_TYPE_CODE = 15 THEN
				SELECT T1.PERSON_ID INTO LS_TEMP_PERSON_ID
				FROM PERSON_ROLES T1
				INNER JOIN PERSON T2 ON T1.PERSON_ID = T2.PERSON_ID
				WHERE T1.ROLE_ID = 28
				AND T1.UNIT_NUMBER = LS_LEAD_UNIT
				AND T2.STATUS = 'A' LIMIT 1;
			ELSEIF LI_ROLE_TYPE_CODE = 16 THEN
				SELECT T1.PERSON_ID INTO LS_TEMP_PERSON_ID
				FROM PERSON_ROLES T1
				INNER JOIN PERSON T2 ON T1.PERSON_ID = T2.PERSON_ID
				WHERE ROLE_ID = 100
				AND T1.UNIT_NUMBER = '252'
				AND T2.STATUS = 'A' LIMIT 1;
			ELSEIF LI_ROLE_TYPE_CODE = 17 THEN
				SELECT T1.PERSON_ID INTO LS_TEMP_PERSON_ID
				FROM UNIT_ADMINISTRATOR T1
				INNER JOIN PERSON T2 ON T1.PERSON_ID = T2.PERSON_ID
				WHERE UNIT_ADMINISTRATOR_TYPE_CODE = 5
				AND T1.UNIT_NUMBER = '252'
				AND T2.STATUS = 'A' LIMIT 1;
			ELSEIF LI_ROLE_TYPE_CODE = 18 THEN
				SELECT T1.PERSON_ID INTO LS_TEMP_PERSON_ID
				FROM PERSON_ROLES T1
				INNER JOIN PERSON T2 ON T1.PERSON_ID = T2.PERSON_ID
				WHERE ROLE_ID = 100
				AND T1.UNIT_NUMBER = '654'
				AND T2.STATUS = 'A' LIMIT 1;
			ELSEIF LI_ROLE_TYPE_CODE = 19 THEN
				SELECT T1.PERSON_ID INTO LS_TEMP_PERSON_ID
				FROM UNIT_ADMINISTRATOR T1
				INNER JOIN PERSON T2 ON T1.PERSON_ID = T2.PERSON_ID
				WHERE UNIT_ADMINISTRATOR_TYPE_CODE = 5
				AND T1.UNIT_NUMBER = '654'
				AND T2.STATUS = 'A' LIMIT 1;
			ELSEIF LI_ROLE_TYPE_CODE = 35 THEN 
				IF AV_MODULE_CODE = 13 THEN
					SELECT ADMIN_PERSON_ID INTO LS_ADMIN_PERSON_ID
					FROM AGREEMENT_HEADER
					WHERE AGREEMENT_REQUEST_ID = AV_MODULE_ITEM_KEY;
					IF LS_ADMIN_PERSON_ID IS NULL THEN

						SELECT PR.PERSON_ID INTO LS_TEMP_PERSON_ID
						FROM PERSON_ROLES PR JOIN 
						(SELECT ROLE_ID,RT.RIGHT_NAME 
						   FROM ROLE_RIGHTS RR,
								RIGHTS RT
							WHERE RR.RIGHT_ID = RT.RIGHT_ID
						) RLE ON RLE.ROLE_ID = PR.ROLE_ID AND RLE.ROLE_ID =1300 
						JOIN PERSON P ON PR.PERSON_ID=P.PERSON_ID AND P.STATUS='A'
						WHERE (( PR. DESCEND_FLAG = 'Y' AND  EXISTS (SELECT 1
																				 FROM UNIT_WITH_CHILDREN 
																								  WHERE UNIT_NUMBER = PR.UNIT_NUMBER
																								  AND CHILD_UNIT_NUMBER = LS_LEAD_UNIT
							 ))OR ( PR. DESCEND_FLAG = 'N' AND PR.UNIT_NUMBER = LS_LEAD_UNIT )) LIMIT 1;
							 
					ELSE
						SELECT T1.ADMIN_PERSON_ID INTO LS_TEMP_PERSON_ID
						FROM AGREEMENT_HEADER T1
						INNER JOIN PERSON T2 ON T1.ADMIN_PERSON_ID = T2.PERSON_ID
						WHERE AGREEMENT_REQUEST_ID = AV_MODULE_ITEM_KEY
						AND T2.STATUS = 'A' LIMIT 1;
					END IF;
				END IF;

			ELSEIF LI_ROLE_TYPE_CODE = 22 THEN
				SELECT T1.PERSON_ID INTO LS_TEMP_PERSON_ID
				FROM PERSON_ROLES T1
				INNER JOIN PERSON T2 ON T1.PERSON_ID = T2.PERSON_ID
				WHERE T1.ROLE_ID = 668
				AND T1.UNIT_NUMBER = LS_LEAD_UNIT
				AND T2.STATUS = 'A' LIMIT 1;
			END IF;

			-- Store derived person from role
			IF LS_TEMP_PERSON_ID IS NOT NULL THEN
				SET LS_ADMIN_PERSON_ID = LS_TEMP_PERSON_ID;
			END IF;

		-- Admin Group Processing
		ELSEIF LI_ADMIN_GROUP_ID IS NOT NULL THEN
			SELECT 
			AG.PERSON_ID
			INTO LS_FINAL_PERSON_ID FROM
			ADMIN_GROUP AG
			INNER JOIN
			PERSON P ON AG.PERSON_ID = P.PERSON_ID
			WHERE AG.ADMIN_GROUP_ID = LI_ADMIN_GROUP_ID
			AND P.STATUS = 'A' LIMIT 1;

			IF LS_FINAL_PERSON_ID IS NOT NULL THEN
				SET LS_ADMIN_PERSON_ID = LS_FINAL_PERSON_ID;
			END IF;

			SET LI_FINAL_GROUP_ID = LI_ADMIN_GROUP_ID;

		-- Direct Person Assignment
		ELSE
			IF LS_APPROVER_PERSON_ID IS NOT NULL THEN
				SELECT PERSON_ID INTO LS_FINAL_PERSON_ID
				FROM PERSON
				WHERE PERSON_ID = LS_APPROVER_PERSON_ID
				  AND STATUS = 'A';

				IF LS_FINAL_PERSON_ID IS NOT NULL THEN
					SET LS_ADMIN_PERSON_ID = LS_FINAL_PERSON_ID;
				END IF;
			END IF;

		END IF;
	
	IF LS_ADMIN_PERSON_ID IS NOT NULL AND LI_ADMIN_GROUP_ID IS NOT NULL THEN 	

    IF LI_FINAL_GROUP_ID IS NOT NULL THEN 
    SELECT ADMIN_GROUP_NAME INTO AV_GROUP_NAME FROM admin_group WHERE ADMIN_GROUP_ID = LI_FINAL_GROUP_ID;
    END IF;
    
	IF LS_ADMIN_PERSON_ID IS NOT NULL THEN 
    SELECT FULL_NAME INTO AV_ADMIN_NAME FROM PERSON WHERE PERSON_ID = LS_ADMIN_PERSON_ID;
    END IF;
    
		SELECT 
        LI_FINAL_GROUP_ID,
		LS_ADMIN_PERSON_ID 
        INTO  AV_ADMIN_GROUP_ID, 
        AV_ADMIN_PERSON_ID ;
	END IF;

	END LOOP MAP_CURSOR_LOOP;
	CLOSE MAP_CURSOR;

	-- Case: No Admin Group - Check person's groups
	IF LS_ADMIN_PERSON_ID IS NOT NULL THEN
		SELECT COUNT(AG.ADMIN_GROUP_ID) INTO LI_GROUP_COUNT
		FROM ADMIN_GROUP AG 
		WHERE AG.ROLE_ID IN (
			SELECT PR.ROLE_ID 
			FROM PERSON_ROLES PR 
			WHERE PR.PERSON_ID = LS_ADMIN_PERSON_ID
		)
		AND AG.IS_ACTIVE = 'Y'
		AND AG.MODULE_CODE = 13;

		IF LI_GROUP_COUNT = 1 THEN
			SELECT ADMIN_GROUP_ID INTO LI_FINAL_GROUP_ID
			FROM ADMIN_GROUP AG 
			WHERE AG.ROLE_ID IN (
				SELECT PR.ROLE_ID 
				FROM PERSON_ROLES PR 
				WHERE PR.PERSON_ID = LS_ADMIN_PERSON_ID
			)
			AND AG.IS_ACTIVE = 'Y'
			AND AG.MODULE_CODE = 13
			LIMIT 1;
		END IF;
	END IF;

    IF LI_FINAL_GROUP_ID IS NOT NULL THEN 
    SELECT ADMIN_GROUP_NAME INTO AV_GROUP_NAME FROM admin_group WHERE ADMIN_GROUP_ID = LI_FINAL_GROUP_ID;
    END IF;
    
	IF LS_ADMIN_PERSON_ID IS NOT NULL THEN 
    SELECT FULL_NAME INTO AV_ADMIN_NAME FROM PERSON WHERE PERSON_ID = LS_ADMIN_PERSON_ID;
    END IF;
    
		SELECT 
        LI_FINAL_GROUP_ID,
		LS_ADMIN_PERSON_ID 
        INTO  AV_ADMIN_GROUP_ID, 
        AV_ADMIN_PERSON_ID ;

END
