-- `GET_UNIT_BASED_PERSON_AND_RIGHT`; 

CREATE PROCEDURE `GET_UNIT_BASED_PERSON_AND_RIGHT`(AV_RIGHT_NAME TEXT,
AV_PERSON_ID VARCHAR(40),
AV_SEARCH VARCHAR(40)
)
BEGIN
DECLARE LS_DYN_SQL TEXT default '';
DECLARE LS_RIGHT_NAME TEXT;
IF AV_RIGHT_NAME != '' THEN
	SET LS_RIGHT_NAME = CONCAT("'", REPLACE(AV_RIGHT_NAME, ",", "','"), "'");
ELSE
	SET LS_RIGHT_NAME = AV_RIGHT_NAME;
END IF;
					SET LS_DYN_SQL = CONCAT('WITH ACCESS_TMP 
							AS
							(
							SELECT UNIT_NUMBER
							FROM PERSON_ROLES T1
							INNER JOIN ROLE_RIGHTS T2 ON T1.ROLE_ID = T2.ROLE_ID
							INNER JOIN RIGHTS T3 ON T2.RIGHT_ID = T3.RIGHT_ID 
							WHERE T1.DESCEND_FLAG = ''N'' AND T1.PERSON_ID = ''',AV_PERSON_ID,'''
							AND RIGHT_NAME IN (',LS_RIGHT_NAME,')							
							UNION
							SELECT CHILD_UNIT_NUMBER FROM UNIT_WITH_CHILDREN 
							WHERE UNIT_NUMBER IN (
							SELECT UNIT_NUMBER
							FROM PERSON_ROLES T1
							INNER JOIN ROLE_RIGHTS T2 ON T1.ROLE_ID = T2.ROLE_ID
							INNER JOIN RIGHTS T3 ON T2.RIGHT_ID = T3.RIGHT_ID 
							WHERE T1.DESCEND_FLAG = ''Y'' AND T1.PERSON_ID = ''',AV_PERSON_ID,'''
							AND RIGHT_NAME IN (',LS_RIGHT_NAME,') 
                            ))
							');
		 set LS_DYN_SQL = concat(LS_DYN_SQL, 'SELECT UNIT_NUMBER,UNIT_NAME,DISPLAY_NAME FROM UNIT WHERE (UNIT_NUMBER IN (SELECT UNIT_NUMBER FROM ACCESS_TMP)
                            AND IS_ACTIVE = ''Y'') AND (LOWER(UNIT_NUMBER) like LOWER(''%',AV_SEARCH,'%'') OR LOWER(UNIT_NAME) like LOWER(''%',AV_SEARCH,'%'')) ORDER BY DISPLAY_NAME ASC');
											
				 SET @QUERY_STATEMENT = LS_DYN_SQL;
				 PREPARE EXECUTABLE_STAEMENT FROM @QUERY_STATEMENT;
				 EXECUTE EXECUTABLE_STAEMENT ; 
END
