CREATE FUNCTION FN_PERSON_HAS_RIGHTS(
AV_RIGHT_NAME            VARCHAR(100),
AV_PERSON_ID             VARCHAR(40),
AV_UNIT_NUMBER           VARCHAR(50),
AV_MODULE_CODE           INT(4),
AV_MODULE_ITEM_KEY       VARCHAR(200),				
AV_PERMISSION_TYPE       VARCHAR(40)	
) RETURNS int(11)
    DETERMINISTIC
BEGIN
DECLARE  LS_UNIT_NUMBER   VARCHAR(50);
DECLARE  LI_COUNT          INT;
DECLARE LI_GRANT          INT DEFAULT 0;
DECLARE LS_GRANT_UNIT    VARCHAR(50);

SET LI_COUNT = 0;
IF AV_PERMISSION_TYPE = 'RIGHT_IN_A_DOCUMENT' THEN

		IF AV_MODULE_CODE = 1 THEN   

				SELECT  LEAD_UNIT_NUMBER INTO LS_UNIT_NUMBER  
				FROM AWARD WHERE AWARD_NUMBER = AV_MODULE_ITEM_KEY ;

		ELSEIF AV_MODULE_CODE = 2 THEN  
        
				SELECT HOME_UNIT_NUMBER INTO LS_UNIT_NUMBER  
				FROM PROPOSAL WHERE PROPOSAL_NUMBER = AV_MODULE_ITEM_KEY;
                
		ELSEIF AV_MODULE_CODE = 3 THEN  
        
				SELECT HOME_UNIT_NUMBER  INTO LS_UNIT_NUMBER 
				FROM EPS_PROPOSAL WHERE PROPOSAL_ID = AV_MODULE_ITEM_KEY;

		ELSEIF AV_MODULE_CODE = 5 THEN 

				SELECT COALESCE(T3.HOME_UNIT_NUMBER,T2.LEAD_UNIT_NUMBER) INTO LS_UNIT_NUMBER 
				FROM  NEGOTIATION_ASSOCIATION T1 
				LEFT JOIN AWARD T2 ON T1.ASSOCIATED_PROJECT_ID = T2.AWARD_NUMBER AND T1.ASSOCIATION_TYPE_CODE = 1
				LEFT JOIN PROPOSAL T3 ON T3.PROPOSAL_ID = T1.ASSOCIATED_PROJECT_ID AND T1.ASSOCIATION_TYPE_CODE = 2
				WHERE T1.NEGOTIATION_ID = AV_MODULE_ITEM_KEY ;
            
		ELSEIF AV_MODULE_CODE = 15 THEN 
            
				SELECT HOME_UNIT_NUMBER INTO LS_UNIT_NUMBER  
				FROM GRANT_CALL_HEADER WHERE GRANT_HEADER_ID = AV_MODULE_ITEM_KEY;
         
         END IF;
         
ELSEIF AV_PERMISSION_TYPE = 'RIGHT_IN_DEPT' THEN
          SET LS_UNIT_NUMBER = AV_UNIT_NUMBER;
            
END IF;

IF AV_PERMISSION_TYPE IN ('RIGHT_IN_A_DOCUMENT','RIGHT_IN_DEPT') THEN
		
		SELECT  COUNT(1) INTO LI_COUNT
        FROM
        PERSON_ROLES PR JOIN
        (SELECT ROLE_ID,RT.RIGHT_NAME 
           FROM ROLE_RIGHTS RR,
                RIGHTS RT
            WHERE RR.RIGHT_ID = RT.RIGHT_ID
              AND RT.RIGHT_NAME = AV_RIGHT_NAME
        ) RLE ON RLE.ROLE_ID = PR.ROLE_ID
        WHERE PR.PERSON_ID = AV_PERSON_ID
          AND (( PR. DESCEND_FLAG = 'Y' AND  EXISTS (SELECT 1
                                                                 FROM UNIT_WITH_CHILDREN 
                                                                                  WHERE UNIT_NUMBER = PR.UNIT_NUMBER
																				  AND CHILD_UNIT_NUMBER = LS_UNIT_NUMBER
             ))OR ( PR. DESCEND_FLAG = 'N' AND PR.UNIT_NUMBER = LS_UNIT_NUMBER )
            );
    
    IF LI_COUNT > 0 THEN
       RETURN 1;
    END IF;
    

	RETURN 0;
    
ELSEIF AV_PERMISSION_TYPE IN ('RIGHT_IN_ANY_DEPT') THEN
    
	SELECT  COUNT(1) INTO LI_COUNT
        FROM
        PERSON_ROLES PR JOIN 
        (SELECT ROLE_ID,RT.RIGHT_NAME 
           FROM ROLE_RIGHTS RR,
                RIGHTS RT
            WHERE RR.RIGHT_ID = RT.RIGHT_ID
              AND RT.RIGHT_NAME = AV_RIGHT_NAME
        ) RLE ON RLE.ROLE_ID = PR.ROLE_ID
        WHERE PR.PERSON_ID = AV_PERSON_ID ;
    
    IF LI_COUNT >= 1 THEN
       RETURN 1;
    END IF;

	RETURN 0;

ELSEIF AV_PERMISSION_TYPE IN ('RIGHT_IN_LINKED_DEPT') THEN

 IF AV_MODULE_CODE = 3 THEN
        
        -- Check if the proposal is linked to a Grant Call
        SELECT T1.HOME_UNIT_NUMBER 
        INTO LS_GRANT_UNIT
        FROM GRANT_CALL_HEADER T1
        INNER JOIN EPS_PROPOSAL T2 ON T1.GRANT_HEADER_ID = T2.GRANT_HEADER_ID
        WHERE T2.PROPOSAL_ID = AV_MODULE_ITEM_KEY
        AND T1.HOME_UNIT_NUMBER <> (SELECT VALUE FROM PARAMETER WHERE PARAMETER_NAME = 'ROOT_UNIT');

        -- If the proposal is linked to a grant call with a different unit, check user rights
        IF LS_GRANT_UNIT IS NOT NULL THEN  
            SET LI_COUNT = 0;
            SELECT COUNT(1) INTO LI_COUNT
            FROM PERSON_ROLES PR
            JOIN (
                SELECT ROLE_ID, RT.RIGHT_NAME 
                FROM ROLE_RIGHTS RR
                JOIN RIGHTS RT ON RR.RIGHT_ID = RT.RIGHT_ID
                WHERE RT.RIGHT_NAME = AV_RIGHT_NAME
            ) RLE ON RLE.ROLE_ID = PR.ROLE_ID
            WHERE PR.PERSON_ID = AV_PERSON_ID
            AND (
                (PR.DESCEND_FLAG = 'Y' AND EXISTS (
                    SELECT 1 FROM UNIT_WITH_CHILDREN 
                    WHERE UNIT_NUMBER = PR.UNIT_NUMBER 
                    AND CHILD_UNIT_NUMBER = LS_GRANT_UNIT
                ))
                OR (PR.DESCEND_FLAG = 'N' AND PR.UNIT_NUMBER = LS_GRANT_UNIT)
            );

            IF LI_COUNT > 0 THEN
                RETURN 1;
            END IF;

            END IF;
            SELECT  COUNT(1) INTO LI_COUNT
        FROM
        PERSON_ROLES PR JOIN
        (SELECT ROLE_ID,RT.RIGHT_NAME 
           FROM ROLE_RIGHTS RR,
                RIGHTS RT
            WHERE RR.RIGHT_ID = RT.RIGHT_ID
              AND RT.RIGHT_NAME = AV_RIGHT_NAME
        ) RLE ON RLE.ROLE_ID = PR.ROLE_ID
        WHERE PR.PERSON_ID = AV_PERSON_ID
          AND (( PR. DESCEND_FLAG = 'Y' AND  EXISTS (SELECT 1
                                                                 FROM UNIT_WITH_CHILDREN 
                                                                                  WHERE UNIT_NUMBER = PR.UNIT_NUMBER
                                                                                  AND CHILD_UNIT_NUMBER = AV_UNIT_NUMBER
             ))OR ( PR. DESCEND_FLAG = 'N' AND PR.UNIT_NUMBER = AV_UNIT_NUMBER )
            );

            IF LI_COUNT > 0 THEN
       RETURN 1;
    END IF;
    RETURN 0;
        END IF;

ELSEIF AV_PERMISSION_TYPE IN ('NTU_GM_CUSTOM') THEN

	IF AV_MODULE_CODE = 3 THEN 
		SELECT COUNT(1) INTO LI_GRANT
		FROM EPS_PROPOSAL T1
		INNER JOIN GRANT_CALL_HEADER T2 ON T1.GRANT_HEADER_ID = T2.GRANT_HEADER_ID
		WHERE T1.PROPOSAL_ID = AV_MODULE_ITEM_KEY;
		
		IF LI_GRANT > 0 THEN 
		
			SELECT COUNT(1) INTO LI_COUNT
			FROM EPS_PROPOSAL T1
			INNER JOIN GRANT_CALL_HEADER T2 ON T1.GRANT_HEADER_ID = T2.GRANT_HEADER_ID
			WHERE T1.PROPOSAL_ID = AV_MODULE_ITEM_KEY
			AND T2.HOME_UNIT_NUMBER IN (SELECT  UNIT_NUMBER
										FROM PERSON_ROLES PR JOIN 
			(SELECT ROLE_ID,RT.RIGHT_NAME 
			FROM ROLE_RIGHTS RR,
                RIGHTS RT
            WHERE RR.RIGHT_ID = RT.RIGHT_ID
              AND RT.RIGHT_NAME = AV_RIGHT_NAME
			) RLE ON RLE.ROLE_ID = PR.ROLE_ID
			WHERE PR.PERSON_ID = AV_PERSON_ID);
		
			IF LI_COUNT > 0 THEN
				RETURN 1;
			END IF;
		
		ELSE
		
		
			SELECT COUNT(1) INTO LI_COUNT
			FROM EPS_PROPOSAL T1
			WHERE T1.PROPOSAL_ID = AV_MODULE_ITEM_KEY
			AND T1.HOME_UNIT_NUMBER IN (SELECT  UNIT_NUMBER
										FROM PERSON_ROLES PR JOIN 
			(SELECT ROLE_ID,RT.RIGHT_NAME 
			FROM ROLE_RIGHTS RR,
                RIGHTS RT
            WHERE RR.RIGHT_ID = RT.RIGHT_ID
              AND RT.RIGHT_NAME = AV_RIGHT_NAME
			) RLE ON RLE.ROLE_ID = PR.ROLE_ID
			WHERE PR.PERSON_ID = AV_PERSON_ID);
			
			IF LI_COUNT > 0 THEN
				RETURN 1;
			END IF;
		END IF;
	END IF;
	RETURN 0;
	
END IF;


END
