-- `GENERATE_IP_NUMBER`; 

CREATE PROCEDURE `GENERATE_IP_NUMBER`(
AV_FISCAL_YEAR varchar(40)
)
BEGIN
    DECLARE LI_NEXT_IP_NUMBER INT DEFAULT -1;
	DECLARE LI_FY_BASED_IP_COUNTER INT;
    DECLARE LI_LOCK_ACQUIRED INT DEFAULT 0;
    DECLARE LI_NEXT_VALUE INT;
    DECLARE LI_CURRENT_FY INT;
    DECLARE LI_CURRENT_FY_COUNT INT;
        	
    IF AV_FISCAL_YEAR IS NOT NULL THEN
        	
		SELECT GET_LOCK('LOCK_ON_INSTITUTE_PROPOSAL_NUMBER_GENERATION', 30) INTO LI_LOCK_ACQUIRED;
		
		IF LI_LOCK_ACQUIRED THEN
			SELECT COUNT(*) INTO LI_CURRENT_FY_COUNT FROM SEQ_IP_NUMBER_GNTR;
             IF LI_CURRENT_FY_COUNT = 0 THEN
             INSERT INTO SEQ_IP_NUMBER_GNTR (FY_BASED_IP_COUNTER, CURRENT_FY) VALUES ('1', AV_FISCAL_YEAR);
             END IF;
            SELECT CURRENT_FY INTO LI_CURRENT_FY FROM SEQ_IP_NUMBER_GNTR;
            
            IF LI_CURRENT_FY <> AV_FISCAL_YEAR THEN
            
				UPDATE SEQ_IP_NUMBER_GNTR SET CURRENT_FY = AV_FISCAL_YEAR, FY_BASED_IP_COUNTER = 0 WHERE CURRENT_FY = LI_CURRENT_FY;
                
                SET LI_FY_BASED_IP_COUNTER = 0;
            ELSE
				SELECT FY_BASED_IP_COUNTER INTO LI_FY_BASED_IP_COUNTER FROM SEQ_IP_NUMBER_GNTR WHERE CURRENT_FY = AV_FISCAL_YEAR;
                
			END IF;
 
			SET LI_NEXT_IP_NUMBER = IF(LI_FY_BASED_IP_COUNTER < 9999, LI_FY_BASED_IP_COUNTER + 1, 1);
				
			UPDATE SEQ_IP_NUMBER_GNTR SET FY_BASED_IP_COUNTER = LI_NEXT_IP_NUMBER WHERE CURRENT_FY = AV_FISCAL_YEAR;
            
            COMMIT;
            SET LI_LOCK_ACQUIRED = RELEASE_LOCK('LOCK_ON_INSTITUTE_PROPOSAL_NUMBER_GENERATION');
    
		END IF;
	
		
	
    END IF;
    
    SELECT LI_NEXT_IP_NUMBER;
END
