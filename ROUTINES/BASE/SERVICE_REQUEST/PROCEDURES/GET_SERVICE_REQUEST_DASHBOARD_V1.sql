CREATE PROCEDURE `GET_SERVICE_REQUEST_DASHBOARD_V1`(
    IN AV_FILTER_JSON JSON,
    IN AV_DISPLAY_LIST JSON,
    IN AV_PERSON_ID VARCHAR(40),
    IN AV_OFFSET INT(10),
    IN AV_LIMIT INT(10),
    IN AV_TAB_TYPE VARCHAR(30),
    IN AV_IS_COUNT BOOLEAN,
    IN AV_SORT_TYPE VARCHAR(500)
)
BEGIN

    -- Declare variables
    DECLARE LS_DYN_SQL LONGTEXT;
    DECLARE LS_FILTER_CONDITION LONGTEXT;
    DECLARE LS_OFFSET INT(11);
    DECLARE IS_UNIT_ADMIN INT(11);
    
    -- Custom data element variables
    DECLARE LI_CUSTOM_DATA_ELEMENTS_ID INT(11);
    DECLARE LI_DATA_TYPE INT(11);
    DECLARE LS_CUST_LABEL VARCHAR(255);
    DECLARE LI_CUST_ORDER INT(11);
    DECLARE LS_IS_MULTI_SELECT_LOOKUP VARCHAR(1);
    DECLARE LS_CUSTOM_CRT VARCHAR(255);
    DECLARE LS_CUST_CRT_VALUE TEXT;
    DECLARE CUSTOM_CRT_QUERY TEXT;
    DECLARE LS_CUSTOM_COL VARCHAR(255);
    DECLARE LS_CUSTOM_DATA_ELEMENT VARCHAR(255);
    DECLARE LS_CUST_COL TEXT;
    DECLARE LS_CUSTOM_DATA_JOIN_SEL TEXT;
    DECLARE NOT_FOUND INT DEFAULT 0;


    -- Cursor for custom data elements
    DECLARE CUSTOM_DATA_ELEMENTS_IDS CURSOR FOR
      SELECT CDE.CUSTOM_DATA_ELEMENTS_ID, CDE.DATA_TYPE, CDE.COLUMN_LABEL, CDEU.ORDER_NUMBER, CDE.IS_MULTI_SELECT_LOOKUP
      FROM CUSTOM_DATA_ELEMENTS CDE
      INNER JOIN CUSTOM_DATA_ELEMENT_USAGE CDEU ON CDEU.CUSTOM_DATA_ELEMENTS_ID = CDE.CUSTOM_DATA_ELEMENTS_ID
      WHERE CDEU.MODULE_CODE = 20 AND CDE.IS_ACTIVE = 'Y' AND CDEU.IS_REQ_ADVANCE_SEARCH = 'Y';
          -- Handler for cursor
   
    DECLARE CONTINUE HANDLER FOR NOT FOUND SET NOT_FOUND = 1;

    


    SET LS_FILTER_CONDITION = '';
    SET LS_CUSTOM_DATA_JOIN_SEL = '';
    SET LS_DYN_SQL = '';
    SET @CUST_CRITERIA_MAP = JSON_OBJECT();
    SET @CUST_COL_MAP = JSON_OBJECT();
    SET @AV_FILTER_JSON = AV_FILTER_JSON;
    SET @AV_DISPLAY_LIST = AV_DISPLAY_LIST;


    SELECT COUNT(1) INTO IS_UNIT_ADMIN 
    FROM ROLE_RIGHTS T1
    LEFT JOIN RIGHTS T2 ON T1.RIGHT_ID = T2.RIGHT_ID
    LEFT JOIN PERSON_ROLES T3 ON T1.ROLE_ID = T3.ROLE_ID
    WHERE T3.PERSON_ID = AV_PERSON_ID AND T2.RIGHT_NAME = 'SERVICE_REQUEST_ADMINISTRATOR';

 -- PREPARE CUSTOM DATA QUERY: START

    -- Process custom data elements
    OPEN CUSTOM_DATA_ELEMENTS_IDS;
    CUSTOM_DATA_ELEMENTS_LOOP: LOOP
        SET NOT_FOUND = 0;
        FETCH CUSTOM_DATA_ELEMENTS_IDS INTO LI_CUSTOM_DATA_ELEMENTS_ID, LI_DATA_TYPE, LS_CUST_LABEL, LI_CUST_ORDER, LS_IS_MULTI_SELECT_LOOKUP;
        
        IF NOT_FOUND = 1 THEN
            LEAVE CUSTOM_DATA_ELEMENTS_LOOP;
        END IF;

        -- Build custom field names
        SET LS_CUSTOM_CRT = CONCAT('CRT_SR_CUST_ELEMENTS_ID_', LI_CUSTOM_DATA_ELEMENTS_ID);
        SET LS_CUSTOM_DATA_ELEMENT = CONCAT('CUST_ELEMENTS_ID_', LI_CUSTOM_DATA_ELEMENTS_ID);
        SET LS_CUST_CRT_VALUE = JSON_UNQUOTE(JSON_EXTRACT(AV_FILTER_JSON, CONCAT('$.', LS_CUSTOM_CRT)));
        
       SET LS_CUSTOM_DATA_JOIN_SEL = CONCAT(
            LS_CUSTOM_DATA_JOIN_SEL,
            CASE 
               WHEN LI_DATA_TYPE = 4 OR (LI_DATA_TYPE IN (8,9) AND LS_IS_MULTI_SELECT_LOOKUP = 'Y') THEN 
				CONCAT(
					'JSON_ARRAYAGG(JSON_OBJECT(''CUSTOM_ANSWER'', CUST_ELEMENTS_ID_', LI_CUSTOM_DATA_ELEMENTS_ID, 
					')) AS CUST_ELEMENTS_ID_', LI_CUSTOM_DATA_ELEMENTS_ID
				)
                WHEN LI_DATA_TYPE = 3 THEN
				CONCAT('(UNIX_TIMESTAMP( CUST_ELEMENTS_ID_', LI_CUSTOM_DATA_ELEMENTS_ID, '))*1000 AS CUST_ELEMENTS_ID_', LI_CUSTOM_DATA_ELEMENTS_ID)
                ELSE 
                    CONCAT('CUST_ELEMENTS_ID_', LI_CUSTOM_DATA_ELEMENTS_ID)
            END,
            ','
        );

        -- Build custom criteria query
        IF LS_CUST_CRT_VALUE IS NOT NULL THEN
            SET CUSTOM_CRT_QUERY = NULL;
            IF LI_DATA_TYPE IN (3) THEN
                SET CUSTOM_CRT_QUERY = CONCAT('(', LS_CUSTOM_DATA_ELEMENT, ' = (UNIX_TIMESTAMP(''', LS_CUST_CRT_VALUE, ''')*1000))');
            ELSEIF LI_DATA_TYPE IN (1,10) THEN
                SET CUSTOM_CRT_QUERY = CONCAT('(', LS_CUSTOM_DATA_ELEMENT, ' LIKE ''%', LS_CUST_CRT_VALUE, '%'')');
            ELSEIF LI_DATA_TYPE IN (4,6,8,9) THEN
                IF LS_IS_MULTI_SELECT_LOOKUP = 'Y' THEN
                    SET CUSTOM_CRT_QUERY = CONCAT('(EXISTS(SELECT 1 FROM SR_CUSTOM_DATA_RT WHERE SR_HEADER_ID = T1.SR_HEADER_ID AND MATCH(', LS_CUSTOM_DATA_ELEMENT, ') AGAINST (''', LS_CUST_CRT_VALUE, ''') ))');
                ELSE
					SET CUSTOM_CRT_QUERY = CONCAT('(EXISTS(SELECT 1 FROM SR_CUSTOM_DATA_RT WHERE SR_HEADER_ID = T1.SR_HEADER_ID AND ', LS_CUSTOM_DATA_ELEMENT, ' IN (SELECT value FROM JSON_TABLE(''',LS_CUST_CRT_VALUE,''',"$[*]" COLUMNS (value LONGTEXT PATH "$")) AS t)  ))');
                END IF;
            ELSE
				IF LI_DATA_TYPE IN (7, 5)THEN
                 SET LS_CUST_CRT_VALUE = JSON_UNQUOTE(JSON_EXTRACT(LS_CUST_CRT_VALUE, '$[0]'));
                END IF;
                
                SET CUSTOM_CRT_QUERY = CONCAT('(', LS_CUSTOM_DATA_ELEMENT, ' = ''', LS_CUST_CRT_VALUE, ''')');
            END IF;
            
            IF CUSTOM_CRT_QUERY IS NOT NULL THEN
                SET @CUST_CRITERIA_MAP = JSON_INSERT(@CUST_CRITERIA_MAP, CONCAT('$.', LS_CUSTOM_CRT), CUSTOM_CRT_QUERY);
            END IF;
        END IF;
        
        -- Handle custom column display
        SET LS_CUSTOM_COL = CONCAT('COL_SR_CUST_ELEMENTS_ID_', LI_CUSTOM_DATA_ELEMENTS_ID);

        IF JSON_CONTAINS(AV_DISPLAY_LIST, JSON_QUOTE(LS_CUSTOM_COL)) = 1 THEN
            SET @CUST_COL_MAP = JSON_INSERT(@CUST_COL_MAP, CONCAT('$.', LS_CUSTOM_COL), CONCAT('CD.', CONCAT('CUST_ELEMENTS_ID_', LI_CUSTOM_DATA_ELEMENTS_ID)));
        END IF;
  
    END LOOP CUSTOM_DATA_ELEMENTS_LOOP;
    CLOSE CUSTOM_DATA_ELEMENTS_IDS;
 -- PREPARE CUSTOM DATA QUERY: END
 SET LS_CUSTOM_DATA_JOIN_SEL = TRIM(TRAILING ',' FROM LS_CUSTOM_DATA_JOIN_SEL);




 -- PREPARE CTE QUERY: START
    SET @DYNAMIC_CTE = CONCAT('WITH ACCESS_TMP AS (
                                SELECT UNIT_NUMBER
                                FROM PERSON_ROLES T1
                                INNER JOIN ROLE_RIGHTS T2 ON T1.ROLE_ID = T2.ROLE_ID
                                INNER JOIN RIGHTS T3 ON T2.RIGHT_ID = T3.RIGHT_ID 
                                WHERE T1.DESCEND_FLAG = ''N'' AND T1.PERSON_ID = ''', AV_PERSON_ID, '''
                                AND T3.RIGHT_NAME IN (''SERVICE_REQUEST_ADMINISTRATOR'')
                                UNION
                                SELECT CHILD_UNIT_NUMBER FROM UNIT_WITH_CHILDREN 
                                WHERE UNIT_NUMBER IN (
                                    SELECT UNIT_NUMBER
                                    FROM PERSON_ROLES T1
                                    INNER JOIN ROLE_RIGHTS T2 ON T1.ROLE_ID = T2.ROLE_ID
                                    INNER JOIN RIGHTS T3 ON T2.RIGHT_ID = T3.RIGHT_ID 
                                    WHERE T1.DESCEND_FLAG = ''Y'' AND T1.PERSON_ID = ''', AV_PERSON_ID, '''
                                    AND T3.RIGHT_NAME IN (''SERVICE_REQUEST_ADMINISTRATOR'')
                                )),
								
							SR_TASK_ROLES AS(
                                SELECT UNIT_NUMBER
                                FROM PERSON_ROLES T1
                                INNER JOIN ROLE_RIGHTS T2 ON T1.ROLE_ID = T2.ROLE_ID
                                INNER JOIN RIGHTS T3 ON T2.RIGHT_ID = T3.RIGHT_ID 
                                WHERE T1.DESCEND_FLAG = ''N'' AND T1.PERSON_ID = ''', AV_PERSON_ID, '''
                                AND T3.RIGHT_NAME IN (''MANAGE_SERVICE_REQUEST_TASK'')
                                UNION
                                SELECT CHILD_UNIT_NUMBER FROM UNIT_WITH_CHILDREN 
                                WHERE UNIT_NUMBER IN (
                                    SELECT UNIT_NUMBER
                                    FROM PERSON_ROLES T1
                                    INNER JOIN ROLE_RIGHTS T2 ON T1.ROLE_ID = T2.ROLE_ID
                                    INNER JOIN RIGHTS T3 ON T2.RIGHT_ID = T3.RIGHT_ID 
                                    WHERE T1.DESCEND_FLAG = ''Y'' AND T1.PERSON_ID = ''', AV_PERSON_ID, '''
                                    AND T3.RIGHT_NAME IN (''MANAGE_SERVICE_REQUEST_TASK'')
                                )			
							),
                            ACCESS_TMP_SR AS (
                                SELECT UNIT_NUMBER
                                FROM PERSON_ROLES T1
                                INNER JOIN ROLE_RIGHTS T2 ON T1.ROLE_ID = T2.ROLE_ID
                                INNER JOIN RIGHTS T3 ON T2.RIGHT_ID = T3.RIGHT_ID 
                                WHERE T1.DESCEND_FLAG = ''N'' AND T1.PERSON_ID = ''', AV_PERSON_ID, '''
                                AND T3.RIGHT_NAME IN (''MODIFY_SERVICE_REQUEST'',''VIEW_SERVICE_REQUEST'')
                                UNION
                                SELECT CHILD_UNIT_NUMBER FROM UNIT_WITH_CHILDREN 
                                WHERE UNIT_NUMBER IN (
                                    SELECT UNIT_NUMBER
                                    FROM PERSON_ROLES T1
                                    INNER JOIN ROLE_RIGHTS T2 ON T1.ROLE_ID = T2.ROLE_ID
                                    INNER JOIN RIGHTS T3 ON T2.RIGHT_ID = T3.RIGHT_ID 
                                    WHERE T1.DESCEND_FLAG = ''Y'' AND T1.PERSON_ID = ''', AV_PERSON_ID, '''
                                    AND T3.RIGHT_NAME IN (''MODIFY_SERVICE_REQUEST'',''VIEW_SERVICE_REQUEST'')
                                )),
                            SR_TEMP AS (
                                SELECT T1.SR_HEADER_ID 
                                FROM SR_HEADER T1 
                                INNER JOIN WORKFLOW T9 ON T9.MODULE_ITEM_ID = T1.SR_HEADER_ID
                                INNER JOIN WORKFLOW_DETAIL T10 ON T9.WORKFLOW_ID = T10.WORKFLOW_ID
                                WHERE T10.APPROVER_PERSON_ID = ''', AV_PERSON_ID, '''
                                AND T9.MODULE_CODE = 20 
                                AND T9.IS_WORKFLOW_ACTIVE = ''Y'' 
                                AND T10.APPROVAL_STATUS = ''W''
                            ),  
                            SR_HEADER_IDS AS (
                                SELECT DISTINCT SR_HEADER_ID 
                                FROM SR_PERSON_ROLES T5
                                INNER JOIN ROLE_RIGHTS RR ON RR.ROLE_ID = T5.ROLE_ID
                                INNER JOIN RIGHTS R ON R.RIGHT_ID = RR.RIGHT_ID 
                                WHERE R.RIGHT_NAME IN (''SERVICE_REQUEST_WATCHER'', ''MODIFY_SERVICE_REQUEST'',''VIEW_SERVICE_REQUEST'')
                                AND T5.PERSON_ID = ''', AV_PERSON_ID, '''
                            ),
                            SR_HEADER_IDS_FOR_WAT AS (
                                SELECT DISTINCT SR_HEADER_ID 
                                FROM SR_PERSON_ROLES T5
                                INNER JOIN ROLE_RIGHTS RR ON RR.ROLE_ID = T5.ROLE_ID
                                INNER JOIN RIGHTS R ON R.RIGHT_ID = RR.RIGHT_ID 
                                WHERE R.RIGHT_NAME IN (''SERVICE_REQUEST_WATCHER'')
                                AND T5.PERSON_ID = ''', AV_PERSON_ID, ''')');
 -- PREPARE CTE QUERY: END

SET @ASSOC_CTE = 'SR_ASSOC_DETAIL AS (
                            SELECT 
                            T.SR_HEADER_ID,
                            JSON_ARRAYAGG(
                                JSON_OBJECT(
                                ''MODULE_CODE'', T.MODULE_CODE,
                                ''MODULE_NAME'', T.MODULE_NAME,
                                ''MODULE_ITEM_KEY'', T.MODULE_ITEM_KEY,
                                ''MODULE_ITEM_ID'', T.MODULE_ITEM_ID,
                                ''TITLE'', T.TITLE,
                                ''PI_NAME'', T.PI_NAME,
                                ''PI_PERSON_ID'', T.PI_PERSON_ID,
                                ''PI_ROLODEX_PERSON_ID'', T.PI_ROLODEX_PERSON_ID,
                                ''SPONSOR_CODE'', T.SPONSOR_CODE,
                                ''SPONSOR_NAME'', T.SPONSOR_NAME,
                                ''START_DATE'', (UNIX_TIMESTAMP(T.START_DATE)*1000),
								''END_DATE'', (UNIX_TIMESTAMP(T.END_DATE)*1000),
                                ''LEAD_UNIT_NUMBER'', T.LEAD_UNIT_NUMBER,
                                ''LEAD_UNIT_NAME'', T.LEAD_UNIT_NAME)) AS MODULES
                                FROM sr_assoc_detail_v T
                                GROUP BY T.SR_HEADER_ID)';

SET @KEY_PERSONS_CTE ='KEY_PERSONS AS (
                                SELECT SP.SR_HEADER_ID,
					JSON_ARRAYAGG(
						JSON_OBJECT(
							''FIRST_NAME'', COALESCE(P.FIRST_NAME, R.FIRST_NAME),
							''LAST_NAME'', COALESCE(P.LAST_NAME, R.LAST_NAME),
							''FULL_NAME'', COALESCE(P.FULL_NAME, CONCAT(R.FIRST_NAME, '' '', R.LAST_NAME)),
							''ROLE_NAME'', PR.DESCRIPTION,
							''PERCENTAGE_OF_EFFORT'', SP.PERCENTAGE_OF_EFFORT
						)
					) AS KEY_PERSONS
				FROM SR_PERSONS SP
				LEFT JOIN PERSON P ON P.PERSON_ID = SP.PERSON_ID
				LEFT JOIN ROLODEX R ON R.ROLODEX_ID = SP.ROLODEX_ID
				INNER JOIN EPS_PROP_PERSON_ROLE PR ON PR.PROP_PERSON_ROLE_ID = SP.PERSON_ROLE_ID
				GROUP BY SP.SR_HEADER_ID
                            )';

SET @TASK_DETAIL_CTE ='TASK_DETAILS AS (
                    SELECT T1.SR_HEADER_ID,
                    JSON_ARRAYAGG(JSON_OBJECT(''TASK_TYPE'', T2.DESCRIPTION,''TASK_STATUS'', T3.DESCRIPTION)) AS TASK_DETAILS
                    FROM SR_TASK T1
                    INNER JOIN sr_task_type T2 ON T1.task_type_code = T2.task_type_code
                    INNER JOIN sr_task_status T3 ON T1.task_status_code = T3.task_status_code
                    GROUP BY T1.SR_HEADER_ID
                            )';                             

 SET @CTE_MAP = JSON_OBJECT(
    'CTE_ASSOC', @ASSOC_CTE,
    'CTE_KEY_PERSONS', @KEY_PERSONS_CTE,
    'CTE_TASK_DETAIL', @TASK_DETAIL_CTE
    );

    SET @CTE_KEY_MAP = JSON_ARRAY(
    JSON_OBJECT('CTE_ASSOC', JSON_ARRAY('COL_ASSOC_SR_SPONSOR','COL_ASSOC_SR_LINKED_ID','COL_LINKED_RECORD_PI','COL_ASSOC_START_DATE','COL_ASSOC_END_DATE')),
    JSON_OBJECT('CTE_KEY_PERSONS', JSON_ARRAY('CRT_SR_KEY_PERSONS','COL_SR_KEY_PERSONS')),
    JSON_OBJECT('CTE_TASK_DETAIL', JSON_ARRAY('COL_SR_TASK_DETAILS'))
    );

SET @DYNAMIC_CTE = CONCAT(@DYNAMIC_CTE, COALESCE(FN_PREPARE_DASHBOARD_JOINS(@AV_DISPLAY_LIST,  @AV_FILTER_JSON, @CTE_KEY_MAP, @CTE_MAP, 'CTE'),''));
-- PREPARE COLUMN QUERY: START
    IF AV_IS_COUNT = FALSE THEN
        SET @QUERY_MAP = JSON_OBJECT(
			'serviceRequestId','T1.SR_HEADER_ID',
			'statusCode','T1.STATUS_CODE',
			'isSystemGenerated','T1.IS_SYSTEM_GENERATED',
			'unitNumber','T1.UNIT_NUMBER',
			'HEADER_ID','T1.SR_HEADER_ID',
            'IS_WATCHER', 'CASE WHEN ((SELECT COUNT(1) FROM SR_HEADER_IDS_FOR_WAT WHERE SR_HEADER_ID = T1.SR_HEADER_ID) > 0) THEN ''TRUE'' ELSE ''FALSE'' END',
            'COL_SR_ID', 'T1.SR_HEADER_ID',
            'COL_SR_CATEGORY', 'T8.DESCRIPTION',
            'COL_SR_ASSIGNEE', '(COALESCE(CONCAT(T6.FULL_NAME, '' | '', T10.ADMIN_GROUP_NAME), T10.ADMIN_GROUP_NAME, T6.FULL_NAME, ''Unassigned''))',
            'COL_SR_ADMIN_GROUP','T10.ADMIN_GROUP_NAME',
            'COL_SR_ASSI_PERSON','T6.FULL_NAME',
            'COL_SR_REPORTER', 'T7.FULL_NAME',
            'COL_SR_TYPE', 'T2.DESCRIPTION',
            'COL_SR_TYPE_CODE', 'T1.TYPE_CODE',
            'COL_SR_STATUS_CODE', 'T1.STATUS_CODE',
            'COL_SR_PRIORITY_ID', 'T1.PRIORITY_ID',
            'COL_SR_SUBJECT', 'T1.SUBJECT',
            'COL_SR_DEPARTMENT', 'T4.DISPLAY_NAME',
            'COL_SR_UNIT_NUMBER', 'T1.UNIT_NUMBER',
            'COL_SR_STATUS', 'T3.DESCRIPTION',
            'COL_SR_UPDATE_TIMESTAMP', 'T1.UPDATE_TIMESTAMP',
            'COL_SR_ADMIN_GROUP_ID', 'T1.ADMIN_GROUP_ID',
            'COL_SR_CATEGORY_CODE', 'T1.CATEGORY_CODE',
            'COL_SR_PRIORITY', 'T9.DESCRIPTION',
            'COL_SR_CREATE_DATE', '(UNIX_TIMESTAMP(T1.CREATE_TIMESTAMP)*1000)',
            'COL_SR_PI','(SR_PI.PI_NAMES)',
            'COL_ASSOC_SR_SPONSOR','(ASD.MODULES)',
            'COL_ASSOC_SR_LINKED_ID','(ASD.MODULES)',
            'COL_LINKED_RECORD_PI','(ASD.MODULES)',
            'COL_ASSOC_START_DATE','(ASD.MODULES)',
            'COL_ASSOC_END_DATE','(ASD.MODULES)',
            'COL_SR_KEY_PERSONS','(KP.KEY_PERSONS)',
            'COL_SR_TASK_DETAILS','(TD.TASK_DETAILS)'
        );
        SET AV_DISPLAY_LIST = JSON_ARRAY_APPEND(AV_DISPLAY_LIST,'$','HEADER_ID');
        SET AV_DISPLAY_LIST = JSON_ARRAY_APPEND(AV_DISPLAY_LIST,'$','IS_WATCHER');
        
        SET AV_DISPLAY_LIST = JSON_ARRAY_APPEND(AV_DISPLAY_LIST,'$','serviceRequestId');
        SET AV_DISPLAY_LIST = JSON_ARRAY_APPEND(AV_DISPLAY_LIST,'$','statusCode');
        SET AV_DISPLAY_LIST = JSON_ARRAY_APPEND(AV_DISPLAY_LIST,'$','isSystemGenerated');
        SET AV_DISPLAY_LIST = JSON_ARRAY_APPEND(AV_DISPLAY_LIST,'$','unitNumber');

        SELECT JSON_MERGE_PATCH(@QUERY_MAP, @CUST_COL_MAP) INTO @QUERY_MAP;

        -- Build display mapping from requested columns
        SET @DISPLAY_MAP = (
            SELECT JSON_OBJECTAGG(jk.k, JSON_UNQUOTE(JSON_EXTRACT(@QUERY_MAP, CONCAT('$.', jk.k))))
            FROM JSON_TABLE(AV_DISPLAY_LIST, '$[*]' COLUMNS (k VARCHAR(100) PATH '$')) AS jk
            WHERE JSON_EXTRACT(@QUERY_MAP, CONCAT('$.', jk.k)) IS NOT NULL
        );
        
        SELECT FN_PREPARE_DASHBOARD_SELECT(@DISPLAY_MAP) INTO @SELECT_STM;
        SELECT FN_PREPARE_DASHBOARD_JSON(@DISPLAY_MAP) INTO @DISPLAY;

    END IF;
-- PREPARE COLUMN QUERY: END


-- PREPARE JOIN QUERY: START

	SET @CUSTOM_DATA_JOIN = CONCAT('LEFT JOIN (SELECT SR_HEADER_ID,',LS_CUSTOM_DATA_JOIN_SEL,' FROM SR_CUSTOM_DATA_RT GROUP BY SR_HEADER_ID) CD ON CD.SR_HEADER_ID = T1.SR_HEADER_ID');

    SET @JOIN_QUERY_MAP = JSON_OBJECT(
    'JOIN_CUSTOM_DATA',@CUSTOM_DATA_JOIN,
    'JOIN_SR_PRIORITY', 'LEFT JOIN SR_PRIORITY T9 ON T9.PRIORITY_ID = T1.PRIORITY_ID',
    'JOIN_SR_KEY_PERSONS',' LEFT JOIN KEY_PERSONS KP ON T1.SR_HEADER_ID = KP.SR_HEADER_ID',
	'JOIN_SR_PI','LEFT JOIN (SELECT SR_HEADER_ID, GROUP_CONCAT(FULL_NAME SEPARATOR '' | '') AS PI_NAMES FROM SR_PERSONS WHERE PERSON_ROLE_ID = 3 GROUP BY SR_HEADER_ID) SR_PI ON SR_PI.SR_HEADER_ID = T1.SR_HEADER_ID',
    'JOIN_SR_ASSOC',' LEFT JOIN SR_ASSOC_DETAIL ASD ON T1.SR_HEADER_ID = ASD.SR_HEADER_ID ',
    'JOIN_SR_TASK',' LEFT JOIN (select DISTINCT SR_HEADER_ID, TASK_TYPE_CODE, TASK_STATUS_CODE  FROM SR_TASK) ST ON ST.SR_HEADER_ID = T1.SR_HEADER_ID',
    'JOIN_SR_CATEGORY', 'LEFT JOIN SR_CATEGORY T8 ON T8.CATEGORY_CODE = T1.CATEGORY_CODE',
    'JOIN_SR_REPORTER_PERSON', 'LEFT JOIN PERSON T7 ON T7.PERSON_ID = T1.REPORTER_PERSON_ID',
    'JOIN_SR_ASSIGNEE', 'LEFT JOIN PERSON T6 ON T6.PERSON_ID = T1.ASSIGNEE_PERSON_ID',
    'JOIN_SR_UNIT', 'LEFT JOIN UNIT T4 ON T4.UNIT_NUMBER = T1.UNIT_NUMBER',
    'JOIN_TASK_DETAIL', 'LEFT JOIN TASK_DETAILS TD ON TD.SR_HEADER_ID = T1.SR_HEADER_ID'
    );
    SET @JOIN_KEY_MAP = JSON_ARRAY(
    JSON_OBJECT('JOIN_CUSTOM_DATA', JSON_ARRAY('CUST_ELEMENTS_ID')),
    JSON_OBJECT('JOIN_SR_PRIORITY', JSON_ARRAY('COL_SR_PRIORITY','CRT_SR_PRIORITY')),
    JSON_OBJECT('JOIN_SR_KEY_PERSONS', JSON_ARRAY('CRT_SR_KEY_PERSONS','COL_SR_KEY_PERSONS')),
    JSON_OBJECT('JOIN_SR_PI', JSON_ARRAY('COL_SR_PI')),
    JSON_OBJECT('JOIN_SR_ASSOC', JSON_ARRAY('COL_ASSOC_SR_SPONSOR','COL_ASSOC_SR_LINKED_ID','COL_LINKED_RECORD_PI','COL_ASSOC_START_DATE','COL_ASSOC_END_DATE')),
    JSON_OBJECT('JOIN_SR_TASK', JSON_ARRAY('CRT_SR_TASK_TYPE','CRT_SR_TASK_STATUS')),
    JSON_OBJECT('JOIN_SR_CATEGORY', JSON_ARRAY('COL_SR_CATEGORY')),
    JSON_OBJECT('JOIN_SR_REPORTER_PERSON', JSON_ARRAY('COL_SR_REPORTER')),
    JSON_OBJECT('JOIN_SR_ASSIGNEE', JSON_ARRAY('COL_SR_ASSI_PERSON','COL_SR_ASSIGNEE')),
    JSON_OBJECT('JOIN_SR_UNIT', JSON_ARRAY('COL_SR_DEPARTMENT')),
    JSON_OBJECT('JOIN_TASK_DETAIL', JSON_ARRAY('COL_SR_TASK_DETAILS'))
    );

  SELECT FN_PREPARE_DASHBOARD_JOINS(@AV_DISPLAY_LIST, @AV_FILTER_JSON, @JOIN_KEY_MAP, @JOIN_QUERY_MAP,'JOIN') INTO @JOIN_QUERY;
-- PREPARE JOIN QUERY: END


-- PREPARE TAB QUERY: START
    SET @ALL_REQUEST = CONCAT('
    (
        (
            T1.REPORTER_PERSON_ID = ''', AV_PERSON_ID, '''
            OR T1.ASSIGNEE_PERSON_ID = ''', AV_PERSON_ID, '''
            OR EXISTS (SELECT 1  FROM SR_HEADER_IDS WHERE SR_HEADER_ID = T1.SR_HEADER_ID)
            OR EXISTS (SELECT 1 FROM SR_TEMP WHERE SR_HEADER_ID = T1.SR_HEADER_ID)
            OR T1.UNIT_NUMBER IN (SELECT DISTINCT UNIT_NUMBER  FROM ACCESS_TMP_SR)
        )
        OR
        (
            (EXISTS(SELECT 1 FROM ROLE_RIGHTS T1 LEFT JOIN RIGHTS T2 ON T1.RIGHT_ID = T2.RIGHT_ID LEFT JOIN PERSON_ROLES T3 ON T1.ROLE_ID = T3.ROLE_ID WHERE T3.PERSON_ID = ''', AV_PERSON_ID, ''' AND T2.RIGHT_NAME = ''SERVICE_REQUEST_ADMINISTRATOR'')) 
            AND T1.UNIT_NUMBER IN (SELECT DISTINCT UNIT_NUMBER  FROM ACCESS_TMP)
        )
        OR
        (
            (EXISTS(SELECT 1 FROM ROLE_RIGHTS T1 LEFT JOIN RIGHTS T2 ON T1.RIGHT_ID = T2.RIGHT_ID LEFT JOIN PERSON_ROLES T3 ON T1.ROLE_ID = T3.ROLE_ID WHERE T3.PERSON_ID = ''', AV_PERSON_ID, ''' AND T2.RIGHT_NAME = ''VIEW_SR_ADMIN_GROUP'')) 
            AND T1.ADMIN_GROUP_ID IN (
                SELECT AG.ADMIN_GROUP_ID FROM ADMIN_GROUP AG
                INNER JOIN ROLE_RIGHTS RR ON AG.ROLE_ID = RR.ROLE_ID
                INNER JOIN RIGHTS R ON RR.RIGHT_ID = R.RIGHT_ID
                INNER JOIN PERSON_ROLES PR ON RR.ROLE_ID = PR.ROLE_ID
                WHERE PR.PERSON_ID = ''', AV_PERSON_ID, ''' AND R.RIGHT_NAME = ''VIEW_SR_ADMIN_GROUP''
            )
        )
    )');
    SET @MY_PENDING_SERVICE_REQUEST = CONCAT('(((T1.ASSIGNEE_PERSON_ID = ''', AV_PERSON_ID, ''') 
                                                OR EXISTS (
                                                    SELECT 1 FROM WORKFLOW T9
                                                    INNER JOIN WORKFLOW_DETAIL T10 ON T9.WORKFLOW_ID = T10.WORKFLOW_ID
                                                    WHERE T9.MODULE_ITEM_ID = T1.SR_HEADER_ID
                                                    AND T10.APPROVER_PERSON_ID = ''', AV_PERSON_ID, '''
                                                    AND T9.MODULE_CODE = 20 
                                                    AND T9.IS_WORKFLOW_ACTIVE = ''Y''                                                            
                                                    AND T10.APPROVAL_STATUS = ''W''
                                                ) OR T1.ADMIN_GROUP_ID IN (
                                                    SELECT AG.ADMIN_GROUP_ID
                                                    FROM ADMIN_GROUP AG
                                                    INNER JOIN ROLE_RIGHTS RR ON AG.ROLE_ID = RR.ROLE_ID
                                                    INNER JOIN RIGHTS R ON RR.RIGHT_ID = R.RIGHT_ID
                                                    INNER JOIN PERSON_ROLES PR ON RR.ROLE_ID = PR.ROLE_ID
                                                    WHERE PR.PERSON_ID = ''', AV_PERSON_ID, '''
                                                    AND R.RIGHT_NAME = ''VIEW_SR_ADMIN_GROUP''
                                                )) AND T1.STATUS_CODE IN (2,4,6,15))');

    SET @TAB_QUERY_MAP = JSON_OBJECT(
        'MY_REQUEST', CONCAT('T1.REPORTER_PERSON_ID = ''', AV_PERSON_ID, ''''),
        'UNASSIGNED_REQUESTS', CONCAT('((T1.UNIT_NUMBER IN (SELECT DISTINCT UNIT_NUMBER FROM ACCESS_TMP) OR (T1.REPORTER_PERSON_ID = ''', AV_PERSON_ID, ''') OR (T1.UNIT_NUMBER IN (SELECT DISTINCT UNIT_NUMBER FROM ACCESS_TMP_SR)) OR EXISTS (SELECT 1 FROM SR_HEADER_IDS WHERE SR_HEADER_ID = T1.SR_HEADER_ID)) AND T1.ASSIGNEE_PERSON_ID IS NULL AND T1.ADMIN_GROUP_ID IS NULL AND T1.STATUS_CODE IN (4,6))'),
        'ALL_PENDING_SERVICE_REQUEST', CONCAT(IFNULL(IF(IS_UNIT_ADMIN > 0, '(T1.UNIT_NUMBER IN (SELECT DISTINCT UNIT_NUMBER FROM ACCESS_TMP) AND ((T1.ASSIGNEE_PERSON_ID IS NOT NULL AND T1.STATUS_CODE IN (4,6)) OR (T1.ADMIN_GROUP_ID IS NOT NULL AND T1.STATUS_CODE IN (4,6)) OR T1.STATUS_CODE IN (2)))', '(1=0)'),''),' OR (EXISTS (SELECT 1 FROM SR_TASK WHERE TASK_STATUS_CODE IN (1,4,3) AND ASSIGNEE_PERSON_ID = ''', AV_PERSON_ID, ''' AND SR_HEADER_ID = T1.SR_HEADER_ID)
		OR EXISTS (SELECT 1 FROM ACCESS_TMP_SR WHERE UNIT_NUMBER = T1.UNIT_NUMBER))'),
        'MY_PENDING_SERVICE_REQUEST', CONCAT(@MY_PENDING_SERVICE_REQUEST,' OR ((EXISTS (SELECT 1 FROM SR_TASK WHERE TASK_STATUS_CODE IN (1,4,3) AND ASSIGNEE_PERSON_ID = ''', AV_PERSON_ID, ''' AND SR_HEADER_ID = T1.SR_HEADER_ID))) '),
        'ALL_REQUEST', CONCAT(IFNULL(@ALL_REQUEST, ''),' OR EXISTS (SELECT 1 FROM SR_TASK_ROLES WHERE UNIT_NUMBER = T1.UNIT_NUMBER) OR ((EXISTS (SELECT 1 FROM SR_TASK WHERE  ASSIGNEE_PERSON_ID = ''', AV_PERSON_ID, ''' AND SR_HEADER_ID = T1.SR_HEADER_ID))) '));

    SET @TAB_QUERY = JSON_UNQUOTE(JSON_EXTRACT(@TAB_QUERY_MAP, CONCAT('$.', AV_TAB_TYPE)));

-- PREPARE TAB QUERY: END


 -- PREPARE CRITERIA QUERY: START    
   
    SET @ASSOC_START_DATE_CRT='(EXISTS(SELECT 1 FROM sr_assoc_detail_v WHERE SR_HEADER_ID= T1.SR_HEADER_ID
                        AND (
                            (JSON_UNQUOTE(JSON_EXTRACT(@AV_FILTER_JSON, ''$.CRT_ASSOC_START_DATE.fromDate'')) IS NULL AND CAST(START_DATE AS DATE) <= JSON_UNQUOTE(JSON_EXTRACT(@AV_FILTER_JSON, ''$.CRT_ASSOC_START_DATE.toDate'')))
                            OR (JSON_UNQUOTE(JSON_EXTRACT(@AV_FILTER_JSON, ''$.CRT_ASSOC_START_DATE.toDate'')) IS NULL AND CAST(START_DATE AS DATE) >= JSON_UNQUOTE(JSON_EXTRACT(@AV_FILTER_JSON, ''$.CRT_ASSOC_START_DATE.fromDate'')))
                            OR (CAST(START_DATE AS DATE) BETWEEN JSON_UNQUOTE(JSON_EXTRACT(@AV_FILTER_JSON, ''$.CRT_ASSOC_START_DATE.fromDate'')) AND JSON_UNQUOTE(JSON_EXTRACT(@AV_FILTER_JSON, ''$.CRT_ASSOC_START_DATE.toDate'')))
                            )
                        ))';
    SET @ASSOC_END_DATE_CRT='(EXISTS(SELECT 1 FROM sr_assoc_detail_v WHERE SR_HEADER_ID= T1.SR_HEADER_ID
                        AND (
                            (JSON_UNQUOTE(JSON_EXTRACT(@AV_FILTER_JSON, ''$.CRT_ASSOC_END_DATE.fromDate'')) IS NULL AND CAST(END_DATE AS DATE) <= JSON_UNQUOTE(JSON_EXTRACT(@AV_FILTER_JSON, ''$.CRT_ASSOC_END_DATE.toDate'')))
                            OR (JSON_UNQUOTE(JSON_EXTRACT(@AV_FILTER_JSON, ''$.CRT_ASSOC_END_DATE.toDate'')) IS NULL AND CAST(END_DATE AS DATE) >= JSON_UNQUOTE(JSON_EXTRACT(@AV_FILTER_JSON, ''$.CRT_ASSOC_END_DATE.fromDate'')))
                            OR (CAST(END_DATE AS DATE) BETWEEN JSON_UNQUOTE(JSON_EXTRACT(@AV_FILTER_JSON, ''$.CRT_ASSOC_END_DATE.fromDate'')) AND JSON_UNQUOTE(JSON_EXTRACT(@AV_FILTER_JSON, ''$.CRT_ASSOC_END_DATE.toDate'')))
                            )
                        ))';

    SET @SR_CREATE_DATE_CRT='(
                            (JSON_UNQUOTE(JSON_EXTRACT(@AV_FILTER_JSON, ''$.CRT_SR_CREATE_DATE.fromDate'')) IS NULL AND CAST(T1.CREATE_TIMESTAMP AS DATE) <= JSON_UNQUOTE(JSON_EXTRACT(@AV_FILTER_JSON, ''$.CRT_SR_CREATE_DATE.toDate'')))
                            OR (JSON_UNQUOTE(JSON_EXTRACT(@AV_FILTER_JSON, ''$.CRT_SR_CREATE_DATE.toDate'')) IS NULL AND CAST(T1.CREATE_TIMESTAMP AS DATE) >= JSON_UNQUOTE(JSON_EXTRACT(@AV_FILTER_JSON, ''$.CRT_SR_CREATE_DATE.fromDate'')))
                            OR (CAST(T1.CREATE_TIMESTAMP AS DATE) BETWEEN JSON_UNQUOTE(JSON_EXTRACT(@AV_FILTER_JSON, ''$.CRT_SR_CREATE_DATE.fromDate'')) AND JSON_UNQUOTE(JSON_EXTRACT(@AV_FILTER_JSON, ''$.CRT_SR_CREATE_DATE.toDate'')))
                            )';
	SET @SR_KEY_PERSON_CRT = '(
                                ( JSON_UNQUOTE(JSON_EXTRACT(@AV_FILTER_JSON, ''$.CRT_SR_KEY_PERSONS.isEmp'')) = ''true'' AND EXISTS (SELECT 1 FROM SR_PERSONS WHERE SR_HEADER_ID = T1.SR_HEADER_ID AND PERSON_ID IN (SELECT res FROM JSON_TABLE(JSON_EXTRACT(@AV_FILTER_JSON, ''$.CRT_SR_KEY_PERSONS.values''), ''$[*]'' COLUMNS(res LONGTEXT PATH ''$'')) jt) ) )
                                 OR
                                ( JSON_UNQUOTE(JSON_EXTRACT(@AV_FILTER_JSON, ''$.CRT_SR_KEY_PERSONS.isEmp'')) = ''false'' AND EXISTS (SELECT 1 FROM SR_PERSONS WHERE SR_HEADER_ID = T1.SR_HEADER_ID AND ROLODEX_ID IN (SELECT res FROM JSON_TABLE(JSON_EXTRACT(@AV_FILTER_JSON, ''$.CRT_SR_KEY_PERSONS.values''), ''$[*]'' COLUMNS(res LONGTEXT PATH ''$'')) jt) ) )
                            )';
	SET @CRT_SR_PI_CRT = '(
                                ( JSON_UNQUOTE(JSON_EXTRACT(@AV_FILTER_JSON, ''$.CRT_SR_PI.isEmp'')) = ''true'' AND EXISTS (SELECT 1 FROM SR_PERSONS WHERE SR_HEADER_ID = T1.SR_HEADER_ID AND PERSON_ROLE_ID = 3 AND PERSON_ID IN (SELECT res FROM JSON_TABLE(JSON_EXTRACT(@AV_FILTER_JSON, ''$.CRT_SR_PI.values''), ''$[*]'' COLUMNS(res LONGTEXT PATH ''$'')) jt) ) )
                                 OR
                                ( JSON_UNQUOTE(JSON_EXTRACT(@AV_FILTER_JSON, ''$.CRT_SR_PI.isEmp'')) = ''false'' AND EXISTS (SELECT 1 FROM SR_PERSONS WHERE SR_HEADER_ID = T1.SR_HEADER_ID AND PERSON_ROLE_ID = 3 AND ROLODEX_ID IN (SELECT res FROM JSON_TABLE(JSON_EXTRACT(@AV_FILTER_JSON, ''$.CRT_SR_PI.values''), ''$[*]'' COLUMNS(res LONGTEXT PATH ''$'')) jt) ) )
                            )';
	SET @CRT_LINKED_RECORD_PI_CRT = '(
                                ( JSON_UNQUOTE(JSON_EXTRACT(@AV_FILTER_JSON, ''$.CRT_LINKED_RECORD_PI.isEmp'')) = ''true'' AND EXISTS (SELECT 1 FROM sr_assoc_detail_v WHERE SR_HEADER_ID = T1.SR_HEADER_ID  AND PI_PERSON_ID IN (SELECT res FROM JSON_TABLE(JSON_EXTRACT(@AV_FILTER_JSON, ''$.CRT_LINKED_RECORD_PI.values''), ''$[*]'' COLUMNS(res LONGTEXT PATH ''$'')) jt) ) )
                                 OR
                                ( JSON_UNQUOTE(JSON_EXTRACT(@AV_FILTER_JSON, ''$.CRT_LINKED_RECORD_PI.isEmp'')) = ''false'' AND EXISTS (SELECT 1 FROM sr_assoc_detail_v WHERE SR_HEADER_ID = T1.SR_HEADER_ID AND PI_ROLODEX_PERSON_ID IN (SELECT res FROM JSON_TABLE(JSON_EXTRACT(@AV_FILTER_JSON, ''$.CRT_LINKED_RECORD_PI.values''), ''$[*]'' COLUMNS(res LONGTEXT PATH ''$'')) jt) ) )
                            )';
        SET @CRITERIA_MAP = JSON_OBJECT(
            'CRT_SR_ID', CONCAT('(T1.SR_HEADER_ID LIKE CONCAT("%",JSON_UNQUOTE(JSON_EXTRACT(@AV_FILTER_JSON,''$.CRT_SR_ID'')),"%"))'),
            'CRT_SR_SUBJECT', CONCAT('(T1.SUBJECT LIKE CONCAT("%",JSON_UNQUOTE(JSON_EXTRACT(@AV_FILTER_JSON,''$.CRT_SR_SUBJECT'')),"%"))'),
            'CRT_SR_TYPE', CONCAT('(T1.TYPE_CODE IN (SELECT res FROM JSON_TABLE(JSON_EXTRACT(@AV_FILTER_JSON,''$.CRT_SR_TYPE''), ''$[*]'' COLUMNS(res LONGTEXT PATH ''$'')) jt))'),
            'CRT_SR_DEPARTMENT', CONCAT('(T1.UNIT_NUMBER IN (SELECT res FROM JSON_TABLE(JSON_EXTRACT(@AV_FILTER_JSON, ''$.CRT_SR_DEPARTMENT''), ''$[*]'' COLUMNS(res LONGTEXT PATH ''$'')) jt))'),
            'CRT_SR_PRIORITY', CONCAT('(T1.PRIORITY_ID IN (SELECT res FROM JSON_TABLE(JSON_EXTRACT(@AV_FILTER_JSON,''$.CRT_SR_PRIORITY''), ''$[*]'' COLUMNS(res LONGTEXT PATH ''$'')) jt))'),
            'CRT_SR_STATUS', CONCAT('(T1.STATUS_CODE IN (SELECT res FROM JSON_TABLE(JSON_EXTRACT(@AV_FILTER_JSON, ''$.CRT_SR_STATUS''), ''$[*]'' COLUMNS(res LONGTEXT PATH ''$'')) jt))'),
			'CRT_SR_TASK_TYPE', CONCAT('(ST.task_type_code IN (SELECT res FROM JSON_TABLE(JSON_EXTRACT(@AV_FILTER_JSON, ''$.CRT_SR_TASK_TYPE''), ''$[*]'' COLUMNS(res LONGTEXT PATH ''$'')) jt))'),
			'CRT_SR_TASK_STATUS', CONCAT('(ST.task_status_code IN (SELECT res FROM JSON_TABLE(JSON_EXTRACT(@AV_FILTER_JSON, ''$.CRT_SR_TASK_STATUS''), ''$[*]'' COLUMNS(res LONGTEXT PATH ''$'')) jt))'),
            'CRT_CATEGORY', CONCAT('(T1.CATEGORY_CODE IN (SELECT res FROM JSON_TABLE(JSON_EXTRACT(@AV_FILTER_JSON, ''$.CRT_CATEGORY''), ''$[*]'' COLUMNS(res LONGTEXT PATH ''$'')) jt))'),
            'CRT_SR_PI', @CRT_SR_PI_CRT,
            'CRT_SR_KEY_PERSONS', @SR_KEY_PERSON_CRT,
            'CRT_ASSOC_SR_SPONSOR', '(EXISTS (SELECT 1 FROM sr_assoc_detail_v WHERE SR_HEADER_ID= T1.SR_HEADER_ID AND SPONSOR_CODE IN (SELECT res FROM JSON_TABLE(JSON_EXTRACT(@AV_FILTER_JSON,''$.CRT_ASSOC_SR_SPONSOR''), ''$[*]'' COLUMNS(res LONGTEXT PATH ''$'')) jt)))', 
            'CRT_ASSOC_START_DATE', @ASSOC_START_DATE_CRT,
            'CRT_ASSOC_END_DATE', @ASSOC_END_DATE_CRT,
            'CRT_ASSOC_SR_LINKED_ID', '(EXISTS (SELECT 1 FROM sr_assoc_detail_v WHERE SR_HEADER_ID= T1.SR_HEADER_ID AND MODULE_ITEM_KEY LIKE CONCAT("%",JSON_UNQUOTE(JSON_EXTRACT(@AV_FILTER_JSON,''$.CRT_ASSOC_SR_LINKED_ID'')),"%")))',
            'CRT_LINKED_RECORD_PI', @CRT_LINKED_RECORD_PI_CRT,
            'CRT_SR_CREATE_DATE', @SR_CREATE_DATE_CRT,
            'CRT_SR_ADMIN_GROUP', CONCAT('(T1.ADMIN_GROUP_ID IN (SELECT res FROM JSON_TABLE(JSON_EXTRACT(@AV_FILTER_JSON,''$.CRT_SR_ADMIN_GROUP''), ''$[*]'' COLUMNS(res LONGTEXT PATH ''$'')) jt))'),
            'CRT_SR_ASSI_PERSON', CONCAT('(T1.ASSIGNEE_PERSON_ID IN (SELECT res FROM JSON_TABLE(JSON_EXTRACT(@AV_FILTER_JSON, ''$.CRT_SR_ASSI_PERSON''), ''$[*]'' COLUMNS(res LONGTEXT PATH ''$'')) jt))'),
            'CRT_SR_REPORTER', CONCAT('(T1.REPORTER_PERSON_ID IN (SELECT res FROM JSON_TABLE(JSON_EXTRACT(@AV_FILTER_JSON, ''$.CRT_SR_REPORTER''), ''$[*]'' COLUMNS(res LONGTEXT PATH ''$'')) jt))'),
            'CRT_SR_ASSOC_LINKED_MODULE', '(EXISTS (SELECT 1 FROM sr_assoc_detail_v WHERE SR_HEADER_ID= T1.SR_HEADER_ID AND MODULE_CODE IN (SELECT res FROM JSON_TABLE(JSON_EXTRACT(@AV_FILTER_JSON,''$.CRT_SR_ASSOC_LINKED_MODULE''), ''$[*]'' COLUMNS (res LONGTEXT PATH ''$'')) jt)))'
        ); 
        
        SELECT JSON_MERGE_PATCH(@CRITERIA_MAP, @CUST_CRITERIA_MAP) INTO @CRITERIA_MAP;
        SELECT FN_PREPARE_DASHBOARD_CRITERIA(AV_FILTER_JSON, @CRITERIA_MAP) INTO LS_FILTER_CONDITION;
-- PREPARE CRITERIA QUERY: END

-- PREPARE FINAL AGGREGATED QUERY: START

IF AV_SORT_TYPE IS NULL OR AV_SORT_TYPE = '' THEN
    SET AV_SORT_TYPE = 'T1.UPDATE_TIMESTAMP DESC';
ELSE
    SET AV_SORT_TYPE =  CONCAT(AV_SORT_TYPE,',T1.UPDATE_TIMESTAMP DESC');
END IF;

    SET LS_DYN_SQL = CONCAT(@DYNAMIC_CTE,
        CASE WHEN AV_IS_COUNT = TRUE 
            THEN ' SELECT TOTAL_COUNT FROM (SELECT COUNT(*) AS TOTAL_COUNT'
            ELSE CONCAT(' SELECT ', IFNULL(@DISPLAY, '*'), ' FROM (SELECT ', IFNULL(@SELECT_STM, '*'))
        END, 
        ' FROM SR_HEADER T1
        INNER JOIN SR_TYPE T2 ON T1.TYPE_CODE = T2.TYPE_CODE
        INNER JOIN SR_STATUS T3 ON T3.STATUS_CODE = T1.STATUS_CODE
        LEFT JOIN ADMIN_GROUP T10 ON T10.ADMIN_GROUP_ID = T1.ADMIN_GROUP_ID
        ',IFNULL(@JOIN_QUERY,''),'
        WHERE (T1.IS_SYSTEM_GENERATED = ''N'') ',
        CASE WHEN @TAB_QUERY IS NOT NULL AND @TAB_QUERY <> '' THEN CONCAT('AND ( ', @TAB_QUERY, ')') ELSE '' END, 
        CASE WHEN LS_FILTER_CONDITION IS NOT NULL AND LS_FILTER_CONDITION != '' THEN CONCAT('AND ', LS_FILTER_CONDITION) ELSE ''END,
        IF(AV_IS_COUNT = FALSE,CONCAT(' ORDER BY ', AV_SORT_TYPE, ' '),''),
        IF(AV_IS_COUNT = FALSE,CONCAT(' LIMIT ', AV_LIMIT, ' OFFSET ', AV_OFFSET),''),') T');
-- PREPARE FINAL AGGREGATED QUERY: START
    SET @QUERY_STATEMENT = LS_DYN_SQL;
    PREPARE EXECUTABLE_STATEMENT FROM @QUERY_STATEMENT;
    EXECUTE EXECUTABLE_STATEMENT;
    DEALLOCATE PREPARE EXECUTABLE_STATEMENT;

END
