CREATE PROCEDURE `GET_SERVICE_REQUEST_WIDGET`(
      AV_WIDGET VARCHAR(200),
      AV_PERSON_ID VARCHAR(40),
      AV_SEARCH VARCHAR(3),
      AV_UNIT_NUMBER VARCHAR(50),
      AV_TYPE_CODES VARCHAR(2000),
      AV_STATUS_CODES VARCHAR(200),
      AV_ASSIGNEE_PERSON_ID VARCHAR(40),
      AV_REPORTER_PERSON_ID VARCHAR(40),
      AV_START_DATE VARCHAR(30),
      AV_END_DATE VARCHAR(30),
      AV_PRIORITIES VARCHAR(10),
      AV_FILTER_TYPE VARCHAR(50),
      AV_DESCENT_FLAG VARCHAR(1),
      AV_PAGED  INT(10),
	  AV_LIMIT INT(10)
)
BEGIN
    DECLARE LS_DYN_SQL LONGTEXT DEFAULT '';
    DECLARE LS_FILTER_CONDITIONS LONGTEXT DEFAULT '';
    DECLARE LS_OFFSET_CONDITION VARCHAR(600) DEFAULT '';
    DECLARE LS_OFFSET INT(11);
    DECLARE TAB_QUERY LONGTEXT;
    SET TAB_QUERY ='';
    SET LS_OFFSET = (AV_LIMIT * AV_PAGED);

    SET LS_DYN_SQL = CONCAT('
        WITH ACCESS_TMP AS 
        (
            SELECT UNIT_NUMBER
            FROM PERSON_ROLES T1
            INNER JOIN ROLE_RIGHTS T2 ON T1.ROLE_ID = T2.ROLE_ID
            INNER JOIN RIGHTS T3 ON T2.RIGHT_ID = T3.RIGHT_ID 
            WHERE T1.DESCEND_FLAG = ''N'' AND T1.PERSON_ID = ''', AV_PERSON_ID ,'''
            AND T3.RIGHT_NAME IN ( ''SERVICE_REQUEST_ADMINISTRATOR'',  ''MODIFY_SERVICE_REQUEST'', ''VIEW_SERVICE_REQUEST'')
            UNION
            SELECT CHILD_UNIT_NUMBER FROM UNIT_WITH_CHILDREN 
            WHERE UNIT_NUMBER IN 
            (
                SELECT UNIT_NUMBER
                FROM PERSON_ROLES T1
                INNER JOIN ROLE_RIGHTS T2 ON T1.ROLE_ID = T2.ROLE_ID
                INNER JOIN RIGHTS T3 ON T2.RIGHT_ID = T3.RIGHT_ID 
                WHERE T1.DESCEND_FLAG = ''Y'' AND T1.PERSON_ID = ''', AV_PERSON_ID ,'''
                AND T3.RIGHT_NAME IN (''SERVICE_REQUEST_ADMINISTRATOR'', ''MODIFY_SERVICE_REQUEST'', ''VIEW_SERVICE_REQUEST'')
            )
        ),
        SR_TEMP AS 
        (
            SELECT s.SR_HEADER_ID 
            FROM SR_HEADER s 
            INNER JOIN WORKFLOW T9 ON T9.MODULE_ITEM_ID = s.SR_HEADER_ID
            INNER JOIN WORKFLOW_DETAIL T10 ON T9.WORKFLOW_ID = T10.WORKFLOW_ID
            WHERE T10.APPROVER_PERSON_ID = ''', AV_PERSON_ID ,'''
            AND T9.MODULE_CODE = 20 
            AND T9.IS_WORKFLOW_ACTIVE = ''Y'' 
            AND T10.APPROVAL_STATUS = ''W''
        ),
        SR_HEADER_IDS AS 
        (
            SELECT DISTINCT SR_HEADER_ID 
            FROM SR_PERSON_ROLES T5
            INNER JOIN ROLE_RIGHTS rr ON rr.ROLE_ID = T5.ROLE_ID
            INNER JOIN RIGHTS r ON r.RIGHT_ID = rr.RIGHT_ID 
            WHERE r.RIGHT_NAME IN (''SERVICE_REQUEST_WATCHER'', ''MODIFY_SERVICE_REQUEST'', ''VIEW_SERVICE_REQUEST'')
            AND T5.PERSON_ID = ''', AV_PERSON_ID ,'''
        ),
        SR_VIEW_ASSIGNEE AS
        (
            SELECT AG.ADMIN_GROUP_ID
            FROM ADMIN_GROUP AG
            INNER JOIN ROLE_RIGHTS RR ON AG.ROLE_ID = RR.ROLE_ID
            INNER JOIN RIGHTS R ON RR.RIGHT_ID = R.RIGHT_ID
            INNER JOIN PERSON_ROLES PR ON RR.ROLE_ID = PR.ROLE_ID
            WHERE PR.PERSON_ID = ''', AV_PERSON_ID ,'''
            AND R.RIGHT_NAME = ''VIEW_SR_ADMIN_GROUP''
        )');

    IF AV_UNIT_NUMBER IS NOT NULL AND AV_UNIT_NUMBER != '' THEN

         IF AV_DESCENT_FLAG = 'Y' THEN
	       SET LS_FILTER_CONDITIONS = CONCAT(' AND (( EXISTS (SELECT 1 FROM UNIT_WITH_CHILDREN WHERE UNIT_NUMBER = ''',AV_UNIT_NUMBER,''' AND CHILD_UNIT_NUMBER = T1.UNIT_NUMBER)) OR  (T1.UNIT_NUMBER =''',AV_UNIT_NUMBER,''' ) )');	

        ELSE
 
           SET LS_FILTER_CONDITIONS = CONCAT(' AND (T1.UNIT_NUMBER =''',AV_UNIT_NUMBER,''' )')	;

          END IF;
    END IF;

    IF AV_TYPE_CODES IS NOT NULL AND AV_TYPE_CODES != '' THEN
        SET LS_FILTER_CONDITIONS = CONCAT(LS_FILTER_CONDITIONS, ' AND ST.TYPE_CODE IN (', AV_TYPE_CODES ,')');
    END IF;

    IF AV_STATUS_CODES IS NOT NULL AND AV_STATUS_CODES != '' THEN
        SET LS_FILTER_CONDITIONS = CONCAT(LS_FILTER_CONDITIONS, ' AND T1.STATUS_CODE IN (', AV_STATUS_CODES ,')');
    END IF;

    IF AV_ASSIGNEE_PERSON_ID IS NOT NULL AND AV_ASSIGNEE_PERSON_ID != '' THEN
        SET LS_FILTER_CONDITIONS = CONCAT(LS_FILTER_CONDITIONS, ' AND A1.PERSON_ID = ''', AV_ASSIGNEE_PERSON_ID ,'''');
    END IF;

    IF AV_REPORTER_PERSON_ID IS NOT NULL AND AV_REPORTER_PERSON_ID != '' THEN
        SET LS_FILTER_CONDITIONS = CONCAT(LS_FILTER_CONDITIONS, ' AND R1.PERSON_ID = ''', AV_REPORTER_PERSON_ID ,'''');
    END IF;

    IF AV_START_DATE IS NOT NULL AND AV_START_DATE != '' THEN
        SET LS_FILTER_CONDITIONS = CONCAT(LS_FILTER_CONDITIONS, ' AND T1.CREATE_TIMESTAMP >= ''', AV_START_DATE ,'''');
    END IF;

    IF AV_END_DATE IS NOT NULL AND AV_END_DATE != '' THEN
        SET LS_FILTER_CONDITIONS = CONCAT(LS_FILTER_CONDITIONS, ' AND T1.CREATE_TIMESTAMP <= ''', AV_END_DATE ,'''');
    END IF;
    
    

 
    IF AV_WIDGET = 'PRIORITY_BREAKDOWN_OF_SERVICE_REQUEST' THEN
        SET LS_DYN_SQL = CONCAT(LS_DYN_SQL, '
            SELECT T1.SR_HEADER_ID AS ID,
                   T1.SUBJECT,
                   ST.DESCRIPTION AS TYPE,
                   P1.DESCRIPTION AS PRIORITY,
                   S1.DESCRIPTION AS STATUS,
                   U1.DISPLAY_NAME AS DEPARTMENT,
                   A1.FULL_NAME AS ASSIGNEE,
                   R1.FULL_NAME AS REPORTER
            FROM SR_HEADER T1
            INNER JOIN SR_TYPE ST ON T1.TYPE_CODE = ST.TYPE_CODE
            INNER JOIN SR_PRIORITY P1 ON T1.PRIORITY_ID = P1.PRIORITY_ID
            LEFT JOIN SR_STATUS S1 ON T1.STATUS_CODE = S1.STATUS_CODE
            LEFT JOIN UNIT U1 ON T1.UNIT_NUMBER = U1.UNIT_NUMBER
            LEFT JOIN PERSON A1 ON T1.ASSIGNEE_PERSON_ID = A1.PERSON_ID
            LEFT JOIN PERSON R1 ON T1.REPORTER_PERSON_ID = R1.PERSON_ID
			WHERE 
            (
                T1.REPORTER_PERSON_ID = ''', AV_PERSON_ID ,''' 
                OR T1.ASSIGNEE_PERSON_ID = ''', AV_PERSON_ID ,'''
                OR T1.UNIT_NUMBER IN (SELECT DISTINCT UNIT_NUMBER FROM ACCESS_TMP)
                OR T1.SR_HEADER_ID IN (SELECT DISTINCT SR_HEADER_ID FROM SR_HEADER_IDS)
                OR T1.SR_HEADER_ID IN (SELECT DISTINCT SR_HEADER_ID FROM SR_TEMP)
                OR T1.ADMIN_GROUP_ID IN (SELECT DISTINCT ADMIN_GROUP_ID FROM SR_VIEW_ASSIGNEE)
            )
            AND T1.IS_SYSTEM_GENERATED = ''N''
            AND P1.PRIORITY_ID = ''', AV_SEARCH ,'''');
        SET LS_DYN_SQL = CONCAT(LS_DYN_SQL, LS_FILTER_CONDITIONS, 'ORDER BY T1.UPDATE_TIMESTAMP DESC LIMIT ',AV_LIMIT,' OFFSET ',LS_OFFSET);

    ELSEIF AV_WIDGET = 'CATEGORY_BREAKDOWN_OF_SERVICE_REQUEST' THEN
        SET LS_DYN_SQL = CONCAT(LS_DYN_SQL, '
            SELECT DISTINCT T1.SR_HEADER_ID AS ID,
                            T1.SUBJECT,
                            ST.DESCRIPTION AS TYPE,
                            P1.DESCRIPTION AS PRIORITY,
                            S1.DESCRIPTION AS STATUS,
                            U1.DISPLAY_NAME AS DEPARTMENT,
                            A1.FULL_NAME AS ASSIGNEE,
                            R1.FULL_NAME AS REPORTER
            FROM SR_HEADER T1
            LEFT JOIN SR_CATEGORY C1 ON T1.CATEGORY_CODE = C1.CATEGORY_CODE
            INNER JOIN SR_TYPE ST ON T1.TYPE_CODE = ST.TYPE_CODE   
            INNER JOIN SR_PRIORITY P1 ON T1.PRIORITY_ID = P1.PRIORITY_ID
            LEFT JOIN SR_STATUS S1 ON T1.STATUS_CODE = S1.STATUS_CODE
            LEFT JOIN UNIT U1 ON T1.UNIT_NUMBER = U1.UNIT_NUMBER
            LEFT JOIN PERSON A1 ON T1.ASSIGNEE_PERSON_ID = A1.PERSON_ID
            LEFT JOIN PERSON R1 ON T1.REPORTER_PERSON_ID = R1.PERSON_ID
			WHERE C1.CATEGORY_CODE = ''', AV_SEARCH ,'''
                AND (
                    T1.REPORTER_PERSON_ID = ''', AV_PERSON_ID ,'''
                    OR T1.ASSIGNEE_PERSON_ID = ''', AV_PERSON_ID ,'''
					OR T1.UNIT_NUMBER IN (SELECT DISTINCT UNIT_NUMBER FROM ACCESS_TMP)
                    OR T1.SR_HEADER_ID IN (SELECT DISTINCT SR_HEADER_ID FROM SR_HEADER_IDS)
                    OR T1.SR_HEADER_ID IN (SELECT DISTINCT SR_HEADER_ID FROM SR_TEMP)
                    OR T1.ADMIN_GROUP_ID IN (SELECT DISTINCT ADMIN_GROUP_ID FROM SR_VIEW_ASSIGNEE)
                )
                AND T1.IS_SYSTEM_GENERATED = ''N'' ');
        
        IF AV_PRIORITIES IS NOT NULL AND AV_PRIORITIES != '' THEN
            SET LS_DYN_SQL = CONCAT(LS_DYN_SQL, ' AND P1.PRIORITY_ID IN (', AV_PRIORITIES, ')');
        END IF;

SET LS_DYN_SQL = CONCAT(LS_DYN_SQL, LS_FILTER_CONDITIONS,  'ORDER BY T1.UPDATE_TIMESTAMP DESC LIMIT ',AV_LIMIT,' OFFSET ',LS_OFFSET);


ELSEIF AV_WIDGET = 'SERVICE_REQUEST_RESEARCH_SUMMARY' THEN 

         IF AV_FILTER_TYPE = 'OPENED' THEN

				SET TAB_QUERY = CONCAT(' AND (T1.STATUS_CODE IN (1, 12, 14, 2, 3) OR (T1.STATUS_CODE = 4 AND T1.ASSIGNEE_PERSON_ID IS NULL AND T1.ADMIN_GROUP_ID IS NULL))',LS_FILTER_CONDITIONS);

ELSEIF AV_FILTER_TYPE = 'TOTAL' THEN

				SET TAB_QUERY = CONCAT(LS_FILTER_CONDITIONS);

ELSEIF AV_FILTER_TYPE = 'PENDING' THEN

				SET TAB_QUERY = CONCAT(' AND T1.STATUS_CODE IN (4, 6) AND (T1.ASSIGNEE_PERSON_ID IS NOT NULL OR T1.ADMIN_GROUP_ID IS NOT NULL)',LS_FILTER_CONDITIONS);

 ELSEIF AV_FILTER_TYPE = 'RESOLVED' THEN

				SET TAB_QUERY = CONCAT(' AND T1.STATUS_CODE IN (5)',LS_FILTER_CONDITIONS);

ELSEIF AV_FILTER_TYPE = 'CLOSED' THEN

				SET TAB_QUERY = CONCAT(' AND T1.STATUS_CODE = 8',LS_FILTER_CONDITIONS);

ELSEIF AV_FILTER_TYPE = 'REOPENED' THEN

				SET TAB_QUERY = CONCAT(' AND  T1.STATUS_CODE = 6 AND (T1.ASSIGNEE_PERSON_ID IS  NULL AND T1.ADMIN_GROUP_ID IS  NULL)',LS_FILTER_CONDITIONS);

END IF;

       SET LS_DYN_SQL =CONCAT(LS_DYN_SQL,' SELECT DISTINCT *  FROM(SELECT T1.SR_HEADER_ID,
                                                                    T1.SUBJECT,
                                                                    T9.DESCRIPTION AS PRIORITY,
                                                                    T2.DESCRIPTION AS REQUEST_TYPE,
                                                                    T7.FULL_NAME AS REPORTER_FUL_NAME,	
																	T6.FULL_NAME AS ASIGNEE_FULL_NAME,
																	T3.DESCRIPTION AS REQUEST_STATUS,
                                                                    T1.PRIORITY_ID,
                                                                    T1.STATUS_CODE,
                                                                    T1.ADMIN_GROUP_ID,
																	T10.ADMIN_GROUP_NAME,
																	T1.IS_SYSTEM_GENERATED,
                                                                    T1.UNIT_NUMBER,
                                                                    T1.UPDATE_TIMESTAMP
															FROM SR_HEADER T1
															INNER JOIN SR_TYPE T2 ON T1.TYPE_CODE = T2.TYPE_CODE
															INNER JOIN SR_STATUS T3 ON T3.STATUS_CODE = T1.STATUS_CODE 
															LEFT JOIN PERSON T6 ON T6.PERSON_ID = T1.ASSIGNEE_PERSON_ID
															LEFT JOIN PERSON T7 ON T7.PERSON_ID = T1.REPORTER_PERSON_ID
                                                            LEFT JOIN SR_PRIORITY T9 ON T9.PRIORITY_ID = T1.PRIORITY_ID
                                                            LEFT JOIN ADMIN_GROUP T10 ON T10.ADMIN_GROUP_ID = T1.ADMIN_GROUP_ID
															WHERE 
            (
                T1.REPORTER_PERSON_ID = ''', AV_PERSON_ID ,''' 
                OR T1.ASSIGNEE_PERSON_ID = ''', AV_PERSON_ID ,'''
                OR T1.UNIT_NUMBER IN (SELECT DISTINCT UNIT_NUMBER FROM ACCESS_TMP)
                OR T1.SR_HEADER_ID IN (SELECT DISTINCT SR_HEADER_ID FROM SR_HEADER_IDS)
                OR T1.SR_HEADER_ID IN (SELECT DISTINCT SR_HEADER_ID FROM SR_TEMP)
                OR T1.ADMIN_GROUP_ID IN (SELECT DISTINCT ADMIN_GROUP_ID FROM SR_VIEW_ASSIGNEE)
                
            )',TAB_QUERY,'AND T1.IS_SYSTEM_GENERATED = ''N'')T   ', 'ORDER BY T.UPDATE_TIMESTAMP DESC LIMIT ',AV_LIMIT,' OFFSET ',LS_OFFSET);

    END IF;

    SET @QUERY_STATEMENT = LS_DYN_SQL;
    PREPARE EXECUTABLE_STATEMENT FROM @QUERY_STATEMENT;
    EXECUTE EXECUTABLE_STATEMENT;

END

