-- `FN_CHK_SERVICE_REQUEST_LEAD_UNIT`;


CREATE FUNCTION `FN_CHK_SERVICE_REQUEST_LEAD_UNIT`(
AV_SR_HEADER_ID INT,
AV_UNIT_NUMBER VARCHAR(50)
) RETURNS varchar(10) 
    DETERMINISTIC
BEGIN
DECLARE  LI_FLAG INT;
DECLARE  LI_MODULE_CODE     INT;
DECLARE  LI_MODULE_ITEM_KEY varchar(12);
DECLARE  LS_PROC_LOC         VARCHAR(200);
DECLARE  LS_ERROR_MSG        VARCHAR(4000);
DECLARE NOT_FOUND                       INT;
	DECLARE SEL_ASSOC_SR CURSOR FOR
     	SELECT MODULE_CODE,MODULE_ITEM_ID FROM ASSOC_SR WHERE SR_HEADER_ID = AV_SR_HEADER_ID ;
        	DECLARE EXIT HANDLER FOR SQLEXCEPTION
				BEGIN
				
					GET DIAGNOSTICS CONDITION 1 @sqlstate = RETURNED_SQLSTATE, 
					 @errno = MYSQL_ERRNO, @msg = MESSAGE_TEXT;					 
					SET @full_error = CONCAT(@msg,'/',LS_PROC_LOC);	
					SET LS_ERROR_MSG = @full_error;
                    	RESIGNAL SET MESSAGE_TEXT = LS_ERROR_MSG;
		 
                END;
				
     DECLARE CONTINUE HANDLER FOR NOT FOUND  SET NOT_FOUND = 1;	
	 
	SET LS_PROC_LOC = 'SEL_ASSOC_SR';
			OPEN SEL_ASSOC_SR;
            SEL_ASSOC_SR:LOOP
			SET NOT_FOUND  = 0;
            FETCH SEL_ASSOC_SR INTO LI_MODULE_CODE, LI_MODULE_ITEM_KEY;
            IF NOT_FOUND = 1 THEN
            LEAVE SEL_ASSOC_SR;
            END IF;
    IF LI_MODULE_CODE = 3 THEN 
		SELECT COUNT(1) INTO LI_FLAG FROM EPS_PROPOSAL
		WHERE PROPOSAL_ID = LI_MODULE_ITEM_KEY
		AND HOME_UNIT_NUMBER = AV_UNIT_NUMBER; 
		
		IF LI_FLAG > 0 THEN
			RETURN 'TRUE'; 
		 LEAVE SEL_ASSOC_SR;			
		END IF;
   
    ELSEIF LI_MODULE_CODE = 1 THEN
        SELECT COUNT(1) INTO LI_FLAG FROM AWARD
		WHERE AWARD_ID = LI_MODULE_ITEM_KEY
		AND LEAD_UNIT_NUMBER = AV_UNIT_NUMBER; 
		
		IF LI_FLAG > 0 THEN
			RETURN 'TRUE';  
		 LEAVE SEL_ASSOC_SR;		
		END IF;
        
	 ELSEIF LI_MODULE_CODE = 13  THEN
        SELECT COUNT(1) INTO LI_FLAG FROM AGREEMENT_HEADER
		WHERE AGREEMENT_REQUEST_ID = LI_MODULE_ITEM_KEY
		AND UNIT_NUMBER = AV_UNIT_NUMBER; 
		
		IF LI_FLAG > 0 THEN
			RETURN 'TRUE';  
		LEAVE SEL_ASSOC_SR;			
		END IF;	
    
    ELSEIF LI_MODULE_CODE = 2  THEN
        SELECT COUNT(1) INTO LI_FLAG FROM PROPOSAL
		WHERE PROPOSAL_ID = LI_MODULE_ITEM_KEY
		AND HOME_UNIT_NUMBER = AV_UNIT_NUMBER;
		IF LI_FLAG > 0 THEN
			RETURN 'TRUE';  
		 LEAVE SEL_ASSOC_SR;			
		END IF;	
	END IF;
	END LOOP SEL_ASSOC_SR;
	CLOSE SEL_ASSOC_SR;
    RETURN 'FALSE';  
END
