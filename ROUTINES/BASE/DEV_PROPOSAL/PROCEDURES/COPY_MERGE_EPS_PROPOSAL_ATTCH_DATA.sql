-- `COPY_MERGE_EPS_PROPOSAL_ATTCH_DATA`; 

CREATE PROCEDURE `COPY_MERGE_EPS_PROPOSAL_ATTCH_DATA`(
IN AV_ACTIVE_PROPOSAL_ID  INT,
IN AV_ARCHIVE_PROPOSAL_ID INT,
IN AV_TYPE VARCHAR(1) 
)
BEGIN
	DECLARE LI_ATTACHMNT_TYPE_CODE    INT;
	DECLARE LS_DESCRIPTION            VARCHAR(200);
	DECLARE LS_FILE_NAME                 varchar(300);
	DECLARE LS_MIME_TYPE				  varchar(255);
	DECLARE LD_UPDATE_TIMESTAMP		  datetime;
	DECLARE LS_UPDATE_USER	              varchar(60); 
	DECLARE LS_NARRATIVE_STATUS_CODE	  varchar(3);
	DECLARE LI_VERSION_NUMBER	          int;
	DECLARE LS_FILE_DATA_ID	          varchar(36);
	DECLARE LI_DOCUMENT_STATUS_CODE	  int;
	DECLARE LI_DOCUMENT_ID	              int;
	DECLARE LS_ERROR_MSG	              VARCHAR(2000);
	DECLARE LS_ERROR_FLAG	              VARCHAR(1) DEFAULT 'N';
    DECLARE NOT_FOUND                 INT;
    DECLARE LS_PROC_LOC                VARCHAR(200);
    DECLARE li_seq_proposal_id          INT;
	DECLARE LI_PROPOSAL_ID             INT;
	
    DECLARE  SEL_EPS_ATTACH CURSOR FOR
	SELECT ATTACHMNT_TYPE_CODE, DESCRIPTION, FILE_NAME, MIME_TYPE, UPDATE_TIMESTAMP, UPDATE_USER, NARRATIVE_STATUS_CODE, VERSION_NUMBER, FILE_DATA_ID, DOCUMENT_STATUS_CODE, DOCUMENT_ID FROM EPS_PROPOSAL_ATTACHMENTS WHERE PROPOSAL_ID = LI_PROPOSAL_ID;
	
	 
	
	DECLARE EXIT HANDLER FOR SQLEXCEPTION
				BEGIN
				
					GET DIAGNOSTICS CONDITION 1 @sqlstate = RETURNED_SQLSTATE, 
					 @errno = MYSQL_ERRNO, @msg = MESSAGE_TEXT;					 
					SET @full_error = CONCAT(@msg,'/',LS_PROC_LOC);	
					SET LS_ERROR_MSG = @full_error;
                   RESIGNAL SET MESSAGE_TEXT = LS_ERROR_MSG;		
		 
                END;
				
     DECLARE CONTINUE HANDLER FOR NOT FOUND SET NOT_FOUND = 1;	
 
	 SET LS_ERROR_FLAG = 'N';
	 
		IF AV_TYPE = 'C' THEN 
		
		  SET LI_PROPOSAL_ID = AV_ACTIVE_PROPOSAL_ID;
		  
		ELSEIF AV_TYPE = 'M' THEN 
         SET LS_PROC_LOC = 'DELETE_EPS_PROPOSAL_ATTACHMENTS';
         SET SQL_SAFE_UPDATES = 0;
	   DELETE FROM EPS_PROPOSAL_ATTACHMENTS WHERE PROPOSAL_ID = AV_ACTIVE_PROPOSAL_ID;
	   SET SQL_SAFE_UPDATES = 1;
		 SET LI_PROPOSAL_ID = AV_ARCHIVE_PROPOSAL_ID;		 
		  
		END IF;
		
 
   
		
  SET LS_PROC_LOC = 'EPS_PROPOSAL_ATTACHMENTS';
			
         OPEN SEL_EPS_ATTACH;
            SEL_EPS_ATTACH:LOOP
            SET NOT_FOUND = 0;
            FETCH SEL_EPS_ATTACH INTO LI_ATTACHMNT_TYPE_CODE,LS_DESCRIPTION,LS_FILE_NAME,LS_MIME_TYPE,LD_UPDATE_TIMESTAMP,
									  LS_UPDATE_USER,LS_NARRATIVE_STATUS_CODE,LI_VERSION_NUMBER,LS_FILE_DATA_ID,
									  LI_DOCUMENT_STATUS_CODE,LI_DOCUMENT_ID; 
            IF NOT_FOUND=1 THEN
            LEAVE SEL_EPS_ATTACH;
            END IF; 
			   
                 INSERT INTO EPS_PROPOSAL_ATTACHMENTS	
                (
				 ATTACHMNT_TYPE_CODE, 
				 DESCRIPTION, 
				 FILE_NAME, 
				 MIME_TYPE, 
				 UPDATE_TIMESTAMP, 
				 UPDATE_USER, 
				 PROPOSAL_ID, 
				 NARRATIVE_STATUS_CODE, 
				 VERSION_NUMBER, 
				 FILE_DATA_ID, 
				 DOCUMENT_STATUS_CODE, 
				 DOCUMENT_ID)
                 VALUES(
				 LI_ATTACHMNT_TYPE_CODE,
				 LS_DESCRIPTION,
				 LS_FILE_NAME,
				 LS_MIME_TYPE,
				 LD_UPDATE_TIMESTAMP,
				 LS_UPDATE_USER,
				 CASE WHEN AV_TYPE = 'M' THEN AV_ACTIVE_PROPOSAL_ID ELSE AV_ARCHIVE_PROPOSAL_ID END,
				 LS_NARRATIVE_STATUS_CODE,
				 LI_VERSION_NUMBER,
				 LS_FILE_DATA_ID,
				 LI_DOCUMENT_STATUS_CODE,
				 LI_DOCUMENT_ID 	 
                
                );
				
				
		
                
              
		END LOOP SEL_EPS_ATTACH;
		CLOSE SEL_EPS_ATTACH;
    
		 
END
