-- `COPY_MERGE_EPS_PROPOSAL_PERSON_DATA`; 

CREATE PROCEDURE `COPY_MERGE_EPS_PROPOSAL_PERSON_DATA`(
IN AV_ACTIVE_PROPOSAL_ID  INT,
IN AV_ARCHIVE_PROPOSAL_ID  INT,
IN AV_TYPE VARCHAR(1) 
)
BEGIN
    DECLARE LI_PROPOSAL_PERSON_ID INT;
	DECLARE LS_DEPARTMENT	varchar(90);
    DECLARE LS_ACTIVITY_TYPE_CODE VARCHAR(200);
	DECLARE LS_FULL_NAME	varchar(90);
	DECLARE LS_UNIT_NAME	varchar(200);
	DECLARE LS_UNIT_NUMBER	varchar(50);
	DECLARE LS_PERSON_ID	varchar(40);
	DECLARE LI_PROP_PERSON_ROLE_ID	int;
	DECLARE LI_ROLODEX_ID	int;
	DECLARE LD_UPDATE_TIMESTAMP	datetime;
	DECLARE LS_UPDATE_USER	varchar(60) ;
	DECLARE LI_PERCENTAGE_OF_EFFORT	decimal(5,2);
	DECLARE LS_PI_FLAG	varchar(255);
	DECLARE LS_DESIGNATION	varchar(255);
	DECLARE LS_IS_MULTI_PI	varchar(255);
	DECLARE LS_IS_PERSON_CERTIFIED	varchar(1);
	DECLARE LS_PROJECT_ROLE	varchar(200);
	DECLARE LS_IS_TRAINING_COMPLETED	varchar(16); 
	DECLARE LI_ROLE_ID	int; 
	DECLARE LS_DESCRIPTION	varchar(255);
	DECLARE LS_FILE_DATA_ID	varchar(255);
	DECLARE LS_FILE_NAME	varchar(300);
	DECLARE LS_MIME_TYPE	varchar(255);  
	DECLARE LI_DOCUMENT_ID	int;
	DECLARE LI_VERSION_NUMBER	int;
	DECLARE LI_DOCUMENT_STATUS_CODE	int;
	DECLARE LI_ATTACHMNT_TYPE_CODE	int;
	DECLARE LS_DEGREE_CODE	varchar(10);
	DECLARE LS_DEGREE	varchar(200);
	DECLARE LS_FIELD_OF_STUDY	varchar(200);
	DECLARE LS_SPECIALIZATION	varchar(200);
	DECLARE LS_SCHOOL	varchar(200);
	DECLARE LS_GRADUATION_DATE	varchar(20); 
	DECLARE LS_LEAD_UNIT_FLAG	varchar(1); 
	DECLARE LS_ERROR_MSG	              VARCHAR(2000);
	DECLARE LS_ERROR_FLAG	              VARCHAR(1) DEFAULT 'N';
    DECLARE NOT_FOUND                 INT;
    DECLARE LS_PROC_LOC                VARCHAR(200);
    DECLARE li_seq_proposal_id          INT;
	DECLARE LI_LS_PROPOSAL_PERSON_ID INT;
	
    
	DECLARE  SEL_EPS_PROPOSAL_PERSONS CURSOR FOR
	SELECT PROPOSAL_PERSON_ID, DEPARTMENT, FULL_NAME, UNIT_NAME, UNIT_NUMBER, PERSON_ID, PROP_PERSON_ROLE_ID, ROLODEX_ID, 
	UPDATE_TIMESTAMP, UPDATE_USER,PERCENTAGE_OF_EFFORT, PI_FLAG, 
	DESIGNATION, IS_MULTI_PI, IS_PERSON_CERTIFIED, PROJECT_ROLE, IS_TRAINING_COMPLETED
	FROM EPS_PROPOSAL_PERSONS WHERE PROPOSAL_ID = li_seq_proposal_id;
	
	DECLARE  SEL_EPS_PROPOSAL_PERSON_ROLES CURSOR FOR
	SELECT  PERSON_ID, ROLE_ID, UPDATE_TIMESTAMP, UPDATE_USER
	FROM EPS_PROPOSAL_PERSON_ROLES WHERE PROPOSAL_ID = li_seq_proposal_id;
	
	DECLARE  SEL_EPS_PROPOSAL_PERSON_ATTACHMNT CURSOR FOR
	SELECT DESCRIPTION, FILE_DATA_ID, FILE_NAME, MIME_TYPE, UPDATE_TIMESTAMP, UPDATE_USER, 
	DOCUMENT_ID, VERSION_NUMBER, DOCUMENT_STATUS_CODE, ATTACHMNT_TYPE_CODE
	FROM EPS_PROPOSAL_PERSON_ATTACHMNT WHERE PROPOSAL_PERSON_ID = LI_LS_PROPOSAL_PERSON_ID;
	
	 DECLARE  SEL_EPS_PROPOSAL_PERSON_DEGREE CURSOR FOR
	 SELECT DEGREE_CODE, DEGREE, FIELD_OF_STUDY, SPECIALIZATION, SCHOOL, 
     GRADUATION_DATE, UPDATE_TIMESTAMP, UPDATE_USER FROM EPS_PROPOSAL_PERSON_DEGREE
	  WHERE PROPOSAL_PERSON_ID = LI_LS_PROPOSAL_PERSON_ID;
	 
	 DECLARE  SEL_EPS_PROP_PERSON_UNITS CURSOR FOR
	 SELECT LEAD_UNIT_FLAG, UNIT_NUMBER,UPDATE_TIMESTAMP, UPDATE_USER FROM EPS_PROP_PERSON_UNITS WHERE PROPOSAL_PERSON_ID = LI_LS_PROPOSAL_PERSON_ID;
	
	
	DECLARE EXIT HANDLER FOR SQLEXCEPTION
				BEGIN
				
					GET DIAGNOSTICS CONDITION 1 @sqlstate = RETURNED_SQLSTATE, 
					 @errno = MYSQL_ERRNO, @msg = MESSAGE_TEXT;					 
					SET @full_error = CONCAT(@msg,'/',LS_PROC_LOC);	
					SET LS_ERROR_MSG = @full_error;
                    RESIGNAL SET MESSAGE_TEXT = LS_ERROR_MSG;			
		 
                END;
				
     DECLARE CONTINUE HANDLER FOR NOT FOUND SET NOT_FOUND = 1;	
 
	 SET LS_ERROR_FLAG = 'N';
     
	 IF AV_TYPE = 'M' THEN 
	
    SET SQL_SAFE_UPDATES = 0;
    SET LS_PROC_LOC = 'DELETE_EPS_PROPOSAL_PERSONS';
	DELETE FROM EPS_PROP_PERSON_UNITS WHERE PROPOSAL_PERSON_ID IN (SELECT PROPOSAL_PERSON_ID FROM EPS_PROPOSAL_PERSONS WHERE PROPOSAL_ID IN (AV_ACTIVE_PROPOSAL_ID)) ;
    DELETE FROM EPS_PROPOSAL_PERSON_DEGREE  WHERE PROPOSAL_PERSON_ID IN (SELECT PROPOSAL_PERSON_ID  FROM EPS_PROPOSAL_PERSONS WHERE PROPOSAL_ID = AV_ACTIVE_PROPOSAL_ID );
    DELETE FROM EPS_PROPOSAL_PERSON_ATTACHMNT WHERE PROPOSAL_PERSON_ID IN (SELECT PROPOSAL_PERSON_ID  FROM EPS_PROPOSAL_PERSONS WHERE PROPOSAL_ID = AV_ACTIVE_PROPOSAL_ID );
    DELETE FROM EPS_PROPOSAL_PERSON_ROLES WHERE PROPOSAL_ID = AV_ACTIVE_PROPOSAL_ID;
     DELETE FROM EPS_PROPOSAL_PERSONS WHERE PROPOSAL_ID = AV_ACTIVE_PROPOSAL_ID;
	 
	 SET li_seq_proposal_id = AV_ARCHIVE_PROPOSAL_ID;
     
	 SET SQL_SAFE_UPDATES = 1;
	 
	 ELSEIF AV_TYPE = 'C' THEN 
	 
	 SET li_seq_proposal_id = AV_ACTIVE_PROPOSAL_ID;
	 
	 END IF;
	  
	  
	SET LS_PROC_LOC = 'EPS_PROPOSAL_PERSONS';
			
            OPEN SEL_EPS_PROPOSAL_PERSONS;
            SEL_EPS_PROPOSAL_PERSONS:LOOP
			SET NOT_FOUND  = 0;
            FETCH SEL_EPS_PROPOSAL_PERSONS INTO LI_LS_PROPOSAL_PERSON_ID,LS_DEPARTMENT,LS_FULL_NAME,LS_UNIT_NAME,LS_UNIT_NUMBER,LS_PERSON_ID,LI_PROP_PERSON_ROLE_ID,LI_ROLODEX_ID,LD_UPDATE_TIMESTAMP,LS_UPDATE_USER,LI_PERCENTAGE_OF_EFFORT,LS_PI_FLAG,LS_DESIGNATION, LS_IS_MULTI_PI, 
            LS_IS_PERSON_CERTIFIED,LS_PROJECT_ROLE,LS_IS_TRAINING_COMPLETED;
 
			
            IF NOT_FOUND=1 THEN
            LEAVE SEL_EPS_PROPOSAL_PERSONS;
            END IF;
            
               
                INSERT INTO EPS_PROPOSAL_PERSONS	
                (
					DEPARTMENT,
					FULL_NAME,
					UNIT_NAME,
					UNIT_NUMBER,
					PERSON_ID,
					PROP_PERSON_ROLE_ID,
					ROLODEX_ID,
					UPDATE_TIMESTAMP,
					UPDATE_USER,
					PROPOSAL_ID,
					PERCENTAGE_OF_EFFORT,
					PI_FLAG,
					DESIGNATION,
					IS_MULTI_PI,
					IS_PERSON_CERTIFIED,
					PROJECT_ROLE,
					IS_TRAINING_COMPLETED
					)
					
                 VALUES(				 
				 LS_DEPARTMENT,
				 LS_FULL_NAME,	 
				 LS_UNIT_NAME,	 
				 LS_UNIT_NUMBER, 
				 LS_PERSON_ID,	 
				 LI_PROP_PERSON_ROLE_ID,
				 LI_ROLODEX_ID,
				 LD_UPDATE_TIMESTAMP, 
				 LS_UPDATE_USER,
				 CASE WHEN AV_TYPE = 'M' THEN AV_ACTIVE_PROPOSAL_ID WHEN AV_TYPE = 'C' THEN AV_ARCHIVE_PROPOSAL_ID END,
				 LI_PERCENTAGE_OF_EFFORT,
				 LS_PI_FLAG,
				 LS_DESIGNATION, 
				 LS_IS_MULTI_PI, 
				 LS_IS_PERSON_CERTIFIED, 
				 LS_PROJECT_ROLE, 
				 LS_IS_TRAINING_COMPLETED	 
                );
                
              SET LI_PROPOSAL_PERSON_ID = LAST_INSERT_ID();
		
		
   	
	
	  SET LS_PROC_LOC = 'EPS_PROPOSAL_PERSON_ATTACHMNT';
			
            OPEN SEL_EPS_PROPOSAL_PERSON_ATTACHMNT;
            SEL_EPS_PROPOSAL_PERSON_ATTACHMNT:LOOP
			SET NOT_FOUND  = 0;
            FETCH SEL_EPS_PROPOSAL_PERSON_ATTACHMNT INTO LS_DESCRIPTION,LS_FILE_DATA_ID,LS_FILE_NAME,LS_MIME_TYPE,LD_UPDATE_TIMESTAMP,LS_UPDATE_USER, LI_DOCUMENT_ID,LI_VERSION_NUMBER,LI_DOCUMENT_STATUS_CODE,LI_ATTACHMNT_TYPE_CODE;
 
			
            IF NOT_FOUND=1 THEN
            LEAVE SEL_EPS_PROPOSAL_PERSON_ATTACHMNT;
            END IF;
            
               
                INSERT INTO EPS_PROPOSAL_PERSON_ATTACHMNT	
                (
					DESCRIPTION,
					FILE_DATA_ID,
					FILE_NAME,
					MIME_TYPE,
					UPDATE_TIMESTAMP,
					UPDATE_USER,
					PROPOSAL_PERSON_ID,
					DOCUMENT_ID,
					VERSION_NUMBER,
					DOCUMENT_STATUS_CODE,
					ATTACHMNT_TYPE_CODE
					)
					
                 VALUES(
				 LS_DESCRIPTION,
				 LS_FILE_DATA_ID,
				 LS_FILE_NAME,
				 LS_MIME_TYPE,
				 LD_UPDATE_TIMESTAMP,
				 LS_UPDATE_USER, 
				 LI_PROPOSAL_PERSON_ID,
				 LI_DOCUMENT_ID,
				 LI_VERSION_NUMBER,
				 LI_DOCUMENT_STATUS_CODE,
				 LI_ATTACHMNT_TYPE_CODE  
                );
                
              
		END LOOP SEL_EPS_PROPOSAL_PERSON_ATTACHMNT;
		CLOSE SEL_EPS_PROPOSAL_PERSON_ATTACHMNT;
 SET LS_PROC_LOC = 'EPS_PROPOSAL_PERSON_DEGREE';
			
            OPEN SEL_EPS_PROPOSAL_PERSON_DEGREE;
            SEL_EPS_PROPOSAL_PERSON_DEGREE:LOOP
			SET NOT_FOUND  = 0;
            FETCH SEL_EPS_PROPOSAL_PERSON_DEGREE INTO LS_DEGREE_CODE,LS_DEGREE,LS_FIELD_OF_STUDY,LS_SPECIALIZATION,LS_SCHOOL,LS_GRADUATION_DATE,
             LD_UPDATE_TIMESTAMP,LS_UPDATE_USER;
 
			
            IF NOT_FOUND=1 THEN
            LEAVE SEL_EPS_PROPOSAL_PERSON_DEGREE;
            END IF;
            
               
                INSERT INTO EPS_PROPOSAL_PERSON_DEGREE	
                (
					PROPOSAL_PERSON_ID,
					DEGREE_CODE,
					DEGREE,
					FIELD_OF_STUDY,
					SPECIALIZATION,
					SCHOOL,
					GRADUATION_DATE,
					UPDATE_TIMESTAMP,
					UPDATE_USER
					)
					
                 VALUES(
				 LI_PROPOSAL_PERSON_ID,
				 LS_DEGREE_CODE,
				 LS_DEGREE,
				 LS_FIELD_OF_STUDY,
				 LS_SPECIALIZATION,
				 LS_SCHOOL,
				 LS_GRADUATION_DATE,
				 LD_UPDATE_TIMESTAMP,
				 LS_UPDATE_USER 
                );
                
              
		END LOOP SEL_EPS_PROPOSAL_PERSON_DEGREE;
		CLOSE SEL_EPS_PROPOSAL_PERSON_DEGREE;  
 SET LS_PROC_LOC = 'EPS_PROP_PERSON_UNITS';
			
            OPEN SEL_EPS_PROP_PERSON_UNITS;
            SEL_EPS_PROP_PERSON_UNITS:LOOP
			SET NOT_FOUND  = 0;
            FETCH SEL_EPS_PROP_PERSON_UNITS INTO LS_LEAD_UNIT_FLAG,LS_UNIT_NUMBER,LD_UPDATE_TIMESTAMP,LS_UPDATE_USER;
 
			
            IF NOT_FOUND=1 THEN
            LEAVE SEL_EPS_PROP_PERSON_UNITS;
            END IF;
            
               
                INSERT INTO EPS_PROP_PERSON_UNITS	
                (
				  PROPOSAL_ID,
				  PROPOSAL_PERSON_ID,
				  LEAD_UNIT_FLAG,
				  UNIT_NUMBER,
				  UPDATE_TIMESTAMP,
				  UPDATE_USER
					)
					
                 VALUES(
				 CASE WHEN AV_TYPE = 'M' THEN AV_ACTIVE_PROPOSAL_ID WHEN AV_TYPE = 'C' THEN AV_ARCHIVE_PROPOSAL_ID END,
				 LI_PROPOSAL_PERSON_ID,
				 LS_LEAD_UNIT_FLAG,
				 LS_UNIT_NUMBER,
				 LD_UPDATE_TIMESTAMP,
				 LS_UPDATE_USER
                );
                
              
		END LOOP SEL_EPS_PROP_PERSON_UNITS;
		CLOSE SEL_EPS_PROP_PERSON_UNITS; 
		
		END LOOP SEL_EPS_PROPOSAL_PERSONS;
		CLOSE SEL_EPS_PROPOSAL_PERSONS;  
 SET LS_PROC_LOC = 'EPS_PROPOSAL_PERSON_ROLES';
			
            OPEN SEL_EPS_PROPOSAL_PERSON_ROLES;
            SEL_EPS_PROPOSAL_PERSON_ROLES:LOOP
			SET NOT_FOUND  = 0;
            FETCH SEL_EPS_PROPOSAL_PERSON_ROLES INTO LS_PERSON_ID,LI_ROLE_ID,LD_UPDATE_TIMESTAMP,LS_UPDATE_USER;
 
			
            IF NOT_FOUND=1 THEN
            LEAVE SEL_EPS_PROPOSAL_PERSON_ROLES;
            END IF;
            
               
                INSERT INTO EPS_PROPOSAL_PERSON_ROLES	
                (
					PROPOSAL_ID,
					PERSON_ID,
					ROLE_ID,
					UPDATE_TIMESTAMP,
					UPDATE_USER
					)
					
                 VALUES(
                CASE WHEN AV_TYPE = 'M' THEN AV_ACTIVE_PROPOSAL_ID WHEN AV_TYPE = 'C' THEN AV_ARCHIVE_PROPOSAL_ID END,				 
				LS_PERSON_ID,
				LI_ROLE_ID,
				LD_UPDATE_TIMESTAMP,
				LS_UPDATE_USER	 
                );
                
              
		END LOOP SEL_EPS_PROPOSAL_PERSON_ROLES;
		CLOSE SEL_EPS_PROPOSAL_PERSON_ROLES;  		
		
		 
		 
END
