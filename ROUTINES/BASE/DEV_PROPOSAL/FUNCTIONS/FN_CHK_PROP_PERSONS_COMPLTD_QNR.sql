-- `FN_CHK_PROP_PERSONS_COMPLTD_QNR`; 

CREATE FUNCTION `FN_CHK_PROP_PERSONS_COMPLTD_QNR`(AV_PROPOSAL_ID VARCHAR(90)) RETURNS varchar(6) 
    DETERMINISTIC
BEGIN
DECLARE LS_PERSON_ID VARCHAR(60);
DECLARE LI_COUNT INT DEFAULT '0';
DECLARE LI_QUESTIONNAIRE_ID INT;
DECLARE LS_ERROR VARCHAR(4000);
        DECLARE NOT_FOUND INT DEFAULT 0;
		  DECLARE SEL_PROP_PERSONS CURSOR FOR
          SELECT PERSON_ID FROM EPS_PROPOSAL_PERSONS EPP WHERE EPP.PROPOSAL_ID = AV_PROPOSAL_ID;
		  
		  DECLARE SEL_LATEST_QNR CURSOR FOR
		  SELECT QH.QUESTIONNAIRE_ID FROM QUEST_HEADER QH
		  INNER JOIN QUEST_USAGE QU ON QU.QUESTIONNAIRE_ID = QH.QUESTIONNAIRE_ID
		  WHERE QU.MODULE_ITEM_CODE = '3' AND QU.MODULE_SUB_ITEM_CODE = '3' 
		  AND QH.VERSION_NUMBER IN (SELECT MAX(T1.VERSION_NUMBER) FROM QUEST_HEADER T1 
		  WHERE T1.QUESTIONNAIRE_NUMBER = QH.QUESTIONNAIRE_NUMBER)
		  AND QH.IS_FINAL = 'Y';
		  
                DECLARE CONTINUE HANDLER FOR NOT FOUND SET NOT_FOUND = 1;
                DECLARE EXIT HANDLER FOR SQLEXCEPTION
                BEGIN
                        GET DIAGNOSTICS CONDITION 1 @sqlstate = RETURNED_SQLSTATE,
                         @errno = MYSQL_ERRNO, @msg = MESSAGE_TEXT;
                        SET @full_error = CONCAT("ERROR ", @errno, " (", @sqlstate, "): ", @msg);
                        SELECT @full_error INTO LS_ERROR;
                        RETURN 'FALSE';
                END;
       OPEN SEL_PROP_PERSONS;
       SEL_PROP_PERSONS : LOOP
	   
	    SET NOT_FOUND = 0;
        FETCH SEL_PROP_PERSONS INTO LS_PERSON_ID;
								
		IF NOT_FOUND = 1 THEN
				LEAVE SEL_PROP_PERSONS;
		END IF;
		
		
					OPEN SEL_LATEST_QNR;
					SEL_LATEST_QNR : LOOP
                    
					SET NOT_FOUND = 0;
					FETCH SEL_LATEST_QNR INTO LI_QUESTIONNAIRE_ID;
					IF NOT_FOUND = 1 THEN
					LEAVE SEL_LATEST_QNR;
					END IF;
					
							SELECT COUNT(1) INTO LI_COUNT FROM QUEST_ANSWER_HEADER 
							WHERE MODULE_ITEM_CODE = 3 
							AND MODULE_SUB_ITEM_CODE = 3
							AND MODULE_ITEM_KEY =AV_PROPOSAL_ID
							AND QUESTIONNAIRE_ID = LI_QUESTIONNAIRE_ID
							AND MODULE_SUB_ITEM_KEY = LS_PERSON_ID
							AND QUESTIONNAIRE_COMPLETED_FLAG = 'Y';
							
							IF LI_COUNT = 0 THEN
							RETURN 'FALSE';
							END IF;	
												
					END LOOP SEL_LATEST_QNR;
					CLOSE SEL_LATEST_QNR;
        END LOOP SEL_PROP_PERSONS;
        CLOSE SEL_PROP_PERSONS;
RETURN 'TRUE';
END
