CREATE FUNCTION `FN_CHECK_BUDGET_PERSON_EFFORT`(
	AV_PROPOSAL_ID INT(11)
) RETURNS varchar(10) CHARSET utf8mb4
    DETERMINISTIC
BEGIN

	DECLARE LI_COUNT INT(2);
    DECLARE LI_BUDEGT_HEADER_ID INT(10);
    DECLARE LS_PARAM_ENABLED VARCHAR(1);
    
    SELECT VALUE INTO LS_PARAM_ENABLED FROM PARAMETER WHERE PARAMETER_NAME = 'ENABLE_KEY_PERSON_EFFORT_INTO_BUDGET';
    
    IF (LS_PARAM_ENABLED = 'Y') THEN
    
		SET LI_COUNT = 0;

		-- FETCHING LOGIC FOR BUDGET_HEADER ID: FINAL BUDGET, ELSE BUDGET WITH COMPLETE STATUS,  ELSE LATEST VERSION
        SELECT BH.BUDGET_HEADER_ID INTO LI_BUDEGT_HEADER_ID FROM  BUDGET_HEADER  BH
				WHERE BH.PROPOSAL_ID = AV_PROPOSAL_ID
				AND BH.BUDGET_HEADER_ID
                IN (SELECT CASE WHEN BH.IS_FINAL_BUDGET = 'Y' THEN BH.BUDGET_HEADER_ID 
										WHEN ((SELECT COUNT(*) FROM BUDGET_HEADER S1 WHERE  S1.PROPOSAL_ID = BH.PROPOSAL_ID AND S1.IS_FINAL_BUDGET='Y') = 0)
												THEN ( SELECT CASE WHEN ((SELECT COUNT(*) FROM BUDGET_HEADER S1 WHERE S1.PROPOSAL_ID = BH.PROPOSAL_ID AND  S1.BUDGET_STATUS_CODE = 3) = 0)
																		THEN (SELECT BUDGET_HEADER_ID FROM BUDGET_HEADER S1 WHERE S1.PROPOSAL_ID = BH.PROPOSAL_ID AND  S1.IS_LATEST_VERSION = 'Y')
																	ELSE (SELECT MAX(BUDGET_HEADER_ID) FROM BUDGET_HEADER S1 WHERE S1.PROPOSAL_ID = BH.PROPOSAL_ID AND  S1.BUDGET_STATUS_CODE = 3)
					END)
		END);
		
		SELECT COUNT(*) INTO LI_COUNT FROM BUDGET_PERSON_DETAIL BPD
		INNER JOIN
		BUDGET_PERSONS BP ON
					BPD.BUDGET_PERSON_ID = BP.BUDGET_PERSON_ID
					AND BP.BUDGET_HEADER_ID = LI_BUDEGT_HEADER_ID
					AND BPD.PERSON_TYPE = 'P'
		INNER JOIN
		EPS_PROPOSAL_PERSONS EPP ON
					EPP.PROPOSAL_ID = AV_PROPOSAL_ID
					AND (
							(BPD.PERSON_ID IS NOT NULL AND (EPP.PERSON_ID = BPD.PERSON_ID))
                            OR (BPD.ROLODEX_ID IS NOT NULL AND (EPP.ROLODEX_ID = BPD.ROLODEX_ID))
					)
					AND EPP.PERCENTAGE_OF_EFFORT <> BPD.PERCENT_EFFORT;

		IF (LI_COUNT > 0) THEN
		RETURN 'FALSE';
		ELSE
		RETURN 'TRUE';
		END IF;

    END IF;

	RETURN 'TRUE';

END
