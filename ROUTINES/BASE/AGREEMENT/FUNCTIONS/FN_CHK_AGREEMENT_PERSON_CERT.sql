CREATE FUNCTION FN_CHK_AGREEMENT_PERSON_CERT (AV_AGREEMENT_ID INT) RETURNS varchar(10)
	READS SQL DATA
    NOT DETERMINISTIC
BEGIN
    DECLARE LI_UNCERTIFIED_PEOPLE_COUNT INT;
	DECLARE LS_NON_EMPLOYEE_CERT_FLAG VARCHAR(1);
	DECLARE LS_SECTION_ACTIVE VARCHAR(1);
	
	SELECT IS_ACTIVE INTO LS_SECTION_ACTIVE
    FROM DYN_SECTION_CONFIG
    WHERE SECTION_CODE = 'AG1309';

    IF LS_SECTION_ACTIVE = 'N' THEN
        RETURN 'TRUE';
    END IF;
	
	SELECT VALUE INTO LS_NON_EMPLOYEE_CERT_FLAG
	FROM PARAMETER
	WHERE PARAMETER_NAME = 'NON_EMPLOYEE_CERTIFICATION';

    SELECT COUNT(*) INTO LI_UNCERTIFIED_PEOPLE_COUNT
    FROM AGREEMENT_PEOPLE T1
    INNER JOIN AGREEMENT_PEOPLE_TYPE T2 ON T2.PEOPLE_TYPE_ID = T1.PEOPLE_TYPE_ID
    WHERE T2.CERTIFICATION_REQUIRED = 'Y' AND T2.IS_ACTIVE = 'Y'
      AND T1.AGREEMENT_REQUEST_ID = AV_AGREEMENT_ID
      AND (
            (T1.IS_PERSON_CERTIFIED = 'N' OR T1.IS_PERSON_CERTIFIED IS NULL)
            AND NOT (
                T1.ROLODEX_ID IS NOT NULL AND LS_NON_EMPLOYEE_CERT_FLAG = 'N'
            )
          );

    IF LI_UNCERTIFIED_PEOPLE_COUNT > 0 THEN
        RETURN 'FALSE';
    END IF;

    RETURN 'TRUE';
END
