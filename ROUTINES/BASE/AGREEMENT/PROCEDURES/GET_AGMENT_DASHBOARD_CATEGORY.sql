CREATE PROCEDURE GET_AGMENT_DASHBOARD_CATEGORY(
AV_PERSON_ID         VARCHAR(255),
AV_CATEGORY_CODE     VARCHAR(255),
AV_SORT_TYPE         VARCHAR(255),
AV_PAGED             INT(11),
AV_LIMIT             INT(11),
AV_TAB_TYPE          VARCHAR(255),
AV_UNLIMITED         BOOLEAN,
AV_IS_COUNT          BOOLEAN,
AV_UNIT_NUMBER       VARCHAR(50),
AV_DESCENT_FLAG      VARCHAR(1)
)
BEGIN
DECLARE LS_DYN_SQL 				LONGTEXT;
DECLARE LS_FILTER_CONDITION 	LONGTEXT;
DECLARE LS_OFFSET_CONDITION 	VARCHAR(600);
DECLARE LI_OFFSET 				INT(11);
DECLARE LS_TAB_QUERY 			LONGTEXT;
DECLARE LS_JOIN_CONDITION 		LONGTEXT;
DECLARE LS_SELECTED_FIELD_LIST 	LONGTEXT;
DECLARE LS_FILTER_CONDITION1 	LONGTEXT;
DECLARE LS_FILTER_CONDITION2 	LONGTEXT;
DECLARE LS_FILTER_CONDITION3 	LONGTEXT;
DECLARE LS_FILTER_CONDITION4 	LONGTEXT;
DECLARE LS_UNIT_CONDITION       LONGTEXT DEFAULT '' ;

DECLARE LS_SELECTED_FIELD_LIST2		LONGTEXT;

DECLARE LI_FROM_ROW				INT(10);
DECLARE LI_TO_ROW				INT(10);
DECLARE LS_SORT_TYPE            VARCHAR(1000);
DECLARE LI_ID INT(11);

DECLARE LS_DYN_CUST_DATA_PARAM LONGTEXT DEFAULT '';
DECLARE LS_DYN_CUST_DATA_ELEMENTS LONGTEXT DEFAULT '';
DECLARE LS_FIELD_HEADER LONGTEXT;

DECLARE done INT DEFAULT 0;
DECLARE LI_CUST_ELE_ID INT;
DECLARE LI_CUST_ORDER INT;
DECLARE LS_CUST_LABEL VARCHAR(60);
DECLARE LS_CUST_DATA_TYPE_CODE VARCHAR(3);
DECLARE LJ_CUST_DATA_HEADER_JSON JSON DEFAULT JSON_OBJECT();
DECLARE LJ_HEADER_JSON JSON ;

DECLARE CUSTOR_DATA_HEADER_CUR CURSOR FOR 
SELECT CDE.CUSTOM_DATA_ELEMENTS_ID, CDE.COLUMN_LABEL, CDEU.ORDER_NUMBER, CDE.DATA_TYPE FROM CUSTOM_DATA_ELEMENTS CDE
INNER JOIN CUSTOM_DATA_ELEMENT_USAGE CDEU ON CDEU.CUSTOM_DATA_ELEMENTS_ID = CDE.CUSTOM_DATA_ELEMENTS_ID
WHERE CDEU.MODULE_CODE = 13 AND CDE.IS_ACTIVE = 'Y' AND CDEU.IS_REQ_ADVANCE_SEARCH = 'Y';

DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = 1;

OPEN CUSTOR_DATA_HEADER_CUR;
	CUST_LOOP: LOOP
		FETCH CUSTOR_DATA_HEADER_CUR INTO LI_CUST_ELE_ID, LS_CUST_LABEL, LI_CUST_ORDER, LS_CUST_DATA_TYPE_CODE;
        IF done THEN
            LEAVE CUST_LOOP;
        END IF; 
        SET LS_CUST_LABEL = REPLACE(LS_CUST_LABEL, "'", "''");
        SET LS_DYN_CUST_DATA_PARAM = CONCAT(LS_DYN_CUST_DATA_PARAM,',','''','CUST_ELEMENTS_ID_',LI_CUST_ELE_ID,'''',',','T.CUST_ELEMENTS_ID_',LI_CUST_ELE_ID);
        SET LS_DYN_CUST_DATA_ELEMENTS = CONCAT(LS_DYN_CUST_DATA_ELEMENTS,',','CD.CUST_ELEMENTS_ID_',LI_CUST_ELE_ID);
        SET LJ_CUST_DATA_HEADER_JSON = JSON_SET(LJ_CUST_DATA_HEADER_JSON, CONCAT('$.', CONCAT('CUST_ELEMENTS_ID_',LI_CUST_ELE_ID)),
        JSON_OBJECT('label',LS_CUST_LABEL, 'sortOrder', LI_CUST_ORDER,'sortIcon',IF(LS_CUST_DATA_TYPE_CODE = 2, 'NUM', 'STR'), 'colWidth', '15rem')
        );
    END LOOP CUST_LOOP;
CLOSE CUSTOR_DATA_HEADER_CUR;

SET LS_TAB_QUERY ='';
SET LS_FILTER_CONDITION1 ='';
SET LS_FILTER_CONDITION2 ='';
SET LS_FILTER_CONDITION3 ='';
SET LS_FILTER_CONDITION4 ='';

SET LS_DYN_SQL = CONCAT('WITH UNIT_ACCESS AS(
SELECT UNIT_NUMBER
							FROM PERSON_ROLES T1
							INNER JOIN ROLE_RIGHTS T2 ON T1.ROLE_ID = T2.ROLE_ID
							INNER JOIN RIGHTS T3 ON T2.RIGHT_ID = T3.RIGHT_ID 
							WHERE T1.DESCEND_FLAG = ''N'' AND T1.PERSON_ID = ''',AV_PERSON_ID,'''
							AND RIGHT_NAME IN (''VIEW_ALL_AGREEMENT'', ''MODIFY_ALL_AGREEMENT'', ''AGREEMENT_ADMINISTRATOR'') 						
							UNION
							SELECT CHILD_UNIT_NUMBER FROM UNIT_WITH_CHILDREN 
							WHERE UNIT_NUMBER IN (
							SELECT UNIT_NUMBER
							FROM PERSON_ROLES T1
							INNER JOIN ROLE_RIGHTS T2 ON T1.ROLE_ID = T2.ROLE_ID
							INNER JOIN RIGHTS T3 ON T2.RIGHT_ID = T3.RIGHT_ID 
							WHERE T1.DESCEND_FLAG = ''Y'' AND T1.PERSON_ID = ''',AV_PERSON_ID,'''
							AND RIGHT_NAME IN (''VIEW_ALL_AGREEMENT'', ''MODIFY_ALL_AGREEMENT'', ''AGREEMENT_ADMINISTRATOR'') 		
                            )), 
AGREEMENT_ACCESS AS (SELECT DISTINCT AH.AGREEMENT_REQUEST_ID FROM AGREEMENT_HEADER AH 
 WHERE AH.AGREEMENT_SEQUENCE_STATUS NOT IN (''TEMPLATE'') AND (AH.UNIT_NUMBER IN (SELECT UNIT_NUMBER FROM UNIT_ACCESS) 
 OR (AH.AGREEMENT_REQUEST_ID IN (SELECT R1.AGREEMENT_REQUEST_ID FROM AGREEMENT_PEOPLE_ROLES R1 
 INNER JOIN ROLE_RIGHTS R2 ON R1.ROLE_ID = R2.ROLE_ID INNER JOIN RIGHTS R3 ON R2.RIGHT_ID = R3.RIGHT_ID WHERE R1.PERSON_ID = ''',AV_PERSON_ID,'''
 AND R3.RIGHT_NAME IN (''VIEW_ALL_AGREEMENT'',''MODIFY_ALL_AGREEMENT''))) OR (AH.AGREEMENT_REQUEST_ID IN (SELECT P1.AGREEMENT_REQUEST_ID FROM
 AGREEMENT_PEOPLE P1 WHERE P1.PEOPLE_TYPE_ID = 3 AND P1.PERSON_ID = ''',AV_PERSON_ID,''')) OR  (AH.REQUESTOR_PERSON_ID = ''',AV_PERSON_ID,''') OR (AH.ADMIN_PERSON_ID = ''',AV_PERSON_ID,''')
 OR (AH.ADMIN_GROUP_ID IN(
																	SELECT AG.ADMIN_GROUP_ID
																	FROM ADMIN_GROUP AG
																	INNER JOIN ROLE_RIGHTS RR ON AG.ROLE_ID = RR.ROLE_ID
																	INNER JOIN RIGHTS R ON RR.RIGHT_ID = R.RIGHT_ID
																	INNER JOIN PERSON_ROLES PR ON RR.ROLE_ID = PR.ROLE_ID
																	WHERE PR.PERSON_ID = ''', AV_PERSON_ID ,'''
																	AND R.RIGHT_NAME = ''VIEW_ADMIN_GROUP_AGREEMENT'')
 
 )OR (AH.AGREEMENT_REQUEST_ID in (SELECT T9.MODULE_ITEM_ID FROM WORKFLOW T9
																INNER JOIN WORKFLOW_DETAIL T10 ON T9.WORKFLOW_ID = T10.WORKFLOW_ID
																WHERE T9.MODULE_CODE = 13 AND T10.APPROVER_PERSON_ID = ''',AV_PERSON_ID,''' AND T9.MODULE_ITEM_ID = AH.AGREEMENT_REQUEST_ID
																  AND T9.IS_WORKFLOW_ACTIVE = ''Y''
																AND  T10.APPROVAL_STATUS = ''W''
																)) ))');
                                                                


    IF AV_UNIT_NUMBER IS NOT NULL AND AV_UNIT_NUMBER != '' THEN
        IF AV_DESCENT_FLAG = 'Y' THEN
            SET LS_UNIT_CONDITION = CONCAT(' AND (( EXISTS (SELECT 1 FROM UNIT_WITH_CHILDREN WHERE UNIT_NUMBER = ''',AV_UNIT_NUMBER,''' AND CHILD_UNIT_NUMBER = T1.UNIT_NUMBER)) OR  (T1.UNIT_NUMBER =''',AV_UNIT_NUMBER,''' ) )');
        ELSE
            SET LS_UNIT_CONDITION = CONCAT(' AND (T1.UNIT_NUMBER =''',AV_UNIT_NUMBER,''' )');
        END IF;
    END IF;

IF AV_IS_COUNT = 'N' THEN

SET LS_FILTER_CONDITION = CONCAT(' AND T1.CATEGORY_CODE = ',AV_CATEGORY_CODE, LS_UNIT_CONDITION);

		SET LS_FILTER_CONDITION1 = CONCAT(LS_FILTER_CONDITION1,' WHERE T1.AGREEMENT_STATUS_CODE IN (1,6)  AND ((T1.AGREEMENT_REQUEST_ID IN (SELECT DISTINCT AGREEMENT_REQUEST_ID FROM AGREEMENT_ACCESS))
															)' );

		SET LS_FILTER_CONDITION2 = CONCAT(LS_FILTER_CONDITION2,' WHERE T1.AGREEMENT_STATUS_CODE IN (2,5,7)  AND  ((T1.AGREEMENT_REQUEST_ID IN (SELECT DISTINCT AGREEMENT_REQUEST_ID FROM AGREEMENT_ACCESS)))
															');

                                                            
		SET LS_SELECTED_FIELD_LIST2 = ',(SELECT FULL_NAME FROM AGREEMENT_PEOPLE WHERE 
AGREEMENT_REQUEST_ID = T1.AGREEMENT_REQUEST_ID AND AGREEMENT_PEOPLE_ID =
(SELECT max(AGREEMENT_PEOPLE_ID) FROM AGREEMENT_PEOPLE WHERE AGREEMENT_REQUEST_ID = T1.AGREEMENT_REQUEST_ID AND PEOPLE_TYPE_ID = 3)) AS PRINCIPAL_INVESTIGATOR';




	IF AV_TAB_TYPE = 'DRAFT_AGREEMENTS' THEN
	

			SET LS_TAB_QUERY = CONCAT(LS_TAB_QUERY,' ',LS_FILTER_CONDITION1);

    
	ELSEIF AV_TAB_TYPE = 'WORKFLOW_AGREEMENTS' THEN

			SET LS_TAB_QUERY = CONCAT(LS_TAB_QUERY,' ',LS_FILTER_CONDITION2);

	END IF;

	IF AV_SORT_TYPE IS NULL OR  AV_SORT_TYPE=''  THEN
		SET LS_SORT_TYPE = CONCAT(' ORDER BY UPDATE_TIMESTAMP DESC ');
	ELSE
		SET LS_SORT_TYPE = CONCAT(' ORDER BY ',AV_SORT_TYPE);

	END IF;

	IF AV_UNLIMITED = TRUE THEN

		SET  LS_OFFSET_CONDITION = '';

	ELSE
		SET LI_OFFSET = (AV_LIMIT * AV_PAGED);
		SET LS_OFFSET_CONDITION = CONCAT(' LIMIT ',AV_LIMIT,' OFFSET ',LI_OFFSET);

	END IF;
    
        SELECT JSON_OBJECT(
        'AGREEMENT_REQUEST_ID', JSON_OBJECT('label', 'Agreement #', 'sortOrder',  1, 'sortIcon','NUM', 'colWidth', '12rem'),
        'TITLE', JSON_OBJECT('label', 'Research Title', 'sortOrder', 4, 'sortIcon', 'STR', 'colWidth', '35rem'),
        'UNIT', JSON_OBJECT('label','Lead Unit', 'sortOrder', 5, 'sortIcon', 'STR', 'colWidth', '20rem' ),
        'CATEGORY', JSON_OBJECT('label', 'Category', 'sortOrder', 3, 'sortIcon', 'STR', 'colWidth', '15rem'),
        'TYPE_OF_AGREEMENT', JSON_OBJECT('label', 'Type', 'sortOrder', 2, 'sortIcon', 'STR', 'colWidth', '15rem'),
        'SPONSOR', JSON_OBJECT('label', 'Sponsor/Organization', 'sortOrder', 6, 'sortIcon', 'STR', 'colWidth', '20rem' ),
        'ADMINISTRATOR', JSON_OBJECT('label', 'Administrator', 'sortOrder', 7,'sortIcon', 'STR', 'colWidth', '20rem' ),
        'REQUESTOR', JSON_OBJECT('label', 'Requestor', 'sortOrder', 8, 'sortIcon', 'STR', 'colWidth', '20rem' ),
        'ADMIN_GROUP_NAME', JSON_OBJECT('label', 'Admin Group', 'sortOrder',  9, 'sortIcon', 'STR', 'colWidth', '20rem' ),
        'PRINCIPAL_INVESTIGATOR', JSON_OBJECT('label', 'Principal Investigator', 'sortOrder', 10, 'sortIcon', 'STR', 'colWidth', '20rem'),
        'STATUS', JSON_OBJECT('label', 'Status', 'sortOrder', 11, 'sortIcon', 'STR', 'colWidth', '15rem')
    ) INTO LS_FIELD_HEADER;

SELECT JSON_MERGE_PATCH(LS_FIELD_HEADER,LJ_CUST_DATA_HEADER_JSON) INTO LJ_HEADER_JSON;


    SET LS_DYN_SQL =CONCAT(LS_DYN_SQL,
                                 'SELECT
                                  JSON_OBJECT( 
        ''HEADERS'' ,  ''',LJ_HEADER_JSON,''',
        ''DASHBOARD_DETAILS'', JSON_ARRAYAGG(
                JSON_OBJECT(
                    ''AGREEMENT_REQUEST_ID'', T.AGREEMENT_REQUEST_ID,
                    ''TITLE'', T.TITLE,
                    ''UNIT'', T.UNIT,
                    ''CATEGORY'', T.CATEGORY,
                    ''TYPE_OF_AGREEMENT'', T.TYPE_OF_AGREEMENT,
                    ''SPONSOR'', T.SPONSOR,
                    ''ADMINISTRATOR'', T.ADMINISTRATOR,
                    ''REQUESTOR'', T.REQUESTOR,
                    ''ADMIN_GROUP_NAME'', T.ADMIN_GROUP_NAME,
                    ''PRINCIPAL_INVESTIGATOR'', T.PRINCIPAL_INVESTIGATOR,
                    ''STATUS'', T.STATUS
                    ');
        
        IF LS_DYN_CUST_DATA_PARAM IS NOT NULL THEN
         SET LS_DYN_SQL = CONCAT(LS_DYN_SQL,LS_DYN_CUST_DATA_PARAM);
        END IF;
        
SET LS_DYN_SQL = CONCAT(LS_DYN_SQL,'
	))) as widget_data
                                 FROM
                                    ( 
									SELECT 
                                        distinct
										T1.AGREEMENT_REQUEST_ID,
                                        T1.TITLE,
                                        T3.DESCRIPTION AS CATEGORY,
										CASE 
											WHEN T1.IS_HOLD = ''Y'' THEN CONCAT(T2.DESCRIPTION, '' - '', ''Info Requested'')
											ELSE T2.DESCRIPTION 
										END AS STATUS, 
										T1.AGREEMENT_STATUS_CODE,
										T4.DESCRIPTION AS TYPE_OF_AGREEMENT,
										T1.START_DATE,
										T1.REQUESTOR_PERSON_ID,
										T1.REQUESTOR_NAME AS REQUESTOR,
										T1.END_DATE,
										T1.AGREEMENT_TYPE_CODE,
										T1.ADMIN_PERSON_NAME AS ADMINISTRATOR,
										T1.CATEGORY_CODE,
                                        T15.ADMIN_GROUP_NAME,
										T1.CONTRACT_VALUE,
                                        T7.DISPLAY_NAME AS SPONSOR,
										T1.UNIT_NUMBER,
										T5.DISPLAY_NAME AS UNIT,
										T1.CURRENCY_CODE,
										T1.UPDATE_TIMESTAMP', LS_SELECTED_FIELD_LIST2);
        
        IF LS_DYN_CUST_DATA_ELEMENTS IS NOT NULL THEN
         SET LS_DYN_SQL = CONCAT(LS_DYN_SQL,LS_DYN_CUST_DATA_ELEMENTS);
        END IF;
        
SET LS_DYN_SQL = CONCAT(LS_DYN_SQL,'
 
                                    FROM AGREEMENT_HEADER T1
                                    LEFT JOIN AGREEMENT_CUSTOM_DATA_RT CD ON CD.AGREEMENT_REQUEST_ID = T1.AGREEMENT_REQUEST_ID
                                    LEFT JOIN ADMIN_GROUP T15 ON T1.ADMIN_GROUP_ID = T15.ADMIN_GROUP_ID
                                    INNER JOIN AGREEMENT_STATUS T2 ON T2.AGREEMENT_STATUS_CODE = T1.AGREEMENT_STATUS_CODE
                                    INNER JOIN UNIT T5 ON T1.UNIT_NUMBER = T5.UNIT_NUMBER
									LEFT JOIN AGREEMENT_PEOPLE T6 ON T6.AGREEMENT_REQUEST_ID = T1.AGREEMENT_REQUEST_ID
                                    LEFT JOIN AGREEMENT_TYPE T4 ON T4.AGREEMENT_TYPE_CODE = T1.AGREEMENT_TYPE_CODE
									LEFT JOIN AGREEMENT_SPONSOR T20 ON T20.AGREEMENT_REQUEST_ID = T1.AGREEMENT_REQUEST_ID AND AGREEMENT_SPONSOR_TYPE_CODE = 1
                                    LEFT JOIN SPONSOR T7 ON T7.SPONSOR_CODE = T20.SPONSOR_CODE
                                    LEFT JOIN AGREEMENT_CATEGORY T3 ON T1.CATEGORY_CODE = T3.CATEGORY_CODE ',LS_TAB_QUERY,LS_FILTER_CONDITION ,LS_SORT_TYPE,LS_OFFSET_CONDITION,'
                                 ) T');
								 
								 
  ELSE
	SET LS_DYN_SQL = CONCAT(LS_DYN_SQL, ' ,AGREEMENT_STATS AS (
    SELECT 
        AC.CATEGORY_CODE,
        AC.DESCRIPTION,
        SUM(CASE WHEN T1.AGREEMENT_STATUS_CODE IN (1, 6) THEN 1 ELSE 0 END) AS DRAFT,
        SUM(CASE WHEN T1.AGREEMENT_STATUS_CODE IN (2, 5, 7) THEN 1 ELSE 0 END) AS SUBMITTED
    FROM AGREEMENT_HEADER T1
    INNER JOIN AGREEMENT_CATEGORY AC ON T1.CATEGORY_CODE = AC.CATEGORY_CODE 
    WHERE T1.AGREEMENT_REQUEST_ID IN (SELECT AGREEMENT_REQUEST_ID FROM AGREEMENT_ACCESS)', LS_UNIT_CONDITION, ' 
    GROUP BY AC.CATEGORY_CODE, AC.DESCRIPTION
)
SELECT 
    JSON_ARRAYAGG(
        JSON_OBJECT(
            ''CATEGORY_CODE'', CATEGORY_CODE,
            ''CATEGORY'', DESCRIPTION,
            ''SUBMITTED'', SUBMITTED,
            ''DRAFT'', DRAFT
        )
    ) AS CATEGORY_STATS_JSON
FROM AGREEMENT_STATS');


 END IF;

    SET @QUERY_STATEMENT = LS_DYN_SQL;
    PREPARE EXECUTABLE_STAEMENT FROM @QUERY_STATEMENT;
    EXECUTE EXECUTABLE_STAEMENT; 

END
