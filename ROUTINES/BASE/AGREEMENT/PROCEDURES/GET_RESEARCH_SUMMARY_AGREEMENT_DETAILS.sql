CREATE PROCEDURE GET_RESEARCH_SUMMARY_AGREEMENT_DETAILS(
AV_WIDGET 			VARCHAR(100),
AV_PERSON_ID 		VARCHAR(40),
AV_UNIT_NUMBER 		VARCHAR(50),
AV_CATEGORY_CODE 	VARCHAR(100),
AV_STATUS_CODE 		VARCHAR(100),
AV_COUNTER 			VARCHAR(1),
AV_SORT_TYPE 		VARCHAR(255),
AV_PAGED 			INT(11),
AV_LIMIT 			INT(11),
AV_START_DATE 		VARCHAR(30),
AV_END_DATE 		VARCHAR(30),
AV_DESCENT_FLAG 	VARCHAR(1),
AV_UNLIMITED 		BOOLEAN
)
BEGIN
DECLARE LS_DYN_SQL 				LONGTEXT;
DECLARE LS_OFFSET 				INT(11);
DECLARE LS_SORT_TYPE 			VARCHAR(600);
DECLARE LS_UNIT_CONDITION 		LONGTEXT;
DECLARE LS_OFFSET_CONDITION 	VARCHAR(600);
DECLARE LS_STATUS_CONDITION 	VARCHAR(600);
DECLARE LS_CATEGORY_CONDITION 	VARCHAR(600);

DECLARE LS_DYN_CUST_DATA_PARAM LONGTEXT DEFAULT '';
DECLARE LS_DYN_CUST_DATA_ELEMENTS LONGTEXT DEFAULT '';
DECLARE LS_DYN_CUST_DATA_HEADER LONGTEXT DEFAULT '';
DECLARE LS_FIELD_HEADER LONGTEXT;

DECLARE LS_FY_MONTH_CRITERIA VARCHAR(3) DEFAULT '4';
DECLARE LS_FY_START_DATE VARCHAR(10) DEFAULT '-04-01';
DECLARE LS_FY_END_DATE VARCHAR(10) DEFAULT '-03-31';
DECLARE LS_FY_TIME VARCHAR(10) DEFAULT ' 00:00:00';

DECLARE done INT DEFAULT 0;
DECLARE LS_CUST_ELE_ID INT;
DECLARE LI_CUST_ORDER INT;
DECLARE LS_CUST_LABEL VARCHAR(60);
DECLARE LS_CUST_DATA_TYPE_CODE VARCHAR(3);
DECLARE LJ_CUST_DATA_HEADER_JSON JSON DEFAULT JSON_OBJECT();
DECLARE LJ_HEADER_JSON JSON ;

DECLARE CUSTOR_DATA_HEADER_CUR CURSOR FOR 
SELECT CDE.CUSTOM_DATA_ELEMENTS_ID, CDE.COLUMN_LABEL, CDEU.ORDER_NUMBER, CDE.DATA_TYPE FROM CUSTOM_DATA_ELEMENTS CDE
INNER JOIN CUSTOM_DATA_ELEMENT_USAGE CDEU ON CDEU.CUSTOM_DATA_ELEMENTS_ID = CDE.CUSTOM_DATA_ELEMENTS_ID
WHERE CDEU.MODULE_CODE = 13 AND CDE.IS_ACTIVE = 'Y' AND CDEU.IS_REQ_ADVANCE_SEARCH = 'Y';

DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = 1;

OPEN CUSTOR_DATA_HEADER_CUR;
	CUST_LOOP: LOOP
		FETCH CUSTOR_DATA_HEADER_CUR INTO LS_CUST_ELE_ID, LS_CUST_LABEL, LI_CUST_ORDER, LS_CUST_DATA_TYPE_CODE;
        IF done THEN
            LEAVE CUST_LOOP;
        END IF; 
		SET LS_CUST_LABEL = REPLACE(LS_CUST_LABEL, "'", "''");
        SET LS_DYN_CUST_DATA_PARAM = CONCAT(LS_DYN_CUST_DATA_PARAM,',','''','CUST_ELEMENTS_ID_',LS_CUST_ELE_ID,'''',',','T.CUST_ELEMENTS_ID_',LS_CUST_ELE_ID);
        SET LS_DYN_CUST_DATA_ELEMENTS = CONCAT(LS_DYN_CUST_DATA_ELEMENTS,',','CD.CUST_ELEMENTS_ID_',LS_CUST_ELE_ID);
        SET LJ_CUST_DATA_HEADER_JSON = JSON_SET(LJ_CUST_DATA_HEADER_JSON, CONCAT('$.', CONCAT('CUST_ELEMENTS_ID_',LS_CUST_ELE_ID)),
        JSON_OBJECT('label',LS_CUST_LABEL, 'sortOrder', LI_CUST_ORDER, 'sortIcon',IF(LS_CUST_DATA_TYPE_CODE = 2, 'NUM', 'STR'), 'colWidth', '15rem')
        );
        	

    END LOOP CUST_LOOP;
CLOSE CUSTOR_DATA_HEADER_CUR;

IF AV_UNLIMITED = TRUE THEN
	SET  LS_OFFSET_CONDITION = '';
ELSE
	SET LS_OFFSET = (AV_LIMIT * AV_PAGED);
	SET LS_OFFSET_CONDITION = CONCAT(' LIMIT ',AV_LIMIT,' OFFSET ',LS_OFFSET);
END IF;

IF AV_UNIT_NUMBER <> '' THEN
	IF AV_DESCENT_FLAG = 'Y' THEN
		SET LS_UNIT_CONDITION = CONCAT(' AND T1.UNIT_NUMBER IN (SELECT CHILD_UNIT_NUMBER FROM UNIT_WITH_CHILDREN WHERE UNIT_NUMBER = ''',AV_UNIT_NUMBER,''')');
	ELSE
		SET LS_UNIT_CONDITION = CONCAT(' AND T1.UNIT_NUMBER = ''',AV_UNIT_NUMBER,'''');
	END IF;
ELSE 
	SET LS_UNIT_CONDITION = '';
END IF;

IF AV_START_DATE = '' THEN
    SET AV_START_DATE = CASE 
        WHEN MONTH(NOW()) >= LS_FY_MONTH_CRITERIA THEN CONCAT(DATE(CONCAT(YEAR(NOW()), LS_FY_START_DATE)), LS_FY_TIME)
        ELSE CONCAT(DATE(CONCAT(YEAR(NOW()) - 1, LS_FY_START_DATE)), LS_FY_TIME)
    END;
END IF;

IF AV_END_DATE = '' THEN
    SET AV_END_DATE = CASE 
        WHEN MONTH(NOW()) >= LS_FY_MONTH_CRITERIA THEN CONCAT(DATE(CONCAT(YEAR(NOW()) + 1, LS_FY_END_DATE)), LS_FY_TIME)
        ELSE CONCAT(DATE(CONCAT(YEAR(NOW()), LS_FY_END_DATE)), LS_FY_TIME)
    END;
END IF;

IF AV_CATEGORY_CODE IS NULL OR AV_CATEGORY_CODE = '' THEN
	SET LS_CATEGORY_CONDITION = (' T1.CATEGORY_CODE IN (SELECT CATEGORY_CODE FROM AGREEMENT_CATEGORY)');
ELSE
	SET LS_CATEGORY_CONDITION = CONCAT(' T1.CATEGORY_CODE IN (',AV_CATEGORY_CODE,')');
END IF;

IF AV_STATUS_CODE IS NULL OR AV_STATUS_CODE = '' THEN
	SET LS_STATUS_CONDITION = CONCAT(' AND T1.AGREEMENT_STATUS_CODE IN (''1'',''2'',''3'',''4'',''5'',''6'',''7'',''8'',''9'',''10'')');
ELSE
	SET LS_STATUS_CONDITION = CONCAT(' AND T1.AGREEMENT_STATUS_CODE IN (',AV_STATUS_CODE,')');
END IF;

IF AV_SORT_TYPE = '' THEN 
	SET LS_SORT_TYPE = CONCAT(' ORDER BY UPDATE_TIMESTAMP DESC ');
ELSE 
	SET LS_SORT_TYPE = CONCAT(' ORDER BY ',AV_SORT_TYPE);
END IF;

    SELECT JSON_OBJECT(
        'AGREEMENT_REQUEST_ID', JSON_OBJECT('label', 'Agreement #', 'sortOrder',  1, 'sortIcon','NUM', 'colWidth', '12rem'),
        'TITLE', JSON_OBJECT('label', 'Research Title', 'sortOrder', 4, 'sortIcon', 'STR', 'colWidth', '35rem'),
        'UNIT', JSON_OBJECT('label','Lead Unit', 'sortOrder', 5, 'sortIcon', 'STR', 'colWidth', '20rem' ),
        'CATEGORY', JSON_OBJECT('label', 'Category', 'sortOrder', 3, 'sortIcon', 'STR', 'colWidth', '15rem'),
        'TYPE_OF_AGREEMENT', JSON_OBJECT('label', 'Type', 'sortOrder', 2, 'sortIcon', 'STR', 'colWidth', '15rem'),
        'SPONSOR', JSON_OBJECT('label', 'Sponsor/Organization', 'sortOrder', 6, 'sortIcon', 'STR', 'colWidth', '20rem' ),
        'ADMINISTRATOR', JSON_OBJECT('label', 'Administrator', 'sortOrder', 7,'sortIcon', 'STR', 'colWidth', '20rem' ),
        'REQUESTOR', JSON_OBJECT('label', 'Requestor', 'sortOrder', 8, 'sortIcon', 'STR', 'colWidth', '20rem' ),
        'ADMIN_GROUP_NAME', JSON_OBJECT('label', 'Admin Group', 'sortOrder',  9, 'sortIcon', 'STR', 'colWidth', '20rem' ),
        'PRINCIPAL_INVESTIGATOR', JSON_OBJECT('label', 'Principal Investigator', 'sortOrder', 10, 'sortIcon', 'STR', 'colWidth', '20rem'),
        'STATUS', JSON_OBJECT('label', 'Status', 'sortOrder', 11, 'sortIcon', 'STR', 'colWidth', '15rem')
    ) INTO LS_FIELD_HEADER;

SELECT JSON_MERGE_PATCH(LS_FIELD_HEADER,LJ_CUST_DATA_HEADER_JSON) INTO LJ_HEADER_JSON;

IF AV_WIDGET = 'AGREEMENT_SUMMARY' THEN

	SET LS_DYN_SQL = CONCAT('WITH ACCESS_ADMIN_TMP AS (
		SELECT DISTINCT UNIT_NUMBER
		FROM PERSON_ROLES T1
		INNER JOIN ROLE_RIGHTS T2 ON T1.ROLE_ID = T2.ROLE_ID
		INNER JOIN RIGHTS T3 ON T2.RIGHT_ID = T3.RIGHT_ID 
		WHERE T1.DESCEND_FLAG = ''N'' 
		AND T1.PERSON_ID = ''',AV_PERSON_ID,'''
		AND RIGHT_NAME IN (''VIEW_ALL_AGREEMENT'', ''MODIFY_ALL_AGREEMENT'', ''AGREEMENT_ADMINISTRATOR'')
		UNION
		SELECT CHILD_UNIT_NUMBER 
		FROM UNIT_WITH_CHILDREN 
		WHERE UNIT_NUMBER IN (
			SELECT DISTINCT UNIT_NUMBER
			FROM PERSON_ROLES T1
			INNER JOIN ROLE_RIGHTS T2 ON T1.ROLE_ID = T2.ROLE_ID
			INNER JOIN RIGHTS T3 ON T2.RIGHT_ID = T3.RIGHT_ID 
			WHERE T1.DESCEND_FLAG = ''Y'' 
			AND T1.PERSON_ID = ''',AV_PERSON_ID,'''
			AND RIGHT_NAME IN (''VIEW_ALL_AGREEMENT'', ''MODIFY_ALL_AGREEMENT'', ''AGREEMENT_ADMINISTRATOR'')
		)
	),
	NEGOTIATOR AS (
		SELECT ASSOCIATED_PROJECT_ID
		FROM NEGOTIATION_ASSOCIATION T1
		INNER JOIN NEGOTIATION_LOCATION T2 ON T1.NEGOTIATION_ID = T2.NEGOTIATION_ID
		WHERE T2.ASSIGNEE_PERSON_ID = ''',AV_PERSON_ID,'''
	),
	ACCESS_ADMIN_GROUP_TMP AS (SELECT T1.AGREEMENT_REQUEST_ID 
							FROM AGREEMENT_HEADER T1
							LEFT JOIN ADMIN_GROUP T2 ON T1.ADMIN_GROUP_ID = T2.ADMIN_GROUP_ID
							WHERE T2.ROLE_ID IN (SELECT T3.ROLE_ID FROM ROLE_RIGHTS T3 
							LEFT JOIN RIGHTS T4 ON T3.RIGHT_ID = T4.RIGHT_ID
							LEFT JOIN PERSON_ROLES T5 ON T3.ROLE_ID = T5.ROLE_ID
							WHERE T5.PERSON_ID = ''',AV_PERSON_ID,''' AND T4.RIGHT_NAME = ''VIEW_ADMIN_GROUP_AGREEMENT'')),
	ACCESS_TMP AS (SELECT R1.AGREEMENT_REQUEST_ID
						FROM AGREEMENT_PEOPLE_ROLES R1
						INNER JOIN ROLE_RIGHTS R2 ON R1.ROLE_ID = R2.ROLE_ID
						INNER JOIN RIGHTS R3 ON R2.RIGHT_ID = R3.RIGHT_ID 
						WHERE R1.PERSON_ID = ''',AV_PERSON_ID,'''
						AND R3.RIGHT_NAME IN (''VIEW_ALL_AGREEMENT'',''MODIFY_ALL_AGREEMENT'')),
	SPONSORS AS (SELECT T31.AGREEMENT_REQUEST_ID, T32.DISPLAY_NAME AS SPONSOR
                                   FROM AGREEMENT_SPONSOR T31 
                                   INNER JOIN SPONSOR T32 ON T31.SPONSOR_CODE = T32.SPONSOR_CODE 
                                   WHERE AGREEMENT_SPONSOR_TYPE_CODE = 1)


	SELECT
     JSON_OBJECT( 
        ''HEADERS'' ,  ''',LJ_HEADER_JSON,''',
        ''DASHBOARD_DETAILS'', JSON_ARRAYAGG(
                JSON_OBJECT(
                    ''AGREEMENT_REQUEST_ID'', T.AGREEMENT_REQUEST_ID,
                    ''TITLE'', T.TITLE,
                    ''UNIT'', T.UNIT,
                    ''CATEGORY'', T.CATEGORY,
                    ''TYPE_OF_AGREEMENT'', T.TYPE_OF_AGREEMENT,
                    ''SPONSOR'', T.SPONSOR,
                    ''ADMINISTRATOR'', T.ADMINISTRATOR,
                    ''REQUESTOR'', T.REQUESTOR,
                    
                    ''ADMIN_GROUP_NAME'', T.ADMIN_GROUP_NAME,
                    ''PRINCIPAL_INVESTIGATOR'', T.PRINCIPAL_INVESTIGATOR,
                    ''STATUS'', T.STATUS
                    ');
        
        IF LS_DYN_CUST_DATA_PARAM IS NOT NULL THEN
         SET LS_DYN_SQL = CONCAT(LS_DYN_SQL,LS_DYN_CUST_DATA_PARAM);
        END IF;
        
SET LS_DYN_SQL = CONCAT(LS_DYN_SQL,'
	))) as widget_data
    FROM (
	SELECT 
		DISTINCT
        CONVERT(T1.AGREEMENT_REQUEST_ID, CHAR) AS AGREEMENT_REQUEST_ID ,
		T1.TITLE,
		T8.DISPLAY_NAME AS UNIT,
		T2.DESCRIPTION AS CATEGORY,
		T4.DESCRIPTION AS TYPE_OF_AGREEMENT,
		T7.SPONSOR,
		T1.ADMIN_PERSON_NAME AS ADMINISTRATOR,
		T1.REQUESTOR_NAME AS REQUESTOR,
		T6.FULL_NAME AS PRINCIPAL_INVESTIGATOR,
		CASE 
				WHEN T1.IS_HOLD = ''Y'' THEN CONCAT(T3.DESCRIPTION, '' - '', ''On Hold'')
				ELSE T3.DESCRIPTION 
		END AS STATUS,
        T1.UPDATE_TIMESTAMP,
        T15.ADMIN_GROUP_NAME
    ');
        
        IF LS_DYN_CUST_DATA_ELEMENTS IS NOT NULL THEN
         SET LS_DYN_SQL = CONCAT(LS_DYN_SQL,LS_DYN_CUST_DATA_ELEMENTS);
        END IF;
        
SET LS_DYN_SQL = CONCAT(LS_DYN_SQL,'
	FROM AGREEMENT_HEADER T1
	INNER JOIN AGREEMENT_CATEGORY T2 ON T1.CATEGORY_CODE = T2.CATEGORY_CODE
	INNER JOIN AGREEMENT_STATUS T3 ON T1.AGREEMENT_STATUS_CODE = T3.AGREEMENT_STATUS_CODE
	LEFT JOIN AGREEMENT_TYPE T4 ON T4.AGREEMENT_TYPE_CODE = T1.AGREEMENT_TYPE_CODE
    LEFT JOIN SPONSORS T7 ON T7.AGREEMENT_REQUEST_ID = T1.AGREEMENT_REQUEST_ID
	LEFT JOIN AGREEMENT_PEOPLE T6 ON T1.AGREEMENT_REQUEST_ID = T6.AGREEMENT_REQUEST_ID AND T6.PEOPLE_TYPE_ID = 3
    LEFT JOIN AGREEMENT_CUSTOM_DATA_RT CD ON CD.AGREEMENT_REQUEST_ID = T1.AGREEMENT_REQUEST_ID
	INNER JOIN UNIT T8 ON T1.UNIT_NUMBER = T8.UNIT_NUMBER
    LEFT JOIN ADMIN_GROUP T15 ON T15.ADMIN_GROUP_ID = T1.ADMIN_GROUP_ID
	WHERE ',LS_CATEGORY_CONDITION, LS_STATUS_CONDITION,
	' AND T1.UPDATE_TIMESTAMP BETWEEN ''',AV_START_DATE,''' AND ''',AV_END_DATE,'''
    AND (( EXISTS (SELECT 1 FROM ACCESS_ADMIN_TMP WHERE UNIT_NUMBER = T1.UNIT_NUMBER )
		 OR T6.PERSON_ID = ''',AV_PERSON_ID,''' AND T6.PEOPLE_TYPE_ID = 3
		 OR EXISTS (SELECT 1 FROM NEGOTIATOR WHERE ASSOCIATED_PROJECT_ID = T1.AGREEMENT_REQUEST_ID)
         OR T1.REQUESTOR_PERSON_ID = ''',AV_PERSON_ID,'''
         OR T1.ADMIN_PERSON_ID = ''', AV_PERSON_ID, '''
		 OR (EXISTS (SELECT 1
					FROM WORKFLOW T9
					INNER JOIN WORKFLOW_DETAIL T10 ON T9.WORKFLOW_ID = T10.WORKFLOW_ID
					WHERE T9.MODULE_CODE = 13 
                        AND T10.APPROVER_PERSON_ID = ''',AV_PERSON_ID,'''
                        AND T9.MODULE_ITEM_ID = T1.AGREEMENT_REQUEST_ID
                        AND T9.IS_WORKFLOW_ACTIVE = ''Y''
                        AND T10.APPROVAL_STATUS = ''W''))
		OR EXISTS (SELECT 1 FROM ACCESS_ADMIN_GROUP_TMP WHERE AGREEMENT_REQUEST_ID = T1.AGREEMENT_REQUEST_ID)
		OR EXISTS (SELECT 1 FROM ACCESS_TMP WHERE AGREEMENT_REQUEST_ID = T1.AGREEMENT_REQUEST_ID)
	)',LS_UNIT_CONDITION,' ) 
	AND T1.AGREEMENT_SEQUENCE_STATUS <> ''TEMPLATE''');

	IF AV_COUNTER = 'P' THEN
			SET LS_DYN_SQL = CONCAT(LS_DYN_SQL, ' AND T3.AGREEMENT_STATUS_CODE IN (4)');
		ELSEIF AV_COUNTER = 'A' THEN
			SET LS_DYN_SQL = CONCAT(LS_DYN_SQL, ' AND T3.AGREEMENT_STATUS_CODE IN (1,2,3,5,7)');
		ELSEIF AV_COUNTER = 'U' THEN
			SET LS_DYN_SQL = CONCAT(LS_DYN_SQL, ' AND T3.AGREEMENT_STATUS_CODE IN (6,8,9,10)');
	END IF;

	 SET LS_DYN_SQL = CONCAT(LS_DYN_SQL, LS_SORT_TYPE, LS_OFFSET_CONDITION,' )T ');

END IF;

        SET @QUERY_STATEMENT = LS_DYN_SQL;
         PREPARE EXECUTABLE_STAEMENT FROM @QUERY_STATEMENT;
         EXECUTE EXECUTABLE_STAEMENT; 

END
