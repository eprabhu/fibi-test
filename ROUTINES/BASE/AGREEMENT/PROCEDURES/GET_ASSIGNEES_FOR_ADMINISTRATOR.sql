CREATE PROCEDURE `GET_ASSIGNEES_FOR_ADMINISTRATOR`(
  IN AV_PERSON_ID VARCHAR(40),
  IN AV_UNIT_NUMBER VARCHAR(50),
  IN AV_DESCENT_FLAG VARCHAR(1),
  IN AV_ADMIN_ID VARCHAR(40),
  IN FILTER_JSON JSON
)
BEGIN
DECLARE IS_UNIT_ADMIN INT;
DECLARE IS_GROUP_ADMIN INT;

-- Using global variables because other variables and parameters are not accessible in the sub queries inside WITH clause query.
SET @AV_DESCENT_FLAG =  AV_DESCENT_FLAG;
SET @AV_PERSON_ID =  AV_PERSON_ID;
SET @AV_UNIT_NUMBER = AV_UNIT_NUMBER;
SET @AV_ADMIN_ID = AV_ADMIN_ID;

SET @AV_FILTER_ADMIN_IDS = JSON_UNQUOTE(JSON_EXTRACT(FILTER_JSON,'$.ADMIN_PERSON_IDS'));
SET @AV_FILTER_ASSIGNEE_IDS = JSON_UNQUOTE(JSON_EXTRACT(FILTER_JSON,'$.ASSIGNEE_IDS'));
SET @AV_FILTER_AGREEMENT_STATUS_CODES = JSON_UNQUOTE(JSON_EXTRACT(FILTER_JSON,'$.STATUS_CODE'));
SET @AV_FILTER_LOCATION_STATUS_CODES = JSON_UNQUOTE(JSON_EXTRACT(FILTER_JSON,'$.LOCATION_STATUS')); 
SET @AV_DEFAULT_CRITERIA_ASSIGNEE = JSON_UNQUOTE(JSON_EXTRACT(FILTER_JSON,'$.DEFAULT_CRITERIA_ASSIGNEE'));

SELECT COUNT(1) INTO IS_UNIT_ADMIN
	FROM PERSON_ROLES PR JOIN
	(SELECT ROLE_ID,RT.RIGHT_NAME
	   FROM ROLE_RIGHTS RR,
			RIGHTS RT
		WHERE RR.RIGHT_ID = RT.RIGHT_ID
		  AND RT.RIGHT_NAME IN ('AGREEMENT_ADMINISTRATOR')
	 ) RLE ON RLE.ROLE_ID = PR.ROLE_ID
	WHERE PR.PERSON_ID = @AV_PERSON_ID;


SELECT COUNT(1) INTO IS_GROUP_ADMIN 
	FROM ROLE_RIGHTS T1
	LEFT JOIN RIGHTS T2 ON T1.RIGHT_ID = T2.RIGHT_ID
	LEFT JOIN PERSON_ROLES T3 ON T1.ROLE_ID = T3.ROLE_ID
	WHERE T3.PERSON_ID = @AV_PERSON_ID AND T2.RIGHT_NAME = 'VIEW_ADMIN_GROUP_AGREEMENT';

    IF IS_UNIT_ADMIN > 0 THEN 
        SET @FILTER_TYPE = 'IS_UNIT_ADMIN';
    ELSEIF IS_GROUP_ADMIN > 0 THEN 
        SET @FILTER_TYPE = 'IS_GROUP_ADMIN';
    ELSE
        SET @FILTER_TYPE = 'DEFAULT';
    END IF;

(WITH ACCESS_TMP AS
				(
				SELECT UNIT_NUMBER
				FROM PERSON_ROLES T1
				INNER JOIN ROLE_RIGHTS T2 ON T1.ROLE_ID = T2.ROLE_ID
				INNER JOIN RIGHTS T3 ON T2.RIGHT_ID = T3.RIGHT_ID 
				WHERE T1.DESCEND_FLAG = 'N' AND T1.PERSON_ID = @AV_PERSON_ID
				AND RIGHT_NAME IN ('VIEW_ALL_AGREEMENT','MODIFY_ALL_AGREEMENT') 							
				UNION
				SELECT CHILD_UNIT_NUMBER FROM UNIT_WITH_CHILDREN 
				WHERE UNIT_NUMBER IN (
				SELECT UNIT_NUMBER
				FROM PERSON_ROLES T1
				INNER JOIN ROLE_RIGHTS T2 ON T1.ROLE_ID = T2.ROLE_ID
				INNER JOIN RIGHTS T3 ON T2.RIGHT_ID = T3.RIGHT_ID 
				WHERE T1.DESCEND_FLAG = 'Y' AND T1.PERSON_ID = @AV_PERSON_ID
				AND RIGHT_NAME IN ('VIEW_ALL_AGREEMENT','MODIFY_ALL_AGREEMENT') 
                )),
    ACCESS_TMP_ADMIN AS
         (
             SELECT UNIT_NUMBER
             FROM PERSON_ROLES T1
                      INNER JOIN ROLE_RIGHTS T2 ON T1.ROLE_ID = T2.ROLE_ID
                      INNER JOIN RIGHTS T3 ON T2.RIGHT_ID = T3.RIGHT_ID
             WHERE T1.DESCEND_FLAG = 'N' AND T1.PERSON_ID = @AV_PERSON_ID
               AND RIGHT_NAME IN ('AGREEMENT_ADMINISTRATOR')
             UNION
             SELECT CHILD_UNIT_NUMBER FROM UNIT_WITH_CHILDREN
             WHERE UNIT_NUMBER IN (
                 SELECT UNIT_NUMBER
                 FROM PERSON_ROLES T1
                          INNER JOIN ROLE_RIGHTS T2 ON T1.ROLE_ID = T2.ROLE_ID
                          INNER JOIN RIGHTS T3 ON T2.RIGHT_ID = T3.RIGHT_ID
                 WHERE T1.DESCEND_FLAG = 'Y' AND T1.PERSON_ID = @AV_PERSON_ID
                   AND RIGHT_NAME IN ('AGREEMENT_ADMINISTRATOR')
             )),
             VIEW_ACCESS_TMP_ADMIN 
							AS
							(
							SELECT UNIT_NUMBER
							FROM PERSON_ROLES T1
							INNER JOIN ROLE_RIGHTS T2 ON T1.ROLE_ID = T2.ROLE_ID
							INNER JOIN RIGHTS T3 ON T2.RIGHT_ID = T3.RIGHT_ID 
							WHERE T1.DESCEND_FLAG = 'N' AND T1.PERSON_ID = @AV_PERSON_ID
							AND RIGHT_NAME IN ('VIEW_ADMIN_GROUP_AGREEMENT') 							
							UNION
							SELECT CHILD_UNIT_NUMBER FROM UNIT_WITH_CHILDREN 
							WHERE UNIT_NUMBER IN (
							SELECT UNIT_NUMBER
							FROM PERSON_ROLES T1
							INNER JOIN ROLE_RIGHTS T2 ON T1.ROLE_ID = T2.ROLE_ID
							INNER JOIN RIGHTS T3 ON T2.RIGHT_ID = T3.RIGHT_ID 
							WHERE T1.DESCEND_FLAG = 'Y' AND T1.PERSON_ID = @AV_PERSON_ID
							AND RIGHT_NAME IN ('VIEW_ADMIN_GROUP_AGREEMENT') 
                            )),
	UNITS_BY_DESCEND_FLAG AS (
						SELECT CHILD_UNIT_NUMBER AS UNIT_NUMBER FROM UNIT_WITH_CHILDREN WHERE UNIT_NUMBER = @AV_UNIT_NUMBER AND @AV_DESCENT_FLAG = 'Y'
						UNION
						SELECT @AV_UNIT_NUMBER AS UNIT_NUMBER),
            FILTER_CRITERIA_ADMINS AS (SELECT LOOK_UP_VAL FROM JSON_TABLE( @AV_FILTER_ADMIN_IDS,"$[*]" COLUMNS ( LOOK_UP_VAL text PATH "$" )) AS virtual_table),
            FILTER_CRITERIA_ASSIGNEES AS (SELECT LOOK_UP_VAL FROM JSON_TABLE( @AV_FILTER_ASSIGNEE_IDS,"$[*]" COLUMNS ( LOOK_UP_VAL text PATH "$" )) AS virtual_table),
            FILTER_CRITERIA_AGT_STATUS AS (SELECT LOOK_UP_VAL FROM JSON_TABLE( @AV_FILTER_AGREEMENT_STATUS_CODES,"$[*]" COLUMNS ( LOOK_UP_VAL text PATH "$" )) AS virtual_table),
            FILTER_CRITERIA_LOC_STATUS AS (SELECT LOOK_UP_VAL FROM JSON_TABLE( @AV_FILTER_LOCATION_STATUS_CODES,"$[*]" COLUMNS ( LOOK_UP_VAL text PATH "$" )) AS virtual_table),
     MY_AGREEMENTS AS (
         SELECT AH.* FROM AGREEMENT_HEADER AH
                              INNER JOIN NEGOTIATION_ASSOCIATION S0 ON AH.AGREEMENT_REQUEST_ID = S0.ASSOCIATED_PROJECT_ID AND S0.ASSOCIATION_TYPE_CODE = 4
                              LEFT JOIN AGREEMENT_PEOPLE PI ON (AH.AGREEMENT_REQUEST_ID = PI.AGREEMENT_REQUEST_ID  AND PI.PEOPLE_TYPE_ID = 3)
                              LEFT JOIN ADMIN_GROUP T50 ON AH.ADMIN_GROUP_ID = T50.ADMIN_GROUP_ID
                              INNER JOIN AGREEMENT_TYPE T4 ON T4.AGREEMENT_TYPE_CODE = AH.AGREEMENT_TYPE_CODE
         WHERE
            ((T50.ROLE_ID IN (SELECT T51.ROLE_ID FROM ROLE_RIGHTS T51 
																	LEFT JOIN RIGHTS T52 ON T51.RIGHT_ID = T52.RIGHT_ID
																	LEFT JOIN PERSON_ROLES T53 ON T51.ROLE_ID = T53.ROLE_ID
																	WHERE T53.PERSON_ID = @AV_PERSON_ID AND T52.RIGHT_NAME = 'VIEW_ADMIN_GROUP_AGREEMENT'))
            OR ( @FILTER_TYPE = 'IS_UNIT_ADMIN' AND (
                    AH.UNIT_NUMBER IN (SELECT DISTINCT UNIT_NUMBER FROM ACCESS_TMP_ADMIN) OR (AH.ADMIN_PERSON_ID = @AV_PERSON_ID)
                  )
                )
            OR ( @FILTER_TYPE = 'IS_GROUP_ADMIN' AND (
                    AH.UNIT_NUMBER IN (SELECT DISTINCT UNIT_NUMBER FROM VIEW_ACCESS_TMP_ADMIN) OR (AH.ADMIN_PERSON_ID = @AV_PERSON_ID)
                  )
                )
            OR ( @FILTER_TYPE = 'DEFAULT' AND (
                    AH.UNIT_NUMBER IN (SELECT DISTINCT UNIT_NUMBER FROM ACCESS_TMP)
                  )
                )
            OR (AH.REQUESTOR_PERSON_ID = @AV_PERSON_ID)
            OR (PI.PERSON_ID= @AV_PERSON_ID)
            OR (AH.AGREEMENT_REQUEST_ID IN (SELECT R1.AGREEMENT_REQUEST_ID FROM AGREEMENT_PEOPLE_ROLES R1
                                                                                  INNER JOIN ROLE_RIGHTS R2 ON R1.ROLE_ID = R2.ROLE_ID
                                                                                  INNER JOIN RIGHTS R3 ON R2.RIGHT_ID = R3.RIGHT_ID
                                          WHERE R1.PERSON_ID = @AV_PERSON_ID AND R3.RIGHT_NAME
                                              IN ('VIEW_ALL_AGREEMENT','MODIFY_ALL_AGREEMENT')))
            OR (EXISTS (SELECT S1.NEGOTIATION_LOCATION_ID FROM NEGOTIATION_LOCATION S1 WHERE S1.NEGOTIATION_ID = S0.NEGOTIATION_ID AND S1.ASSIGNEE_PERSON_ID = @AV_PERSON_ID)))
            AND AH.AGREEMENT_SEQUENCE_STATUS <> 'TEMPLATE'
            AND ((@AV_UNIT_NUMBER IS NOT NULL AND EXISTS (SELECT 1 FROM UNITS_BY_DESCEND_FLAG UD WHERE UD.UNIT_NUMBER = AH.UNIT_NUMBER )) OR @AV_UNIT_NUMBER IS NULL )
            AND (@AV_ADMIN_ID = "" OR AH.ADMIN_PERSON_ID = @AV_ADMIN_ID)
            AND (@AV_FILTER_ADMIN_IDS IS NULL OR AH.ADMIN_PERSON_ID IN (SELECT LOOK_UP_VAL FROM FILTER_CRITERIA_ADMINS))
            AND (@AV_FILTER_ASSIGNEE_IDS IS NULL OR (EXISTS (SELECT S1.NEGOTIATION_LOCATION_ID FROM NEGOTIATION_LOCATION S1 WHERE S1.NEGOTIATION_ID = S0.NEGOTIATION_ID AND S1.ASSIGNEE_PERSON_ID IN (SELECT LOOK_UP_VAL FROM FILTER_CRITERIA_ASSIGNEES))))
            AND (@AV_FILTER_AGREEMENT_STATUS_CODES IS NULL OR AH.AGREEMENT_STATUS_CODE IN (SELECT LOOK_UP_VAL FROM FILTER_CRITERIA_AGT_STATUS))
            AND (@AV_FILTER_LOCATION_STATUS_CODES IS NULL OR EXISTS (SELECT S1.NEGOTIATION_LOCATION_ID FROM NEGOTIATION_LOCATION S1 WHERE S1.NEGOTIATION_ID = S0.NEGOTIATION_ID AND S1.LOCATION_STATUS_CODE IN (SELECT LOOK_UP_VAL FROM FILTER_CRITERIA_LOC_STATUS)))
            AND ((@AV_DEFAULT_CRITERIA_ASSIGNEE IS NULL OR IS_UNIT_ADMIN > 0) OR (
					NOT EXISTS (
						SELECT 1 
						FROM NEGOTIATION_LOCATION S_ALL 
						WHERE S_ALL.ASSIGNEE_PERSON_ID = @AV_PERSON_ID
						)
					OR EXISTS (
					SELECT 1 
					FROM NEGOTIATION_LOCATION S1 
					WHERE S1.NEGOTIATION_ID = S0.NEGOTIATION_ID 
					AND S1.ASSIGNEE_PERSON_ID = @AV_PERSON_ID
					)
            )
            )
     )



(SELECT
    JSON_ARRAYAGG(
                JSON_OBJECT(
                    'personId', T.ASSIGNEE_PERSON_ID,
                    'fullName',  T.FULL_NAME,
                    'adminFullName',T.ADMIN_PERSON_NAME,
                    'adminId',T.ADMIN_PERSON_ID,
                    'locationCount', T.LOCATION_COUNT
                )
            ) AS assignees_json
FROM 
(
    SELECT DISTINCT
    NL.ASSIGNEE_PERSON_ID AS ASSIGNEE_PERSON_ID,
    IF(P.PERSON_ID IS NOT NULL, P.FULL_NAME, (SELECT R.FULL_NAME FROM ROLODEX R WHERE R.ROLODEX_ID = NL.ASSIGNEE_PERSON_ID)) AS FULL_NAME,
    IF(@AV_ADMIN_ID = "", NULL, AH2.ADMIN_PERSON_NAME) AS ADMIN_PERSON_NAME,
    IF(@AV_ADMIN_ID = "", NULL, AH2.ADMIN_PERSON_ID) AS ADMIN_PERSON_ID,
    IF(@AV_ADMIN_ID = "", NULL, (SELECT COUNT(DISTINCT NL2.NEGOTIATION_LOCATION_ID)
                        FROM NEGOTIATION_LOCATION NL2
                        WHERE NL2.ASSIGNEE_PERSON_ID = NL.ASSIGNEE_PERSON_ID)) AS LOCATION_COUNT
                FROM NEGOTIATION_LOCATION NL
                INNER JOIN NEGOTIATION_ASSOCIATION NA ON NL.NEGOTIATION_ID = NA.NEGOTIATION_ID
                INNER JOIN MY_AGREEMENTS AH2 ON NA.ASSOCIATED_PROJECT_ID = AH2.AGREEMENT_REQUEST_ID
                LEFT JOIN PERSON P ON P.PERSON_ID = NL.ASSIGNEE_PERSON_ID
                WHERE NL.ASSIGNEE_PERSON_ID IS NOT NULL
                AND (@AV_ADMIN_ID = "" OR AH2.ADMIN_PERSON_ID = @AV_ADMIN_ID)
                AND (@AV_FILTER_ASSIGNEE_IDS IS NULL OR NL.ASSIGNEE_PERSON_ID IN (SELECT LOOK_UP_VAL FROM FILTER_CRITERIA_ASSIGNEES))
                AND (@AV_FILTER_ADMIN_IDS IS NULL OR AH2.ADMIN_PERSON_ID IN (SELECT LOOK_UP_VAL FROM FILTER_CRITERIA_ADMINS))
) T)
);

SET @AV_DESCENT_FLAG =  NULL;
SET @AV_PERSON_ID =  NULL;
SET @AV_UNIT_NUMBER = NULL;
SET @AV_ADMIN_ID = NULL;
SET @AV_FILTER_ADMIN_IDS = NULL;
SET @AV_FILTER_ASSIGNEE_IDS = NULL;
SET @AV_FILTER_AGREEMENT_STATUS_CODES = NULL;
SET @AV_FILTER_LOCATION_STATUS_CODES = NULL;
END
