CREATE PROCEDURE `GET_AGREEMENT_DASHBOARD_V1`(
    IN AV_FILTER_JSON JSON,
    IN AV_DISPLAY_LIST JSON,
    IN AV_PERSON_ID VARCHAR(40),
    IN AV_OFFSET INT(10),
    IN AV_LIMIT INT(10),
    IN AV_TAB_TYPE VARCHAR(30),
    IN AV_IS_COUNT BOOLEAN,
    IN AV_SORT_TYPE VARCHAR(500))
BEGIN

 -- Declare variables
    DECLARE LS_DYN_SQL LONGTEXT;
    DECLARE LS_FILTER_CONDITION LONGTEXT;
    DECLARE LS_OFFSET INT(11);
    DECLARE IS_UNIT_ADMIN INT(11);
    DECLARE IS_GROUP_ADMIN INT(11);
    DECLARE LS_ADMIN_GROUP_CONDITION LONGTEXT;
	DECLARE LS_TAB_QUERY_WHERE_CLAUSE 			LONGTEXT;
    
   -- Custom data element variables
    DECLARE LI_CUSTOM_DATA_ELEMENTS_ID INT(11);
    DECLARE LI_DATA_TYPE INT(11);
    DECLARE LS_CUST_LABEL VARCHAR(255);
    DECLARE LI_CUST_ORDER INT(11);
    DECLARE LS_IS_MULTI_SELECT_LOOKUP VARCHAR(1);
    DECLARE LS_CUSTOM_CRT VARCHAR(255);
    DECLARE LS_CUST_CRT_VALUE TEXT;
    DECLARE CUSTOM_CRT_QUERY TEXT;
    DECLARE LS_CUSTOM_COL VARCHAR(255);
    DECLARE LS_CUSTOM_DATA_ELEMENT VARCHAR(255);
    DECLARE LS_CUSTOM_DATA_JOIN_SEL TEXT;
    DECLARE NOT_FOUND INT DEFAULT 0;

    -- Cursor for custom data elements
    DECLARE CUSTOM_DATA_ELEMENTS_IDS CURSOR FOR
      SELECT CDE.CUSTOM_DATA_ELEMENTS_ID, CDE.DATA_TYPE, CDE.COLUMN_LABEL, CDEU.ORDER_NUMBER, CDE.IS_MULTI_SELECT_LOOKUP
      FROM CUSTOM_DATA_ELEMENTS CDE
      INNER JOIN CUSTOM_DATA_ELEMENT_USAGE CDEU ON CDEU.CUSTOM_DATA_ELEMENTS_ID = CDE.CUSTOM_DATA_ELEMENTS_ID
      WHERE CDEU.MODULE_CODE = 13 AND CDE.IS_ACTIVE = 'Y' AND CDEU.IS_REQ_ADVANCE_SEARCH = 'Y';

    DECLARE CONTINUE HANDLER FOR NOT FOUND SET NOT_FOUND = 1;

    SET LS_FILTER_CONDITION = '';
    SET LS_CUSTOM_DATA_JOIN_SEL = '';
    SET LS_TAB_QUERY_WHERE_CLAUSE 	='';
    SET LS_DYN_SQL = '';
    SET LS_ADMIN_GROUP_CONDITION = '';
    SET @CUST_CRITERIA_MAP = JSON_OBJECT();
    SET @CUST_COL_MAP = JSON_OBJECT();
    SET @AV_FILTER_JSON = AV_FILTER_JSON;
    SET @AV_DISPLAY_LIST = AV_DISPLAY_LIST;
    
	-- Check admin permissions
    SELECT COUNT(1) INTO IS_UNIT_ADMIN 
    FROM PERSON_ROLES T1
    INNER JOIN ROLE_RIGHTS T2 ON T1.ROLE_ID = T2.ROLE_ID
    INNER JOIN RIGHTS T3 ON T2.RIGHT_ID = T3.RIGHT_ID 
    WHERE T1.PERSON_ID = AV_PERSON_ID AND T3.RIGHT_NAME = 'AGREEMENT_ADMINISTRATOR';

    SELECT COUNT(1) INTO IS_GROUP_ADMIN 
    FROM PERSON_ROLES T1
    INNER JOIN ROLE_RIGHTS T2 ON T1.ROLE_ID = T2.ROLE_ID
    INNER JOIN RIGHTS T3 ON T2.RIGHT_ID = T3.RIGHT_ID 
    WHERE T1.PERSON_ID = AV_PERSON_ID AND T3.RIGHT_NAME = 'VIEW_ADMIN_GROUP_AGREEMENT';
    
    -- PREPARE CUSTOM DATA QUERY: START
    OPEN CUSTOM_DATA_ELEMENTS_IDS;
    CUSTOM_DATA_ELEMENTS_LOOP: LOOP
        SET NOT_FOUND = 0;
        FETCH CUSTOM_DATA_ELEMENTS_IDS INTO LI_CUSTOM_DATA_ELEMENTS_ID, LI_DATA_TYPE, LS_CUST_LABEL, LI_CUST_ORDER, LS_IS_MULTI_SELECT_LOOKUP;
        
        IF NOT_FOUND = 1 THEN
            LEAVE CUSTOM_DATA_ELEMENTS_LOOP;
        END IF;

        -- Build custom field names
        SET LS_CUSTOM_CRT = CONCAT('CRT_AG_CUST_ELEMENTS_ID_', LI_CUSTOM_DATA_ELEMENTS_ID);
        SET LS_CUSTOM_DATA_ELEMENT = CONCAT('CUST_ELEMENTS_ID_', LI_CUSTOM_DATA_ELEMENTS_ID);
        SET LS_CUST_CRT_VALUE = JSON_UNQUOTE(JSON_EXTRACT(AV_FILTER_JSON, CONCAT('$.', LS_CUSTOM_CRT)));
        
       SET LS_CUSTOM_DATA_JOIN_SEL = CONCAT(
            LS_CUSTOM_DATA_JOIN_SEL,
            CASE 
               WHEN LI_DATA_TYPE = 4 OR (LI_DATA_TYPE IN (8,9) AND LS_IS_MULTI_SELECT_LOOKUP = 'Y') THEN 
				CONCAT(
					'JSON_ARRAYAGG(JSON_OBJECT(''CUSTOM_ANSWER'', CUST_ELEMENTS_ID_', LI_CUSTOM_DATA_ELEMENTS_ID, 
					')) AS CUST_ELEMENTS_ID_', LI_CUSTOM_DATA_ELEMENTS_ID
				)
                WHEN LI_DATA_TYPE = 3 THEN
				CONCAT('(UNIX_TIMESTAMP( CUST_ELEMENTS_ID_', LI_CUSTOM_DATA_ELEMENTS_ID, '))*1000 AS CUST_ELEMENTS_ID_', LI_CUSTOM_DATA_ELEMENTS_ID)
                ELSE 
                    CONCAT('CUST_ELEMENTS_ID_', LI_CUSTOM_DATA_ELEMENTS_ID)
            END,
            ','
        );

        -- Build custom criteria query
        IF LS_CUST_CRT_VALUE IS NOT NULL THEN
            SET CUSTOM_CRT_QUERY = NULL;
            IF LI_DATA_TYPE IN (3) THEN
                SET CUSTOM_CRT_QUERY = CONCAT('(', LS_CUSTOM_DATA_ELEMENT, ' = (UNIX_TIMESTAMP(''', LS_CUST_CRT_VALUE, ''')*1000))');
            ELSEIF LI_DATA_TYPE IN (1,10) THEN
                SET CUSTOM_CRT_QUERY = CONCAT('(', LS_CUSTOM_DATA_ELEMENT, ' LIKE ''%', LS_CUST_CRT_VALUE, '%'')');
            ELSEIF LI_DATA_TYPE IN (4,6,8,9) THEN
                IF LS_IS_MULTI_SELECT_LOOKUP = 'Y' THEN
                    SET CUSTOM_CRT_QUERY = CONCAT('(EXISTS(SELECT 1 FROM AGREEMENT_CUSTOM_DATA_RT WHERE AGREEMENT_REQUEST_ID = T1.AGREEMENT_REQUEST_ID AND MATCH(', LS_CUSTOM_DATA_ELEMENT, ') AGAINST (''', LS_CUST_CRT_VALUE, ''') ))');
                ELSE
                    SET CUSTOM_CRT_QUERY = CONCAT('(EXISTS(SELECT 1 FROM AGREEMENT_CUSTOM_DATA_RT WHERE AGREEMENT_REQUEST_ID = T1.AGREEMENT_REQUEST_ID AND ',
                     LS_CUSTOM_DATA_ELEMENT, ' IN (SELECT value FROM JSON_TABLE(''',LS_CUST_CRT_VALUE,''',"$[*]" COLUMNS (value LONGTEXT PATH "$")) AS t)  ))');
                END IF;
            ELSE
                IF LI_DATA_TYPE IN (7, 5) THEN
                    SET LS_CUST_CRT_VALUE = JSON_UNQUOTE(JSON_EXTRACT(LS_CUST_CRT_VALUE, '$[0]'));
                END IF;
                
                SET CUSTOM_CRT_QUERY = CONCAT('(', LS_CUSTOM_DATA_ELEMENT, ' = ''', LS_CUST_CRT_VALUE, ''')');
            END IF;
            
            IF CUSTOM_CRT_QUERY IS NOT NULL THEN
                SET @CUST_CRITERIA_MAP = JSON_INSERT(@CUST_CRITERIA_MAP, CONCAT('$.', LS_CUSTOM_CRT), CUSTOM_CRT_QUERY);
            END IF;
        END IF;
        
        -- Handle custom column display
        SET LS_CUSTOM_COL = CONCAT('COL_AG_CUST_ELEMENTS_ID_', LI_CUSTOM_DATA_ELEMENTS_ID);

        IF JSON_CONTAINS(AV_DISPLAY_LIST, JSON_QUOTE(LS_CUSTOM_COL)) = 1 THEN
            SET @CUST_COL_MAP = JSON_INSERT(@CUST_COL_MAP, CONCAT('$.', LS_CUSTOM_COL), CONCAT('CD.', CONCAT('CUST_ELEMENTS_ID_', LI_CUSTOM_DATA_ELEMENTS_ID))); -- "COL_CUST_ELEMENTS_ID_101": "CD.CUST_ELEMENTS_ID_101"
        END IF;
  
    END LOOP CUSTOM_DATA_ELEMENTS_LOOP;
    CLOSE CUSTOM_DATA_ELEMENTS_IDS;
    
    SET LS_CUSTOM_DATA_JOIN_SEL = TRIM(TRAILING ',' FROM LS_CUSTOM_DATA_JOIN_SEL);
    -- PREPARE CUSTOM DATA QUERY: END
    
     -- PREPARE CTE QUERY: START
    SET @DYNAMIC_CTE = CONCAT('WITH ACCESS_TMP AS (
                                SELECT UNIT_NUMBER
                                FROM PERSON_ROLES T1
                                INNER JOIN ROLE_RIGHTS T2 ON T1.ROLE_ID = T2.ROLE_ID
                                INNER JOIN RIGHTS T3 ON T2.RIGHT_ID = T3.RIGHT_ID 
                                WHERE T1.DESCEND_FLAG = ''N'' AND T1.PERSON_ID = ''', AV_PERSON_ID, '''
                                AND T3.RIGHT_NAME IN (''VIEW_ALL_AGREEMENT'',''MODIFY_ALL_AGREEMENT'')
                                UNION
                                SELECT CHILD_UNIT_NUMBER FROM UNIT_WITH_CHILDREN 
                                WHERE UNIT_NUMBER IN (
                                    SELECT UNIT_NUMBER
                                    FROM PERSON_ROLES T1
                                    INNER JOIN ROLE_RIGHTS T2 ON T1.ROLE_ID = T2.ROLE_ID
                                    INNER JOIN RIGHTS T3 ON T2.RIGHT_ID = T3.RIGHT_ID 
                                    WHERE T1.DESCEND_FLAG = ''Y'' AND T1.PERSON_ID = ''', AV_PERSON_ID, '''
                                    AND T3.RIGHT_NAME IN (''VIEW_ALL_AGREEMENT'',''MODIFY_ALL_AGREEMENT'')
                                )),
                            ACCESS_TMP_ADMIN AS (
                                SELECT UNIT_NUMBER
                                FROM PERSON_ROLES T1
                                INNER JOIN ROLE_RIGHTS T2 ON T1.ROLE_ID = T2.ROLE_ID
                                INNER JOIN RIGHTS T3 ON T2.RIGHT_ID = T3.RIGHT_ID 
                                WHERE T1.DESCEND_FLAG = ''N'' AND T1.PERSON_ID = ''', AV_PERSON_ID, '''
                                AND T3.RIGHT_NAME IN (''AGREEMENT_ADMINISTRATOR'')
                                UNION
                                SELECT CHILD_UNIT_NUMBER FROM UNIT_WITH_CHILDREN 
                                WHERE UNIT_NUMBER IN (
                                    SELECT UNIT_NUMBER
                                    FROM PERSON_ROLES T1
                                    INNER JOIN ROLE_RIGHTS T2 ON T1.ROLE_ID = T2.ROLE_ID
                                    INNER JOIN RIGHTS T3 ON T2.RIGHT_ID = T3.RIGHT_ID 
                                    WHERE T1.DESCEND_FLAG = ''Y'' AND T1.PERSON_ID = ''', AV_PERSON_ID, '''
                                    AND T3.RIGHT_NAME IN (''AGREEMENT_ADMINISTRATOR'')
                                )),
                            VIEW_ACCESS_TMP_ADMIN AS (
                                SELECT UNIT_NUMBER
                                FROM PERSON_ROLES T1
                                INNER JOIN ROLE_RIGHTS T2 ON T1.ROLE_ID = T2.ROLE_ID
                                INNER JOIN RIGHTS T3 ON T2.RIGHT_ID = T3.RIGHT_ID 
                                WHERE T1.DESCEND_FLAG = ''N'' AND T1.PERSON_ID = ''', AV_PERSON_ID, '''
                                AND T3.RIGHT_NAME IN (''VIEW_ADMIN_GROUP_AGREEMENT'')
                                UNION
                                SELECT CHILD_UNIT_NUMBER FROM UNIT_WITH_CHILDREN 
                                WHERE UNIT_NUMBER IN (
                                    SELECT UNIT_NUMBER
                                    FROM PERSON_ROLES T1
                                    INNER JOIN ROLE_RIGHTS T2 ON T1.ROLE_ID = T2.ROLE_ID
                                    INNER JOIN RIGHTS T3 ON T2.RIGHT_ID = T3.RIGHT_ID 
                                    WHERE T1.DESCEND_FLAG = ''Y'' AND T1.PERSON_ID = ''', AV_PERSON_ID, '''
                                    AND T3.RIGHT_NAME IN (''VIEW_ADMIN_GROUP_AGREEMENT'')
                                )),
                            SPONSORS AS (
                                SELECT T31.AGREEMENT_REQUEST_ID, T32.DISPLAY_NAME AS ORGANIZATION, T32.SPONSOR_CODE,T32.SPONSOR_TYPE_CODE,T31.AGREEMENT_SPONSOR_TYPE_CODE
                                FROM AGREEMENT_SPONSOR T31
                                INNER JOIN SPONSOR T32 ON T31.SPONSOR_CODE = T32.SPONSOR_CODE
								WHERE AGREEMENT_SPONSOR_TYPE_CODE = 1
                            ),
                            AGREEMENT_ACTION_LOG AS (
								SELECT
									AGREEMENT_REQUEST_ID,
									MIN(UPDATE_TIMESTAMP) AS SUBMITTED_DATE
								FROM AGREEMENT_ACTION_LOG
								WHERE ACTION_TYPE_CODE IN (2, 20)
								GROUP BY AGREEMENT_REQUEST_ID
							) 
                        ');
    -- PREPARE CTE QUERY: END
    SET @ASSOC_CTE = 'AG_ASSOC_DETAIL AS (
                        SELECT 
                        T.AGREEMENT_ID,
                        JSON_ARRAYAGG(
                            JSON_OBJECT(
                            ''MODULE_CODE'', T.MODULE_CODE,
                            ''MODULE_NAME'', T.MODULE_NAME,
                            ''MODULE_ITEM_KEY'', T.MODULE_ITEM_KEY,
                            ''MODULE_ITEM_ID'', T.MODULE_ITEM_ID,
                            ''TITLE'', T.TITLE,
                            ''PI_NAME'', T.PI_NAME,
                            ''PI_PERSON_ID'', T.PI_PERSON_ID,
                            ''PI_ROLODEX_PERSON_ID'', T.PI_ROLODEX_PERSON_ID,
                            ''SPONSOR_CODE'', T.SPONSOR_CODE,
                            ''SPONSOR_NAME'', T.SPONSOR_NAME,
                            ''START_DATE'', (UNIX_TIMESTAMP(T.START_DATE)*1000),
							''END_DATE'', (UNIX_TIMESTAMP(T.END_DATE)*1000),
                            ''LEAD_UNIT_NUMBER'', T.LEAD_UNIT_NUMBER,
                            ''LEAD_UNIT_NAME'', T.LEAD_UNIT_NAME)) AS MODULES
                            FROM ag_assoc_detail_v T
                            GROUP BY T.AGREEMENT_ID)';

    SET @KEY_WORD_CTE ='AGREEMENT_KEYWORDS_JSON AS (
                            SELECT AK.AGREEMENT_REQUEST_ID,
                                JSON_ARRAYAGG(
                                    JSON_OBJECT(''KEYWORD'', SK.DESCRIPTION)
                                ) AS KEYWORDS
                            FROM AGREEMENT_KEYWORDS AK
                            LEFT JOIN SCIENCE_KEYWORD SK ON SK.SCIENCE_KEYWORD_CODE = AK.SCIENCE_KEYWORD_CODE
                            GROUP BY AK.AGREEMENT_REQUEST_ID
                        )';
    SET @AGREEMENT_PEOPLE_CTE ='AGREEMENT_PEOPLE_JSON AS (
                        SELECT AP.AGREEMENT_REQUEST_ID,
                            JSON_ARRAYAGG(
                                JSON_OBJECT(
                                    ''FIRST_NAME'', COALESCE(P.FIRST_NAME, R.FIRST_NAME),
                                    ''LAST_NAME'', COALESCE(P.LAST_NAME, R.LAST_NAME),
                                    ''FULL_NAME'', COALESCE(P.FULL_NAME, CONCAT(R.FIRST_NAME, '' '', R.LAST_NAME)),
                                    ''ROLE_NAME'', APT.DESCRIPTION,
                                    ''PERCENTAGE_OF_EFFORT'', NULL
                                )
                            ) AS KEY_PERSONS
                        FROM AGREEMENT_PEOPLE AP
                        LEFT JOIN PERSON P ON P.PERSON_ID = AP.PERSON_ID
                        LEFT JOIN ROLODEX R ON R.ROLODEX_ID = AP.ROLODEX_ID
                        INNER JOIN AGREEMENT_PEOPLE_TYPE APT ON APT.PEOPLE_TYPE_ID = AP.PEOPLE_TYPE_ID
                        GROUP BY AP.AGREEMENT_REQUEST_ID
                        )';

    SET @NEGO_REVIEW_CTE ='NEGOTIATION_AND_REVIEW AS (
												SELECT
						NG.ASSOCIATED_PROJECT_ID AS AGREEMENT_REQUEST_ID,
						JSON_ARRAYAGG(
							JSON_OBJECT(
								''ASSIGNED_TO'', P.FULL_NAME,
								''LOCATION'', NLT.DESCRIPTION,
								''ASSIGNED_BY'', PE.FULL_NAME,
								''LOCATION_STATUS'', NLS.DESCRIPTION,
								''LOCATION_STATUS_CODE'',NL.LOCATION_STATUS_CODE
							)
						) AS REVIEW_DETAILS
					FROM negotiation_association NG
					INNER JOIN NEGOTIATION_LOCATION NL ON NL.NEGOTIATION_ID = NG.NEGOTIATION_ID
					INNER JOIN NEGOTIATION_LOCATION_TYPE NLT ON NLT.LOCATION_TYPE_CODE = NL.LOCATION_TYPE_CODE
					INNER JOIN NEGOTIATION_LOCATION_STATUS NLS ON NLS.LOCATION_STATUS_CODE = NL.LOCATION_STATUS_CODE
					LEFT JOIN PERSON P ON P.PERSON_ID = NL.ASSIGNEE_PERSON_ID
					LEFT JOIN PERSON PE ON PE.USER_NAME = NL.CREATE_USER
					GROUP BY NG.ASSOCIATED_PROJECT_ID
                    )';

        SET @SPECIAL_REVIEW_CTE ='AGREEMENT_SPECIAL_REVIEW_JSON AS (
                                     SELECT
                                         AGREEMENT_REQUEST_ID,
                                         JSON_ARRAYAGG(
                                             JSON_OBJECT(
                                                 ''PROTOCOL_NUMBER'', PROTOCOL_NUMBER
                                             )
                                         ) AS SPECIAL_REVIEWS
                                     FROM agreement_special_review
                                     GROUP BY AGREEMENT_REQUEST_ID
                                 )';    

     SET @CTE_MAP = JSON_OBJECT(
    'CTE_ASSOC', @ASSOC_CTE,
    'CTE_KEYWORD_CTE', @KEY_WORD_CTE,
    'CTE_AGREEMENT_PEOPLE', @AGREEMENT_PEOPLE_CTE,
    'CTE_NEGO_REVIEW', @NEGO_REVIEW_CTE,
    'CTE_SPECIAL_REVIEW', @SPECIAL_REVIEW_CTE
    );

    SET @CTE_KEY_MAP = JSON_ARRAY(
    JSON_OBJECT('CTE_ASSOC', JSON_ARRAY('COL_AG_ASSOC_END_DATE','COL_AG_ASSOC_START_DATE','COL_AG_ASSOC_RECORD_PI','COL_AG_ASSOC_RECORD_ID','COL_AG_ASSOC_SPONSOR')),
    JSON_OBJECT('CTE_KEYWORD_CTE', JSON_ARRAY('COL_AG_KEYWORDS')),
    JSON_OBJECT('CTE_AGREEMENT_PEOPLE', JSON_ARRAY('COL_AG_KEY_PERSON')),
    JSON_OBJECT('CTE_NEGO_REVIEW', JSON_ARRAY('COL_AG_REVIEW_DETAILS','CRT_AG_REVIEW_DETAILS')),
    JSON_OBJECT('CTE_SPECIAL_REVIEW', JSON_ARRAY('COL_AG_SPL_REVIEW_PROTOCOL','CRT_AG_SPL_REVIEW_PROTOCOL'))
    );

SET @DYNAMIC_CTE = CONCAT(@DYNAMIC_CTE, COALESCE(FN_PREPARE_DASHBOARD_JOINS(@AV_DISPLAY_LIST,  @AV_FILTER_JSON, @CTE_KEY_MAP, @CTE_MAP, 'CTE'),''));
    
     -- PREPARE COLUMN QUERY: START
    IF AV_IS_COUNT = FALSE THEN
        SET @QUERY_MAP = JSON_OBJECT(
			'CURRENCY_CODE','T1.CURRENCY_CODE',
            'agreementRequestId', 'T1.AGREEMENT_REQUEST_ID',
            'COL_AG_REQUEST_ID', 'T1.AGREEMENT_REQUEST_ID',
			'NEGOTIATION_ID', 'S0.NEGOTIATION_ID',
            'HEADER_ID','T1.AGREEMENT_REQUEST_ID',
            'AGREEMENT_STATUS_CODE','T1.AGREEMENT_STATUS_CODE',
            'COL_AG_TITLE', 'T1.TITLE',
            'COL_AG_KKI_STATUS', 'CASE WHEN T1.IS_HOLD = ''Y'' THEN CONCAT(T2.DESCRIPTION, '' - '', ''Info Requested'') ELSE T2.DESCRIPTION END',
            'COL_AG_JHU_STATUS', 'CASE WHEN T1.IS_HOLD = ''Y'' THEN CONCAT(T2.DESCRIPTION, '' - '', ''Compliance Pending'') ELSE T2.DESCRIPTION END',
            'COL_AG_STATUS', 'CASE WHEN T1.IS_HOLD = ''Y'' THEN CONCAT(T2.DESCRIPTION, '' - '', ''On Hold'') ELSE T2.DESCRIPTION END',
            'COL_AG_TYPE', 'T4.DESCRIPTION',
            'COL_AG_REQUESTOR', 'T1.REQUESTOR_NAME',
            'COL_AG_LEAD_UNIT', 'T5.DISPLAY_NAME',
            'COL_AG_CONTRACT_VALUE', 'T1.CONTRACT_VALUE',
            'COL_AG_ADMINISTRATOR', 'T1.ADMIN_PERSON_NAME',
            'COL_AG_ADMIN_GROUP', 'AG.ADMIN_GROUP_NAME',
            'COL_AG_PI', 'PI.FULL_NAME',
            'COL_AG_SPONSOR', 'SPO.ORGANIZATION',
			'COL_AG_CATEGORY', 'AC.DESCRIPTION',
			'COL_AG_SPONSOR_TYPE', 'ST.DESCRIPTION',
            'COL_AG_SUBMISSION_DATE', '(UNIX_TIMESTAMP(AL.SUBMITTED_DATE)*1000)',
            'COL_AG_LAST_MOD_DATE', '(UNIX_TIMESTAMP(T1.UPDATE_TIMESTAMP)*1000)',
            'COL_AG_REVIEW_STATUS', 'ARS.DESCRIPTION',
			'COL_AG_PI_UNIT', 'U.DISPLAY_NAME',
			'COL_AG_SPL_REVIEW_PROTOCOL', '(ASR.SPECIAL_REVIEWS)',
            'COL_AG_REVIEW_DETAILS', '(NR.REVIEW_DETAILS)',
            'COL_AG_KEY_PERSON', '(AP.KEY_PERSONS)',
            'COL_AG_ASSOC_SPONSOR','(ASD.MODULES)',
            'COL_AG_ASSOC_RECORD_ID','(ASD.MODULES)',
            'COL_AG_ASSOC_RECORD_PI','(ASD.MODULES)',
            'COL_AG_ASSOC_START_DATE','(ASD.MODULES)',
            'COL_AG_ASSOC_END_DATE','(ASD.MODULES)',
            'COL_AG_KEYWORDS','(K.KEYWORDS)'
        );

        SET AV_DISPLAY_LIST = JSON_ARRAY_APPEND(AV_DISPLAY_LIST,'$','agreementRequestId');
		SET AV_DISPLAY_LIST = JSON_ARRAY_APPEND(AV_DISPLAY_LIST,'$','HEADER_ID');
        SET AV_DISPLAY_LIST = JSON_ARRAY_APPEND(AV_DISPLAY_LIST,'$','AGREEMENT_STATUS_CODE');
		SET AV_DISPLAY_LIST = JSON_ARRAY_APPEND(AV_DISPLAY_LIST,'$','NEGOTIATION_ID');
        SET AV_DISPLAY_LIST = JSON_ARRAY_APPEND(AV_DISPLAY_LIST,'$','CURRENCY_CODE');
        
        SELECT JSON_MERGE_PATCH(@QUERY_MAP, @CUST_COL_MAP) INTO @QUERY_MAP;

        -- Build display mapping from requested columns
        SET @DISPLAY_MAP = (
            SELECT JSON_OBJECTAGG(jk.k, JSON_UNQUOTE(JSON_EXTRACT(@QUERY_MAP, CONCAT('$.', jk.k))))
            FROM JSON_TABLE(AV_DISPLAY_LIST, '$[*]' COLUMNS (k VARCHAR(100) PATH '$')) AS jk
            WHERE JSON_EXTRACT(@QUERY_MAP, CONCAT('$.', jk.k)) IS NOT NULL
        );
        
        SELECT FN_PREPARE_DASHBOARD_SELECT(@DISPLAY_MAP) INTO @SELECT_STM;
        SELECT FN_PREPARE_DASHBOARD_JSON(@DISPLAY_MAP) INTO @DISPLAY;

    END IF;
    -- PREPARE COLUMN QUERY: END
    

    -- PREPARE JOIN QUERY: START
    SET @CUSTOM_DATA_JOIN = CONCAT('LEFT JOIN (SELECT AGREEMENT_REQUEST_ID,', LS_CUSTOM_DATA_JOIN_SEL, ' FROM AGREEMENT_CUSTOM_DATA_RT GROUP BY AGREEMENT_REQUEST_ID) CD ON CD.AGREEMENT_REQUEST_ID = T1.AGREEMENT_REQUEST_ID');

    SET @JOIN_QUERY_MAP = JSON_OBJECT(
        'JOIN_CUSTOM_DATA', @CUSTOM_DATA_JOIN,
        'JOIN_AG_AGREEMENT_STATUS', 'INNER JOIN AGREEMENT_STATUS T2 ON T2.AGREEMENT_STATUS_CODE = T1.AGREEMENT_STATUS_CODE',
        'JOIN_AG_UNIT', 'INNER JOIN UNIT T5 ON T1.UNIT_NUMBER = T5.UNIT_NUMBER',
        'JOIN_AG_AGREEMENT_TYPE', 'INNER JOIN AGREEMENT_TYPE T4 ON T4.AGREEMENT_TYPE_CODE = T1.AGREEMENT_TYPE_CODE',
		'JOIN_AG_SPONSORS', 'LEFT JOIN SPONSORS SPO ON T1.AGREEMENT_REQUEST_ID = SPO.AGREEMENT_REQUEST_ID',
        'JOIN_AG_ADMIN_GROUP', 'LEFT JOIN ADMIN_GROUP AG ON T1.ADMIN_GROUP_ID = AG.ADMIN_GROUP_ID',
		'JOIN_AG_CATEGORY', 'LEFT JOIN AGREEMENT_CATEGORY AC ON AC.CATEGORY_CODE = T1.CATEGORY_CODE',
		'JOIN_AG_SPONSOR_TYPE', 'LEFT JOIN SPONSOR_TYPE ST ON ST.SPONSOR_TYPE_CODE  = SPO.SPONSOR_TYPE_CODE',
        'JOIN_AG_ACTION_LOG', 'LEFT JOIN AGREEMENT_ACTION_LOG AL ON T1.AGREEMENT_REQUEST_ID = AL.AGREEMENT_REQUEST_ID',
		'JOIN_AG_PI_PERSON', 'LEFT JOIN PERSON P ON P.PERSON_ID = PI.PERSON_ID',
        'JOIN_AG_PI_UNIT', 'LEFT JOIN UNIT U ON U.UNIT_NUMBER = P.HOME_UNIT',
		'JOIN_AG_SPL_REVIEW',' LEFT JOIN AGREEMENT_SPECIAL_REVIEW_JSON ASR ON T1.AGREEMENT_REQUEST_ID = ASR.AGREEMENT_REQUEST_ID',
        'JOIN_AG_REVIEW_DETAILS',' LEFT JOIN NEGOTIATION_AND_REVIEW NR ON T1.AGREEMENT_REQUEST_ID = NR.AGREEMENT_REQUEST_ID ',
        'JOIN_AG_KEY_PERSONS',' LEFT JOIN AGREEMENT_PEOPLE_JSON AP ON T1.AGREEMENT_REQUEST_ID = AP.AGREEMENT_REQUEST_ID ',
        'JOIN_AG_ASSOC',' LEFT JOIN AG_ASSOC_DETAIL ASD ON T1.AGREEMENT_REQUEST_ID = ASD.AGREEMENT_ID ',
        'JOIN_AG_KEYWORDS',' LEFT JOIN AGREEMENT_KEYWORDS_JSON K ON T1.AGREEMENT_REQUEST_ID = K.AGREEMENT_REQUEST_ID',
        'JOIN_AG_REVIEW_STATUS','LEFT JOIN AGREEMENT_REVIEW_STATUS ARS ON T1.REVIEW_STATUS_CODE = ARS.REVIEW_STATUS_CODE'
    );

    SET @JOIN_KEY_MAP = JSON_ARRAY(
        JSON_OBJECT('JOIN_CUSTOM_DATA', JSON_ARRAY('CUST_ELEMENTS_ID')),
        JSON_OBJECT('JOIN_AG_AGREEMENT_STATUS', JSON_ARRAY('COL_AG_STATUS','CRT_AG_STATUS','COL_AG_KKI_STATUS','COL_AG_JHU_STATUS')),
        JSON_OBJECT('JOIN_AG_UNIT', JSON_ARRAY('COL_AG_LEAD_UNIT', 'CRT_AG_LEAD_UNIT')),
        JSON_OBJECT('JOIN_AG_AGREEMENT_TYPE', JSON_ARRAY('COL_AG_TYPE','CRT_AG_TYPE')),
        JSON_OBJECT('JOIN_AG_SPONSORS', JSON_ARRAY('COL_AG_SPONSOR','CRT_AG_SPONSOR','COL_AG_SPONSOR_TYPE')),
        JSON_OBJECT('JOIN_AG_ADMIN_GROUP', JSON_ARRAY('COL_AG_ADMIN_GROUP')),
		JSON_OBJECT('JOIN_AG_CATEGORY', JSON_ARRAY('COL_AG_CATEGORY','CRT_AG_CATEGORY')),
        JSON_OBJECT('JOIN_AG_SPONSOR_TYPE', JSON_ARRAY('COL_AG_SPONSOR_TYPE')),
        JSON_OBJECT('JOIN_AG_ACTION_LOG', JSON_ARRAY('COL_AG_SUBMISSION_DATE','CRT_AG_SUBMISSION_DATE')),
        JSON_OBJECT('JOIN_AG_REVIEW_STATUS', JSON_ARRAY('COL_AG_REVIEW_STATUS')),
		JSON_OBJECT('JOIN_AG_PI_PERSON', JSON_ARRAY('COL_AG_PI_UNIT','CRT_AG_PI_UNIT')),
		JSON_OBJECT('JOIN_AG_PI_UNIT', JSON_ARRAY('COL_AG_PI_UNIT')),
        JSON_OBJECT('JOIN_AG_SPL_REVIEW', JSON_ARRAY('COL_AG_SPL_REVIEW_PROTOCOL')),
        JSON_OBJECT('JOIN_AG_REVIEW_DETAILS', JSON_ARRAY('COL_AG_REVIEW_DETAILS')),
		JSON_OBJECT('JOIN_AG_KEY_PERSONS', JSON_ARRAY('COL_AG_KEY_PERSON')),
		JSON_OBJECT('JOIN_AG_ASSOC', JSON_ARRAY('COL_AG_ASSOC_END_DATE','COL_AG_ASSOC_START_DATE','COL_AG_ASSOC_RECORD_PI','COL_AG_ASSOC_RECORD_ID','COL_AG_ASSOC_SPONSOR')),
		JSON_OBJECT('JOIN_AG_KEYWORDS', JSON_ARRAY('COL_AG_KEYWORDS'))
    );

    SELECT FN_PREPARE_DASHBOARD_JOINS(AV_DISPLAY_LIST, AV_FILTER_JSON, @JOIN_KEY_MAP, @JOIN_QUERY_MAP,'JOIN') INTO @JOIN_QUERY;
    -- PREPARE JOIN QUERY: END
    
    -- PREPARE TAB QUERIES: START
SET @MY_PENDING_AGREEMENTS_QUERY = CONCAT(' WHERE ((EXISTS (SELECT S1.NEGOTIATION_LOCATION_ID FROM NEGOTIATION_LOCATION S1 WHERE S1.ASSIGNEE_PERSON_ID=''',AV_PERSON_ID,''' 
AND S1.NEGOTIATION_ID = S0.NEGOTIATION_ID AND LOCATION_STATUS_CODE NOT IN (3,4))) OR (T1.AGREEMENT_REQUEST_ID IN 
(SELECT T9.MODULE_ITEM_ID FROM WORKFLOW T9 INNER JOIN WORKFLOW_DETAIL T10 ON T9.WORKFLOW_ID = T10.WORKFLOW_ID WHERE T9.MODULE_CODE = 13 AND T10.APPROVER_PERSON_ID = ''',AV_PERSON_ID,'''
 AND T9.MODULE_ITEM_ID = T1.AGREEMENT_REQUEST_ID AND T9.IS_WORKFLOW_ACTIVE = ''Y'' AND T10.APPROVAL_STATUS = ''W'')) OR (T1.ADMIN_PERSON_ID =''',AV_PERSON_ID,'''
  AND T1.AGREEMENT_STATUS_CODE IN (SELECT S.AGREEMENT_STATUS_CODE FROM AGREEMENT_STATUS S WHERE S.IS_TERMINAL <> ''Y''))) AND T1.AGREEMENT_STATUS_CODE IN
   (SELECT S.AGREEMENT_STATUS_CODE FROM AGREEMENT_STATUS S WHERE S.IS_TERMINAL <> ''Y'')');

SET @ALL_PENDING_AGREEMENTS_QUERY = CONCAT(
    IF(IS_UNIT_ADMIN > 0,
        CONCAT('((((EXISTS (SELECT S1.NEGOTIATION_LOCATION_ID FROM NEGOTIATION_LOCATION S1 WHERE S1.NEGOTIATION_ID = S0.NEGOTIATION_ID AND LOCATION_STATUS_CODE NOT IN (3,4))) OR (T1.AGREEMENT_REQUEST_ID IN (SELECT T9.MODULE_ITEM_ID FROM WORKFLOW T9 INNER JOIN WORKFLOW_DETAIL T10 ON T9.WORKFLOW_ID = T10.WORKFLOW_ID WHERE T9.MODULE_CODE = 13 AND T9.MODULE_ITEM_ID = T1.AGREEMENT_REQUEST_ID AND T9.IS_WORKFLOW_ACTIVE = ''Y'' AND T10.APPROVAL_STATUS = ''W'')) OR (T1.ADMIN_PERSON_ID IS NOT NULL AND T1.AGREEMENT_STATUS_CODE IN (SELECT S.AGREEMENT_STATUS_CODE FROM AGREEMENT_STATUS S WHERE S.IS_TERMINAL <> ''Y''))) AND T1.AGREEMENT_STATUS_CODE IN (SELECT S.AGREEMENT_STATUS_CODE FROM AGREEMENT_STATUS S WHERE S.IS_TERMINAL <> ''Y'')) AND (T1.UNIT_NUMBER IN(SELECT DISTINCT UNIT_NUMBER FROM ACCESS_TMP_ADMIN))) OR ((EXISTS (SELECT S1.NEGOTIATION_LOCATION_ID FROM NEGOTIATION_LOCATION S1 WHERE S1.ASSIGNEE_PERSON_ID=''',AV_PERSON_ID,''' AND S1.NEGOTIATION_ID = S0.NEGOTIATION_ID AND LOCATION_STATUS_CODE NOT IN (3,4))) OR (T1.AGREEMENT_REQUEST_ID IN (SELECT T9.MODULE_ITEM_ID FROM WORKFLOW T9 INNER JOIN WORKFLOW_DETAIL T10 ON T9.WORKFLOW_ID = T10.WORKFLOW_ID WHERE T9.MODULE_CODE = 13 AND T10.APPROVER_PERSON_ID = ''',AV_PERSON_ID,''' AND T9.MODULE_ITEM_ID = T1.AGREEMENT_REQUEST_ID AND T9.IS_WORKFLOW_ACTIVE = ''Y'' AND T10.APPROVAL_STATUS = ''W'')) OR (T1.ADMIN_PERSON_ID =''',AV_PERSON_ID,''' AND T1.AGREEMENT_STATUS_CODE IN (SELECT S.AGREEMENT_STATUS_CODE FROM AGREEMENT_STATUS S WHERE S.IS_TERMINAL <> ''Y'')))) AND T1.AGREEMENT_STATUS_CODE IN (SELECT S.AGREEMENT_STATUS_CODE FROM AGREEMENT_STATUS S WHERE S.IS_TERMINAL <> ''Y'')'),
        CONCAT(' OR (((EXISTS (SELECT S1.NEGOTIATION_LOCATION_ID FROM NEGOTIATION_LOCATION S1 WHERE S1.NEGOTIATION_ID = S0.NEGOTIATION_ID AND LOCATION_STATUS_CODE NOT IN (3,4))) OR (T1.AGREEMENT_REQUEST_ID IN (SELECT T9.MODULE_ITEM_ID FROM WORKFLOW T9 INNER JOIN WORKFLOW_DETAIL T10 ON T9.WORKFLOW_ID = T10.WORKFLOW_ID WHERE T9.MODULE_CODE = 13 AND T9.MODULE_ITEM_ID = T1.AGREEMENT_REQUEST_ID AND T9.IS_WORKFLOW_ACTIVE = ''Y'' AND T10.APPROVAL_STATUS = ''W'')) OR (T1.ADMIN_PERSON_ID IS NOT NULL AND T1.AGREEMENT_STATUS_CODE IN(2,3,6,5))) AND (T1.UNIT_NUMBER IN(SELECT DISTINCT UNIT_NUMBER FROM VIEW_ACCESS_TMP_ADMIN))) OR ((EXISTS (SELECT S1.NEGOTIATION_LOCATION_ID FROM NEGOTIATION_LOCATION S1 WHERE S1.ASSIGNEE_PERSON_ID=''',AV_PERSON_ID,''' AND S1.NEGOTIATION_ID = S0.NEGOTIATION_ID AND LOCATION_STATUS_CODE NOT IN (3,4))) OR (T1.AGREEMENT_REQUEST_ID IN (SELECT T9.MODULE_ITEM_ID FROM WORKFLOW T9 INNER JOIN WORKFLOW_DETAIL T10 ON T9.WORKFLOW_ID = T10.WORKFLOW_ID WHERE T9.MODULE_CODE = 13 AND T10.APPROVER_PERSON_ID = ''',AV_PERSON_ID,''' AND T9.MODULE_ITEM_ID = T1.AGREEMENT_REQUEST_ID AND T9.IS_WORKFLOW_ACTIVE = ''Y'' AND T10.APPROVAL_STATUS = ''W'')) OR (T1.ADMIN_PERSON_ID =''',AV_PERSON_ID,''' AND T1.AGREEMENT_STATUS_CODE IN (SELECT S.AGREEMENT_STATUS_CODE FROM AGREEMENT_STATUS S WHERE S.IS_TERMINAL <> ''Y'')))) AND T1.AGREEMENT_STATUS_CODE IN (SELECT S.AGREEMENT_STATUS_CODE FROM AGREEMENT_STATUS S WHERE S.IS_TERMINAL <> ''Y'')')
    )
);

    SET @AGREEMENT_BASE_FILTER = CONCAT('',
        IF(IS_UNIT_ADMIN > 0,
            CONCAT('(T1.UNIT_NUMBER IN(SELECT DISTINCT UNIT_NUMBER FROM ACCESS_TMP_ADMIN)) OR (T1.REQUESTOR_PERSON_ID =''', AV_PERSON_ID ,''') 
            OR (PI.PERSON_ID=''', AV_PERSON_ID ,''') OR (T1.ADMIN_PERSON_ID =''',AV_PERSON_ID,''') OR (T1.AGREEMENT_REQUEST_ID IN (SELECT R1.AGREEMENT_REQUEST_ID FROM AGREEMENT_PEOPLE_ROLES R1 
            INNER JOIN ROLE_RIGHTS R2 ON R1.ROLE_ID = R2.ROLE_ID INNER JOIN RIGHTS R3 ON R2.RIGHT_ID = R3.RIGHT_ID WHERE R1.PERSON_ID = ''',AV_PERSON_ID,''' 
            AND R3.RIGHT_NAME IN (''VIEW_ALL_AGREEMENT'',''MODIFY_ALL_AGREEMENT'')))'),
            IF(IS_GROUP_ADMIN > 0,
                CONCAT('(T1.UNIT_NUMBER IN(SELECT DISTINCT UNIT_NUMBER FROM VIEW_ACCESS_TMP_ADMIN)) OR (T1.REQUESTOR_PERSON_ID =''', AV_PERSON_ID ,''') OR (PI.PERSON_ID=''', AV_PERSON_ID ,''') 
                OR (T1.ADMIN_PERSON_ID =''',AV_PERSON_ID,''') OR (T1.AGREEMENT_REQUEST_ID IN (SELECT R1.AGREEMENT_REQUEST_ID FROM AGREEMENT_PEOPLE_ROLES R1 
                INNER JOIN ROLE_RIGHTS R2 ON R1.ROLE_ID = R2.ROLE_ID INNER JOIN RIGHTS R3 ON R2.RIGHT_ID = R3.RIGHT_ID WHERE R1.PERSON_ID = ''',AV_PERSON_ID,''' 
                AND R3.RIGHT_NAME IN (''VIEW_ALL_AGREEMENT'',''MODIFY_ALL_AGREEMENT''))'),
                CONCAT('(T1.UNIT_NUMBER IN(SELECT DISTINCT UNIT_NUMBER FROM ACCESS_TMP) OR (T1.REQUESTOR_PERSON_ID =''', AV_PERSON_ID ,''') OR (PI.PERSON_ID=''', AV_PERSON_ID ,''')) OR 
                (T1.AGREEMENT_REQUEST_ID IN (SELECT R1.AGREEMENT_REQUEST_ID FROM AGREEMENT_PEOPLE_ROLES R1 INNER JOIN ROLE_RIGHTS R2 ON R1.ROLE_ID = R2.ROLE_ID INNER JOIN RIGHTS R3 ON R2.RIGHT_ID = R3.RIGHT_ID 
                WHERE R1.PERSON_ID = ''',AV_PERSON_ID,''' AND R3.RIGHT_NAME IN (''VIEW_ALL_AGREEMENT'',''MODIFY_ALL_AGREEMENT'')))')
            )
        ),
        CONCAT(' OR (EXISTS (SELECT S1.NEGOTIATION_LOCATION_ID FROM NEGOTIATION_LOCATION S1 WHERE S1.NEGOTIATION_ID = S0.NEGOTIATION_ID AND S1.ASSIGNEE_PERSON_ID = ''',AV_PERSON_ID,''')))'),
          IF(IS_UNIT_ADMIN = 0 AND IS_GROUP_ADMIN > 0, ')', '')																		
        );
                                                                                    

    SET @NEW_SUBMISSIONS_QUERY = CONCAT('',
        IF(IS_UNIT_ADMIN > 0,
            CONCAT('(T1.UNIT_NUMBER IN(SELECT DISTINCT UNIT_NUMBER FROM ACCESS_TMP_ADMIN)) OR (T1.REQUESTOR_PERSON_ID =''', AV_PERSON_ID ,''') OR (PI.PERSON_ID=''', AV_PERSON_ID ,''') 
            OR (T1.ADMIN_PERSON_ID =''',AV_PERSON_ID,''') OR (T1.AGREEMENT_REQUEST_ID IN (SELECT R1.AGREEMENT_REQUEST_ID FROM AGREEMENT_PEOPLE_ROLES R1 INNER JOIN ROLE_RIGHTS R2 ON R1.ROLE_ID = R2.ROLE_ID 
            INNER JOIN RIGHTS R3 ON R2.RIGHT_ID = R3.RIGHT_ID WHERE R1.PERSON_ID = ''',AV_PERSON_ID,''' AND R3.RIGHT_NAME IN (''VIEW_ALL_AGREEMENT'',''MODIFY_ALL_AGREEMENT'')))'),
            CONCAT('(T1.UNIT_NUMBER IN(SELECT DISTINCT UNIT_NUMBER FROM VIEW_ACCESS_TMP_ADMIN)) OR (T1.REQUESTOR_PERSON_ID =''', AV_PERSON_ID ,''') OR (PI.PERSON_ID=''', AV_PERSON_ID ,''') OR 
            (T1.ADMIN_PERSON_ID =''',AV_PERSON_ID,''') OR (T1.AGREEMENT_REQUEST_ID IN (SELECT R1.AGREEMENT_REQUEST_ID FROM AGREEMENT_PEOPLE_ROLES R1 INNER JOIN ROLE_RIGHTS R2 ON R1.ROLE_ID = R2.ROLE_ID 
            INNER JOIN RIGHTS R3 ON R2.RIGHT_ID = R3.RIGHT_ID WHERE R1.PERSON_ID = ''',AV_PERSON_ID,''' AND R3.RIGHT_NAME IN (''VIEW_ALL_AGREEMENT'',''MODIFY_ALL_AGREEMENT''))')
        ),
        CONCAT(' OR (EXISTS (SELECT S1.NEGOTIATION_LOCATION_ID FROM NEGOTIATION_LOCATION S1 WHERE S1.NEGOTIATION_ID = S0.NEGOTIATION_ID AND S1.ASSIGNEE_PERSON_ID = ''',AV_PERSON_ID,''' )))'),
        IF(IS_UNIT_ADMIN  = 0, ')', '')
    );

    SET @TAB_QUERY_MAP = JSON_OBJECT(
        'IN_PROGRESS_AGREEMENTS', CONCAT(@AGREEMENT_BASE_FILTER, ' AND T1.AGREEMENT_STATUS_CODE = 1'),
        'ALL_AGREEMENTS', CONCAT(@AGREEMENT_BASE_FILTER),
        'NEW_SUBMISSIONS', CONCAT(@NEW_SUBMISSIONS_QUERY, ' AND T1.AGREEMENT_STATUS_CODE = 7'),
        'MY_PENDING_AGREEMENTS', @MY_PENDING_AGREEMENTS_QUERY,
        'ALL_PENDING_AGREEMENTS', @ALL_PENDING_AGREEMENTS_QUERY
    );

	IF IS_GROUP_ADMIN > 0 AND (AV_TAB_TYPE <> 'MY_PENDING_AGREEMENTS') THEN
	 SET LS_ADMIN_GROUP_CONDITION =  CONCAT(' LEFT JOIN ADMIN_GROUP T50 ON T1.ADMIN_GROUP_ID = T50.ADMIN_GROUP_ID
									WHERE (T50.ROLE_ID IN (SELECT T51.ROLE_ID FROM ROLE_RIGHTS T51 
																	LEFT JOIN RIGHTS T52 ON T51.RIGHT_ID = T52.RIGHT_ID
																	LEFT JOIN PERSON_ROLES T53 ON T51.ROLE_ID = T53.ROLE_ID
																	WHERE T53.PERSON_ID = ''', AV_PERSON_ID ,''' AND T52.RIGHT_NAME = ''VIEW_ADMIN_GROUP_AGREEMENT'')');
		IF IS_UNIT_ADMIN > 0 OR (IS_GROUP_ADMIN > 0 AND  (AV_TAB_TYPE =  'ALL_AGREEMENTS' OR AV_TAB_TYPE =  'IN_PROGRESS_AGREEMENTS'  OR AV_TAB_TYPE =  'NEW_SUBMISSIONS'))THEN
			SET LS_ADMIN_GROUP_CONDITION =  CONCAT(LS_ADMIN_GROUP_CONDITION,'OR ');
		END IF;
	ELSEIF  LS_ADMIN_GROUP_CONDITION = '' AND (AV_TAB_TYPE <> 'MY_PENDING_AGREEMENTS') THEN
		 SET LS_TAB_QUERY_WHERE_CLAUSE = CONCAT(' WHERE (', LS_TAB_QUERY_WHERE_CLAUSE);
	END IF;
    
        SET @TAB_QUERY = JSON_UNQUOTE(JSON_EXTRACT(@TAB_QUERY_MAP, CONCAT('$.', AV_TAB_TYPE)));
	IF LS_TAB_QUERY_WHERE_CLAUSE IS NOT NULL AND LS_TAB_QUERY_WHERE_CLAUSE != '' THEN
    SET @TAB_QUERY = CONCAT(LS_TAB_QUERY_WHERE_CLAUSE, @TAB_QUERY);
END IF;
    
    
    -- PREPARE TAB QUERY: END
    
    
	-- PREPARE CRITERIA QUERY: START
    SET @CRT_AG_SUBMISSION_DATE_CRT = CONCAT(
        '(AL.SUBMITTED_DATE IS NOT NULL AND (',
        '    (JSON_UNQUOTE(JSON_EXTRACT(@AV_FILTER_JSON, ''$.CRT_AG_SUBMISSION_DATE.fromDate'')) IS NOT NULL AND JSON_UNQUOTE(JSON_EXTRACT(@AV_FILTER_JSON, ''$.CRT_AG_SUBMISSION_DATE.toDate'')) IS NOT NULL AND DATE(AL.SUBMITTED_DATE) >= DATE(JSON_UNQUOTE(JSON_EXTRACT(@AV_FILTER_JSON, ''$.CRT_AG_SUBMISSION_DATE.fromDate''))) AND DATE(AL.SUBMITTED_DATE) <= DATE(JSON_UNQUOTE(JSON_EXTRACT(@AV_FILTER_JSON, ''$.CRT_AG_SUBMISSION_DATE.toDate''))))',
        '    OR (JSON_UNQUOTE(JSON_EXTRACT(@AV_FILTER_JSON, ''$.CRT_AG_SUBMISSION_DATE.fromDate'')) IS NOT NULL AND JSON_UNQUOTE(JSON_EXTRACT(@AV_FILTER_JSON, ''$.CRT_AG_SUBMISSION_DATE.toDate'')) IS NULL AND DATE(AL.SUBMITTED_DATE) >= DATE(JSON_UNQUOTE(JSON_EXTRACT(@AV_FILTER_JSON, ''$.CRT_AG_SUBMISSION_DATE.fromDate''))))',
        '    OR (JSON_UNQUOTE(JSON_EXTRACT(@AV_FILTER_JSON, ''$.CRT_AG_SUBMISSION_DATE.fromDate'')) IS NULL AND JSON_UNQUOTE(JSON_EXTRACT(@AV_FILTER_JSON, ''$.CRT_AG_SUBMISSION_DATE.toDate'')) IS NOT NULL AND DATE(AL.SUBMITTED_DATE) <= DATE(JSON_UNQUOTE(JSON_EXTRACT(@AV_FILTER_JSON, ''$.CRT_AG_SUBMISSION_DATE.toDate''))))',
        '))'
    );

    SET @CRT_AG_LAST_MOD_DATE_CRT = CONCAT(
        '(DATE(T1.UPDATE_TIMESTAMP) IS NOT NULL AND (',
        '    (JSON_UNQUOTE(JSON_EXTRACT(@AV_FILTER_JSON, ''$.CRT_AG_LAST_MOD_DATE.fromDate'')) IS NOT NULL AND JSON_UNQUOTE(JSON_EXTRACT(@AV_FILTER_JSON, ''$.CRT_AG_LAST_MOD_DATE.toDate'')) IS NOT NULL AND DATE(T1.UPDATE_TIMESTAMP) >= DATE(JSON_UNQUOTE(JSON_EXTRACT(@AV_FILTER_JSON, ''$.CRT_AG_LAST_MOD_DATE.fromDate''))) AND DATE(T1.UPDATE_TIMESTAMP) <= DATE(JSON_UNQUOTE(JSON_EXTRACT(@AV_FILTER_JSON, ''$.CRT_AG_LAST_MOD_DATE.toDate''))))',
        '    OR (JSON_UNQUOTE(JSON_EXTRACT(@AV_FILTER_JSON, ''$.CRT_AG_LAST_MOD_DATE.fromDate'')) IS NOT NULL AND JSON_UNQUOTE(JSON_EXTRACT(@AV_FILTER_JSON, ''$.CRT_AG_LAST_MOD_DATE.toDate'')) IS NULL AND DATE(T1.UPDATE_TIMESTAMP) >= DATE(JSON_UNQUOTE(JSON_EXTRACT(@AV_FILTER_JSON, ''$.CRT_AG_LAST_MOD_DATE.fromDate''))))',
        '    OR (JSON_UNQUOTE(JSON_EXTRACT(@AV_FILTER_JSON, ''$.CRT_AG_LAST_MOD_DATE.fromDate'')) IS NULL AND JSON_UNQUOTE(JSON_EXTRACT(@AV_FILTER_JSON, ''$.CRT_AG_LAST_MOD_DATE.toDate'')) IS NOT NULL AND DATE(T1.UPDATE_TIMESTAMP) <= DATE(JSON_UNQUOTE(JSON_EXTRACT(@AV_FILTER_JSON, ''$.CRT_AG_LAST_MOD_DATE.toDate''))))',
        '))'
    );
    SET @ASSOC_START_DATE_CRT='(EXISTS(SELECT 1 FROM ag_assoc_detail_v WHERE AGREEMENT_ID= T1.AGREEMENT_REQUEST_ID
                            AND (
                                (JSON_UNQUOTE(JSON_EXTRACT(@AV_FILTER_JSON, ''$.CRT_AG_ASSOC_START_DATE.fromDate'')) IS NULL AND CAST(START_DATE AS DATE) <= JSON_UNQUOTE(JSON_EXTRACT(@AV_FILTER_JSON, ''$.CRT_AG_ASSOC_START_DATE.toDate'')))
                                OR (JSON_UNQUOTE(JSON_EXTRACT(@AV_FILTER_JSON, ''$.CRT_AG_ASSOC_START_DATE.toDate'')) IS NULL AND CAST(START_DATE AS DATE) >= JSON_UNQUOTE(JSON_EXTRACT(@AV_FILTER_JSON, ''$.CRT_AG_ASSOC_START_DATE.fromDate'')))
                                OR (CAST(START_DATE AS DATE) BETWEEN JSON_UNQUOTE(JSON_EXTRACT(@AV_FILTER_JSON, ''$.CRT_AG_ASSOC_START_DATE.fromDate'')) AND JSON_UNQUOTE(JSON_EXTRACT(@AV_FILTER_JSON, ''$.CRT_AG_ASSOC_START_DATE.toDate'')))
                                )
                            ))';
    SET @ASSOC_END_DATE_CRT='(EXISTS(SELECT 1 FROM ag_assoc_detail_v WHERE AGREEMENT_ID= T1.AGREEMENT_REQUEST_ID
                        AND (
                            (JSON_UNQUOTE(JSON_EXTRACT(@AV_FILTER_JSON, ''$.CRT_AG_ASSOC_END_DATE.fromDate'')) IS NULL AND CAST(END_DATE AS DATE) <= JSON_UNQUOTE(JSON_EXTRACT(@AV_FILTER_JSON, ''$.CRT_AG_ASSOC_END_DATE.toDate'')))
                            OR (JSON_UNQUOTE(JSON_EXTRACT(@AV_FILTER_JSON, ''$.CRT_AG_ASSOC_END_DATE.toDate'')) IS NULL AND CAST(END_DATE AS DATE) >= JSON_UNQUOTE(JSON_EXTRACT(@AV_FILTER_JSON, ''$.CRT_AG_ASSOC_END_DATE.fromDate'')))
                            OR (CAST(END_DATE AS DATE) BETWEEN JSON_UNQUOTE(JSON_EXTRACT(@AV_FILTER_JSON, ''$.CRT_AG_ASSOC_END_DATE.fromDate'')) AND JSON_UNQUOTE(JSON_EXTRACT(@AV_FILTER_JSON, ''$.CRT_AG_ASSOC_END_DATE.toDate'')))
                            )
                        ))';
    SET @CRT_LINKED_RECORD_PI_CRT = '(
            ( JSON_UNQUOTE(JSON_EXTRACT(@AV_FILTER_JSON, ''$.CRT_AG_ASSOC_RECORD_PI.isEmp'')) = ''true'' AND EXISTS (SELECT 1 FROM ag_assoc_detail_v WHERE AGREEMENT_ID = T1.AGREEMENT_REQUEST_ID  AND PI_PERSON_ID IN (SELECT res FROM JSON_TABLE(JSON_EXTRACT(@AV_FILTER_JSON, ''$.CRT_AG_ASSOC_RECORD_PI.values''), ''$[*]'' COLUMNS(res LONGTEXT PATH ''$'')) jt) ) )
                OR
            ( JSON_UNQUOTE(JSON_EXTRACT(@AV_FILTER_JSON, ''$.CRT_LINKED_RECORD_PI.isEmp'')) = ''false'' AND EXISTS (SELECT 1 FROM ag_assoc_detail_v WHERE AGREEMENT_ID = T1.AGREEMENT_REQUEST_ID AND PI_ROLODEX_PERSON_ID IN (SELECT res FROM JSON_TABLE(JSON_EXTRACT(@AV_FILTER_JSON, ''$.CRT_AG_ASSOC_RECORD_PI.values''), ''$[*]'' COLUMNS(res LONGTEXT PATH ''$'')) jt) ) )
        )';
            
	SET @CRT_AG_PI_CRT = '(
    ( JSON_UNQUOTE(JSON_EXTRACT(@AV_FILTER_JSON, ''$.CRT_AG_PI.isEmp'')) = ''true'' AND EXISTS (
        SELECT 1 
        FROM AGREEMENT_PEOPLE AP 
        WHERE AP.AGREEMENT_REQUEST_ID = T1.AGREEMENT_REQUEST_ID 
          AND AP.PEOPLE_TYPE_ID = 3 
          AND AP.PERSON_ID IN (SELECT res FROM JSON_TABLE(JSON_EXTRACT(@AV_FILTER_JSON, ''$.CRT_AG_PI.values''), ''$[*]'' COLUMNS(res LONGTEXT PATH ''$'')) jt)
    ) )
     OR
    ( JSON_UNQUOTE(JSON_EXTRACT(@AV_FILTER_JSON, ''$.CRT_AG_PI.isEmp'')) = ''false'' AND EXISTS (
        SELECT 1 
        FROM AGREEMENT_PEOPLE AP 
        WHERE AP.AGREEMENT_REQUEST_ID = T1.AGREEMENT_REQUEST_ID 
          AND AP.PEOPLE_TYPE_ID = 3 
          AND AP.ROLODEX_ID IN (SELECT res FROM JSON_TABLE(JSON_EXTRACT(@AV_FILTER_JSON, ''$.CRT_AG_PI.values''), ''$[*]'' COLUMNS(res LONGTEXT PATH ''$'')) jt)
    ) )
    )';
    SET @CRITERIA_MAP = JSON_OBJECT(
		'CRT_AG_COMPLIANCE_PENDING', CONCAT('(T1.IS_HOLD IN (SELECT res FROM JSON_TABLE(JSON_EXTRACT(@AV_FILTER_JSON,''$.CRT_AG_COMPLIANCE_PENDING''), ''$[*]'' COLUMNS (res LONGTEXT PATH ''$'')) jt))'),
        'CRT_AG_REQUEST_ID', CONCAT('(T1.AGREEMENT_REQUEST_ID LIKE CONCAT("%",JSON_UNQUOTE(JSON_EXTRACT(@AV_FILTER_JSON,''$.CRT_AG_REQUEST_ID'')),"%"))'),
        'CRT_AG_TITLE', CONCAT('(T1.TITLE LIKE CONCAT("%",JSON_UNQUOTE(JSON_EXTRACT(@AV_FILTER_JSON,''$.CRT_AG_TITLE'')),"%"))'),
        'CRT_AG_REQUESTOR', CONCAT('(T1.REQUESTOR_PERSON_ID IN (SELECT res FROM JSON_TABLE(JSON_EXTRACT(@AV_FILTER_JSON,''$.CRT_AG_REQUESTOR''), ''$[*]'' COLUMNS (res LONGTEXT PATH ''$'')) jt))'),
        'CRT_AG_TYPE', CONCAT('(T1.AGREEMENT_TYPE_CODE IN (SELECT res FROM JSON_TABLE(JSON_EXTRACT(@AV_FILTER_JSON,''$.CRT_AG_TYPE''), ''$[*]'' COLUMNS (res LONGTEXT PATH ''$'')) jt))'),
        'CRT_AG_STATUS', CONCAT('(T1.AGREEMENT_STATUS_CODE IN (SELECT res FROM JSON_TABLE(JSON_EXTRACT(@AV_FILTER_JSON,''$.CRT_AG_STATUS''), ''$[*]'' COLUMNS (res LONGTEXT PATH ''$'')) jt))'),
        'CRT_AG_LEAD_UNIT', CONCAT('(T1.UNIT_NUMBER IN (SELECT res FROM JSON_TABLE(JSON_EXTRACT(@AV_FILTER_JSON,''$.CRT_AG_LEAD_UNIT''), ''$[*]'' COLUMNS (res LONGTEXT PATH ''$'')) jt))'),
		'CRT_AG_SPONSOR', CONCAT('(SPO.SPONSOR_CODE IN (SELECT res FROM JSON_TABLE(JSON_EXTRACT(@AV_FILTER_JSON,''$.CRT_AG_SPONSOR''), ''$[*]'' COLUMNS (res LONGTEXT PATH ''$'')) jt))'),
        'CRT_AG_PI', @CRT_AG_PI_CRT,
        'CRT_AG_REVIEW_STATUS', CONCAT('(T1.REVIEW_STATUS_CODE IN (SELECT res FROM JSON_TABLE(JSON_EXTRACT(@AV_FILTER_JSON,''$.CRT_AG_REVIEW_STATUS''), ''$[*]'' COLUMNS (res LONGTEXT PATH ''$'')) jt))'),
        'CRT_AG_SPONSOR_TYPE', CONCAT('(T1.AGREEMENT_REQUEST_ID IN (SELECT AGREEMENT_REQUEST_ID FROM AGREEMENT_SPONSOR T21
            WHERE T21.SPONSOR_CODE IN (SELECT SP1.SPONSOR_CODE FROM SPONSOR SP1
            WHERE SP1.SPONSOR_TYPE_CODE IN (SELECT res FROM JSON_TABLE(JSON_EXTRACT(@AV_FILTER_JSON,''$.CRT_AG_SPONSOR_TYPE''), ''$[*]'' COLUMNS (res LONGTEXT PATH ''$'')) jt))))'),
        'CRT_AG_ADMINISTRATOR', CONCAT('(T1.ADMIN_PERSON_ID IN (SELECT res FROM JSON_TABLE(JSON_EXTRACT(@AV_FILTER_JSON,''$.CRT_AG_ADMINISTRATOR''), ''$[*]'' COLUMNS (res LONGTEXT PATH ''$'')) jt))'),
        'CRT_AG_CATEGORY', CONCAT('(T1.CATEGORY_CODE IN (SELECT res FROM JSON_TABLE(JSON_EXTRACT(@AV_FILTER_JSON,''$.CRT_AG_CATEGORY''), ''$[*]'' COLUMNS (res LONGTEXT PATH ''$'')) jt))'),
        'CRT_AG_LOCATION_STATUS', CONCAT('(EXISTS (SELECT S1.NEGOTIATION_LOCATION_ID FROM NEGOTIATION_LOCATION S1
            WHERE S1.NEGOTIATION_ID = S0.NEGOTIATION_ID AND S1.LOCATION_STATUS_CODE IN (SELECT res FROM JSON_TABLE(JSON_EXTRACT(@AV_FILTER_JSON,''$.CRT_AG_LOCATION_STATUS''), ''$[*]'' COLUMNS (res LONGTEXT PATH ''$'')) jt)))'),
        'CRT_AG_SUBMISSION_DATE',@CRT_AG_SUBMISSION_DATE_CRT,
        'CRT_AG_LAST_MOD_DATE', @CRT_AG_LAST_MOD_DATE_CRT,
        'CRT_AG_KEYWORDS', CONCAT('(EXISTS(SELECT 1 FROM AGREEMENT_KEYWORDS AK INNER JOIN SCIENCE_KEYWORD SK ON AK.SCIENCE_KEYWORD_CODE = SK.SCIENCE_KEYWORD_CODE WHERE AK.AGREEMENT_REQUEST_ID = T1.AGREEMENT_REQUEST_ID AND SK.DESCRIPTION LIKE CONCAT("%",JSON_UNQUOTE(JSON_EXTRACT(@AV_FILTER_JSON,''$.CRT_AG_KEYWORDS'')),"%")))'),
        'CRT_AG_CONTRACT_VALUE', CONCAT('(T1.CONTRACT_VALUE LIKE CONCAT("%",JSON_UNQUOTE(JSON_EXTRACT(@AV_FILTER_JSON,''$.CRT_AG_CONTRACT_VALUE'')),"%"))'),
        'CRT_AG_ADMIN_GROUP', CONCAT('(T1.ADMIN_GROUP_ID IN (SELECT res FROM JSON_TABLE(JSON_EXTRACT(@AV_FILTER_JSON,''$.CRT_AG_ADMIN_GROUP''), ''$[*]'' COLUMNS (res LONGTEXT PATH ''$'')) jt))'),
		'CRT_AG_PI_UNIT', CONCAT('(P.HOME_UNIT IN (SELECT res FROM JSON_TABLE(JSON_EXTRACT(@AV_FILTER_JSON,''$.CRT_AG_PI_UNIT''), ''$[*]'' COLUMNS (res LONGTEXT PATH ''$'')) jt))'),
        'CRT_AG_REVIEW_DETAILS', CONCAT('(EXISTS (SELECT * FROM NEGOTIATION_AND_REVIEW NR
             WHERE NR.AGREEMENT_REQUEST_ID = T1.AGREEMENT_REQUEST_ID AND LOWER(JSON_UNQUOTE(JSON_SEARCH(LOWER(NR.REVIEW_DETAILS), ''one'', CONCAT(''%'' ,LOWER(JSON_UNQUOTE(JSON_EXTRACT(@AV_FILTER_JSON,''$.CRT_AG_REVIEW_DETAILS''))), ''%'')))) IS NOT NULL))'),
        'CRT_AG_SPL_REVIEW_PROTOCOL', CONCAT('(EXISTS (SELECT 1 FROM AGREEMENT_SPECIAL_REVIEW_JSON ASR WHERE ASR.AGREEMENT_REQUEST_ID = T1.AGREEMENT_REQUEST_ID AND LOWER(JSON_UNQUOTE(JSON_SEARCH(LOWER(ASR.SPECIAL_REVIEWS), ''one'', CONCAT(''%'' ,LOWER(JSON_UNQUOTE(JSON_EXTRACT(@AV_FILTER_JSON,''$.CRT_AG_SPL_REVIEW_PROTOCOL''))), ''%'')))) IS NOT NULL))'),
        'CRT_AG_KEY_PERSON', CONCAT('(T1.AGREEMENT_REQUEST_ID IN (SELECT AGREEMENT_REQUEST_ID FROM AGREEMENT_PEOPLE WHERE PERSON_ID IN (SELECT res FROM JSON_TABLE(JSON_EXTRACT(@AV_FILTER_JSON,''$.CRT_AG_KEY_PERSON''), ''$[*]'' COLUMNS (res LONGTEXT PATH ''$'')) jt)))'),
        'CRT_AG_ASSOC_SPONSOR', '(EXISTS (SELECT 1 FROM ag_assoc_detail_v WHERE AGREEMENT_ID= T1.AGREEMENT_REQUEST_ID AND SPONSOR_CODE IN (SELECT res FROM JSON_TABLE(JSON_EXTRACT(@AV_FILTER_JSON,''$.CRT_AG_ASSOC_SPONSOR''), ''$[*]'' COLUMNS(res LONGTEXT PATH ''$'')) jt)))', 
        'CRT_AG_ASSOC_START_DATE', @ASSOC_START_DATE_CRT,
        'CRT_AG_ASSOC_END_DATE', @ASSOC_END_DATE_CRT,
        'CRT_AG_ASSOC_RECORD_ID', '(EXISTS (SELECT 1 FROM ag_assoc_detail_v WHERE AGREEMENT_ID= T1.AGREEMENT_REQUEST_ID AND MODULE_ITEM_KEY LIKE CONCAT("%",JSON_UNQUOTE(JSON_EXTRACT(@AV_FILTER_JSON,''$.CRT_AG_ASSOC_RECORD_ID'')),"%")))',
        'CRT_AG_ASSOC_RECORD_PI', @CRT_LINKED_RECORD_PI_CRT,
        'CRT_AG_ASSOC_LINKED_MODULE', '(EXISTS (SELECT 1 FROM ag_assoc_detail_v WHERE AGREEMENT_ID= T1.AGREEMENT_REQUEST_ID AND MODULE_CODE IN (SELECT res FROM JSON_TABLE(JSON_EXTRACT(@AV_FILTER_JSON,''$.CRT_AG_ASSOC_LINKED_MODULE''), ''$[*]'' COLUMNS (res LONGTEXT PATH ''$'')) jt)))'
    );

    SELECT JSON_MERGE_PATCH(@CRITERIA_MAP, @CUST_CRITERIA_MAP) INTO @CRITERIA_MAP;
    SELECT FN_PREPARE_DASHBOARD_CRITERIA(AV_FILTER_JSON, @CRITERIA_MAP) INTO LS_FILTER_CONDITION;
    -- PREPARE CRITERIA QUERY: END

IF AV_SORT_TYPE IS NULL OR AV_SORT_TYPE = '' THEN
    SET AV_SORT_TYPE = 'T1.UPDATE_TIMESTAMP DESC';
ELSE
    SET AV_SORT_TYPE =  CONCAT(AV_SORT_TYPE,',T1.UPDATE_TIMESTAMP DESC');
END IF;

-- PREPARE FINAL AGGREGATED QUERY: START
SET LS_DYN_SQL = CONCAT(@DYNAMIC_CTE,
    CASE WHEN AV_IS_COUNT = TRUE 
        THEN ' SELECT TOTAL_COUNT FROM (SELECT COUNT(*) AS TOTAL_COUNT'
        ELSE CONCAT(' SELECT ', IFNULL(@DISPLAY, '*'), ' FROM (SELECT ', IFNULL(@SELECT_STM, '*'))
    END, 
    ' FROM AGREEMENT_HEADER T1
     INNER JOIN NEGOTIATION_ASSOCIATION S0 ON T1.AGREEMENT_REQUEST_ID = S0.ASSOCIATED_PROJECT_ID AND S0.ASSOCIATION_TYPE_CODE = 4 
     LEFT JOIN AGREEMENT_PEOPLE PI ON T1.AGREEMENT_REQUEST_ID = PI.AGREEMENT_REQUEST_ID AND PI.PEOPLE_TYPE_ID = 3 ',
    IFNULL(@JOIN_QUERY, ''),
    CASE 
        WHEN LS_ADMIN_GROUP_CONDITION IS NOT NULL AND LS_ADMIN_GROUP_CONDITION <> '' THEN LS_ADMIN_GROUP_CONDITION ELSE '' 
    END,
    CASE 
        WHEN @TAB_QUERY IS NOT NULL AND @TAB_QUERY <> '' THEN @TAB_QUERY ELSE '' 
    END,
    CASE 
        WHEN LS_FILTER_CONDITION IS NOT NULL AND LS_FILTER_CONDITION <> '' THEN CONCAT(' AND ', LS_FILTER_CONDITION) ELSE '' 
    END,
    ' AND T1.AGREEMENT_SEQUENCE_STATUS <> ''TEMPLATE'' ',
    IF(AV_IS_COUNT = FALSE,CONCAT(' ORDER BY ', AV_SORT_TYPE, ' '),''),
    IF(AV_IS_COUNT = FALSE,CONCAT(' LIMIT ', AV_LIMIT, ' OFFSET ', AV_OFFSET),''),') T');
-- PREPARE FINAL AGGREGATED QUERY: END
    
    SET @QUERY_STATEMENT = LS_DYN_SQL;
    PREPARE EXECUTABLE_STATEMENT FROM @QUERY_STATEMENT;
    EXECUTE EXECUTABLE_STATEMENT;
    DEALLOCATE PREPARE EXECUTABLE_STATEMENT;
END
