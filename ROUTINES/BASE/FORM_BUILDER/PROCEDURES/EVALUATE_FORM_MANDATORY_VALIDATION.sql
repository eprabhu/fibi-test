CREATE PROCEDURE `EVALUATE_FORM_MANDATORY_VALIDATION`(
AV_MODULE_CODE           VARCHAR(200),
AV_SUBMODULE_CODE        VARCHAR(200),
AV_MODULE_ITEM_KEY       VARCHAR(200),
AV_SUB_MODULE_ITEM_KEY   VARCHAR(20),
AV_FORM_ID      INT,
AV_SECTION_ID     INT,
AV_COMPONENT_ID    INT
)
    DETERMINISTIC
BEGIN
DECLARE LS_CUST_DATA_FLAG INT DEFAULT 0;
DECLARE LS_QUEST_FLAG VARCHAR(1) DEFAULT 'N';
DECLARE LI_FORM_BUILDER_SECT_COMP_ID INT;
DECLARE LS_COMPONENT_TYPE_CODE VARCHAR(10);
DECLARE LI_COMPONENT_REF_ID INT;
DECLARE LS_VALIDATION_MESSAGE VARCHAR(2000);
DECLARE LS_COMP_ID_LIST VARCHAR(2000);
DECLARE LI_ANS_HEADER_ID INT DEFAULT 0;
DECLARE LI_CNT INT DEFAULT 0;
DECLARE LI_QUESTION_ID INT;
DECLARE LS_Q_MANDATORY_MESSAGE VARCHAR(1000);
DECLARE LI_RULE_ID INT DEFAULT NULL;
DECLARE IS_CHILD_QUEST INT DEFAULT NULL;
DECLARE PRENT_ANSWERED VARCHAR(2000);
DECLARE COND_TYPE VARCHAR(50);
DECLARE COND_VALUE VARCHAR(2000);
DECLARE LI_NUM_OPTIONS INT;
DECLARE DONE1 INT DEFAULT 0;
DECLARE RULE_CURSOR CURSOR FOR

SELECT  T1.FORM_BUILDER_SECT_COMP_ID,
  T1.COMPONENT_TYPE_CODE,
  T1.COMPONENT_REF_ID,
  T1.VALIDATION_MESSAGE
FROM FORM_BUILDER_SECTION_COMPONENT T1
WHERE FIND_IN_SET(T1.FORM_BUILDER_SECT_COMP_ID, LS_COMP_ID_LIST)
AND T1.IS_MANDATORY = 'Y';

DECLARE QUEST_CURSOR CURSOR FOR
SELECT
Q.QUESTION_ID,
Q.MANDATORY_MESSAGE
FROM
QUEST_QUESTION Q
WHERE
Q.QUESTIONNAIRE_ID = LI_COMPONENT_REF_ID
AND Q.IS_MANDATORY = 'Y';     
 
DECLARE CONTINUE HANDLER FOR NOT FOUND SET DONE1 = 1;
CREATE TEMPORARY TABLE IF NOT EXISTS RESULT_TABLE (
        VALIDATION_TYPE VARCHAR(2),
        VALIDATION_MESSAGE VARCHAR(2000),
        FORM_BUILDER_SECT_COMP_ID INT,
        QUESTION_ID INT
);
 
    IF AV_FORM_ID IS NOT NULL THEN
            SELECT GROUP_CONCAT(FORM_BUILDER_SECT_COMP_ID) INTO LS_COMP_ID_LIST  
   FROM FORM_BUILDER_SECTION_COMPONENT
   WHERE FORM_BUILDER_SECTION_ID IN
            (SELECT FORM_BUILDER_SECTION_ID
             FROM FORM_BUILDER_SECTION
             WHERE FORM_BUILDER_ID = AV_FORM_ID);
    ELSEIF AV_SECTION_ID IS NOT NULL THEN
        SELECT GROUP_CONCAT(FORM_BUILDER_SECT_COMP_ID) INTO LS_COMP_ID_LIST   
        FROM FORM_BUILDER_SECTION_COMPONENT
        WHERE FORM_BUILDER_SECTION_ID = AV_SECTION_ID;
ELSEIF AV_COMPONENT_ID IS NOT NULL THEN
 
  SET LS_COMP_ID_LIST = AV_COMPONENT_ID;
 
END IF;
 
   OPEN RULE_CURSOR;
   RULE_CURSOR_LOOP : LOOP
            SET
                DONE1 = 0;
     FETCH RULE_CURSOR INTO LI_FORM_BUILDER_SECT_COMP_ID,
                    LS_COMPONENT_TYPE_CODE,
                    LI_COMPONENT_REF_ID,
                    LS_VALIDATION_MESSAGE;
     IF DONE1 = 1 THEN LEAVE RULE_CURSOR_LOOP;
 
     END IF;

    IF LS_COMPONENT_TYPE_CODE IN ('CE', 'NE', 'DE', 'AS', 'CB', 'ES', 'RB', 'SE', 'SD', 'TE', 'UD','CR','PT') THEN
    SELECT COUNT(T1.VALUE) INTO LS_CUST_DATA_FLAG
                FROM fb_comp_custom_element_answer T1
                WHERE T1.CUSTOM_DATA_ELEMENTS_ID = LI_COMPONENT_REF_ID
                AND T1.MODULE_ITEM_CODE = AV_MODULE_CODE
                AND T1.MODULE_SUB_ITEM_CODE= AV_SUBMODULE_CODE
                AND T1.MODULE_ITEM_KEY = AV_MODULE_ITEM_KEY
                AND T1.MODULE_SUB_ITEM_KEY = LI_FORM_BUILDER_SECT_COMP_ID
                AND TRIM(IFNULL(T1.VALUE, '')) <> '';
                IF LS_CUST_DATA_FLAG = 0 THEN
 
 INSERT IGNORE INTO RESULT_TABLE VALUES ('VM', LS_VALIDATION_MESSAGE, LI_FORM_BUILDER_SECT_COMP_ID, NULL);
 
    END IF;
 
                SET LS_CUST_DATA_FLAG = 0;
 
            ELSEIF LS_COMPONENT_TYPE_CODE = 'AT' THEN
                SELECT COUNT(1) INTO LS_CUST_DATA_FLAG
                FROM FB_ATTACHMENTS T1
                WHERE T1.MODULE_ITEM_CODE = AV_MODULE_CODE
                AND T1.MODULE_ITEM_KEY = AV_MODULE_ITEM_KEY
                AND T1.MODULE_SUB_ITEM_CODE = AV_SUBMODULE_CODE
                AND T1.MODULE_SUB_ITEM_KEY =  (SELECT FBSC.FORM_BUILDER_SECT_COMP_ID FROM FORM_BUILDER_SECTION_COMPONENT FBSC WHERE FBSC.COMPONENT_REF_ID = LI_COMPONENT_REF_ID);
                IF LS_CUST_DATA_FLAG = 0 THEN
 
                        INSERT IGNORE INTO RESULT_TABLE VALUES ('VM', LS_VALIDATION_MESSAGE, LI_FORM_BUILDER_SECT_COMP_ID, NULL);
 
                END IF;
 
                SET LS_CUST_DATA_FLAG = 0;
            ELSEIF LS_COMPONENT_TYPE_CODE = 'QN' THEN
                SET
                    LS_QUEST_FLAG = 'N';
                SET     
                    LI_ANS_HEADER_ID = 0;
				SELECT 
    T1.QUESTIONNAIRE_COMPLETED_FLAG,
    T1.QUESTIONNAIRE_ANS_HEADER_ID
INTO LS_QUEST_FLAG , LI_ANS_HEADER_ID FROM
    FB_QUEST_ANSWER_HEADER T1
WHERE
    T1.QUESTIONNAIRE_ID = LI_COMPONENT_REF_ID
        AND T1.MODULE_ITEM_CODE = AV_MODULE_CODE
        AND T1.MODULE_SUB_ITEM_CODE = AV_SUBMODULE_CODE
        AND T1.MODULE_ITEM_KEY = AV_MODULE_ITEM_KEY
        AND T1.MODULE_SUB_ITEM_KEY = LI_FORM_BUILDER_SECT_COMP_ID
LIMIT 1;
 
                IF IFNULL(LS_QUEST_FLAG, 'N') <> 'Y' THEN
 
                INSERT IGNORE INTO RESULT_TABLE
                    VALUES ('VM', LS_VALIDATION_MESSAGE, LI_FORM_BUILDER_SECT_COMP_ID, NULL);
                    
                OPEN QUEST_CURSOR;
                QUEST_LOOP : LOOP
                    SET DONE1 = 0;
                    FETCH QUEST_CURSOR INTO LI_QUESTION_ID,
                    LS_Q_MANDATORY_MESSAGE;
                    IF DONE1 = 1 THEN LEAVE QUEST_LOOP;
					END IF;

SELECT 
    RULE_ID
INTO LI_RULE_ID FROM
    quest_question
WHERE
    QUESTION_ID = LI_QUESTION_ID
LIMIT 1;
 
				SELECT COUNT(*) INTO LI_NUM_OPTIONS
				FROM quest_question_option
				WHERE QUESTION_ID = LI_QUESTION_ID;

				SELECT CASE
				
					WHEN (SELECT ANSWER_TYPE FROM quest_question WHERE QUESTION_ID = LI_QUESTION_ID) <> 'Table' THEN
						CASE WHEN EXISTS (
							SELECT 1
							FROM fb_quest_answer A
							WHERE A.QUESTION_ID = LI_QUESTION_ID
							  AND A.QUESTIONNAIRE_ANS_HEADER_ID = LI_ANS_HEADER_ID
						) THEN 1 ELSE 0 END

					WHEN (SELECT ANSWER_TYPE FROM quest_question WHERE QUESTION_ID = LI_QUESTION_ID) = 'Table' THEN
						CASE 
							WHEN NOT EXISTS (
								SELECT 1
								FROM fb_quest_table_answer TA
								WHERE TA.QUESTION_ID = LI_QUESTION_ID
								  AND TA.QUESTIONNAIRE_ANS_HEADER_ID = LI_ANS_HEADER_ID
							) THEN 0

							WHEN EXISTS (
								SELECT 1
								FROM fb_quest_table_answer TA
								WHERE TA.QUESTION_ID = LI_QUESTION_ID
								  AND TA.QUESTIONNAIRE_ANS_HEADER_ID = LI_ANS_HEADER_ID
								  AND (
									  ( (LENGTH(COALESCE(TRIM(COLUMN_1),''))>0) +
										(LENGTH(COALESCE(TRIM(COLUMN_2),''))>0) +
										(LENGTH(COALESCE(TRIM(COLUMN_3),''))>0) +
										(LENGTH(COALESCE(TRIM(COLUMN_4),''))>0) +
										(LENGTH(COALESCE(TRIM(COLUMN_5),''))>0) +
										(LENGTH(COALESCE(TRIM(COLUMN_6),''))>0) +
										(LENGTH(COALESCE(TRIM(COLUMN_7),''))>0) +
										(LENGTH(COALESCE(TRIM(COLUMN_8),''))>0) +
										(LENGTH(COALESCE(TRIM(COLUMN_9),''))>0) +
										(LENGTH(COALESCE(TRIM(COLUMN_10),''))>0)
									  ) < LI_NUM_OPTIONS
								  )
							) THEN 0

							ELSE 1  
						END

					ELSE 0
				END
				INTO LI_CNT;
                 IF LI_CNT = 0 THEN
			      IF LI_RULE_ID IS NOT NULL THEN
                  
				 ITERATE QUEST_LOOP;
				END IF;

                        SET IS_CHILD_QUEST = NULL;
 
						SELECT 
							PARENT_QUESTION_ID
						INTO IS_CHILD_QUEST FROM
							quest_question
						WHERE
							QUESTION_ID = LI_QUESTION_ID;
												IF IS_CHILD_QUEST IS NOT NULL THEN
                            SELECT ANSWER
                            INTO PRENT_ANSWERED
                            FROM fb_quest_answer A
                            WHERE A.QUESTION_ID = IS_CHILD_QUEST
                              AND A.QUESTIONNAIRE_ANS_HEADER_ID = LI_ANS_HEADER_ID
                            LIMIT 1;
                            
                            IF PRENT_ANSWERED IS NOT NULL THEN
                                SELECT CONDITION_TYPE, CONDITION_VALUE
                                INTO COND_TYPE, COND_VALUE
                                FROM quest_question_condition
                                WHERE QUESTION_ID = IS_CHILD_QUEST
                                LIMIT 1;
                                IF (COND_TYPE = 'EQUALS'     AND PRENT_ANSWERED = COND_VALUE)
                                OR (COND_TYPE = 'NOTEQUALS'  AND PRENT_ANSWERED <> COND_VALUE)
                                OR (COND_TYPE = 'GREATERTHAN' AND PRENT_ANSWERED > COND_VALUE)
                                OR (COND_TYPE = 'LESSTHAN'    AND PRENT_ANSWERED < COND_VALUE) THEN
                                    INSERT INTO RESULT_TABLE
                                    VALUES ('VM', LS_Q_MANDATORY_MESSAGE, LI_FORM_BUILDER_SECT_COMP_ID, LI_QUESTION_ID);
                                END IF;
                            END IF;
                        ELSE
                            INSERT INTO RESULT_TABLE
                            VALUES ('VM', LS_Q_MANDATORY_MESSAGE, LI_FORM_BUILDER_SECT_COMP_ID, LI_QUESTION_ID);
                        END IF;
                    END IF;
                END LOOP;
                CLOSE QUEST_CURSOR;
            END IF;
        END IF;
    END LOOP;
 
    CLOSE RULE_CURSOR;
 
SELECT 
    VALIDATION_TYPE,
    VALIDATION_MESSAGE,
    FORM_BUILDER_SECT_COMP_ID,
    QUESTION_ID
FROM
    RESULT_TABLE;
    DROP TEMPORARY TABLE IF EXISTS RESULT_TABLE;
 
END
