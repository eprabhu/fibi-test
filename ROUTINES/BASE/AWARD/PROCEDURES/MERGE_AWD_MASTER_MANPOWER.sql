CREATE PROCEDURE `MERGE_AWD_MASTER_MANPOWER`(
AV_AWARD_ID 			INT,
AV_AWARD_NUMBER			VARCHAR(12),
AV_SEQUENCE_NUMBER		INT(4),
AV_VARIATION_TYPE_CODE	VARCHAR(3),
AV_UPDATE_USER			VARCHAR(60)
)
BEGIN

DECLARE LS_ERROR_MSG						VARCHAR(1000);
DECLARE LS_TABLE_NAME						VARCHAR(30);
DECLARE LI_FLAG								INT;
DECLARE LI_MASTER_AWARD_ID					INT;
DECLARE LI_MASTER_SEQ_NUMBER				INT(4);

DECLARE LI_AWARD_MANPWR_NEXT_VAL			BIGINT(20);
DECLARE LI_AWARD_MANPWR_CNT					INT(10);

DECLARE LI_AWARD_MANPWR_RES_NEXT_VAL		BIGINT(20);
DECLARE LI_AWD_MANPW_RES_CNT				INT(10);


DECLARE LI_AWARD_MANPOWER_ID			INT(12);
DECLARE LS_MANPOWER_TYPE_CODE			VARCHAR(3);
DECLARE LS_BUDGET_REFERENCE_NUMBER		VARCHAR(50);
DECLARE LS_BUDGET_REFERENCE_TYPE_CODE	VARCHAR(3);
DECLARE LI_BUDGET_VERSION_NUMBER		INT(11);
DECLARE LI_APPROVED_HEADCOUNT			INT(5);
DECLARE LI_ACTUAL_HEADCOUNT				INT(5);
DECLARE LS_CREATE_USER					VARCHAR(60);
DECLARE LS_CREATE_TIMESTAMP				DATETIME;
DECLARE LS_UPDATE_USER					VARCHAR(60);
DECLARE LS_UPDATE_TIMESTAMP				DATETIME;
DECLARE LS_MODULE_CODE					INT(12);
DECLARE LS_SUB_MODULE_CODE				INT(12);

DECLARE LI_AWARD_MANPOWER_RESOURCE_ID	INT(12);
DECLARE LS_PERSON_ID					VARCHAR(40);
DECLARE LI_ROLODEX_ID					INT(11);
DECLARE LS_POSITION_ID					VARCHAR(50);
DECLARE LS_FULL_NAME					VARCHAR(90);
DECLARE LS_POSITION_STATUS_CODE			VARCHAR(3);
DECLARE LI_COST_ALLOCATION				DECIMAL(5,2);
DECLARE LS_PLAN_COMPENSATION_TYPE_CODE	VARCHAR(3);
DECLARE LS_PLAN_JOB_PROFILE_TYPE_CODE	VARCHAR(20);
DECLARE LS_COMPENSATION_GRADE_TYPE_CODE	VARCHAR(3);
DECLARE LS_JOB_PROFILE_TYPE_CODE		VARCHAR(20);
DECLARE LS_PLAN_START_DATE				DATETIME;
DECLARE LS_PLAN_END_DATE				DATETIME;
DECLARE LS_PLAN_DURATION				VARCHAR(50);
DECLARE LS_CHARGE_START_DATE			DATETIME;
DECLARE LS_CHARGE_END_DATE				DATETIME;
DECLARE LS_CHARGE_DURATION				VARCHAR(50);
DECLARE LS_COMMITTED_COST				DECIMAL(12,2);
DECLARE LS_RESOURCE_TYPE_CODE			VARCHAR(3);
DECLARE LS_DESCRIPTION					VARCHAR(4000);
DECLARE LS_POSITION_OWNED_BY_AWARD		VARCHAR(1);
DECLARE LS_CANDIDATE_TITLE_TYPE_CODE	VARCHAR(3);
DECLARE LS_POSITION_TRIGGER_DATE		DATETIME;
DECLARE LS_PLANNED_BASE_SALARY			DECIMAL(12,2);
DECLARE LS_PLANNED_SALARY				DECIMAL(12,2);
DECLARE LS_RESOURCE_UNIQUE_ID			VARCHAR(100);
DECLARE LR_AWARD_NUMBER VARCHAR(12); 
DECLARE LR_MODULE_CODE INT(12);
 DECLARE LR_SUB_MODULE_CODE INT(12); 
 DECLARE LR_FREEZE_DATE DATETIME; 
 DECLARE LR_UPGRADE_TYPE_CODE VARCHAR(3);
 DECLARE LR_MULTIPLIER_USED DECIMAL(12,2);
 DECLARE LR_PREVIOUS_CHARGE_END_DATE DATETIME;
 DECLARE LR_PREVIOUS_CHARGE_START_DATE DATETIME;
 DECLARE LR_BASE_SALARY_USED VARCHAR(200);
 DECLARE LR_IS_REMAINING_CA_FROM_WBS VARCHAR(1);
 DECLARE LR_COMMITTED_AMOUNT_USED DECIMAL(12,2);
 DECLARE LS_CPFC_AMOUNT				DECIMAL(12,2);
 DECLARE LS_CPFE_PERCENTAGE			DECIMAL(12,2);
 DECLARE LS_SDL_PERCENTAGE				DECIMAL(12,2);
 DECLARE LS_SDLC_AMOUNT				    DECIMAL(12,2);
 DECLARE LS_ONB_PERCENTAGE				DECIMAL(12,2);
 DECLARE LS_YEARLY_BENEFIT_AMOUNT		DECIMAL(12,2);
 DECLARE LS_ANNUAL_WORKING_DAYS			DECIMAL(12,2);
 DECLARE LS_PI_SUP_ORG_ID_USED			VARCHAR(20);
DECLARE LS_DOCUMENT_UPDATE_USER			VARCHAR(60);
DECLARE LS_DOCUMENT_UPDATE_TIMESTAMP	DATETIME;




	BEGIN

			DECLARE CONTINUE HANDLER FOR SQLEXCEPTION
			BEGIN

				GET DIAGNOSTICS CONDITION 1 @sqlstate = RETURNED_SQLSTATE,
				 @errno = MYSQL_ERRNO, @msg = MESSAGE_TEXT;

				SET @full_error = CONCAT("ERROR ", @errno, " (", @sqlstate, "): ", @msg);

				SELECT @full_error INTO LS_ERROR_MSG;

				INSERT INTO AWARD_ERROR_LOG(AWARD_ID, AWARD_NUMBER, SEQUENCE_NUMBER, ERROR_MESSAGE, PROCEDURE_NAME, TABLE_NAME,SECTION_CODE,VARIATION_TYPE_CODE, UPDATE_TIMESTAMP, UPDATE_USER)
				VALUES(AV_AWARD_ID,AV_AWARD_NUMBER,AV_SEQUENCE_NUMBER,LS_ERROR_MSG,'MERGE_AWD_MASTER_MANPOWER',LS_TABLE_NAME,131,AV_VARIATION_TYPE_CODE,UTC_TIMESTAMP(),AV_UPDATE_USER);
				COMMIT;


			END;

			SELECT COUNT(1) INTO LI_FLAG
			FROM AWARD
			WHERE AWARD_NUMBER = AV_AWARD_NUMBER
			AND SEQUENCE_NUMBER = 0;

			IF LI_FLAG > 0 THEN

				SELECT AWARD_ID,SEQUENCE_NUMBER
				INTO LI_MASTER_AWARD_ID,LI_MASTER_SEQ_NUMBER
				FROM AWARD
				WHERE AWARD_NUMBER = AV_AWARD_NUMBER
				AND SEQUENCE_NUMBER = 0;

			END IF;


			SELECT IFNULL(MAX(NEXT_VAL),0) INTO LI_AWARD_MANPWR_NEXT_VAL
			FROM SEQ_AWARD_MANPOWER_ID_GENERATOR;

			SELECT IFNULL(MAX(NEXT_VAL),0) INTO LI_AWARD_MANPWR_RES_NEXT_VAL
			FROM SEQ_AWARD_MANPOWER_RESOURCE_ID_GENERATOR;


			SELECT COUNT(1) INTO LI_AWARD_MANPWR_CNT
			FROM AWARD_MANPOWER
			WHERE AWARD_ID = AV_AWARD_ID;

			SELECT COUNT(1) INTO LI_AWD_MANPW_RES_CNT
			FROM AWARD_MANPOWER_RESOURCE
			WHERE AWARD_MANPOWER_ID IN(SELECT AWARD_MANPOWER_ID FROM AWARD_MANPOWER
									   WHERE AWARD_ID = AV_AWARD_ID);

			UPDATE SEQ_AWARD_MANPOWER_ID_GENERATOR
			SET NEXT_VAL = LI_AWARD_MANPWR_NEXT_VAL + LI_AWARD_MANPWR_CNT + 1;

			UPDATE SEQ_AWARD_MANPOWER_RESOURCE_ID_GENERATOR
			SET NEXT_VAL = LI_AWARD_MANPWR_RES_NEXT_VAL + LI_AWD_MANPW_RES_CNT + 1;


			-- -------------------------------STARTS INSERT INTO AWARD_MANPOWER-----------------------
			SET LS_TABLE_NAME = 'AWARD_MANPOWER';
            BEGIN

				DECLARE DONE1 INT DEFAULT FALSE;

				DECLARE CUR_AWARD_MANPWR CURSOR FOR
				SELECT
					AWARD_MANPOWER_ID,
					MANPOWER_TYPE_CODE,
					BUDGET_REFERENCE_NUMBER,
					BUDGET_REFERENCE_TYPE_CODE,
					BUDGET_VERSION_NUMBER,
					APPROVED_HEADCOUNT,
					ACTUAL_HEADCOUNT,
					CREATE_USER,
					CREATE_TIMESTAMP,
					UPDATE_USER,
					UPDATE_TIMESTAMP,
					MODULE_CODE,
					SUB_MODULE_CODE
				FROM AWARD_MANPOWER
				WHERE AWARD_ID = AV_AWARD_ID;

				DECLARE CONTINUE HANDLER FOR NOT FOUND SET DONE1 = TRUE;

				OPEN CUR_AWARD_MANPWR;
				INSERT_CUR_AWARD_MANPWR_LOOP: LOOP
				FETCH CUR_AWARD_MANPWR INTO
				LI_AWARD_MANPOWER_ID,
				LS_MANPOWER_TYPE_CODE,
				LS_BUDGET_REFERENCE_NUMBER,
				LS_BUDGET_REFERENCE_TYPE_CODE,
				LI_BUDGET_VERSION_NUMBER,
				LI_APPROVED_HEADCOUNT,
				LI_ACTUAL_HEADCOUNT,
				LS_CREATE_USER,
				LS_CREATE_TIMESTAMP,
				LS_UPDATE_USER,
				LS_UPDATE_TIMESTAMP,
				LS_MODULE_CODE,
				LS_SUB_MODULE_CODE;

				IF DONE1 THEN
					LEAVE INSERT_CUR_AWARD_MANPWR_LOOP;
				END IF;

				SET LI_AWARD_MANPWR_NEXT_VAL = LI_AWARD_MANPWR_NEXT_VAL + 1;
				INSERT INTO AWARD_MANPOWER(
				AWARD_MANPOWER_ID,
				AWARD_ID,
				AWARD_NUMBER,
				SEQUENCE_NUMBER,
				MANPOWER_TYPE_CODE,
				BUDGET_REFERENCE_NUMBER,
				BUDGET_REFERENCE_TYPE_CODE,
				BUDGET_VERSION_NUMBER,
				APPROVED_HEADCOUNT,
				ACTUAL_HEADCOUNT,
				CREATE_USER,
				CREATE_TIMESTAMP,
				UPDATE_USER,
				UPDATE_TIMESTAMP,
				MODULE_CODE,
				SUB_MODULE_CODE
				)
				VALUES
				(
				LI_AWARD_MANPWR_NEXT_VAL,
				LI_MASTER_AWARD_ID,
				AV_AWARD_NUMBER,
				LI_MASTER_SEQ_NUMBER,
				LS_MANPOWER_TYPE_CODE,
				LS_BUDGET_REFERENCE_NUMBER,
				LS_BUDGET_REFERENCE_TYPE_CODE,
				LI_BUDGET_VERSION_NUMBER,
				LI_APPROVED_HEADCOUNT,
				LI_ACTUAL_HEADCOUNT,
				LS_CREATE_USER,
				LS_CREATE_TIMESTAMP,
				LS_UPDATE_USER,
				LS_UPDATE_TIMESTAMP,
				LS_MODULE_CODE,
				LS_SUB_MODULE_CODE
				);

				-- --------------------------------STARTS INSERT INTO AWARD_MANPOWER_RESOURCE----------

				SET LS_TABLE_NAME = 'AWARD_MANPOWER_RESOURCE';

				 BEGIN

					DECLARE DONE2 INT DEFAULT FALSE;

					DECLARE CUR_AWD_MANPWR_RES CURSOR FOR
					SELECT
						PERSON_ID, ROLODEX_ID, POSITION_ID, FULL_NAME, POSITION_STATUS_CODE, COST_ALLOCATION, PLAN_COMPENSATION_TYPE_CODE, PLAN_JOB_PROFILE_TYPE_CODE, COMPENSATION_GRADE_TYPE_CODE, JOB_PROFILE_TYPE_CODE, PLAN_START_DATE, PLAN_END_DATE, PLAN_DURATION, CHARGE_START_DATE, CHARGE_END_DATE, CHARGE_DURATION, COMMITTED_COST, RESOURCE_TYPE_CODE, DESCRIPTION, POSITION_OWNED_BY_AWARD, CANDIDATE_TITLE_TYPE_CODE, POSITION_TRIGGER_DATE, PLANNED_BASE_SALARY, PLANNED_SALARY, RESOURCE_UNIQUE_ID, CREATE_USER, CREATE_TIMESTAMP, UPDATE_USER, UPDATE_TIMESTAMP,
						AWARD_NUMBER, MODULE_CODE, SUB_MODULE_CODE, FREEZE_DATE, UPGRADE_TYPE_CODE, MULTIPLIER_USED,
						PREVIOUS_CHARGE_END_DATE, PREVIOUS_CHARGE_START_DATE, BASE_SALARY_USED, IS_REMAINING_CA_FROM_WBS,CPFC_AMOUNT,CPFE_PERCENTAGE,SDL_PERCENTAGE,SDLC_AMOUNT,ONB_PERCENTAGE,YEARLY_BENEFIT_AMOUNT,ANNUAL_WORKING_DAYS,PI_SUP_ORG_ID_USED,COMMITTED_AMOUNT_USED
					FROM AWARD_MANPOWER_RESOURCE
					WHERE AWARD_MANPOWER_ID = LI_AWARD_MANPOWER_ID;

					DECLARE CONTINUE HANDLER FOR NOT FOUND SET DONE2 = TRUE;

					OPEN CUR_AWD_MANPWR_RES;
					INSERT_CUR_AWD_MANPWR_RES_LOOP: LOOP
					FETCH CUR_AWD_MANPWR_RES INTO
					LS_PERSON_ID,
					LI_ROLODEX_ID,
					LS_POSITION_ID,
					LS_FULL_NAME,
					LS_POSITION_STATUS_CODE,
					LI_COST_ALLOCATION,
					LS_PLAN_COMPENSATION_TYPE_CODE,
					LS_PLAN_JOB_PROFILE_TYPE_CODE,
					LS_COMPENSATION_GRADE_TYPE_CODE,
					LS_JOB_PROFILE_TYPE_CODE,
					LS_PLAN_START_DATE,
					LS_PLAN_END_DATE,
					LS_PLAN_DURATION,
					LS_CHARGE_START_DATE,
					LS_CHARGE_END_DATE,
					LS_CHARGE_DURATION,
					LS_COMMITTED_COST,
					LS_RESOURCE_TYPE_CODE,
					LS_DESCRIPTION,
					LS_POSITION_OWNED_BY_AWARD,
					LS_CANDIDATE_TITLE_TYPE_CODE,
					LS_POSITION_TRIGGER_DATE,
					LS_PLANNED_BASE_SALARY,
					LS_PLANNED_SALARY,
					LS_RESOURCE_UNIQUE_ID,
					LS_CREATE_USER,
					LS_CREATE_TIMESTAMP,
					LS_UPDATE_USER,
					LS_UPDATE_TIMESTAMP,
					LR_AWARD_NUMBER ,
					LR_MODULE_CODE ,
					 LR_SUB_MODULE_CODE ,
					 LR_FREEZE_DATE ,
					 LR_UPGRADE_TYPE_CODE,
					 LR_MULTIPLIER_USED ,
					 LR_PREVIOUS_CHARGE_END_DATE ,
					 LR_PREVIOUS_CHARGE_START_DATE ,
					 LR_BASE_SALARY_USED ,
					 LR_IS_REMAINING_CA_FROM_WBS,
                     LS_CPFC_AMOUNT,
                     LS_CPFE_PERCENTAGE,
                     LS_SDL_PERCENTAGE,
                     LS_SDLC_AMOUNT,
                     LS_ONB_PERCENTAGE,
                     LS_YEARLY_BENEFIT_AMOUNT,
                     LS_ANNUAL_WORKING_DAYS,
                     LS_PI_SUP_ORG_ID_USED,
                     LR_COMMITTED_AMOUNT_USED;

					IF DONE2 THEN
						LEAVE INSERT_CUR_AWD_MANPWR_RES_LOOP;
					END IF;

					SET LI_AWARD_MANPWR_RES_NEXT_VAL = LI_AWARD_MANPWR_RES_NEXT_VAL + 1;

					INSERT INTO AWARD_MANPOWER_RESOURCE
					(
					 AWARD_MANPOWER_RESOURCE_ID, AWARD_MANPOWER_ID, PERSON_ID, ROLODEX_ID, POSITION_ID, FULL_NAME, POSITION_STATUS_CODE, COST_ALLOCATION, PLAN_COMPENSATION_TYPE_CODE, PLAN_JOB_PROFILE_TYPE_CODE, COMPENSATION_GRADE_TYPE_CODE, JOB_PROFILE_TYPE_CODE, PLAN_START_DATE, PLAN_END_DATE, PLAN_DURATION, CHARGE_START_DATE, CHARGE_END_DATE, CHARGE_DURATION, COMMITTED_COST, RESOURCE_TYPE_CODE, DESCRIPTION, POSITION_OWNED_BY_AWARD, CANDIDATE_TITLE_TYPE_CODE, POSITION_TRIGGER_DATE, PLANNED_BASE_SALARY, PLANNED_SALARY, RESOURCE_UNIQUE_ID, CREATE_USER, CREATE_TIMESTAMP, UPDATE_USER, UPDATE_TIMESTAMP,
					AWARD_NUMBER, MODULE_CODE, SUB_MODULE_CODE, FREEZE_DATE, UPGRADE_TYPE_CODE, MULTIPLIER_USED,
						PREVIOUS_CHARGE_END_DATE, PREVIOUS_CHARGE_START_DATE, BASE_SALARY_USED, IS_REMAINING_CA_FROM_WBS,CPFC_AMOUNT,CPFE_PERCENTAGE,SDL_PERCENTAGE,SDLC_AMOUNT,ONB_PERCENTAGE,YEARLY_BENEFIT_AMOUNT,ANNUAL_WORKING_DAYS,PI_SUP_ORG_ID_USED,COMMITTED_AMOUNT_USED
					)
					VALUES
					(
					LI_AWARD_MANPWR_RES_NEXT_VAL,
					LI_AWARD_MANPWR_NEXT_VAL,
					LS_PERSON_ID,
					LI_ROLODEX_ID,
					LS_POSITION_ID,
					LS_FULL_NAME,
					LS_POSITION_STATUS_CODE,
					LI_COST_ALLOCATION,
					LS_PLAN_COMPENSATION_TYPE_CODE,
					LS_PLAN_JOB_PROFILE_TYPE_CODE,
					LS_COMPENSATION_GRADE_TYPE_CODE,
					LS_JOB_PROFILE_TYPE_CODE,
					LS_PLAN_START_DATE,
					LS_PLAN_END_DATE,
					LS_PLAN_DURATION,
					LS_CHARGE_START_DATE,
					LS_CHARGE_END_DATE,
					LS_CHARGE_DURATION,
					LS_COMMITTED_COST,
					LS_RESOURCE_TYPE_CODE,
					LS_DESCRIPTION,
					LS_POSITION_OWNED_BY_AWARD,
					LS_CANDIDATE_TITLE_TYPE_CODE,
					LS_POSITION_TRIGGER_DATE,
					LS_PLANNED_BASE_SALARY,
					LS_PLANNED_SALARY,
					LS_RESOURCE_UNIQUE_ID,
					LS_CREATE_USER,
					LS_CREATE_TIMESTAMP,
					LS_UPDATE_USER,
					LS_UPDATE_TIMESTAMP,
					LR_AWARD_NUMBER ,
					LR_MODULE_CODE ,
					 LR_SUB_MODULE_CODE ,
					 LR_FREEZE_DATE ,
					 LR_UPGRADE_TYPE_CODE,
					 LR_MULTIPLIER_USED ,
					 LR_PREVIOUS_CHARGE_END_DATE ,
					 LR_PREVIOUS_CHARGE_START_DATE ,
					 LR_BASE_SALARY_USED ,
					 LR_IS_REMAINING_CA_FROM_WBS,
                     LS_CPFC_AMOUNT,
                     LS_CPFE_PERCENTAGE,
                     LS_SDL_PERCENTAGE,
                     LS_SDLC_AMOUNT,
                     LS_ONB_PERCENTAGE,
                     LS_YEARLY_BENEFIT_AMOUNT,
                     LS_ANNUAL_WORKING_DAYS,
                     LS_PI_SUP_ORG_ID_USED,
                     LR_COMMITTED_AMOUNT_USED
					);
				END LOOP;
				CLOSE CUR_AWD_MANPWR_RES;
				END;
				
				
				-- --------------------------------ENDS INSERT INTO AWARD_MANPOWER_RESOURCE------------
			
				END LOOP;
				CLOSE CUR_AWARD_MANPWR;
			
			END;
			-- -------------------------------ENDS INSERT INTO AWARD_MANPOWER-------------------------
			            
			
	END;
END
