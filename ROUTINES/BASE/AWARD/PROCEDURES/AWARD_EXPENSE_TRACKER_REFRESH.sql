CREATE  PROCEDURE `AWARD_EXPENSE_TRACKER_REFRESH`(AV_FILE_ID INT)
BEGIN

	DECLARE LS_ERROR_MSG VARCHAR(4000);
	DECLARE LI_SEQ_ERROR_LOG_ID INT;
	DECLARE LS_ACCOUNT_NUMBER VARCHAR(100);
	DECLARE LS_INTERNAL_ORDER_CODE VARCHAR(50);
	DECLARE LS_DOCUMENT_NUMBER VARCHAR(100);
	DECLARE LI_ERROR_FLAG INT;
	DECLARE MSG_PREFIX VARCHAR(2000);


	DECLARE CONTINUE HANDLER FOR SQLEXCEPTION

		BEGIN

			GET DIAGNOSTICS CONDITION 1 @sqlstate = RETURNED_SQLSTATE,
			@errno = MYSQL_ERRNO, @msg = MESSAGE_TEXT;

			SET @full_error = CONCAT("ERROR ", @errno, " (", @sqlstate, "): ", @msg);

			SELECT @full_error INTO LS_ERROR_MSG;

			SELECT IFNULL(MAX(ERROR_LOG_ID),0)+1 INTO LI_SEQ_ERROR_LOG_ID FROM AWARD_EXPENSE_ERROR_LOG;
			
			ROLLBACK;
			
			INSERT INTO AWARD_EXPENSE_ERROR_LOG(ERROR_LOG_ID,ACCOUNT_NUMBER,INTERNAL_ORDER_CODE,ERROR_MESSAGE,PROCEDURE_NAME,UPDATE_TIMESTAMP, UPDATE_USER, FILE_ID, DOCUMENT_NUMBER)
			VALUES(LI_SEQ_ERROR_LOG_ID,LS_ACCOUNT_NUMBER,LS_INTERNAL_ORDER_CODE,CONCAT(MSG_PREFIX,LS_ERROR_MSG),'AWARD_EXPENSE_TRACKER_REFRESH',utc_timestamp(),'quickstart', AV_FILE_ID, LS_DOCUMENT_NUMBER);

			COMMIT;

			SET LI_ERROR_FLAG = 1;
		END;
	SET LI_ERROR_FLAG = 0;
	SET AUTOCOMMIT = 0;
	SET SQL_SAFE_UPDATES = 0;
	TRUNCATE AWARD_EXPENSE_TEMP;
	INSERT INTO AWARD_EXPENSE_TEMP (EXP_RT_ID, EXP_TRX_ID,FILE_ID,AWARD_NUMBER, ACCOUNT_NUMBER, OLD_AWARD_NUMBER)
		SELECT *, (SELECT AWARD_NUMBER from AWARD_EXPENSE_TRANSACTIONS WHERE AWARD_EXPENSE_TRANS_ID = T.AWARD_EXPENSE_TRANS_ID)  from
		((WITH temp AS 
			(SELECT AWARD_EXPENSE_TRANS_ID ,DOCUMENT_NUMBER,ITEM_NUMBER,REFERENCE_DOCUMENT_CATEGORY,REFERENCE_ORG_UNIT,ACCT_ASSIGNMENT_NUMBER,
					SCHEDULE_LINE_NUMBER,CONDITION_COUNTER,REFERENCE_PROCEDURE,DOCUMENT_NUMBER_FM_LINE_ITEM,NUMBER_OF_POST_FM_LINE_ITEM,
					COMPANY_CODE,VALUE_TYPE,AMOUNT_TYPE,FISCAL_YEAR,TRANSACTION_NUMBER, AWARD_NUMBER
			  FROM  AWARD_EXPENSE_TRANSACTIONS EXT1
			 WHERE  EXT1.DOCUMENT_NUMBER IN ( SELECT DOCUMENT_NUMBER FROM AWARD_EXPENSE_TRANSACTIONS_RT  RT1 WHERE RT1.FILE_ID = AV_FILE_ID )) 	
			SELECT  RT.EXPENSE_TRACKER_ID AS EXPENSE_TRACKER_ID,
			( SELECT EXT.AWARD_EXPENSE_TRANS_ID 
				FROM temp EXT 
				WHERE  (EXT.DOCUMENT_NUMBER = RT.DOCUMENT_NUMBER OR (EXT.DOCUMENT_NUMBER = '' AND  RT.DOCUMENT_NUMBER  = '' ) OR (EXT.DOCUMENT_NUMBER IS NULL AND  RT.DOCUMENT_NUMBER  IS NULL ))
				AND (EXT.ITEM_NUMBER = RT.ITEM_NUMBER OR (EXT.ITEM_NUMBER  = ''  AND RT.ITEM_NUMBER  = '' ) OR (EXT.ITEM_NUMBER  IS NULL  AND RT.ITEM_NUMBER  IS NULL ) )
				AND (EXT.REFERENCE_DOCUMENT_CATEGORY = RT.REFERENCE_DOCUMENT_CATEGORY OR (EXT.REFERENCE_DOCUMENT_CATEGORY  = ''  AND RT.REFERENCE_DOCUMENT_CATEGORY  = '' ) OR (EXT.REFERENCE_DOCUMENT_CATEGORY  IS NULL  AND RT.REFERENCE_DOCUMENT_CATEGORY IS NULL ) )
				AND (EXT.REFERENCE_ORG_UNIT = RT.REFERENCE_ORG_UNIT OR ( EXT.REFERENCE_ORG_UNIT  = ''  AND  RT.REFERENCE_ORG_UNIT  = '' ) OR ( EXT.REFERENCE_ORG_UNIT  IS NULL AND  RT.REFERENCE_ORG_UNIT  IS NULL ))
				AND (EXT.ACCT_ASSIGNMENT_NUMBER = RT.ACCT_ASSIGNMENT_NUMBER OR (EXT.ACCT_ASSIGNMENT_NUMBER  = ''  AND  RT.ACCT_ASSIGNMENT_NUMBER  = '' ) OR (EXT.ACCT_ASSIGNMENT_NUMBER IS NULL  AND  RT.ACCT_ASSIGNMENT_NUMBER IS NULL ))
				AND (EXT.SCHEDULE_LINE_NUMBER = RT.SCHEDULE_LINE_NUMBER OR (EXT.SCHEDULE_LINE_NUMBER  = ''  AND  RT.SCHEDULE_LINE_NUMBER  = '' ) OR (EXT.SCHEDULE_LINE_NUMBER  IS NULL  AND  RT.SCHEDULE_LINE_NUMBER  IS NULL ))
				AND (EXT.CONDITION_COUNTER = RT.CONDITION_COUNTER OR (EXT.CONDITION_COUNTER  = ''  AND  RT.CONDITION_COUNTER  = '' ) OR (EXT.CONDITION_COUNTER  IS NULL  AND  RT.CONDITION_COUNTER IS NULL ))
				AND (EXT.REFERENCE_PROCEDURE = RT.REFERENCE_PROCEDURE OR (EXT.REFERENCE_PROCEDURE  = '' AND RT.REFERENCE_PROCEDURE  = '' ) OR (EXT.REFERENCE_PROCEDURE  IS NULL AND RT.REFERENCE_PROCEDURE  IS NULL ))
				AND (EXT.DOCUMENT_NUMBER_FM_LINE_ITEM = RT.DOCUMENT_NUMBER_FM_LINE_ITEM OR ( EXT.DOCUMENT_NUMBER_FM_LINE_ITEM  = ''  AND RT.DOCUMENT_NUMBER_FM_LINE_ITEM  = '' )  OR ( EXT.DOCUMENT_NUMBER_FM_LINE_ITEM IS NULL  AND RT.DOCUMENT_NUMBER_FM_LINE_ITEM IS NULL ))
				AND (EXT.NUMBER_OF_POST_FM_LINE_ITEM = RT.NUMBER_OF_POST_FM_LINE_ITEM OR (EXT.NUMBER_OF_POST_FM_LINE_ITEM  = ''  AND RT.NUMBER_OF_POST_FM_LINE_ITEM  = '' ) OR (EXT.NUMBER_OF_POST_FM_LINE_ITEM IS NULL  AND RT.NUMBER_OF_POST_FM_LINE_ITEM IS NULL ) )
				AND (EXT.COMPANY_CODE = RT.COMPANY_CODE OR (EXT.COMPANY_CODE  = ''  AND  RT.COMPANY_CODE  = '' ) OR (EXT.COMPANY_CODE  IS NULL AND  RT.COMPANY_CODE  IS NULL ))
				AND (EXT.VALUE_TYPE = RT.VALUE_TYPE OR (EXT.VALUE_TYPE  = ''  AND RT.VALUE_TYPE  = '' ) OR (EXT.VALUE_TYPE  IS NULL  AND RT.VALUE_TYPE IS NULL ))
				AND (EXT.AMOUNT_TYPE = RT.AMOUNT_TYPE OR (EXT.AMOUNT_TYPE  = ''  AND RT.AMOUNT_TYPE  = '' ) OR (EXT.AMOUNT_TYPE  IS NULL  AND RT.AMOUNT_TYPE IS NULL ))
				AND (EXT.FISCAL_YEAR = RT.FISCAL_YEAR OR (EXT.FISCAL_YEAR  = ''  AND  RT.FISCAL_YEAR  = '' ) OR (EXT.FISCAL_YEAR IS NULL  AND  RT.FISCAL_YEAR IS NULL ))
				AND (EXT.TRANSACTION_NUMBER = RT.TRANSACTION_NUMBER OR (EXT.TRANSACTION_NUMBER  = ''  AND  RT.TRANSACTION_NUMBER   = '' ) OR (EXT.TRANSACTION_NUMBER IS NULL  AND  RT.TRANSACTION_NUMBER IS NULL ))            
			) AS AWARD_EXPENSE_TRANS_ID,
			AV_FILE_ID AS FILE_ID,
		   (SELECT AWARD_NUMBER FROM AWARD WHERE AWARD_SEQUENCE_STATUS = 'ACTIVE' AND ACCOUNT_NUMBER = SUBSTRING(RT.ACCOUNT_NUMBER, 1, 15) LIMIT 1) AS AWARD_NUMBER,
			SUBSTRING(RT.ACCOUNT_NUMBER, 1, 15) AS ACCOUNT_NUMBER
			FROM AWARD_EXPENSE_TRANSACTIONS_RT  RT WHERE FILE_ID = AV_FILE_ID)) T;

	COMMIT;

	SET MSG_PREFIX = 'BEFRORE INS ';
	INSERT INTO AWARD_EXPENSE_TRANSACTIONS
	(
			AWARD_NUMBER,
			ACCOUNT_NUMBER,
			INTERNAL_ORDER_CODE,
			REMARKS,
			AMOUNT_IN_FMA_CURRENCY,
			ACTUAL_OR_COMMITTED_FLAG,
			PO_PR_FLAG,
			BANK_CLEARING_DATE,
			FM_POSTING_DATE,
			FI_POSTING_DATE,
			VENDOR_CODE,
			VENDOR_NAME,
			DOCUMENT_DATE,
			FI_GL_ACCOUNT,
			FI_GL_DESCRIPTION,
			GR_DATE,
			INVOICE_DATE,
			PR_DATE,
			REQUESTER_NAME,
			UPDATE_TIMESTAMP,
			UPDATE_USER,
			TRANSACTION_REFERENCE_NUMBER,
			DOCUMENT_NUMBER,
			PO_DATE,
			FILE_ID,
			ITEM_NUMBER,
			REFERENCE_DOCUMENT_CATEGORY,
			REFERENCE_ORG_UNIT,
			ACCT_ASSIGNMENT_NUMBER,
			SCHEDULE_LINE_NUMBER,
			CONDITION_COUNTER,
			REFERENCE_PROCEDURE,
			DOCUMENT_NUMBER_FM_LINE_ITEM,
			NUMBER_OF_POST_FM_LINE_ITEM,
			COMPANY_CODE,
			VALUE_TYPE,
			AMOUNT_TYPE,
			FISCAL_YEAR,
			FM_AREA,
			FUND,
			FUND_CENTER,
			FUNCTIONAL_AREA,
			BATCH_ID,
			TRANSACTION_NUMBER,
			PREDECESSOR_DOC_NUMBER,
			BUDGET_CATEGORY_CODE
	)	
	(SELECT RT.AWARD_NUMBER,
			SUBSTRING(RT.ACCOUNT_NUMBER,1,15),
			RT.INTERNAL_ORDER_CODE,
			RT.REMARKS,
			RT.AMOUNT_IN_FMA_CURRENCY,
			RT.ACTUAL_OR_COMMITTED_FLAG,
			RT.PO_PR_FLAG,
			DATE_FORMAT(CASE WHEN RT.BANK_CLEARING_DATE = '' THEN NULL ELSE RT.BANK_CLEARING_DATE END,'%Y-%m-%d'),
			DATE_FORMAT(CASE WHEN RT.FM_POSTING_DATE = '' THEN NULL ELSE RT.FM_POSTING_DATE END,'%Y-%m-%d'),
			DATE_FORMAT(CASE WHEN RT.FI_POSTING_DATE = '' THEN NULL ELSE RT.FI_POSTING_DATE END,'%Y-%m-%d'),
			RT.VENDOR_CODE,
			RT.VENDOR_NAME,
			DATE_FORMAT(CASE WHEN RT.DOCUMENT_DATE = '' THEN NULL ELSE RT.DOCUMENT_DATE END,'%Y-%m-%d'), 
			RT.FI_GL_ACCOUNT,
			RT.FI_GL_DESCRIPTION,
			DATE_FORMAT(CASE WHEN RT.GR_DATE = '' THEN NULL ELSE RT.GR_DATE END,'%Y-%m-%d'), 
			DATE_FORMAT(CASE WHEN RT.INVOICE_DATE = '' THEN NULL ELSE RT.INVOICE_DATE END,'%Y-%m-%d'), 
			DATE_FORMAT(CASE WHEN RT.PR_DATE = '' THEN NULL ELSE RT.PR_DATE END,'%Y-%m-%d'), 
			RT.REQUESTER_NAME,
			utc_timestamp(),
			'quickstart',
			RT.TRANSACTION_REFERENCE_NUMBER,
			TRIM(RT.DOCUMENT_NUMBER),
			DATE_FORMAT(CASE WHEN RT.PO_DATE = '' THEN NULL ELSE RT.PO_DATE END,'%Y-%m-%d'), 
			AV_FILE_ID,
			TRIM(RT.ITEM_NUMBER),
			TRIM(RT.REFERENCE_DOCUMENT_CATEGORY),
			TRIM(RT.REFERENCE_ORG_UNIT),
			TRIM(RT.ACCT_ASSIGNMENT_NUMBER),
			TRIM(RT.SCHEDULE_LINE_NUMBER),
			TRIM(RT.CONDITION_COUNTER),
			TRIM(RT.REFERENCE_PROCEDURE),
			TRIM(RT.DOCUMENT_NUMBER_FM_LINE_ITEM),
			TRIM(RT.NUMBER_OF_POST_FM_LINE_ITEM),
			TRIM(RT.COMPANY_CODE),
			TRIM(RT.VALUE_TYPE),
			TRIM(RT.AMOUNT_TYPE),
			TRIM(RT.FISCAL_YEAR),
			RT.FM_AREA,
			RT.FUND,
			RT.FUND_CENTER,
			RT.FUNCTIONAL_AREA,
			RT.BATCH_ID,
			TRIM(RT.TRANSACTION_NUMBER),
			TRIM(RT.PREDECESSOR_DOC_NUMBER),
			SUBSTR(RT.INTERNAL_ORDER_CODE,16,3)
	FROM AWARD_EXPENSE_TRANSACTIONS_RT  RT 
	WHERE FILE_ID = AV_FILE_ID 
	  AND RT.EXPENSE_TRACKER_ID IN (SELECT EXP_RT_ID FROM AWARD_EXPENSE_TEMP WHERE EXP_TRX_ID IS NULL AND FILE_ID = AV_FILE_ID )
	);

	SET MSG_PREFIX = 'BEFRORE UPD ';
	
	UPDATE AWARD_EXPENSE_TRANSACTIONS EXT,
		 AWARD_EXPENSE_TEMP TMP,
		 AWARD_EXPENSE_TRANSACTIONS_RT RT		 
	SET EXT.AWARD_NUMBER = RT.AWARD_NUMBER,
		EXT.ACCOUNT_NUMBER = SUBSTRING(RT.ACCOUNT_NUMBER,1,15),
		EXT.INTERNAL_ORDER_CODE = RT.INTERNAL_ORDER_CODE,
		EXT.REMARKS = RT.REMARKS,
		EXT.AMOUNT_IN_FMA_CURRENCY = RT.AMOUNT_IN_FMA_CURRENCY,
		EXT.ACTUAL_OR_COMMITTED_FLAG = RT.ACTUAL_OR_COMMITTED_FLAG,
		EXT.PO_PR_FLAG = RT.PO_PR_FLAG,
		EXT.BANK_CLEARING_DATE = DATE_FORMAT(CASE WHEN RT.BANK_CLEARING_DATE = '' THEN NULL ELSE RT.BANK_CLEARING_DATE END,'%Y-%m-%d'),
		EXT.FM_POSTING_DATE = DATE_FORMAT(CASE WHEN RT.FM_POSTING_DATE = '' THEN NULL ELSE RT.FM_POSTING_DATE END,'%Y-%m-%d'),
		EXT.FI_POSTING_DATE = DATE_FORMAT(CASE WHEN RT.FI_POSTING_DATE = '' THEN NULL ELSE RT.FI_POSTING_DATE END,'%Y-%m-%d'),
		EXT.VENDOR_CODE = RT.VENDOR_CODE,
		EXT.VENDOR_NAME = RT.VENDOR_NAME,
		EXT.DOCUMENT_DATE = DATE_FORMAT(CASE WHEN RT.DOCUMENT_DATE = '' THEN NULL ELSE RT.DOCUMENT_DATE END,'%Y-%m-%d'),
		EXT.FI_GL_ACCOUNT = RT.FI_GL_ACCOUNT,
		EXT.FI_GL_DESCRIPTION = RT.FI_GL_DESCRIPTION,
		EXT.GR_DATE = DATE_FORMAT(CASE WHEN RT.GR_DATE = '' THEN NULL ELSE RT.GR_DATE END,'%Y-%m-%d'),
		EXT.INVOICE_DATE = DATE_FORMAT(CASE WHEN RT.INVOICE_DATE = '' THEN NULL ELSE RT.INVOICE_DATE END,'%Y-%m-%d'),
		EXT.PR_DATE = DATE_FORMAT(CASE WHEN RT.PR_DATE = '' THEN NULL ELSE RT.PR_DATE END,'%Y-%m-%d'),
		EXT.REQUESTER_NAME = RT.REQUESTER_NAME,
		EXT.UPDATE_TIMESTAMP = UTC_TIMESTAMP(),
		EXT.UPDATE_USER = 'quickstart',
		EXT.TRANSACTION_REFERENCE_NUMBER = RT.TRANSACTION_REFERENCE_NUMBER,
		EXT.PREDECESSOR_DOC_NUMBER = RT.PREDECESSOR_DOC_NUMBER,
		EXT.PO_DATE = DATE_FORMAT(CASE WHEN RT.PO_DATE = '' THEN NULL ELSE RT.PO_DATE END,'%Y-%m-%d'),
		EXT.FILE_ID = AV_FILE_ID,
		EXT.FM_AREA = RT.FM_AREA,
		EXT.FUND = RT.FUND,
		EXT.FUND_CENTER = RT.FUND_CENTER,
		EXT.FUNCTIONAL_AREA = RT.FUNCTIONAL_AREA,
		EXT.BATCH_ID = RT.BATCH_ID,
		EXT.BUDGET_CATEGORY_CODE = SUBSTR(RT.INTERNAL_ORDER_CODE,16,3)
	WHERE EXT.AWARD_EXPENSE_TRANS_ID = TMP.EXP_TRX_ID
	 AND  TMP.FILE_ID = AV_FILE_ID
	 AND  RT.EXPENSE_TRACKER_ID = TMP.EXP_RT_ID;
	 
	COMMIT;

	SET AUTOCOMMIT = 1;
	SET SQL_SAFE_UPDATES = 1;

END
