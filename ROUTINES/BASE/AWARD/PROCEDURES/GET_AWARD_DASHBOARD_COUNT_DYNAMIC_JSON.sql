CREATE PROCEDURE GET_AWARD_DASHBOARD_COUNT_DYNAMIC_JSON(
 
		JSON_FORMAT JSON
)
BEGIN
DECLARE LS_DYN_SQL LONGTEXT;
DECLARE LS_FILTER_CONDITION LONGTEXT;
DECLARE LS_OFFSET_CONDITION VARCHAR(600);
DECLARE LS_OFFSET INT(11);
DECLARE TAB_QUERY LONGTEXT;
DECLARE TAB_QUERY1 LONGTEXT;
DECLARE JOIN_CONDITION LONGTEXT;
DECLARE SELECTED_FIELD_LIST LONGTEXT;


DECLARE AV_AWARD_ID             VARCHAR(20);
DECLARE AV_AWARD_NUMBER         VARCHAR(20);
DECLARE AV_ACCOUNT_NUMBER       VARCHAR(200);
DECLARE AV_TITLE                VARCHAR(1000);
DECLARE AV_LEAD_UNIT_NUMBER     VARCHAR(200);
DECLARE AV_SPONSOR_CODE         VARCHAR(200);
DECLARE AV_RESEARCH_PERSON_ID   VARCHAR(200);
DECLARE AV_AWARD_STATUS         VARCHAR(200);
DECLARE AV_GRANT_HEADER_ID      VARCHAR(200);
DECLARE AV_KEYWORD              VARCHAR(200);
DECLARE AV_PERSON_ID            VARCHAR(200);
DECLARE AV_SORT_TYPE            VARCHAR(500);
DECLARE AV_PAGED                VARCHAR(30);
DECLARE AV_LIMIT                VARCHAR(30);
DECLARE AV_TAB_TYPE             VARCHAR(30);
DECLARE AV_UNLIMITED            BOOLEAN;
DECLARE AV_TYPE                 VARCHAR(1);
DECLARE AV_ROLE_ID		VARCHAR(100);
DECLARE AV_SPONSOR_AWARD_NUMBER      VARCHAR(200);
DECLARE AV_AWARD_VARIATION_TYPE_CODE  VARCHAR(200);
DECLARE AV_ACCOUNT_TYPE_CODE        VARCHAR(200);
DECLARE AV_GRANT_TYPE_CODE          VARCHAR(200);
DECLARE AV_CUSTOM_DATA_ELEMENTS_ID  VARCHAR(20);
DECLARE AV_VALUE                    varchar(4000);
DECLARE AV_FUNDING_SCHEME          VARCHAR(8);

-- CUSTOM DATA
  DECLARE LI_COUNT INT DEFAULT 0;
  DECLARE key_prefix VARCHAR(255);
   DECLARE LS_CUSTOM_DATA_CONDITION VARCHAR(1000) DEFAULT ''; 
  DECLARE LS_CLAUSE VARCHAR(10) DEFAULT ''; 
  DECLARE NOT_FOUND INT;
  DECLARE LI_CUSTOM_DATA_ELEMENTS_ID INT;
  DECLARE LI_DATA_TYPE INT;
  DECLARE LI_LOOP_COUNT INT DEFAULT 0;
  DECLARE key_prefix_COUNT VARCHAR(2000);
  DECLARE STR_LEN INT DEFAULT 0;
  DECLARE PRE_VAL VARCHAR(255);
  DECLARE key_prefix_STRING VARCHAR(2000);

  DECLARE CUSTOM_DATA_ELEMENTS_IDS CURSOR FOR
  SELECT CUSTOM_DATA_ELEMENTS_ID, DATA_TYPE FROM CUSTOM_DATA_ELEMENTS WHERE CUSTOM_DATA_ELEMENTS_ID IN
  (SELECT CUSTOM_DATA_ELEMENTS_ID FROM CUSTOM_DATA_ELEMENT_USAGE WHERE MODULE_CODE = 1
    AND IS_REQ_ADVANCE_SEARCH = 'Y');


  DECLARE CONTINUE HANDLER FOR NOT FOUND  SET NOT_FOUND =1;


SET AV_AWARD_ID = JSON_UNQUOTE(JSON_EXTRACT(JSON_FORMAT,'$.AWARD_ID'));
SET AV_AWARD_NUMBER = JSON_UNQUOTE(JSON_EXTRACT(JSON_FORMAT,'$.AWARD_NUMBER'));
SET AV_ACCOUNT_NUMBER = JSON_UNQUOTE(JSON_EXTRACT(JSON_FORMAT,'$.ACCOUNT_NUMBER'));
SET AV_TITLE = JSON_UNQUOTE(JSON_EXTRACT(JSON_FORMAT,'$.TITLE'));
SET AV_LEAD_UNIT_NUMBER = JSON_UNQUOTE(JSON_EXTRACT(JSON_FORMAT,'$.LEAD_UNIT_NUMBER'));
SET AV_SPONSOR_CODE = JSON_UNQUOTE(JSON_EXTRACT(JSON_FORMAT,'$.SPONSOR_CODE'));
SET AV_RESEARCH_PERSON_ID = JSON_UNQUOTE(JSON_EXTRACT(JSON_FORMAT,'$.RESEARCH_PERSON_ID'));
SET AV_AWARD_STATUS =  JSON_UNQUOTE(JSON_EXTRACT(JSON_FORMAT,'$.AWARD_STATUS'));
SET AV_GRANT_HEADER_ID =JSON_UNQUOTE(JSON_EXTRACT(JSON_FORMAT,'$.GRANT_HEADER_ID'));
SET AV_KEYWORD = JSON_UNQUOTE(JSON_EXTRACT(JSON_FORMAT,'$.KEYWORD'));
SET AV_PERSON_ID = JSON_UNQUOTE(JSON_EXTRACT(JSON_FORMAT,'$.PERSON_ID'));
SET AV_SORT_TYPE = JSON_UNQUOTE(JSON_EXTRACT(JSON_FORMAT,'$.SORT_TYPE'));
SET AV_PAGED = JSON_UNQUOTE(JSON_EXTRACT(JSON_FORMAT,'$.PAGED'));
SET AV_LIMIT =  JSON_UNQUOTE(JSON_EXTRACT(JSON_FORMAT,'$.LIMIT'));
SET AV_TAB_TYPE = JSON_UNQUOTE(JSON_EXTRACT(JSON_FORMAT,'$.TAB_TYPE'));
SET AV_UNLIMITED =  JSON_EXTRACT(JSON_FORMAT,'$.UNLIMITED');
SET AV_TYPE = JSON_UNQUOTE(JSON_EXTRACT(JSON_FORMAT,'$.TYPE'));
SET AV_ROLE_ID = JSON_UNQUOTE(JSON_EXTRACT(JSON_FORMAT,'$.ROLE_ID'));
SET AV_SPONSOR_AWARD_NUMBER = JSON_UNQUOTE(JSON_EXTRACT(JSON_FORMAT,'$.SPONSOR_AWARD_NUMBER'));
SET AV_AWARD_VARIATION_TYPE_CODE = JSON_UNQUOTE(JSON_EXTRACT(JSON_FORMAT,'$.AWARD_VARIATION_TYPE_CODE'));
SET AV_ACCOUNT_TYPE_CODE = JSON_UNQUOTE(JSON_EXTRACT(JSON_FORMAT,'$.ACCOUNT_TYPE_CODE'));
SET AV_GRANT_TYPE_CODE = JSON_UNQUOTE(JSON_EXTRACT(JSON_FORMAT,'$.GRANT_TYPE_CODE'));
SET AV_FUNDING_SCHEME = JSON_UNQUOTE(JSON_EXTRACT(JSON_FORMAT,'$.FUNDING_SCHEME'));

-- CUSTOM DATA
OPEN CUSTOM_DATA_ELEMENTS_IDS;
CUSTOM_DATA_ELEMENTS_IDS:LOOP

	   SET NOT_FOUND = 0;
       FETCH CUSTOM_DATA_ELEMENTS_IDS INTO LI_CUSTOM_DATA_ELEMENTS_ID,LI_DATA_TYPE;

		IF NOT_FOUND =1 THEN
	    LEAVE CUSTOM_DATA_ELEMENTS_IDS;
		END IF;

 IF LI_CUSTOM_DATA_ELEMENTS_ID IS NOT NULL THEN

	SET STR_LEN = JSON_LENGTH(JSON_FORMAT, CONCAT('$."', LI_CUSTOM_DATA_ELEMENTS_ID,'"'));
IF STR_LEN > 1 THEN
SET key_prefix = ' ';
   WHILE  LI_LOOP_COUNT < STR_LEN DO
SET KEY_PREFIX_STRING = JSON_UNQUOTE(JSON_EXTRACT(JSON_FORMAT, CONCAT('$.\"', LI_CUSTOM_DATA_ELEMENTS_ID,'\"[',LI_LOOP_COUNT,']')));
IF KEY_PREFIX_STRING IS NOT NULL THEN
 SELECT CONCAT(key_prefix,KEY_PREFIX_STRING,''',''') INTO key_prefix ;
END IF;

  SET LI_LOOP_COUNT = LI_LOOP_COUNT + 1;

  END WHILE;

SET key_prefix = LEFT(key_prefix, LENGTH(key_prefix) - 3);

  ELSE

    SET key_prefix = REPLACE(REPLACE(REPLACE(JSON_UNQUOTE(JSON_EXTRACT(JSON_FORMAT, CONCAT('$."', LI_CUSTOM_DATA_ELEMENTS_ID,'"'))), '[', ''), ']', ''),'"','');

  END IF;



 END IF;
         SET key_prefix = TRIM(key_prefix);
	 IF key_prefix IS NOT NULL  THEN
 	SET LS_CLAUSE = ' AND (';
 	IF LI_DATA_TYPE IN (1,10) THEN
	SET LS_CUSTOM_DATA_CONDITION = CONCAT( LS_CUSTOM_DATA_CONDITION,LS_CLAUSE, CONCAT(' CUST_ELEMENTS_ID_',LI_CUSTOM_DATA_ELEMENTS_ID),' LIKE ',QUOTE(CONCAT('%',key_prefix,'%')),')');
    ELSEIF LI_DATA_TYPE IN (4,8,9) THEN
    SET LS_CUSTOM_DATA_CONDITION = CONCAT( LS_CUSTOM_DATA_CONDITION,LS_CLAUSE, CONCAT(' CUST_ELEMENTS_ID_',LI_CUSTOM_DATA_ELEMENTS_ID),' IN  (''',REPLACE(key_prefix,',',','),'''))');
	ELSE
    SET LS_CUSTOM_DATA_CONDITION = CONCAT( LS_CUSTOM_DATA_CONDITION,LS_CLAUSE, CONCAT(' CUST_ELEMENTS_ID_',LI_CUSTOM_DATA_ELEMENTS_ID),' =  ''',key_prefix,''')');
    END IF;


 END IF;
   		END LOOP CUSTOM_DATA_ELEMENTS_IDS;
		CLOSE CUSTOM_DATA_ELEMENTS_IDS;


SET LS_OFFSET = (AV_LIMIT * AV_PAGED);
SET LS_FILTER_CONDITION ='';
SET LS_DYN_SQL ='';
SET JOIN_CONDITION = '';
SET SELECTED_FIELD_LIST= '';

IF AV_TYPE = 'A'   THEN

        IF AV_AWARD_ID IS NOT NULL AND AV_AWARD_ID <> '' THEN
                SET LS_FILTER_CONDITION = CONCAT(LS_FILTER_CONDITION,' T.AWARD_ID LIKE ''%',AV_AWARD_ID,'%'' AND ');
        END IF;

        IF AV_ACCOUNT_NUMBER IS NOT NULL  AND AV_ACCOUNT_NUMBER <> '' THEN
                SET LS_FILTER_CONDITION = CONCAT(LS_FILTER_CONDITION,' T.ACCOUNT_NUMBER LIKE ''%',AV_ACCOUNT_NUMBER,'%'' AND ');
        END IF;

        IF AV_TITLE IS NOT NULL  AND AV_TITLE <> '' THEN
                SET LS_FILTER_CONDITION = CONCAT(LS_FILTER_CONDITION,' T.TITLE LIKE ',QUOTE(CONCAT('%',AV_TITLE,'%')),' AND ');
        END IF;

        IF AV_LEAD_UNIT_NUMBER IS NOT NULL  AND AV_LEAD_UNIT_NUMBER <> '' THEN
                SET LS_FILTER_CONDITION = CONCAT(LS_FILTER_CONDITION,' T.LEAD_UNIT_NUMBER LIKE ''%',AV_LEAD_UNIT_NUMBER,'%'' AND ');
        END IF;

        IF AV_SPONSOR_CODE IS NOT NULL  AND AV_SPONSOR_CODE <> '' THEN
                SET LS_FILTER_CONDITION = CONCAT(LS_FILTER_CONDITION,' T.SPONSOR_CODE = ',AV_SPONSOR_CODE,' AND ');
        END IF;

         IF AV_FUNDING_SCHEME IS NOT NULL AND AV_FUNDING_SCHEME <> '' THEN 
		        SET LS_FILTER_CONDITION = CONCAT(LS_FILTER_CONDITION,' T.FUNDING_SCHEME_CODE = ',AV_FUNDING_SCHEME,' AND ');
		END IF;

        IF AV_AWARD_STATUS IS NOT NULL  AND AV_AWARD_STATUS <> '' THEN
                SET LS_FILTER_CONDITION = CONCAT(LS_FILTER_CONDITION,' T.STATUS_CODE IN (',AV_AWARD_STATUS,')  AND ');
        END IF;

        IF AV_GRANT_HEADER_ID IS NOT NULL  AND AV_GRANT_HEADER_ID <> '' THEN
                SET LS_FILTER_CONDITION = CONCAT(LS_FILTER_CONDITION,' T.GRANT_HEADER_ID IN (',AV_GRANT_HEADER_ID,') AND ');
        END IF;

        IF AV_AWARD_NUMBER IS NOT NULL  AND AV_AWARD_NUMBER <> '' THEN
                SET LS_FILTER_CONDITION = CONCAT(LS_FILTER_CONDITION,' T.AWARD_NUMBER LIKE ''%',AV_AWARD_NUMBER,'%'' AND ');
        END IF;

        IF AV_KEYWORD IS NOT NULL  AND AV_KEYWORD <> '' THEN
                 SET LS_FILTER_CONDITION = CONCAT(LS_FILTER_CONDITION,' T.KEYWORD LIKE ',QUOTE(CONCAT('%',AV_KEYWORD,'%')),' AND ');
                SET JOIN_CONDITION = CONCAT(JOIN_CONDITION,' LEFT JOIN AWARD_SCIENCE_KEYWORD T11 ON T11.AWARD_ID = T1.AWARD_ID
                        LEFT JOIN  SCIENCE_KEYWORD  T15 ON T15.SCIENCE_KEYWORD_CODE = T11.SCIENCE_KEYWORD_CODE ');
                SET SELECTED_FIELD_LIST= CONCAT(SELECTED_FIELD_LIST,' ,GROUP_CONCAT(IFNULL(T11.KEYWORD,''''),IFNULL(T15.DESCRIPTION,'''')   SEPARATOR '','')  AS KEYWORD ');
        END IF;
                        
        IF AV_ACCOUNT_TYPE_CODE IS NOT NULL  AND AV_ACCOUNT_TYPE_CODE <> '' THEN
                SET LS_FILTER_CONDITION = CONCAT(LS_FILTER_CONDITION,' T.ACCOUNT_TYPE_CODE IN (',AV_ACCOUNT_TYPE_CODE,')  AND ');
        END IF;

	IF AV_GRANT_TYPE_CODE IS NOT NULL  AND AV_GRANT_TYPE_CODE <> '' THEN
                SET LS_FILTER_CONDITION = CONCAT(LS_FILTER_CONDITION,' T.GRANT_TYPE_CODE  IN (',AV_GRANT_TYPE_CODE,')  AND ');
        END IF;                        
                        
        IF AV_AWARD_VARIATION_TYPE_CODE IS NOT NULL  AND AV_AWARD_VARIATION_TYPE_CODE <> '' THEN
                SET LS_FILTER_CONDITION = CONCAT(LS_FILTER_CONDITION,' T.AWARD_VARIATION_TYPE_CODE IN (',AV_AWARD_VARIATION_TYPE_CODE,')  AND ');
        END IF;
			
	IF (AV_ROLE_ID IS NOT NULL AND AV_ROLE_ID <> '') and (AV_RESEARCH_PERSON_ID IS NOT NULL AND AV_RESEARCH_PERSON_ID <> '') THEN
		
		SET LS_FILTER_CONDITION = CONCAT(LS_FILTER_CONDITION,' T.AWARD_ID IN (SELECT AWARD_ID 
	                FROM AWARD_PERSONS WHERE PERSON_ROLE_ID IN(
			',AV_ROLE_ID,') AND (PERSON_ID =''',AV_RESEARCH_PERSON_ID,''' OR ROLODEX_ID =''',AV_RESEARCH_PERSON_ID,''')) AND ');
        END IF;
			
	IF (AV_ROLE_ID IS NOT NULL AND AV_ROLE_ID <> '') and (AV_RESEARCH_PERSON_ID IS NULL OR AV_RESEARCH_PERSON_ID = '') THEN
		SET LS_FILTER_CONDITION = CONCAT(LS_FILTER_CONDITION,' T.AWARD_ID IN (SELECT AWARD_ID 
		        FROM AWARD_PERSONS WHERE PERSON_ROLE_ID IN(
			',AV_ROLE_ID,')) AND ');
	END IF;			
			
	IF (AV_ROLE_ID is null OR AV_ROLE_ID = '') AND (AV_RESEARCH_PERSON_ID IS NOT NULL AND AV_RESEARCH_PERSON_ID <> '') THEN
		SET LS_FILTER_CONDITION = CONCAT(LS_FILTER_CONDITION,' T.AWARD_ID IN(SELECT AWARD_ID FROM AWARD_PERSONS
			WHERE (PERSON_ID =''',AV_RESEARCH_PERSON_ID,''' OR ROLODEX_ID =''',AV_RESEARCH_PERSON_ID,''')) AND ' );
	END IF;

	IF AV_SPONSOR_AWARD_NUMBER IS NOT NULL  AND AV_SPONSOR_AWARD_NUMBER <> '' THEN
                SET LS_FILTER_CONDITION = CONCAT(LS_FILTER_CONDITION,' T.SPONSOR_AWARD_NUMBER LIKE ''%',AV_SPONSOR_AWARD_NUMBER,'%'' AND ');
	END IF;
    
    IF LS_CUSTOM_DATA_CONDITION IS NOT NULL  AND LS_CUSTOM_DATA_CONDITION <> '' THEN
 
          SET LS_FILTER_CONDITION = CONCAT(LS_FILTER_CONDITION,'   EXISTS (SELECT 1 FROM AWARD_CUSTOM_DATA_RT  WHERE AWARD_ID = T.AWARD_ID',LS_CUSTOM_DATA_CONDITION,')');
          
	END IF;

END IF;
 IF AV_TAB_TYPE = 'MY_AWARDS' THEN
	SET TAB_QUERY = CONCAT(' WHERE ((( T12.PERSON_ID = ''',AV_PERSON_ID,''' AND T12.PERSON_ROLE_ID = 3))
		AND T1.AWARD_SEQUENCE_STATUS = ''ACTIVE'' AND T4.STATUS_CODE NOT IN (11,12,5,4) )' );

ELSEIF AV_TAB_TYPE = 'ALL_AWARDS' THEN

	SET TAB_QUERY = CONCAT(' WHERE (T1.LEAD_UNIT_NUMBER IN(SELECT DISTINCT UNIT_NUMBER FROM ACCESS_TMP)
	OR T7.HOME_UNIT_NUMBER IN(SELECT DISTINCT UNIT_NUMBER FROM ACCESS_TMP_GM)
        OR(T1.LEAD_UNIT_NUMBER IN(SELECT DISTINCT UNIT_NUMBER FROM ACCESS_TMP_FOR_MODIFY_VARIATION) AND (T1.AWARD_DOCUMENT_TYPE_CODE =''3'' OR ( 0 < (select count(1) from AWARD AW WHERE AW.AWARD_NUMBER = T1.AWARD_NUMBER AND AW.AWARD_DOCUMENT_TYPE_CODE = 3 AND AW.AWARD_SEQUENCE_STATUS =''PENDING'' ))))
        OR(T7.HOME_UNIT_NUMBER IN(SELECT DISTINCT UNIT_NUMBER FROM ACCESS_TMP_GM_FOR_MODIFY_VARIATION) AND (T1.AWARD_DOCUMENT_TYPE_CODE =''3'' OR ( 0 < (select count(1) from AWARD AW WHERE AW.AWARD_NUMBER = T1.AWARD_NUMBER AND AW.AWARD_DOCUMENT_TYPE_CODE = 3 AND AW.AWARD_SEQUENCE_STATUS =''PENDING'' ))))
	OR T1.AWARD_ID IN(SELECT AWARD_ID FROM AWARD_PERSONS
		WHERE PERSON_ID=''',AV_PERSON_ID,''')
	OR (T1.AWARD_ID IN(SELECT DISTINCT S1.AWARD_ID FROM AWARD_PERSON_ROLES S1
		WHERE T1.AWARD_DOCUMENT_TYPE_CODE <> 1 AND S1.PERSON_ID=''',AV_PERSON_ID,''' AND T1.AWARD_SEQUENCE_STATUS IN (''ACTIVE'')
		UNION
		SELECT DISTINCT S2.AWARD_ID FROM AWARD_PERSON_ROLES S2 WHERE T1.AWARD_DOCUMENT_TYPE_CODE = 1 AND S2.PERSON_ID=''',AV_PERSON_ID,'''))
	OR (T1.AWARD_NUMBER IN(SELECT DISTINCT X1.AWARD_NUMBER FROM AWARD_PERSON_ROLES X1 INNER JOIN AWARD Y1 ON X1.AWARD_ID = Y1.AWARD_ID
		WHERE Y1.AWARD_DOCUMENT_TYPE_CODE <> 1 AND X1.PERSON_ID=''',AV_PERSON_ID,'''
		AND Y1.AWARD_SEQUENCE_STATUS IN (''ACTIVE''))
		AND T1.AWARD_SEQUENCE_STATUS IN (''PENDING'')
		AND T1.SEQUENCE_NUMBER > (SELECT MAX(SEQUENCE_NUMBER) FROM AWARD WHERE AWARD_NUMBER = T1.AWARD_NUMBER AND AWARD_SEQUENCE_STATUS IN (''ACTIVE''))))
	AND T1.AWARD_SEQUENCE_STATUS NOT IN (''ARCHIVE'', ''CANCELLED'')' );

ELSEIF AV_TAB_TYPE = 'PENDING_AWARDS' THEN
SET TAB_QUERY = CONCAT(' WHERE 	T4.STATUS_CODE NOT IN (11,12,5,4) AND T1.AWARD_SEQUENCE_STATUS NOT IN (''ARCHIVE'', ''CANCELLED'')
										AND (T10.APPROVER_PERSON_ID IS NOT NULL OR PR.REVIEWER_PERSON_ID IS NOT NULL)' );
		SET TAB_QUERY1 = CONCAT(' WHERE EXISTS (
												SELECT 1 FROM TASK T16 WHERE T16.MODULE_ITEM_ID = T1.AWARD_ID 
												AND T16.ASSIGNEE_PERSON_ID = ''',AV_PERSON_ID,''' AND T16.TASK_STATUS_CODE IN (1, 2, 4) AND T4.STATUS_CODE NOT IN (12, 5, 4))
										' );
ELSEIF AV_TAB_TYPE = 'DRAFT_AWARDS' THEN

        SET TAB_QUERY =  CONCAT('  WHERE  ((T1.CREATE_USER = (SELECT USER_NAME FROM PERSON WHERE PERSON_ID = ''',AV_PERSON_ID,''')
                OR (T1.LEAD_UNIT_NUMBER IN (SELECT DISTINCT UNIT_NUMBER FROM ACCESS_TMP)
                AND T1.AWARD_DOCUMENT_TYPE_CODE = 1) OR (T2.PERSON_ID = ''',AV_PERSON_ID,'''))
                AND (  T4.STATUS_CODE NOT IN (11,12,5,4) )
                AND ( T1.WORKFLOW_AWARD_STATUS_CODE NOT IN (3,5))
                AND (T1.AWARD_SEQUENCE_STATUS = ''PENDING'')  )');

ELSEIF AV_TAB_TYPE = 'HOLD_AWARDS' THEN

        SET TAB_QUERY =  CONCAT('  WHERE  ((T1.CREATE_USER = (SELECT USER_NAME FROM PERSON WHERE PERSON_ID = ''',AV_PERSON_ID,''')
                OR (T1.LEAD_UNIT_NUMBER IN (SELECT DISTINCT UNIT_NUMBER FROM ACCESS_TMP)
                ) OR (T2.PERSON_ID = ''',AV_PERSON_ID,'''))
                AND (  T4.STATUS_CODE NOT IN (11,12,5,4) )
                AND ( T1.WORKFLOW_AWARD_STATUS_CODE IN (5))
                AND (T1.AWARD_SEQUENCE_STATUS = ''PENDING'')  )');
END IF;

IF AV_SORT_TYPE IS NULL AND AV_TAB_TYPE <> 'ALL_AWARDS' THEN
        SET AV_SORT_TYPE =  CONCAT(' ORDER BY T.UPDATE_TIMESTAMP DESC ');
ELSEIF AV_SORT_TYPE IS NULL AND AV_TAB_TYPE = 'ALL_AWARDS' THEN
	SET AV_SORT_TYPE =  CONCAT(' ORDER BY T.AWARD_NUMBER ASC ');		
ELSE
        SET AV_SORT_TYPE = CONCAT(' ORDER BY ',AV_SORT_TYPE);
END IF;
 
  SET LS_OFFSET_CONDITION = '';

IF LS_FILTER_CONDITION <>'' THEN
        SET LS_FILTER_CONDITION = CONCAT(' WHERE  T.AWARD_SEQUENCE_STATUS NOT IN (''ARCHIVE'', ''CANCELLED'') AND ',LS_FILTER_CONDITION);
        SELECT TRIM(TRAILING 'AND ' FROM LS_FILTER_CONDITION) into LS_FILTER_CONDITION from dual;
END IF;


IF LS_OFFSET_CONDITION IS NULL THEN
SET LS_OFFSET_CONDITION = '';
END IF;
 

			SET LS_DYN_SQL = CONCAT('WITH ACCESS_TMP 
							AS
							(
							SELECT UNIT_NUMBER
							FROM PERSON_ROLES T1
							INNER JOIN ROLE_RIGHTS T2 ON T1.ROLE_ID = T2.ROLE_ID
							INNER JOIN RIGHTS T3 ON T2.RIGHT_ID = T3.RIGHT_ID 
							WHERE T1.DESCEND_FLAG = ''N'' AND T1.PERSON_ID = ''',AV_PERSON_ID,'''
							AND RIGHT_NAME IN (''VIEW_AWARD'', ''MODIFY_AWARD'') 							
							UNION
							SELECT CHILD_UNIT_NUMBER FROM UNIT_WITH_CHILDREN 
							WHERE UNIT_NUMBER IN (
							SELECT UNIT_NUMBER
							FROM PERSON_ROLES T1
							INNER JOIN ROLE_RIGHTS T2 ON T1.ROLE_ID = T2.ROLE_ID
							INNER JOIN RIGHTS T3 ON T2.RIGHT_ID = T3.RIGHT_ID 
							WHERE T1.DESCEND_FLAG = ''Y'' AND T1.PERSON_ID = ''',AV_PERSON_ID,'''
							AND RIGHT_NAME IN (''VIEW_AWARD'', ''MODIFY_AWARD'') 
                            )),
							ACCESS_TMP_GM 
							AS
							(
							SELECT UNIT_NUMBER
							FROM PERSON_ROLES T1
							INNER JOIN ROLE_RIGHTS T2 ON T1.ROLE_ID = T2.ROLE_ID
							INNER JOIN RIGHTS T3 ON T2.RIGHT_ID = T3.RIGHT_ID 
							WHERE T1.DESCEND_FLAG = ''N'' AND T1.PERSON_ID = ''',AV_PERSON_ID,'''
							AND RIGHT_NAME IN (''VIEW_AWARD'', ''MODIFY_AWARD'') AND T1.ROLE_ID=''100'' 							
							UNION
							SELECT CHILD_UNIT_NUMBER FROM UNIT_WITH_CHILDREN 
							WHERE UNIT_NUMBER IN (
							SELECT UNIT_NUMBER
							FROM PERSON_ROLES T1
							INNER JOIN ROLE_RIGHTS T2 ON T1.ROLE_ID = T2.ROLE_ID
							INNER JOIN RIGHTS T3 ON T2.RIGHT_ID = T3.RIGHT_ID 
							WHERE T1.DESCEND_FLAG = ''Y'' AND T1.PERSON_ID = ''',AV_PERSON_ID,'''
							AND RIGHT_NAME IN (''VIEW_AWARD'', ''MODIFY_AWARD'') AND T1.ROLE_ID=''100''
                            )),

                                                        ACCESS_TMP_FOR_MODIFY_VARIATION
							AS
							(
							SELECT UNIT_NUMBER
							FROM PERSON_ROLES T1
							INNER JOIN ROLE_RIGHTS T2 ON T1.ROLE_ID = T2.ROLE_ID
							INNER JOIN RIGHTS T3 ON T2.RIGHT_ID = T3.RIGHT_ID
							WHERE T1.DESCEND_FLAG = ''N'' AND T1.PERSON_ID = ''',AV_PERSON_ID,'''
							AND RIGHT_NAME = ''MODIFY_ALL_VARIATION_REQUESTS''
							UNION
							SELECT CHILD_UNIT_NUMBER FROM UNIT_WITH_CHILDREN
							WHERE UNIT_NUMBER IN (
							SELECT UNIT_NUMBER
							FROM PERSON_ROLES T1
							INNER JOIN ROLE_RIGHTS T2 ON T1.ROLE_ID = T2.ROLE_ID
							INNER JOIN RIGHTS T3 ON T2.RIGHT_ID = T3.RIGHT_ID
							WHERE T1.DESCEND_FLAG = ''Y'' AND T1.PERSON_ID = ''',AV_PERSON_ID,'''
							AND RIGHT_NAME = ''MODIFY_ALL_VARIATION_REQUESTS''
                            )),
                                                      ACCESS_TMP_GM_FOR_MODIFY_VARIATION
							AS
							(
							SELECT UNIT_NUMBER
							FROM PERSON_ROLES T1
							INNER JOIN ROLE_RIGHTS T2 ON T1.ROLE_ID = T2.ROLE_ID
							INNER JOIN RIGHTS T3 ON T2.RIGHT_ID = T3.RIGHT_ID
							WHERE T1.DESCEND_FLAG = ''N'' AND T1.PERSON_ID = ''',AV_PERSON_ID,'''
							AND RIGHT_NAME = ''MODIFY_ALL_VARIATION_REQUESTS'' AND T1.ROLE_ID=''100''
							UNION
							SELECT CHILD_UNIT_NUMBER FROM UNIT_WITH_CHILDREN
							WHERE UNIT_NUMBER IN (
							SELECT UNIT_NUMBER
							FROM PERSON_ROLES T1
							INNER JOIN ROLE_RIGHTS T2 ON T1.ROLE_ID = T2.ROLE_ID
							INNER JOIN RIGHTS T3 ON T2.RIGHT_ID = T3.RIGHT_ID
							WHERE T1.DESCEND_FLAG = ''Y'' AND T1.PERSON_ID = ''',AV_PERSON_ID,'''
							AND RIGHT_NAME = ''MODIFY_ALL_VARIATION_REQUESTS'' AND T1.ROLE_ID=''100''
                            ))
							');
							
        IF AV_TAB_TYPE <> 'PENDING_AWARDS' THEN
                SET LS_DYN_SQL = CONCAT(LS_DYN_SQL,'SELECT DISTINCT COUNT(*) FROM(SELECT T1.AWARD_ID,
                        T1.AWARD_NUMBER,
                        T1.ACCOUNT_NUMBER,
                        T1.TITLE,
                        T2.FULL_NAME,
                        COALESCE(T2.PERSON_ID,T2.ROLODEX_ID) AS PI_PERSON_ID,
                        T1.LEAD_UNIT_NUMBER,
                        T3.SPONSOR_CODE,
                        T3.DISPLAY_NAME AS SPONSOR_NAME,
                        T3.ACRONYM,
                        T4.DESCRIPTION AS AWARD_STATUS,
                        T1.STATUS_CODE,
                        T7.NAME as NAME,
                        T1.GRANT_HEADER_ID,
                        T1.UPDATE_TIMESTAMP,
                        T8.DISPLAY_NAME AS UNIT_NAME,
                        T1.AWARD_DOCUMENT_TYPE_CODE AS AWARD_DOCUMENT_TYPE,
                        T1.AWARD_SEQUENCE_STATUS,
                        T1.WORKFLOW_AWARD_STATUS_CODE,
                        T20.DESCRIPTION AS AWARD_TYPE,
                        T22.DESCRIPTION AS AWARD_WORKFLOW_STATUS,
                        T1.SPONSOR_AWARD_NUMBER,
                        T23.DESCRIPTION AS AWARD_VARIATION_TYPE,
                        T1.AWARD_VARIATION_TYPE_CODE,
                        T1.ACCOUNT_TYPE_CODE,
			            T24.GRANT_TYPE_CODE,
			            T1.BEGIN_DATE,
                        T1.FINAL_EXPIRATION_DATE,
                        T26.SCHEME_NAME AS FUNDING_SCHEME,
                        T26.FUNDING_SCHEME_CODE,
                        T1.SEQUENCE_NUMBER ',SELECTED_FIELD_LIST,
                                ' FROM AWARD T1
                                LEFT JOIN AWARD_PERSONS T2 ON T1.AWARD_ID=T2.AWARD_ID AND T2.PERSON_ROLE_ID = 3
                                LEFT JOIN SPONSOR T3 ON T3.SPONSOR_CODE = T1.SPONSOR_CODE
                                LEFT JOIN AWARD_STATUS T4 ON T4.STATUS_CODE = T1.STATUS_CODE
                                LEFT JOIN GRANT_CALL_HEADER T7 ON T7.GRANT_HEADER_ID = T1.GRANT_HEADER_ID
                                LEFT JOIN AWARD_TYPE T20 ON T20.AWARD_TYPE_CODE = T1.AWARD_TYPE_CODE
                                LEFT JOIN AWARD_DOCUMENT_TYPE T21 ON T21.AWARD_DOCUMENT_TYPE_CODE = T1.AWARD_DOCUMENT_TYPE_CODE
                                LEFT JOIN UNIT T8 ON T8.UNIT_NUMBER = T1.LEAD_UNIT_NUMBER
                                LEFT JOIN AWARD_WORKFLOW_STATUS T22 ON T22.WORKFLOW_AWARD_STATUS_CODE = T1.WORKFLOW_AWARD_STATUS_CODE
                                LEFT JOIN SR_TYPE T23 ON T23.TYPE_CODE = T1.AWARD_VARIATION_TYPE_CODE
                                LEFT JOIN AWARD_PERSONS T12 ON T1.AWARD_ID = T12.AWARD_ID
                                LEFT JOIN SPONSOR_FUNDING_SCHEME T25 ON T25.FUNDING_SCHEME_ID = T7.FUNDING_SCHEME_ID
                                LEFT JOIN FUNDING_SCHEME T26 ON T26.FUNDING_SCHEME_CODE = T25.FUNDING_SCHEME_CODE
				LEFT JOIN GRANT_CALL_TYPE T24 ON T24.GRANT_TYPE_CODE = T7.GRANT_TYPE_CODE ',JOIN_CONDITION,TAB_QUERY,
                                ' GROUP BY T1.AWARD_ID)T ',LS_FILTER_CONDITION,' ',AV_SORT_TYPE,' ',LS_OFFSET_CONDITION );

ELSE
SET LS_DYN_SQL = CONCAT('SELECT DISTINCT COUNT(*) FROM(SELECT T1.AWARD_ID,
T1.AWARD_NUMBER,
T1.ACCOUNT_NUMBER,
T1.TITLE,
T2.FULL_NAME,
COALESCE(T2.PERSON_ID,T2.ROLODEX_ID) AS PI_PERSON_ID,
T1.LEAD_UNIT_NUMBER,
T3.SPONSOR_CODE,
T3.DISPLAY_NAME AS SPONSOR_NAME,
T3.ACRONYM,
T4.DESCRIPTION AS AWARD_STATUS,
T1.STATUS_CODE,
T7.NAME AS NAME,
T1.GRANT_HEADER_ID,
T1.UPDATE_TIMESTAMP,
T8.DISPLAY_NAME AS UNIT_NAME,
T1.AWARD_DOCUMENT_TYPE_CODE AS AWARD_DOCUMENT_TYPE,
T1.AWARD_SEQUENCE_STATUS,
T1.WORKFLOW_AWARD_STATUS_CODE,
T20.DESCRIPTION AS AWARD_TYPE,
T22.DESCRIPTION AS AWARD_WORKFLOW_STATUS,
T1.SPONSOR_AWARD_NUMBER,
T23.DESCRIPTION AS AWARD_VARIATION_TYPE,
T1.AWARD_VARIATION_TYPE_CODE,
T1.ACCOUNT_TYPE_CODE,
T24.GRANT_TYPE_CODE,
T1.BEGIN_DATE,
T1.FINAL_EXPIRATION_DATE,
T26.SCHEME_NAME AS FUNDING_SCHEME,
T26.FUNDING_SCHEME_CODE,
T1.SEQUENCE_NUMBER ',SELECTED_FIELD_LIST,
' FROM AWARD T1
LEFT JOIN AWARD_PERSONS T2 ON T1.AWARD_ID=T2.AWARD_ID AND T2.PERSON_ROLE_ID = 3
INNER JOIN SPONSOR T3 ON T3.SPONSOR_CODE = T1.SPONSOR_CODE
INNER JOIN AWARD_STATUS T4 ON T4.STATUS_CODE = T1.STATUS_CODE
LEFT JOIN GRANT_CALL_HEADER T7 ON T7.GRANT_HEADER_ID = T1.GRANT_HEADER_ID
LEFT JOIN AWARD_TYPE T20 ON T20.AWARD_TYPE_CODE = T1.AWARD_TYPE_CODE
LEFT JOIN AWARD_DOCUMENT_TYPE T21 ON T21.AWARD_DOCUMENT_TYPE_CODE = T1.AWARD_DOCUMENT_TYPE_CODE
LEFT JOIN UNIT T8 ON T8.UNIT_NUMBER = T1.LEAD_UNIT_NUMBER
LEFT JOIN AWARD_WORKFLOW_STATUS T22 ON T22.WORKFLOW_AWARD_STATUS_CODE = T1.WORKFLOW_AWARD_STATUS_CODE
LEFT JOIN SR_TYPE T23 ON T23.TYPE_CODE = T1.AWARD_VARIATION_TYPE_CODE
LEFT JOIN SPONSOR_FUNDING_SCHEME T25 ON T25.FUNDING_SCHEME_ID = T7.FUNDING_SCHEME_ID
LEFT JOIN FUNDING_SCHEME T26 ON T26.FUNDING_SCHEME_CODE = T25.FUNDING_SCHEME_CODE
LEFT JOIN GRANT_CALL_TYPE T24 ON T24.GRANT_TYPE_CODE = T7.GRANT_TYPE_CODE
 LEFT JOIN
    PRE_REVIEW PR ON PR.MODULE_ITEM_KEY = T1.AWARD_ID
    AND PR.MODULE_ITEM_CODE = 1
    AND PR.PRE_REVIEW_STATUS_CODE = ''1''
    AND PR.PRE_REVIEW_TYPE_CODE = ''3''
    AND PR.REVIEWER_PERSON_ID = ''',AV_PERSON_ID,'''
LEFT JOIN
    WORKFLOW T9 ON T9.MODULE_ITEM_ID = T1.AWARD_ID
    AND T9.MODULE_CODE = 1
    AND T9.IS_WORKFLOW_ACTIVE = ''Y''
LEFT JOIN
    WORKFLOW_DETAIL T10 ON T9.WORKFLOW_ID = T10.WORKFLOW_ID
    AND T10.APPROVER_PERSON_ID = ''',AV_PERSON_ID,'''
    AND T10.APPROVAL_STATUS = ''W''
',JOIN_CONDITION,TAB_QUERY,
' GROUP BY T1.AWARD_ID
UNION
SELECT T1.AWARD_ID,
T1.AWARD_NUMBER,
T1.ACCOUNT_NUMBER,
T1.TITLE,
T2.FULL_NAME,
COALESCE(T2.PERSON_ID,T2.ROLODEX_ID) AS PI_PERSON_ID,
T1.LEAD_UNIT_NUMBER,
T3.SPONSOR_CODE,
T3.DISPLAY_NAME AS SPONSOR_NAME,
T3.ACRONYM,
T4.DESCRIPTION AS AWARD_STATUS,
T1.STATUS_CODE,
T7.NAME as NAME,
T1.GRANT_HEADER_ID,
T1.UPDATE_TIMESTAMP,
T8.DISPLAY_NAME AS UNIT_NAME,
T1.AWARD_DOCUMENT_TYPE_CODE AS AWARD_DOCUMENT_TYPE,
T1.AWARD_SEQUENCE_STATUS,
T1.WORKFLOW_AWARD_STATUS_CODE,
T20.DESCRIPTION AS AWARD_TYPE,
T22.DESCRIPTION AS AWARD_WORKFLOW_STATUS,
T1.SPONSOR_AWARD_NUMBER,
T23.DESCRIPTION AS AWARD_VARIATION_TYPE,
T1.AWARD_VARIATION_TYPE_CODE,
T1.ACCOUNT_TYPE_CODE,
T24.GRANT_TYPE_CODE,
T1.BEGIN_DATE,
T1.FINAL_EXPIRATION_DATE,
T26.SCHEME_NAME AS FUNDING_SCHEME,
T26.FUNDING_SCHEME_CODE,
T1.SEQUENCE_NUMBER ',SELECTED_FIELD_LIST,
' FROM AWARD T1
LEFT JOIN AWARD_PERSONS T2 ON T1.AWARD_ID=T2.AWARD_ID AND T2.PERSON_ROLE_ID = 3
INNER JOIN SPONSOR T3 ON T3.SPONSOR_CODE = T1.SPONSOR_CODE
INNER JOIN AWARD_STATUS T4 ON T4.STATUS_CODE = T1.STATUS_CODE
LEFT JOIN GRANT_CALL_HEADER T7 ON T7.GRANT_HEADER_ID = T1.GRANT_HEADER_ID
LEFT JOIN AWARD_TYPE T20 ON T20.AWARD_TYPE_CODE = T1.AWARD_TYPE_CODE
LEFT JOIN AWARD_DOCUMENT_TYPE T21 ON T21.AWARD_DOCUMENT_TYPE_CODE = T1.AWARD_DOCUMENT_TYPE_CODE
LEFT JOIN UNIT T8 ON T8.UNIT_NUMBER = T1.LEAD_UNIT_NUMBER
LEFT JOIN AWARD_WORKFLOW_STATUS T22 ON T22.WORKFLOW_AWARD_STATUS_CODE = T1.WORKFLOW_AWARD_STATUS_CODE
LEFT JOIN SR_TYPE T23 ON T23.TYPE_CODE = T1.AWARD_VARIATION_TYPE_CODE
LEFT JOIN SPONSOR_FUNDING_SCHEME T25 ON T25.FUNDING_SCHEME_ID = T7.FUNDING_SCHEME_ID
LEFT JOIN FUNDING_SCHEME T26 ON T26.FUNDING_SCHEME_CODE = T25.FUNDING_SCHEME_CODE
LEFT JOIN GRANT_CALL_TYPE T24 ON T24.GRANT_TYPE_CODE = T7.GRANT_TYPE_CODE ',JOIN_CONDITION,TAB_QUERY1,
' GROUP BY T1.AWARD_ID
)T ',LS_FILTER_CONDITION,' ',AV_SORT_TYPE,' ',LS_OFFSET_CONDITION );
END IF;
 SET @QUERY_STATEMENT = LS_DYN_SQL;
PREPARE EXECUTABLE_STAEMENT FROM @QUERY_STATEMENT;
EXECUTE EXECUTABLE_STAEMENT; 
 
END;
