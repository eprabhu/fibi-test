-- `FN_CHECK_IS_ELIGIBLE_TO_SYNC_TO_ORCID`; 


CREATE FUNCTION `FN_CHECK_IS_ELIGIBLE_TO_SYNC_TO_ORCID`(AV_AWARD_ID INT, AV_DOCUMENT_TYPE_CODE VARCHAR(2),
    AV_SERVICE_TYPE_CODE VARCHAR(2)) RETURNS varchar(5) 
    DETERMINISTIC
BEGIN
    DECLARE LI_ACCOUNT_NUMBER INT;
    DECLARE LS_DISPLAY_AT_ACAD_PROFILE VARCHAR(3);
    DECLARE LI_PERSON_ID INT;
    DECLARE LI_IS_VALID_AWARD_VERSION_TYPE INT;
    SELECT COUNT(*)
    INTO LI_ACCOUNT_NUMBER
    FROM AWARD A
    WHERE A.AWARD_ID = AV_AWARD_ID 
      AND A.ACCOUNT_NUMBER IS NOT NULL 
      AND A.ACCOUNT_NUMBER <> '';
    SELECT COALESCE(CD.DESCRIPTION, CD.VALUE)
    INTO LS_DISPLAY_AT_ACAD_PROFILE
    FROM CUSTOM_DATA CD
    WHERE CD.MODULE_ITEM_CODE = 1
      AND CD.CUSTOM_DATA_ELEMENTS_ID = (
          SELECT MAX(CDE.CUSTOM_DATA_ELEMENTS_ID)
          FROM CUSTOM_DATA_ELEMENTS CDE
          WHERE CDE.CUSTOM_ELEMENT_NAME = 'Display at Acad Profile?' 
            AND CDE.IS_ACTIVE = 'Y'
      )
      AND CD.MODULE_ITEM_KEY = AV_AWARD_ID;
    SELECT COUNT(*)
    INTO LI_PERSON_ID
    FROM AWARD_PERSONS AP
    WHERE AP.AWARD_ID = AV_AWARD_ID 
      AND AP.PI_FLAG = 'Y' 
      AND AP.PERSON_ID IS NOT NULL 
      AND AP.PERSON_ID <> '';
    IF AV_DOCUMENT_TYPE_CODE IS NOT NULL AND AV_DOCUMENT_TYPE_CODE != '' AND AV_DOCUMENT_TYPE_CODE = '1' THEN 
        SET LI_IS_VALID_AWARD_VERSION_TYPE = 1;
    ELSEIF AV_SERVICE_TYPE_CODE IS NOT NULL AND AV_SERVICE_TYPE_CODE != '' AND AV_SERVICE_TYPE_CODE IN ('1', '3', '6', '16') THEN
        SET LI_IS_VALID_AWARD_VERSION_TYPE = 1;
    ELSE
        SET LI_IS_VALID_AWARD_VERSION_TYPE = 0;
    END IF;
    RETURN IF(LI_ACCOUNT_NUMBER > 0 
              AND UPPER(LS_DISPLAY_AT_ACAD_PROFILE) = 'YES' 
              AND LI_PERSON_ID > 0
              AND LI_IS_VALID_AWARD_VERSION_TYPE = 1, 
              'TRUE', 
              'FALSE');
END
