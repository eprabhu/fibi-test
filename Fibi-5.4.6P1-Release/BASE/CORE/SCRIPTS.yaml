databaseChangeLog:
  - changeSet:
        id: FIBI-7786-1
        author: Prabhu.E
        labels: 'DML'
        comment: 
        changes:
          - sql:
              sql: | 
                  SET SQL_SAFE_UPDATES = 0;
                  UPDATE `quest_column_nextvalue`
                  SET 
                    `QUESTIONNAIRE_ID` = (SELECT IFNULL(MAX(QUESTIONNAIRE_ID), 0) + 1 FROM QUEST_HEADER),
                    `QUESTIONNAIRE_NUMBER` = (SELECT IFNULL(MAX(QUESTIONNAIRE_NUMBER), 0) + 1 FROM QUEST_HEADER),
                    `QUESTION_ID` = (SELECT IFNULL(MAX(QUESTION_ID), 0) + 1 FROM quest_question),
                    `QUESTION_NUMBER` = (SELECT IFNULL(MAX(QUESTION_NUMBER), 0) + 1 FROM quest_question),
                    `QUESTION_CONDITION_ID` = (SELECT IFNULL(MAX(QUESTION_CONDITION_ID), 0) + 1 FROM quest_question_condition),
                    `QUESTION_OPTION_ID` = (SELECT IFNULL(MAX(QUESTION_OPTION_ID), 0) + 1 FROM quest_question_option),
                    `QUESTIONNAIRE_ANS_HEADER_ID` = (SELECT IFNULL(MAX(QUESTIONNAIRE_ANS_HEADER_ID), 0) + 1 FROM quest_answer_header),
                    `QUESTIONNAIRE_ANSWER_ID` = (SELECT IFNULL(MAX(QUESTIONNAIRE_ANSWER_ID), 0) + 1 FROM quest_answer),
                    `QUESTIONNAIRE_ANSWER_ATT_ID` = (SELECT IFNULL(MAX(QUESTIONNAIRE_ANSWER_ATT_ID), 0) + 1 FROM quest_answer_attachment),
                    `QUESTIONNAIRE_USAGE_ID` = (SELECT IFNULL(MAX(QUESTIONNAIRE_USAGE_ID), 0) + 1 FROM quest_usage),
                    `QUESTIONNAIRE_ANSWER_TABLE_ID` = (SELECT IFNULL(MAX(QUEST_TABLE_ANSWER_ID), 0) + 1 FROM quest_table_answer);
                  SET SQL_SAFE_UPDATES = 1;
        rollback: empty

  - changeSet:
        id: FIBI-7656-1
        author: Manesh.MS
        labels: 'DDL'
        comment: Alter script for table PERSON_TRAINING
        changes:
          - sql:
              sql: |
                  Analyze table PERSON_TRAINING;

                  SET @sql := IF(
                      (SELECT COUNT(*) FROM INFORMATION_SCHEMA.COLUMNS
                      WHERE TABLE_SCHEMA = DATABASE() AND TABLE_NAME = 'PERSON_TRAINING' AND COLUMN_NAME = 'TRAINING_NUMBER') = 1,
                      'ALTER TABLE PERSON_TRAINING CHANGE COLUMN `TRAINING_NUMBER` `TRAINING_NUMBER` INT NULL;',
                      'DO 1'
                  );
                  PREPARE stmt FROM @sql;
                  EXECUTE stmt;
                  DEALLOCATE PREPARE stmt;

        rollback: empty