-- `GET_RESEARCHER_PUBLICATION`; 

CREATE PROCEDURE `GET_RESEARCHER_PUBLICATION`(
    AV_PERSON_ID            VARCHAR(40)
)
BEGIN
	SELECT RESEARCHER_PUBLICATION_EXT_ID,
	PUBLICATION_TYPE_ID,
	PERSON_ID,
	PUBLICATION_TYPE_CODE,
	IFNULL(ORCID.TITLE ,RESEARCHER.TITLE) AS TITLE,
	IFNULL(RESEARCHER.CO_AUTHORSHIP, GROUP_CONCAT(distinct CONTRIBUTOR.CREDIT_NAME SEPARATOR " , ")) AS CONTRIBUTOR_NAME,
	 IFNULL(
			researcher.PUBLICATION_DATE, 
			IF(orcid.PUBLICATION_MONTH REGEXP '^[0-9]+$',
				STR_TO_DATE(
					CONCAT(orcid.PUBLICATION_YEAR,'-',LPAD(orcid.PUBLICATION_MONTH, 2, '0'), '-', orcid.PUBLICATION_DAY
					),'%Y-%m-%d'),
				STR_TO_DATE(
					CONCAT(orcid.PUBLICATION_DAY,', ', orcid.PUBLICATION_MONTH,', ', orcid.PUBLICATION_YEAR),
					'%d, %M, %Y')
			)
		) AS PUBLICATION_DATE,
	IFNULL(RESEARCHER.RELEVANT_URL,ORCID.URL) AS RELEVANT_URL,
	EXT.QUICK_URL,
	IFNULL(ORCID.PUT_CODE ,RESEARCHER.RESEARCHER_PUBLICATION_ID) AS PUBLICATION_ID,
	IFNULL(ORCID.ORCID_WORK_TYPE_CODE ,RESEARCHER.ORCID_WORK_TYPE_CODE) AS ORCID_WORK_TYPE_CODE,
	IFNULL(ORCID.ORCID_WORK_CATEGORY_CODE ,RESEARCHER.ORCID_WORK_CATEGORY_CODE) AS ORCID_WORK_CATEGORY_CODE,
	IFNULL(ORCID.JOURNAL_TITLE ,RESEARCHER.JOURNAL_TITLE) AS JOURNAL_TITLE,
	EXT.SORT_ORDER
	FROM PUBLICATION_EXT EXT
	LEFT JOIN ORCID_WORK ORCID ON EXT.PUBLICATION_TYPE_ID = ORCID.PUT_CODE AND EXT.PUBLICATION_TYPE_CODE= 1
	LEFT JOIN ORCID_WORK_CONTRIBUTOR CONTRIBUTOR ON ORCID.PUT_CODE = CONTRIBUTOR.PUT_CODE
	LEFT JOIN  RESEARCHER_PUBLICATION RESEARCHER ON EXT.PUBLICATION_TYPE_ID = RESEARCHER.RESEARCHER_PUBLICATION_ID AND EXT.PUBLICATION_TYPE_CODE= 2
	LEFT JOIN PUBLICATION_EXTERNAL_IDENTIFIER  RESEARCHER_IDENTIFIER ON  RESEARCHER.RESEARCHER_PUBLICATION_ID = RESEARCHER_IDENTIFIER.RESEARCHER_PUBLICATION_ID
	LEFT JOIN ORCID_WORK_EXTERNAL_IDENTIFIER  ORCID_IDENTIFIER ON  ORCID.PUT_CODE = ORCID_IDENTIFIER.PUT_CODE
	WHERE EXT.PERSON_ID = AV_PERSON_ID AND EXT.STATUS = 'A'
	GROUP BY RESEARCHER_PUBLICATION_EXT_ID ORDER BY  EXT.SORT_ORDER DESC, PUBLICATION_DATE DESC,EXT.UPDATE_TIMESTAMP DESC;
END
