CREATE PROCEDURE GET_AGREEMENT_COUNT_BY_STATUS_DETAIL(
AV_PERSON_ID VARCHAR(40),
AV_UNIT_NUMBER VARCHAR(10),
AV_STATUS_CODE VARCHAR(2),
AV_DESCENT_FLAG VARCHAR(1),
AV_SORT_TYPE VARCHAR(255),
AV_PAGED INT,
AV_LIMIT INT,
AV_UNLIMITED VARCHAR(1)
)
BEGIN

DECLARE LS_DYN_SQL LONGTEXT DEFAULT '';
DECLARE LS_UNIT_NUMBER_CONDITION LONGTEXT;
DECLARE LS_CHILD_UNIT_CONDITION LONGTEXT DEFAULT '';
DECLARE LS_PRINCIPAL_INVESTIGATOR 	LONGTEXT;
DECLARE LS_SPONSOR 	LONGTEXT;
DECLARE LS_OFFSET INT;
DECLARE LS_SORT_TYPE VARCHAR(1000);
DECLARE LS_OFFSET_CONDITION VARCHAR(600);

DECLARE LS_DYN_CUST_DATA_PARAM LONGTEXT DEFAULT '';
DECLARE LS_DYN_CUST_DATA_ELEMENTS LONGTEXT DEFAULT '';
DECLARE LS_FIELD_HEADER LONGTEXT;

DECLARE done INT DEFAULT 0;
DECLARE LS_CUST_ELE_ID INT;
DECLARE LI_CUST_ORDER INT;
DECLARE LS_CUST_LABEL VARCHAR(60);
DECLARE LS_CUST_DATA_TYPE_CODE VARCHAR(3);
DECLARE LJ_CUST_DATA_HEADER_JSON JSON DEFAULT JSON_OBJECT();
DECLARE LJ_HEADER_JSON JSON ;

DECLARE CUSTOR_DATA_HEADER_CUR CURSOR FOR 
SELECT CDE.CUSTOM_DATA_ELEMENTS_ID, CDE.COLUMN_LABEL, CDEU.ORDER_NUMBER, CDE.DATA_TYPE FROM CUSTOM_DATA_ELEMENTS CDE
INNER JOIN CUSTOM_DATA_ELEMENT_USAGE CDEU ON CDEU.CUSTOM_DATA_ELEMENTS_ID = CDE.CUSTOM_DATA_ELEMENTS_ID
WHERE CDEU.MODULE_CODE = 13 AND CDE.IS_ACTIVE = 'Y' AND CDEU.IS_REQ_ADVANCE_SEARCH = 'Y';

DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = 1;

OPEN CUSTOR_DATA_HEADER_CUR;
	CUST_LOOP: LOOP
		FETCH CUSTOR_DATA_HEADER_CUR INTO LS_CUST_ELE_ID, LS_CUST_LABEL, LI_CUST_ORDER, LS_CUST_DATA_TYPE_CODE;
        IF done THEN
            LEAVE CUST_LOOP;
        END IF; 
        SET LS_CUST_LABEL = REPLACE(LS_CUST_LABEL, "'", "''");
        SET LS_DYN_CUST_DATA_PARAM = CONCAT(LS_DYN_CUST_DATA_PARAM,',','''','CUST_ELEMENTS_ID_',LS_CUST_ELE_ID,'''',',','T.CUST_ELEMENTS_ID_',LS_CUST_ELE_ID);
        SET LS_DYN_CUST_DATA_ELEMENTS = CONCAT(LS_DYN_CUST_DATA_ELEMENTS,',','CD.CUST_ELEMENTS_ID_',LS_CUST_ELE_ID);
        SET LJ_CUST_DATA_HEADER_JSON = JSON_SET(LJ_CUST_DATA_HEADER_JSON, CONCAT('$.', CONCAT('CUST_ELEMENTS_ID_',LS_CUST_ELE_ID)),
        JSON_OBJECT('label',LS_CUST_LABEL, 'sortOrder', LI_CUST_ORDER,'sortIcon',IF(LS_CUST_DATA_TYPE_CODE = 2, 'NUM', 'STR'), 'colWidth', '15rem')
        );
    END LOOP CUST_LOOP;
CLOSE CUSTOR_DATA_HEADER_CUR;

SET LS_OFFSET = (AV_LIMIT * AV_PAGED);

	IF AV_UNLIMITED = 'Y' THEN 
			SET LS_OFFSET_CONDITION = '';
	ELSE
			SET LS_OFFSET_CONDITION = CONCAT(' LIMIT ',AV_LIMIT,' OFFSET ',LS_OFFSET);
	END IF;

	IF AV_SORT_TYPE = '' THEN 
		SET LS_SORT_TYPE = CONCAT(' ORDER BY UPDATE_TIMESTAMP DESC ');
	ELSE 
		SET LS_SORT_TYPE = CONCAT(' ORDER BY ',AV_SORT_TYPE);
	END IF;


    IF AV_UNIT_NUMBER IS NULL OR AV_UNIT_NUMBER = '' THEN 
        SET LS_UNIT_NUMBER_CONDITION = 'NULL';
    ELSE
        SET LS_UNIT_NUMBER_CONDITION = CONCAT("'", AV_UNIT_NUMBER, "'");
		IF AV_DESCENT_FLAG = 'Y' THEN 
	       SET LS_CHILD_UNIT_CONDITION = CONCAT(' OR T1.UNIT_NUMBER IN (SELECT CHILD_UNIT_NUMBER FROM UNIT_WITH_CHILDREN WHERE UNIT_NUMBER = ',LS_UNIT_NUMBER_CONDITION,')');	
        END IF;
    END IF;

SET LS_PRINCIPAL_INVESTIGATOR = ',(SELECT FULL_NAME FROM AGREEMENT_PEOPLE WHERE 
AGREEMENT_REQUEST_ID = T1.AGREEMENT_REQUEST_ID AND AGREEMENT_PEOPLE_ID =
(select max(AGREEMENT_PEOPLE_ID) FROM AGREEMENT_PEOPLE WHERE AGREEMENT_REQUEST_ID = T1.AGREEMENT_REQUEST_ID AND PEOPLE_TYPE_ID = 3)) AS PRINCIPAL_INVESTIGATOR';

SET LS_SPONSOR = ',(SELECT T1.DISPLAY_NAME FROM SPONSOR T1 
INNER JOIN AGREEMENT_SPONSOR T2 ON T1.SPONSOR_CODE = T2.SPONSOR_CODE WHERE 
AGREEMENT_REQUEST_ID = T1.AGREEMENT_REQUEST_ID AND AGREEMENT_SPONSOR_ID =
(select max(AGREEMENT_SPONSOR_ID) FROM AGREEMENT_SPONSOR WHERE AGREEMENT_REQUEST_ID = T1.AGREEMENT_REQUEST_ID AND AGREEMENT_SPONSOR_TYPE_CODE = 1)) AS SPONSOR';

    SELECT JSON_OBJECT(
        'AGREEMENT_REQUEST_ID', JSON_OBJECT('label', 'Agreement #', 'sortOrder',  1, 'sortIcon','NUM', 'colWidth', '12rem'),
        'TITLE', JSON_OBJECT('label', 'Research Title', 'sortOrder', 4, 'sortIcon', 'STR', 'colWidth', '35rem'),
        'UNIT', JSON_OBJECT('label','Lead Unit', 'sortOrder', 5, 'sortIcon', 'STR', 'colWidth', '20rem' ),
        'CATEGORY', JSON_OBJECT('label', 'Category', 'sortOrder', 3, 'sortIcon', 'STR', 'colWidth', '15rem'),
        'TYPE_OF_AGREEMENT', JSON_OBJECT('label', 'Type', 'sortOrder', 2, 'sortIcon', 'STR', 'colWidth', '15rem'),
        'SPONSOR', JSON_OBJECT('label', 'Sponsor/Organization', 'sortOrder', 6, 'sortIcon', 'STR', 'colWidth', '20rem' ),
        'ADMINISTRATOR', JSON_OBJECT('label', 'Administrator', 'sortOrder', 7,'sortIcon', 'STR', 'colWidth', '20rem' ),
        'REQUESTOR', JSON_OBJECT('label', 'Requestor', 'sortOrder', 8, 'sortIcon', 'STR', 'colWidth', '20rem' ),
        'ADMIN_GROUP_NAME', JSON_OBJECT('label', 'Admin Group', 'sortOrder',  9, 'sortIcon', 'STR', 'colWidth', '20rem' ),
        'PRINCIPAL_INVESTIGATOR', JSON_OBJECT('label', 'Principal Investigator', 'sortOrder', 10, 'sortIcon', 'STR', 'colWidth', '20rem'),
        'STATUS', JSON_OBJECT('label', 'Status', 'sortOrder', 11, 'sortIcon', 'STR', 'colWidth', '15rem')
    ) INTO LS_FIELD_HEADER;


SELECT JSON_MERGE_PATCH(LS_FIELD_HEADER,LJ_CUST_DATA_HEADER_JSON) INTO LJ_HEADER_JSON;

   SET LS_DYN_SQL = CONCAT('
    WITH ACCESS_TMP_ADMIN 
							AS
							(
							SELECT UNIT_NUMBER
							FROM PERSON_ROLES T1
							INNER JOIN ROLE_RIGHTS T2 ON T1.ROLE_ID = T2.ROLE_ID
							INNER JOIN RIGHTS T3 ON T2.RIGHT_ID = T3.RIGHT_ID 
							WHERE T1.DESCEND_FLAG = ''N'' AND T1.PERSON_ID = ''',AV_PERSON_ID,'''
							AND RIGHT_NAME IN (''AGREEMENT_ADMINISTRATOR'',''VIEW_ALL_AGREEMENT'',''MODIFY_ALL_AGREEMENT'',''VIEW_ADMIN_GROUP_AGREEMENT'') 							
							UNION
							SELECT CHILD_UNIT_NUMBER FROM UNIT_WITH_CHILDREN 
							WHERE UNIT_NUMBER IN (
							SELECT UNIT_NUMBER
							FROM PERSON_ROLES T1
							INNER JOIN ROLE_RIGHTS T2 ON T1.ROLE_ID = T2.ROLE_ID
							INNER JOIN RIGHTS T3 ON T2.RIGHT_ID = T3.RIGHT_ID 
							WHERE T1.DESCEND_FLAG = ''Y'' AND T1.PERSON_ID = ''',AV_PERSON_ID,'''
							AND RIGHT_NAME IN (''AGREEMENT_ADMINISTRATOR'',''VIEW_ALL_AGREEMENT'',''MODIFY_ALL_AGREEMENT'',''VIEW_ADMIN_GROUP_AGREEMENT'') 
                            ))

          SELECT 
                 JSON_OBJECT( 
        ''HEADERS'' ,  ''',LJ_HEADER_JSON,''',
        ''DASHBOARD_DETAILS'', JSON_ARRAYAGG(
                JSON_OBJECT(
                    ''AGREEMENT_REQUEST_ID'', T.AGREEMENT_REQUEST_ID,
                    ''TITLE'', T.TITLE,
                    ''UNIT'', T.UNIT,
                    ''CATEGORY'', T.CATEGORY,
                    ''TYPE_OF_AGREEMENT'', T.TYPE_OF_AGREEMENT,
                    ''SPONSOR'', T.SPONSOR,
                    ''ADMINISTRATOR'', T.ADMINISTRATOR,
                    ''REQUESTOR'', T.REQUESTOR,
                    ''ADMIN_GROUP_NAME'', T.ADMIN_GROUP_NAME,
                    ''PRINCIPAL_INVESTIGATOR'', T.PRINCIPAL_INVESTIGATOR,
                    ''STATUS'', T.STATUS
                    ');
        
        IF LS_DYN_CUST_DATA_PARAM IS NOT NULL THEN
         SET LS_DYN_SQL = CONCAT(LS_DYN_SQL,LS_DYN_CUST_DATA_PARAM);
        END IF;
        
SET LS_DYN_SQL = CONCAT(LS_DYN_SQL,'
	))) as widget_data
           FROM ( SELECT
                                        DISTINCT T1.AGREEMENT_REQUEST_ID,
										T1.TITLE,
										T5.DISPLAY_NAME AS UNIT,
										T3.DESCRIPTION AS CATEGORY,
										T4.DESCRIPTION AS TYPE_OF_AGREEMENT',
										LS_SPONSOR,',
										T1.ADMIN_PERSON_NAME AS ADMINISTRATOR,
										T1.REQUESTOR_NAME AS REQUESTOR',
										LS_PRINCIPAL_INVESTIGATOR,',
										T2.DESCRIPTION AS STATUS,
										T1.CREATE_TIMESTAMP,
                                        T1.UPDATE_TIMESTAMP,
                                        T50.ADMIN_GROUP_NAME
                                        ');
        
        IF LS_DYN_CUST_DATA_ELEMENTS IS NOT NULL THEN
         SET LS_DYN_SQL = CONCAT(LS_DYN_SQL,LS_DYN_CUST_DATA_ELEMENTS);
        END IF;
        
SET LS_DYN_SQL = CONCAT(LS_DYN_SQL,'
                                         
            FROM AGREEMENT_HEADER T1
            LEFT JOIN AGREEMENT_CUSTOM_DATA_RT CD ON CD.AGREEMENT_REQUEST_ID = T1.AGREEMENT_REQUEST_ID
            INNER JOIN AGREEMENT_STATUS T2 ON T2.AGREEMENT_STATUS_CODE = T1.AGREEMENT_STATUS_CODE
                                    LEFT JOIN UNIT T5 ON T1.UNIT_NUMBER = T5.UNIT_NUMBER
									LEFT JOIN AGREEMENT_PEOPLE T6 ON T6.AGREEMENT_REQUEST_ID = T1.AGREEMENT_REQUEST_ID
                                    LEFT JOIN AGREEMENT_TYPE T4 ON T4.AGREEMENT_TYPE_CODE = T1.AGREEMENT_TYPE_CODE
                                    LEFT JOIN AGREEMENT_SPONSOR T20 ON T20.AGREEMENT_REQUEST_ID = T1.AGREEMENT_REQUEST_ID
                                    LEFT JOIN AGREEMENT_CATEGORY T3 ON T1.CATEGORY_CODE = T3.CATEGORY_CODE
            LEFT JOIN ADMIN_GROUP T50 ON T1.ADMIN_GROUP_ID = T50.ADMIN_GROUP_ID
            INNER JOIN NEGOTIATION_ASSOCIATION S0 ON T1.AGREEMENT_REQUEST_ID = S0.ASSOCIATED_PROJECT_ID AND S0.ASSOCIATION_TYPE_CODE = 4
            WHERE T1.AGREEMENT_SEQUENCE_STATUS <> ''TEMPLATE'' AND (T1.IS_HOLD = ''N'' OR T1.IS_HOLD IS NULL)
               AND T1.AGREEMENT_STATUS_CODE = ''',AV_STATUS_CODE,'''
               AND  (((', LS_UNIT_NUMBER_CONDITION, ' IS NULL OR T1.UNIT_NUMBER = ', LS_UNIT_NUMBER_CONDITION, LS_CHILD_UNIT_CONDITION, ')
             )
             AND (
                  T1.AGREEMENT_REQUEST_ID IN (
                      SELECT R1.AGREEMENT_REQUEST_ID 
                      FROM AGREEMENT_PEOPLE_ROLES R1
                      INNER JOIN ROLE_RIGHTS R2 ON R1.ROLE_ID = R2.ROLE_ID
                      INNER JOIN RIGHTS R3 ON R2.RIGHT_ID = R3.RIGHT_ID 
                      WHERE R1.PERSON_ID = ''', AV_PERSON_ID, '''
                  )
                  OR T1.UNIT_NUMBER IN (SELECT DISTINCT UNIT_NUMBER FROM ACCESS_TMP_ADMIN)
                  OR T1.REQUESTOR_PERSON_ID = ''', AV_PERSON_ID, '''
                  OR EXISTS (
                      SELECT S1.NEGOTIATION_LOCATION_ID 
                      FROM NEGOTIATION_LOCATION S1 
                      WHERE S1.NEGOTIATION_ID = S0.NEGOTIATION_ID 
                        AND S1.ASSIGNEE_PERSON_ID = ''', AV_PERSON_ID, '''
                  )
                  OR T1.AGREEMENT_REQUEST_ID IN (
                      SELECT T9.MODULE_ITEM_ID 
                      FROM WORKFLOW T9
                      INNER JOIN WORKFLOW_DETAIL T10 ON T9.WORKFLOW_ID = T10.WORKFLOW_ID
                      WHERE T9.MODULE_CODE = 13 
                        AND T10.APPROVER_PERSON_ID = ''', AV_PERSON_ID, '''
                        AND T9.MODULE_ITEM_ID = T1.AGREEMENT_REQUEST_ID
                        AND T9.IS_WORKFLOW_ACTIVE = ''Y''
                        AND T10.APPROVAL_STATUS = ''W''
                  )
                  OR T1.ADMIN_PERSON_ID = ''', AV_PERSON_ID, '''
                  OR T1.AGREEMENT_REQUEST_ID IN (select AGREEMENT_REQUEST_ID FROM AGREEMENT_PEOPLE WHERE  PEOPLE_TYPE_ID = 3 AND PERSON_ID = ''', AV_PERSON_ID, ''')
                  OR (T50.ROLE_ID IN (SELECT T51.ROLE_ID FROM ROLE_RIGHTS T51 
																	LEFT JOIN RIGHTS T52 ON T51.RIGHT_ID = T52.RIGHT_ID
																	LEFT JOIN PERSON_ROLES T53 ON T51.ROLE_ID = T53.ROLE_ID
																	WHERE T53.PERSON_ID = ''', AV_PERSON_ID ,''' AND T52.RIGHT_NAME = ''VIEW_ADMIN_GROUP_AGREEMENT''))
		))',LS_SORT_TYPE,LS_OFFSET_CONDITION, ')T ');
             
 SET @QUERY_STATEMENT = LS_DYN_SQL;
 PREPARE EXECUTABLE_STAEMENT FROM @QUERY_STATEMENT;
 EXECUTE EXECUTABLE_STAEMENT;

END
