CREATE PROCEDURE `GET_AWARDS_FOR_ORCID`(
     AV_PERSON_ID VARCHAR(40),
	      AV_LOGGIN_PERSON_ID VARCHAR(40),
		  AV_SEARCH_STRING VARCHAR(100),
          AV_FETCH_LIMIT INT
          
)
BEGIN
    WITH ACCESS_TMP AS (
  SELECT UNIT_NUMBER
  FROM PERSON_ROLES T1
  INNER JOIN ROLE_RIGHTS T2 ON T1.ROLE_ID = T2.ROLE_ID
  INNER JOIN RIGHTS T3 ON T2.RIGHT_ID = T3.RIGHT_ID
  WHERE T1.DESCEND_FLAG = 'N'
    AND T1.PERSON_ID = AV_LOGGIN_PERSON_ID-- LOGIN PERSON
    AND RIGHT_NAME IN ('VIEW_AWARD')
  UNION
  SELECT CHILD_UNIT_NUMBER
  FROM UNIT_WITH_CHILDREN
  WHERE UNIT_NUMBER IN (
    SELECT UNIT_NUMBER
    FROM PERSON_ROLES T1
    INNER JOIN ROLE_RIGHTS T2 ON T1.ROLE_ID = T2.ROLE_ID
    INNER JOIN RIGHTS T3 ON T2.RIGHT_ID = T3.RIGHT_ID
    WHERE T1.DESCEND_FLAG = 'Y'
      AND T1.PERSON_ID = AV_LOGGIN_PERSON_ID-- LOGIN PERSON 
      AND RIGHT_NAME IN ('VIEW_AWARD')
  ))
  SELECT DISTINCT
  T1.AWARD_NUMBER,
  T1.AWARD_ID,
  T1.TITLE,
  T1.SPONSOR_AWARD_NUMBER,
  T1.ACCOUNT_NUMBER,
  T6.SPONSOR_NAME,
  T7.UNIT_NAME,
  T2.FULL_NAME,
  T1.LEAD_UNIT_NUMBER
FROM Award T1
LEFT JOIN AWARD_PERSONS T2 ON T1.AWARD_ID = T2.AWARD_ID 
INNER JOIN SPONSOR T6 ON T6.SPONSOR_CODE = T1.SPONSOR_CODE
INNER JOIN UNIT T7 ON T7.UNIT_NUMBER = T1.LEAD_UNIT_NUMBER
WHERE 
 (
            (LOWER(T1.TITLE) LIKE AV_SEARCH_STRING OR 
            LOWER(T1.AWARD_ID) LIKE AV_SEARCH_STRING OR
            LOWER(T1.AWARD_NUMBER) LIKE AV_SEARCH_STRING OR 
            LOWER(T1.ACCOUNT_NUMBER) LIKE AV_SEARCH_STRING OR
            LOWER(T1.SPONSOR_AWARD_NUMBER) LIKE AV_SEARCH_STRING OR 
            LOWER(T2.FULL_NAME) LIKE AV_SEARCH_STRING OR
            LOWER(T6.SPONSOR_NAME) LIKE AV_SEARCH_STRING OR 
            LOWER(T7.UNIT_NAME) LIKE AV_SEARCH_STRING)
        )
  AND (
EXISTS ( SELECT 1 FROM AWARD_PERSON_ROLES APR  -- CHECK WHETHER LOGIN USER HAS SOME RIGHT(VIEW_AWARD) IN THAT AWARD
INNER JOIN ROLE_RIGHTS RR ON  APR.ROLE_ID = RR.ROLE_ID
INNER JOIN RIGHTS R ON RR.RIGHT_ID = R.RIGHT_ID 
WHERE R.RIGHT_NAME = 'VIEW_AWARD' AND APR.PERSON_ID = AV_LOGGIN_PERSON_ID
AND APR.AWARD_ID = T1.AWARD_ID )
OR 
T1.LEAD_UNIT_NUMBER IN (SELECT UNIT_NUMBER FROM ACCESS_TMP)-- CHECK WHETHER LOGIN USER HAS SOME RIGHT(VIEW_AWARD) FOR RESPECTIVE UNIT
)
AND  T2.PERSON_ROLE_ID IN (3) 
AND T1.AWARD_SEQUENCE_STATUS = 'ACTIVE'
AND T2.PERSON_ID = AV_PERSON_ID 
LIMIT AV_FETCH_LIMIT; -- KEY PERSON -- USE THIS QUERY
END 
