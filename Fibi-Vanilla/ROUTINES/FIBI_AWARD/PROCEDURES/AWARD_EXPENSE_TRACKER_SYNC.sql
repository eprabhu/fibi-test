CREATE PROCEDURE `AWARD_EXPENSE_TRACKER_SYNC`(AV_FILE_ID INT)
BEGIN  

DECLARE LS_AWARD_NUMBER 	       		VARCHAR(20);
DECLARE LS_ACCOUNT_NUMBER 	       		VARCHAR(20);
DECLARE LS_INTERNAL_ORDER_CODE     		VARCHAR(100);
DECLARE LS_AMOUNT_IN_FMA_CURRENCY  		VARCHAR(100);
DECLARE LS_COMMITTED_NUMBER        		INT(3);
DECLARE LS_AWARD_EXPENSE_DETLS_EXT_ID 	INT(12);
DECLARE LS_AMOUNT 						VARCHAR(100);
DECLARE LI_FLAG 						INT;
DECLARE LS_UPDATE_USER 					VARCHAR(60);
DECLARE LS_ERROR_MSG 					VARCHAR(4000);
DECLARE LI_SEQ_ERROR_LOG_ID				INT;
DECLARE LS_PROG_LOC                     VARCHAR(100);
DECLARE DONE 							BOOLEAN;
DECLARE LS_TIME                         DATETIME;

DECLARE  AWD_DATA CURSOR FOR
	SELECT DISTINCT AWARD_NUMBER FROM AWARD_EXPENSE_TRANSACTIONS 
	WHERE FILE_ID = AV_FILE_ID 
	AND AWARD_NUMBER IS NOT NULL;
	
SELECT UTC_TIMESTAMP() INTO LS_TIME;
SET SQL_SAFE_UPDATES = 0;

OPEN AWD_DATA;
awd_lp: LOOP
   BEGIN 
		DECLARE CONTINUE HANDLER FOR NOT FOUND SET DONE = TRUE;

		DECLARE EXIT HANDLER FOR SQLEXCEPTION
		BEGIN
			GET DIAGNOSTICS CONDITION 1 @sqlstate = RETURNED_SQLSTATE,
			@errno = MYSQL_ERRNO, @msg = MESSAGE_TEXT;
			SET @full_error = CONCAT("ERROR ", @errno, " (", @sqlstate, "): ", @msg);
			SELECT @full_error INTO LS_ERROR_MSG;
			SELECT IFNULL(MAX(ERROR_LOG_ID),0)+1 INTO LI_SEQ_ERROR_LOG_ID FROM AWARD_EXPENSE_ERROR_LOG;
			INSERT INTO AWARD_EXPENSE_ERROR_LOG(ERROR_LOG_ID,FILE_ID,ACCOUNT_NUMBER,INTERNAL_ORDER_CODE,ERROR_MESSAGE,PROCEDURE_NAME,UPDATE_TIMESTAMP, UPDATE_USER)
			VALUES(LI_SEQ_ERROR_LOG_ID,AV_FILE_ID,LS_ACCOUNT_NUMBER,LS_INTERNAL_ORDER_CODE,SUBSTR(CONCAT(LS_PROG_LOC,'-',LS_AWARD_NUMBER,'-',LS_ERROR_MSG),1,4000),'AWARD_EXPENSE_TRACKER_SYNC',UTC_TIMESTAMP(),'admin');
			COMMIT;
		END;
	   
		
		SET DONE = FALSE;
		FETCH AWD_DATA INTO LS_AWARD_NUMBER;
		IF DONE = TRUE THEN
		 LEAVE awd_lp;
		END IF;

		SET LS_PROG_LOC = 'DEL_EXP_HDR';
		-- TRUNCATE TABLE AWARD_EXPENSE_HEADER;
		DELETE FROM AWARD_EXPENSE_HEADER WHERE AWARD_NUMBER = LS_AWARD_NUMBER;

		SET LS_PROG_LOC = 'DEL_EXP_DTLS';
		-- TRUNCATE TABLE AWARD_EXPENSE_DETAILS;

		DELETE FROM AWARD_EXPENSE_DETAILS WHERE AWARD_NUMBER = LS_AWARD_NUMBER;

		SET LS_PROG_LOC = 'DEL_EXP_DTLS_EXT';
		-- TRUNCATE TABLE AWARD_EXPENSE_DETAILS_EXT;
		DELETE FROM AWARD_EXPENSE_DETAILS_EXT WHERE AWARD_NUMBER = LS_AWARD_NUMBER;


		SET LS_PROG_LOC = 'INS EXP HDR';
		INSERT INTO AWARD_EXPENSE_HEADER
		(
		AWARD_NUMBER,ACCOUNT_NUMBER,CREATE_TIMESTAMP,CREATE_USER,UPDATE_TIMESTAMP,UPDATE_USER,LAST_SYNCH_TIMESTAMP
		)
		SELECT distinct T1.AWARD_NUMBER,T1.ACCOUNT_NUMBER,UTC_TIMESTAMP(),'admin',UTC_TIMESTAMP(),'admin',UTC_TIMESTAMP() FROM AWARD_EXPENSE_TRANSACTIONS T1
		WHERE T1.AWARD_NUMBER IS NOT NULL AND T1.ACCOUNT_NUMBER IS NOT NULL 
		AND AWARD_NUMBER = LS_AWARD_NUMBER;


		SET LS_PROG_LOC = 'INS_EXP_DTLS';
		INSERT INTO AWARD_EXPENSE_DETAILS
		(AWARD_NUMBER,ACCOUNT_NUMBER,INTERNAL_ORDER_CODE,TOTAL_EXPENSE_AMOUNT,UPDATE_TIMESTAMP,UPDATE_USER)
		SELECT
		T1.AWARD_NUMBER,
		T1.ACCOUNT_NUMBER,
		T1.INTERNAL_ORDER_CODE,
		SUM(T1.AMOUNT_IN_FMA_CURRENCY),
		utc_timestamp(),
		'admin'
		FROM AWARD_EXPENSE_TRANSACTIONS T1
		WHERE T1.ACTUAL_OR_COMMITTED_FLAG= 'A'
		AND  T1.AWARD_NUMBER IS NOT NULL
		AND T1.INTERNAL_ORDER_CODE IS NOT NULL
		AND AWARD_NUMBER = LS_AWARD_NUMBER
		GROUP BY T1.AWARD_NUMBER,T1.ACCOUNT_NUMBER,T1.INTERNAL_ORDER_CODE;

		SET LS_PROG_LOC = 'INS_EXP_DTLS_EXT';
		INSERT INTO AWARD_EXPENSE_DETAILS_EXT
		(AWARD_NUMBER,ACCOUNT_NUMBER,INTERNAL_ORDER_CODE,COMMITTED_AMOUNT,UPDATE_TIMESTAMP,UPDATE_USER,IS_FROM_SAP
		)
		SELECT T1.AWARD_NUMBER,T1.ACCOUNT_NUMBER,T1.INTERNAL_ORDER_CODE,SUM(T1.AMOUNT_IN_FMA_CURRENCY),UTC_TIMESTAMP(),'admin','Y'
		FROM AWARD_EXPENSE_TRANSACTIONS T1
		WHERE T1.ACTUAL_OR_COMMITTED_FLAG = 'C'
		AND T1.AWARD_NUMBER IS NOT NULL
		AND T1.INTERNAL_ORDER_CODE IS NOT NULL
		AND AWARD_NUMBER = LS_AWARD_NUMBER
		GROUP BY T1.AWARD_NUMBER,T1.ACCOUNT_NUMBER,T1.INTERNAL_ORDER_CODE;
								
		SET LS_PROG_LOC = 'DEL_EXP_TRANS_AMT';

		DELETE FROM AWARD_EXPENSE_TRANS_AMT_RT WHERE AWARD_NUMBER = LS_AWARD_NUMBER;
		
		SET LS_PROG_LOC = 'INS_EXP_TRANS_AMT';
		INSERT INTO AWARD_EXPENSE_TRANS_AMT_RT(AWARD_NUMBER, INTERNAL_ORDER_CODE, BUDGET_CATEGORY_CODE,
		FM_POSTING_DATE,ACTUAL_AMOUNT,COMMITTED_AMOUNT)
		SELECT 
			AWARD_NUMBER, INTERNAL_ORDER_CODE, BUDGET_CATEGORY_CODE,FM_POSTING_DATE, 
			SUM(ACTUAL_AMOUNT) AS ACTUAL_AMOUNT,
			SUM(COMMITTED_AMOUNT) AS COMMITTED_AMOUNT
		FROM (    
			SELECT 
				AWARD_NUMBER, INTERNAL_ORDER_CODE, BUDGET_CATEGORY_CODE,
				FM_POSTING_DATE,ACTUAL_OR_COMMITTED_FLAG,
				CASE WHEN ACTUAL_OR_COMMITTED_FLAG = 'A' THEN SUM(AMOUNT_IN_FMA_CURRENCY) END AS ACTUAL_AMOUNT,
				CASE WHEN ACTUAL_OR_COMMITTED_FLAG = 'C' THEN SUM(AMOUNT_IN_FMA_CURRENCY) END AS COMMITTED_AMOUNT
			FROM  AWARD_EXPENSE_TRANSACTIONS
			WHERE AWARD_NUMBER IS NOT NULL AND AWARD_NUMBER = LS_AWARD_NUMBER
			GROUP BY AWARD_NUMBER, INTERNAL_ORDER_CODE, BUDGET_CATEGORY_CODE,FM_POSTING_DATE, ACTUAL_OR_COMMITTED_FLAG
		)T
		GROUP BY AWARD_NUMBER, INTERNAL_ORDER_CODE, BUDGET_CATEGORY_CODE,FM_POSTING_DATE ;
								
		/* SET LS_PROG_LOC = 'UPD_AWD'; -- COMMENTED FOR DEADLOCK ISSUE
		UPDATE AWARD
		SET DOCUMENT_UPDATE_TIMESTAMP = LS_TIME
		WHERE AWARD_NUMBER = LS_AWARD_NUMBER
		AND AWARD_SEQUENCE_STATUS = 'ACTIVE'; */
	END;
END LOOP;
CLOSE AWD_DATA;

UPDATE REPORT_LAST_SYNC_TIME SET EXP_LAST_SYNC_TIMESTAMP =  UTC_TIMESTAMP();

SET SQL_SAFE_UPDATES = 1;

SET LS_PROG_LOC = 'COMPLETE';
END
