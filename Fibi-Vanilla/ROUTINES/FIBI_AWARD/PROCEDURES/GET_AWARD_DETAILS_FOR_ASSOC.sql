CREATE PROCEDURE GET_AWARD_DETAILS_FOR_ASSOC(
IN AV_MODULE_ITEM_ID INT)
BEGIN
	
SELECT 'ID'
		,'Title'
		,'Status'
		,'Principal Investigator'
		,'Lead Unit'
		,'Sponsor'
		,'Prime Sponsor'
		,'Sponsor Award Number'
		,'Anticipated Amount'
		,'Obligated Amount'
		-- ,'Total Amount'
		,'Effective Date'
		,'Final Expiration Date'
		
        UNION

         SELECT T1.AWARD_NUMBER,
              T1.TITLE,
			  AWS.DESCRIPTION AS AWARD_STATUS,
               (SELECT
                IFNULL(p2.FULL_NAME, r1.FULL_NAME)
				FROM
                ((award_persons p1
                LEFT JOIN person p2 ON ((p1.PERSON_ID = p2.PERSON_ID)))
                LEFT JOIN rolodex r1 ON ((p1.ROLODEX_ID = r1.ROLODEX_ID)))
				WHERE
                ((p1.AWARD_ID = t1.AWARD_ID)
                    AND (p1.PI_FLAG = 'Y'))) AS PI_NAME,
			  T3.DISPLAY_NAME AS LEAD_UNIT,
			  T2.DISPLAY_NAME AS SPONSOR,
			  T13.DISPLAY_NAME AS PRIME_SPONSOR,
			  T1.SPONSOR_AWARD_NUMBER,
			  IFNULL(T5.ANTICIPATED_TOTAL_AMOUNT, 0.00) AS ANTICIPATED_AMOUNT,
			  IFNULL(T5.AMOUNT_OBLIGATED_TO_DATE, 0.00) AS OBLIGATED_AMOUNT,
			  -- T7.TOTAL_COST,
			  DATE(T1.BEGIN_DATE) AS AWARD_EFFECTIVE_DATE,
			  DATE(T1.FINAL_EXPIRATION_DATE) AS AWARD_END_DATE
                 
            FROM AWARD T1
            INNER JOIN AWARD_STATUS AWS ON T1.STATUS_CODE = AWS.STATUS_CODE
            LEFT OUTER JOIN SPONSOR T2 ON T1.SPONSOR_CODE = T2.SPONSOR_CODE
            LEFT OUTER JOIN SPONSOR T13 ON T13.SPONSOR_CODE = T1.PRIME_SPONSOR_CODE
            LEFT OUTER JOIN UNIT T3 ON T1.LEAD_UNIT_NUMBER = T3.UNIT_NUMBER
            LEFT OUTER JOIN AWARD_PERSONS T9 ON T1.AWARD_ID = T9.AWARD_ID AND T9.PERSON_ROLE_ID=3
            LEFT OUTER JOIN PERSON T10 ON T9.PERSON_ID = T10.PERSON_ID
			LEFT JOIN (
					SELECT
						S1.AWARD_ID,
						S1.AWARD_NUMBER,
						S1.ANTICIPATED_TOTAL_AMOUNT,
						S1.AMOUNT_OBLIGATED_TO_DATE,
						S1.FINAL_EXPIRATION_DATE,
						S1.CURRENT_FUND_EFFECTIVE_DATE,
						S1.OBLIGATION_EXPIRATION_DATE,
						S1.TOTAL_COST_IN_CURRENCY
					FROM AWARD_AMOUNT_INFO S1
					WHERE  S1.AWARD_AMOUNT_INFO_ID = (
						SELECT MAX(S3.AWARD_AMOUNT_INFO_ID)
						FROM AWARD_AMOUNT_INFO S3
						LEFT JOIN AWARD_AMOUNT_TRANSACTION S2 ON S3.TRANSACTION_ID = S2.TRANSACTION_ID
						INNER JOIN AWARD S5 ON S5.AWARD_NUMBER = S3.AWARD_NUMBER
						WHERE S3.AWARD_NUMBER = S1.AWARD_NUMBER
							AND (
								(S2.TRANSACTION_STATUS_CODE IN ('P', 'A') AND S5.AWARD_DOCUMENT_TYPE_CODE = 1 AND S5.AWARD_SEQUENCE_STATUS = 'PENDING')
								OR (S2.TRANSACTION_STATUS_CODE = 'A' AND S5.AWARD_SEQUENCE_STATUS = 'ACTIVE')))
								) T5 ON T5.AWARD_NUMBER = T1.AWARD_NUMBER
			LEFT JOIN (
					SELECT
						S3.AWARD_ID,
						S3.TOTAL_COST,
						S3.TOTAL_DIRECT_COST,
						S3.TOTAL_INDIRECT_COST,
						S3.RATE_CLASS_CODE,
						S3.CUMULATIVE_VIREMENT,
						S3.RATE_TYPE_CODE,
						S3.ON_OFF_CAMPUS_FLAG,
						S3.ON_CAMPUS_RATES,
						S3.OFF_CAMPUS_RATES
					FROM AWARD_BUDGET_HEADER S3
					WHERE S3.VERSION_NUMBER = (
						SELECT MAX(S4.VERSION_NUMBER)
						FROM AWARD_BUDGET_HEADER S4
						WHERE S3.AWARD_ID = S4.AWARD_ID
					)
				) T11 ON T11.AWARD_ID = T1.AWARD_ID
				LEFT JOIN (
					SELECT
						S5.AWARD_ID,
						SUM(COMMITMENT_AMOUNT) AS COST_SHARE_AMT
					FROM AWARD_COST_SHARE S5
					GROUP BY S5.AWARD_ID
				) T6 ON T6.AWARD_ID = T1.AWARD_ID

            LEFT OUTER JOIN AWARD_BUDGET_HEADER T7 ON T1.BUDGET_HEADER_ID = T7.BUDGET_HEADER_ID
			WHERE  T1.AWARD_ID = AV_MODULE_ITEM_ID;
           		   
END
