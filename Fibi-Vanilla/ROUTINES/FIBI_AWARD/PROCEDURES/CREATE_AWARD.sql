-- `CREATE_AWARD`; 

CREATE PROCEDURE `CREATE_AWARD`(
  JSON_FORMAT JSON 
)
BEGIN
DECLARE LS_ERROR_MSG	      				VARCHAR(1000);
DECLARE NOT_FOUND 					INT;
DECLARE LD_CURRENT_DATE 				VARCHAR(10);
DECLARE LI_AWARD_ID					INT;
DECLARE LS_MAX_AWARD_NUMBER				VARCHAR(12);
DECLARE LS_AWARD_NUMBER					VARCHAR(12);
DECLARE LI_SEQUENCE_NUMBER				INT;
DECLARE LS_DURATION					VARCHAR(255);
DECLARE LS_LEAD_UNIT_NUMBER				VARCHAR(8);
DECLARE LS_TITLE					VARCHAR(300);
DECLARE LS_SPONSOR_CODE					VARCHAR(6);
DECLARE LD_FINAL_EXPIRATION_DATE			DATETIME;
DECLARE LD_BEGIN_DATE					DATETIME;
DECLARE LS_UNIT_NUMBER					VARCHAR(8);
DECLARE LS_PERSON_ID				   	VARCHAR(40);
DECLARE LS_DESIGNATION                 	 		VARCHAR(51);
DECLARE LI_AWARD_PERSON_ID				INT;
DECLARE LS_PERSON_NAME					VARCHAR(90);

DECLARE LS_PI_NAME_JSON					VARCHAR(90);
DECLARE LS_TITLE_JSON          				VARCHAR(200);
DECLARE LD_BEGIN_DATE_JSON         			DATETIME;
DECLARE LD_FINAL_EXPIRATION_DATE_JSON  			 DATETIME;
DECLARE LS_SPONSOR_NAME_JSON   				VARCHAR(200);
DECLARE LD_ANTICIPATED_AMOUNT   			DECIMAL(15,2);
DECLARE LD_OBLIGATED_AMOUNT 	  			DECIMAL(15,2);
DECLARE LD_OBLIGATED_START_DATE				DATETIME;
DECLARE LD_OBLIGATED_END_DATE				DATETIME;
DECLARE LD_NOTICE_DATE					DATETIME;
DECLARE	LD_TRANSACTION_ID 				DECIMAL(22,0);

BEGIN
				DECLARE CONTINUE HANDLER FOR SQLEXCEPTION
				BEGIN
				
					GET DIAGNOSTICS CONDITION 1 @sqlstate = RETURNED_SQLSTATE, 
					 @errno = MYSQL_ERRNO, @msg = MESSAGE_TEXT;
					 
					SET @full_error = CONCAT("ERROR ", @errno, " (", @sqlstate, "): ", @msg);
					
					SELECT @full_error INTO LS_ERROR_MSG;
																	
					INSERT INTO AWARD_ERROR_LOG(AWARD_ID, AWARD_NUMBER, SEQUENCE_NUMBER, ERROR_MESSAGE, PROCEDURE_NAME, TABLE_NAME,SECTION_CODE,VARIATION_TYPE_CODE, UPDATE_TIMESTAMP, UPDATE_USER)
					VALUES(LI_AWARD_ID,LS_AWARD_NUMBER,LI_SEQUENCE_NUMBER,LS_ERROR_MSG,'CREATE_AWARD',NULL,NULL,null,UTC_TIMESTAMP(),'admin');
					COMMIT;
					
				END;

DECLARE CONTINUE HANDLER FOR NOT FOUND  SET NOT_FOUND =1;

SET LS_TITLE_JSON = JSON_UNQUOTE(JSON_EXTRACT(JSON_FORMAT, '$."Federal Award Project Title"'));
SET LS_PI_NAME_JSON = JSON_UNQUOTE(JSON_EXTRACT(JSON_FORMAT, '$."Principal Investigators"'));
SET LD_FINAL_EXPIRATION_DATE_JSON = STR_TO_DATE(JSON_UNQUOTE(JSON_EXTRACT(JSON_FORMAT, '$."Latest Activation Date"')), '%m/%d/%Y');
SET LD_BEGIN_DATE_JSON = STR_TO_DATE(JSON_UNQUOTE(JSON_EXTRACT(JSON_FORMAT, '$."Budget Period Start Date"')), '%m/%d/%Y');
SET LS_SPONSOR_NAME_JSON = JSON_UNQUOTE(JSON_EXTRACT(JSON_FORMAT, '$."Sponsor"'));
SET LD_NOTICE_DATE = STR_TO_DATE(JSON_UNQUOTE(JSON_EXTRACT(JSON_FORMAT, '$."Federal Award Date"')), '%m/%d/%Y');
SET LD_OBLIGATED_START_DATE = STR_TO_DATE(JSON_UNQUOTE(JSON_EXTRACT(JSON_FORMAT, '$."Budget Period Start Date"')), '%m/%d/%Y');
SET LD_OBLIGATED_END_DATE = STR_TO_DATE(JSON_UNQUOTE(JSON_EXTRACT(JSON_FORMAT, '$."End Date"')), '%m/%d/%Y');
SET LD_OBLIGATED_AMOUNT = 
    CAST(
        REPLACE(REPLACE(
            JSON_UNQUOTE(JSON_EXTRACT(JSON_FORMAT, '$."Total Amount of Federal Funds Obligated by this Action"')),
            '$', ''), 
        ',', '') 
    AS DECIMAL(15,2));

SET LD_ANTICIPATED_AMOUNT = 
 CAST(
        REPLACE(REPLACE(
            JSON_UNQUOTE(JSON_EXTRACT(JSON_FORMAT, '$."Total Amount of Federal Funds Obligated by this Action"')),
            '$', ''), 
        ',', '') 
    AS DECIMAL(15,2));

IF LS_TITLE_JSON IS NOT NULL AND LS_TITLE_JSON != '' THEN
    SET LS_TITLE_JSON = CONCAT('(Automated) ', LS_TITLE_JSON);
END IF;

 SET @LD_CURRENT_DATE = DATE_FORMAT(CURDATE(), '%m/%d/%Y');
IF LD_FINAL_EXPIRATION_DATE_JSON IS NULL AND LD_BEGIN_DATE_JSON IS NULL THEN
	SET LD_FINAL_EXPIRATION_DATE_JSON =   STR_TO_DATE(@LD_CURRENT_DATE, '%m/%d/%Y');
	SET LD_BEGIN_DATE_JSON = STR_TO_DATE(@LD_CURRENT_DATE, '%m/%d/%Y');
ELSEIF LD_FINAL_EXPIRATION_DATE_JSON IS NULL AND LD_BEGIN_DATE_JSON IS NOT NULL THEN  
	SET LD_BEGIN_DATE_JSON =  LD_BEGIN_DATE_JSON;
    SET LD_FINAL_EXPIRATION_DATE_JSON = LD_BEGIN_DATE_JSON;
ELSEIF LD_BEGIN_DATE_JSON IS NULL AND LD_FINAL_EXPIRATION_DATE_JSON IS NOT NULL THEN
	 SET LD_BEGIN_DATE_JSON =  LD_FINAL_EXPIRATION_DATE_JSON;
     SET LD_FINAL_EXPIRATION_DATE_JSON =  LD_FINAL_EXPIRATION_DATE_JSON;
ELSEIF LD_BEGIN_DATE_JSON IS NOT NULL AND LD_FINAL_EXPIRATION_DATE_JSON IS NOT NULL THEN
	IF LD_FINAL_EXPIRATION_DATE_JSON <= LD_BEGIN_DATE_JSON THEN
		SET LD_FINAL_EXPIRATION_DATE_JSON = LD_BEGIN_DATE_JSON;
	END IF;
END IF;

-- OBLIGATED DATES
IF LD_OBLIGATED_START_DATE IS NULL AND LD_OBLIGATED_END_DATE IS NULL THEN
	SET LD_OBLIGATED_START_DATE = STR_TO_DATE(@LD_CURRENT_DATE, '%m/%d/%Y');
	SET LD_OBLIGATED_END_DATE = STR_TO_DATE(@LD_CURRENT_DATE, '%m/%d/%Y');
ELSEIF LD_OBLIGATED_START_DATE IS NULL THEN
	SET LD_OBLIGATED_START_DATE = STR_TO_DATE(@LD_CURRENT_DATE, '%m/%d/%Y');
ELSEIF LD_OBLIGATED_END_DATE IS NULL THEN
    SET LD_OBLIGATED_END_DATE = LD_OBLIGATED_START_DATE;
END IF;

SELECT PERSON_ID,HOME_UNIT,PRIMARY_TITLE,FULL_NAME INTO LS_PERSON_ID, LS_UNIT_NUMBER, LS_DESIGNATION, LS_PERSON_NAME FROM PERSON WHERE FULL_NAME = LS_PI_NAME_JSON;
IF LS_PERSON_ID IS NULL  THEN
	SET LS_PERSON_ID = '10000000001';			-- default person
    SET LS_UNIT_NUMBER = '000001';
    SET LS_DESIGNATION = 'Quickstart Primary Title';
    SET LS_PERSON_NAME = 'Smith, Will';
END IF;

SELECT SPONSOR_CODE INTO LS_SPONSOR_CODE FROM SPONSOR WHERE SPONSOR_NAME = LS_SPONSOR_NAME_JSON;
IF LS_SPONSOR_CODE IS NULL  THEN
	SET LS_SPONSOR_CODE = '000100';		-- default sponsor
END IF;

-- AWARD_NUMBER generation starts 
UPDATE AWARD_NEXTVALUE SET AWARD_NUMBER = AWARD_NUMBER + 1;
SELECT MAX(AWARD_NUMBER) INTO LS_MAX_AWARD_NUMBER FROM AWARD_NEXTVALUE;
-- Format as a 6-digit number and append "-00001"
SELECT CONCAT(LPAD(LS_MAX_AWARD_NUMBER, 6, '0'), '-00001') INTO LS_AWARD_NUMBER;
-- AWARD_NUMBER generation ends

-- TRANSACTION ID generation starts
SELECT CONCAT(DATE_FORMAT(NOW(), '%y%m%d'), LPAD(DATE_FORMAT(NOW(), '%H%i%s%f') DIV 1000, 9, '0')) INTO LD_TRANSACTION_ID;
-- TRANSACTION ID generation ends

		INSERT INTO AWARD (
			 AWARD_NUMBER, SEQUENCE_NUMBER, ACCOUNT_NUMBER, LEAD_UNIT_NUMBER, TITLE, AWARD_TYPE_CODE, 
			 ACTIVITY_TYPE_CODE, ACCOUNT_TYPE_CODE, STATUS_CODE, SPONSOR_TEMPLATE_CODE, SPONSOR_AWARD_NUMBER, 
			 SPONSOR_CODE, AWARD_EXECUTION_DATE, AWARD_EFFECTIVE_DATE, FINAL_EXPIRATION_DATE, BEGIN_DATE,
			 PRE_AWARD_AUTHORIZED_AMOUNT, SPECIAL_EB_RATE_OFF_CAMPUS, SPECIAL_EB_RATE_ON_CAMPUS, PRE_AWARD_EFFECTIVE_DATE, 
			 PRIME_SPONSOR_CODE, AWARD_SEQUENCE_STATUS, UPDATE_TIMESTAMP, UPDATE_USER, IS_LATEST, BUDGET_HEADER_ID,
			 CREATE_TIMESTAMP, CREATE_USER, AWARD_DOCUMENT_TYPE_CODE, AWARD_VARIATION_TYPE_CODE, WORKFLOW_AWARD_STATUS_CODE, 
			 SUBMIT_USER, UNIQUE_ENTITY_NO, FUND_CENTRE, FUND_CENTER, SUBMISSION_DATE, BASIS_OF_PAYMENT_CODE, 
			 METHOD_OF_PAYMENT_CODE, PAYMENT_INVOICE_FREQ_CODE, INVOICE_NUMBER_OF_COPIES, FINAL_INVOICE_DUE, DFAFS_NUMBER, INVOICE_INSTRUCTIONS,
			 GRANT_HEADER_ID, RESEARCH_AREA_DESC, MULTI_DISCIPLINARY_DESC, CFDA_NUMBER, DURATION, DOCUMENT_UPDATE_USER, DOCUMENT_UPDATE_TIMESTAMP
             ) VALUES (
			LS_AWARD_NUMBER, 1, NULL, LS_UNIT_NUMBER, LS_TITLE_JSON, NULL, 
			11, NULL, 3, NULL, NULL,
			LS_SPONSOR_CODE, NULL, LD_NOTICE_DATE, LD_FINAL_EXPIRATION_DATE_JSON, LD_BEGIN_DATE_JSON,
			NULL, NULL, NULL, NULL,
			NULL, 'PENDING', UTC_TIMESTAMP(), 'admin', 'Y', NULL,
			UTC_TIMESTAMP(), 'admin', 1, NULL, 1,
			NULL, NULL, NULL, NULL, NULL, NULL, 
			NULL, NULL, NULL, NULL, NULL, NULL,
			NULL, NULL, NULL, NULL, NULL, 'admin', UTC_TIMESTAMP()
		);
		-- ACTIVITY_TYPE_CODE = RESEARCH , STATUS_CODE = PENDING
		 SELECT LAST_INSERT_ID() INTO LI_AWARD_ID FROM AWARD;
         
    
         INSERT INTO AWARD_PERSONS (
			 AWARD_ID, AWARD_NUMBER, SEQUENCE_NUMBER, PERSON_ID, FULL_NAME,
			 UPDATE_TIMESTAMP, UPDATE_USER, PERCENTAGE_OF_EFFORT, UNIT_NUMBER,
			 UNIT_NAME, PERSON_ROLE_ID, DEPARTMENT, EMAIL_ADDRESS, ROLODEX_ID,
			 PROJECT_ROLE, PI_FLAG, IS_MULTI_PI, DESIGNATION
			)  VALUES (
			 LI_AWARD_ID, LS_AWARD_NUMBER, 1, LS_PERSON_ID, LS_PERSON_NAME,
			 UTC_TIMESTAMP(), 'admin', NULL, NULL,
			 NULL, 3, NULL, NULL, NULL,
			 NULL, 'Y', 'N', LS_DESIGNATION
         );
		     -- PERSON_ROLE_ID = PI 
		SELECT LAST_INSERT_ID() INTO LI_AWARD_PERSON_ID FROM AWARD_PERSONS;

        INSERT INTO AWARD_PERSON_UNIT (
			AWARD_PERSON_ID, AWARD_ID, AWARD_NUMBER, SEQUENCE_NUMBER,
			UNIT_NUMBER, LEAD_UNIT_FLAG, UPDATE_TIMESTAMP, UPDATE_USER
			) VALUES (
			LI_AWARD_PERSON_ID, LI_AWARD_ID, LS_AWARD_NUMBER, 1,
			LS_UNIT_NUMBER, 'Y', UTC_TIMESTAMP(), 'admin'
		);

            INSERT INTO AWARD_PERSON_ROLES (
				AWARD_ID, AWARD_NUMBER, PERSON_ID, ROLE_ID,
				SEQUENCE_NUMBER, UPDATE_TIMESTAMP, UPDATE_USER, IS_SYSTEM_GENERATED
				) VALUES (
				LI_AWARD_ID, LS_AWARD_NUMBER, LS_PERSON_ID, 13, 
				1, UTC_TIMESTAMP(), 'admin', 'Y'
           );
           -- ROLE_ID = 13 View award

			INSERT INTO AWARD_HIERARCHY (
				ROOT_AWARD_NUMBER, AWARD_NUMBER, PARENT_AWARD_NUMBER, ORIGINATING_AWARD_NUMBER,
				UPDATE_TIMESTAMP,UPDATE_USER,IS_ACTIVE
				) VALUES (
                LS_AWARD_NUMBER, LS_AWARD_NUMBER,'000000-00000', LS_AWARD_NUMBER
                ,UTC_TIMESTAMP(), 'admin','Y'
			);

		INSERT INTO AWARD_AMOUNT_TRANSACTION (
			AWARD_NUMBER, TRANSACTION_ID, TRANSACTION_TYPE_CODE, FUNDED_PROPOSAL_ID, NOTICE_DATE, COMMENTS, 
            UPDATE_TIMESTAMP, UPDATE_USER, SOURCE_AWARD_NUMBER, DESTINATION_AWARD_NUMBER, TRANSACTION_STATUS_CODE
            ) VALUES (
				LS_AWARD_NUMBER, LD_TRANSACTION_ID, 9, NULL, LD_NOTICE_DATE, '',
				UTC_TIMESTAMP(), 'admin', 'EXTERNAL', LS_AWARD_NUMBER, 'P'
            );
			-- TRANSACTION_TYPE_CODE = 9 NEW

		INSERT INTO AWARD_AMOUNT_INFO (
			 AWARD_ID, AWARD_NUMBER, SEQUENCE_NUMBER, TRANSACTION_ID, UPDATE_TIMESTAMP, UPDATE_USER, ANTICIPATED_CHANGE, 
             ANTICIPATED_CHANGE_DIRECT, ANTICIPATED_CHANGE_INDIRECT, OBLIGATED_CHANGE, OBLIGATED_CHANGE_DIRECT, OBLIGATED_CHANGE_INDIRECT, ANTICIPATED_TOTAL_DIRECT,
             ANTICIPATED_TOTAL_INDIRECT, ANTICIPATED_TOTAL_AMOUNT, OBLIGATED_TOTAL_DIRECT, OBLIGATED_TOTAL_INDIRECT, AMOUNT_OBLIGATED_TO_DATE, ANT_DISTRIBUTABLE_AMOUNT, 
             OBLI_DISTRIBUTABLE_AMOUNT, FINAL_EXPIRATION_DATE, CURRENT_FUND_EFFECTIVE_DATE, OBLIGATION_EXPIRATION_DATE, TOTAL_COST_IN_CURRENCY, CURRENCY_CODE
             ) VALUES (
             LI_AWARD_ID, LS_AWARD_NUMBER ,1, LD_TRANSACTION_ID, UTC_TIMESTAMP(), 'admin', LD_ANTICIPATED_AMOUNT,
              0.00, 0.00, LD_OBLIGATED_AMOUNT, 0.00, 0.00, 0.00,
              0.00, LD_ANTICIPATED_AMOUNT, 0.00, 0.00, LD_OBLIGATED_AMOUNT, LD_ANTICIPATED_AMOUNT,
              LD_OBLIGATED_AMOUNT, NULL, LD_OBLIGATED_START_DATE, LD_OBLIGATED_END_DATE, 0.00, NULL
             );


		SELECT LI_AWARD_ID AS AWARD_ID;
END;
END
