

CREATE PROCEDURE `UPDATE_GLOBAL_ENTITY_FOREIGN_FLAG`(AV_ENTITY_ID INT)
BEGIN

        SET SESSION group_concat_max_len = 1000000;

    	CALL GET_ENTITY_HIERARCHY(AV_ENTITY_ID);

        SELECT GROUP_CONCAT(ENTITY_ID) INTO @entity_ids
        FROM ENTITY_HIERARCHY_TEMP_TABLE;

        UPDATE ENTITY
        SET IS_FOREIGN = 'Y'
        WHERE (EXISTS ( SELECT 1 FROM ENTITY_HIERARCHY_TEMP_TABLE WHERE COUNTRY_CODE NOT IN (
                SELECT NON_FOREIGN_COUNTRY_CODE FROM ENTITY_NON_FOREIGN_COUNTRIES WHERE IS_ACTIVE = 'Y'
            )
        ) AND  FIND_IN_SET(ENTITY_ID, @entity_ids))
        OR (
            COUNTRY_CODE NOT IN (
                SELECT NON_FOREIGN_COUNTRY_CODE FROM ENTITY_NON_FOREIGN_COUNTRIES WHERE IS_ACTIVE = 'Y'
            )
            AND ENTITY_ID = AV_ENTITY_ID
        );

        IF NOT EXISTS (SELECT 1 FROM ENTITY WHERE ( EXISTS ( SELECT 1 FROM ENTITY_HIERARCHY_TEMP_TABLE WHERE COUNTRY_CODE NOT IN (
                        SELECT NON_FOREIGN_COUNTRY_CODE FROM ENTITY_NON_FOREIGN_COUNTRIES WHERE IS_ACTIVE = 'Y'
                    )
                ) AND  FIND_IN_SET(ENTITY_ID, @entity_ids))
                OR (
                    COUNTRY_CODE NOT IN (SELECT NON_FOREIGN_COUNTRY_CODE FROM ENTITY_NON_FOREIGN_COUNTRIES WHERE IS_ACTIVE = 'Y')
                    AND ENTITY_ID = AV_ENTITY_ID
                )
            ) THEN
            UPDATE ENTITY SET IS_FOREIGN = 'N' WHERE ENTITY_ID = AV_ENTITY_ID;
        END IF;

END
