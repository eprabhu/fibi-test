


CREATE PROCEDURE `GET_COI_PROJECTS`(
	AV_MODULE_CODE            INT(3),
	AV_PERSON_ID              VARCHAR(40),
    AV_SEARCH_STRING		  VARCHAR(40),
    AV_MODULE_ITEM_KEY  	VARCHAR(40)
)
BEGIN

    IF AV_MODULE_CODE = 1 THEN

		IF AV_MODULE_ITEM_KEY is not null THEN

			SELECT DISTINCT T2.EXTERNAL_SYSTEM_REF_ID AS AWARD_ID, T2.AWARD_NUMBER, T2.TITLE, T2.AWARD_START_DATE AS BEGIN_DATE, 
            T2.AWARD_END_DATE AS FINAL_EXPIRATION_DATE, T2.LEAD_UNIT_NUMBER, T2.LEAD_UNIT_NAME AS UNIT_NAME,
            T2.PI_NAME AS PI, T2.KEY_PERSON_NAME AS KEY_PERSON, T2.KEY_PERSON_ID, T2.KEY_PERSON_ROLE_NAME, T2.AWARD_STATUS AS STATUS,
            T2.PRIME_SPONSOR_NAME, T2.SPONSOR_CODE, T2.PRIME_SPONSOR_CODE, T2.SPONSOR_NAME,
            T2.ACCOUNT_NUMBER, T2.SPONSOR_AWARD_NUMBER, null AS CONFLICT_DESCRIPTION, null as PROJECT_CONFLICT_STATUS_CODE,
            NULL AS RELATIONSHIP_COUNT FROM COI_PROJECT_AWARD_V T2 WHERE T2.AWARD_NUMBER = AV_MODULE_ITEM_KEY ;

		ELSEIF AV_PERSON_ID is not null THEN

			WITH AwardRanks AS (
			SELECT DISTINCT T1.EXTERNAL_SYSTEM_REF_ID AS AWARD_ID, T1.AWARD_NUMBER, T1.TITLE, T1.AWARD_START_DATE AS BEGIN_DATE, 
            T1.AWARD_END_DATE AS FINAL_EXPIRATION_DATE, T1.LEAD_UNIT_NUMBER, T1.LEAD_UNIT_NAME AS UNIT_NAME,
            T1.PI_NAME AS PI, T1.KEY_PERSON_NAME AS KEY_PERSON, T1.KEY_PERSON_ID, T1.KEY_PERSON_ROLE_NAME, T1.AWARD_STATUS AS STATUS,
            T1.PRIME_SPONSOR_NAME, T1.SPONSOR_CODE, T1.PRIME_SPONSOR_CODE, T1.SPONSOR_NAME,
			T1.ACCOUNT_NUMBER, T1.SPONSOR_AWARD_NUMBER , null as CONFLICT_DESCRIPTION, null as PROJECT_CONFLICT_STATUS_CODE,
            NULL AS RELATIONSHIP_COUNT,DISCLOSURE_VALIDATION_FLAG,DISCLOSURE_REQUIRED_FLAG,ROW_NUMBER() OVER (PARTITION BY SUBSTRING_INDEX(T1.AWARD_NUMBER, '-', 1)  
								ORDER BY CASE 
                                      WHEN T1.DISCLOSURE_VALIDATION_FLAG = 'SELF' THEN 1
                                      WHEN (T1.DISCLOSURE_VALIDATION_FLAG = 'HIERARCHY' OR DISCLOSURE_VALIDATION_FLAG IS NULL) AND T1.DISCLOSURE_REQUIRED_FLAG= 'REQUIRED' THEN 2
                                      ELSE 3
                                  END,								
								CAST(SUBSTRING_INDEX(T1.AWARD_NUMBER, '-', -1) AS UNSIGNED) ASC) AS rn
							FROM COI_PROJECT_AWARD_V T1
							LEFT JOIN (SELECT DISTINCT AW2.PROJECT_NUMBER FROM COI_INT_STAGE_AWARD AW1
										INNER JOIN COI_INT_STAGE_AWARD AW2 ON AW2.ROOT_PROJECT_NUMBER = AW1.ROOT_PROJECT_NUMBER
										INNER JOIN COI_INT_STAGE_AWARD_PERSON AW3 ON AW3.PROJECT_NUMBER = AW2.PROJECT_NUMBER
										WHERE AW2.PROJECT_STATUS_CODE IN (1, 6, 3) AND AW3.KEY_PERSON_ID = AV_PERSON_ID
							) T5 ON T5.PROJECT_NUMBER = T1.AWARD_NUMBER
			WHERE T1.KEY_PERSON_ID = AV_PERSON_ID AND T1.AWARD_STATUS_CODE IN (1,6,3)
			AND ((T1.DISCLOSURE_VALIDATION_FLAG = 'SELF')
									OR (T1.DISCLOSURE_REQUIRED_FLAG = 'REQUIRED' AND
									(T1.DISCLOSURE_VALIDATION_FLAG IS NULL OR T1.DISCLOSURE_VALIDATION_FLAG = 'HIERARCHY') AND T5.PROJECT_NUMBER IS NOT NULL)) 
			)
			SELECT AWARD_ID, AWARD_NUMBER, TITLE, BEGIN_DATE, FINAL_EXPIRATION_DATE, LEAD_UNIT_NUMBER,UNIT_NAME,PI, KEY_PERSON, KEY_PERSON_ID,
			KEY_PERSON_ROLE_NAME,STATUS,PRIME_SPONSOR_NAME, SPONSOR_CODE, PRIME_SPONSOR_CODE, SPONSOR_NAME,ACCOUNT_NUMBER, SPONSOR_AWARD_NUMBER,
			CONFLICT_DESCRIPTION,PROJECT_CONFLICT_STATUS_CODE,RELATIONSHIP_COUNT
			FROM AwardRanks
			WHERE (DISCLOSURE_VALIDATION_FLAG = 'SELF'
			OR (DISCLOSURE_REQUIRED_FLAG = 'REQUIRED' 
			AND (DISCLOSURE_VALIDATION_FLAG IS NULL OR DISCLOSURE_VALIDATION_FLAG = 'HIERARCHY') AND rn = 1 
			AND NOT EXISTS (
						   SELECT 1 
						   FROM AwardRanks AR 
						   WHERE AR.DISCLOSURE_VALIDATION_FLAG = 'SELF'
						   AND SUBSTRING_INDEX(AR.AWARD_NUMBER, '-', 1) = SUBSTRING_INDEX(AwardRanks.AWARD_NUMBER, '-', 1)
			)))
			AND AWARD_NUMBER NOT IN (SELECT T2.MODULE_ITEM_KEY FROM COI_DISCLOSURE t1
											INNER JOIN COI_DISCL_PROJECTS T2 ON T2.DISCLOSURE_ID=T1.DISCLOSURE_ID
											WHERE t1.PERSON_ID = AV_PERSON_ID
											AND t1.VERSION_STATUS IN ('PENDING','ACTIVE') AND T2.MODULE_CODE = 1
											AND t1.FCOI_TYPE_CODE IN (1, 3))
			AND (LOWER(AWARD_ID) LIKE CONCAT('%', LOWER(AV_SEARCH_STRING), '%')
				OR LOWER(AWARD_NUMBER) LIKE CONCAT('%', LOWER(AV_SEARCH_STRING), '%')
				OR LOWER(TITLE) LIKE CONCAT('%', AV_SEARCH_STRING, '%')
				OR LOWER(LEAD_UNIT_NUMBER) LIKE CONCAT('%', LOWER(AV_SEARCH_STRING), '%')
				OR LOWER(UNIT_NAME) LIKE CONCAT('%', LOWER(AV_SEARCH_STRING), '%')
				OR LOWER(SPONSOR_NAME) LIKE CONCAT('%', LOWER(AV_SEARCH_STRING), '%')
				OR LOWER(PI) LIKE CONCAT('%', LOWER(AV_SEARCH_STRING), '%')
				OR LOWER(KEY_PERSON) LIKE CONCAT('%', LOWER(AV_SEARCH_STRING), '%')
				OR LOWER(KEY_PERSON_ID) LIKE CONCAT('%', LOWER(AV_SEARCH_STRING), '%')
				OR LOWER(PRIME_SPONSOR_NAME) LIKE CONCAT('%', LOWER(AV_SEARCH_STRING), '%')
				OR LOWER(ACCOUNT_NUMBER) LIKE CONCAT('%', LOWER(AV_SEARCH_STRING), '%')
				OR LOWER(SPONSOR_AWARD_NUMBER) LIKE CONCAT('%', LOWER(AV_SEARCH_STRING), '%')
			);

        END IF;

	ELSEIF AV_MODULE_CODE = 3 THEN

		IF AV_MODULE_ITEM_KEY is not null THEN

            SELECT DISTINCT T2.EXTERNAL_SYSTEM_REF_ID AS PROPOSAL_ID, T2.TITLE, T2.PROPOSAL_STATUS AS STATUS, T2.PROPOSAL_START_DATE AS START_DATE, T2.PROPOSAL_END_DATE AS END_DATE, 
            T2.LEAD_UNIT_NUMBER AS HOME_UNIT_NUMBER, T2.LEAD_UNIT_NAME AS HOME_UNIT_NAME, T2.SPONSOR_CODE, T2.PRIME_SPONSOR_CODE,
            T2.SPONSOR_NAME, T2.PRIME_SPONSOR_NAME, T2.PI_NAME AS PI, T2.KEY_PERSON_NAME AS KEY_PERSON, T2.KEY_PERSON_ID, T2.KEY_PERSON_ROLE_NAME,
            null AS CONFLICT_DESCRIPTION, null as PROJECT_CONFLICT_STATUS_CODE, NULL AS RELATIONSHIP_COUNT
            FROM COI_PROJECT_PROPOSAL_V T2 WHERE T2.PROPOSAL_NUMBER = AV_MODULE_ITEM_KEY;

		ELSEIF AV_PERSON_ID is not null THEN

			SELECT DISTINCT T1.EXTERNAL_SYSTEM_REF_ID AS PROPOSAL_ID, T1.TITLE, T1.PROPOSAL_STATUS AS STATUS, T1.PROPOSAL_START_DATE AS START_DATE,
            T1.PROPOSAL_END_DATE AS END_DATE, T1.LEAD_UNIT_NUMBER AS HOME_UNIT_NUMBER, T1.LEAD_UNIT_NAME AS HOME_UNIT_NAME,
            T1.SPONSOR_CODE, T1.PRIME_SPONSOR_CODE, T1.SPONSOR_NAME,
            T1.PRIME_SPONSOR_NAME, T1.PI_NAME AS PI, T1.KEY_PERSON_NAME AS KEY_PERSON, T1.KEY_PERSON_ID, T1.KEY_PERSON_ROLE_NAME,
            null as CONFLICT_DESCRIPTION, null as PROJECT_CONFLICT_STATUS_CODE, NULL AS RELATIONSHIP_COUNT
            FROM COI_PROJECT_PROPOSAL_V T1 
            WHERE T1.PROPOSAL_STATUS not IN ("In Progress","Unsuccessful","Inactive","Revision Requested",
            "ORT Director Review Completed","Pending Revisions By PI","Pending Revisions By PI","Not Submitted","Returned","Withdrawn","Awarded") 
            AND (LOWER(T1.EXTERNAL_SYSTEM_REF_ID) LIKE CONCAT('%', LOWER(AV_SEARCH_STRING), '%')
				 OR LOWER(T1.TITLE) LIKE CONCAT('%', LOWER(AV_SEARCH_STRING), '%')
				 OR LOWER(T1.LEAD_UNIT_NUMBER) LIKE CONCAT('%', LOWER(AV_SEARCH_STRING), '%')
				 OR LOWER(T1.LEAD_UNIT_NAME) LIKE CONCAT('%', LOWER(AV_SEARCH_STRING), '%')
				 OR LOWER(T1.SPONSOR_NAME) LIKE CONCAT('%', LOWER(AV_SEARCH_STRING), '%')
				 OR LOWER(T1.PRIME_SPONSOR_NAME) LIKE CONCAT('%', LOWER(AV_SEARCH_STRING), '%')
				 OR LOWER(T1.PI_NAME) LIKE CONCAT('%', LOWER(AV_SEARCH_STRING), '%')
				 OR LOWER(T1.KEY_PERSON_NAME) LIKE CONCAT('%', LOWER(AV_SEARCH_STRING), '%')
				 OR LOWER(T1.KEY_PERSON_ID) LIKE CONCAT('%', LOWER(AV_SEARCH_STRING), '%')
			)
            AND T1.KEY_PERSON_ID = AV_PERSON_ID;
        END IF;
	END IF;
END