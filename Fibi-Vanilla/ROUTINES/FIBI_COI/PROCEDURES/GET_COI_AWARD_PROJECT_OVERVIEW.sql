


CREATE PROCEDURE `GET_COI_AWARD_PROJECT_OVERVIEW`(
AV_AWARD_TITLE		  VARCHAR(1000),
AV_AWARD_NUMBER		  VARCHAR(20),
AV_UNIT_NUMBER            VARCHAR(8),
AV_PERSON_ID    		  VARCHAR(40),
AV_AWARD_STATUS        VARCHAR(200),
AV_REVIEW_STATUS 		  VARCHAR(200),
AV_SPONSOR 					VARCHAR(6),
AV_PRIME_SPONSOR 			VARCHAR(6),
AV_AWARD_START_DATE 		VARCHAR(20),
AV_AWARD_END_DATE 		VARCHAR(20),
AV_PAGED                        INT(10),
AV_LIMIT                        INT(10),
AV_UNLIMITED                    BOOLEAN,
AV_TYPE						 VARCHAR(1),
AV_SORT_TYPE 				VARCHAR(2000),
AV_ACCOUNT_NUMBER 		VARCHAR(20),
AV_PI_PERSON_ID 		VARCHAR(20),
AV_LOGIN_PERSON_ID	VARCHAR(40)
)
BEGIN

DECLARE LS_FILTER_CONDITION 		LONGTEXT;
DECLARE LS_JOIN_CONDITION			LONGTEXT;
DECLARE LS_PAGINATION_CONDITION 	VARCHAR(60);
DECLARE LS_DYN_SQL					LONGTEXT;
DECLARE LI_CA_ADMIN					INT;
DECLARE LI_CAN_VIEW_PRIVATE_COMMENT	INT;

DECLARE LS_OFFSET 					INT(11);
DECLARE LS_ORDER_BY 				LONGTEXT;
DECLARE LS_OFFSET_CONDITION			LONGTEXT;

SET LS_DYN_SQL ='';
SET LS_FILTER_CONDITION = '';
SET LS_PAGINATION_CONDITION = '';
SET LS_JOIN_CONDITION = '';
SET LS_OFFSET = (AV_LIMIT * AV_PAGED);

 IF AV_UNLIMITED <> TRUE THEN

TRUNCATE TABLE DisclosureAwardProjects;
INSERT INTO DisclosureAwardProjects 
(PROJECT_ID, PROJECT_NUMBER, KEY_PERSON_ID, DISCLOSURE_REQUIRED_FLAG, DISCLOSURE_ID, DISCLOSURE_STATUS, PROJECT_DISCLOSURE_REVIEW_STATUS)
SELECT DISTINCT T1.EXTERNAL_SYSTEM_REF_ID AS PROJECT_ID
		,T1.AWARD_NUMBER AS PROJECT_NUMBER
		,T1.KEY_PERSON_ID
        ,T1.DISCLOSURE_REQUIRED_FLAG
        ,CASE 
			WHEN T55.DISCLOSURE_ID IS NULL 
				AND T1.DISCLOSURE_REQUIRED_FLAG = 'REQUIRED' 
				AND T1.DISCLOSURE_VALIDATION_FLAG IS NULL 
				AND FN_CHK_HIERARCHY_HAS_DISCL(T1.AWARD_NUMBER, T1.KEY_PERSON_ID) <> 'NO DATA' 
			THEN FN_CHK_HIERARCHY_HAS_DISCL(T1.AWARD_NUMBER, T1.KEY_PERSON_ID)
			WHEN T55.DISCLOSURE_ID IS NOT NULL 
			THEN T55.DISCLOSURE_ID 
			ELSE NULL 
		END AS DISCLOSURE_ID 
		,CASE 
    WHEN T1.DISCLOSURE_REQUIRED_FLAG = 'REQUIRED' COLLATE utf8mb4_0900_ai_ci
	THEN CASE 
        WHEN T1.DISCLOSURE_VALIDATION_FLAG IS NULL AND T55.DISCLOSURE_ID IS NULL AND FN_CHK_HIERARCHY_HAS_DISCL(T1.AWARD_NUMBER, T1.KEY_PERSON_ID) <> 'NO DATA'
                THEN CASE 
						WHEN FN_CHK_HIERARCHY_HAS_DISCL(T1.AWARD_NUMBER, T1.KEY_PERSON_ID) <> 'NO DATA' AND 
						(SELECT 1 FROM  COI_DISCL_PROJECTS C1
								INNER JOIN COI_DISCLOSURE C2 ON C1.DISCLOSURE_ID = C2.DISCLOSURE_ID
								WHERE C1.MODULE_CODE = 1 AND C2.DISPOSITION_STATUS_CODE <> 2
									AND C2.VERSION_STATUS <> 'ARCHIVE' AND C2.PERSON_ID = T1.KEY_PERSON_ID AND C1.MODULE_ITEM_KEY <> T1.AWARD_NUMBER
									AND C1.MODULE_ITEM_KEY LIKE CONCAT(SUBSTRING_INDEX(T1.AWARD_NUMBER, '-', 1), '-%')
									AND C2.REVIEW_STATUS_CODE IN (2, 3, 4, 7, 8)
									AND C2.DISCLOSURE_ID = FN_CHK_HIERARCHY_HAS_DISCL(T1.AWARD_NUMBER, T1.KEY_PERSON_ID)
								ORDER BY C2.DISCLOSURE_ID DESC LIMIT 1) = 1 THEN 'DISCLOSURE_COMPLETED' COLLATE utf8mb4_0900_ai_ci
						ELSE CASE 
                                WHEN FN_CHK_HIERARCHY_HAS_DISCL(T1.AWARD_NUMBER, T1.KEY_PERSON_ID) = 'NO DATA' THEN 'NOT_YET_DISCLOSED' COLLATE utf8mb4_0900_ai_ci
                                ELSE 'DISCLOSURE_PENDING' COLLATE utf8mb4_0900_ai_ci
                             END
					 END
        WHEN T1.DISCLOSURE_VALIDATION_FLAG <> 'SELF' COLLATE utf8mb4_0900_ai_ci
        THEN 
            CASE 
                WHEN FN_CHK_HIERARCHY_HAS_DISCL(T1.AWARD_NUMBER, T1.KEY_PERSON_ID) = 'NO DATA' COLLATE utf8mb4_0900_ai_ci
                THEN 
                    CASE 
                        WHEN T55.REVIEW_STATUS_CODE IN (
                                2
                                ,3
                                ,4
                                ,7
                                ,8
                                )
                        THEN 'DISCLOSURE_COMPLETED' COLLATE utf8mb4_0900_ai_ci
                        ELSE
                        CASE WHEN T55.DISCLOSURE_ID  IS NOT NULL THEN 'DISCLOSURE_PENDING' COLLATE utf8mb4_0900_ai_ci
                        ELSE 'NOT_YET_DISCLOSED'
                        END 
                    END
                ELSE FN_CHK_HIERARCHY_HAS_DISCL(T1.AWARD_NUMBER, T1.KEY_PERSON_ID)
            END
        WHEN T1.NEW_DISCLOSURE_REQUIRED = 'N' AND T55.REVIEW_STATUS_CODE IN (
                2
                ,3
                ,4
                ,7
                ,8
                )
        THEN 'DISCLOSURE_COMPLETED' COLLATE utf8mb4_0900_ai_ci
        ELSE CASE WHEN T55.DISCLOSURE_ID  IS NOT NULL AND T55.REVIEW_STATUS_CODE = 1 THEN 'DISCLOSURE_PENDING' COLLATE utf8mb4_0900_ai_ci
                        ELSE 'NOT_YET_DISCLOSED'
                        END 
                END
    WHEN T1.DISCLOSURE_REQUIRED_FLAG = 'NOT_REQUIRED' COLLATE utf8mb4_0900_ai_ci
        THEN CASE 
                WHEN T1.DISCLOSURE_VALIDATION_FLAG = 'SELF' COLLATE utf8mb4_0900_ai_ci
                    THEN CASE 
                    WHEN T55.REVIEW_STATUS_CODE IS NULL 
                    THEN 'DISCLOSURE_NOT_REQUIRED' COLLATE utf8mb4_0900_ai_ci
                            WHEN T55.REVIEW_STATUS_CODE IN (
                                    2
                                    ,3
                                    ,4
                                    ,7
                                    ,8
                                    )
                                THEN 'DISCLOSURE_COMPLETED' COLLATE utf8mb4_0900_ai_ci
                         ELSE
                       CASE WHEN T55.DISCLOSURE_ID  IS NOT NULL THEN 'DISCLOSURE_PENDING' COLLATE utf8mb4_0900_ai_ci
                        ELSE 'NOT_YET_DISCLOSED'
                        END 
                            END                 
                END
    ELSE 'DISCLOSURE_TO_BE_DETERMINED' COLLATE utf8mb4_0900_ai_ci
	END AS DISCLOSURE_STATUS,
CASE 
    WHEN T1.DISCLOSURE_VALIDATION_FLAG = 'SELF' and T1.NEW_DISCLOSURE_REQUIRED = 'Y' AND T55.REVIEW_STATUS_CODE <> 1 COLLATE utf8mb4_0900_ai_ci
        THEN NULL
    WHEN T1.DISCLOSURE_VALIDATION_FLAG IS NULL AND T55.DISCLOSURE_ID IS NULL AND FN_CHK_HIERARCHY_HAS_DISCL(T1.AWARD_NUMBER, T1.KEY_PERSON_ID) <> 'NO DATA' THEN
			CASE WHEN FN_CHK_HIERARCHY_HAS_DISCL(T1.AWARD_NUMBER, T1.KEY_PERSON_ID) <> 'NO DATA' THEN
					(SELECT C3.DESCRIPTION FROM COI_DISCLOSURE C1
					LEFT JOIN COI_REVIEW_STATUS_TYPE C3 ON C3.REVIEW_STATUS_CODE = C1.REVIEW_STATUS_CODE
					WHERE C1.DISCLOSURE_ID = FN_CHK_HIERARCHY_HAS_DISCL(T1.AWARD_NUMBER, T1.KEY_PERSON_ID))
				ELSE 'DISCLOSURE_REVIEW_NA' COLLATE utf8mb4_0900_ai_ci
				END
    WHEN T1.DISCLOSURE_REQUIRED_FLAG = 'REQUIRED' COLLATE utf8mb4_0900_ai_ci
        THEN T9.DESCRIPTION
    WHEN T1.DISCLOSURE_REQUIRED_FLAG = 'NOT_REQUIRED' 
        THEN 
        CASE 
            WHEN T1.DISCLOSURE_VALIDATION_FLAG = 'SELF' 
                THEN 
                CASE 
                    WHEN T55.DISCLOSURE_ID  IS NULL  
                        THEN 'DISCLOSURE_REVIEW_NA' COLLATE utf8mb4_0900_ai_ci
                    ELSE T9.DESCRIPTION
                END
            WHEN T1.DISCLOSURE_VALIDATION_FLAG = 'SELF' 
                THEN T9.DESCRIPTION 
            ELSE 'DISCLOSURE_REVIEW_NA' 
        END
       
END AS PROJECT_DISCLOSURE_REVIEW_STATUS
	FROM COI_PROJECT_AWARD_V T1
		LEFT JOIN (
		SELECT T13.EXTERNAL_SYSTEM_REF_ID
			,T13.AWARD_NUMBER
			,T22.DISCLOSURE_ID
			,T6.FCOI_TYPE_CODE
			,T6.REVIEW_STATUS_CODE
			,T6.DISPOSITION_STATUS_CODE
			,T6.PERSON_ID
		FROM COI_PROJECT_AWARD_V T13
		INNER JOIN COI_DISCL_PROJECTS T22 ON T22.MODULE_ITEM_KEY = T13.AWARD_NUMBER
			AND T22.MODULE_CODE = T13.COI_PROJECT_TYPE_CODE
		INNER JOIN COI_DISCLOSURE T6 ON T22.DISCLOSURE_ID = T6.DISCLOSURE_ID
        INNER JOIN (
			SELECT DISCLOSURE_NUMBER, MODULE_CODE, MAX(DISCLOSURE_ID) AS MAX_DISCLOSURE_ID
			FROM COI_DISCL_PROJECTS
			GROUP BY DISCLOSURE_NUMBER, MODULE_CODE
					) AS MaxDisclosures 
					ON T6.DISCLOSURE_NUMBER = MaxDisclosures.DISCLOSURE_NUMBER 
					AND T13.COI_PROJECT_TYPE_CODE = MaxDisclosures.MODULE_CODE
					AND T6.DISCLOSURE_ID = MaxDisclosures.MAX_DISCLOSURE_ID

		WHERE T6.DISPOSITION_STATUS_CODE != 2 ) AS T55 ON T55.EXTERNAL_SYSTEM_REF_ID = T1.EXTERNAL_SYSTEM_REF_ID
		AND T55.PERSON_ID = T1.KEY_PERSON_ID AND T55.DISCLOSURE_ID = (SELECT MAX(T22.DISCLOSURE_ID)
		FROM COI_DISCL_PROJECTS T22			
		INNER JOIN COI_DISCLOSURE T6 ON T22.DISCLOSURE_ID = T6.DISCLOSURE_ID
        WHERE T22.MODULE_ITEM_KEY = T1.AWARD_NUMBER AND T22.MODULE_CODE = '1'
        AND T6.PERSON_ID = T1.KEY_PERSON_ID)
	LEFT JOIN coi_review_status_type T9 ON T9.REVIEW_STATUS_CODE = T55.REVIEW_STATUS_CODE
    INNER  JOIN coi_int_stage_award_person CISA ON CISA.PROJECT_NUMBER = T1.AWARD_NUMBER AND  (CISA.NEW_DISCLOSURE_REQUIRED IS NULL OR CISA.NEW_DISCLOSURE_REQUIRED = 'N') WHERE T1.PERSON_STATUS <> 'I';
END IF;
		   
    

    SET LS_JOIN_CONDITION = CONCAT(LS_JOIN_CONDITION, ' LEFT JOIN PERSON T2 ON T1.KEY_PERSON_ID = T2.PERSON_ID
														LEFT JOIN SPONSOR T3 ON T3.SPONSOR_CODE = T1.SPONSOR_CODE
														LEFT JOIN SPONSOR T4 ON T4.SPONSOR_CODE = T1.PRIME_SPONSOR_CODE
														LEFT JOIN (
                                                        SELECT T13.EXTERNAL_SYSTEM_REF_ID, T22.DISCLOSURE_ID, T6.FCOI_TYPE_CODE, T6.REVIEW_STATUS_CODE,
															T6.DISPOSITION_STATUS_CODE, T6.PERSON_ID
															from coi_project_award_v T13
                                                            INNER JOIN COI_DISCL_PROJECTS T22
																ON T22.MODULE_ITEM_KEY = T13.AWARD_NUMBER
																AND T22.MODULE_CODE = T13.COI_PROJECT_TYPE_CODE
                                                            inner join
															COI_DISCLOSURE T6
                                                            on T22.DISCLOSURE_ID = T6.DISCLOSURE_ID
                                                            where T6.DISPOSITION_STATUS_CODE != 2
                                                            and T6.DISCLOSURE_ID = (select max(DISCLOSURE_ID) from COI_DISCLOSURE where DISCLOSURE_NUMBER = t6.DISCLOSURE_NUMBER )
														) AS T55 ON (T55.EXTERNAL_SYSTEM_REF_ID = T1.EXTERNAL_SYSTEM_REF_ID AND T55.PERSON_ID = T1.KEY_PERSON_ID)
														INNER JOIN eps_prop_person_role T7 ON T7.PROP_PERSON_ROLE_ID = T1.KEY_PERSON_ROLE_CODE
														LEFT JOIN UNIT T8 ON T8.UNIT_NUMBER = T2.HOME_UNIT
														LEFT JOIN coi_review_status_type T9 ON T9.REVIEW_STATUS_CODE = T55.REVIEW_STATUS_CODE
														INNER JOIN coi_project_type T10 ON T10.COI_PROJECT_TYPE_CODE = T1.COI_PROJECT_TYPE_CODE
                                                        INNER JOIN coi_project_award_status_v T11 ON T11.STATUS_CODE = T1.AWARD_STATUS_CODE
                                                         ');

IF AV_TYPE ='A' THEN

    IF AV_AWARD_TITLE IS NOT NULL AND AV_AWARD_TITLE <> '' THEN
		 SET LS_FILTER_CONDITION = CONCAT(LS_FILTER_CONDITION, ' AND T1.TITLE LIKE ''%', AV_AWARD_TITLE, '%'' ');
	END IF;

    IF AV_AWARD_NUMBER IS NOT NULL  AND AV_AWARD_NUMBER <> '' THEN
		SET LS_FILTER_CONDITION = CONCAT(LS_FILTER_CONDITION,' AND T1.AWARD_NUMBER LIKE ''%',AV_AWARD_NUMBER, '%'' ');
	END IF;
    
    IF AV_UNIT_NUMBER IS NOT NULL AND AV_UNIT_NUMBER <> '' THEN
        SET LS_FILTER_CONDITION = CONCAT(LS_FILTER_CONDITION,' AND T1.LEAD_UNIT_NUMBER = ''',AV_UNIT_NUMBER,''' ');
    END IF;

    IF AV_PERSON_ID IS NOT NULL AND AV_PERSON_ID <> '' THEN 
        SET LS_FILTER_CONDITION = CONCAT(LS_FILTER_CONDITION,' AND T1.AWARD_NUMBER IN(SELECT AWARD_NUMBER FROM coi_project_award_v WHERE KEY_PERSON_ID = ''',AV_PERSON_ID,''') ');
    END IF;

    IF AV_AWARD_STATUS IS NOT NULL AND AV_AWARD_STATUS <> '' THEN 
        SET LS_FILTER_CONDITION = CONCAT(LS_FILTER_CONDITION,' AND T11.STATUS_CODE IN (', AV_AWARD_STATUS, ') ');
    END IF;

    IF AV_REVIEW_STATUS IS NOT NULL AND AV_REVIEW_STATUS <> '' THEN
        SET LS_FILTER_CONDITION = CONCAT(LS_FILTER_CONDITION,' AND T55.REVIEW_STATUS_CODE IN (', AV_REVIEW_STATUS, ') ');
    END IF;

    IF AV_SPONSOR IS NOT NULL AND AV_SPONSOR <> '' THEN 
        SET LS_FILTER_CONDITION = CONCAT(LS_FILTER_CONDITION,' AND T3.SPONSOR_CODE = ''',AV_SPONSOR,''' ');
    END IF;
    
    IF AV_PRIME_SPONSOR IS NOT NULL AND AV_PRIME_SPONSOR <> '' THEN 
        SET LS_FILTER_CONDITION = CONCAT(LS_FILTER_CONDITION,' AND T4.SPONSOR_CODE = ''',AV_PRIME_SPONSOR,''' ');
    END IF;

    IF AV_AWARD_START_DATE IS NOT NULL AND AV_AWARD_START_DATE <> '' THEN
        SET LS_FILTER_CONDITION = CONCAT(LS_FILTER_CONDITION,' AND DATE(T1.AWARD_START_DATE) >= DATE_FORMAT(''',AV_AWARD_START_DATE,''',''%Y-%m-%d'') ');
    END IF;

    IF AV_AWARD_END_DATE IS NOT NULL AND AV_AWARD_END_DATE <> '' THEN
        SET LS_FILTER_CONDITION = CONCAT(LS_FILTER_CONDITION,' AND DATE(T1.AWARD_END_DATE) <= DATE_FORMAT(''',AV_AWARD_END_DATE,''',''%Y-%m-%d'') ');
    END IF;
 
	IF AV_ACCOUNT_NUMBER IS NOT NULL AND AV_ACCOUNT_NUMBER <> '' THEN 
        SET LS_FILTER_CONDITION = CONCAT(LS_FILTER_CONDITION,' AND T1.ACCOUNT_NUMBER LIKE ''%',AV_ACCOUNT_NUMBER, '%'' ');
    END IF;
	
	IF AV_PI_PERSON_ID IS NOT NULL AND AV_PI_PERSON_ID <> '' THEN 
        SET LS_FILTER_CONDITION = CONCAT(LS_FILTER_CONDITION,' AND T1.PI_PERSON_ID = ''',AV_PI_PERSON_ID,''' ');
    END IF;	   
END IF;

IF AV_TYPE <> 'A' THEN
	SET LS_FILTER_CONDITION = CONCAT(LS_FILTER_CONDITION, ' AND  (T1.DISCLOSURE_VALIDATION_FLAG = ''SELF'' OR (T1.AWARD_STATUS_CODE = 6))');
END IF;



IF AV_SORT_TYPE IS NOT NULL OR AV_SORT_TYPE <> '' THEN 

SET LS_ORDER_BY = CONCAT(' ORDER BY T1.PROJECT_SUBMISSION_STATUS IS NULL, T1.PROJECT_REVIEW_STATUS IS NULL,
 ',AV_SORT_TYPE,', T1.UPDATE_TIMESTAMP DESC,T1.SORT_ID ASC');
ELSE 

SET LS_ORDER_BY = ' ORDER BY T1.UPDATE_TIMESTAMP DESC,T1.SORT_ID ASC ';

END IF;

IF AV_UNLIMITED <> TRUE  THEN


IF AV_LIMIT IS NOT NULL AND LS_OFFSET IS NOT NULL THEN
    SET LS_OFFSET_CONDITION =CONCAT(' WHERE T.ROWNUMBER BETWEEN ', (SELECT CASE WHEN LS_OFFSET = 0 THEN LS_OFFSET ELSE LS_OFFSET+1 END), ' AND ', ( LS_OFFSET + AV_LIMIT));
END IF;

ELSE 
SET LS_OFFSET_CONDITION = '';
END IF;

SELECT COUNT(1) INTO LI_CA_ADMIN
FROM PERSON_ROLES PR
JOIN ROLE_RIGHTS RR ON PR.ROLE_ID = RR.ROLE_ID
JOIN RIGHTS RT ON RR.RIGHT_ID = RT.RIGHT_ID
WHERE PR.PERSON_ID = AV_LOGIN_PERSON_ID AND RT.RIGHT_NAME = 'CONTRACT_ADMINISTRATOR';

SELECT COUNT(1) INTO LI_CAN_VIEW_PRIVATE_COMMENT
FROM PERSON_ROLES PR
JOIN ROLE_RIGHTS RR ON PR.ROLE_ID = RR.ROLE_ID
JOIN RIGHTS RT ON RR.RIGHT_ID = RT.RIGHT_ID
WHERE PR.PERSON_ID = AV_LOGIN_PERSON_ID AND RT.RIGHT_NAME IN ('VIEW_COI_PRIVATE_COMMENTS','MAINTAIN_COI_PRIVATE_COMMENTS');

SET LS_DYN_SQL = CONCAT(
    LS_DYN_SQL,
    'WITH CommentsCount AS (
        SELECT MODULE_ITEM_KEY, MODULE_CODE, COUNT(*) AS COMMENT_COUNT
        FROM coi_project_comment
        where MODULE_CODE = 1
        GROUP BY MODULE_ITEM_KEY
    ),
	 PersonCommentsCount AS (
        SELECT MODULE_ITEM_KEY, MODULE_CODE,DOCUMENT_OWNER_PERSON_ID,COUNT(*) AS PERSON_COMMENT_COUNT
        FROM DISCL_COMMENT
        where MODULE_CODE = 8 AND PARENT_COMMENT_ID IS NULL
		AND ((',LI_CA_ADMIN,' = 0 AND COMPONENT_TYPE_CODE IN (3, 4, 5, 6, 8, 9, 2, 10, 11, 12)) 
            OR (',LI_CA_ADMIN,' = 1 AND COMPONENT_TYPE_CODE = 12)
        )
		AND ((',LI_CAN_VIEW_PRIVATE_COMMENT,' = 0 AND IS_PRIVATE = ''N'') 
            OR (',LI_CAN_VIEW_PRIVATE_COMMENT,' > 0 AND IS_PRIVATE IN (''Y'',''N''))
        )
        GROUP BY MODULE_ITEM_KEY,DOCUMENT_OWNER_PERSON_ID
    )'
);

SET LS_DYN_SQL = CONCAT(LS_DYN_SQL, '
SELECT * FROM (SELECT 
	T1.PROJECT_ID,
    T1.PROJECT_NUMBER,
    T1.TITLE,
    T1.PI_NAME,
    T1.KEY_PERSON_ID,
    T1.KEY_PERSON_NAME,
    T1.KEY_PERSON_ROLE_CODE,
    T1.KEY_PERSON_ROLE,
    T1.SPONSOR_NAME,
    T1.SPONSOR_CODE,
    T1.PRIME_SPONSOR_NAME,
    T1.PRIME_SPONSOR_CODE,
    T1.LEAD_UNIT_NUMBER,
    T1.LEAD_UNIT_NAME,
    T1.HOME_UNIT,
    T1.HOME_UNIT_NAME,
    T1.AWARD_START_DATE,
    T1.AWARD_END_DATE,
    T1.PROJECT_STATUS,
    T1.DISCLOSURE_ID,
    T1.DISCLOSURE_REVIEW_STATUS,
    T1.FCOI_TYPE_CODE,
    T1.PROJECT_TYPE_CODE,
    T1.PROJECT_TYPE,
    T1.BADGE_COLOR,
    T1.UPDATE_TIMESTAMP,
    null as CERTIFICATION_FLAG,
    T1.DISCLOSURE_REQUIRED_FLAG,
    T1.COMMENT_COUNT ,
    T1.DISCLOSURE_COMPLETION_STATUS,
    T1.PROJECT_ICON,
    T1.DOCUMENT_NUMBER,
    T1.ACCOUNT_NUMBER,
    CASE WHEN T1.DISCLOSURE_STATUS = ''DISCLOSURE_COMPLETED'' THEN ''Completed''
    WHEN T1.DISCLOSURE_STATUS =''DISCLOSURE_NOT_REQUIRED''  THEN ''Not Required''
    WHEN T1.DISCLOSURE_STATUS =''DISCLOSURE_TO_BE_DETERMINED'' THEN ''TO_BE_DETERMINED''
    WHEN T1.DISCLOSURE_STATUS is null AND T1.DISCLOSURE_REQUIRED_FLAG = ''NOT_REQUIRED'' AND T1.RESUBMISSION_FLAG = ''N'' THEN ''Not Required''
    WHEN T1.DISCLOSURE_STATUS is null AND T1.DISCLOSURE_REQUIRED_FLAG = ''NOT_REQUIRED'' AND T1.RESUBMISSION_FLAG = ''Y'' THEN ''Yet to disclose''
    WHEN T1.DISCLOSURE_STATUS is null and T1.DISCLOSURE_REQUIRED_FLAG <> ''REQUIRED'' THEN ''N/A''
    WHEN T1.DISCLOSURE_STATUS = ''DISCLOSURE_PENDING'' THEN ''Pending''
	WHEN T1.DISCLOSURE_STATUS = ''NOT_YET_DISCLOSED'' THEN ''Yet to disclose''
    WHEN T1.DISCLOSURE_STATUS is null AND T1.DISCLOSURE_REQUIRED_FLAG = ''REQUIRED'' AND T1.RESUBMISSION_FLAG = ''Y'' THEN ''Yet to disclose''
    ELSE T1.DISCLOSURE_STATUS
    END AS PERSON_SUBMISSION_STATUS ,
 	CASE WHEN T1.REVIEW_STATUS = ''COMPLETED'' THEN ''Completed''
    WHEN T1.DISCLOSURE_STATUS is null AND T1.DISCLOSURE_REQUIRED_FLAG = ''NOT_REQUIRED'' AND T1.RESUBMISSION_FLAG = ''N'' THEN ''N/A''
    WHEN T1.DISCLOSURE_STATUS is null AND T1.DISCLOSURE_REQUIRED_FLAG = ''NOT_REQUIRED'' AND T1.RESUBMISSION_FLAG = ''Y'' THEN  NULL
    WHEN T1.REVIEW_STATUS =''DISCLOSURE_REVIEW_NA'' THEN ''N/A''
    WHEN T1.REVIEW_STATUS =''DISCLOSURE_TO_BE_DETERMINED'' THEN ''TO_BE_DETERMINED''
	WHEN T1.REVIEW_STATUS = ''DISCLOSURE_PENDING'' THEN ''Pending''
    WHEN T1.DISCLOSURE_STATUS is null OR T1.REVIEW_STATUS IS NULL then null
    ELSE T1.REVIEW_STATUS
    END AS PERSON_REVIEW_STATUS ,
    CASE WHEN T1.PROJECT_SUBMISSION_STATUS = ''DISCLOSURE_COMPLETED'' THEN ''Completed''
    WHEN T1.PROJECT_SUBMISSION_STATUS =''DISCLOSURE_REQUIRED_NOT'' AND T1.RESUBMISSION_FLAG = ''N'' THEN ''Not Required''
    WHEN T1.PROJECT_SUBMISSION_STATUS =''DISCLOSURE_REQUIRED_NOT'' AND T1.RESUBMISSION_FLAG = ''Y'' THEN ''Yet to disclose''
    WHEN T1.PROJECT_SUBMISSION_STATUS =''DISCLOSURE_TO_BE_DETERMINED'' THEN NULL
    WHEN T1.PROJECT_SUBMISSION_STATUS = ''DISCLOSURE_PENDING'' THEN ''Pending''
    WHEN T1.PROJECT_SUBMISSION_STATUS = ''DISCLOSURE_YET_NOT'' THEN ''Yet to disclose''
    ELSE T1.PROJECT_SUBMISSION_STATUS
    END AS PROJECT_SUBMISSION_STATUS ,
    CASE  WHEN T1.PROJECT_SUBMISSION_STATUS = ''DISCLOSURE_PENDING'' 
     AND T1.PROJECT_REVIEW_STATUS =''DISCLOSURE_REVIEW_NA''  THEN NULL
    WHEN T1.PROJECT_SUBMISSION_STATUS = ''DISCLOSURE_PENDING'' 
     AND T1.PROJECT_REVIEW_STATUS IS NOT NULL  THEN ''Pending''
	WHEN T1.PROJECT_SUBMISSION_STATUS = ''DISCLOSURE_YET_NOT''  THEN NULL
    WHEN T1.PROJECT_SUBMISSION_STATUS IS NULL THEN NULL
    WHEN T1.PROJECT_REVIEW_STATUS = ''DISCLOSURE_COMPLETED'' THEN ''Completed''
    WHEN T1.PROJECT_REVIEW_STATUS =''DISCLOSURE_REVIEW_NA'' AND T1.RESUBMISSION_FLAG = ''N'' THEN ''N/A''
    WHEN T1.PROJECT_REVIEW_STATUS =''DISCLOSURE_REVIEW_NA'' AND T1.RESUBMISSION_FLAG = ''Y'' THEN NULL
    WHEN T1.PROJECT_REVIEW_STATUS =''DISCLOSURE_TO_BE_DETERMINED'' THEN NULL
    WHEN T1.PROJECT_REVIEW_STATUS = ''DISCLOSURE_PENDING'' THEN ''Pending''    
    WHEN T1.PROJECT_REVIEW_STATUS = ''NOT_YET_DISCLOSED'' THEN ''N/A''
    ELSE T1.PROJECT_REVIEW_STATUS
    END AS PROJECT_REVIEW_STATUS,
    T1.Complete_count,
     T1.PCK,
     T1.DISCLOSURE_VALIDATION_FLAG,
    T1.SPONSOR_HIERARCY,
    T1.Incomplete_count,
    T1.RESUBMISSION_FLAG,
           (CASE 
        WHEN T1.SPONSOR_HIERARCY = ''YES'' THEN CONCAT(
            "This award is on hold due to ",
            "the sponsor\'s requirement for a disclosure",
            CASE 
                WHEN T1.DISCLOSURE_VALIDATION_FLAG = ''SELF'' THEN ", Disclosure request from the COI administration"
                ELSE \'\'
            END,
            CASE 
                WHEN T1.PCK != ''N/A'' THEN ", and the need for the PI/COI/keyperson to complete their disclosures"
                ELSE \'\'
            END
        )
        WHEN T1.DISCLOSURE_VALIDATION_FLAG = ''SELF'' THEN CONCAT(
            "This award is on hold due to ",
            "Disclosure request from the COI administration",
            CASE 
                WHEN T1.PCK != ''N/A'' THEN ", and the need for the PI/COI/keyperson to complete their disclosures"
                ELSE \'\'
            END
        )
        WHEN T1.PCK != ''N/A'' THEN CONCAT(
            "This award is on hold due to ",
            "the need for the PI/COI/keyperson to complete their disclosures"
        )
        ELSE NULL
    END )as INFO,
    @row_number := IF(@prev_value = T1.PROJECT_ID, @row_number, @row_number + 1) AS rownumber,
	@prev_value := T1.PROJECT_ID AS PROJECT_IDS,
    T1.NON_EMPLOYEE_FLAG,
    T1.PERSON_COMMENT_COUNT	
    FROM
(SELECT DISTINCT 
    T1.EXTERNAL_SYSTEM_REF_ID AS PROJECT_ID,
    T1.AWARD_NUMBER AS PROJECT_NUMBER,
    T1.TITLE,
    T1.PI_NAME,
    T1.KEY_PERSON_ID,
    T1.KEY_PERSON_NAME,
    T1.KEY_PERSON_ROLE_CODE,
    T7.DESCRIPTION AS KEY_PERSON_ROLE,
    T1.SPONSOR_NAME,
    T3.SPONSOR_CODE,
    T1.PRIME_SPONSOR_NAME,
    T4.SPONSOR_CODE AS PRIME_SPONSOR_CODE,
    T1.LEAD_UNIT_NUMBER,
    T1.LEAD_UNIT_NAME,
    T2.HOME_UNIT,
    T8.UNIT_NAME AS HOME_UNIT_NAME,
    T1.AWARD_START_DATE,
    T1.AWARD_END_DATE,
    T1.AWARD_STATUS AS PROJECT_STATUS,
    COALESCE(T55.DISCLOSURE_ID, DP.DISCLOSURE_ID) AS DISCLOSURE_ID,
    COALESCE(T9.DESCRIPTION, CR.DESCRIPTION) AS DISCLOSURE_REVIEW_STATUS,
   COALESCE(T55.FCOI_TYPE_CODE, CD.FCOI_TYPE_CODE) AS FCOI_TYPE_CODE,
    T1.COI_PROJECT_TYPE_CODE AS PROJECT_TYPE_CODE,
    T10.DESCRIPTION AS PROJECT_TYPE,
    T7.SORT_ID ,
    T10.BADGE_COLOR,
    T1.UPDATE_TIMESTAMP,
    null as CERTIFICATION_FLAG,
    T1.DISCLOSURE_REQUIRED_FLAG,
    (SELECT COALESCE(COMMENT_COUNT, 0) FROM CommentsCount WHERE MODULE_ITEM_KEY = T1.AWARD_NUMBER AND MODULE_CODE = T1.COI_PROJECT_TYPE_CODE LIMIT 1) AS COMMENT_COUNT,
    CASE 
        WHEN T55.REVIEW_STATUS_CODE IN (2, 3, 4, 7, 8) OR (T55.REVIEW_STATUS_CODE IS NULL AND CD.REVIEW_STATUS_CODE IN (2, 3, 4, 7, 8))
        THEN "Yes"
        ELSE "No"
    END AS DISCLOSURE_COMPLETION_STATUS,
    T10.PROJECT_ICON,
    T1.DOCUMENT_NUMBER,
    T1.ACCOUNT_NUMBER,
    T1.PCK,
    T1.DISCLOSURE_VALIDATION_FLAG,
    (case when (T1.SPONSOR_CODE IN (SELECT T21.SPONSOR_CODE FROM SPONSOR_DISCLOSURE_REQUIREMENTS T21)
      OR T1.PRIME_SPONSOR_CODE IN (SELECT T21.SPONSOR_CODE FROM SPONSOR_DISCLOSURE_REQUIREMENTS T21) )
      THEN ''YES'' ELSE ''NO'' END) AS SPONSOR_HIERARCY,

(SELECT FN_GET_OVRAL_AWD_PRJT_DISCL_RVW_STATUS(T1.EXTERNAL_SYSTEM_REF_ID)) AS PROJECT_REVIEW_STATUS,
(SELECT FN_GET_OVAL_AWD_PRJT_DISCL_STATUS(T1.EXTERNAL_SYSTEM_REF_ID)) AS PROJECT_SUBMISSION_STATUS,
    COUNT(CASE WHEN DAP.DISCLOSURE_STATUS = ''DISCLOSURE_COMPLETED'' THEN 1 END) AS complete_count,
    COUNT(CASE WHEN DAP.DISCLOSURE_STATUS != ''DISCLOSURE_COMPLETED'' THEN 1 END) AS Incomplete_count,
    (SELECT DISCLOSURE_STATUS FROM DisclosureAwardProjects WHERE PROJECT_ID = T1.EXTERNAL_SYSTEM_REF_ID AND  KEY_PERSON_ID = T1.KEY_PERSON_ID LIMIT 1) AS DISCLOSURE_STATUS,
	(SELECT PROJECT_DISCLOSURE_REVIEW_STATUS FROM DisclosureAwardProjects WHERE PROJECT_ID = T1.EXTERNAL_SYSTEM_REF_ID AND  KEY_PERSON_ID = T1.KEY_PERSON_ID LIMIT 1 ) AS REVIEW_STATUS,
     (CASE
    WHEN EXISTS (SELECT 1 FROM coi_int_stage_award_person WHERE PROJECT_NUMBER = T1.AWARD_NUMBER AND NEW_DISCLOSURE_REQUIRED = ''Y'' AND STATUS != ''I''
    AND ATTRIBUTE_1_VALUE = ''N'') THEN ''Y''
    ELSE ''N''
  END) AS RESUBMISSION_FLAG,
  T1.NON_EMPLOYEE_FLAG,
  COALESCE(PC.PERSON_COMMENT_COUNT, 0) AS PERSON_COMMENT_COUNT
	FROM coi_project_award_v T1		
	 ',IFNULL(LS_JOIN_CONDITION,''), '
     LEFT JOIN DisclosureAwardProjects DAP ON DAP.PROJECT_ID = T1.EXTERNAL_SYSTEM_REF_ID
     LEFT JOIN DisclosureAwardProjects DP ON DP.PROJECT_ID = T1.EXTERNAL_SYSTEM_REF_ID AND DP.KEY_PERSON_ID = T1.KEY_PERSON_ID
     LEFT JOIN COI_DISCLOSURE CD ON CD.DISCLOSURE_ID = DP.DISCLOSURE_ID
     LEFT JOIN COI_REVIEW_STATUS_TYPE CR ON CR.REVIEW_STATUS_CODE = CD.REVIEW_STATUS_CODE
	 LEFT JOIN PersonCommentsCount PC ON (PC.MODULE_ITEM_KEY = T55.DISCLOSURE_ID  
     or (T55.DISCLOSURE_ID IS NULL AND PC.MODULE_ITEM_KEY = CD.DISCLOSURE_ID)) AND PC.DOCUMENT_OWNER_PERSON_ID = T1.KEY_PERSON_ID
	WHERE PERSON_STATUS != ''I'' ',IFNULL(LS_FILTER_CONDITION,''), ' GROUP BY T1.EXTERNAL_SYSTEM_REF_ID , T1.KEY_PERSON_ID,T1.KEY_PERSON_ROLE_CODE )T1',ifnull(LS_ORDER_BY,''),' )T ',IFNULL(LS_OFFSET_CONDITION,''),' ');

 
 IF AV_UNLIMITED = TRUE THEN

    SET LS_DYN_SQL = CONCAT('SELECT count(distinct PROJECT_ID) AS AWARD_COUNT FROM ( ',LS_DYN_SQL,' ) T');

 END IF;

SET @row_number = 0;
SET @prev_value = NULL;									   
	   
SET @QUERY_STATEMENT = LS_DYN_SQL;
PREPARE EXECUTABLE_STAEMENT FROM @QUERY_STATEMENT;
EXECUTE EXECUTABLE_STAEMENT;


END