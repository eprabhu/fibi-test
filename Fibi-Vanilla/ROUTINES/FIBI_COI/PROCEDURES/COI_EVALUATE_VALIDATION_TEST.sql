


CREATE PROCEDURE `COI_EVALUATE_VALIDATION_TEST`(
  AV_DISCLOSURE_ID INT,
  AV_PERSON_ID VARCHAR(45)
)
BEGIN
  DECLARE LI_QUESTIONNAIRE_FLAG INT; 
  DECLARE LI_SFI_FLAG INT;
  DECLARE LI_RELATIONSHIP_FLAG INT;
  DECLARE LS_ERROR_MSG VARCHAR(2000);
  DECLARE LS_SFI_LIST VARCHAR(2000);
  DECLARE LS_PROJ_SFI_LIST LONGTEXT;
  DECLARE LI_LOCK_ACQUIRED INT DEFAULT 0;

  START TRANSACTION;
  SELECT GET_LOCK('coi_sfi_projects_lock', 30) INTO LI_LOCK_ACQUIRED;
  IF LI_LOCK_ACQUIRED = 1 THEN

    CREATE TEMPORARY TABLE IF NOT EXISTS ERROR_MESSAGE (
      VALIDATION_TYPE VARCHAR(3),
      VALIDATION_MSG_TYPE VARCHAR(3),
      MESSAGE VARCHAR(2000),
      SFIs VARCHAR(2000),
      PROJ_SFI_DETAILS LONGTEXT
    );

    SET LI_QUESTIONNAIRE_FLAG = FN_EVAL_DISCLOSURE_QUESTIONNAIRE(8, 0, AV_DISCLOSURE_ID);

    IF LI_QUESTIONNAIRE_FLAG = 1 THEN
      SELECT COUNT(*) > 0 INTO LI_SFI_FLAG 
      FROM PERSON_ENTITY 
      WHERE PERSON_ID = AV_PERSON_ID
      AND VERSION_STATUS = 'ACTIVE';

      IF NOT LI_SFI_FLAG THEN
        SET LS_ERROR_MSG = "You have not added any SFI(s). Based on your screening questionnaire, you have to add at least one SFI to continue with disclosure.";
        INSERT INTO ERROR_MESSAGE(VALIDATION_TYPE, VALIDATION_MSG_TYPE, MESSAGE) 
        VALUES ('VE', 'QM', LS_ERROR_MSG);
      END IF;
    END IF;
  
    SET LI_SFI_FLAG = 0;
  
    SELECT COUNT(*) = 0 INTO LI_RELATIONSHIP_FLAG
    FROM COI_DISCL_ENT_PROJ_DETAILS T1
    INNER JOIN PERSON_ENTITY_RELATIONSHIP T2 ON T1.PERSON_ENTITY_ID = T2.PERSON_ENTITY_ID
    INNER JOIN VALID_PERSON_ENTITY_REL_TYPE T3 ON T2.VALID_PERS_ENTITY_REL_TYP_CODE = T3.VALID_PERS_ENTITY_REL_TYP_CODE
    WHERE T1.DISCLOSURE_ID = AV_DISCLOSURE_ID
    AND T1.PROJECT_CONFLICT_STATUS_CODE IS NULL
    AND T1.PERSON_ENTITY_ID IS NOT NULL
    AND T3.DISCLOSURE_TYPE_CODE = 1;

    IF NOT LI_RELATIONSHIP_FLAG THEN
      SET LS_SFI_LIST = '';

      INSERT INTO ERROR_MESSAGE (VALIDATION_TYPE, VALIDATION_MSG_TYPE, MESSAGE, PROJ_SFI_DETAILS)
      SELECT DISTINCT 'VE' AS VALIDATION_TYPE, 'PS' AS VALIDATION_MSG_TYPE, 
             'You have undefined Project-SFI relationships. Kindly complete the Relationships section to certify the disclosure.' AS LS_ERROR_MSG,
             CONCAT(
               'DisclDetailId:: ', CONVERT(T1.DISCLOSURE_DETAILS_ID USING utf8mb4), '||', 
               'Title:: ', COALESCE(CONVERT(T2.TITLE USING utf8mb4), CONVERT(T3.TITLE USING utf8mb4), CONVERT(T6.TITLE USING utf8mb4)), '||', 
               'Entity:: ', CONVERT(T4.ENTITY_NAME USING utf8mb4), '||',
               'ModuleCode:: ', COALESCE(CONVERT(T2.COI_PROJECT_TYPE_CODE USING utf8mb4), CONVERT(T3.COI_PROJECT_TYPE_CODE USING utf8mb4), CONVERT(T6.COI_PROJECT_TYPE_CODE USING utf8mb4)), '||',
               'ModuleItemKey:: ', COALESCE(CONVERT(T2.EXTERNAL_SYSTEM_REF_ID USING utf8mb4), CONVERT(T3.EXTERNAL_SYSTEM_REF_ID USING utf8mb4), CONVERT(T6.EXTERNAL_SYSTEM_REF_ID USING utf8mb4))
             ) AS LS_PROJ_SFI_LIST
      FROM COI_DISCL_ENT_PROJ_DETAILS T1
      INNER JOIN PERSON_ENTITY_RELATIONSHIP T5 ON T5.PERSON_ENTITY_ID = T1.PERSON_ENTITY_ID AND T5.VALID_PERS_ENTITY_REL_TYP_CODE IN (1,2,3)
      LEFT JOIN COI_PROJECT_AWARD_V T2 ON T2.EXTERNAL_SYSTEM_REF_ID = T1.MODULE_ITEM_KEY AND T1.MODULE_CODE = 1
      LEFT JOIN COI_PROJECT_PROPOSAL_V T3 ON T3.EXTERNAL_SYSTEM_REF_ID = T1.MODULE_ITEM_KEY AND T1.MODULE_CODE = 3
      LEFT JOIN coi_project_institute_proposal_v T6 ON T6.EXTERNAL_SYSTEM_REF_ID = T1.MODULE_ITEM_KEY AND T1.MODULE_CODE = 2
      INNER JOIN ENTITY T4 ON T4.ENTITY_ID = T1.ENTITY_ID
      WHERE T1.DISCLOSURE_ID = AV_DISCLOSURE_ID 
      AND T1.PROJECT_CONFLICT_STATUS_CODE IS NULL 
      AND T1.PERSON_ENTITY_ID IS NOT NULL;

      SET LS_ERROR_MSG = "You have undefined Project-SFI relationships. Kindly complete the Relationships section to certify the disclosure.";
    END IF;

    SELECT COUNT(*) > 0 INTO LI_SFI_FLAG 
    FROM COI_DISCL_ENT_PROJ_DETAILS T1 
    INNER JOIN PERSON_ENTITY T2 ON T2.PERSON_ENTITY_ID = T1.PERSON_ENTITY_ID 
    INNER JOIN ENTITY T3 ON T3.ENTITY_NUMBER = T2.ENTITY_NUMBER 
    WHERE T1.DISCLOSURE_ID = AV_DISCLOSURE_ID 
    AND T2.ENTITY_ID != T3.ENTITY_ID 
    AND T3.IS_ACTIVE IN ('N', 'Y')
    AND T3.VERSION_STATUS = 'ACTIVE';

    IF LI_SFI_FLAG THEN
      SET LS_PROJ_SFI_LIST = '';

      SELECT GROUP_CONCAT(DISTINCT CONCAT(CONVERT(T2.PERSON_ENTITY_ID USING utf8mb4), '||', CONVERT(T4.ENTITY_NAME USING utf8mb4)) SEPARATOR ':;:') INTO LS_PROJ_SFI_LIST
      FROM COI_DISCL_ENT_PROJ_DETAILS T1 
      INNER JOIN PERSON_ENTITY T2 ON T2.PERSON_ENTITY_ID = T1.PERSON_ENTITY_ID 
      INNER JOIN ENTITY T3 ON T3.ENTITY_NUMBER = T2.ENTITY_NUMBER 
      INNER JOIN ENTITY T4 ON T4.ENTITY_ID = T1.ENTITY_ID 
      WHERE T1.DISCLOSURE_ID = AV_DISCLOSURE_ID 
      AND T2.ENTITY_ID != T3.ENTITY_ID 
      AND T3.IS_ACTIVE IN ('N', 'Y') 
      AND T3.VERSION_STATUS = 'ACTIVE';

      SET LS_ERROR_MSG = "You have unrevised SFI(s) in your SFI list for recently modified Entity(s). Kindly revise the SFI or inactivate the SFI to proceed and certify the disclosure.";
      INSERT INTO ERROR_MESSAGE (VALIDATION_TYPE, VALIDATION_MSG_TYPE, MESSAGE, SFIs) 
      VALUES ('VE', 'RS', LS_ERROR_MSG, LS_PROJ_SFI_LIST);
    END IF;

    INSERT INTO ERROR_MESSAGE (VALIDATION_TYPE, VALIDATION_MSG_TYPE, MESSAGE, PROJ_SFI_DETAILS)
    SELECT DISTINCT 'VW' AS VALIDATION_TYPE, 'PS' AS VALIDATION_MSG_TYPE,  
           "Your SFIs were altered or modified. If required, please make necessary changes." AS LS_ERROR_MSG,
           CONCAT(
             'DisclDetailId:: ', CONVERT(T1.DISCLOSURE_DETAILS_ID USING utf8mb4), '||', 
             'Title:: ', COALESCE(CONVERT(T5.TITLE USING utf8mb4), CONVERT(T6.TITLE USING utf8mb4), CONVERT(T8.TITLE USING utf8mb4)), '||', 
             'Entity:: ', CONVERT(T7.ENTITY_NAME USING utf8mb4), '||',
             'ModuleCode:: ', COALESCE(CONVERT(T5.COI_PROJECT_TYPE_CODE USING utf8mb4), CONVERT(T6.COI_PROJECT_TYPE_CODE USING utf8mb4), CONVERT(T8.COI_PROJECT_TYPE_CODE USING utf8mb4)), '||',
             'ModuleItemKey:: ', COALESCE(CONVERT(T5.EXTERNAL_SYSTEM_REF_ID USING utf8mb4), CONVERT(T6.EXTERNAL_SYSTEM_REF_ID USING utf8mb4), CONVERT(T8.EXTERNAL_SYSTEM_REF_ID USING utf8mb4))
           ) AS LS_PROJ_SFI_LIST
    FROM COI_DISCL_ENT_PROJ_DETAILS T1
    INNER JOIN PERSON_ENTITY T2 ON T2.PERSON_ENTITY_NUMBER = T1.PERSON_ENTITY_NUMBER
    LEFT JOIN COI_PROJECT_AWARD_V T5 ON T5.EXTERNAL_SYSTEM_REF_ID = T1.MODULE_ITEM_KEY AND T1.MODULE_CODE = 1
    LEFT JOIN COI_PROJECT_PROPOSAL_V T6 ON T6.EXTERNAL_SYSTEM_REF_ID = T1.MODULE_ITEM_KEY AND T1.MODULE_CODE = 3
    LEFT JOIN coi_project_institute_proposal_v T8 ON T8.EXTERNAL_SYSTEM_REF_ID = T1.MODULE_ITEM_KEY AND T1.MODULE_CODE = 2
    INNER JOIN ENTITY T7 ON T7.ENTITY_ID = T1.ENTITY_ID
    WHERE T1.DISCLOSURE_ID = AV_DISCLOSURE_ID 
    AND T1.PROJECT_CONFLICT_STATUS_CODE IS NULL 
    AND T1.PERSON_ENTITY_NUMBER IS NOT NULL;

  SELECT VALIDATION_TYPE, VALIDATION_MSG_TYPE, MESSAGE, SFIs, PROJ_SFI_DETAILS FROM ERROR_MESSAGE;

    DROP TEMPORARY TABLE IF EXISTS ERROR_MESSAGE;
 COMMIT;
 SET LI_LOCK_ACQUIRED = RELEASE_LOCK('coi_sfi_projects_lock');
 	SELECT '1';
 ELSE
         SELECT 'Unable to acquire lock. Another process may sync the projects vs entity.';

 END IF;
END