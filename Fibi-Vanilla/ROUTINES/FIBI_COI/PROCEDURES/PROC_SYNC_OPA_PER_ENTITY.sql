

CREATE PROCEDURE `PROC_SYNC_OPA_PER_ENTITY`(IN AV_OPA_DISCLOSURE_ID INT, IN AV_UPDATE_USER VARCHAR(60))
BEGIN
    DECLARE LS_PERSON_ID VARCHAR(20);
    DECLARE LS_OPA_STATUS VARCHAR(3);
    
    SELECT PERSON_ID, REVIEW_STATUS_CODE
	INTO LS_PERSON_ID, LS_OPA_STATUS
    FROM OPA_DISCLOSURE
    WHERE OPA_DISCLOSURE_ID = AV_OPA_DISCLOSURE_ID;
	
	
    IF FIND_IN_SET(LS_OPA_STATUS, '1,5,6') < 1 THEN
        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Status code is not In Progress state. Exiting procedure.';
    END IF;



    
    INSERT INTO OPA_DISCL_PERSON_ENTITY (OPA_DISCLOSURE_ID, PERSON_ENTITY_ID, PERSON_ENTITY_NUMBER, ENTITY_ID, ENTITY_NUMBER,UPDATE_TIMESTAMP, UPDATE_USER)
	 SELECT
        AV_OPA_DISCLOSURE_ID,
        T.PERSON_ENTITY_ID,
		T.PERSON_ENTITY_NUMBER,
        T.ENTITY_ID,
        T.ENTITY_NUMBER,
        utc_timestamp(),
        AV_UPDATE_USER
	
	FROM
	(
		
		SELECT DISTINCT
			t0.PERSON_ENTITY_ID,
			t0.ENTITY_ID,
			t0.ENTITY_NUMBER,
			t0.PERSON_ENTITY_NUMBER
		FROM PERSON_ENTITY t0
		INNER JOIN person_entity_relationship t1 ON t1.PERSON_ENTITY_ID = t0.PERSON_ENTITY_ID
		INNER JOIN VALID_PERSON_ENTITY_REL_TYPE t2 ON t1.VALID_PERS_ENTITY_REL_TYP_CODE = t2.VALID_PERS_ENTITY_REL_TYP_CODE
		WHERE t2.VALID_PERS_ENTITY_REL_TYP_CODE IN ('1' ,'5')  
		AND t0.VERSION_STATUS = 'ACTIVE'
		AND t0.PERSON_ID = LS_PERSON_ID
		AND t0.PERSON_ENTITY_NUMBER NOT IN (
											SELECT s1.PERSON_ENTITY_NUMBER 
											FROM OPA_DISCL_PERSON_ENTITY s1													
											WHERE s1.OPA_DISCLOSURE_ID = AV_OPA_DISCLOSURE_ID
									   )
	) T;
                                              
	
	
	
	
	INSERT INTO OPA_DISCL_ACTIVITIES(OPA_DISCLOSURE_ID,OPA_DISCL_PERSON_ENTITY_ID,IS_COMPENSATED,NUM_OF_DAYS_SUMMER,NUM_OF_DAYS_ACADEMIC,NUM_OF_DAYS_IN_YEAR,NATURE_OF_WORK,UPDATE_TIMESTAMP,UPDATE_USER)
	
	SELECT distinct AV_OPA_DISCLOSURE_ID,t.OPA_DISCL_PERSON_ENTITY_ID,'Y',NULL,NULL,NULL,
	CONCAT(t0.STUDENT_INVOLVEMENT,t0.INSTITUTE_RESOURCE_INVOLVEMENT, t0.STAFF_INVOLVEMENT) AS NATURE_OF_WORK,
	utc_timestamp(),AV_UPDATE_USER	
    FROM OPA_DISCL_PERSON_ENTITY t
    INNER JOIN person_entity t0 ON t.PERSON_ENTITY_ID = t0.PERSON_ENTITY_ID
    INNER JOIN person_entity_relationship t1 ON t1.PERSON_ENTITY_ID = t0.PERSON_ENTITY_ID
    INNER JOIN VALID_PERSON_ENTITY_REL_TYPE t2 ON t1.VALID_PERS_ENTITY_REL_TYP_CODE = t2.VALID_PERS_ENTITY_REL_TYP_CODE
    WHERE t2.VALID_PERS_ENTITY_REL_TYP_CODE = '5' 
    AND t.OPA_DISCLOSURE_ID = AV_OPA_DISCLOSURE_ID
    AND t.OPA_DISCL_PERSON_ENTITY_ID NOT IN (
											SELECT OPA_DISCL_PERSON_ENTITY_ID	
                                            FROM OPA_DISCL_ACTIVITIES 
                                            WHERE OPA_DISCLOSURE_ID = AV_OPA_DISCLOSURE_ID
									);


	
	INSERT INTO OPA_OUTSIDE_FIN_INTERESTS(OPA_DISCLOSURE_ID,OPA_DISCL_PERSON_ENTITY_ID,PERSON_REL_WITH_ENTITY,ENTITY_REL_WITH_INSTITUTE,UPDATE_TIMESTAMP,UPDATE_USER)
	
	SELECT distinct AV_OPA_DISCLOSURE_ID,t.OPA_DISCL_PERSON_ENTITY_ID,NULL,NULL,utc_timestamp(),AV_UPDATE_USER	
    FROM OPA_DISCL_PERSON_ENTITY t
    INNER JOIN person_entity t0 ON t.PERSON_ENTITY_ID = t0.PERSON_ENTITY_ID
    INNER JOIN person_entity_relationship t1 ON t1.PERSON_ENTITY_ID = t0.PERSON_ENTITY_ID
    INNER JOIN VALID_PERSON_ENTITY_REL_TYPE t2 ON t1.VALID_PERS_ENTITY_REL_TYP_CODE = t2.VALID_PERS_ENTITY_REL_TYP_CODE
    WHERE t2.VALID_PERS_ENTITY_REL_TYP_CODE IN ('1' ,'5') 
    AND t.OPA_DISCLOSURE_ID = AV_OPA_DISCLOSURE_ID
    AND t.OPA_DISCL_PERSON_ENTITY_ID NOT IN (
											SELECT OPA_DISCL_PERSON_ENTITY_ID	
                                            FROM OPA_OUTSIDE_FIN_INTERESTS 
                                            WHERE OPA_DISCLOSURE_ID = AV_OPA_DISCLOSURE_ID
									);
		
	
	
	UPDATE opa_discl_person_entity s0
	JOIN (
	SELECT 
		t0.PERSON_ENTITY_NUMBER,
		t0.PERSON_ENTITY_ID,
		t0.ENTITY_ID
	FROM person_entity t0
	WHERE t0.VERSION_STATUS = 'ACTIVE'
	AND t0.PERSON_ID = LS_PERSON_ID
	GROUP BY t0.PERSON_ENTITY_NUMBER
	) AS s1
	ON s0.PERSON_ENTITY_NUMBER = s1.PERSON_ENTITY_NUMBER 

	SET s0.PERSON_ENTITY_ID = s1.PERSON_ENTITY_ID, s0.ENTITY_ID = s1.ENTITY_ID
	WHERE s0.OPA_DISCLOSURE_ID = AV_OPA_DISCLOSURE_ID
	AND	s0.PERSON_ENTITY_ID <> s1.PERSON_ENTITY_ID;								
	
	 DELETE t3, t2, t1 FROM opa_discl_person_entity t0
	 INNER JOIN PERSON_ENTITY t ON t.PERSON_ENTITY_NUMBER = t0.PERSON_ENTITY_NUMBER
	 LEFT JOIN OPA_OUTSIDE_FIN_INTERESTS t1 ON t1.OPA_DISCL_PERSON_ENTITY_ID = t0.OPA_DISCL_PERSON_ENTITY_ID
	 LEFT JOIN OPA_DISCL_ACTIVITIES t2 ON t2.OPA_DISCL_PERSON_ENTITY_ID = t0.OPA_DISCL_PERSON_ENTITY_ID
	 LEFT JOIN opa_institute_resource_use t3 ON t3.OPA_DISCL_PERSON_ENTITY_ID = t0.OPA_DISCL_PERSON_ENTITY_ID
	 WHERE t0.OPA_DISCLOSURE_ID = AV_OPA_DISCLOSURE_ID AND (t.VERSION_STATUS = 'INACTIVE');

	 DELETE t0 FROM opa_discl_person_entity t0
	 INNER JOIN PERSON_ENTITY t ON t.PERSON_ENTITY_NUMBER = t0.PERSON_ENTITY_NUMBER
	 WHERE t0.OPA_DISCLOSURE_ID = AV_OPA_DISCLOSURE_ID AND (t.VERSION_STATUS = 'INACTIVE');
	 
	 select 1;
	 
END
