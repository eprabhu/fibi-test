

CREATE FUNCTION `FN_CAN_NOTIFY_FOR_CREATE_AWD_DISCL`(
    AV_PERSON_ID VARCHAR(60),
    AV_MODULE_CODE INT,
    AV_SUB_MODULE_CODE INT,
    AV_MODULE_ITEM_KEY VARCHAR(200),
    AV_SUB_MODULE_ITEM_KEY VARCHAR(200)
) RETURNS tinyint(1)
    DETERMINISTIC
BEGIN
    DECLARE LI_COUNT INT;
	DECLARE LS_DISCLOSURE_VALIDATION_FLAG VARCHAR(200);
	DECLARE LS_REQUIRED_FLAG VARCHAR(200);
    DECLARE MODULE_PREFIX VARCHAR(200);

    SET MODULE_PREFIX = SUBSTRING_INDEX(AV_MODULE_ITEM_KEY, '-', 1);
		
		-- Check for non-employee person
		SELECT COUNT(T1.PROJECT_NUMBER) INTO LI_COUNT
		FROM COI_INT_STAGE_AWARD T1
		INNER JOIN COI_INT_STAGE_AWARD_PERSON T2 ON T2.PROJECT_NUMBER = T1.PROJECT_NUMBER
		WHERE T2.KEY_PERSON_ID = AV_PERSON_ID AND T2.STATUS = 'A' AND T2.ATTRIBUTE_1_VALUE = 'Y' AND T1.PROJECT_NUMBER = AV_MODULE_ITEM_KEY  AND T1.PROJECT_STATUS_CODE IN (1, 6, 3);
		  
		  IF LI_COUNT > 0 THEN
			
			RETURN FALSE; 
			
		  END IF;
		
		SELECT COUNT(T1.PROJECT_NUMBER) INTO LI_COUNT 
		FROM COI_INT_STAGE_AWARD T1
		WHERE T1.PROJECT_NUMBER = AV_MODULE_ITEM_KEY AND T1.PROJECT_STATUS_CODE IN (1, 6, 3);
		  
		  IF LI_COUNT = 0 THEN
			
			RETURN FALSE; 
			
		  END IF;
		
		SELECT T1.DISCLOSURE_VALIDATION_FLAG,T2.DISCLOSURE_REQUIRED_FLAG INTO LS_DISCLOSURE_VALIDATION_FLAG,LS_REQUIRED_FLAG
		FROM COI_INT_STAGE_AWARD T1
		INNER JOIN COI_INT_STAGE_AWARD_PERSON T2 ON T2.PROJECT_NUMBER = T1.PROJECT_NUMBER
		WHERE T2.KEY_PERSON_ID = AV_PERSON_ID AND T2.STATUS = 'A' AND T1.PROJECT_NUMBER = AV_MODULE_ITEM_KEY  AND T1.PROJECT_STATUS_CODE IN (1, 6, 3);
		  
		IF LS_DISCLOSURE_VALIDATION_FLAG = 'SELF' THEN
		
			SELECT COUNT(INBOX_ID) INTO LI_COUNT
			FROM INBOX T1
			WHERE TO_PERSON_ID = AV_PERSON_ID AND MODULE_CODE = AV_MODULE_CODE 
			AND SUB_MODULE_CODE = AV_SUB_MODULE_CODE AND SUB_MODULE_ITEM_KEY = AV_SUB_MODULE_ITEM_KEY
			AND OPENED_FLAG = 'N' AND MODULE_ITEM_KEY = AV_MODULE_ITEM_KEY; 
			  
			  IF LI_COUNT = 0 THEN  
		
				RETURN TRUE;
			
			END IF;
				
		ELSEIF LS_REQUIRED_FLAG = 'REQUIRED' AND (LS_DISCLOSURE_VALIDATION_FLAG IS NULL OR LS_DISCLOSURE_VALIDATION_FLAG = 'HIERARCHY') THEN
			
				SELECT COUNT(T1.DISCLOSURE_ID) INTO LI_COUNT
				FROM COI_DISCLOSURE T1
				INNER JOIN COI_DISCL_PROJECTS T2 ON T2.DISCLOSURE_ID = T1.DISCLOSURE_ID
				WHERE T1.PERSON_ID = AV_PERSON_ID AND T2.MODULE_CODE = 1
				AND SUBSTRING_INDEX(MODULE_ITEM_KEY, '-', 1) = MODULE_PREFIX;			   
				  
				IF LI_COUNT = 0 THEN  
				
				SELECT COUNT(INBOX_ID) INTO LI_COUNT
				FROM INBOX T1
				WHERE TO_PERSON_ID = AV_PERSON_ID AND MODULE_CODE = AV_MODULE_CODE
				  AND SUB_MODULE_CODE = AV_SUB_MODULE_CODE AND SUB_MODULE_ITEM_KEY = AV_SUB_MODULE_ITEM_KEY
				  AND OPENED_FLAG = 'N' AND SUBSTRING_INDEX(MODULE_ITEM_KEY, '-', 1) = MODULE_PREFIX;
			
					IF LI_COUNT = 0 THEN  
						RETURN TRUE;
					END IF;
				
				END IF;
			
		
		END IF;
		
		RETURN FALSE;
		

    
END
