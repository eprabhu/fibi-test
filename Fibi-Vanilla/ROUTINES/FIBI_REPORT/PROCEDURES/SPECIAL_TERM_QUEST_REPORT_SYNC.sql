-- `SPECIAL_TERM_QUEST_REPORT_SYNC`; 

CREATE PROCEDURE `SPECIAL_TERM_QUEST_REPORT_SYNC`(AV_MODULE_ITEM_KEY INT)
BEGIN
DECLARE LS_DYN_SQL LONGTEXT;
DECLARE LS_DYN_SQL_SEL LONGTEXT;
DECLARE LS_SEL_STMT LONGTEXT;
DECLARE DONE1 INT DEFAULT FALSE;
DECLARE CUR_SEL CURSOR FOR
	SELECT CONCAT('MAX(CASE WHEN T1.QUESTION_NUMBER =', Q1.QUESTION_NUMBER,' THEN S1.ANSWER END) AS `',Q1.SORT_ORDER, '`')
	FROM QUEST_QUESTION Q1
    LEFT OUTER JOIN QUEST_HEADER QH ON Q1.QUESTIONNAIRE_ID = QH.QUESTIONNAIRE_ID
	WHERE Q1.QUESTIONNAIRE_ID = QH.QUESTIONNAIRE_ID AND QH.IS_FINAL ='Y' AND QH.QUESTIONNAIRE_NUMBER = 123
    ORDER BY Q1.SORT_ORDER;
	DECLARE CONTINUE HANDLER FOR NOT FOUND SET DONE1 = TRUE;
	OPEN CUR_SEL;
	INSERT_LOOP1: LOOP
	FETCH CUR_SEL INTO
	LS_DYN_SQL_SEL;
	IF DONE1 THEN
			LEAVE INSERT_LOOP1;
	END IF;
	SET LS_SEL_STMT:= CONCAT(IFNULL(LS_SEL_STMT,''),',',LS_DYN_SQL_SEL);
	END LOOP;
	CLOSE CUR_SEL;
	SELECT TRIM(TRAILING ',' FROM LS_SEL_STMT) INTO LS_SEL_STMT FROM DUAL;
    
    IF AV_MODULE_ITEM_KEY IS NOT NULL THEN
		SET LS_DYN_SQL = CONCAT('DELETE FROM SPECIAL_TERM_QUEST_REPORT_DATASET T2
								WHERE T2.AGREEMENT_ID IN(', AV_MODULE_ITEM_KEY, ')');
        SET @QUERY_STATEMENT = LS_DYN_SQL;
		PREPARE EXECUTABLE_STAEMENT FROM @QUERY_STATEMENT;
		EXECUTE EXECUTABLE_STAEMENT;
	ELSE
        SET LS_DYN_SQL = CONCAT('TRUNCATE TABLE SPECIAL_TERM_QUEST_REPORT_DATASET; ');
        SET @QUERY_STATEMENT = LS_DYN_SQL;
		PREPARE EXECUTABLE_STAEMENT FROM @QUERY_STATEMENT;
		EXECUTE EXECUTABLE_STAEMENT;
	END IF;
	SET LS_DYN_SQL = CONCAT(' INSERT INTO SPECIAL_TERM_QUEST_REPORT_DATASET (AGREEMENT_ID,
										RESEARCH_TITLE,
										START_DATE,
										END_DATE,
										AGREEMENT_TYPE,
										AGREEMENT_CATEGORY,
										PI,
										SPONSOR,
										LEAD_UNIT,
										ADMINISTRATOR,
										ADMIN_GROUP,
										STATUS,
										SUBMISSION_DATE,
										REQUESTOR,
										Q_6874,
										Q_6875,
										Q_6876,
										Q_6878,
										Q_6879,
                                        Q_6880,
                                        Q_6881,
                                        Q_6882) 
	SELECT  AH.AGREEMENT_REQUEST_ID, 
			AH.TITLE, 
            AH.START_DATE, 
            AH.END_DATE ,
            AT.DESCRIPTION,
            AC.DESCRIPTION,
            AP.FULL_NAME,
            SP.SPONSOR,
            U.DISPLAY_NAME,
            AH.ADMIN_PERSON_NAME,
            AG.DESCRIPTION,
            AGS.DESCRIPTION,
            S1.SUBMISSION_DATE,
            AH.REQUESTOR_NAME
            ', LS_SEL_STMT, ' 
    FROM QUEST_QUESTION T1
	LEFT JOIN(SELECT
				T3.QUESTION_ID,
				T2.MODULE_ITEM_KEY,
                CASE WHEN T2.QUESTIONNAIRE_COMPLETED_FLAG=''Y'' THEN T2.UPDATE_TIMESTAMP ELSE NULL END AS SUBMISSION_DATE,
				SPECIAL_TERM_QUEST_REPORT_ANSWER(T2.MODULE_ITEM_KEY, T3.QUESTION_ID) AS ANSWER
				FROM QUEST_ANSWER_HEADER T2
				LEFT JOIN QUEST_ANSWER T3 ON T2.QUESTIONNAIRE_ANS_HEADER_ID = T3.QUESTIONNAIRE_ANS_HEADER_ID
				WHERE T2.MODULE_ITEM_CODE = 13
				AND T2.QUESTIONNAIRE_ID = (SELECT MAX(S.QUESTIONNAIRE_ID) FROM QUEST_ANSWER_HEADER S 
											INNER JOIN QUEST_HEADER T5 ON S.QUESTIONNAIRE_ID = T5.QUESTIONNAIRE_ID 
											WHERE S.MODULE_ITEM_KEY = T2.MODULE_ITEM_KEY 
											AND T5.QUESTIONNAIRE_NUMBER = 123
											AND S.MODULE_ITEM_CODE = 13) 
                AND T2.MODULE_ITEM_KEY IN(',CASE WHEN AV_MODULE_ITEM_KEY IS NOT NULL THEN AV_MODULE_ITEM_KEY ELSE 'SELECT AGREEMENT_REQUEST_ID FROM AGREEMENT_HEADER' END, ')
				GROUP BY T3.QUESTION_ID,T3.QUESTIONNAIRE_ANS_HEADER_ID
				)S1 ON T1.QUESTION_ID = S1.QUESTION_ID
	INNER JOIN AGREEMENT_HEADER AH ON AH.AGREEMENT_REQUEST_ID = S1.MODULE_ITEM_KEY
    LEFT JOIN AGREEMENT_TYPE AT ON AT.AGREEMENT_TYPE_CODE = AH.AGREEMENT_TYPE_CODE
	LEFT JOIN AGREEMENT_CATEGORY AC ON AC.CATEGORY_CODE = AH.CATEGORY_CODE
    LEFT JOIN AGREEMENT_PEOPLE AP ON AP.AGREEMENT_REQUEST_ID = AH.AGREEMENT_REQUEST_ID AND PEOPLE_TYPE_ID = 3
    LEFT JOIN (SELECT T31.AGREEMENT_REQUEST_ID, T32.DISPLAY_NAME AS SPONSOR
                                   FROM AGREEMENT_SPONSOR T31 
                                   INNER JOIN SPONSOR T32 ON T31.SPONSOR_CODE = T32.SPONSOR_CODE 
                                   WHERE AGREEMENT_SPONSOR_TYPE_CODE = 1) SP ON SP.AGREEMENT_REQUEST_ID = AH.AGREEMENT_REQUEST_ID
    LEFT JOIN UNIT U ON U.UNIT_NUMBER = AH.UNIT_NUMBER
    LEFT JOIN ADMIN_GROUP AG ON AG.ADMIN_GROUP_ID = AH.ADMIN_GROUP_ID
    LEFT JOIN AGREEMENT_STATUS AGS ON AGS.AGREEMENT_STATUS_CODE = AH.AGREEMENT_STATUS_CODE
	WHERE T1.QUESTIONNAIRE_ID = (SELECT MAX(S.QUESTIONNAIRE_ID) FROM QUEST_ANSWER_HEADER S 
											INNER JOIN QUEST_HEADER T5 ON S.QUESTIONNAIRE_ID = T5.QUESTIONNAIRE_ID 
											WHERE S.MODULE_ITEM_KEY = S1.MODULE_ITEM_KEY 
											AND T5.QUESTIONNAIRE_NUMBER = 123
											AND S.MODULE_ITEM_CODE = 13) 
    GROUP BY AH.AGREEMENT_REQUEST_ID
    ORDER BY AH.AGREEMENT_REQUEST_ID');
SET @QUERY_STATEMENT = LS_DYN_SQL; 
PREPARE EXECUTABLE_STAEMENT FROM @QUERY_STATEMENT;
EXECUTE EXECUTABLE_STAEMENT;
END
