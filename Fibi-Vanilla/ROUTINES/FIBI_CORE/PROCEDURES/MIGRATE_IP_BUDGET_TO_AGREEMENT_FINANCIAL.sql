-- `MIGRATE_IP_BUDGET_TO_AGREEMENT_FINANCIAL`; 

CREATE PROCEDURE `MIGRATE_IP_BUDGET_TO_AGREEMENT_FINANCIAL`(
	IN AV_SOURCE_MODULE_ID INT,
    IN AV_DESTINATION_MODULE_ID INT,
    IN AV_DESTINATION_MODULE_CODE INT,
    IN AV_SOURCE_MODULE_CODE INT,
    IN AV_UPDATED_USER VARCHAR(60)
)
BEGIN
    INSERT INTO agreement_financial_detail (
        AGREEMENT_REQUEST_ID, 
        PROJECT_START_DATE, 
        PROJECT_END_DATE,
        FA_RATE_TYPE_CODE, 
        FA_RATE_CLASS_CODE,
        FA_RATE,
        LOCATION, 
        COST_SHARE,
        OBLIGATED_AMOUNT, 
        ANTICIPATED_AMOUNT, 
        DESCRIPTION, 
        UPDATE_TIMESTAMP, 
        UPDATE_USER
    )
    SELECT 
        AV_DESTINATION_MODULE_ID,
        DATE(T1.START_DATE) AS START_DATE,
        DATE(T1.END_DATE) AS END_DATE,
        T3.RATE_TYPE_CODE,
        T3.RATE_CLASS_CODE,
        CASE 
			WHEN T3.ON_OFF_CAMPUS_FLAG = 'N' THEN T3.ON_CAMPUS_RATES
			WHEN T3.ON_OFF_CAMPUS_FLAG = 'F' THEN T3.OFF_CAMPUS_RATES
			WHEN T3.ON_OFF_CAMPUS_FLAG = 'D' THEN T3.OFF_CAMPUS_RATES + T3.ON_CAMPUS_RATES
		END AS CAMPUS_RATES,
        T3.ON_OFF_CAMPUS_FLAG AS DESCRIPTION,
        IFNULL(T3.COST_SHARING_AMOUNT, 0.00) AS COST_SHARE,
        IFNULL(T3.TOTAL_COST, 0.00) AS OBLIGATED_AMOUNT,
        IFNULL(T3.TOTAL_COST, 0.00) AS ANTICIPATED_AMOUNT,
        null,
        UTC_TIMESTAMP(),
        AV_UPDATED_USER
    FROM PROPOSAL T1
  
    LEFT JOIN (
        SELECT 
            S3.PROPOSAL_ID,
            S3.TOTAL_COST,
            S3.TOTAL_DIRECT_COST,
            S3.TOTAL_INDIRECT_COST,
            S3.RATE_CLASS_CODE,
            S3.RATE_TYPE_CODE,
            S3.ON_OFF_CAMPUS_FLAG,
			S3.COST_SHARING_AMOUNT,
			S3.ON_CAMPUS_RATES,
			S3.OFF_CAMPUS_RATES
        FROM IP_BUDGET_HEADER S3
        WHERE S3.VERSION_NUMBER = (
            SELECT MAX(S4.VERSION_NUMBER) 
            FROM IP_BUDGET_HEADER S4
            WHERE S3.PROPOSAL_ID = S4.PROPOSAL_ID
        )
    ) T3 ON T1.PROPOSAL_ID = T3.PROPOSAL_ID
    LEFT JOIN RATE_TYPE T4 ON T3.RATE_TYPE_CODE = T4.RATE_TYPE_CODE
        AND T3.RATE_CLASS_CODE = T4.RATE_CLASS_CODE
    WHERE T1.PROPOSAL_ID = AV_SOURCE_MODULE_ID;
END
