-- `PERSON_ROLE_SYNCH`; 

CREATE PROCEDURE `PERSON_ROLE_SYNCH`(
        AV_PERSON_ID     VARCHAR(40),
        AV_UNIT_NUMBER   VARCHAR(8),
        AV_ROLE_ID               INT,
        AV_RIGHT_ID      INT,
        AV_DESCEND_FLAG  VARCHAR(1),
        AV_UPDATE_USER   VARCHAR(60),
        AV_TYPE                  VARCHAR(20)
)
BEGIN
DECLARE LS_RIGHT_NAME           VARCHAR(100);
DECLARE LS_PERSON_ID            VARCHAR(40);
DECLARE LS_UNIT_NUMBER          VARCHAR(8);
DECLARE LS_DESCEND_FLAG         VARCHAR(1);
DECLARE LI_FLAG                         INT;
DECLARE LI_ROLE_RIGHTS_ID       INT;
DECLARE LI_PERSON_ROLES_ID  INT;
DECLARE LI_DESCEND_PARENTS INT;
        IF AV_TYPE IN ('ASSIGN_ROLE','UPDATE_DESCEND_FLAG') THEN
                SELECT COUNT(1) INTO LI_FLAG
                FROM PERSON_ROLES
                WHERE PERSON_ID = AV_PERSON_ID
                AND UNIT_NUMBER = AV_UNIT_NUMBER
                AND ROLE_ID = AV_ROLE_ID;
                IF LI_FLAG = 0 THEN 
					SELECT IFNULL(MAX(PERSON_ROLES_ID),0)+1 INTO LI_PERSON_ROLES_ID FROM PERSON_ROLES;
				
					INSERT INTO PERSON_ROLES(PERSON_ROLES_ID, PERSON_ID, ROLE_ID, UNIT_NUMBER, DESCEND_FLAG, UPDATE_TIMESTAMP, UPDATE_USER)
					VALUES(LI_PERSON_ROLES_ID,AV_PERSON_ID,AV_ROLE_ID,AV_UNIT_NUMBER,AV_DESCEND_FLAG,utc_timestamp(),AV_UPDATE_USER);
				
				ELSE
					UPDATE PERSON_ROLES SET DESCEND_FLAG = AV_DESCEND_FLAG, UPDATE_TIMESTAMP = utc_timestamp(), UPDATE_USER = AV_UPDATE_USER WHERE PERSON_ID = AV_PERSON_ID
					AND UNIT_NUMBER = AV_UNIT_NUMBER AND ROLE_ID = AV_ROLE_ID;
				END IF;
        ELSEIF AV_TYPE = 'DELETE_ROLE' THEN
		DELETE FROM PERSON_ROLES
        WHERE PERSON_ID = AV_PERSON_ID
        AND ROLE_ID = AV_ROLE_ID
        AND UNIT_NUMBER = AV_UNIT_NUMBER;
				 										 
		 CALL ROLE_RIGHTS_AUDIT_PROC
								('PER_ROLES',			
								'DELETE',				
								NULL,					
								NULL,					
								NULL,					
								NULL,					
								AV_PERSON_ID,			
								NULL,			
								AV_ROLE_ID,			
								NULL,			
								NULL,			
								NULL,					
								AV_UNIT_NUMBER,		
								NULL,		
								LS_DESCEND_FLAG,		
								NULL,
								AV_UPDATE_USER);										 
        ELSEIF AV_TYPE = 'ASSIGN_RIGHT' THEN
                SELECT COUNT(1) INTO LI_FLAG FROM ROLE_RIGHTS
                WHERE ROLE_ID = AV_ROLE_ID
                AND RIGHT_ID = AV_RIGHT_ID;
                IF LI_FLAG = 0 THEN
                        SELECT IFNULL(MAX(ROLE_RIGHTS_ID),0)+1 INTO LI_ROLE_RIGHTS_ID FROM ROLE_RIGHTS;
                        INSERT INTO ROLE_RIGHTS(ROLE_RIGHTS_ID, RIGHT_ID, ROLE_ID, UPDATE_TIMESTAMP, UPDATE_USER)
                        VALUES(LI_ROLE_RIGHTS_ID,AV_RIGHT_ID,AV_ROLE_ID,utc_timestamp(),AV_UPDATE_USER);
                END IF;
        ELSEIF AV_TYPE = 'DELETE_RIGHT' THEN
				DELETE FROM ROLE_RIGHTS
				WHERE ROLE_ID = AV_ROLE_ID
				AND RIGHT_ID = AV_RIGHT_ID;
				
				CALL ROLE_RIGHTS_AUDIT_PROC
						('ROLE_RIGHTS',			
						'DELETE',				
						NULL,				
						NULL,				
						NULL,				
						NULL,					
						NULL,			
						NULL,			
						AV_ROLE_ID,			
						AV_ROLE_ID,			
						AV_RIGHT_ID,			
						NULL,					
						NULL,		
						NULL,		
						NULL,		
						NULL,
						AV_UPDATE_USER);	
				
        END IF;
END
