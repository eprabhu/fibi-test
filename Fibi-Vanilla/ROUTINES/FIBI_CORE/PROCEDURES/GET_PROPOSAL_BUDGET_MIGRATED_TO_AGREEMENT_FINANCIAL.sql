-- `GET_PROPOSAL_BUDGET_MIGRATED_TO_AGREEMENT_FINANCIAL`; 

CREATE PROCEDURE `GET_PROPOSAL_BUDGET_MIGRATED_TO_AGREEMENT_FINANCIAL`(
IN AV_SOURCE_MODULE_ID INT)
BEGIN
				SELECT 'ID'
				,'Title'
				,'Status'
				,'Proposed Start Date'
				,'Proposed End Date'
				,'Campus Flag'
				,'F&A Rate Type'
				,'F&A Rate (%)'
				,'Direct Cost'
				,'Indirect Cost'
				,'Cost Share'
				,'Total Cost'
UNION
			 SELECT
					T1.PROPOSAL_ID,
					T1.TITLE,
					T5.DESCRIPTION AS STATUS,
					DATE(T1.START_DATE) AS START_DATE,
					DATE(T1.END_DATE) AS END_DATE,
					CASE WHEN T3.ON_OFF_CAMPUS_FLAG = 'N' THEN 'ON'
					WHEN T3.ON_OFF_CAMPUS_FLAG = 'F' THEN 'OFF' end as flag,
					T4.DESCRIPTION AS FA_RATE,
					CASE 
						WHEN T3.ON_OFF_CAMPUS_FLAG = 'N' THEN CONCAT(T3.ON_CAMPUS_RATES, '%')
						WHEN T3.ON_OFF_CAMPUS_FLAG = 'F' THEN  CONCAT(T3.OFF_CAMPUS_RATES, '%')
						WHEN T3.ON_OFF_CAMPUS_FLAG = 'D' THEN CONCAT(T3.OFF_CAMPUS_RATES + T3.ON_CAMPUS_RATES,'%')
					end as CAMPUS_RATES,
					IFNULL(T3.TOTAL_DIRECT_COST, 0.00) AS TOTAL_DIRECT_COST,
					IFNULL(T3.TOTAL_INDIRECT_COST, 0.00) AS TOTAL_INDIRECT_COST,
					 IFNULL(T3.COST_SHARING_AMOUNT, 0.00) AS COST_SHARE,
					IFNULL(T3.TOTAL_COST, 0.00) AS TOTAL_COST
				FROM EPS_PROPOSAL T1
				LEFT JOIN (
					SELECT 
						S3.PROPOSAL_ID,
						S3.TOTAL_COST,
						S3.TOTAL_DIRECT_COST,
						S3.TOTAL_INDIRECT_COST,
						S3.RATE_CLASS_CODE,
						S3.RATE_TYPE_CODE,
						S3.ON_OFF_CAMPUS_FLAG,
						S3.COST_SHARING_AMOUNT,
						S3.ON_CAMPUS_RATES,
						S3.OFF_CAMPUS_RATES
					FROM BUDGET_HEADER S3
					WHERE S3.VERSION_NUMBER = (
						SELECT MAX(S4.VERSION_NUMBER) 
						FROM BUDGET_HEADER S4
						WHERE S3.PROPOSAL_ID = S4.PROPOSAL_ID
					)
				) T3 ON T1.PROPOSAL_ID = T3.PROPOSAL_ID
				LEFT JOIN RATE_TYPE T4 ON T3.RATE_TYPE_CODE = T4.RATE_TYPE_CODE
					AND T3.RATE_CLASS_CODE = T4.RATE_CLASS_CODE
				 inner join EPS_PROPOSAL_STATUS T5 ON T5.STATUS_CODE = T1.STATUS_CODE
				WHERE T1.PROPOSAL_ID = AV_SOURCE_MODULE_ID;
END
