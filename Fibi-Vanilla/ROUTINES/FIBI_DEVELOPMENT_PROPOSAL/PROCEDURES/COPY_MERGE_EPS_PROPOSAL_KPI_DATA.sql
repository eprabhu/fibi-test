-- `COPY_MERGE_EPS_PROPOSAL_KPI_DATA`; 

CREATE PROCEDURE `COPY_MERGE_EPS_PROPOSAL_KPI_DATA`(
IN AV_ACTIVE_PROPOSAL_ID  INT,
IN AV_ARCHIVE_PROPOSAL_ID  INT,
IN AV_TYPE VARCHAR(1) 
)
BEGIN
    DECLARE LS_KPI_TYPE_CODE	varchar(3);
	DECLARE LD_UPDATE_TIMESTAMP	datetime;
	DECLARE LS_UPDATE_USER	varchar(60);
	DECLARE LI_PROPOSAL_KPI_ID INT;
	DECLARE LS_KPI_CRITERIA_TYPE_CODE	varchar(255); 
	DECLARE LI_TARGET	int; 
	DECLARE LS_MILESTONE	varchar(1000); 
	DECLARE LI_DURATION	int;
	DECLARE LI_START_MONTH	int;
	DECLARE LS_ERROR_MSG	              VARCHAR(2000);
	DECLARE LS_ERROR_FLAG	              VARCHAR(1) DEFAULT 'N';
    DECLARE NOT_FOUND                 INT;
    DECLARE LS_PROC_LOC                VARCHAR(200);
    DECLARE li_seq_proposal_id          INT;
    DECLARE LI_LS_PROPOSAL_KPI_ID INT;
	
    DECLARE  SEL_EPS_PROPOSAL_KPI CURSOR FOR
    SELECT PROPOSAL_KPI_ID,KPI_TYPE_CODE, UPDATE_TIMESTAMP, UPDATE_USER FROM EPS_PROPOSAL_KPI WHERE PROPOSAL_ID = li_seq_proposal_id;
	
	DECLARE  SEL_EPS_PROPOSAL_KPI_CRITERIA CURSOR FOR
    SELECT  KPI_CRITERIA_TYPE_CODE, KPI_TYPE_CODE, TARGET, UPDATE_TIMESTAMP, UPDATE_USER FROM EPS_PROPOSAL_KPI_CRITERIA WHERE PROPOSAL_KPI_ID = LI_LS_PROPOSAL_KPI_ID;
	
	DECLARE  SEL_EPS_PROPOSAL_MILESTONE CURSOR FOR
    SELECT MILESTONE, UPDATE_TIMESTAMP, UPDATE_USER, DURATION, START_MONTH FROM EPS_PROPOSAL_MILESTONE WHERE PROPOSAL_ID = li_seq_proposal_id ;
	
	
	DECLARE EXIT HANDLER FOR SQLEXCEPTION
				BEGIN
				
					GET DIAGNOSTICS CONDITION 1 @sqlstate = RETURNED_SQLSTATE, 
					 @errno = MYSQL_ERRNO, @msg = MESSAGE_TEXT;					 
					SET @full_error = CONCAT(@msg,'/',LS_PROC_LOC);	
					SET LS_ERROR_MSG = @full_error;
                    RESIGNAL SET MESSAGE_TEXT = LS_ERROR_MSG;			
		 
                END;
				
     DECLARE CONTINUE HANDLER FOR NOT FOUND SET NOT_FOUND = 1;	
 
	 SET LS_ERROR_FLAG = 'N';
	 
		IF AV_TYPE = 'C' THEN 
		
		  SET li_seq_proposal_id = AV_ACTIVE_PROPOSAL_ID;
		  
		ELSEIF AV_TYPE = 'M' THEN 
        SET LS_PROC_LOC = 'DELETE_EPS_PROPOSAL_KPI';
		set sql_safe_updates = 0;
		DELETE FROM EPS_PROPOSAL_MILESTONE WHERE PROPOSAL_ID = AV_ACTIVE_PROPOSAL_ID ;
        DELETE FROM EPS_PROPOSAL_KPI_CRITERIA WHERE PROPOSAL_KPI_ID IN  (SELECT PROPOSAL_KPI_ID FROM EPS_PROPOSAL_KPI WHERE PROPOSAL_ID = AV_ACTIVE_PROPOSAL_ID);
        DELETE FROM EPS_PROPOSAL_KPI WHERE PROPOSAL_ID = AV_ACTIVE_PROPOSAL_ID;
		set sql_safe_updates = 1;
		 SET li_seq_proposal_id = AV_ARCHIVE_PROPOSAL_ID;		 
		  
		END IF;
		
	  
    SET LS_PROC_LOC = 'EPS_PROPOSAL_KPI';
			
            OPEN SEL_EPS_PROPOSAL_KPI;
            SEL_EPS_PROPOSAL_KPI:LOOP
			SET NOT_FOUND  = 0;
            FETCH SEL_EPS_PROPOSAL_KPI INTO LI_LS_PROPOSAL_KPI_ID, LS_KPI_TYPE_CODE,LD_UPDATE_TIMESTAMP,LS_UPDATE_USER;
 
             IF NOT_FOUND=1 THEN
            LEAVE SEL_EPS_PROPOSAL_KPI;
            END IF;
            
                 INSERT INTO EPS_PROPOSAL_KPI	
                (
				 PROPOSAL_ID,
				 KPI_TYPE_CODE,
				 UPDATE_TIMESTAMP,
				 UPDATE_USER
					)
					
                 VALUES(
				CASE WHEN AV_TYPE = 'M' THEN AV_ACTIVE_PROPOSAL_ID WHEN AV_TYPE = 'C' THEN AV_ARCHIVE_PROPOSAL_ID END,
				LS_KPI_TYPE_CODE,
				LD_UPDATE_TIMESTAMP,
				LS_UPDATE_USER
                );
				
				SET LI_PROPOSAL_KPI_ID = LAST_INSERT_ID();
                
              
	  
	   SET LS_PROC_LOC = 'EPS_PROPOSAL_KPI_CRITERIA';
			 
            OPEN SEL_EPS_PROPOSAL_KPI_CRITERIA;
            SEL_EPS_PROPOSAL_KPI_CRITERIA:LOOP
			SET NOT_FOUND  = 0;
            FETCH SEL_EPS_PROPOSAL_KPI_CRITERIA INTO LS_KPI_CRITERIA_TYPE_CODE,LS_KPI_TYPE_CODE,LI_TARGET,LD_UPDATE_TIMESTAMP,LS_UPDATE_USER;
              IF NOT_FOUND=1 THEN
            LEAVE SEL_EPS_PROPOSAL_KPI_CRITERIA;
            END IF;
             
                 INSERT INTO EPS_PROPOSAL_KPI_CRITERIA	
                (
				 KPI_CRITERIA_TYPE_CODE,
				 KPI_TYPE_CODE,
				 PROPOSAL_KPI_ID,
				 TARGET,
				 UPDATE_TIMESTAMP,
				 UPDATE_USER
					)
					
                 VALUES(
					LS_KPI_CRITERIA_TYPE_CODE,
					LS_KPI_TYPE_CODE,
					LI_PROPOSAL_KPI_ID,
					LI_TARGET,
					LD_UPDATE_TIMESTAMP,
					LS_UPDATE_USER
                );
                
              
		END LOOP SEL_EPS_PROPOSAL_KPI_CRITERIA;
		CLOSE SEL_EPS_PROPOSAL_KPI_CRITERIA;  
		
				END LOOP SEL_EPS_PROPOSAL_KPI;
		CLOSE SEL_EPS_PROPOSAL_KPI;  
		
	  SET LS_PROC_LOC = 'EPS_PROPOSAL_MILESTONE';
			
            OPEN SEL_EPS_PROPOSAL_MILESTONE;
            SEL_EPS_PROPOSAL_MILESTONE:LOOP
			SET NOT_FOUND  = 0;
            FETCH SEL_EPS_PROPOSAL_MILESTONE INTO LS_MILESTONE,LD_UPDATE_TIMESTAMP,LS_UPDATE_USER,LI_DURATION,LI_START_MONTH;
 
			
            IF NOT_FOUND=1 THEN
            LEAVE SEL_EPS_PROPOSAL_MILESTONE;
            END IF;
            
               
                INSERT INTO EPS_PROPOSAL_MILESTONE	
                (
				 PROPOSAL_ID,
				 MILESTONE,
				 UPDATE_TIMESTAMP,
				 UPDATE_USER,
				 DURATION,
				 START_MONTH
					)
					
                 VALUES(
				    CASE WHEN AV_TYPE = 'M' THEN AV_ACTIVE_PROPOSAL_ID WHEN AV_TYPE = 'C' THEN AV_ARCHIVE_PROPOSAL_ID END,
					LS_MILESTONE,
					LD_UPDATE_TIMESTAMP,
					LS_UPDATE_USER,
					LI_DURATION,
					LI_START_MONTH
                );
                
              
		END LOOP SEL_EPS_PROPOSAL_MILESTONE;
		CLOSE SEL_EPS_PROPOSAL_MILESTONE;  
		 
END
