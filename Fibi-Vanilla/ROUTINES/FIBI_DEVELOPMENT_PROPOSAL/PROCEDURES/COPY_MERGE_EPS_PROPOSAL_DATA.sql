-- `COPY_MERGE_EPS_PROPOSAL_DATA`; 

CREATE PROCEDURE `COPY_MERGE_EPS_PROPOSAL_DATA`(
IN AV_ACTIVE_PROPOSAL_ID  INT,
IN AV_ARCHIVE_PROPOSAL_ID INT,
IN AV_TYPE VARCHAR(1),
out AV_seq_proposal_id int(4)
)
BEGIN  
  
    DECLARE LS_ABSTRACT_DESC	text;
	DECLARE LS_ACTIVITY_TYPE_CODE	varchar(3);
	DECLARE LD_CREATE_TIMESTAMP	datetime;
	DECLARE LS_CREATE_USER	varchar(60);
	DECLARE LS_DELIVERABLES	text;
	DECLARE LS_DETAILS	varchar(4000);
	DECLARE LD_END_DATE	datetime;
	DECLARE LS_FUNDING_STRATEGY	varchar(255);
	DECLARE LI_GRANT_HEADER_ID	int;
	DECLARE LI_GRANT_TYPE_CODE	int;
	DECLARE LS_HOME_UNIT_NAME	varchar(200);
	DECLARE LS_HOME_UNIT_NUMBER	varchar(8);
	DECLARE LS_IP_NUMBER	varchar(30);
	DECLARE LS_RESEARCH_AREA_DESC	varchar(4000);
	DECLARE LS_SPONSOR_CODE	varchar(6);
	DECLARE LS_SPONSOR_PROPOSAL_NUMBER	varchar(100);
	DECLARE LD_START_DATE	datetime;
	DECLARE LI_STATUS_CODE	int;
	DECLARE LD_SUBMISSION_DATE	datetime;
	DECLARE LS_SUBMIT_USER	varchar(60);
	DECLARE LS_TITLE	varchar(1000);
	DECLARE LI_TYPE_CODE	int;
	DECLARE LD_UPDATE_TIMESTAMP	datetime;
	DECLARE LS_UPDATE_USER	varchar(60);
	DECLARE LS_BUDGET_HEADER_ID	int;
	DECLARE LD_INTERNAL_DEADLINE_DATE	datetime;
	DECLARE LS_IS_SUBCONTRACT	varchar(1);
	DECLARE LS_IS_DOMESTIC_SITE	varchar(1);
	DECLARE LS_IS_MULTISITE_STUDY	varchar(1);
	DECLARE LS_AWARD_TYPE_CODE	varchar(255);
	DECLARE LS_BASE_PROPOSAL_NUMBER	varchar(255);
	DECLARE LS_CFDA_NUMBER	varchar(100);
	DECLARE LS_PRIME_SPONSOR_CODE	varchar(255);
	DECLARE LS_PROGRAM_ANNOUNCEMENT_NUMBER	varchar(255);
	DECLARE LS_APPLICATION_ID	varchar(255);
	DECLARE LS_IS_ENDORSED_ONCE	varchar(255);
	DECLARE LS_MULTI_DISCIPLINARY_DESC	longtext;
	DECLARE LI_PROPOSAL_RANK	int;
	DECLARE LD_SPONSOR_DEADLINE_DATE	datetime(6);
	DECLARE LI_CLUSTER_CODE	int;
	DECLARE LS_EXTERNAL_FUNDING_AGENCY_ID	varchar(50);
	DECLARE LS_IS_ELIGIBLE_CRITERIA_MET	varchar(1);
	DECLARE LI_EVALUATION_RECOMMENDATION_CODE	int;
	DECLARE LS_DURATION	varchar(255);
	DECLARE LS_AWARD_NUMBER	varchar(12);
	DECLARE LS_DOCUMENT_STATUS_CODE	varchar(3);
	DECLARE LI_SOURCE_PROPOSAL_ID	int;
	DECLARE LI_PROPOSAL_ID	             INT;
 
	DECLARE LS_ERROR_MSG	              VARCHAR(2000);
	DECLARE LS_ERROR_FLAG	              VARCHAR(1) DEFAULT 'N';
    DECLARE NOT_FOUND                 INT;
    DECLARE LS_PROC_LOC                VARCHAR(200);
    DECLARE li_seq_proposal_id          INT;
 
	
	DECLARE SEL_EPS_PROPOSAL CURSOR FOR
	 SELECT ABSTRACT_DESC, ACTIVITY_TYPE_CODE,CREATE_TIMESTAMP,CREATE_USER,DELIVERABLES,DETAILS,END_DATE,FUNDING_STRATEGY,GRANT_HEADER_ID,
  GRANT_TYPE_CODE,HOME_UNIT_NAME,HOME_UNIT_NUMBER,IP_NUMBER,RESEARCH_AREA_DESC,SPONSOR_CODE,SPONSOR_PROPOSAL_NUMBER,START_DATE,STATUS_CODE,
  SUBMISSION_DATE,SUBMIT_USER,TITLE,TYPE_CODE,UPDATE_TIMESTAMP,UPDATE_USER,BUDGET_HEADER_ID,INTERNAL_DEADLINE_DATE,IS_SUBCONTRACT,IS_DOMESTIC_SITE,
  IS_MULTISITE_STUDY,AWARD_TYPE_CODE,BASE_PROPOSAL_NUMBER,CFDA_NUMBER,PRIME_SPONSOR_CODE,PROGRAM_ANNOUNCEMENT_NUMBER,APPLICATION_ID,
  IS_ENDORSED_ONCE, MULTI_DISCIPLINARY_DESC, PROPOSAL_RANK, SPONSOR_DEADLINE_DATE, CLUSTER_CODE, EXTERNAL_FUNDING_AGENCY_ID, IS_ELIGIBLE_CRITERIA_MET,
  EVALUATION_RECOMMENDATION_CODE,
  DURATION, AWARD_NUMBER, DOCUMENT_STATUS_CODE, SOURCE_PROPOSAL_ID  FROM EPS_PROPOSAL
  WHERE PROPOSAL_ID = LI_PROPOSAL_ID;
	
	DECLARE EXIT HANDLER FOR SQLEXCEPTION
				BEGIN
				
					GET DIAGNOSTICS CONDITION 1 @sqlstate = RETURNED_SQLSTATE, 
					 @errno = MYSQL_ERRNO, @msg = MESSAGE_TEXT;					 
					SET @full_error = CONCAT(@msg,'/',LS_PROC_LOC);	
					SET LS_ERROR_MSG = @full_error;
                     				
                END;
				
     DECLARE CONTINUE HANDLER FOR NOT FOUND SET NOT_FOUND = 1;	
 
	 SET LS_ERROR_FLAG = 'N';
	 
	 IF AV_TYPE = 'C' THEN 
	SET  LI_PROPOSAL_ID = AV_ACTIVE_PROPOSAL_ID ;
	
	ELSEIF AV_TYPE = 'M' THEN
	
	SET  LI_PROPOSAL_ID = AV_ARCHIVE_PROPOSAL_ID ;
	END IF;
	
   SET LS_PROC_LOC = 'EPS_PROPOSAL';
			
         OPEN SEL_EPS_PROPOSAL;
            SEL_EPS_PROPOSAL:LOOP
            SET NOT_FOUND=0;
            FETCH SEL_EPS_PROPOSAL INTO LS_ABSTRACT_DESC,LS_ACTIVITY_TYPE_CODE,LD_CREATE_TIMESTAMP,LS_CREATE_USER,LS_DELIVERABLES,LS_DETAILS,LD_END_DATE,LS_FUNDING_STRATEGY,LI_GRANT_HEADER_ID,LI_GRANT_TYPE_CODE,LS_HOME_UNIT_NAME,LS_HOME_UNIT_NUMBER,LS_IP_NUMBER,LS_RESEARCH_AREA_DESC,LS_SPONSOR_CODE,LS_SPONSOR_PROPOSAL_NUMBER,LD_START_DATE,LI_STATUS_CODE,LD_SUBMISSION_DATE,LS_SUBMIT_USER,LS_TITLE,LI_TYPE_CODE,LD_UPDATE_TIMESTAMP,LS_UPDATE_USER,LS_BUDGET_HEADER_ID,LD_INTERNAL_DEADLINE_DATE,LS_IS_SUBCONTRACT,LS_IS_DOMESTIC_SITE,LS_IS_MULTISITE_STUDY,LS_AWARD_TYPE_CODE,LS_BASE_PROPOSAL_NUMBER,LS_CFDA_NUMBER,LS_PRIME_SPONSOR_CODE,LS_PROGRAM_ANNOUNCEMENT_NUMBER,LS_APPLICATION_ID,LS_IS_ENDORSED_ONCE,LS_MULTI_DISCIPLINARY_DESC,LI_PROPOSAL_RANK,LD_SPONSOR_DEADLINE_DATE,LI_CLUSTER_CODE,LS_EXTERNAL_FUNDING_AGENCY_ID,LS_IS_ELIGIBLE_CRITERIA_MET,LI_EVALUATION_RECOMMENDATION_CODE,
            LS_DURATION,LS_AWARD_NUMBER,LS_DOCUMENT_STATUS_CODE,LI_SOURCE_PROPOSAL_ID; 
			
            IF NOT_FOUND=1 THEN
            LEAVE SEL_EPS_PROPOSAL;
            END IF;
			
		IF AV_TYPE = 'C' THEN 
		
        INSERT INTO EPS_PROPOSAL
        (           
            ABSTRACT_DESC, 
			ACTIVITY_TYPE_CODE,
			CREATE_TIMESTAMP,			 
			CREATE_USER,
			DELIVERABLES,
			DETAILS,
			END_DATE,
			FUNDING_STRATEGY,
			GRANT_HEADER_ID,
			GRANT_TYPE_CODE,
			HOME_UNIT_NAME,
			HOME_UNIT_NUMBER,
			IP_NUMBER,
			RESEARCH_AREA_DESC,
			SPONSOR_CODE,
			SPONSOR_PROPOSAL_NUMBER,
			START_DATE,
			STATUS_CODE,
			SUBMISSION_DATE,
			SUBMIT_USER,
			TITLE,
			TYPE_CODE,
			UPDATE_TIMESTAMP,
			UPDATE_USER,
			BUDGET_HEADER_ID,
			INTERNAL_DEADLINE_DATE,
			IS_SUBCONTRACT,
			IS_DOMESTIC_SITE,
			IS_MULTISITE_STUDY,
			AWARD_TYPE_CODE,
			BASE_PROPOSAL_NUMBER,
			CFDA_NUMBER,
			PRIME_SPONSOR_CODE,
			PROGRAM_ANNOUNCEMENT_NUMBER,
			APPLICATION_ID,
			IS_ENDORSED_ONCE,
			MULTI_DISCIPLINARY_DESC,
			PROPOSAL_RANK,
			SPONSOR_DEADLINE_DATE,
			CLUSTER_CODE,
			EXTERNAL_FUNDING_AGENCY_ID,
			IS_ELIGIBLE_CRITERIA_MET,
			EVALUATION_RECOMMENDATION_CODE,
			DURATION,
			AWARD_NUMBER,
			DOCUMENT_STATUS_CODE,
			SOURCE_PROPOSAL_ID
             
        ) VALUES 
		(
		    LS_ABSTRACT_DESC,
			LS_ACTIVITY_TYPE_CODE,
			LD_CREATE_TIMESTAMP,
			LS_CREATE_USER,
			LS_DELIVERABLES,
			LS_DETAILS,
			LD_END_DATE,
			LS_FUNDING_STRATEGY,
			LI_GRANT_HEADER_ID,
			LI_GRANT_TYPE_CODE,
			LS_HOME_UNIT_NAME,
			LS_HOME_UNIT_NUMBER,
			LS_IP_NUMBER,
			LS_RESEARCH_AREA_DESC,
			LS_SPONSOR_CODE,
			LS_SPONSOR_PROPOSAL_NUMBER,
			LD_START_DATE,
			LI_STATUS_CODE,
			LD_SUBMISSION_DATE,
			LS_SUBMIT_USER,
			LS_TITLE,
			LI_TYPE_CODE,
			LD_UPDATE_TIMESTAMP,
			LS_UPDATE_USER,
			LS_BUDGET_HEADER_ID,
			LD_INTERNAL_DEADLINE_DATE,
			LS_IS_SUBCONTRACT,
			LS_IS_DOMESTIC_SITE,
			LS_IS_MULTISITE_STUDY,
			LS_AWARD_TYPE_CODE,
			LS_BASE_PROPOSAL_NUMBER,
			LS_CFDA_NUMBER,
			LS_PRIME_SPONSOR_CODE,
			LS_PROGRAM_ANNOUNCEMENT_NUMBER,
			LS_APPLICATION_ID,
			LS_IS_ENDORSED_ONCE,
			LS_MULTI_DISCIPLINARY_DESC,
			LI_PROPOSAL_RANK,
			LD_SPONSOR_DEADLINE_DATE,
			LI_CLUSTER_CODE,
			LS_EXTERNAL_FUNDING_AGENCY_ID,
			LS_IS_ELIGIBLE_CRITERIA_MET,
			LI_EVALUATION_RECOMMENDATION_CODE,
			LS_DURATION,
			LS_AWARD_NUMBER,
			3,
			LI_SOURCE_PROPOSAL_ID  
	 		 
		);
                  
        
        SET li_seq_proposal_id=LAST_INSERT_ID();
         
	ELSEIF AV_TYPE = 'M' THEN
	
	
	  UPDATE EPS_PROPOSAL SET           
				
	            ABSTRACT_DESC = LS_ABSTRACT_DESC,
				ACTIVITY_TYPE_CODE = LS_ACTIVITY_TYPE_CODE,
				CREATE_TIMESTAMP = LD_CREATE_TIMESTAMP,
				CREATE_USER = LS_CREATE_USER,
				DELIVERABLES = LS_DELIVERABLES,
				DETAILS = LS_DETAILS,
				END_DATE = LD_END_DATE,
				FUNDING_STRATEGY = LS_FUNDING_STRATEGY,
				GRANT_HEADER_ID = LI_GRANT_HEADER_ID,
				GRANT_TYPE_CODE = LI_GRANT_TYPE_CODE,
				HOME_UNIT_NAME = LS_HOME_UNIT_NAME,
				HOME_UNIT_NUMBER = LS_HOME_UNIT_NUMBER,
				IP_NUMBER = LS_IP_NUMBER,
				RESEARCH_AREA_DESC = LS_RESEARCH_AREA_DESC,
				SPONSOR_CODE = LS_SPONSOR_CODE,
				SPONSOR_PROPOSAL_NUMBER = LS_SPONSOR_PROPOSAL_NUMBER,
				START_DATE = LD_START_DATE,
				STATUS_CODE = LI_STATUS_CODE,
				SUBMISSION_DATE = LD_SUBMISSION_DATE,
				SUBMIT_USER = LS_SUBMIT_USER,
				TITLE = LS_TITLE,
				TYPE_CODE = LI_TYPE_CODE,
				UPDATE_TIMESTAMP = LD_UPDATE_TIMESTAMP,
				UPDATE_USER = LS_UPDATE_USER,
				BUDGET_HEADER_ID = LS_BUDGET_HEADER_ID,
				INTERNAL_DEADLINE_DATE = LD_INTERNAL_DEADLINE_DATE,
				IS_SUBCONTRACT = LS_IS_SUBCONTRACT,
				IS_DOMESTIC_SITE = LS_IS_DOMESTIC_SITE,
				IS_MULTISITE_STUDY = LS_IS_MULTISITE_STUDY,
				AWARD_TYPE_CODE = LS_AWARD_TYPE_CODE,
				BASE_PROPOSAL_NUMBER = LS_BASE_PROPOSAL_NUMBER,
				CFDA_NUMBER = LS_CFDA_NUMBER,
				PRIME_SPONSOR_CODE = LS_PRIME_SPONSOR_CODE,
				PROGRAM_ANNOUNCEMENT_NUMBER = LS_PROGRAM_ANNOUNCEMENT_NUMBER,
				APPLICATION_ID = LS_APPLICATION_ID,
				IS_ENDORSED_ONCE = LS_IS_ENDORSED_ONCE,
				MULTI_DISCIPLINARY_DESC = LS_MULTI_DISCIPLINARY_DESC,
				PROPOSAL_RANK = LI_PROPOSAL_RANK,
				SPONSOR_DEADLINE_DATE = LD_SPONSOR_DEADLINE_DATE,
				CLUSTER_CODE = LI_CLUSTER_CODE,
				EXTERNAL_FUNDING_AGENCY_ID = LS_EXTERNAL_FUNDING_AGENCY_ID,
				IS_ELIGIBLE_CRITERIA_MET = LS_IS_ELIGIBLE_CRITERIA_MET,
				EVALUATION_RECOMMENDATION_CODE = LI_EVALUATION_RECOMMENDATION_CODE,
				DURATION = LS_DURATION,
				AWARD_NUMBER = LS_AWARD_NUMBER,
				DOCUMENT_STATUS_CODE = 1,
				SOURCE_PROPOSAL_ID =LI_SOURCE_PROPOSAL_ID
				
				WHERE PROPOSAL_ID = AV_ACTIVE_PROPOSAL_ID;
    
    	
        END IF;	
		
		END LOOP SEL_EPS_PROPOSAL;
		CLOSE SEL_EPS_PROPOSAL;
		
	
		
		
		
		IF LS_ERROR_FLAG = 'N' THEN
		 SET AV_seq_proposal_id = li_seq_proposal_id;
         end if;
		 
		 
		 
END
