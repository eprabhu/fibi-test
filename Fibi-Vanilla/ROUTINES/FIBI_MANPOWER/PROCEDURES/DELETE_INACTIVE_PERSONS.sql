CREATE PROCEDURE DELETE_INACTIVE_PERSONS(
    IN AV_TYPE VARCHAR(8),
    IN AV_DATE DATETIME,
    OUT OUT_INELIGIBLE_PERSONS TEXT
)
BEGIN
    DECLARE LS_INELIGIBLE_LIST TEXT DEFAULT '';

    IF AV_TYPE = 'STAFF' THEN
        SELECT GROUP_CONCAT(DISTINCT P.PERSON_ID) INTO LS_INELIGIBLE_LIST
        FROM PERSON P
        -- Commented this because these are NTU custom changes
        /*INNER JOIN PERSON_ROLES PR ON P.PERSON_ID = PR.PERSON_ID
        WHERE PR.ROLE_ID IN (660, 400, 100, 120, 28, 668, 670, 669, 684, 682)*/
          WHERE P.UPDATE_TIMESTAMP <> AV_DATE
          AND P.DATE_WHEN_PERSON_INACTIVE IS NULL
          AND (P.IS_GRADUATE_STUDENT_STAFF = 'N' OR P.IS_GRADUATE_STUDENT_STAFF IS NULL)
          AND (P.IS_EXTERNAL_USER IS NULL OR P.IS_EXTERNAL_USER = 'N');

    ELSEIF AV_TYPE = 'STUDENT' THEN
        SELECT GROUP_CONCAT(DISTINCT P.PERSON_ID) INTO LS_INELIGIBLE_LIST
        FROM PERSON P
        /*INNER JOIN PERSON_ROLES PR ON P.PERSON_ID = PR.PERSON_ID
        WHERE PR.ROLE_ID IN (660, 400, 100, 120, 28, 668, 670, 669, 684, 682)*/
          WHERE P.UPDATE_TIMESTAMP <> AV_DATE
          AND P.DATE_WHEN_PERSON_INACTIVE IS NULL
          AND P.IS_GRADUATE_STUDENT_STAFF = 'Y';
    END IF;

    SET SQL_SAFE_UPDATES = 0;
    IF AV_TYPE = 'STAFF' THEN
        UPDATE PERSON P
        SET P.STATUS = 'I',
            P.UPDATE_TIMESTAMP = UTC_TIMESTAMP(),
            P.DATE_WHEN_PERSON_INACTIVE = DATE_SUB(AV_DATE, INTERVAL 1 DAY)
        /*WHERE FIND_IN_SET(P.PERSON_ID, LS_INELIGIBLE_LIST) = 0*/
          WHERE P.UPDATE_TIMESTAMP <> AV_DATE
          AND P.DATE_WHEN_PERSON_INACTIVE IS NULL
          AND (P.IS_GRADUATE_STUDENT_STAFF = 'N' OR P.IS_GRADUATE_STUDENT_STAFF IS NULL)
          AND (P.IS_EXTERNAL_USER IS NULL OR P.IS_EXTERNAL_USER = 'N');

    ELSEIF AV_TYPE = 'STUDENT' THEN
        UPDATE PERSON P
        SET P.STATUS = 'I',
            P.UPDATE_TIMESTAMP = UTC_TIMESTAMP(),
            P.DATE_WHEN_PERSON_INACTIVE = DATE_SUB(AV_DATE, INTERVAL 1 DAY)
        /*WHERE FIND_IN_SET(P.PERSON_ID, LS_INELIGIBLE_LIST) = 0*/
          WHERE P.UPDATE_TIMESTAMP <> AV_DATE
          AND P.DATE_WHEN_PERSON_INACTIVE IS NULL
          AND P.IS_GRADUATE_STUDENT_STAFF = 'Y';
    END IF;


    SET OUT_INELIGIBLE_PERSONS = LS_INELIGIBLE_LIST;

    DELETE FROM MANPOWER_PERSON_ACTIVITY_LOG
    WHERE PERSON_ID IN (SELECT PERSON_ID FROM PERSON WHERE STATUS = 'A');

    INSERT INTO MANPOWER_PERSON_ACTIVITY_LOG
   (SELECT PERSON_ID, DATE(DATE_WHEN_PERSON_INACTIVE), FULL_NAME, STATUS, UPDATE_USER, UPDATE_TIMESTAMP FROM
    PERSON WHERE DATE(DATE_WHEN_PERSON_INACTIVE) = DATE(DATE_SUB(AV_DATE, INTERVAL 1 DAY))
    AND PERSON_ID NOT IN (SELECT PERSON_ID FROM MANPOWER_PERSON_ACTIVITY_LOG) AND UPDATE_USER <> 'workday admin');
    SET SQL_SAFE_UPDATES = 1;

END
