-- `CLOSE_SERVICE_REQUEST`; 

CREATE PROCEDURE `CLOSE_SERVICE_REQUEST`(AV_RESOLVED_DAYS_THRESHOLD INT)
BEGIN
   DECLARE LI_SR_HEADER_ID         INT;
   DECLARE LS_SR_HEADER_ID         VARCHAR(500) DEFAULT '';
   DECLARE NOT_FOUND               INT;
   DECLARE LS_ERROR_FLAG           VARCHAR(1) DEFAULT 'N';
   DECLARE LS_PROC_LOC             VARCHAR(200);
   DECLARE LI_ACTION_LOG_ID        INT;
   DECLARE LS_ERROR_MSG            VARCHAR(4000);
   DECLARE LS_QUERY VARCHAR(2000);
    
    
 
        DECLARE SEL_SR_HEADER_ID CURSOR FOR SELECT SR_HEADER_ID FROM SR_HEADER
        WHERE STATUS_CODE = '5' 
        AND DATEDIFF(UTC_TIMESTAMP(6), UPDATE_TIMESTAMP) >= AV_RESOLVED_DAYS_THRESHOLD	;
									   
					DECLARE EXIT HANDLER FOR SQLEXCEPTION
				BEGIN
				
					GET DIAGNOSTICS CONDITION 1 @sqlstate = RETURNED_SQLSTATE, 
					 @errno = MYSQL_ERRNO, @msg = MESSAGE_TEXT;					 
					SET @full_error = CONCAT(@msg,'/',LS_PROC_LOC);	
					SET LS_ERROR_MSG = @full_error;
                    	RESIGNAL SET MESSAGE_TEXT = LS_ERROR_MSG;
		 
                END;
									   
									   
		DECLARE CONTINUE HANDLER FOR NOT FOUND 
   
	    SET NOT_FOUND = 1;	
        SET LS_ERROR_FLAG = 'N';
						
										
		SET LS_PROC_LOC = 'SEL_SR_HEADER_ID';
			
        OPEN SEL_SR_HEADER_ID;
        SEL_SR_HEADER_ID:LOOP
	    SET NOT_FOUND  = 0;
            
        FETCH SEL_SR_HEADER_ID INTO LI_SR_HEADER_ID;          
			 
        IF NOT_FOUND = 1 THEN
        LEAVE SEL_SR_HEADER_ID;
        END IF;
            
               
        UPDATE SR_HEADER SET STATUS_CODE = 8 , UPDATE_TIMESTAMP = UTC_TIMESTAMP(6), UPDATE_USER = 'System' WHERE SR_HEADER_ID = LI_SR_HEADER_ID;
				
		INSERT INTO SR_ACTION_LOG (ACTION_TYPE_CODE, STATUS_CODE, UPDATE_TIMESTAMP, UPDATE_USER, SR_HEADER_ID) VALUES (26, 8, UTC_TIMESTAMP(6), 'System', LI_SR_HEADER_ID);
		SET LI_ACTION_LOG_ID =  LAST_INSERT_ID();
				 
				 
		UPDATE SR_STATUS_HISTORY SET ACTION_END_TIME = UTC_TIMESTAMP(6)  WHERE SR_HEADER_ID  = LI_SR_HEADER_ID;
		INSERT INTO SR_STATUS_HISTORY(ACTION_LOG_ID, ACTION_START_TIME, STATUS_CODE, UPDATE_TIMESTAMP, SR_HEADER_ID) VALUES (LI_ACTION_LOG_ID, UTC_TIMESTAMP(6),8, UTC_TIMESTAMP(6), LI_SR_HEADER_ID);
        
        UPDATE INBOX SET OPENED_FLAG = 'Y'  
        WHERE MODULE_CODE = 20
        AND MODULE_ITEM_KEY = LI_SR_HEADER_ID
        AND SUB_MODULE_CODE = 0
        AND SUB_MODULE_ITEM_KEY = 0
		AND OPENED_FLAG = 'N' ;
        
SET LS_SR_HEADER_ID = CONCAT(LS_SR_HEADER_ID,  LI_SR_HEADER_ID,',');
 
  END LOOP SEL_SR_HEADER_ID;
  CLOSE SEL_SR_HEADER_ID;
 
 IF LENGTH(LS_SR_HEADER_ID) > 0 THEN
SET LS_QUERY = CONCAT('SELECT SR.SR_HEADER_ID, TYPE.DESCRIPTION, SR.SUBJECT, SR.UNIT_NUMBER, SR.REPORTER_PERSON_ID, SR.UPDATE_USER FROM SR_HEADER SR LEFT JOIN SR_TYPE TYPE ON TYPE.TYPE_CODE = SR.TYPE_CODE
     WHERE SR_HEADER_ID IN (''',REPLACE(SUBSTR(LS_SR_HEADER_ID,1,LENGTH(LS_SR_HEADER_ID)-1),',',''','''),''')');
        SET @QUERY_STATEMENT = LS_QUERY;
        PREPARE EXECUTABLE_STATEMENT FROM @QUERY_STATEMENT;
        EXECUTE EXECUTABLE_STATEMENT;
        DEALLOCATE PREPARE EXECUTABLE_STATEMENT;
 END IF;
     
END
