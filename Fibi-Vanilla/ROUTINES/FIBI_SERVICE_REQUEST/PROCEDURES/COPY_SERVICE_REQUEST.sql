-- `COPY_SERVICE_REQUEST`; 

CREATE PROCEDURE `COPY_SERVICE_REQUEST`(
	 AV_SR_HEADER_ID INT,
     AV_UPDATE_USER VARCHAR(60),
     AV_PERSON_ID VARCHAR(40),
     AV_LINK_MODULE BOOLEAN,
	 AV_COPY_QUESTIONNAIRE BOOLEAN,
	 AV_COPY_SUBTASK BOOLEAN,
     AV_COPY_ATTACHMENT BOOLEAN)
BEGIN
    DECLARE LI_SR_HEADER_ID        INT;
	DECLARE LS_DESCRIPTION         LONGTEXT;
	DECLARE LI_MODULE_CODE         INT;
	DECLARE LS_MODULE_ITEM_KEY     VARCHAR(12);
	DECLARE LI_STATUS_CODE         INT;
	DECLARE LS_TYPE_CODE           VARCHAR(3);
	DECLARE LS_SUBJECT             VARCHAR(1000);
	DECLARE LS_UNIT_NUMBER         VARCHAR(8);
    DECLARE LS_IS_SYSTEM_GENERATED VARCHAR(1);
	DECLARE LI_PRIORITY_ID         INT;
    DECLARE LI_ACTION_LOG_ID       INT;
	
	
	DECLARE LS_COLUMN_1 				    VARCHAR(200) ;
	DECLARE LS_COLUMN_2 				    VARCHAR(200) ;
	DECLARE LS_COLUMN_3 				    VARCHAR(200) ;
	DECLARE LS_COLUMN_4 				    VARCHAR(200) ;
	DECLARE LS_COLUMN_5 				    VARCHAR(200) ;
	DECLARE LS_COLUMN_6 				    VARCHAR(200) ;
	DECLARE LS_COLUMN_7 				    VARCHAR(200) ;
	DECLARE LS_COLUMN_8 				    VARCHAR(200) ;
	DECLARE LS_COLUMN_9 				    VARCHAR(200) ;
	DECLARE LS_COLUMN_10 				    VARCHAR(200) ;
	DECLARE LS_QUESTIONNAIRE_ANSWER_ID 		BIGINT(12);
	DECLARE ls_ATTACHMENT 			   		LONGBLOB;
	DECLARE LS_FILE_NAME 			   		VARCHAR(150);
	DECLARE LS_CONTENT_TYPE 		   		VARCHAR(100);
    DECLARE LS_QST_ANS_HEADER_ID 	   		BIGINT(10);
    DECLARE LI_QUEST_ANSWER_ID 		   		BIGINT(10);
    DECLARE LI_QUEST_ATT_ID    		   		BIGINT(10);
    DECLARE LI_QUEST_TABLE_ANS_ID     	 	BIGINT(10);
    DECLARE LI_QUESTIONNAIRE_ID 			BIGINT(12);
	DECLARE LI_MODULE_ITEM_CODE 			SMALLINT(3);
	DECLARE LI_MODULE_SUB_ITEM_CODE 		SMALLINT(3);
	DECLARE LS_QUESTIONNAIRE_COMPLETED_FLAG VARCHAR(1);
    DECLARE LS_MODULE_SUB_ITEM_KEY          VARCHAR(20);
	DECLARE LI_QUESTIONNAIRE_ANS_HEADER_ID 	BIGINT(12);
	DECLARE LI_QUESTION_ID 					BIGINT(12);
	DECLARE LI_OPTION_NUMBER 				SMALLINT(3);
	DECLARE LI_ANSWER_NUMBER 				SMALLINT(3);
	DECLARE LS_ANSWER 						VARCHAR(4000);
	DECLARE LS_ANSWER_LOOKUP_CODE 			VARCHAR(100);
	DECLARE LS_EXPLANATION 					VARCHAR(4000);
	DECLARE LD_UPDATE_TIMESTAMP 			DATETIME;
	DECLARE LS_UPDATE_USER 					VARCHAR(60);
	DECLARE LI_QUESTIONNAIRE_ANSWER_ID 		BIGINT(12);
	DECLARE LI_ORDER_NUMBER 				SMALLINT(3) ;
	DECLARE NOT_FOUND                       INT;
	DECLARE LS_ERROR_FLAG	                VARCHAR(1) DEFAULT 'N';
    DECLARE LS_PROC_LOC                     VARCHAR(200);
    DECLARE LS_ERROR_MSG                    VARCHAR(4000);
    DECLARE LI_ROLE_ID						INT;
    DECLARE LI_DERIVED_ROLE_NAME			VARCHAR(60);
    DECLARE LI_CONCATENATED_ROLE_NAMES	    VARCHAR(4000) DEFAULT '';
    DECLARE LI_ROLE_COUNT	               INT DEFAULT 0 ;
    DECLARE LI_PERSON_FULL_NAME			   VARCHAR(60);
    DECLARE LS_CATEGORY_CODE                VARCHAR(3);
	DECLARE  LS_RELATION_TYPE_CODE          VARCHAR(3);
    DECLARE  LS_ASSOC_CONFIG_CODE           VARCHAR(3);
	DECLARE LI_MODULE_ITEM_ID               INT;
    
    DECLARE SEL_QST_ANS_HEADER CURSOR FOR SELECT QUESTIONNAIRE_ID,MODULE_ITEM_CODE,MODULE_SUB_ITEM_CODE,MODULE_SUB_ITEM_KEY,QUESTIONNAIRE_COMPLETED_FLAG,UPDATE_TIMESTAMP,UPDATE_USER,QUESTIONNAIRE_ANS_HEADER_ID FROM QUEST_ANSWER_HEADER
                                        WHERE MODULE_ITEM_CODE = 20
										AND MODULE_SUB_ITEM_CODE = 0 
                                        AND MODULE_ITEM_KEY = AV_SR_HEADER_ID;
										
	DECLARE SEL_QUEST_ANSWER CURSOR FOR 
	SELECT QUESTION_ID,OPTION_NUMBER,ANSWER_NUMBER,ANSWER,ANSWER_LOOKUP_CODE,EXPLANATION,UPDATE_TIMESTAMP,UPDATE_USER ,QUESTIONNAIRE_ANSWER_ID 	FROM QUEST_ANSWER
	WHERE QUESTIONNAIRE_ANS_HEADER_ID = LI_QUESTIONNAIRE_ANS_HEADER_ID;
	
    DECLARE SEL_QUEST_ATT CURSOR FOR 
	SELECT  QUESTIONNAIRE_ANSWER_ID,ATTACHMENT,FILE_NAME,CONTENT_TYPE,UPDATE_TIMESTAMP,UPDATE_USER 
	FROM QUEST_ANSWER_ATTACHMENT
	WHERE QUESTIONNAIRE_ANSWER_ID = LI_QUESTIONNAIRE_ANSWER_ID;
	
	DECLARE SEL_QUEST_TABLE_ANS CURSOR FOR 
	SELECT QUESTION_ID,ORDER_NUMBER,COLUMN_1,COLUMN_2,COLUMN_3,COLUMN_4,COLUMN_5,COLUMN_6,COLUMN_7,COLUMN_8,COLUMN_9,COLUMN_10,UPDATE_TIMESTAMP,UPDATE_USER 
	FROM QUEST_TABLE_ANSWER
	WHERE QUESTIONNAIRE_ANS_HEADER_ID = LI_QUESTIONNAIRE_ANS_HEADER_ID;	
    
    DECLARE SEL_SYSTEM_DERIVED_ROLES CURSOR FOR
     SELECT  ROLE_ID, DERIVED_ROLE_NAME FROM MODULE_DERIVED_ROLES WHERE IS_ACTIVE = 'Y' AND AUTO_GRANT_TO_MODULE_CREATOR = 'Y' and MODULE_CODE = 20;
         DECLARE SEL_LINK_MODULE CURSOR FOR
         SELECT 
        RELATION_TYPE_CODE,  
        ASSOC_CONFIG_CODE,
		MODULE_CODE,
		MODULE_ITEM_KEY,
		MODULE_ITEM_ID
		
   
    FROM 
        ASSOC_SR
    WHERE 
        SR_HEADER_ID = AV_SR_HEADER_ID;
         DECLARE EXIT HANDLER FOR SQLEXCEPTION
				BEGIN
				
					GET DIAGNOSTICS CONDITION 1 @sqlstate = RETURNED_SQLSTATE, 
					 @errno = MYSQL_ERRNO, @msg = MESSAGE_TEXT;					 
					SET @full_error = CONCAT(@msg,'/',LS_PROC_LOC);	
					SET LS_ERROR_MSG = @full_error;
                    	RESIGNAL SET MESSAGE_TEXT = LS_ERROR_MSG;
		 
                END;
				
     DECLARE CONTINUE HANDLER FOR NOT FOUND 
   
	 SET NOT_FOUND = 1;	
 SET LS_ERROR_FLAG = 'N';
    
	SELECT 
        DESCRIPTION,  
        CATEGORY_CODE,
        SUBJECT, 
        TYPE_CODE, 
        UNIT_NUMBER, 
        IS_SYSTEM_GENERATED,
        PRIORITY_ID 
    INTO 
        LS_DESCRIPTION,
        LS_CATEGORY_CODE,
        LS_SUBJECT,
        LS_TYPE_CODE,
        LS_UNIT_NUMBER,
        LS_IS_SYSTEM_GENERATED,
        LI_PRIORITY_ID
    FROM 
        SR_HEADER 
    WHERE 
        SR_HEADER_ID = AV_SR_HEADER_ID;
		
		
	
    INSERT INTO SR_HEADER (
        CREATE_TIMESTAMP,
        CREATE_USER,
        DESCRIPTION,
        CATEGORY_CODE,
        REPORTER_PERSON_ID,
        STATUS_CODE,
        SUBJECT,
        TYPE_CODE,
        UPDATE_TIMESTAMP,
        UPDATE_USER,
        UNIT_NUMBER,
        IS_SYSTEM_GENERATED,
        PRIORITY_ID 
    )
    VALUES (
        UTC_TIMESTAMP(6),
        AV_UPDATE_USER,
        LS_DESCRIPTION,
		LS_CATEGORY_CODE,
        AV_PERSON_ID,
        1,
        LS_SUBJECT,
        LS_TYPE_CODE,
        UTC_TIMESTAMP(6),
        AV_UPDATE_USER,
        LS_UNIT_NUMBER,
        LS_IS_SYSTEM_GENERATED,
        LI_PRIORITY_ID 
    );
	
	SET LI_SR_HEADER_ID = LAST_INSERT_ID();
	
	
	IF AV_LINK_MODULE = TRUE THEN
    
    SET LS_PROC_LOC = 'SEL_LINK_MODULE';
			
            OPEN SEL_LINK_MODULE;
            SEL_LINK_MODULE:LOOP
			SET NOT_FOUND = 0;
            
            FETCH SEL_LINK_MODULE INTO   
	    LS_RELATION_TYPE_CODE,
		LS_ASSOC_CONFIG_CODE,
        LI_MODULE_CODE,
        LS_MODULE_ITEM_KEY,
		LI_MODULE_ITEM_ID;
           
			 
            IF NOT_FOUND = 1 THEN
            LEAVE SEL_LINK_MODULE;
            END IF;
            
	INSERT INTO ASSOC_SR (
	SR_HEADER_ID,
	RELATION_TYPE_CODE,
	ASSOC_CONFIG_CODE,
	ASSOC_TYPE,
    MODULE_CODE,
	MODULE_ITEM_KEY, 
	MODULE_ITEM_ID,
     UPDATE_USER,
    UPDATE_TIMESTAMP
   
    )
      VALUES (
	  LI_SR_HEADER_ID,
	  LS_RELATION_TYPE_CODE,
	  LS_ASSOC_CONFIG_CODE,
      "DIRECT",
      LI_MODULE_CODE,
      LS_MODULE_ITEM_KEY,
	  LI_MODULE_ITEM_ID,
	  AV_UPDATE_USER,
      UTC_TIMESTAMP(6)
      );
END LOOP SEL_LINK_MODULE;
		CLOSE SEL_LINK_MODULE;
        
        END IF;
    INSERT INTO SR_ACTION_LOG (
        ACTION_TYPE_CODE,
        ASSIGNEE_PERSON_ID,
        ASSIGNEE_PERSON_NAME,
        STATUS_CODE,
        UPDATE_TIMESTAMP,
        UPDATE_USER,
        SR_HEADER_ID
    )
    VALUES (
        1,
        AV_PERSON_ID,
        AV_UPDATE_USER,
        1,
        UTC_TIMESTAMP(6),
        AV_UPDATE_USER,
        LI_SR_HEADER_ID
    );
   
   SET LI_ACTION_LOG_ID = LAST_INSERT_ID();
   
   INSERT INTO SR_PROCESS_FLOW (
	HAS_REVIEW_RIGHT,
    ACTION_LOG_ID,
    PROCESS_START_TIMESTAMP,
    STATUS_CODE, 
    UPDATE_TIMESTAMP, 
    UPDATE_USER, 
    SR_HEADER_ID
    )
  VALUES (
    'N',
    LI_ACTION_LOG_ID,
    UTC_TIMESTAMP(6),
    1,
    UTC_TIMESTAMP(6),
    AV_UPDATE_USER,
    LI_SR_HEADER_ID);
 
    INSERT INTO SR_STATUS_HISTORY (
	    ACTION_LOG_ID,
        ACTION_START_TIME,
        STATUS_CODE,
        UPDATE_TIMESTAMP,
        UPDATE_USER,
        SR_HEADER_ID
    )
    VALUES (
        LI_ACTION_LOG_ID,
         UTC_TIMESTAMP(6),
        1,
		UTC_TIMESTAMP(6),
        AV_UPDATE_USER,
        LI_SR_HEADER_ID
    );
SELECT  COUNT(1) INTO LI_ROLE_COUNT FROM MODULE_DERIVED_ROLES WHERE IS_ACTIVE = 'Y' AND AUTO_GRANT_TO_MODULE_CREATOR = 'Y' and MODULE_CODE = 20;
IF LI_ROLE_COUNT > 0 THEN
 	SET LS_PROC_LOC = 'SEL_SYSTEM_DERIVED_ROLES';
			OPEN SEL_SYSTEM_DERIVED_ROLES;
            SEL_SYSTEM_DERIVED_ROLES:LOOP
			SET NOT_FOUND  = 0;
            FETCH SEL_SYSTEM_DERIVED_ROLES INTO LI_ROLE_ID, LI_DERIVED_ROLE_NAME;
            IF NOT_FOUND = 1 THEN
            LEAVE SEL_SYSTEM_DERIVED_ROLES;
            END IF;   
          IF LI_DERIVED_ROLE_NAME IS NOT NULL THEN
            SET LI_CONCATENATED_ROLE_NAMES = CONCAT(LI_CONCATENATED_ROLE_NAMES, LI_DERIVED_ROLE_NAME, ', ');
          END IF;
            INSERT INTO sr_person_roles (SR_HEADER_ID, PERSON_ID, ROLE_ID, UPDATE_TIMESTAMP, UPDATE_USER, IS_SYSTEM_DERIVED_ROLE)
            VALUES (LI_SR_HEADER_ID,AV_PERSON_ID,LI_ROLE_ID,UTC_TIMESTAMP(6),AV_UPDATE_USER,'Y');
            END LOOP SEL_SYSTEM_DERIVED_ROLES;
		CLOSE SEL_SYSTEM_DERIVED_ROLES;
        
		INSERT INTO SR_ACTION_LOG (
        ACTION_TYPE_CODE,
        ASSIGNEE_PERSON_ID,
        ASSIGNEE_PERSON_NAME,
        STATUS_CODE,
        UPDATE_TIMESTAMP,
        UPDATE_USER,
        SR_HEADER_ID
    )
    VALUES (
        32,
        AV_PERSON_ID,
        AV_UPDATE_USER,
        1,
        UTC_TIMESTAMP(6),
        AV_UPDATE_USER,
        LI_SR_HEADER_ID
    );
    SET LI_ACTION_LOG_ID = last_insert_id();
    
SET LI_CONCATENATED_ROLE_NAMES = TRIM(TRAILING ', ' FROM LI_CONCATENATED_ROLE_NAMES);
SELECT FULL_NAME INTO LI_PERSON_FULL_NAME FROM PERSON WHERE PERSON_ID = AV_PERSON_ID;
  
INSERT INTO sr_header_history
	(ACTION_LOG_ID,
	 UPDATE_TIMESTAMP,
	 UPDATE_USER,
	 SR_HEADER_ID,
	 ADDED_PERMISSION,
	 PERMISSION_ASSIGNED_USER)
 VALUES
	(LI_ACTION_LOG_ID,UTC_TIMESTAMP(6), AV_UPDATE_USER,LI_SR_HEADER_ID,LI_CONCATENATED_ROLE_NAMES,LI_PERSON_FULL_NAME);
 END  IF;
 
IF AV_COPY_QUESTIONNAIRE = TRUE THEN 
 
SET LS_PROC_LOC = 'SEL_QST_ANS_HEADER';
			
            OPEN SEL_QST_ANS_HEADER;
            SEL_QST_ANS_HEADER:LOOP
			SET NOT_FOUND = 0;
            
            FETCH SEL_QST_ANS_HEADER INTO LI_QUESTIONNAIRE_ID,LI_MODULE_ITEM_CODE,LI_MODULE_SUB_ITEM_CODE,LS_MODULE_SUB_ITEM_KEY,LS_QUESTIONNAIRE_COMPLETED_FLAG,LD_UPDATE_TIMESTAMP,LS_UPDATE_USER,LI_QUESTIONNAIRE_ANS_HEADER_ID;
           
			 
            IF NOT_FOUND = 1 THEN
            LEAVE SEL_QST_ANS_HEADER;
            END IF;
            
               
                INSERT INTO QUEST_ANSWER_HEADER
                ( QUESTIONNAIRE_ID, MODULE_ITEM_CODE, MODULE_SUB_ITEM_CODE, MODULE_ITEM_KEY, MODULE_SUB_ITEM_KEY, QUESTIONNAIRE_COMPLETED_FLAG, UPDATE_TIMESTAMP, UPDATE_USER)
                VALUES
                (LI_QUESTIONNAIRE_ID, LI_MODULE_ITEM_CODE, LI_MODULE_SUB_ITEM_CODE, LI_SR_HEADER_ID, LS_MODULE_SUB_ITEM_KEY, LS_QUESTIONNAIRE_COMPLETED_FLAG,UTC_TIMESTAMP(6), AV_UPDATE_USER);
				
				SET LS_QST_ANS_HEADER_ID = LAST_INSERT_ID();
				
				
				
SET LS_PROC_LOC = 'SEL_QUEST_ANSWER';
			
            OPEN SEL_QUEST_ANSWER;
            SEL_QUEST_ANSWER:LOOP
			SET NOT_FOUND = 0;
            FETCH SEL_QUEST_ANSWER INTO LI_QUESTION_ID,LI_OPTION_NUMBER,LI_ANSWER_NUMBER,LS_ANSWER,LS_ANSWER_LOOKUP_CODE,LS_EXPLANATION,LD_UPDATE_TIMESTAMP,LS_UPDATE_USER,LI_QUESTIONNAIRE_ANSWER_ID;
 
			
            IF NOT_FOUND = 1 THEN
            LEAVE SEL_QUEST_ANSWER;
            END IF;
            
               
                 INSERT INTO QUEST_ANSWER( QUESTIONNAIRE_ANS_HEADER_ID, QUESTION_ID, OPTION_NUMBER, ANSWER_NUMBER, ANSWER, ANSWER_LOOKUP_CODE, EXPLANATION, UPDATE_TIMESTAMP, UPDATE_USER)
                  VALUES(LS_QST_ANS_HEADER_ID, LI_QUESTION_ID, LI_OPTION_NUMBER,LI_ANSWER_NUMBER,LS_ANSWER,LS_ANSWER_LOOKUP_CODE,LS_EXPLANATION,UTC_TIMESTAMP(6),AV_UPDATE_USER);                  
                  SET LI_QUEST_ANSWER_ID=LAST_INSERT_ID();
                 SET SQL_SAFE_UPDATES = 0;
				 
                  UPDATE QUEST_COLUMN_NEXTVALUE SET QUESTIONNAIRE_ANSWER_ID = LI_QUEST_ANSWER_ID;
				
				  
SET LS_PROC_LOC = 'SEL_QUEST_ATT';
			
            OPEN SEL_QUEST_ATT;
            SEL_QUEST_ATT:LOOP
			SET NOT_FOUND  = 0;
            FETCH SEL_QUEST_ATT INTO LS_QUESTIONNAIRE_ANSWER_ID,LS_ATTACHMENT,LS_FILE_NAME,LS_CONTENT_TYPE,LD_UPDATE_TIMESTAMP,LS_UPDATE_USER;
 
             IF NOT_FOUND = 1 THEN
            LEAVE SEL_QUEST_ATT;
            END IF;
            
               
                 INSERT INTO QUEST_ANSWER_ATTACHMENT
                 ( QUESTIONNAIRE_ANSWER_ID, ATTACHMENT, FILE_NAME, CONTENT_TYPE, UPDATE_TIMESTAMP, UPDATE_USER)
                 VALUES(LI_QUEST_ANSWER_ID,LS_ATTACHMENT,LS_FILE_NAME,LS_CONTENT_TYPE,UTC_TIMESTAMP(6),AV_UPDATE_USER);
                 SET LI_QUEST_ATT_ID = LAST_INSERT_ID();
                SET SQL_SAFE_UPDATES = 0;
                 UPDATE QUEST_COLUMN_NEXTVALUE SET QUESTIONNAIRE_ANSWER_ATT_ID = LI_QUEST_ATT_ID;
                
              
		END LOOP SEL_QUEST_ATT;
		CLOSE SEL_QUEST_ATT;
                
              
		END LOOP SEL_QUEST_ANSWER;
		CLOSE SEL_QUEST_ANSWER;
		
		
SET LS_PROC_LOC = 'SEL_QUEST_TABLE_ANS';
			
            OPEN SEL_QUEST_TABLE_ANS;
            SEL_QUEST_TABLE_ANS:LOOP
			SET NOT_FOUND = 0;
            FETCH SEL_QUEST_TABLE_ANS INTO LI_QUESTION_ID,LI_ORDER_NUMBER, LS_COLUMN_1,LS_COLUMN_2,LS_COLUMN_3,LS_COLUMN_4,LS_COLUMN_5,LS_COLUMN_6,LS_COLUMN_7,LS_COLUMN_8,LS_COLUMN_9,LS_COLUMN_10,LD_UPDATE_TIMESTAMP,LS_UPDATE_USER ;
 
			
            IF NOT_FOUND = 1 THEN
            LEAVE SEL_QUEST_TABLE_ANS;
            END IF;
            
                INSERT INTO QUEST_TABLE_ANSWER
                  (QUESTIONNAIRE_ANS_HEADER_ID,QUESTION_ID,ORDER_NUMBER,COLUMN_1,COLUMN_2,COLUMN_3,COLUMN_4,COLUMN_5,COLUMN_6,COLUMN_7,COLUMN_8,COLUMN_9,COLUMN_10,UPDATE_TIMESTAMP,UPDATE_USER)
                  VALUES(LS_QST_ANS_HEADER_ID,LI_QUESTION_ID,LI_ORDER_NUMBER, LS_COLUMN_1,LS_COLUMN_2,LS_COLUMN_3,LS_COLUMN_4,LS_COLUMN_5,LS_COLUMN_6,LS_COLUMN_7,LS_COLUMN_8,LS_COLUMN_9,LS_COLUMN_10,UTC_TIMESTAMP(6),AV_UPDATE_USER);
                  SET LI_QUEST_TABLE_ANS_ID = LAST_INSERT_ID();
                  
                  SET SQL_SAFE_UPDATES = 0;
                  UPDATE QUEST_COLUMN_NEXTVALUE SET QUESTIONNAIRE_ANSWER_TABLE_ID = LI_QUEST_TABLE_ANS_ID;
                
              
		END LOOP SEL_QUEST_TABLE_ANS;
		CLOSE SEL_QUEST_TABLE_ANS;
               
SET SQL_SAFE_UPDATES = 0;
          
               UPDATE QUEST_COLUMN_NEXTVALUE SET QUESTIONNAIRE_ANS_HEADER_ID = LS_QST_ANS_HEADER_ID; 
	      
    
		END LOOP SEL_QST_ANS_HEADER;
		CLOSE SEL_QST_ANS_HEADER;  
        SET SQL_SAFE_UPDATES = 1;
END IF;
SELECT LI_SR_HEADER_ID ;
END
