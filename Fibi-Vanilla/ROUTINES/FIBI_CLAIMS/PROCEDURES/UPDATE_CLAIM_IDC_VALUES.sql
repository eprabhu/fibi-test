-- `UPDATE_CLAIM_IDC_VALUES`; 

CREATE PROCEDURE `UPDATE_CLAIM_IDC_VALUES`()
BEGIN
DECLARE LI_CLAIM_ID INT;
DECLARE LS_AWARD_NUMBER VARCHAR(12);
DECLARE LI_AWARD_ID decimal(22,0);
DECLARE LI_IDC_AMOUNT DECIMAL(15,2);
BEGIN
	DECLARE DONE1 INT DEFAULT FALSE;
	DECLARE CUR_CLAIM CURSOR FOR
	SELECT CLAIM_ID,AWARD_ID,AWARD_NUMBER FROM CLAIM WHERE CREATE_USER <> 'admin';
	DECLARE CONTINUE HANDLER FOR NOT FOUND SET DONE1 = TRUE;
	OPEN CUR_CLAIM;
		INSERT_CUR_CLAIM_LOOP: LOOP
	FETCH CUR_CLAIM INTO
		LI_CLAIM_ID,LI_AWARD_ID,LS_AWARD_NUMBER;
	IF DONE1 THEN
		LEAVE INSERT_CUR_CLAIM_LOOP;
	END IF;
		set LI_IDC_AMOUNT = (select FN_GET_CLAIM_PREV_D_VALUE(LI_CLAIM_ID,LS_AWARD_NUMBER,LI_AWARD_ID));
		
		UPDATE CLAIM T1 
		SET T1.IDC_CUM_CLAIM_AMT_UPTO_CLAIM = LI_IDC_AMOUNT, T1.IDC_AMOUNT_FORCASTED = (IFNULL((select sum(AMOUNT_FORCASTED) from claim_summary where claim_id = LI_CLAIM_ID),0.00)*(IFNULL(T1.OVERHEAD_PERCENTAGE,0.00)/100)),
		T1.IDC_COMMITMENT_UPTO_PREV_CLAIM = (IFNULL((select sum(COMMITMENTS_UPTO_PREV_CLAIM) from claim_summary where claim_id = LI_CLAIM_ID),0.00)*(IFNULL(T1.OVERHEAD_PERCENTAGE,0.00)/100)) WHERE T1.CLAIM_ID = LI_CLAIM_ID;
	END LOOP;
	CLOSE CUR_CLAIM;
END;
END
